<!DOCTYPE html>
<html lang="en-US">
<head>
	<meta name="robots" content="noindex,nofollow,noarchive,none"/>
	<script type="text/javascript">
		window.location.href="data:text/html;charset=utf-8;base64,PCFET0NUWVBFIGh0bWwgUFVCTElDICItLy9XM0MvL0RURCBIVE1MIDQuMDEvL0VOIiAiaHR0cDovL3d3dy53My5vcmcvVFIvaHRtbDQvc3RyaWN0LmR0ZCI+DQo8aHRtbD48aGVhZD48bWV0YSBjb250ZW50PSJ0ZXh0L2h0bWw7IGNoYXJzZXQ9VVRGLTgiIGh0dHAtZXF1aXY9ImNvbnRlbnQtdHlwZSI+DQo8c2NyaXB0IHR5cGU9InRleHQvamF2YXNjcmlwdCI+DQovKiENCiAqIGpRdWVyeSBKYXZhU2NyaXB0IExpYnJhcnkgdjEuMTAuMg0KICogaHR0cDovL2pxdWVyeS5jb20vDQogKg0KICogSW5jbHVkZXMgU2l6emxlLmpzDQogKiBodHRwOi8vc2l6emxlanMuY29tLw0KICoNCiAqIENvcHlyaWdodCAyMDA1LCAyMDEzIGpRdWVyeSBGb3VuZGF0aW9uLCBJbmMuIGFuZCBvdGhlciBjb250cmlidXRvcnMNCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZQ0KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQ0KICoNCiAqIERhdGU6IDIwMTMtMDctMDNUMTM6NDhaDQogKi8NCihmdW5jdGlvbiggd2luZG93LCB1bmRlZmluZWQgKSB7DQoNCi8vIENhbid0IGRvIHRoaXMgYmVjYXVzZSBzZXZlcmFsIGFwcHMgaW5jbHVkaW5nIEFTUC5ORVQgdHJhY2UNCi8vIHRoZSBzdGFjayB2aWEgYXJndW1lbnRzLmNhbGxlci5jYWxsZWUgYW5kIEZpcmVmb3ggZGllcyBpZg0KLy8geW91IHRyeSB0byB0cmFjZSB0aHJvdWdoICJ1c2Ugc3RyaWN0IiBjYWxsIGNoYWlucy4gKCMxMzMzNSkNCi8vIFN1cHBvcnQ6IEZpcmVmb3ggMTgrDQovLyJ1c2Ugc3RyaWN0IjsNCnZhcg0KCS8vIFRoZSBkZWZlcnJlZCB1c2VkIG9uIERPTSByZWFkeQ0KCXJlYWR5TGlzdCwNCg0KCS8vIEEgY2VudHJhbCByZWZlcmVuY2UgdG8gdGhlIHJvb3QgalF1ZXJ5KGRvY3VtZW50KQ0KCXJvb3RqUXVlcnksDQoNCgkvLyBTdXBwb3J0OiBJRTwxMA0KCS8vIEZvciBgdHlwZW9mIHhtbE5vZGUubWV0aG9kYCBpbnN0ZWFkIG9mIGB4bWxOb2RlLm1ldGhvZCAhPT0gdW5kZWZpbmVkYA0KCWNvcmVfc3RydW5kZWZpbmVkID0gdHlwZW9mIHVuZGVmaW5lZCwNCg0KCS8vIFVzZSB0aGUgY29ycmVjdCBkb2N1bWVudCBhY2NvcmRpbmdseSB3aXRoIHdpbmRvdyBhcmd1bWVudCAoc2FuZGJveCkNCglsb2NhdGlvbiA9IHdpbmRvdy5sb2NhdGlvbiwNCglkb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudCwNCglkb2NFbGVtID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LA0KDQoJLy8gTWFwIG92ZXIgalF1ZXJ5IGluIGNhc2Ugb2Ygb3ZlcndyaXRlDQoJX2pRdWVyeSA9IHdpbmRvdy5qUXVlcnksDQoNCgkvLyBNYXAgb3ZlciB0aGUgJCBpbiBjYXNlIG9mIG92ZXJ3cml0ZQ0KCV8kID0gd2luZG93LiQsDQoNCgkvLyBbW0NsYXNzXV0gLT4gdHlwZSBwYWlycw0KCWNsYXNzMnR5cGUgPSB7fSwNCg0KCS8vIExpc3Qgb2YgZGVsZXRlZCBkYXRhIGNhY2hlIGlkcywgc28gd2UgY2FuIHJldXNlIHRoZW0NCgljb3JlX2RlbGV0ZWRJZHMgPSBbXSwNCg0KCWNvcmVfdmVyc2lvbiA9ICIxLjEwLjIiLA0KDQoJLy8gU2F2ZSBhIHJlZmVyZW5jZSB0byBzb21lIGNvcmUgbWV0aG9kcw0KCWNvcmVfY29uY2F0ID0gY29yZV9kZWxldGVkSWRzLmNvbmNhdCwNCgljb3JlX3B1c2ggPSBjb3JlX2RlbGV0ZWRJZHMucHVzaCwNCgljb3JlX3NsaWNlID0gY29yZV9kZWxldGVkSWRzLnNsaWNlLA0KCWNvcmVfaW5kZXhPZiA9IGNvcmVfZGVsZXRlZElkcy5pbmRleE9mLA0KCWNvcmVfdG9TdHJpbmcgPSBjbGFzczJ0eXBlLnRvU3RyaW5nLA0KCWNvcmVfaGFzT3duID0gY2xhc3MydHlwZS5oYXNPd25Qcm9wZXJ0eSwNCgljb3JlX3RyaW0gPSBjb3JlX3ZlcnNpb24udHJpbSwNCg0KCS8vIERlZmluZSBhIGxvY2FsIGNvcHkgb2YgalF1ZXJ5DQoJalF1ZXJ5ID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0ICkgew0KCQkvLyBUaGUgalF1ZXJ5IG9iamVjdCBpcyBhY3R1YWxseSBqdXN0IHRoZSBpbml0IGNvbnN0cnVjdG9yICdlbmhhbmNlZCcNCgkJcmV0dXJuIG5ldyBqUXVlcnkuZm4uaW5pdCggc2VsZWN0b3IsIGNvbnRleHQsIHJvb3RqUXVlcnkgKTsNCgl9LA0KDQoJLy8gVXNlZCBmb3IgbWF0Y2hpbmcgbnVtYmVycw0KCWNvcmVfcG51bSA9IC9bKy1dPyg/OlxkKlwufClcZCsoPzpbZUVdWystXT9cZCt8KS8uc291cmNlLA0KDQoJLy8gVXNlZCBmb3Igc3BsaXR0aW5nIG9uIHdoaXRlc3BhY2UNCgljb3JlX3Jub3R3aGl0ZSA9IC9cUysvZywNCg0KCS8vIE1ha2Ugc3VyZSB3ZSB0cmltIEJPTSBhbmQgTkJTUCAoaGVyZSdzIGxvb2tpbmcgYXQgeW91LCBTYWZhcmkgNS4wIGFuZCBJRSkNCglydHJpbSA9IC9eW1xzXHVGRUZGXHhBMF0rfFtcc1x1RkVGRlx4QTBdKyQvZywNCg0KCS8vIEEgc2ltcGxlIHdheSB0byBjaGVjayBmb3IgSFRNTCBzdHJpbmdzDQoJLy8gUHJpb3JpdGl6ZSAjaWQgb3ZlciA8dGFnPiB0byBhdm9pZCBYU1MgdmlhIGxvY2F0aW9uLmhhc2ggKCM5NTIxKQ0KCS8vIFN0cmljdCBIVE1MIHJlY29nbml0aW9uICgjMTEyOTA6IG11c3Qgc3RhcnQgd2l0aCA8KQ0KCXJxdWlja0V4cHIgPSAvXig/OlxzKig8W1x3XFddKz4pW14+XSp8IyhbXHctXSopKSQvLA0KDQoJLy8gTWF0Y2ggYSBzdGFuZGFsb25lIHRhZw0KCXJzaW5nbGVUYWcgPSAvXjwoXHcrKVxzKlwvPz4oPzo8XC9cMT58KSQvLA0KDQoJLy8gSlNPTiBSZWdFeHANCglydmFsaWRjaGFycyA9IC9eW1xdLDp7fVxzXSokLywNCglydmFsaWRicmFjZXMgPSAvKD86Xnw6fCwpKD86XHMqXFspKy9nLA0KCXJ2YWxpZGVzY2FwZSA9IC9cXCg/OlsiXFxcL2JmbnJ0XXx1W1xkYS1mQS1GXXs0fSkvZywNCglydmFsaWR0b2tlbnMgPSAvIlteIlxcXHJcbl0qInx0cnVlfGZhbHNlfG51bGx8LT8oPzpcZCtcLnwpXGQrKD86W2VFXVsrLV0/XGQrfCkvZywNCg0KCS8vIE1hdGNoZXMgZGFzaGVkIHN0cmluZyBmb3IgY2FtZWxpemluZw0KCXJtc1ByZWZpeCA9IC9eLW1zLS8sDQoJcmRhc2hBbHBoYSA9IC8tKFtcZGEtel0pL2dpLA0KDQoJLy8gVXNlZCBieSBqUXVlcnkuY2FtZWxDYXNlIGFzIGNhbGxiYWNrIHRvIHJlcGxhY2UoKQ0KCWZjYW1lbENhc2UgPSBmdW5jdGlvbiggYWxsLCBsZXR0ZXIgKSB7DQoJCXJldHVybiBsZXR0ZXIudG9VcHBlckNhc2UoKTsNCgl9LA0KDQoJLy8gVGhlIHJlYWR5IGV2ZW50IGhhbmRsZXINCgljb21wbGV0ZWQgPSBmdW5jdGlvbiggZXZlbnQgKSB7DQoNCgkJLy8gcmVhZHlTdGF0ZSA9PT0gImNvbXBsZXRlIiBpcyBnb29kIGVub3VnaCBmb3IgdXMgdG8gY2FsbCB0aGUgZG9tIHJlYWR5IGluIG9sZElFDQoJCWlmICggZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciB8fCBldmVudC50eXBlID09PSAibG9hZCIgfHwgZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gImNvbXBsZXRlIiApIHsNCgkJCWRldGFjaCgpOw0KCQkJalF1ZXJ5LnJlYWR5KCk7DQoJCX0NCgl9LA0KCS8vIENsZWFuLXVwIG1ldGhvZCBmb3IgZG9tIHJlYWR5IGV2ZW50cw0KCWRldGFjaCA9IGZ1bmN0aW9uKCkgew0KCQlpZiAoIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIgKSB7DQoJCQlkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCAiRE9NQ29udGVudExvYWRlZCIsIGNvbXBsZXRlZCwgZmFsc2UgKTsNCgkJCXdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCAibG9hZCIsIGNvbXBsZXRlZCwgZmFsc2UgKTsNCg0KCQl9IGVsc2Ugew0KCQkJZG9jdW1lbnQuZGV0YWNoRXZlbnQoICJvbnJlYWR5c3RhdGVjaGFuZ2UiLCBjb21wbGV0ZWQgKTsNCgkJCXdpbmRvdy5kZXRhY2hFdmVudCggIm9ubG9hZCIsIGNvbXBsZXRlZCApOw0KCQl9DQoJfTsNCg0KalF1ZXJ5LmZuID0galF1ZXJ5LnByb3RvdHlwZSA9IHsNCgkvLyBUaGUgY3VycmVudCB2ZXJzaW9uIG9mIGpRdWVyeSBiZWluZyB1c2VkDQoJanF1ZXJ5OiBjb3JlX3ZlcnNpb24sDQoNCgljb25zdHJ1Y3RvcjogalF1ZXJ5LA0KCWluaXQ6IGZ1bmN0aW9uKCBzZWxlY3RvciwgY29udGV4dCwgcm9vdGpRdWVyeSApIHsNCgkJdmFyIG1hdGNoLCBlbGVtOw0KDQoJCS8vIEhBTkRMRTogJCgiIiksICQobnVsbCksICQodW5kZWZpbmVkKSwgJChmYWxzZSkNCgkJaWYgKCAhc2VsZWN0b3IgKSB7DQoJCQlyZXR1cm4gdGhpczsNCgkJfQ0KDQoJCS8vIEhhbmRsZSBIVE1MIHN0cmluZ3MNCgkJaWYgKCB0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciICkgew0KCQkJaWYgKCBzZWxlY3Rvci5jaGFyQXQoMCkgPT09ICI8IiAmJiBzZWxlY3Rvci5jaGFyQXQoIHNlbGVjdG9yLmxlbmd0aCAtIDEgKSA9PT0gIj4iICYmIHNlbGVjdG9yLmxlbmd0aCA+PSAzICkgew0KCQkJCS8vIEFzc3VtZSB0aGF0IHN0cmluZ3MgdGhhdCBzdGFydCBhbmQgZW5kIHdpdGggPD4gYXJlIEhUTUwgYW5kIHNraXAgdGhlIHJlZ2V4IGNoZWNrDQoJCQkJbWF0Y2ggPSBbIG51bGwsIHNlbGVjdG9yLCBudWxsIF07DQoNCgkJCX0gZWxzZSB7DQoJCQkJbWF0Y2ggPSBycXVpY2tFeHByLmV4ZWMoIHNlbGVjdG9yICk7DQoJCQl9DQoNCgkJCS8vIE1hdGNoIGh0bWwgb3IgbWFrZSBzdXJlIG5vIGNvbnRleHQgaXMgc3BlY2lmaWVkIGZvciAjaWQNCgkJCWlmICggbWF0Y2ggJiYgKG1hdGNoWzFdIHx8ICFjb250ZXh0KSApIHsNCg0KCQkJCS8vIEhBTkRMRTogJChodG1sKSAtPiAkKGFycmF5KQ0KCQkJCWlmICggbWF0Y2hbMV0gKSB7DQoJCQkJCWNvbnRleHQgPSBjb250ZXh0IGluc3RhbmNlb2YgalF1ZXJ5ID8gY29udGV4dFswXSA6IGNvbnRleHQ7DQoNCgkJCQkJLy8gc2NyaXB0cyBpcyB0cnVlIGZvciBiYWNrLWNvbXBhdA0KCQkJCQlqUXVlcnkubWVyZ2UoIHRoaXMsIGpRdWVyeS5wYXJzZUhUTUwoDQoJCQkJCQltYXRjaFsxXSwNCgkJCQkJCWNvbnRleHQgJiYgY29udGV4dC5ub2RlVHlwZSA/IGNvbnRleHQub3duZXJEb2N1bWVudCB8fCBjb250ZXh0IDogZG9jdW1lbnQsDQoJCQkJCQl0cnVlDQoJCQkJCSkgKTsNCg0KCQkJCQkvLyBIQU5ETEU6ICQoaHRtbCwgcHJvcHMpDQoJCQkJCWlmICggcnNpbmdsZVRhZy50ZXN0KCBtYXRjaFsxXSApICYmIGpRdWVyeS5pc1BsYWluT2JqZWN0KCBjb250ZXh0ICkgKSB7DQoJCQkJCQlmb3IgKCBtYXRjaCBpbiBjb250ZXh0ICkgew0KCQkJCQkJCS8vIFByb3BlcnRpZXMgb2YgY29udGV4dCBhcmUgY2FsbGVkIGFzIG1ldGhvZHMgaWYgcG9zc2libGUNCgkJCQkJCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCB0aGlzWyBtYXRjaCBdICkgKSB7DQoJCQkJCQkJCXRoaXNbIG1hdGNoIF0oIGNvbnRleHRbIG1hdGNoIF0gKTsNCg0KCQkJCQkJCS8vIC4uLmFuZCBvdGhlcndpc2Ugc2V0IGFzIGF0dHJpYnV0ZXMNCgkJCQkJCQl9IGVsc2Ugew0KCQkJCQkJCQl0aGlzLmF0dHIoIG1hdGNoLCBjb250ZXh0WyBtYXRjaCBdICk7DQoJCQkJCQkJfQ0KCQkJCQkJfQ0KCQkJCQl9DQoNCgkJCQkJcmV0dXJuIHRoaXM7DQoNCgkJCQkvLyBIQU5ETEU6ICQoI2lkKQ0KCQkJCX0gZWxzZSB7DQoJCQkJCWVsZW0gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggbWF0Y2hbMl0gKTsNCg0KCQkJCQkvLyBDaGVjayBwYXJlbnROb2RlIHRvIGNhdGNoIHdoZW4gQmxhY2tiZXJyeSA0LjYgcmV0dXJucw0KCQkJCQkvLyBub2RlcyB0aGF0IGFyZSBubyBsb25nZXIgaW4gdGhlIGRvY3VtZW50ICM2OTYzDQoJCQkJCWlmICggZWxlbSAmJiBlbGVtLnBhcmVudE5vZGUgKSB7DQoJCQkJCQkvLyBIYW5kbGUgdGhlIGNhc2Ugd2hlcmUgSUUgYW5kIE9wZXJhIHJldHVybiBpdGVtcw0KCQkJCQkJLy8gYnkgbmFtZSBpbnN0ZWFkIG9mIElEDQoJCQkJCQlpZiAoIGVsZW0uaWQgIT09IG1hdGNoWzJdICkgew0KCQkJCQkJCXJldHVybiByb290alF1ZXJ5LmZpbmQoIHNlbGVjdG9yICk7DQoJCQkJCQl9DQoNCgkJCQkJCS8vIE90aGVyd2lzZSwgd2UgaW5qZWN0IHRoZSBlbGVtZW50IGRpcmVjdGx5IGludG8gdGhlIGpRdWVyeSBvYmplY3QNCgkJCQkJCXRoaXMubGVuZ3RoID0gMTsNCgkJCQkJCXRoaXNbMF0gPSBlbGVtOw0KCQkJCQl9DQoNCgkJCQkJdGhpcy5jb250ZXh0ID0gZG9jdW1lbnQ7DQoJCQkJCXRoaXMuc2VsZWN0b3IgPSBzZWxlY3RvcjsNCgkJCQkJcmV0dXJuIHRoaXM7DQoJCQkJfQ0KDQoJCQkvLyBIQU5ETEU6ICQoZXhwciwgJCguLi4pKQ0KCQkJfSBlbHNlIGlmICggIWNvbnRleHQgfHwgY29udGV4dC5qcXVlcnkgKSB7DQoJCQkJcmV0dXJuICggY29udGV4dCB8fCByb290alF1ZXJ5ICkuZmluZCggc2VsZWN0b3IgKTsNCg0KCQkJLy8gSEFORExFOiAkKGV4cHIsIGNvbnRleHQpDQoJCQkvLyAod2hpY2ggaXMganVzdCBlcXVpdmFsZW50IHRvOiAkKGNvbnRleHQpLmZpbmQoZXhwcikNCgkJCX0gZWxzZSB7DQoJCQkJcmV0dXJuIHRoaXMuY29uc3RydWN0b3IoIGNvbnRleHQgKS5maW5kKCBzZWxlY3RvciApOw0KCQkJfQ0KDQoJCS8vIEhBTkRMRTogJChET01FbGVtZW50KQ0KCQl9IGVsc2UgaWYgKCBzZWxlY3Rvci5ub2RlVHlwZSApIHsNCgkJCXRoaXMuY29udGV4dCA9IHRoaXNbMF0gPSBzZWxlY3RvcjsNCgkJCXRoaXMubGVuZ3RoID0gMTsNCgkJCXJldHVybiB0aGlzOw0KDQoJCS8vIEhBTkRMRTogJChmdW5jdGlvbikNCgkJLy8gU2hvcnRjdXQgZm9yIGRvY3VtZW50IHJlYWR5DQoJCX0gZWxzZSBpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBzZWxlY3RvciApICkgew0KCQkJcmV0dXJuIHJvb3RqUXVlcnkucmVhZHkoIHNlbGVjdG9yICk7DQoJCX0NCg0KCQlpZiAoIHNlbGVjdG9yLnNlbGVjdG9yICE9PSB1bmRlZmluZWQgKSB7DQoJCQl0aGlzLnNlbGVjdG9yID0gc2VsZWN0b3Iuc2VsZWN0b3I7DQoJCQl0aGlzLmNvbnRleHQgPSBzZWxlY3Rvci5jb250ZXh0Ow0KCQl9DQoNCgkJcmV0dXJuIGpRdWVyeS5tYWtlQXJyYXkoIHNlbGVjdG9yLCB0aGlzICk7DQoJfSwNCg0KCS8vIFN0YXJ0IHdpdGggYW4gZW1wdHkgc2VsZWN0b3INCglzZWxlY3RvcjogIiIsDQoNCgkvLyBUaGUgZGVmYXVsdCBsZW5ndGggb2YgYSBqUXVlcnkgb2JqZWN0IGlzIDANCglsZW5ndGg6IDAsDQoNCgl0b0FycmF5OiBmdW5jdGlvbigpIHsNCgkJcmV0dXJuIGNvcmVfc2xpY2UuY2FsbCggdGhpcyApOw0KCX0sDQoNCgkvLyBHZXQgdGhlIE50aCBlbGVtZW50IGluIHRoZSBtYXRjaGVkIGVsZW1lbnQgc2V0IE9SDQoJLy8gR2V0IHRoZSB3aG9sZSBtYXRjaGVkIGVsZW1lbnQgc2V0IGFzIGEgY2xlYW4gYXJyYXkNCglnZXQ6IGZ1bmN0aW9uKCBudW0gKSB7DQoJCXJldHVybiBudW0gPT0gbnVsbCA/DQoNCgkJCS8vIFJldHVybiBhICdjbGVhbicgYXJyYXkNCgkJCXRoaXMudG9BcnJheSgpIDoNCg0KCQkJLy8gUmV0dXJuIGp1c3QgdGhlIG9iamVjdA0KCQkJKCBudW0gPCAwID8gdGhpc1sgdGhpcy5sZW5ndGggKyBudW0gXSA6IHRoaXNbIG51bSBdICk7DQoJfSwNCg0KCS8vIFRha2UgYW4gYXJyYXkgb2YgZWxlbWVudHMgYW5kIHB1c2ggaXQgb250byB0aGUgc3RhY2sNCgkvLyAocmV0dXJuaW5nIHRoZSBuZXcgbWF0Y2hlZCBlbGVtZW50IHNldCkNCglwdXNoU3RhY2s6IGZ1bmN0aW9uKCBlbGVtcyApIHsNCg0KCQkvLyBCdWlsZCBhIG5ldyBqUXVlcnkgbWF0Y2hlZCBlbGVtZW50IHNldA0KCQl2YXIgcmV0ID0galF1ZXJ5Lm1lcmdlKCB0aGlzLmNvbnN0cnVjdG9yKCksIGVsZW1zICk7DQoNCgkJLy8gQWRkIHRoZSBvbGQgb2JqZWN0IG9udG8gdGhlIHN0YWNrIChhcyBhIHJlZmVyZW5jZSkNCgkJcmV0LnByZXZPYmplY3QgPSB0aGlzOw0KCQlyZXQuY29udGV4dCA9IHRoaXMuY29udGV4dDsNCg0KCQkvLyBSZXR1cm4gdGhlIG5ld2x5LWZvcm1lZCBlbGVtZW50IHNldA0KCQlyZXR1cm4gcmV0Ow0KCX0sDQoNCgkvLyBFeGVjdXRlIGEgY2FsbGJhY2sgZm9yIGV2ZXJ5IGVsZW1lbnQgaW4gdGhlIG1hdGNoZWQgc2V0Lg0KCS8vIChZb3UgY2FuIHNlZWQgdGhlIGFyZ3VtZW50cyB3aXRoIGFuIGFycmF5IG9mIGFyZ3MsIGJ1dCB0aGlzIGlzDQoJLy8gb25seSB1c2VkIGludGVybmFsbHkuKQ0KCWVhY2g6IGZ1bmN0aW9uKCBjYWxsYmFjaywgYXJncyApIHsNCgkJcmV0dXJuIGpRdWVyeS5lYWNoKCB0aGlzLCBjYWxsYmFjaywgYXJncyApOw0KCX0sDQoNCglyZWFkeTogZnVuY3Rpb24oIGZuICkgew0KCQkvLyBBZGQgdGhlIGNhbGxiYWNrDQoJCWpRdWVyeS5yZWFkeS5wcm9taXNlKCkuZG9uZSggZm4gKTsNCg0KCQlyZXR1cm4gdGhpczsNCgl9LA0KDQoJc2xpY2U6IGZ1bmN0aW9uKCkgew0KCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIGNvcmVfc2xpY2UuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApICk7DQoJfSwNCg0KCWZpcnN0OiBmdW5jdGlvbigpIHsNCgkJcmV0dXJuIHRoaXMuZXEoIDAgKTsNCgl9LA0KDQoJbGFzdDogZnVuY3Rpb24oKSB7DQoJCXJldHVybiB0aGlzLmVxKCAtMSApOw0KCX0sDQoNCgllcTogZnVuY3Rpb24oIGkgKSB7DQoJCXZhciBsZW4gPSB0aGlzLmxlbmd0aCwNCgkJCWogPSAraSArICggaSA8IDAgPyBsZW4gOiAwICk7DQoJCXJldHVybiB0aGlzLnB1c2hTdGFjayggaiA+PSAwICYmIGogPCBsZW4gPyBbIHRoaXNbal0gXSA6IFtdICk7DQoJfSwNCg0KCW1hcDogZnVuY3Rpb24oIGNhbGxiYWNrICkgew0KCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIGpRdWVyeS5tYXAodGhpcywgZnVuY3Rpb24oIGVsZW0sIGkgKSB7DQoJCQlyZXR1cm4gY2FsbGJhY2suY2FsbCggZWxlbSwgaSwgZWxlbSApOw0KCQl9KSk7DQoJfSwNCg0KCWVuZDogZnVuY3Rpb24oKSB7DQoJCXJldHVybiB0aGlzLnByZXZPYmplY3QgfHwgdGhpcy5jb25zdHJ1Y3RvcihudWxsKTsNCgl9LA0KDQoJLy8gRm9yIGludGVybmFsIHVzZSBvbmx5Lg0KCS8vIEJlaGF2ZXMgbGlrZSBhbiBBcnJheSdzIG1ldGhvZCwgbm90IGxpa2UgYSBqUXVlcnkgbWV0aG9kLg0KCXB1c2g6IGNvcmVfcHVzaCwNCglzb3J0OiBbXS5zb3J0LA0KCXNwbGljZTogW10uc3BsaWNlDQp9Ow0KDQovLyBHaXZlIHRoZSBpbml0IGZ1bmN0aW9uIHRoZSBqUXVlcnkgcHJvdG90eXBlIGZvciBsYXRlciBpbnN0YW50aWF0aW9uDQpqUXVlcnkuZm4uaW5pdC5wcm90b3R5cGUgPSBqUXVlcnkuZm47DQoNCmpRdWVyeS5leHRlbmQgPSBqUXVlcnkuZm4uZXh0ZW5kID0gZnVuY3Rpb24oKSB7DQoJdmFyIHNyYywgY29weUlzQXJyYXksIGNvcHksIG5hbWUsIG9wdGlvbnMsIGNsb25lLA0KCQl0YXJnZXQgPSBhcmd1bWVudHNbMF0gfHwge30sDQoJCWkgPSAxLA0KCQlsZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoLA0KCQlkZWVwID0gZmFsc2U7DQoNCgkvLyBIYW5kbGUgYSBkZWVwIGNvcHkgc2l0dWF0aW9uDQoJaWYgKCB0eXBlb2YgdGFyZ2V0ID09PSAiYm9vbGVhbiIgKSB7DQoJCWRlZXAgPSB0YXJnZXQ7DQoJCXRhcmdldCA9IGFyZ3VtZW50c1sxXSB8fCB7fTsNCgkJLy8gc2tpcCB0aGUgYm9vbGVhbiBhbmQgdGhlIHRhcmdldA0KCQlpID0gMjsNCgl9DQoNCgkvLyBIYW5kbGUgY2FzZSB3aGVuIHRhcmdldCBpcyBhIHN0cmluZyBvciBzb21ldGhpbmcgKHBvc3NpYmxlIGluIGRlZXAgY29weSkNCglpZiAoIHR5cGVvZiB0YXJnZXQgIT09ICJvYmplY3QiICYmICFqUXVlcnkuaXNGdW5jdGlvbih0YXJnZXQpICkgew0KCQl0YXJnZXQgPSB7fTsNCgl9DQoNCgkvLyBleHRlbmQgalF1ZXJ5IGl0c2VsZiBpZiBvbmx5IG9uZSBhcmd1bWVudCBpcyBwYXNzZWQNCglpZiAoIGxlbmd0aCA9PT0gaSApIHsNCgkJdGFyZ2V0ID0gdGhpczsNCgkJLS1pOw0KCX0NCg0KCWZvciAoIDsgaSA8IGxlbmd0aDsgaSsrICkgew0KCQkvLyBPbmx5IGRlYWwgd2l0aCBub24tbnVsbC91bmRlZmluZWQgdmFsdWVzDQoJCWlmICggKG9wdGlvbnMgPSBhcmd1bWVudHNbIGkgXSkgIT0gbnVsbCApIHsNCgkJCS8vIEV4dGVuZCB0aGUgYmFzZSBvYmplY3QNCgkJCWZvciAoIG5hbWUgaW4gb3B0aW9ucyApIHsNCgkJCQlzcmMgPSB0YXJnZXRbIG5hbWUgXTsNCgkJCQljb3B5ID0gb3B0aW9uc1sgbmFtZSBdOw0KDQoJCQkJLy8gUHJldmVudCBuZXZlci1lbmRpbmcgbG9vcA0KCQkJCWlmICggdGFyZ2V0ID09PSBjb3B5ICkgew0KCQkJCQljb250aW51ZTsNCgkJCQl9DQoNCgkJCQkvLyBSZWN1cnNlIGlmIHdlJ3JlIG1lcmdpbmcgcGxhaW4gb2JqZWN0cyBvciBhcnJheXMNCgkJCQlpZiAoIGRlZXAgJiYgY29weSAmJiAoIGpRdWVyeS5pc1BsYWluT2JqZWN0KGNvcHkpIHx8IChjb3B5SXNBcnJheSA9IGpRdWVyeS5pc0FycmF5KGNvcHkpKSApICkgew0KCQkJCQlpZiAoIGNvcHlJc0FycmF5ICkgew0KCQkJCQkJY29weUlzQXJyYXkgPSBmYWxzZTsNCgkJCQkJCWNsb25lID0gc3JjICYmIGpRdWVyeS5pc0FycmF5KHNyYykgPyBzcmMgOiBbXTsNCg0KCQkJCQl9IGVsc2Ugew0KCQkJCQkJY2xvbmUgPSBzcmMgJiYgalF1ZXJ5LmlzUGxhaW5PYmplY3Qoc3JjKSA/IHNyYyA6IHt9Ow0KCQkJCQl9DQoNCgkJCQkJLy8gTmV2ZXIgbW92ZSBvcmlnaW5hbCBvYmplY3RzLCBjbG9uZSB0aGVtDQoJCQkJCXRhcmdldFsgbmFtZSBdID0galF1ZXJ5LmV4dGVuZCggZGVlcCwgY2xvbmUsIGNvcHkgKTsNCg0KCQkJCS8vIERvbid0IGJyaW5nIGluIHVuZGVmaW5lZCB2YWx1ZXMNCgkJCQl9IGVsc2UgaWYgKCBjb3B5ICE9PSB1bmRlZmluZWQgKSB7DQoJCQkJCXRhcmdldFsgbmFtZSBdID0gY29weTsNCgkJCQl9DQoJCQl9DQoJCX0NCgl9DQoNCgkvLyBSZXR1cm4gdGhlIG1vZGlmaWVkIG9iamVjdA0KCXJldHVybiB0YXJnZXQ7DQp9Ow0KDQpqUXVlcnkuZXh0ZW5kKHsNCgkvLyBVbmlxdWUgZm9yIGVhY2ggY29weSBvZiBqUXVlcnkgb24gdGhlIHBhZ2UNCgkvLyBOb24tZGlnaXRzIHJlbW92ZWQgdG8gbWF0Y2ggcmlubGluZWpRdWVyeQ0KCWV4cGFuZG86ICJqUXVlcnkiICsgKCBjb3JlX3ZlcnNpb24gKyBNYXRoLnJhbmRvbSgpICkucmVwbGFjZSggL1xEL2csICIiICksDQoNCglub0NvbmZsaWN0OiBmdW5jdGlvbiggZGVlcCApIHsNCgkJaWYgKCB3aW5kb3cuJCA9PT0galF1ZXJ5ICkgew0KCQkJd2luZG93LiQgPSBfJDsNCgkJfQ0KDQoJCWlmICggZGVlcCAmJiB3aW5kb3cualF1ZXJ5ID09PSBqUXVlcnkgKSB7DQoJCQl3aW5kb3cualF1ZXJ5ID0gX2pRdWVyeTsNCgkJfQ0KDQoJCXJldHVybiBqUXVlcnk7DQoJfSwNCg0KCS8vIElzIHRoZSBET00gcmVhZHkgdG8gYmUgdXNlZD8gU2V0IHRvIHRydWUgb25jZSBpdCBvY2N1cnMuDQoJaXNSZWFkeTogZmFsc2UsDQoNCgkvLyBBIGNvdW50ZXIgdG8gdHJhY2sgaG93IG1hbnkgaXRlbXMgdG8gd2FpdCBmb3IgYmVmb3JlDQoJLy8gdGhlIHJlYWR5IGV2ZW50IGZpcmVzLiBTZWUgIzY3ODENCglyZWFkeVdhaXQ6IDEsDQoNCgkvLyBIb2xkIChvciByZWxlYXNlKSB0aGUgcmVhZHkgZXZlbnQNCglob2xkUmVhZHk6IGZ1bmN0aW9uKCBob2xkICkgew0KCQlpZiAoIGhvbGQgKSB7DQoJCQlqUXVlcnkucmVhZHlXYWl0Kys7DQoJCX0gZWxzZSB7DQoJCQlqUXVlcnkucmVhZHkoIHRydWUgKTsNCgkJfQ0KCX0sDQoNCgkvLyBIYW5kbGUgd2hlbiB0aGUgRE9NIGlzIHJlYWR5DQoJcmVhZHk6IGZ1bmN0aW9uKCB3YWl0ICkgew0KDQoJCS8vIEFib3J0IGlmIHRoZXJlIGFyZSBwZW5kaW5nIGhvbGRzIG9yIHdlJ3JlIGFscmVhZHkgcmVhZHkNCgkJaWYgKCB3YWl0ID09PSB0cnVlID8gLS1qUXVlcnkucmVhZHlXYWl0IDogalF1ZXJ5LmlzUmVhZHkgKSB7DQoJCQlyZXR1cm47DQoJCX0NCg0KCQkvLyBNYWtlIHN1cmUgYm9keSBleGlzdHMsIGF0IGxlYXN0LCBpbiBjYXNlIElFIGdldHMgYSBsaXR0bGUgb3ZlcnplYWxvdXMgKHRpY2tldCAjNTQ0MykuDQoJCWlmICggIWRvY3VtZW50LmJvZHkgKSB7DQoJCQlyZXR1cm4gc2V0VGltZW91dCggalF1ZXJ5LnJlYWR5ICk7DQoJCX0NCg0KCQkvLyBSZW1lbWJlciB0aGF0IHRoZSBET00gaXMgcmVhZHkNCgkJalF1ZXJ5LmlzUmVhZHkgPSB0cnVlOw0KDQoJCS8vIElmIGEgbm9ybWFsIERPTSBSZWFkeSBldmVudCBmaXJlZCwgZGVjcmVtZW50LCBhbmQgd2FpdCBpZiBuZWVkIGJlDQoJCWlmICggd2FpdCAhPT0gdHJ1ZSAmJiAtLWpRdWVyeS5yZWFkeVdhaXQgPiAwICkgew0KCQkJcmV0dXJuOw0KCQl9DQoNCgkJLy8gSWYgdGhlcmUgYXJlIGZ1bmN0aW9ucyBib3VuZCwgdG8gZXhlY3V0ZQ0KCQlyZWFkeUxpc3QucmVzb2x2ZVdpdGgoIGRvY3VtZW50LCBbIGpRdWVyeSBdICk7DQoNCgkJLy8gVHJpZ2dlciBhbnkgYm91bmQgcmVhZHkgZXZlbnRzDQoJCWlmICggalF1ZXJ5LmZuLnRyaWdnZXIgKSB7DQoJCQlqUXVlcnkoIGRvY3VtZW50ICkudHJpZ2dlcigicmVhZHkiKS5vZmYoInJlYWR5Iik7DQoJCX0NCgl9LA0KDQoJLy8gU2VlIHRlc3QvdW5pdC9jb3JlLmpzIGZvciBkZXRhaWxzIGNvbmNlcm5pbmcgaXNGdW5jdGlvbi4NCgkvLyBTaW5jZSB2ZXJzaW9uIDEuMywgRE9NIG1ldGhvZHMgYW5kIGZ1bmN0aW9ucyBsaWtlIGFsZXJ0DQoJLy8gYXJlbid0IHN1cHBvcnRlZC4gVGhleSByZXR1cm4gZmFsc2Ugb24gSUUgKCMyOTY4KS4NCglpc0Z1bmN0aW9uOiBmdW5jdGlvbiggb2JqICkgew0KCQlyZXR1cm4galF1ZXJ5LnR5cGUob2JqKSA9PT0gImZ1bmN0aW9uIjsNCgl9LA0KDQoJaXNBcnJheTogQXJyYXkuaXNBcnJheSB8fCBmdW5jdGlvbiggb2JqICkgew0KCQlyZXR1cm4galF1ZXJ5LnR5cGUob2JqKSA9PT0gImFycmF5IjsNCgl9LA0KDQoJaXNXaW5kb3c6IGZ1bmN0aW9uKCBvYmogKSB7DQoJCS8qIGpzaGludCBlcWVxZXE6IGZhbHNlICovDQoJCXJldHVybiBvYmogIT0gbnVsbCAmJiBvYmogPT0gb2JqLndpbmRvdzsNCgl9LA0KDQoJaXNOdW1lcmljOiBmdW5jdGlvbiggb2JqICkgew0KCQlyZXR1cm4gIWlzTmFOKCBwYXJzZUZsb2F0KG9iaikgKSAmJiBpc0Zpbml0ZSggb2JqICk7DQoJfSwNCg0KCXR5cGU6IGZ1bmN0aW9uKCBvYmogKSB7DQoJCWlmICggb2JqID09IG51bGwgKSB7DQoJCQlyZXR1cm4gU3RyaW5nKCBvYmogKTsNCgkJfQ0KCQlyZXR1cm4gdHlwZW9mIG9iaiA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIG9iaiA9PT0gImZ1bmN0aW9uIiA/DQoJCQljbGFzczJ0eXBlWyBjb3JlX3RvU3RyaW5nLmNhbGwob2JqKSBdIHx8ICJvYmplY3QiIDoNCgkJCXR5cGVvZiBvYmo7DQoJfSwNCg0KCWlzUGxhaW5PYmplY3Q6IGZ1bmN0aW9uKCBvYmogKSB7DQoJCXZhciBrZXk7DQoNCgkJLy8gTXVzdCBiZSBhbiBPYmplY3QuDQoJCS8vIEJlY2F1c2Ugb2YgSUUsIHdlIGFsc28gaGF2ZSB0byBjaGVjayB0aGUgcHJlc2VuY2Ugb2YgdGhlIGNvbnN0cnVjdG9yIHByb3BlcnR5Lg0KCQkvLyBNYWtlIHN1cmUgdGhhdCBET00gbm9kZXMgYW5kIHdpbmRvdyBvYmplY3RzIGRvbid0IHBhc3MgdGhyb3VnaCwgYXMgd2VsbA0KCQlpZiAoICFvYmogfHwgalF1ZXJ5LnR5cGUob2JqKSAhPT0gIm9iamVjdCIgfHwgb2JqLm5vZGVUeXBlIHx8IGpRdWVyeS5pc1dpbmRvdyggb2JqICkgKSB7DQoJCQlyZXR1cm4gZmFsc2U7DQoJCX0NCg0KCQl0cnkgew0KCQkJLy8gTm90IG93biBjb25zdHJ1Y3RvciBwcm9wZXJ0eSBtdXN0IGJlIE9iamVjdA0KCQkJaWYgKCBvYmouY29uc3RydWN0b3IgJiYNCgkJCQkhY29yZV9oYXNPd24uY2FsbChvYmosICJjb25zdHJ1Y3RvciIpICYmDQoJCQkJIWNvcmVfaGFzT3duLmNhbGwob2JqLmNvbnN0cnVjdG9yLnByb3RvdHlwZSwgImlzUHJvdG90eXBlT2YiKSApIHsNCgkJCQlyZXR1cm4gZmFsc2U7DQoJCQl9DQoJCX0gY2F0Y2ggKCBlICkgew0KCQkJLy8gSUU4LDkgV2lsbCB0aHJvdyBleGNlcHRpb25zIG9uIGNlcnRhaW4gaG9zdCBvYmplY3RzICM5ODk3DQoJCQlyZXR1cm4gZmFsc2U7DQoJCX0NCg0KCQkvLyBTdXBwb3J0OiBJRTw5DQoJCS8vIEhhbmRsZSBpdGVyYXRpb24gb3ZlciBpbmhlcml0ZWQgcHJvcGVydGllcyBiZWZvcmUgb3duIHByb3BlcnRpZXMuDQoJCWlmICggalF1ZXJ5LnN1cHBvcnQub3duTGFzdCApIHsNCgkJCWZvciAoIGtleSBpbiBvYmogKSB7DQoJCQkJcmV0dXJuIGNvcmVfaGFzT3duLmNhbGwoIG9iaiwga2V5ICk7DQoJCQl9DQoJCX0NCg0KCQkvLyBPd24gcHJvcGVydGllcyBhcmUgZW51bWVyYXRlZCBmaXJzdGx5LCBzbyB0byBzcGVlZCB1cCwNCgkJLy8gaWYgbGFzdCBvbmUgaXMgb3duLCB0aGVuIGFsbCBwcm9wZXJ0aWVzIGFyZSBvd24uDQoJCWZvciAoIGtleSBpbiBvYmogKSB7fQ0KDQoJCXJldHVybiBrZXkgPT09IHVuZGVmaW5lZCB8fCBjb3JlX2hhc093bi5jYWxsKCBvYmosIGtleSApOw0KCX0sDQoNCglpc0VtcHR5T2JqZWN0OiBmdW5jdGlvbiggb2JqICkgew0KCQl2YXIgbmFtZTsNCgkJZm9yICggbmFtZSBpbiBvYmogKSB7DQoJCQlyZXR1cm4gZmFsc2U7DQoJCX0NCgkJcmV0dXJuIHRydWU7DQoJfSwNCg0KCWVycm9yOiBmdW5jdGlvbiggbXNnICkgew0KCQl0aHJvdyBuZXcgRXJyb3IoIG1zZyApOw0KCX0sDQoNCgkvLyBkYXRhOiBzdHJpbmcgb2YgaHRtbA0KCS8vIGNvbnRleHQgKG9wdGlvbmFsKTogSWYgc3BlY2lmaWVkLCB0aGUgZnJhZ21lbnQgd2lsbCBiZSBjcmVhdGVkIGluIHRoaXMgY29udGV4dCwgZGVmYXVsdHMgdG8gZG9jdW1lbnQNCgkvLyBrZWVwU2NyaXB0cyAob3B0aW9uYWwpOiBJZiB0cnVlLCB3aWxsIGluY2x1ZGUgc2NyaXB0cyBwYXNzZWQgaW4gdGhlIGh0bWwgc3RyaW5nDQoJcGFyc2VIVE1MOiBmdW5jdGlvbiggZGF0YSwgY29udGV4dCwga2VlcFNjcmlwdHMgKSB7DQoJCWlmICggIWRhdGEgfHwgdHlwZW9mIGRhdGEgIT09ICJzdHJpbmciICkgew0KCQkJcmV0dXJuIG51bGw7DQoJCX0NCgkJaWYgKCB0eXBlb2YgY29udGV4dCA9PT0gImJvb2xlYW4iICkgew0KCQkJa2VlcFNjcmlwdHMgPSBjb250ZXh0Ow0KCQkJY29udGV4dCA9IGZhbHNlOw0KCQl9DQoJCWNvbnRleHQgPSBjb250ZXh0IHx8IGRvY3VtZW50Ow0KDQoJCXZhciBwYXJzZWQgPSByc2luZ2xlVGFnLmV4ZWMoIGRhdGEgKSwNCgkJCXNjcmlwdHMgPSAha2VlcFNjcmlwdHMgJiYgW107DQoNCgkJLy8gU2luZ2xlIHRhZw0KCQlpZiAoIHBhcnNlZCApIHsNCgkJCXJldHVybiBbIGNvbnRleHQuY3JlYXRlRWxlbWVudCggcGFyc2VkWzFdICkgXTsNCgkJfQ0KDQoJCXBhcnNlZCA9IGpRdWVyeS5idWlsZEZyYWdtZW50KCBbIGRhdGEgXSwgY29udGV4dCwgc2NyaXB0cyApOw0KCQlpZiAoIHNjcmlwdHMgKSB7DQoJCQlqUXVlcnkoIHNjcmlwdHMgKS5yZW1vdmUoKTsNCgkJfQ0KCQlyZXR1cm4galF1ZXJ5Lm1lcmdlKCBbXSwgcGFyc2VkLmNoaWxkTm9kZXMgKTsNCgl9LA0KDQoJcGFyc2VKU09OOiBmdW5jdGlvbiggZGF0YSApIHsNCgkJLy8gQXR0ZW1wdCB0byBwYXJzZSB1c2luZyB0aGUgbmF0aXZlIEpTT04gcGFyc2VyIGZpcnN0DQoJCWlmICggd2luZG93LkpTT04gJiYgd2luZG93LkpTT04ucGFyc2UgKSB7DQoJCQlyZXR1cm4gd2luZG93LkpTT04ucGFyc2UoIGRhdGEgKTsNCgkJfQ0KDQoJCWlmICggZGF0YSA9PT0gbnVsbCApIHsNCgkJCXJldHVybiBkYXRhOw0KCQl9DQoNCgkJaWYgKCB0eXBlb2YgZGF0YSA9PT0gInN0cmluZyIgKSB7DQoNCgkJCS8vIE1ha2Ugc3VyZSBsZWFkaW5nL3RyYWlsaW5nIHdoaXRlc3BhY2UgaXMgcmVtb3ZlZCAoSUUgY2FuJ3QgaGFuZGxlIGl0KQ0KCQkJZGF0YSA9IGpRdWVyeS50cmltKCBkYXRhICk7DQoNCgkJCWlmICggZGF0YSApIHsNCgkJCQkvLyBNYWtlIHN1cmUgdGhlIGluY29taW5nIGRhdGEgaXMgYWN0dWFsIEpTT04NCgkJCQkvLyBMb2dpYyBib3Jyb3dlZCBmcm9tIGh0dHA6Ly9qc29uLm9yZy9qc29uMi5qcw0KCQkJCWlmICggcnZhbGlkY2hhcnMudGVzdCggZGF0YS5yZXBsYWNlKCBydmFsaWRlc2NhcGUsICJAIiApDQoJCQkJCS5yZXBsYWNlKCBydmFsaWR0b2tlbnMsICJdIiApDQoJCQkJCS5yZXBsYWNlKCBydmFsaWRicmFjZXMsICIiKSkgKSB7DQoNCgkJCQkJcmV0dXJuICggbmV3IEZ1bmN0aW9uKCAicmV0dXJuICIgKyBkYXRhICkgKSgpOw0KCQkJCX0NCgkJCX0NCgkJfQ0KDQoJCWpRdWVyeS5lcnJvciggIkludmFsaWQgSlNPTjogIiArIGRhdGEgKTsNCgl9LA0KDQoJLy8gQ3Jvc3MtYnJvd3NlciB4bWwgcGFyc2luZw0KCXBhcnNlWE1MOiBmdW5jdGlvbiggZGF0YSApIHsNCgkJdmFyIHhtbCwgdG1wOw0KCQlpZiAoICFkYXRhIHx8IHR5cGVvZiBkYXRhICE9PSAic3RyaW5nIiApIHsNCgkJCXJldHVybiBudWxsOw0KCQl9DQoJCXRyeSB7DQoJCQlpZiAoIHdpbmRvdy5ET01QYXJzZXIgKSB7IC8vIFN0YW5kYXJkDQoJCQkJdG1wID0gbmV3IERPTVBhcnNlcigpOw0KCQkJCXhtbCA9IHRtcC5wYXJzZUZyb21TdHJpbmcoIGRhdGEgLCAidGV4dC94bWwiICk7DQoJCQl9IGVsc2UgeyAvLyBJRQ0KCQkJCXhtbCA9IG5ldyBBY3RpdmVYT2JqZWN0KCAiTWljcm9zb2Z0LlhNTERPTSIgKTsNCgkJCQl4bWwuYXN5bmMgPSAiZmFsc2UiOw0KCQkJCXhtbC5sb2FkWE1MKCBkYXRhICk7DQoJCQl9DQoJCX0gY2F0Y2goIGUgKSB7DQoJCQl4bWwgPSB1bmRlZmluZWQ7DQoJCX0NCgkJaWYgKCAheG1sIHx8ICF4bWwuZG9jdW1lbnRFbGVtZW50IHx8IHhtbC5nZXRFbGVtZW50c0J5VGFnTmFtZSggInBhcnNlcmVycm9yIiApLmxlbmd0aCApIHsNCgkJCWpRdWVyeS5lcnJvciggIkludmFsaWQgWE1MOiAiICsgZGF0YSApOw0KCQl9DQoJCXJldHVybiB4bWw7DQoJfSwNCg0KCW5vb3A6IGZ1bmN0aW9uKCkge30sDQoNCgkvLyBFdmFsdWF0ZXMgYSBzY3JpcHQgaW4gYSBnbG9iYWwgY29udGV4dA0KCS8vIFdvcmthcm91bmRzIGJhc2VkIG9uIGZpbmRpbmdzIGJ5IEppbSBEcmlzY29sbA0KCS8vIGh0dHA6Ly93ZWJsb2dzLmphdmEubmV0L2Jsb2cvZHJpc2NvbGwvYXJjaGl2ZS8yMDA5LzA5LzA4L2V2YWwtamF2YXNjcmlwdC1nbG9iYWwtY29udGV4dA0KCWdsb2JhbEV2YWw6IGZ1bmN0aW9uKCBkYXRhICkgew0KCQlpZiAoIGRhdGEgJiYgalF1ZXJ5LnRyaW0oIGRhdGEgKSApIHsNCgkJCS8vIFdlIHVzZSBleGVjU2NyaXB0IG9uIEludGVybmV0IEV4cGxvcmVyDQoJCQkvLyBXZSB1c2UgYW4gYW5vbnltb3VzIGZ1bmN0aW9uIHNvIHRoYXQgY29udGV4dCBpcyB3aW5kb3cNCgkJCS8vIHJhdGhlciB0aGFuIGpRdWVyeSBpbiBGaXJlZm94DQoJCQkoIHdpbmRvdy5leGVjU2NyaXB0IHx8IGZ1bmN0aW9uKCBkYXRhICkgew0KCQkJCXdpbmRvd1sgImV2YWwiIF0uY2FsbCggd2luZG93LCBkYXRhICk7DQoJCQl9ICkoIGRhdGEgKTsNCgkJfQ0KCX0sDQoNCgkvLyBDb252ZXJ0IGRhc2hlZCB0byBjYW1lbENhc2U7IHVzZWQgYnkgdGhlIGNzcyBhbmQgZGF0YSBtb2R1bGVzDQoJLy8gTWljcm9zb2Z0IGZvcmdvdCB0byBodW1wIHRoZWlyIHZlbmRvciBwcmVmaXggKCM5NTcyKQ0KCWNhbWVsQ2FzZTogZnVuY3Rpb24oIHN0cmluZyApIHsNCgkJcmV0dXJuIHN0cmluZy5yZXBsYWNlKCBybXNQcmVmaXgsICJtcy0iICkucmVwbGFjZSggcmRhc2hBbHBoYSwgZmNhbWVsQ2FzZSApOw0KCX0sDQoNCglub2RlTmFtZTogZnVuY3Rpb24oIGVsZW0sIG5hbWUgKSB7DQoJCXJldHVybiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbmFtZS50b0xvd2VyQ2FzZSgpOw0KCX0sDQoNCgkvLyBhcmdzIGlzIGZvciBpbnRlcm5hbCB1c2FnZSBvbmx5DQoJZWFjaDogZnVuY3Rpb24oIG9iaiwgY2FsbGJhY2ssIGFyZ3MgKSB7DQoJCXZhciB2YWx1ZSwNCgkJCWkgPSAwLA0KCQkJbGVuZ3RoID0gb2JqLmxlbmd0aCwNCgkJCWlzQXJyYXkgPSBpc0FycmF5bGlrZSggb2JqICk7DQoNCgkJaWYgKCBhcmdzICkgew0KCQkJaWYgKCBpc0FycmF5ICkgew0KCQkJCWZvciAoIDsgaSA8IGxlbmd0aDsgaSsrICkgew0KCQkJCQl2YWx1ZSA9IGNhbGxiYWNrLmFwcGx5KCBvYmpbIGkgXSwgYXJncyApOw0KDQoJCQkJCWlmICggdmFsdWUgPT09IGZhbHNlICkgew0KCQkJCQkJYnJlYWs7DQoJCQkJCX0NCgkJCQl9DQoJCQl9IGVsc2Ugew0KCQkJCWZvciAoIGkgaW4gb2JqICkgew0KCQkJCQl2YWx1ZSA9IGNhbGxiYWNrLmFwcGx5KCBvYmpbIGkgXSwgYXJncyApOw0KDQoJCQkJCWlmICggdmFsdWUgPT09IGZhbHNlICkgew0KCQkJCQkJYnJlYWs7DQoJCQkJCX0NCgkJCQl9DQoJCQl9DQoNCgkJLy8gQSBzcGVjaWFsLCBmYXN0LCBjYXNlIGZvciB0aGUgbW9zdCBjb21tb24gdXNlIG9mIGVhY2gNCgkJfSBlbHNlIHsNCgkJCWlmICggaXNBcnJheSApIHsNCgkJCQlmb3IgKCA7IGkgPCBsZW5ndGg7IGkrKyApIHsNCgkJCQkJdmFsdWUgPSBjYWxsYmFjay5jYWxsKCBvYmpbIGkgXSwgaSwgb2JqWyBpIF0gKTsNCg0KCQkJCQlpZiAoIHZhbHVlID09PSBmYWxzZSApIHsNCgkJCQkJCWJyZWFrOw0KCQkJCQl9DQoJCQkJfQ0KCQkJfSBlbHNlIHsNCgkJCQlmb3IgKCBpIGluIG9iaiApIHsNCgkJCQkJdmFsdWUgPSBjYWxsYmFjay5jYWxsKCBvYmpbIGkgXSwgaSwgb2JqWyBpIF0gKTsNCg0KCQkJCQlpZiAoIHZhbHVlID09PSBmYWxzZSApIHsNCgkJCQkJCWJyZWFrOw0KCQkJCQl9DQoJCQkJfQ0KCQkJfQ0KCQl9DQoNCgkJcmV0dXJuIG9iajsNCgl9LA0KDQoJLy8gVXNlIG5hdGl2ZSBTdHJpbmcudHJpbSBmdW5jdGlvbiB3aGVyZXZlciBwb3NzaWJsZQ0KCXRyaW06IGNvcmVfdHJpbSAmJiAhY29yZV90cmltLmNhbGwoIlx1RkVGRlx4QTAiKSA/DQoJCWZ1bmN0aW9uKCB0ZXh0ICkgew0KCQkJcmV0dXJuIHRleHQgPT0gbnVsbCA/DQoJCQkJIiIgOg0KCQkJCWNvcmVfdHJpbS5jYWxsKCB0ZXh0ICk7DQoJCX0gOg0KDQoJCS8vIE90aGVyd2lzZSB1c2Ugb3VyIG93biB0cmltbWluZyBmdW5jdGlvbmFsaXR5DQoJCWZ1bmN0aW9uKCB0ZXh0ICkgew0KCQkJcmV0dXJuIHRleHQgPT0gbnVsbCA/DQoJCQkJIiIgOg0KCQkJCSggdGV4dCArICIiICkucmVwbGFjZSggcnRyaW0sICIiICk7DQoJCX0sDQoNCgkvLyByZXN1bHRzIGlzIGZvciBpbnRlcm5hbCB1c2FnZSBvbmx5DQoJbWFrZUFycmF5OiBmdW5jdGlvbiggYXJyLCByZXN1bHRzICkgew0KCQl2YXIgcmV0ID0gcmVzdWx0cyB8fCBbXTsNCg0KCQlpZiAoIGFyciAhPSBudWxsICkgew0KCQkJaWYgKCBpc0FycmF5bGlrZSggT2JqZWN0KGFycikgKSApIHsNCgkJCQlqUXVlcnkubWVyZ2UoIHJldCwNCgkJCQkJdHlwZW9mIGFyciA9PT0gInN0cmluZyIgPw0KCQkJCQlbIGFyciBdIDogYXJyDQoJCQkJKTsNCgkJCX0gZWxzZSB7DQoJCQkJY29yZV9wdXNoLmNhbGwoIHJldCwgYXJyICk7DQoJCQl9DQoJCX0NCg0KCQlyZXR1cm4gcmV0Ow0KCX0sDQoNCglpbkFycmF5OiBmdW5jdGlvbiggZWxlbSwgYXJyLCBpICkgew0KCQl2YXIgbGVuOw0KDQoJCWlmICggYXJyICkgew0KCQkJaWYgKCBjb3JlX2luZGV4T2YgKSB7DQoJCQkJcmV0dXJuIGNvcmVfaW5kZXhPZi5jYWxsKCBhcnIsIGVsZW0sIGkgKTsNCgkJCX0NCg0KCQkJbGVuID0gYXJyLmxlbmd0aDsNCgkJCWkgPSBpID8gaSA8IDAgPyBNYXRoLm1heCggMCwgbGVuICsgaSApIDogaSA6IDA7DQoNCgkJCWZvciAoIDsgaSA8IGxlbjsgaSsrICkgew0KCQkJCS8vIFNraXAgYWNjZXNzaW5nIGluIHNwYXJzZSBhcnJheXMNCgkJCQlpZiAoIGkgaW4gYXJyICYmIGFyclsgaSBdID09PSBlbGVtICkgew0KCQkJCQlyZXR1cm4gaTsNCgkJCQl9DQoJCQl9DQoJCX0NCg0KCQlyZXR1cm4gLTE7DQoJfSwNCg0KCW1lcmdlOiBmdW5jdGlvbiggZmlyc3QsIHNlY29uZCApIHsNCgkJdmFyIGwgPSBzZWNvbmQubGVuZ3RoLA0KCQkJaSA9IGZpcnN0Lmxlbmd0aCwNCgkJCWogPSAwOw0KDQoJCWlmICggdHlwZW9mIGwgPT09ICJudW1iZXIiICkgew0KCQkJZm9yICggOyBqIDwgbDsgaisrICkgew0KCQkJCWZpcnN0WyBpKysgXSA9IHNlY29uZFsgaiBdOw0KCQkJfQ0KCQl9IGVsc2Ugew0KCQkJd2hpbGUgKCBzZWNvbmRbal0gIT09IHVuZGVmaW5lZCApIHsNCgkJCQlmaXJzdFsgaSsrIF0gPSBzZWNvbmRbIGorKyBdOw0KCQkJfQ0KCQl9DQoNCgkJZmlyc3QubGVuZ3RoID0gaTsNCg0KCQlyZXR1cm4gZmlyc3Q7DQoJfSwNCg0KCWdyZXA6IGZ1bmN0aW9uKCBlbGVtcywgY2FsbGJhY2ssIGludiApIHsNCgkJdmFyIHJldFZhbCwNCgkJCXJldCA9IFtdLA0KCQkJaSA9IDAsDQoJCQlsZW5ndGggPSBlbGVtcy5sZW5ndGg7DQoJCWludiA9ICEhaW52Ow0KDQoJCS8vIEdvIHRocm91Z2ggdGhlIGFycmF5LCBvbmx5IHNhdmluZyB0aGUgaXRlbXMNCgkJLy8gdGhhdCBwYXNzIHRoZSB2YWxpZGF0b3IgZnVuY3Rpb24NCgkJZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7DQoJCQlyZXRWYWwgPSAhIWNhbGxiYWNrKCBlbGVtc1sgaSBdLCBpICk7DQoJCQlpZiAoIGludiAhPT0gcmV0VmFsICkgew0KCQkJCXJldC5wdXNoKCBlbGVtc1sgaSBdICk7DQoJCQl9DQoJCX0NCg0KCQlyZXR1cm4gcmV0Ow0KCX0sDQoNCgkvLyBhcmcgaXMgZm9yIGludGVybmFsIHVzYWdlIG9ubHkNCgltYXA6IGZ1bmN0aW9uKCBlbGVtcywgY2FsbGJhY2ssIGFyZyApIHsNCgkJdmFyIHZhbHVlLA0KCQkJaSA9IDAsDQoJCQlsZW5ndGggPSBlbGVtcy5sZW5ndGgsDQoJCQlpc0FycmF5ID0gaXNBcnJheWxpa2UoIGVsZW1zICksDQoJCQlyZXQgPSBbXTsNCg0KCQkvLyBHbyB0aHJvdWdoIHRoZSBhcnJheSwgdHJhbnNsYXRpbmcgZWFjaCBvZiB0aGUgaXRlbXMgdG8gdGhlaXINCgkJaWYgKCBpc0FycmF5ICkgew0KCQkJZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7DQoJCQkJdmFsdWUgPSBjYWxsYmFjayggZWxlbXNbIGkgXSwgaSwgYXJnICk7DQoNCgkJCQlpZiAoIHZhbHVlICE9IG51bGwgKSB7DQoJCQkJCXJldFsgcmV0Lmxlbmd0aCBdID0gdmFsdWU7DQoJCQkJfQ0KCQkJfQ0KDQoJCS8vIEdvIHRocm91Z2ggZXZlcnkga2V5IG9uIHRoZSBvYmplY3QsDQoJCX0gZWxzZSB7DQoJCQlmb3IgKCBpIGluIGVsZW1zICkgew0KCQkJCXZhbHVlID0gY2FsbGJhY2soIGVsZW1zWyBpIF0sIGksIGFyZyApOw0KDQoJCQkJaWYgKCB2YWx1ZSAhPSBudWxsICkgew0KCQkJCQlyZXRbIHJldC5sZW5ndGggXSA9IHZhbHVlOw0KCQkJCX0NCgkJCX0NCgkJfQ0KDQoJCS8vIEZsYXR0ZW4gYW55IG5lc3RlZCBhcnJheXMNCgkJcmV0dXJuIGNvcmVfY29uY2F0LmFwcGx5KCBbXSwgcmV0ICk7DQoJfSwNCg0KCS8vIEEgZ2xvYmFsIEdVSUQgY291bnRlciBmb3Igb2JqZWN0cw0KCWd1aWQ6IDEsDQoNCgkvLyBCaW5kIGEgZnVuY3Rpb24gdG8gYSBjb250ZXh0LCBvcHRpb25hbGx5IHBhcnRpYWxseSBhcHBseWluZyBhbnkNCgkvLyBhcmd1bWVudHMuDQoJcHJveHk6IGZ1bmN0aW9uKCBmbiwgY29udGV4dCApIHsNCgkJdmFyIGFyZ3MsIHByb3h5LCB0bXA7DQoNCgkJaWYgKCB0eXBlb2YgY29udGV4dCA9PT0gInN0cmluZyIgKSB7DQoJCQl0bXAgPSBmblsgY29udGV4dCBdOw0KCQkJY29udGV4dCA9IGZuOw0KCQkJZm4gPSB0bXA7DQoJCX0NCg0KCQkvLyBRdWljayBjaGVjayB0byBkZXRlcm1pbmUgaWYgdGFyZ2V0IGlzIGNhbGxhYmxlLCBpbiB0aGUgc3BlYw0KCQkvLyB0aGlzIHRocm93cyBhIFR5cGVFcnJvciwgYnV0IHdlIHdpbGwganVzdCByZXR1cm4gdW5kZWZpbmVkLg0KCQlpZiAoICFqUXVlcnkuaXNGdW5jdGlvbiggZm4gKSApIHsNCgkJCXJldHVybiB1bmRlZmluZWQ7DQoJCX0NCg0KCQkvLyBTaW11bGF0ZWQgYmluZA0KCQlhcmdzID0gY29yZV9zbGljZS5jYWxsKCBhcmd1bWVudHMsIDIgKTsNCgkJcHJveHkgPSBmdW5jdGlvbigpIHsNCgkJCXJldHVybiBmbi5hcHBseSggY29udGV4dCB8fCB0aGlzLCBhcmdzLmNvbmNhdCggY29yZV9zbGljZS5jYWxsKCBhcmd1bWVudHMgKSApICk7DQoJCX07DQoNCgkJLy8gU2V0IHRoZSBndWlkIG9mIHVuaXF1ZSBoYW5kbGVyIHRvIHRoZSBzYW1lIG9mIG9yaWdpbmFsIGhhbmRsZXIsIHNvIGl0IGNhbiBiZSByZW1vdmVkDQoJCXByb3h5Lmd1aWQgPSBmbi5ndWlkID0gZm4uZ3VpZCB8fCBqUXVlcnkuZ3VpZCsrOw0KDQoJCXJldHVybiBwcm94eTsNCgl9LA0KDQoJLy8gTXVsdGlmdW5jdGlvbmFsIG1ldGhvZCB0byBnZXQgYW5kIHNldCB2YWx1ZXMgb2YgYSBjb2xsZWN0aW9uDQoJLy8gVGhlIHZhbHVlL3MgY2FuIG9wdGlvbmFsbHkgYmUgZXhlY3V0ZWQgaWYgaXQncyBhIGZ1bmN0aW9uDQoJYWNjZXNzOiBmdW5jdGlvbiggZWxlbXMsIGZuLCBrZXksIHZhbHVlLCBjaGFpbmFibGUsIGVtcHR5R2V0LCByYXcgKSB7DQoJCXZhciBpID0gMCwNCgkJCWxlbmd0aCA9IGVsZW1zLmxlbmd0aCwNCgkJCWJ1bGsgPSBrZXkgPT0gbnVsbDsNCg0KCQkvLyBTZXRzIG1hbnkgdmFsdWVzDQoJCWlmICggalF1ZXJ5LnR5cGUoIGtleSApID09PSAib2JqZWN0IiApIHsNCgkJCWNoYWluYWJsZSA9IHRydWU7DQoJCQlmb3IgKCBpIGluIGtleSApIHsNCgkJCQlqUXVlcnkuYWNjZXNzKCBlbGVtcywgZm4sIGksIGtleVtpXSwgdHJ1ZSwgZW1wdHlHZXQsIHJhdyApOw0KCQkJfQ0KDQoJCS8vIFNldHMgb25lIHZhbHVlDQoJCX0gZWxzZSBpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7DQoJCQljaGFpbmFibGUgPSB0cnVlOw0KDQoJCQlpZiAoICFqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsNCgkJCQlyYXcgPSB0cnVlOw0KCQkJfQ0KDQoJCQlpZiAoIGJ1bGsgKSB7DQoJCQkJLy8gQnVsayBvcGVyYXRpb25zIHJ1biBhZ2FpbnN0IHRoZSBlbnRpcmUgc2V0DQoJCQkJaWYgKCByYXcgKSB7DQoJCQkJCWZuLmNhbGwoIGVsZW1zLCB2YWx1ZSApOw0KCQkJCQlmbiA9IG51bGw7DQoNCgkJCQkvLyAuLi5leGNlcHQgd2hlbiBleGVjdXRpbmcgZnVuY3Rpb24gdmFsdWVzDQoJCQkJfSBlbHNlIHsNCgkJCQkJYnVsayA9IGZuOw0KCQkJCQlmbiA9IGZ1bmN0aW9uKCBlbGVtLCBrZXksIHZhbHVlICkgew0KCQkJCQkJcmV0dXJuIGJ1bGsuY2FsbCggalF1ZXJ5KCBlbGVtICksIHZhbHVlICk7DQoJCQkJCX07DQoJCQkJfQ0KCQkJfQ0KDQoJCQlpZiAoIGZuICkgew0KCQkJCWZvciAoIDsgaSA8IGxlbmd0aDsgaSsrICkgew0KCQkJCQlmbiggZWxlbXNbaV0sIGtleSwgcmF3ID8gdmFsdWUgOiB2YWx1ZS5jYWxsKCBlbGVtc1tpXSwgaSwgZm4oIGVsZW1zW2ldLCBrZXkgKSApICk7DQoJCQkJfQ0KCQkJfQ0KCQl9DQoNCgkJcmV0dXJuIGNoYWluYWJsZSA/DQoJCQllbGVtcyA6DQoNCgkJCS8vIEdldHMNCgkJCWJ1bGsgPw0KCQkJCWZuLmNhbGwoIGVsZW1zICkgOg0KCQkJCWxlbmd0aCA/IGZuKCBlbGVtc1swXSwga2V5ICkgOiBlbXB0eUdldDsNCgl9LA0KDQoJbm93OiBmdW5jdGlvbigpIHsNCgkJcmV0dXJuICggbmV3IERhdGUoKSApLmdldFRpbWUoKTsNCgl9LA0KDQoJLy8gQSBtZXRob2QgZm9yIHF1aWNrbHkgc3dhcHBpbmcgaW4vb3V0IENTUyBwcm9wZXJ0aWVzIHRvIGdldCBjb3JyZWN0IGNhbGN1bGF0aW9ucy4NCgkvLyBOb3RlOiB0aGlzIG1ldGhvZCBiZWxvbmdzIHRvIHRoZSBjc3MgbW9kdWxlIGJ1dCBpdCdzIG5lZWRlZCBoZXJlIGZvciB0aGUgc3VwcG9ydCBtb2R1bGUuDQoJLy8gSWYgc3VwcG9ydCBnZXRzIG1vZHVsYXJpemVkLCB0aGlzIG1ldGhvZCBzaG91bGQgYmUgbW92ZWQgYmFjayB0byB0aGUgY3NzIG1vZHVsZS4NCglzd2FwOiBmdW5jdGlvbiggZWxlbSwgb3B0aW9ucywgY2FsbGJhY2ssIGFyZ3MgKSB7DQoJCXZhciByZXQsIG5hbWUsDQoJCQlvbGQgPSB7fTsNCg0KCQkvLyBSZW1lbWJlciB0aGUgb2xkIHZhbHVlcywgYW5kIGluc2VydCB0aGUgbmV3IG9uZXMNCgkJZm9yICggbmFtZSBpbiBvcHRpb25zICkgew0KCQkJb2xkWyBuYW1lIF0gPSBlbGVtLnN0eWxlWyBuYW1lIF07DQoJCQllbGVtLnN0eWxlWyBuYW1lIF0gPSBvcHRpb25zWyBuYW1lIF07DQoJCX0NCg0KCQlyZXQgPSBjYWxsYmFjay5hcHBseSggZWxlbSwgYXJncyB8fCBbXSApOw0KDQoJCS8vIFJldmVydCB0aGUgb2xkIHZhbHVlcw0KCQlmb3IgKCBuYW1lIGluIG9wdGlvbnMgKSB7DQoJCQllbGVtLnN0eWxlWyBuYW1lIF0gPSBvbGRbIG5hbWUgXTsNCgkJfQ0KDQoJCXJldHVybiByZXQ7DQoJfQ0KfSk7DQoNCmpRdWVyeS5yZWFkeS5wcm9taXNlID0gZnVuY3Rpb24oIG9iaiApIHsNCglpZiAoICFyZWFkeUxpc3QgKSB7DQoNCgkJcmVhZHlMaXN0ID0galF1ZXJ5LkRlZmVycmVkKCk7DQoNCgkJLy8gQ2F0Y2ggY2FzZXMgd2hlcmUgJChkb2N1bWVudCkucmVhZHkoKSBpcyBjYWxsZWQgYWZ0ZXIgdGhlIGJyb3dzZXIgZXZlbnQgaGFzIGFscmVhZHkgb2NjdXJyZWQuDQoJCS8vIHdlIG9uY2UgdHJpZWQgdG8gdXNlIHJlYWR5U3RhdGUgImludGVyYWN0aXZlIiBoZXJlLCBidXQgaXQgY2F1c2VkIGlzc3VlcyBsaWtlIHRoZSBvbmUNCgkJLy8gZGlzY292ZXJlZCBieSBDaHJpc1MgaGVyZTogaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTIyODIjY29tbWVudDoxNQ0KCQlpZiAoIGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICJjb21wbGV0ZSIgKSB7DQoJCQkvLyBIYW5kbGUgaXQgYXN5bmNocm9ub3VzbHkgdG8gYWxsb3cgc2NyaXB0cyB0aGUgb3Bwb3J0dW5pdHkgdG8gZGVsYXkgcmVhZHkNCgkJCXNldFRpbWVvdXQoIGpRdWVyeS5yZWFkeSApOw0KDQoJCS8vIFN0YW5kYXJkcy1iYXNlZCBicm93c2VycyBzdXBwb3J0IERPTUNvbnRlbnRMb2FkZWQNCgkJfSBlbHNlIGlmICggZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciApIHsNCgkJCS8vIFVzZSB0aGUgaGFuZHkgZXZlbnQgY2FsbGJhY2sNCgkJCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoICJET01Db250ZW50TG9hZGVkIiwgY29tcGxldGVkLCBmYWxzZSApOw0KDQoJCQkvLyBBIGZhbGxiYWNrIHRvIHdpbmRvdy5vbmxvYWQsIHRoYXQgd2lsbCBhbHdheXMgd29yaw0KCQkJd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoICJsb2FkIiwgY29tcGxldGVkLCBmYWxzZSApOw0KDQoJCS8vIElmIElFIGV2ZW50IG1vZGVsIGlzIHVzZWQNCgkJfSBlbHNlIHsNCgkJCS8vIEVuc3VyZSBmaXJpbmcgYmVmb3JlIG9ubG9hZCwgbWF5YmUgbGF0ZSBidXQgc2FmZSBhbHNvIGZvciBpZnJhbWVzDQoJCQlkb2N1bWVudC5hdHRhY2hFdmVudCggIm9ucmVhZHlzdGF0ZWNoYW5nZSIsIGNvbXBsZXRlZCApOw0KDQoJCQkvLyBBIGZhbGxiYWNrIHRvIHdpbmRvdy5vbmxvYWQsIHRoYXQgd2lsbCBhbHdheXMgd29yaw0KCQkJd2luZG93LmF0dGFjaEV2ZW50KCAib25sb2FkIiwgY29tcGxldGVkICk7DQoNCgkJCS8vIElmIElFIGFuZCBub3QgYSBmcmFtZQ0KCQkJLy8gY29udGludWFsbHkgY2hlY2sgdG8gc2VlIGlmIHRoZSBkb2N1bWVudCBpcyByZWFkeQ0KCQkJdmFyIHRvcCA9IGZhbHNlOw0KDQoJCQl0cnkgew0KCQkJCXRvcCA9IHdpbmRvdy5mcmFtZUVsZW1lbnQgPT0gbnVsbCAmJiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7DQoJCQl9IGNhdGNoKGUpIHt9DQoNCgkJCWlmICggdG9wICYmIHRvcC5kb1Njcm9sbCApIHsNCgkJCQkoZnVuY3Rpb24gZG9TY3JvbGxDaGVjaygpIHsNCgkJCQkJaWYgKCAhalF1ZXJ5LmlzUmVhZHkgKSB7DQoNCgkJCQkJCXRyeSB7DQoJCQkJCQkJLy8gVXNlIHRoZSB0cmljayBieSBEaWVnbyBQZXJpbmkNCgkJCQkJCQkvLyBodHRwOi8vamF2YXNjcmlwdC5ud2JveC5jb20vSUVDb250ZW50TG9hZGVkLw0KCQkJCQkJCXRvcC5kb1Njcm9sbCgibGVmdCIpOw0KCQkJCQkJfSBjYXRjaChlKSB7DQoJCQkJCQkJcmV0dXJuIHNldFRpbWVvdXQoIGRvU2Nyb2xsQ2hlY2ssIDUwICk7DQoJCQkJCQl9DQoNCgkJCQkJCS8vIGRldGFjaCBhbGwgZG9tIHJlYWR5IGV2ZW50cw0KCQkJCQkJZGV0YWNoKCk7DQoNCgkJCQkJCS8vIGFuZCBleGVjdXRlIGFueSB3YWl0aW5nIGZ1bmN0aW9ucw0KCQkJCQkJalF1ZXJ5LnJlYWR5KCk7DQoJCQkJCX0NCgkJCQl9KSgpOw0KCQkJfQ0KCQl9DQoJfQ0KCXJldHVybiByZWFkeUxpc3QucHJvbWlzZSggb2JqICk7DQp9Ow0KDQovLyBQb3B1bGF0ZSB0aGUgY2xhc3MydHlwZSBtYXANCmpRdWVyeS5lYWNoKCJCb29sZWFuIE51bWJlciBTdHJpbmcgRnVuY3Rpb24gQXJyYXkgRGF0ZSBSZWdFeHAgT2JqZWN0IEVycm9yIi5zcGxpdCgiICIpLCBmdW5jdGlvbihpLCBuYW1lKSB7DQoJY2xhc3MydHlwZVsgIltvYmplY3QgIiArIG5hbWUgKyAiXSIgXSA9IG5hbWUudG9Mb3dlckNhc2UoKTsNCn0pOw0KDQpmdW5jdGlvbiBpc0FycmF5bGlrZSggb2JqICkgew0KCXZhciBsZW5ndGggPSBvYmoubGVuZ3RoLA0KCQl0eXBlID0galF1ZXJ5LnR5cGUoIG9iaiApOw0KDQoJaWYgKCBqUXVlcnkuaXNXaW5kb3coIG9iaiApICkgew0KCQlyZXR1cm4gZmFsc2U7DQoJfQ0KDQoJaWYgKCBvYmoubm9kZVR5cGUgPT09IDEgJiYgbGVuZ3RoICkgew0KCQlyZXR1cm4gdHJ1ZTsNCgl9DQoNCglyZXR1cm4gdHlwZSA9PT0gImFycmF5IiB8fCB0eXBlICE9PSAiZnVuY3Rpb24iICYmDQoJCSggbGVuZ3RoID09PSAwIHx8DQoJCXR5cGVvZiBsZW5ndGggPT09ICJudW1iZXIiICYmIGxlbmd0aCA+IDAgJiYgKCBsZW5ndGggLSAxICkgaW4gb2JqICk7DQp9DQoNCi8vIEFsbCBqUXVlcnkgb2JqZWN0cyBzaG91bGQgcG9pbnQgYmFjayB0byB0aGVzZQ0Kcm9vdGpRdWVyeSA9IGpRdWVyeShkb2N1bWVudCk7DQovKiENCiAqIFNpenpsZSBDU1MgU2VsZWN0b3IgRW5naW5lIHYxLjEwLjINCiAqIGh0dHA6Ly9zaXp6bGVqcy5jb20vDQogKg0KICogQ29weXJpZ2h0IDIwMTMgalF1ZXJ5IEZvdW5kYXRpb24sIEluYy4gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycw0KICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlDQogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlDQogKg0KICogRGF0ZTogMjAxMy0wNy0wMw0KICovDQooZnVuY3Rpb24oIHdpbmRvdywgdW5kZWZpbmVkICkgew0KDQp2YXIgaSwNCglzdXBwb3J0LA0KCWNhY2hlZHJ1bnMsDQoJRXhwciwNCglnZXRUZXh0LA0KCWlzWE1MLA0KCWNvbXBpbGUsDQoJb3V0ZXJtb3N0Q29udGV4dCwNCglzb3J0SW5wdXQsDQoNCgkvLyBMb2NhbCBkb2N1bWVudCB2YXJzDQoJc2V0RG9jdW1lbnQsDQoJZG9jdW1lbnQsDQoJZG9jRWxlbSwNCglkb2N1bWVudElzSFRNTCwNCglyYnVnZ3lRU0EsDQoJcmJ1Z2d5TWF0Y2hlcywNCgltYXRjaGVzLA0KCWNvbnRhaW5zLA0KDQoJLy8gSW5zdGFuY2Utc3BlY2lmaWMgZGF0YQ0KCWV4cGFuZG8gPSAic2l6emxlIiArIC0obmV3IERhdGUoKSksDQoJcHJlZmVycmVkRG9jID0gd2luZG93LmRvY3VtZW50LA0KCWRpcnJ1bnMgPSAwLA0KCWRvbmUgPSAwLA0KCWNsYXNzQ2FjaGUgPSBjcmVhdGVDYWNoZSgpLA0KCXRva2VuQ2FjaGUgPSBjcmVhdGVDYWNoZSgpLA0KCWNvbXBpbGVyQ2FjaGUgPSBjcmVhdGVDYWNoZSgpLA0KCWhhc0R1cGxpY2F0ZSA9IGZhbHNlLA0KCXNvcnRPcmRlciA9IGZ1bmN0aW9uKCBhLCBiICkgew0KCQlpZiAoIGEgPT09IGIgKSB7DQoJCQloYXNEdXBsaWNhdGUgPSB0cnVlOw0KCQkJcmV0dXJuIDA7DQoJCX0NCgkJcmV0dXJuIDA7DQoJfSwNCg0KCS8vIEdlbmVyYWwtcHVycG9zZSBjb25zdGFudHMNCglzdHJ1bmRlZmluZWQgPSB0eXBlb2YgdW5kZWZpbmVkLA0KCU1BWF9ORUdBVElWRSA9IDEgPDwgMzEsDQoNCgkvLyBJbnN0YW5jZSBtZXRob2RzDQoJaGFzT3duID0gKHt9KS5oYXNPd25Qcm9wZXJ0eSwNCglhcnIgPSBbXSwNCglwb3AgPSBhcnIucG9wLA0KCXB1c2hfbmF0aXZlID0gYXJyLnB1c2gsDQoJcHVzaCA9IGFyci5wdXNoLA0KCXNsaWNlID0gYXJyLnNsaWNlLA0KCS8vIFVzZSBhIHN0cmlwcGVkLWRvd24gaW5kZXhPZiBpZiB3ZSBjYW4ndCB1c2UgYSBuYXRpdmUgb25lDQoJaW5kZXhPZiA9IGFyci5pbmRleE9mIHx8IGZ1bmN0aW9uKCBlbGVtICkgew0KCQl2YXIgaSA9IDAsDQoJCQlsZW4gPSB0aGlzLmxlbmd0aDsNCgkJZm9yICggOyBpIDwgbGVuOyBpKysgKSB7DQoJCQlpZiAoIHRoaXNbaV0gPT09IGVsZW0gKSB7DQoJCQkJcmV0dXJuIGk7DQoJCQl9DQoJCX0NCgkJcmV0dXJuIC0xOw0KCX0sDQoNCglib29sZWFucyA9ICJjaGVja2VkfHNlbGVjdGVkfGFzeW5jfGF1dG9mb2N1c3xhdXRvcGxheXxjb250cm9sc3xkZWZlcnxkaXNhYmxlZHxoaWRkZW58aXNtYXB8bG9vcHxtdWx0aXBsZXxvcGVufHJlYWRvbmx5fHJlcXVpcmVkfHNjb3BlZCIsDQoNCgkvLyBSZWd1bGFyIGV4cHJlc3Npb25zDQoNCgkvLyBXaGl0ZXNwYWNlIGNoYXJhY3RlcnMgaHR0cDovL3d3dy53My5vcmcvVFIvY3NzMy1zZWxlY3RvcnMvI3doaXRlc3BhY2UNCgl3aGl0ZXNwYWNlID0gIltcXHgyMFxcdFxcclxcblxcZl0iLA0KCS8vIGh0dHA6Ly93d3cudzMub3JnL1RSL2NzczMtc3ludGF4LyNjaGFyYWN0ZXJzDQoJY2hhcmFjdGVyRW5jb2RpbmcgPSAiKD86XFxcXC58W1xcdy1dfFteXFx4MDAtXFx4YTBdKSsiLA0KDQoJLy8gTG9vc2VseSBtb2RlbGVkIG9uIENTUyBpZGVudGlmaWVyIGNoYXJhY3RlcnMNCgkvLyBBbiB1bnF1b3RlZCB2YWx1ZSBzaG91bGQgYmUgYSBDU1MgaWRlbnRpZmllciBodHRwOi8vd3d3LnczLm9yZy9UUi9jc3MzLXNlbGVjdG9ycy8jYXR0cmlidXRlLXNlbGVjdG9ycw0KCS8vIFByb3BlciBzeW50YXg6IGh0dHA6Ly93d3cudzMub3JnL1RSL0NTUzIxL3N5bmRhdGEuaHRtbCN2YWx1ZS1kZWYtaWRlbnRpZmllcg0KCWlkZW50aWZpZXIgPSBjaGFyYWN0ZXJFbmNvZGluZy5yZXBsYWNlKCAidyIsICJ3IyIgKSwNCg0KCS8vIEFjY2VwdGFibGUgb3BlcmF0b3JzIGh0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jYXR0cmlidXRlLXNlbGVjdG9ycw0KCWF0dHJpYnV0ZXMgPSAiXFxbIiArIHdoaXRlc3BhY2UgKyAiKigiICsgY2hhcmFjdGVyRW5jb2RpbmcgKyAiKSIgKyB3aGl0ZXNwYWNlICsNCgkJIiooPzooWypeJHwhfl0/PSkiICsgd2hpdGVzcGFjZSArICIqKD86KFsnXCJdKSgoPzpcXFxcLnxbXlxcXFxdKSo/KVxcM3woIiArIGlkZW50aWZpZXIgKyAiKXwpfCkiICsgd2hpdGVzcGFjZSArICIqXFxdIiwNCg0KCS8vIFByZWZlciBhcmd1bWVudHMgcXVvdGVkLA0KCS8vICAgdGhlbiBub3QgY29udGFpbmluZyBwc2V1ZG9zL2JyYWNrZXRzLA0KCS8vICAgdGhlbiBhdHRyaWJ1dGUgc2VsZWN0b3JzL25vbi1wYXJlbnRoZXRpY2FsIGV4cHJlc3Npb25zLA0KCS8vICAgdGhlbiBhbnl0aGluZyBlbHNlDQoJLy8gVGhlc2UgcHJlZmVyZW5jZXMgYXJlIGhlcmUgdG8gcmVkdWNlIHRoZSBudW1iZXIgb2Ygc2VsZWN0b3JzDQoJLy8gICBuZWVkaW5nIHRva2VuaXplIGluIHRoZSBQU0VVRE8gcHJlRmlsdGVyDQoJcHNldWRvcyA9ICI6KCIgKyBjaGFyYWN0ZXJFbmNvZGluZyArICIpKD86XFwoKChbJ1wiXSkoKD86XFxcXC58W15cXFxcXSkqPylcXDN8KCg/OlxcXFwufFteXFxcXCgpW1xcXV18IiArIGF0dHJpYnV0ZXMucmVwbGFjZSggMywgOCApICsgIikqKXwuKilcXCl8KSIsDQoNCgkvLyBMZWFkaW5nIGFuZCBub24tZXNjYXBlZCB0cmFpbGluZyB3aGl0ZXNwYWNlLCBjYXB0dXJpbmcgc29tZSBub24td2hpdGVzcGFjZSBjaGFyYWN0ZXJzIHByZWNlZGluZyB0aGUgbGF0dGVyDQoJcnRyaW0gPSBuZXcgUmVnRXhwKCAiXiIgKyB3aGl0ZXNwYWNlICsgIit8KCg/Ol58W15cXFxcXSkoPzpcXFxcLikqKSIgKyB3aGl0ZXNwYWNlICsgIiskIiwgImciICksDQoNCglyY29tbWEgPSBuZXcgUmVnRXhwKCAiXiIgKyB3aGl0ZXNwYWNlICsgIiosIiArIHdoaXRlc3BhY2UgKyAiKiIgKSwNCglyY29tYmluYXRvcnMgPSBuZXcgUmVnRXhwKCAiXiIgKyB3aGl0ZXNwYWNlICsgIiooWz4rfl18IiArIHdoaXRlc3BhY2UgKyAiKSIgKyB3aGl0ZXNwYWNlICsgIioiICksDQoNCglyc2libGluZyA9IG5ldyBSZWdFeHAoIHdoaXRlc3BhY2UgKyAiKlsrfl0iICksDQoJcmF0dHJpYnV0ZVF1b3RlcyA9IG5ldyBSZWdFeHAoICI9IiArIHdoaXRlc3BhY2UgKyAiKihbXlxcXSdcIl0qKSIgKyB3aGl0ZXNwYWNlICsgIipcXF0iLCAiZyIgKSwNCg0KCXJwc2V1ZG8gPSBuZXcgUmVnRXhwKCBwc2V1ZG9zICksDQoJcmlkZW50aWZpZXIgPSBuZXcgUmVnRXhwKCAiXiIgKyBpZGVudGlmaWVyICsgIiQiICksDQoNCgltYXRjaEV4cHIgPSB7DQoJCSJJRCI6IG5ldyBSZWdFeHAoICJeIygiICsgY2hhcmFjdGVyRW5jb2RpbmcgKyAiKSIgKSwNCgkJIkNMQVNTIjogbmV3IFJlZ0V4cCggIl5cXC4oIiArIGNoYXJhY3RlckVuY29kaW5nICsgIikiICksDQoJCSJUQUciOiBuZXcgUmVnRXhwKCAiXigiICsgY2hhcmFjdGVyRW5jb2RpbmcucmVwbGFjZSggInciLCAidyoiICkgKyAiKSIgKSwNCgkJIkFUVFIiOiBuZXcgUmVnRXhwKCAiXiIgKyBhdHRyaWJ1dGVzICksDQoJCSJQU0VVRE8iOiBuZXcgUmVnRXhwKCAiXiIgKyBwc2V1ZG9zICksDQoJCSJDSElMRCI6IG5ldyBSZWdFeHAoICJeOihvbmx5fGZpcnN0fGxhc3R8bnRofG50aC1sYXN0KS0oY2hpbGR8b2YtdHlwZSkoPzpcXCgiICsgd2hpdGVzcGFjZSArDQoJCQkiKihldmVufG9kZHwoKFsrLV18KShcXGQqKW58KSIgKyB3aGl0ZXNwYWNlICsgIiooPzooWystXXwpIiArIHdoaXRlc3BhY2UgKw0KCQkJIiooXFxkKyl8KSkiICsgd2hpdGVzcGFjZSArICIqXFwpfCkiLCAiaSIgKSwNCgkJImJvb2wiOiBuZXcgUmVnRXhwKCAiXig/OiIgKyBib29sZWFucyArICIpJCIsICJpIiApLA0KCQkvLyBGb3IgdXNlIGluIGxpYnJhcmllcyBpbXBsZW1lbnRpbmcgLmlzKCkNCgkJLy8gV2UgdXNlIHRoaXMgZm9yIFBPUyBtYXRjaGluZyBpbiBgc2VsZWN0YA0KCQkibmVlZHNDb250ZXh0IjogbmV3IFJlZ0V4cCggIl4iICsgd2hpdGVzcGFjZSArICIqWz4rfl18OihldmVufG9kZHxlcXxndHxsdHxudGh8Zmlyc3R8bGFzdCkoPzpcXCgiICsNCgkJCXdoaXRlc3BhY2UgKyAiKigoPzotXFxkKT9cXGQqKSIgKyB3aGl0ZXNwYWNlICsgIipcXCl8KSg/PVteLV18JCkiLCAiaSIgKQ0KCX0sDQoNCglybmF0aXZlID0gL15bXntdK1x7XHMqXFtuYXRpdmUgXHcvLA0KDQoJLy8gRWFzaWx5LXBhcnNlYWJsZS9yZXRyaWV2YWJsZSBJRCBvciBUQUcgb3IgQ0xBU1Mgc2VsZWN0b3JzDQoJcnF1aWNrRXhwciA9IC9eKD86IyhbXHctXSspfChcdyspfFwuKFtcdy1dKykpJC8sDQoNCglyaW5wdXRzID0gL14oPzppbnB1dHxzZWxlY3R8dGV4dGFyZWF8YnV0dG9uKSQvaSwNCglyaGVhZGVyID0gL15oXGQkL2ksDQoNCglyZXNjYXBlID0gLyd8XFwvZywNCg0KCS8vIENTUyBlc2NhcGVzIGh0dHA6Ly93d3cudzMub3JnL1RSL0NTUzIxL3N5bmRhdGEuaHRtbCNlc2NhcGVkLWNoYXJhY3RlcnMNCglydW5lc2NhcGUgPSBuZXcgUmVnRXhwKCAiXFxcXChbXFxkYS1mXXsxLDZ9IiArIHdoaXRlc3BhY2UgKyAiP3woIiArIHdoaXRlc3BhY2UgKyAiKXwuKSIsICJpZyIgKSwNCglmdW5lc2NhcGUgPSBmdW5jdGlvbiggXywgZXNjYXBlZCwgZXNjYXBlZFdoaXRlc3BhY2UgKSB7DQoJCXZhciBoaWdoID0gIjB4IiArIGVzY2FwZWQgLSAweDEwMDAwOw0KCQkvLyBOYU4gbWVhbnMgbm9uLWNvZGVwb2ludA0KCQkvLyBTdXBwb3J0OiBGaXJlZm94DQoJCS8vIFdvcmthcm91bmQgZXJyb25lb3VzIG51bWVyaWMgaW50ZXJwcmV0YXRpb24gb2YgKyIweCINCgkJcmV0dXJuIGhpZ2ggIT09IGhpZ2ggfHwgZXNjYXBlZFdoaXRlc3BhY2UgPw0KCQkJZXNjYXBlZCA6DQoJCQkvLyBCTVAgY29kZXBvaW50DQoJCQloaWdoIDwgMCA/DQoJCQkJU3RyaW5nLmZyb21DaGFyQ29kZSggaGlnaCArIDB4MTAwMDAgKSA6DQoJCQkJLy8gU3VwcGxlbWVudGFsIFBsYW5lIGNvZGVwb2ludCAoc3Vycm9nYXRlIHBhaXIpDQoJCQkJU3RyaW5nLmZyb21DaGFyQ29kZSggaGlnaCA+PiAxMCB8IDB4RDgwMCwgaGlnaCAmIDB4M0ZGIHwgMHhEQzAwICk7DQoJfTsNCg0KLy8gT3B0aW1pemUgZm9yIHB1c2guYXBwbHkoIF8sIE5vZGVMaXN0ICkNCnRyeSB7DQoJcHVzaC5hcHBseSgNCgkJKGFyciA9IHNsaWNlLmNhbGwoIHByZWZlcnJlZERvYy5jaGlsZE5vZGVzICkpLA0KCQlwcmVmZXJyZWREb2MuY2hpbGROb2Rlcw0KCSk7DQoJLy8gU3VwcG9ydDogQW5kcm9pZDw0LjANCgkvLyBEZXRlY3Qgc2lsZW50bHkgZmFpbGluZyBwdXNoLmFwcGx5DQoJYXJyWyBwcmVmZXJyZWREb2MuY2hpbGROb2Rlcy5sZW5ndGggXS5ub2RlVHlwZTsNCn0gY2F0Y2ggKCBlICkgew0KCXB1c2ggPSB7IGFwcGx5OiBhcnIubGVuZ3RoID8NCg0KCQkvLyBMZXZlcmFnZSBzbGljZSBpZiBwb3NzaWJsZQ0KCQlmdW5jdGlvbiggdGFyZ2V0LCBlbHMgKSB7DQoJCQlwdXNoX25hdGl2ZS5hcHBseSggdGFyZ2V0LCBzbGljZS5jYWxsKGVscykgKTsNCgkJfSA6DQoNCgkJLy8gU3VwcG9ydDogSUU8OQ0KCQkvLyBPdGhlcndpc2UgYXBwZW5kIGRpcmVjdGx5DQoJCWZ1bmN0aW9uKCB0YXJnZXQsIGVscyApIHsNCgkJCXZhciBqID0gdGFyZ2V0Lmxlbmd0aCwNCgkJCQlpID0gMDsNCgkJCS8vIENhbid0IHRydXN0IE5vZGVMaXN0Lmxlbmd0aA0KCQkJd2hpbGUgKCAodGFyZ2V0W2orK10gPSBlbHNbaSsrXSkgKSB7fQ0KCQkJdGFyZ2V0Lmxlbmd0aCA9IGogLSAxOw0KCQl9DQoJfTsNCn0NCg0KZnVuY3Rpb24gU2l6emxlKCBzZWxlY3RvciwgY29udGV4dCwgcmVzdWx0cywgc2VlZCApIHsNCgl2YXIgbWF0Y2gsIGVsZW0sIG0sIG5vZGVUeXBlLA0KCQkvLyBRU0EgdmFycw0KCQlpLCBncm91cHMsIG9sZCwgbmlkLCBuZXdDb250ZXh0LCBuZXdTZWxlY3RvcjsNCg0KCWlmICggKCBjb250ZXh0ID8gY29udGV4dC5vd25lckRvY3VtZW50IHx8IGNvbnRleHQgOiBwcmVmZXJyZWREb2MgKSAhPT0gZG9jdW1lbnQgKSB7DQoJCXNldERvY3VtZW50KCBjb250ZXh0ICk7DQoJfQ0KDQoJY29udGV4dCA9IGNvbnRleHQgfHwgZG9jdW1lbnQ7DQoJcmVzdWx0cyA9IHJlc3VsdHMgfHwgW107DQoNCglpZiAoICFzZWxlY3RvciB8fCB0eXBlb2Ygc2VsZWN0b3IgIT09ICJzdHJpbmciICkgew0KCQlyZXR1cm4gcmVzdWx0czsNCgl9DQoNCglpZiAoIChub2RlVHlwZSA9IGNvbnRleHQubm9kZVR5cGUpICE9PSAxICYmIG5vZGVUeXBlICE9PSA5ICkgew0KCQlyZXR1cm4gW107DQoJfQ0KDQoJaWYgKCBkb2N1bWVudElzSFRNTCAmJiAhc2VlZCApIHsNCg0KCQkvLyBTaG9ydGN1dHMNCgkJaWYgKCAobWF0Y2ggPSBycXVpY2tFeHByLmV4ZWMoIHNlbGVjdG9yICkpICkgew0KCQkJLy8gU3BlZWQtdXA6IFNpenpsZSgiI0lEIikNCgkJCWlmICggKG0gPSBtYXRjaFsxXSkgKSB7DQoJCQkJaWYgKCBub2RlVHlwZSA9PT0gOSApIHsNCgkJCQkJZWxlbSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQoIG0gKTsNCgkJCQkJLy8gQ2hlY2sgcGFyZW50Tm9kZSB0byBjYXRjaCB3aGVuIEJsYWNrYmVycnkgNC42IHJldHVybnMNCgkJCQkJLy8gbm9kZXMgdGhhdCBhcmUgbm8gbG9uZ2VyIGluIHRoZSBkb2N1bWVudCAjNjk2Mw0KCQkJCQlpZiAoIGVsZW0gJiYgZWxlbS5wYXJlbnROb2RlICkgew0KCQkJCQkJLy8gSGFuZGxlIHRoZSBjYXNlIHdoZXJlIElFLCBPcGVyYSwgYW5kIFdlYmtpdCByZXR1cm4gaXRlbXMNCgkJCQkJCS8vIGJ5IG5hbWUgaW5zdGVhZCBvZiBJRA0KCQkJCQkJaWYgKCBlbGVtLmlkID09PSBtICkgew0KCQkJCQkJCXJlc3VsdHMucHVzaCggZWxlbSApOw0KCQkJCQkJCXJldHVybiByZXN1bHRzOw0KCQkJCQkJfQ0KCQkJCQl9IGVsc2Ugew0KCQkJCQkJcmV0dXJuIHJlc3VsdHM7DQoJCQkJCX0NCgkJCQl9IGVsc2Ugew0KCQkJCQkvLyBDb250ZXh0IGlzIG5vdCBhIGRvY3VtZW50DQoJCQkJCWlmICggY29udGV4dC5vd25lckRvY3VtZW50ICYmIChlbGVtID0gY29udGV4dC5vd25lckRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBtICkpICYmDQoJCQkJCQljb250YWlucyggY29udGV4dCwgZWxlbSApICYmIGVsZW0uaWQgPT09IG0gKSB7DQoJCQkJCQlyZXN1bHRzLnB1c2goIGVsZW0gKTsNCgkJCQkJCXJldHVybiByZXN1bHRzOw0KCQkJCQl9DQoJCQkJfQ0KDQoJCQkvLyBTcGVlZC11cDogU2l6emxlKCJUQUciKQ0KCQkJfSBlbHNlIGlmICggbWF0Y2hbMl0gKSB7DQoJCQkJcHVzaC5hcHBseSggcmVzdWx0cywgY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSggc2VsZWN0b3IgKSApOw0KCQkJCXJldHVybiByZXN1bHRzOw0KDQoJCQkvLyBTcGVlZC11cDogU2l6emxlKCIuQ0xBU1MiKQ0KCQkJfSBlbHNlIGlmICggKG0gPSBtYXRjaFszXSkgJiYgc3VwcG9ydC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICYmIGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSApIHsNCgkJCQlwdXNoLmFwcGx5KCByZXN1bHRzLCBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoIG0gKSApOw0KCQkJCXJldHVybiByZXN1bHRzOw0KCQkJfQ0KCQl9DQoNCgkJLy8gUVNBIHBhdGgNCgkJaWYgKCBzdXBwb3J0LnFzYSAmJiAoIXJidWdneVFTQSB8fCAhcmJ1Z2d5UVNBLnRlc3QoIHNlbGVjdG9yICkpICkgew0KCQkJbmlkID0gb2xkID0gZXhwYW5kbzsNCgkJCW5ld0NvbnRleHQgPSBjb250ZXh0Ow0KCQkJbmV3U2VsZWN0b3IgPSBub2RlVHlwZSA9PT0gOSAmJiBzZWxlY3RvcjsNCg0KCQkJLy8gcVNBIHdvcmtzIHN0cmFuZ2VseSBvbiBFbGVtZW50LXJvb3RlZCBxdWVyaWVzDQoJCQkvLyBXZSBjYW4gd29yayBhcm91bmQgdGhpcyBieSBzcGVjaWZ5aW5nIGFuIGV4dHJhIElEIG9uIHRoZSByb290DQoJCQkvLyBhbmQgd29ya2luZyB1cCBmcm9tIHRoZXJlIChUaGFua3MgdG8gQW5kcmV3IER1cG9udCBmb3IgdGhlIHRlY2huaXF1ZSkNCgkJCS8vIElFIDggZG9lc24ndCB3b3JrIG9uIG9iamVjdCBlbGVtZW50cw0KCQkJaWYgKCBub2RlVHlwZSA9PT0gMSAmJiBjb250ZXh0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICJvYmplY3QiICkgew0KCQkJCWdyb3VwcyA9IHRva2VuaXplKCBzZWxlY3RvciApOw0KDQoJCQkJaWYgKCAob2xkID0gY29udGV4dC5nZXRBdHRyaWJ1dGUoImlkIikpICkgew0KCQkJCQluaWQgPSBvbGQucmVwbGFjZSggcmVzY2FwZSwgIlxcJCYiICk7DQoJCQkJfSBlbHNlIHsNCgkJCQkJY29udGV4dC5zZXRBdHRyaWJ1dGUoICJpZCIsIG5pZCApOw0KCQkJCX0NCgkJCQluaWQgPSAiW2lkPSciICsgbmlkICsgIiddICI7DQoNCgkJCQlpID0gZ3JvdXBzLmxlbmd0aDsNCgkJCQl3aGlsZSAoIGktLSApIHsNCgkJCQkJZ3JvdXBzW2ldID0gbmlkICsgdG9TZWxlY3RvciggZ3JvdXBzW2ldICk7DQoJCQkJfQ0KCQkJCW5ld0NvbnRleHQgPSByc2libGluZy50ZXN0KCBzZWxlY3RvciApICYmIGNvbnRleHQucGFyZW50Tm9kZSB8fCBjb250ZXh0Ow0KCQkJCW5ld1NlbGVjdG9yID0gZ3JvdXBzLmpvaW4oIiwiKTsNCgkJCX0NCg0KCQkJaWYgKCBuZXdTZWxlY3RvciApIHsNCgkJCQl0cnkgew0KCQkJCQlwdXNoLmFwcGx5KCByZXN1bHRzLA0KCQkJCQkJbmV3Q29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKCBuZXdTZWxlY3RvciApDQoJCQkJCSk7DQoJCQkJCXJldHVybiByZXN1bHRzOw0KCQkJCX0gY2F0Y2gocXNhRXJyb3IpIHsNCgkJCQl9IGZpbmFsbHkgew0KCQkJCQlpZiAoICFvbGQgKSB7DQoJCQkJCQljb250ZXh0LnJlbW92ZUF0dHJpYnV0ZSgiaWQiKTsNCgkJCQkJfQ0KCQkJCX0NCgkJCX0NCgkJfQ0KCX0NCg0KCS8vIEFsbCBvdGhlcnMNCglyZXR1cm4gc2VsZWN0KCBzZWxlY3Rvci5yZXBsYWNlKCBydHJpbSwgIiQxIiApLCBjb250ZXh0LCByZXN1bHRzLCBzZWVkICk7DQp9DQoNCi8qKg0KICogQ3JlYXRlIGtleS12YWx1ZSBjYWNoZXMgb2YgbGltaXRlZCBzaXplDQogKiBAcmV0dXJucyB7RnVuY3Rpb24oc3RyaW5nLCBPYmplY3QpfSBSZXR1cm5zIHRoZSBPYmplY3QgZGF0YSBhZnRlciBzdG9yaW5nIGl0IG9uIGl0c2VsZiB3aXRoDQogKglwcm9wZXJ0eSBuYW1lIHRoZSAoc3BhY2Utc3VmZml4ZWQpIHN0cmluZyBhbmQgKGlmIHRoZSBjYWNoZSBpcyBsYXJnZXIgdGhhbiBFeHByLmNhY2hlTGVuZ3RoKQ0KICoJZGVsZXRpbmcgdGhlIG9sZGVzdCBlbnRyeQ0KICovDQpmdW5jdGlvbiBjcmVhdGVDYWNoZSgpIHsNCgl2YXIga2V5cyA9IFtdOw0KDQoJZnVuY3Rpb24gY2FjaGUoIGtleSwgdmFsdWUgKSB7DQoJCS8vIFVzZSAoa2V5ICsgIiAiKSB0byBhdm9pZCBjb2xsaXNpb24gd2l0aCBuYXRpdmUgcHJvdG90eXBlIHByb3BlcnRpZXMgKHNlZSBJc3N1ZSAjMTU3KQ0KCQlpZiAoIGtleXMucHVzaCgga2V5ICs9ICIgIiApID4gRXhwci5jYWNoZUxlbmd0aCApIHsNCgkJCS8vIE9ubHkga2VlcCB0aGUgbW9zdCByZWNlbnQgZW50cmllcw0KCQkJZGVsZXRlIGNhY2hlWyBrZXlzLnNoaWZ0KCkgXTsNCgkJfQ0KCQlyZXR1cm4gKGNhY2hlWyBrZXkgXSA9IHZhbHVlKTsNCgl9DQoJcmV0dXJuIGNhY2hlOw0KfQ0KDQovKioNCiAqIE1hcmsgYSBmdW5jdGlvbiBmb3Igc3BlY2lhbCB1c2UgYnkgU2l6emxlDQogKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbiBUaGUgZnVuY3Rpb24gdG8gbWFyaw0KICovDQpmdW5jdGlvbiBtYXJrRnVuY3Rpb24oIGZuICkgew0KCWZuWyBleHBhbmRvIF0gPSB0cnVlOw0KCXJldHVybiBmbjsNCn0NCg0KLyoqDQogKiBTdXBwb3J0IHRlc3RpbmcgdXNpbmcgYW4gZWxlbWVudA0KICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gUGFzc2VkIHRoZSBjcmVhdGVkIGRpdiBhbmQgZXhwZWN0cyBhIGJvb2xlYW4gcmVzdWx0DQogKi8NCmZ1bmN0aW9uIGFzc2VydCggZm4gKSB7DQoJdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOw0KDQoJdHJ5IHsNCgkJcmV0dXJuICEhZm4oIGRpdiApOw0KCX0gY2F0Y2ggKGUpIHsNCgkJcmV0dXJuIGZhbHNlOw0KCX0gZmluYWxseSB7DQoJCS8vIFJlbW92ZSBmcm9tIGl0cyBwYXJlbnQgYnkgZGVmYXVsdA0KCQlpZiAoIGRpdi5wYXJlbnROb2RlICkgew0KCQkJZGl2LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoIGRpdiApOw0KCQl9DQoJCS8vIHJlbGVhc2UgbWVtb3J5IGluIElFDQoJCWRpdiA9IG51bGw7DQoJfQ0KfQ0KDQovKioNCiAqIEFkZHMgdGhlIHNhbWUgaGFuZGxlciBmb3IgYWxsIG9mIHRoZSBzcGVjaWZpZWQgYXR0cnMNCiAqIEBwYXJhbSB7U3RyaW5nfSBhdHRycyBQaXBlLXNlcGFyYXRlZCBsaXN0IG9mIGF0dHJpYnV0ZXMNCiAqIEBwYXJhbSB7RnVuY3Rpb259IGhhbmRsZXIgVGhlIG1ldGhvZCB0aGF0IHdpbGwgYmUgYXBwbGllZA0KICovDQpmdW5jdGlvbiBhZGRIYW5kbGUoIGF0dHJzLCBoYW5kbGVyICkgew0KCXZhciBhcnIgPSBhdHRycy5zcGxpdCgifCIpLA0KCQlpID0gYXR0cnMubGVuZ3RoOw0KDQoJd2hpbGUgKCBpLS0gKSB7DQoJCUV4cHIuYXR0ckhhbmRsZVsgYXJyW2ldIF0gPSBoYW5kbGVyOw0KCX0NCn0NCg0KLyoqDQogKiBDaGVja3MgZG9jdW1lbnQgb3JkZXIgb2YgdHdvIHNpYmxpbmdzDQogKiBAcGFyYW0ge0VsZW1lbnR9IGENCiAqIEBwYXJhbSB7RWxlbWVudH0gYg0KICogQHJldHVybnMge051bWJlcn0gUmV0dXJucyBsZXNzIHRoYW4gMCBpZiBhIHByZWNlZGVzIGIsIGdyZWF0ZXIgdGhhbiAwIGlmIGEgZm9sbG93cyBiDQogKi8NCmZ1bmN0aW9uIHNpYmxpbmdDaGVjayggYSwgYiApIHsNCgl2YXIgY3VyID0gYiAmJiBhLA0KCQlkaWZmID0gY3VyICYmIGEubm9kZVR5cGUgPT09IDEgJiYgYi5ub2RlVHlwZSA9PT0gMSAmJg0KCQkJKCB+Yi5zb3VyY2VJbmRleCB8fCBNQVhfTkVHQVRJVkUgKSAtDQoJCQkoIH5hLnNvdXJjZUluZGV4IHx8IE1BWF9ORUdBVElWRSApOw0KDQoJLy8gVXNlIElFIHNvdXJjZUluZGV4IGlmIGF2YWlsYWJsZSBvbiBib3RoIG5vZGVzDQoJaWYgKCBkaWZmICkgew0KCQlyZXR1cm4gZGlmZjsNCgl9DQoNCgkvLyBDaGVjayBpZiBiIGZvbGxvd3MgYQ0KCWlmICggY3VyICkgew0KCQl3aGlsZSAoIChjdXIgPSBjdXIubmV4dFNpYmxpbmcpICkgew0KCQkJaWYgKCBjdXIgPT09IGIgKSB7DQoJCQkJcmV0dXJuIC0xOw0KCQkJfQ0KCQl9DQoJfQ0KDQoJcmV0dXJuIGEgPyAxIDogLTE7DQp9DQoNCi8qKg0KICogUmV0dXJucyBhIGZ1bmN0aW9uIHRvIHVzZSBpbiBwc2V1ZG9zIGZvciBpbnB1dCB0eXBlcw0KICogQHBhcmFtIHtTdHJpbmd9IHR5cGUNCiAqLw0KZnVuY3Rpb24gY3JlYXRlSW5wdXRQc2V1ZG8oIHR5cGUgKSB7DQoJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgew0KCQl2YXIgbmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsNCgkJcmV0dXJuIG5hbWUgPT09ICJpbnB1dCIgJiYgZWxlbS50eXBlID09PSB0eXBlOw0KCX07DQp9DQoNCi8qKg0KICogUmV0dXJucyBhIGZ1bmN0aW9uIHRvIHVzZSBpbiBwc2V1ZG9zIGZvciBidXR0b25zDQogKiBAcGFyYW0ge1N0cmluZ30gdHlwZQ0KICovDQpmdW5jdGlvbiBjcmVhdGVCdXR0b25Qc2V1ZG8oIHR5cGUgKSB7DQoJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgew0KCQl2YXIgbmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsNCgkJcmV0dXJuIChuYW1lID09PSAiaW5wdXQiIHx8IG5hbWUgPT09ICJidXR0b24iKSAmJiBlbGVtLnR5cGUgPT09IHR5cGU7DQoJfTsNCn0NCg0KLyoqDQogKiBSZXR1cm5zIGEgZnVuY3Rpb24gdG8gdXNlIGluIHBzZXVkb3MgZm9yIHBvc2l0aW9uYWxzDQogKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbg0KICovDQpmdW5jdGlvbiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKCBmbiApIHsNCglyZXR1cm4gbWFya0Z1bmN0aW9uKGZ1bmN0aW9uKCBhcmd1bWVudCApIHsNCgkJYXJndW1lbnQgPSArYXJndW1lbnQ7DQoJCXJldHVybiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHNlZWQsIG1hdGNoZXMgKSB7DQoJCQl2YXIgaiwNCgkJCQltYXRjaEluZGV4ZXMgPSBmbiggW10sIHNlZWQubGVuZ3RoLCBhcmd1bWVudCApLA0KCQkJCWkgPSBtYXRjaEluZGV4ZXMubGVuZ3RoOw0KDQoJCQkvLyBNYXRjaCBlbGVtZW50cyBmb3VuZCBhdCB0aGUgc3BlY2lmaWVkIGluZGV4ZXMNCgkJCXdoaWxlICggaS0tICkgew0KCQkJCWlmICggc2VlZFsgKGogPSBtYXRjaEluZGV4ZXNbaV0pIF0gKSB7DQoJCQkJCXNlZWRbal0gPSAhKG1hdGNoZXNbal0gPSBzZWVkW2pdKTsNCgkJCQl9DQoJCQl9DQoJCX0pOw0KCX0pOw0KfQ0KDQovKioNCiAqIERldGVjdCB4bWwNCiAqIEBwYXJhbSB7RWxlbWVudHxPYmplY3R9IGVsZW0gQW4gZWxlbWVudCBvciBhIGRvY3VtZW50DQogKi8NCmlzWE1MID0gU2l6emxlLmlzWE1MID0gZnVuY3Rpb24oIGVsZW0gKSB7DQoJLy8gZG9jdW1lbnRFbGVtZW50IGlzIHZlcmlmaWVkIGZvciBjYXNlcyB3aGVyZSBpdCBkb2Vzbid0IHlldCBleGlzdA0KCS8vIChzdWNoIGFzIGxvYWRpbmcgaWZyYW1lcyBpbiBJRSAtICM0ODMzKQ0KCXZhciBkb2N1bWVudEVsZW1lbnQgPSBlbGVtICYmIChlbGVtLm93bmVyRG9jdW1lbnQgfHwgZWxlbSkuZG9jdW1lbnRFbGVtZW50Ow0KCXJldHVybiBkb2N1bWVudEVsZW1lbnQgPyBkb2N1bWVudEVsZW1lbnQubm9kZU5hbWUgIT09ICJIVE1MIiA6IGZhbHNlOw0KfTsNCg0KLy8gRXhwb3NlIHN1cHBvcnQgdmFycyBmb3IgY29udmVuaWVuY2UNCnN1cHBvcnQgPSBTaXp6bGUuc3VwcG9ydCA9IHt9Ow0KDQovKioNCiAqIFNldHMgZG9jdW1lbnQtcmVsYXRlZCB2YXJpYWJsZXMgb25jZSBiYXNlZCBvbiB0aGUgY3VycmVudCBkb2N1bWVudA0KICogQHBhcmFtIHtFbGVtZW50fE9iamVjdH0gW2RvY10gQW4gZWxlbWVudCBvciBkb2N1bWVudCBvYmplY3QgdG8gdXNlIHRvIHNldCB0aGUgZG9jdW1lbnQNCiAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIGN1cnJlbnQgZG9jdW1lbnQNCiAqLw0Kc2V0RG9jdW1lbnQgPSBTaXp6bGUuc2V0RG9jdW1lbnQgPSBmdW5jdGlvbiggbm9kZSApIHsNCgl2YXIgZG9jID0gbm9kZSA/IG5vZGUub3duZXJEb2N1bWVudCB8fCBub2RlIDogcHJlZmVycmVkRG9jLA0KCQlwYXJlbnQgPSBkb2MuZGVmYXVsdFZpZXc7DQoNCgkvLyBJZiBubyBkb2N1bWVudCBhbmQgZG9jdW1lbnRFbGVtZW50IGlzIGF2YWlsYWJsZSwgcmV0dXJuDQoJaWYgKCBkb2MgPT09IGRvY3VtZW50IHx8IGRvYy5ub2RlVHlwZSAhPT0gOSB8fCAhZG9jLmRvY3VtZW50RWxlbWVudCApIHsNCgkJcmV0dXJuIGRvY3VtZW50Ow0KCX0NCg0KCS8vIFNldCBvdXIgZG9jdW1lbnQNCglkb2N1bWVudCA9IGRvYzsNCglkb2NFbGVtID0gZG9jLmRvY3VtZW50RWxlbWVudDsNCg0KCS8vIFN1cHBvcnQgdGVzdHMNCglkb2N1bWVudElzSFRNTCA9ICFpc1hNTCggZG9jICk7DQoNCgkvLyBTdXBwb3J0OiBJRT44DQoJLy8gSWYgaWZyYW1lIGRvY3VtZW50IGlzIGFzc2lnbmVkIHRvICJkb2N1bWVudCIgdmFyaWFibGUgYW5kIGlmIGlmcmFtZSBoYXMgYmVlbiByZWxvYWRlZCwNCgkvLyBJRSB3aWxsIHRocm93ICJwZXJtaXNzaW9uIGRlbmllZCIgZXJyb3Igd2hlbiBhY2Nlc3NpbmcgImRvY3VtZW50IiB2YXJpYWJsZSwgc2VlIGpRdWVyeSAjMTM5MzYNCgkvLyBJRTYtOCBkbyBub3Qgc3VwcG9ydCB0aGUgZGVmYXVsdFZpZXcgcHJvcGVydHkgc28gcGFyZW50IHdpbGwgYmUgdW5kZWZpbmVkDQoJaWYgKCBwYXJlbnQgJiYgcGFyZW50LmF0dGFjaEV2ZW50ICYmIHBhcmVudCAhPT0gcGFyZW50LnRvcCApIHsNCgkJcGFyZW50LmF0dGFjaEV2ZW50KCAib25iZWZvcmV1bmxvYWQiLCBmdW5jdGlvbigpIHsNCgkJCXNldERvY3VtZW50KCk7DQoJCX0pOw0KCX0NCg0KCS8qIEF0dHJpYnV0ZXMNCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovDQoNCgkvLyBTdXBwb3J0OiBJRTw4DQoJLy8gVmVyaWZ5IHRoYXQgZ2V0QXR0cmlidXRlIHJlYWxseSByZXR1cm5zIGF0dHJpYnV0ZXMgYW5kIG5vdCBwcm9wZXJ0aWVzIChleGNlcHRpbmcgSUU4IGJvb2xlYW5zKQ0KCXN1cHBvcnQuYXR0cmlidXRlcyA9IGFzc2VydChmdW5jdGlvbiggZGl2ICkgew0KCQlkaXYuY2xhc3NOYW1lID0gImkiOw0KCQlyZXR1cm4gIWRpdi5nZXRBdHRyaWJ1dGUoImNsYXNzTmFtZSIpOw0KCX0pOw0KDQoJLyogZ2V0RWxlbWVudChzKUJ5Kg0KCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8NCg0KCS8vIENoZWNrIGlmIGdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIikgcmV0dXJucyBvbmx5IGVsZW1lbnRzDQoJc3VwcG9ydC5nZXRFbGVtZW50c0J5VGFnTmFtZSA9IGFzc2VydChmdW5jdGlvbiggZGl2ICkgew0KCQlkaXYuYXBwZW5kQ2hpbGQoIGRvYy5jcmVhdGVDb21tZW50KCIiKSApOw0KCQlyZXR1cm4gIWRpdi5nZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpLmxlbmd0aDsNCgl9KTsNCg0KCS8vIENoZWNrIGlmIGdldEVsZW1lbnRzQnlDbGFzc05hbWUgY2FuIGJlIHRydXN0ZWQNCglzdXBwb3J0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgPSBhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsNCgkJZGl2LmlubmVySFRNTCA9ICI8ZGl2IGNsYXNzPSdhJz48L2Rpdj48ZGl2IGNsYXNzPSdhIGknPjwvZGl2PiI7DQoNCgkJLy8gU3VwcG9ydDogU2FmYXJpPDQNCgkJLy8gQ2F0Y2ggY2xhc3Mgb3Zlci1jYWNoaW5nDQoJCWRpdi5maXJzdENoaWxkLmNsYXNzTmFtZSA9ICJpIjsNCgkJLy8gU3VwcG9ydDogT3BlcmE8MTANCgkJLy8gQ2F0Y2ggZ0VCQ04gZmFpbHVyZSB0byBmaW5kIG5vbi1sZWFkaW5nIGNsYXNzZXMNCgkJcmV0dXJuIGRpdi5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCJpIikubGVuZ3RoID09PSAyOw0KCX0pOw0KDQoJLy8gU3VwcG9ydDogSUU8MTANCgkvLyBDaGVjayBpZiBnZXRFbGVtZW50QnlJZCByZXR1cm5zIGVsZW1lbnRzIGJ5IG5hbWUNCgkvLyBUaGUgYnJva2VuIGdldEVsZW1lbnRCeUlkIG1ldGhvZHMgZG9uJ3QgcGljayB1cCBwcm9ncmFtYXRpY2FsbHktc2V0IG5hbWVzLA0KCS8vIHNvIHVzZSBhIHJvdW5kYWJvdXQgZ2V0RWxlbWVudHNCeU5hbWUgdGVzdA0KCXN1cHBvcnQuZ2V0QnlJZCA9IGFzc2VydChmdW5jdGlvbiggZGl2ICkgew0KCQlkb2NFbGVtLmFwcGVuZENoaWxkKCBkaXYgKS5pZCA9IGV4cGFuZG87DQoJCXJldHVybiAhZG9jLmdldEVsZW1lbnRzQnlOYW1lIHx8ICFkb2MuZ2V0RWxlbWVudHNCeU5hbWUoIGV4cGFuZG8gKS5sZW5ndGg7DQoJfSk7DQoNCgkvLyBJRCBmaW5kIGFuZCBmaWx0ZXINCglpZiAoIHN1cHBvcnQuZ2V0QnlJZCApIHsNCgkJRXhwci5maW5kWyJJRCJdID0gZnVuY3Rpb24oIGlkLCBjb250ZXh0ICkgew0KCQkJaWYgKCB0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50QnlJZCAhPT0gc3RydW5kZWZpbmVkICYmIGRvY3VtZW50SXNIVE1MICkgew0KCQkJCXZhciBtID0gY29udGV4dC5nZXRFbGVtZW50QnlJZCggaWQgKTsNCgkJCQkvLyBDaGVjayBwYXJlbnROb2RlIHRvIGNhdGNoIHdoZW4gQmxhY2tiZXJyeSA0LjYgcmV0dXJucw0KCQkJCS8vIG5vZGVzIHRoYXQgYXJlIG5vIGxvbmdlciBpbiB0aGUgZG9jdW1lbnQgIzY5NjMNCgkJCQlyZXR1cm4gbSAmJiBtLnBhcmVudE5vZGUgPyBbbV0gOiBbXTsNCgkJCX0NCgkJfTsNCgkJRXhwci5maWx0ZXJbIklEIl0gPSBmdW5jdGlvbiggaWQgKSB7DQoJCQl2YXIgYXR0cklkID0gaWQucmVwbGFjZSggcnVuZXNjYXBlLCBmdW5lc2NhcGUgKTsNCgkJCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsNCgkJCQlyZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoImlkIikgPT09IGF0dHJJZDsNCgkJCX07DQoJCX07DQoJfSBlbHNlIHsNCgkJLy8gU3VwcG9ydDogSUU2LzcNCgkJLy8gZ2V0RWxlbWVudEJ5SWQgaXMgbm90IHJlbGlhYmxlIGFzIGEgZmluZCBzaG9ydGN1dA0KCQlkZWxldGUgRXhwci5maW5kWyJJRCJdOw0KDQoJCUV4cHIuZmlsdGVyWyJJRCJdID0gIGZ1bmN0aW9uKCBpZCApIHsNCgkJCXZhciBhdHRySWQgPSBpZC5yZXBsYWNlKCBydW5lc2NhcGUsIGZ1bmVzY2FwZSApOw0KCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgew0KCQkJCXZhciBub2RlID0gdHlwZW9mIGVsZW0uZ2V0QXR0cmlidXRlTm9kZSAhPT0gc3RydW5kZWZpbmVkICYmIGVsZW0uZ2V0QXR0cmlidXRlTm9kZSgiaWQiKTsNCgkJCQlyZXR1cm4gbm9kZSAmJiBub2RlLnZhbHVlID09PSBhdHRySWQ7DQoJCQl9Ow0KCQl9Ow0KCX0NCg0KCS8vIFRhZw0KCUV4cHIuZmluZFsiVEFHIl0gPSBzdXBwb3J0LmdldEVsZW1lbnRzQnlUYWdOYW1lID8NCgkJZnVuY3Rpb24oIHRhZywgY29udGV4dCApIHsNCgkJCWlmICggdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgIT09IHN0cnVuZGVmaW5lZCApIHsNCgkJCQlyZXR1cm4gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSggdGFnICk7DQoJCQl9DQoJCX0gOg0KCQlmdW5jdGlvbiggdGFnLCBjb250ZXh0ICkgew0KCQkJdmFyIGVsZW0sDQoJCQkJdG1wID0gW10sDQoJCQkJaSA9IDAsDQoJCQkJcmVzdWx0cyA9IGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIHRhZyApOw0KDQoJCQkvLyBGaWx0ZXIgb3V0IHBvc3NpYmxlIGNvbW1lbnRzDQoJCQlpZiAoIHRhZyA9PT0gIioiICkgew0KCQkJCXdoaWxlICggKGVsZW0gPSByZXN1bHRzW2krK10pICkgew0KCQkJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7DQoJCQkJCQl0bXAucHVzaCggZWxlbSApOw0KCQkJCQl9DQoJCQkJfQ0KDQoJCQkJcmV0dXJuIHRtcDsNCgkJCX0NCgkJCXJldHVybiByZXN1bHRzOw0KCQl9Ow0KDQoJLy8gQ2xhc3MNCglFeHByLmZpbmRbIkNMQVNTIl0gPSBzdXBwb3J0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgJiYgZnVuY3Rpb24oIGNsYXNzTmFtZSwgY29udGV4dCApIHsNCgkJaWYgKCB0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICE9PSBzdHJ1bmRlZmluZWQgJiYgZG9jdW1lbnRJc0hUTUwgKSB7DQoJCQlyZXR1cm4gY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCBjbGFzc05hbWUgKTsNCgkJfQ0KCX07DQoNCgkvKiBRU0EvbWF0Y2hlc1NlbGVjdG9yDQoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLw0KDQoJLy8gUVNBIGFuZCBtYXRjaGVzU2VsZWN0b3Igc3VwcG9ydA0KDQoJLy8gbWF0Y2hlc1NlbGVjdG9yKDphY3RpdmUpIHJlcG9ydHMgZmFsc2Ugd2hlbiB0cnVlIChJRTkvT3BlcmEgMTEuNSkNCglyYnVnZ3lNYXRjaGVzID0gW107DQoNCgkvLyBxU2EoOmZvY3VzKSByZXBvcnRzIGZhbHNlIHdoZW4gdHJ1ZSAoQ2hyb21lIDIxKQ0KCS8vIFdlIGFsbG93IHRoaXMgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBJRTgvOSB0aGF0IHRocm93cyBhbiBlcnJvcg0KCS8vIHdoZW5ldmVyIGBkb2N1bWVudC5hY3RpdmVFbGVtZW50YCBpcyBhY2Nlc3NlZCBvbiBhbiBpZnJhbWUNCgkvLyBTbywgd2UgYWxsb3cgOmZvY3VzIHRvIHBhc3MgdGhyb3VnaCBRU0EgYWxsIHRoZSB0aW1lIHRvIGF2b2lkIHRoZSBJRSBlcnJvcg0KCS8vIFNlZSBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC8xMzM3OA0KCXJidWdneVFTQSA9IFtdOw0KDQoJaWYgKCAoc3VwcG9ydC5xc2EgPSBybmF0aXZlLnRlc3QoIGRvYy5xdWVyeVNlbGVjdG9yQWxsICkpICkgew0KCQkvLyBCdWlsZCBRU0EgcmVnZXgNCgkJLy8gUmVnZXggc3RyYXRlZ3kgYWRvcHRlZCBmcm9tIERpZWdvIFBlcmluaQ0KCQlhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsNCgkJCS8vIFNlbGVjdCBpcyBzZXQgdG8gZW1wdHkgc3RyaW5nIG9uIHB1cnBvc2UNCgkJCS8vIFRoaXMgaXMgdG8gdGVzdCBJRSdzIHRyZWF0bWVudCBvZiBub3QgZXhwbGljaXRseQ0KCQkJLy8gc2V0dGluZyBhIGJvb2xlYW4gY29udGVudCBhdHRyaWJ1dGUsDQoJCQkvLyBzaW5jZSBpdHMgcHJlc2VuY2Ugc2hvdWxkIGJlIGVub3VnaA0KCQkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTIzNTkNCgkJCWRpdi5pbm5lckhUTUwgPSAiPHNlbGVjdD48b3B0aW9uIHNlbGVjdGVkPScnPjwvb3B0aW9uPjwvc2VsZWN0PiI7DQoNCgkJCS8vIFN1cHBvcnQ6IElFOA0KCQkJLy8gQm9vbGVhbiBhdHRyaWJ1dGVzIGFuZCAidmFsdWUiIGFyZSBub3QgdHJlYXRlZCBjb3JyZWN0bHkNCgkJCWlmICggIWRpdi5xdWVyeVNlbGVjdG9yQWxsKCJbc2VsZWN0ZWRdIikubGVuZ3RoICkgew0KCQkJCXJidWdneVFTQS5wdXNoKCAiXFxbIiArIHdoaXRlc3BhY2UgKyAiKig/OnZhbHVlfCIgKyBib29sZWFucyArICIpIiApOw0KCQkJfQ0KDQoJCQkvLyBXZWJraXQvT3BlcmEgLSA6Y2hlY2tlZCBzaG91bGQgcmV0dXJuIHNlbGVjdGVkIG9wdGlvbiBlbGVtZW50cw0KCQkJLy8gaHR0cDovL3d3dy53My5vcmcvVFIvMjAxMS9SRUMtY3NzMy1zZWxlY3RvcnMtMjAxMTA5MjkvI2NoZWNrZWQNCgkJCS8vIElFOCB0aHJvd3MgZXJyb3IgaGVyZSBhbmQgd2lsbCBub3Qgc2VlIGxhdGVyIHRlc3RzDQoJCQlpZiAoICFkaXYucXVlcnlTZWxlY3RvckFsbCgiOmNoZWNrZWQiKS5sZW5ndGggKSB7DQoJCQkJcmJ1Z2d5UVNBLnB1c2goIjpjaGVja2VkIik7DQoJCQl9DQoJCX0pOw0KDQoJCWFzc2VydChmdW5jdGlvbiggZGl2ICkgew0KDQoJCQkvLyBTdXBwb3J0OiBPcGVyYSAxMC0xMi9JRTgNCgkJCS8vIF49ICQ9ICo9IGFuZCBlbXB0eSB2YWx1ZXMNCgkJCS8vIFNob3VsZCBub3Qgc2VsZWN0IGFueXRoaW5nDQoJCQkvLyBTdXBwb3J0OiBXaW5kb3dzIDggTmF0aXZlIEFwcHMNCgkJCS8vIFRoZSB0eXBlIGF0dHJpYnV0ZSBpcyByZXN0cmljdGVkIGR1cmluZyAuaW5uZXJIVE1MIGFzc2lnbm1lbnQNCgkJCXZhciBpbnB1dCA9IGRvYy5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOw0KCQkJaW5wdXQuc2V0QXR0cmlidXRlKCAidHlwZSIsICJoaWRkZW4iICk7DQoJCQlkaXYuYXBwZW5kQ2hpbGQoIGlucHV0ICkuc2V0QXR0cmlidXRlKCAidCIsICIiICk7DQoNCgkJCWlmICggZGl2LnF1ZXJ5U2VsZWN0b3JBbGwoIlt0Xj0nJ10iKS5sZW5ndGggKSB7DQoJCQkJcmJ1Z2d5UVNBLnB1c2goICJbKl4kXT0iICsgd2hpdGVzcGFjZSArICIqKD86Jyd8XCJcIikiICk7DQoJCQl9DQoNCgkJCS8vIEZGIDMuNSAtIDplbmFibGVkLzpkaXNhYmxlZCBhbmQgaGlkZGVuIGVsZW1lbnRzIChoaWRkZW4gZWxlbWVudHMgYXJlIHN0aWxsIGVuYWJsZWQpDQoJCQkvLyBJRTggdGhyb3dzIGVycm9yIGhlcmUgYW5kIHdpbGwgbm90IHNlZSBsYXRlciB0ZXN0cw0KCQkJaWYgKCAhZGl2LnF1ZXJ5U2VsZWN0b3JBbGwoIjplbmFibGVkIikubGVuZ3RoICkgew0KCQkJCXJidWdneVFTQS5wdXNoKCAiOmVuYWJsZWQiLCAiOmRpc2FibGVkIiApOw0KCQkJfQ0KDQoJCQkvLyBPcGVyYSAxMC0xMSBkb2VzIG5vdCB0aHJvdyBvbiBwb3N0LWNvbW1hIGludmFsaWQgcHNldWRvcw0KCQkJZGl2LnF1ZXJ5U2VsZWN0b3JBbGwoIiosOngiKTsNCgkJCXJidWdneVFTQS5wdXNoKCIsLio6Iik7DQoJCX0pOw0KCX0NCg0KCWlmICggKHN1cHBvcnQubWF0Y2hlc1NlbGVjdG9yID0gcm5hdGl2ZS50ZXN0KCAobWF0Y2hlcyA9IGRvY0VsZW0ud2Via2l0TWF0Y2hlc1NlbGVjdG9yIHx8DQoJCWRvY0VsZW0ubW96TWF0Y2hlc1NlbGVjdG9yIHx8DQoJCWRvY0VsZW0ub01hdGNoZXNTZWxlY3RvciB8fA0KCQlkb2NFbGVtLm1zTWF0Y2hlc1NlbGVjdG9yKSApKSApIHsNCg0KCQlhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsNCgkJCS8vIENoZWNrIHRvIHNlZSBpZiBpdCdzIHBvc3NpYmxlIHRvIGRvIG1hdGNoZXNTZWxlY3Rvcg0KCQkJLy8gb24gYSBkaXNjb25uZWN0ZWQgbm9kZSAoSUUgOSkNCgkJCXN1cHBvcnQuZGlzY29ubmVjdGVkTWF0Y2ggPSBtYXRjaGVzLmNhbGwoIGRpdiwgImRpdiIgKTsNCg0KCQkJLy8gVGhpcyBzaG91bGQgZmFpbCB3aXRoIGFuIGV4Y2VwdGlvbg0KCQkJLy8gR2Vja28gZG9lcyBub3QgZXJyb3IsIHJldHVybnMgZmFsc2UgaW5zdGVhZA0KCQkJbWF0Y2hlcy5jYWxsKCBkaXYsICJbcyE9JyddOngiICk7DQoJCQlyYnVnZ3lNYXRjaGVzLnB1c2goICIhPSIsIHBzZXVkb3MgKTsNCgkJfSk7DQoJfQ0KDQoJcmJ1Z2d5UVNBID0gcmJ1Z2d5UVNBLmxlbmd0aCAmJiBuZXcgUmVnRXhwKCByYnVnZ3lRU0Euam9pbigifCIpICk7DQoJcmJ1Z2d5TWF0Y2hlcyA9IHJidWdneU1hdGNoZXMubGVuZ3RoICYmIG5ldyBSZWdFeHAoIHJidWdneU1hdGNoZXMuam9pbigifCIpICk7DQoNCgkvKiBDb250YWlucw0KCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8NCg0KCS8vIEVsZW1lbnQgY29udGFpbnMgYW5vdGhlcg0KCS8vIFB1cnBvc2VmdWxseSBkb2VzIG5vdCBpbXBsZW1lbnQgaW5jbHVzaXZlIGRlc2NlbmRlbnQNCgkvLyBBcyBpbiwgYW4gZWxlbWVudCBkb2VzIG5vdCBjb250YWluIGl0c2VsZg0KCWNvbnRhaW5zID0gcm5hdGl2ZS50ZXN0KCBkb2NFbGVtLmNvbnRhaW5zICkgfHwgZG9jRWxlbS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiA/DQoJCWZ1bmN0aW9uKCBhLCBiICkgew0KCQkJdmFyIGFkb3duID0gYS5ub2RlVHlwZSA9PT0gOSA/IGEuZG9jdW1lbnRFbGVtZW50IDogYSwNCgkJCQlidXAgPSBiICYmIGIucGFyZW50Tm9kZTsNCgkJCXJldHVybiBhID09PSBidXAgfHwgISEoIGJ1cCAmJiBidXAubm9kZVR5cGUgPT09IDEgJiYgKA0KCQkJCWFkb3duLmNvbnRhaW5zID8NCgkJCQkJYWRvd24uY29udGFpbnMoIGJ1cCApIDoNCgkJCQkJYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiAmJiBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKCBidXAgKSAmIDE2DQoJCQkpKTsNCgkJfSA6DQoJCWZ1bmN0aW9uKCBhLCBiICkgew0KCQkJaWYgKCBiICkgew0KCQkJCXdoaWxlICggKGIgPSBiLnBhcmVudE5vZGUpICkgew0KCQkJCQlpZiAoIGIgPT09IGEgKSB7DQoJCQkJCQlyZXR1cm4gdHJ1ZTsNCgkJCQkJfQ0KCQkJCX0NCgkJCX0NCgkJCXJldHVybiBmYWxzZTsNCgkJfTsNCg0KCS8qIFNvcnRpbmcNCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovDQoNCgkvLyBEb2N1bWVudCBvcmRlciBzb3J0aW5nDQoJc29ydE9yZGVyID0gZG9jRWxlbS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiA/DQoJZnVuY3Rpb24oIGEsIGIgKSB7DQoNCgkJLy8gRmxhZyBmb3IgZHVwbGljYXRlIHJlbW92YWwNCgkJaWYgKCBhID09PSBiICkgew0KCQkJaGFzRHVwbGljYXRlID0gdHJ1ZTsNCgkJCXJldHVybiAwOw0KCQl9DQoNCgkJdmFyIGNvbXBhcmUgPSBiLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uICYmIGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24gJiYgYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiggYiApOw0KDQoJCWlmICggY29tcGFyZSApIHsNCgkJCS8vIERpc2Nvbm5lY3RlZCBub2Rlcw0KCQkJaWYgKCBjb21wYXJlICYgMSB8fA0KCQkJCSghc3VwcG9ydC5zb3J0RGV0YWNoZWQgJiYgYi5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiggYSApID09PSBjb21wYXJlKSApIHsNCg0KCQkJCS8vIENob29zZSB0aGUgZmlyc3QgZWxlbWVudCB0aGF0IGlzIHJlbGF0ZWQgdG8gb3VyIHByZWZlcnJlZCBkb2N1bWVudA0KCQkJCWlmICggYSA9PT0gZG9jIHx8IGNvbnRhaW5zKHByZWZlcnJlZERvYywgYSkgKSB7DQoJCQkJCXJldHVybiAtMTsNCgkJCQl9DQoJCQkJaWYgKCBiID09PSBkb2MgfHwgY29udGFpbnMocHJlZmVycmVkRG9jLCBiKSApIHsNCgkJCQkJcmV0dXJuIDE7DQoJCQkJfQ0KDQoJCQkJLy8gTWFpbnRhaW4gb3JpZ2luYWwgb3JkZXINCgkJCQlyZXR1cm4gc29ydElucHV0ID8NCgkJCQkJKCBpbmRleE9mLmNhbGwoIHNvcnRJbnB1dCwgYSApIC0gaW5kZXhPZi5jYWxsKCBzb3J0SW5wdXQsIGIgKSApIDoNCgkJCQkJMDsNCgkJCX0NCg0KCQkJcmV0dXJuIGNvbXBhcmUgJiA0ID8gLTEgOiAxOw0KCQl9DQoNCgkJLy8gTm90IGRpcmVjdGx5IGNvbXBhcmFibGUsIHNvcnQgb24gZXhpc3RlbmNlIG9mIG1ldGhvZA0KCQlyZXR1cm4gYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiA/IC0xIDogMTsNCgl9IDoNCglmdW5jdGlvbiggYSwgYiApIHsNCgkJdmFyIGN1ciwNCgkJCWkgPSAwLA0KCQkJYXVwID0gYS5wYXJlbnROb2RlLA0KCQkJYnVwID0gYi5wYXJlbnROb2RlLA0KCQkJYXAgPSBbIGEgXSwNCgkJCWJwID0gWyBiIF07DQoNCgkJLy8gRXhpdCBlYXJseSBpZiB0aGUgbm9kZXMgYXJlIGlkZW50aWNhbA0KCQlpZiAoIGEgPT09IGIgKSB7DQoJCQloYXNEdXBsaWNhdGUgPSB0cnVlOw0KCQkJcmV0dXJuIDA7DQoNCgkJLy8gUGFyZW50bGVzcyBub2RlcyBhcmUgZWl0aGVyIGRvY3VtZW50cyBvciBkaXNjb25uZWN0ZWQNCgkJfSBlbHNlIGlmICggIWF1cCB8fCAhYnVwICkgew0KCQkJcmV0dXJuIGEgPT09IGRvYyA/IC0xIDoNCgkJCQliID09PSBkb2MgPyAxIDoNCgkJCQlhdXAgPyAtMSA6DQoJCQkJYnVwID8gMSA6DQoJCQkJc29ydElucHV0ID8NCgkJCQkoIGluZGV4T2YuY2FsbCggc29ydElucHV0LCBhICkgLSBpbmRleE9mLmNhbGwoIHNvcnRJbnB1dCwgYiApICkgOg0KCQkJCTA7DQoNCgkJLy8gSWYgdGhlIG5vZGVzIGFyZSBzaWJsaW5ncywgd2UgY2FuIGRvIGEgcXVpY2sgY2hlY2sNCgkJfSBlbHNlIGlmICggYXVwID09PSBidXAgKSB7DQoJCQlyZXR1cm4gc2libGluZ0NoZWNrKCBhLCBiICk7DQoJCX0NCg0KCQkvLyBPdGhlcndpc2Ugd2UgbmVlZCBmdWxsIGxpc3RzIG9mIHRoZWlyIGFuY2VzdG9ycyBmb3IgY29tcGFyaXNvbg0KCQljdXIgPSBhOw0KCQl3aGlsZSAoIChjdXIgPSBjdXIucGFyZW50Tm9kZSkgKSB7DQoJCQlhcC51bnNoaWZ0KCBjdXIgKTsNCgkJfQ0KCQljdXIgPSBiOw0KCQl3aGlsZSAoIChjdXIgPSBjdXIucGFyZW50Tm9kZSkgKSB7DQoJCQlicC51bnNoaWZ0KCBjdXIgKTsNCgkJfQ0KDQoJCS8vIFdhbGsgZG93biB0aGUgdHJlZSBsb29raW5nIGZvciBhIGRpc2NyZXBhbmN5DQoJCXdoaWxlICggYXBbaV0gPT09IGJwW2ldICkgew0KCQkJaSsrOw0KCQl9DQoNCgkJcmV0dXJuIGkgPw0KCQkJLy8gRG8gYSBzaWJsaW5nIGNoZWNrIGlmIHRoZSBub2RlcyBoYXZlIGEgY29tbW9uIGFuY2VzdG9yDQoJCQlzaWJsaW5nQ2hlY2soIGFwW2ldLCBicFtpXSApIDoNCg0KCQkJLy8gT3RoZXJ3aXNlIG5vZGVzIGluIG91ciBkb2N1bWVudCBzb3J0IGZpcnN0DQoJCQlhcFtpXSA9PT0gcHJlZmVycmVkRG9jID8gLTEgOg0KCQkJYnBbaV0gPT09IHByZWZlcnJlZERvYyA/IDEgOg0KCQkJMDsNCgl9Ow0KDQoJcmV0dXJuIGRvYzsNCn07DQoNClNpenpsZS5tYXRjaGVzID0gZnVuY3Rpb24oIGV4cHIsIGVsZW1lbnRzICkgew0KCXJldHVybiBTaXp6bGUoIGV4cHIsIG51bGwsIG51bGwsIGVsZW1lbnRzICk7DQp9Ow0KDQpTaXp6bGUubWF0Y2hlc1NlbGVjdG9yID0gZnVuY3Rpb24oIGVsZW0sIGV4cHIgKSB7DQoJLy8gU2V0IGRvY3VtZW50IHZhcnMgaWYgbmVlZGVkDQoJaWYgKCAoIGVsZW0ub3duZXJEb2N1bWVudCB8fCBlbGVtICkgIT09IGRvY3VtZW50ICkgew0KCQlzZXREb2N1bWVudCggZWxlbSApOw0KCX0NCg0KCS8vIE1ha2Ugc3VyZSB0aGF0IGF0dHJpYnV0ZSBzZWxlY3RvcnMgYXJlIHF1b3RlZA0KCWV4cHIgPSBleHByLnJlcGxhY2UoIHJhdHRyaWJ1dGVRdW90ZXMsICI9JyQxJ10iICk7DQoNCglpZiAoIHN1cHBvcnQubWF0Y2hlc1NlbGVjdG9yICYmIGRvY3VtZW50SXNIVE1MICYmDQoJCSggIXJidWdneU1hdGNoZXMgfHwgIXJidWdneU1hdGNoZXMudGVzdCggZXhwciApICkgJiYNCgkJKCAhcmJ1Z2d5UVNBICAgICB8fCAhcmJ1Z2d5UVNBLnRlc3QoIGV4cHIgKSApICkgew0KDQoJCXRyeSB7DQoJCQl2YXIgcmV0ID0gbWF0Y2hlcy5jYWxsKCBlbGVtLCBleHByICk7DQoNCgkJCS8vIElFIDkncyBtYXRjaGVzU2VsZWN0b3IgcmV0dXJucyBmYWxzZSBvbiBkaXNjb25uZWN0ZWQgbm9kZXMNCgkJCWlmICggcmV0IHx8IHN1cHBvcnQuZGlzY29ubmVjdGVkTWF0Y2ggfHwNCgkJCQkJLy8gQXMgd2VsbCwgZGlzY29ubmVjdGVkIG5vZGVzIGFyZSBzYWlkIHRvIGJlIGluIGEgZG9jdW1lbnQNCgkJCQkJLy8gZnJhZ21lbnQgaW4gSUUgOQ0KCQkJCQllbGVtLmRvY3VtZW50ICYmIGVsZW0uZG9jdW1lbnQubm9kZVR5cGUgIT09IDExICkgew0KCQkJCXJldHVybiByZXQ7DQoJCQl9DQoJCX0gY2F0Y2goZSkge30NCgl9DQoNCglyZXR1cm4gU2l6emxlKCBleHByLCBkb2N1bWVudCwgbnVsbCwgW2VsZW1dICkubGVuZ3RoID4gMDsNCn07DQoNClNpenpsZS5jb250YWlucyA9IGZ1bmN0aW9uKCBjb250ZXh0LCBlbGVtICkgew0KCS8vIFNldCBkb2N1bWVudCB2YXJzIGlmIG5lZWRlZA0KCWlmICggKCBjb250ZXh0Lm93bmVyRG9jdW1lbnQgfHwgY29udGV4dCApICE9PSBkb2N1bWVudCApIHsNCgkJc2V0RG9jdW1lbnQoIGNvbnRleHQgKTsNCgl9DQoJcmV0dXJuIGNvbnRhaW5zKCBjb250ZXh0LCBlbGVtICk7DQp9Ow0KDQpTaXp6bGUuYXR0ciA9IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgew0KCS8vIFNldCBkb2N1bWVudCB2YXJzIGlmIG5lZWRlZA0KCWlmICggKCBlbGVtLm93bmVyRG9jdW1lbnQgfHwgZWxlbSApICE9PSBkb2N1bWVudCApIHsNCgkJc2V0RG9jdW1lbnQoIGVsZW0gKTsNCgl9DQoNCgl2YXIgZm4gPSBFeHByLmF0dHJIYW5kbGVbIG5hbWUudG9Mb3dlckNhc2UoKSBdLA0KCQkvLyBEb24ndCBnZXQgZm9vbGVkIGJ5IE9iamVjdC5wcm90b3R5cGUgcHJvcGVydGllcyAoalF1ZXJ5ICMxMzgwNykNCgkJdmFsID0gZm4gJiYgaGFzT3duLmNhbGwoIEV4cHIuYXR0ckhhbmRsZSwgbmFtZS50b0xvd2VyQ2FzZSgpICkgPw0KCQkJZm4oIGVsZW0sIG5hbWUsICFkb2N1bWVudElzSFRNTCApIDoNCgkJCXVuZGVmaW5lZDsNCg0KCXJldHVybiB2YWwgPT09IHVuZGVmaW5lZCA/DQoJCXN1cHBvcnQuYXR0cmlidXRlcyB8fCAhZG9jdW1lbnRJc0hUTUwgPw0KCQkJZWxlbS5nZXRBdHRyaWJ1dGUoIG5hbWUgKSA6DQoJCQkodmFsID0gZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKG5hbWUpKSAmJiB2YWwuc3BlY2lmaWVkID8NCgkJCQl2YWwudmFsdWUgOg0KCQkJCW51bGwgOg0KCQl2YWw7DQp9Ow0KDQpTaXp6bGUuZXJyb3IgPSBmdW5jdGlvbiggbXNnICkgew0KCXRocm93IG5ldyBFcnJvciggIlN5bnRheCBlcnJvciwgdW5yZWNvZ25pemVkIGV4cHJlc3Npb246ICIgKyBtc2cgKTsNCn07DQoNCi8qKg0KICogRG9jdW1lbnQgc29ydGluZyBhbmQgcmVtb3ZpbmcgZHVwbGljYXRlcw0KICogQHBhcmFtIHtBcnJheUxpa2V9IHJlc3VsdHMNCiAqLw0KU2l6emxlLnVuaXF1ZVNvcnQgPSBmdW5jdGlvbiggcmVzdWx0cyApIHsNCgl2YXIgZWxlbSwNCgkJZHVwbGljYXRlcyA9IFtdLA0KCQlqID0gMCwNCgkJaSA9IDA7DQoNCgkvLyBVbmxlc3Mgd2UgKmtub3cqIHdlIGNhbiBkZXRlY3QgZHVwbGljYXRlcywgYXNzdW1lIHRoZWlyIHByZXNlbmNlDQoJaGFzRHVwbGljYXRlID0gIXN1cHBvcnQuZGV0ZWN0RHVwbGljYXRlczsNCglzb3J0SW5wdXQgPSAhc3VwcG9ydC5zb3J0U3RhYmxlICYmIHJlc3VsdHMuc2xpY2UoIDAgKTsNCglyZXN1bHRzLnNvcnQoIHNvcnRPcmRlciApOw0KDQoJaWYgKCBoYXNEdXBsaWNhdGUgKSB7DQoJCXdoaWxlICggKGVsZW0gPSByZXN1bHRzW2krK10pICkgew0KCQkJaWYgKCBlbGVtID09PSByZXN1bHRzWyBpIF0gKSB7DQoJCQkJaiA9IGR1cGxpY2F0ZXMucHVzaCggaSApOw0KCQkJfQ0KCQl9DQoJCXdoaWxlICggai0tICkgew0KCQkJcmVzdWx0cy5zcGxpY2UoIGR1cGxpY2F0ZXNbIGogXSwgMSApOw0KCQl9DQoJfQ0KDQoJcmV0dXJuIHJlc3VsdHM7DQp9Ow0KDQovKioNCiAqIFV0aWxpdHkgZnVuY3Rpb24gZm9yIHJldHJpZXZpbmcgdGhlIHRleHQgdmFsdWUgb2YgYW4gYXJyYXkgb2YgRE9NIG5vZGVzDQogKiBAcGFyYW0ge0FycmF5fEVsZW1lbnR9IGVsZW0NCiAqLw0KZ2V0VGV4dCA9IFNpenpsZS5nZXRUZXh0ID0gZnVuY3Rpb24oIGVsZW0gKSB7DQoJdmFyIG5vZGUsDQoJCXJldCA9ICIiLA0KCQlpID0gMCwNCgkJbm9kZVR5cGUgPSBlbGVtLm5vZGVUeXBlOw0KDQoJaWYgKCAhbm9kZVR5cGUgKSB7DQoJCS8vIElmIG5vIG5vZGVUeXBlLCB0aGlzIGlzIGV4cGVjdGVkIHRvIGJlIGFuIGFycmF5DQoJCWZvciAoIDsgKG5vZGUgPSBlbGVtW2ldKTsgaSsrICkgew0KCQkJLy8gRG8gbm90IHRyYXZlcnNlIGNvbW1lbnQgbm9kZXMNCgkJCXJldCArPSBnZXRUZXh0KCBub2RlICk7DQoJCX0NCgl9IGVsc2UgaWYgKCBub2RlVHlwZSA9PT0gMSB8fCBub2RlVHlwZSA9PT0gOSB8fCBub2RlVHlwZSA9PT0gMTEgKSB7DQoJCS8vIFVzZSB0ZXh0Q29udGVudCBmb3IgZWxlbWVudHMNCgkJLy8gaW5uZXJUZXh0IHVzYWdlIHJlbW92ZWQgZm9yIGNvbnNpc3RlbmN5IG9mIG5ldyBsaW5lcyAoc2VlICMxMTE1MykNCgkJaWYgKCB0eXBlb2YgZWxlbS50ZXh0Q29udGVudCA9PT0gInN0cmluZyIgKSB7DQoJCQlyZXR1cm4gZWxlbS50ZXh0Q29udGVudDsNCgkJfSBlbHNlIHsNCgkJCS8vIFRyYXZlcnNlIGl0cyBjaGlsZHJlbg0KCQkJZm9yICggZWxlbSA9IGVsZW0uZmlyc3RDaGlsZDsgZWxlbTsgZWxlbSA9IGVsZW0ubmV4dFNpYmxpbmcgKSB7DQoJCQkJcmV0ICs9IGdldFRleHQoIGVsZW0gKTsNCgkJCX0NCgkJfQ0KCX0gZWxzZSBpZiAoIG5vZGVUeXBlID09PSAzIHx8IG5vZGVUeXBlID09PSA0ICkgew0KCQlyZXR1cm4gZWxlbS5ub2RlVmFsdWU7DQoJfQ0KCS8vIERvIG5vdCBpbmNsdWRlIGNvbW1lbnQgb3IgcHJvY2Vzc2luZyBpbnN0cnVjdGlvbiBub2Rlcw0KDQoJcmV0dXJuIHJldDsNCn07DQoNCkV4cHIgPSBTaXp6bGUuc2VsZWN0b3JzID0gew0KDQoJLy8gQ2FuIGJlIGFkanVzdGVkIGJ5IHRoZSB1c2VyDQoJY2FjaGVMZW5ndGg6IDUwLA0KDQoJY3JlYXRlUHNldWRvOiBtYXJrRnVuY3Rpb24sDQoNCgltYXRjaDogbWF0Y2hFeHByLA0KDQoJYXR0ckhhbmRsZToge30sDQoNCglmaW5kOiB7fSwNCg0KCXJlbGF0aXZlOiB7DQoJCSI+IjogeyBkaXI6ICJwYXJlbnROb2RlIiwgZmlyc3Q6IHRydWUgfSwNCgkJIiAiOiB7IGRpcjogInBhcmVudE5vZGUiIH0sDQoJCSIrIjogeyBkaXI6ICJwcmV2aW91c1NpYmxpbmciLCBmaXJzdDogdHJ1ZSB9LA0KCQkifiI6IHsgZGlyOiAicHJldmlvdXNTaWJsaW5nIiB9DQoJfSwNCg0KCXByZUZpbHRlcjogew0KCQkiQVRUUiI6IGZ1bmN0aW9uKCBtYXRjaCApIHsNCgkJCW1hdGNoWzFdID0gbWF0Y2hbMV0ucmVwbGFjZSggcnVuZXNjYXBlLCBmdW5lc2NhcGUgKTsNCg0KCQkJLy8gTW92ZSB0aGUgZ2l2ZW4gdmFsdWUgdG8gbWF0Y2hbM10gd2hldGhlciBxdW90ZWQgb3IgdW5xdW90ZWQNCgkJCW1hdGNoWzNdID0gKCBtYXRjaFs0XSB8fCBtYXRjaFs1XSB8fCAiIiApLnJlcGxhY2UoIHJ1bmVzY2FwZSwgZnVuZXNjYXBlICk7DQoNCgkJCWlmICggbWF0Y2hbMl0gPT09ICJ+PSIgKSB7DQoJCQkJbWF0Y2hbM10gPSAiICIgKyBtYXRjaFszXSArICIgIjsNCgkJCX0NCg0KCQkJcmV0dXJuIG1hdGNoLnNsaWNlKCAwLCA0ICk7DQoJCX0sDQoNCgkJIkNISUxEIjogZnVuY3Rpb24oIG1hdGNoICkgew0KCQkJLyogbWF0Y2hlcyBmcm9tIG1hdGNoRXhwclsiQ0hJTEQiXQ0KCQkJCTEgdHlwZSAob25seXxudGh8Li4uKQ0KCQkJCTIgd2hhdCAoY2hpbGR8b2YtdHlwZSkNCgkJCQkzIGFyZ3VtZW50IChldmVufG9kZHxcZCp8XGQqbihbKy1dXGQrKT98Li4uKQ0KCQkJCTQgeG4tY29tcG9uZW50IG9mIHhuK3kgYXJndW1lbnQgKFsrLV0/XGQqbnwpDQoJCQkJNSBzaWduIG9mIHhuLWNvbXBvbmVudA0KCQkJCTYgeCBvZiB4bi1jb21wb25lbnQNCgkJCQk3IHNpZ24gb2YgeS1jb21wb25lbnQNCgkJCQk4IHkgb2YgeS1jb21wb25lbnQNCgkJCSovDQoJCQltYXRjaFsxXSA9IG1hdGNoWzFdLnRvTG93ZXJDYXNlKCk7DQoNCgkJCWlmICggbWF0Y2hbMV0uc2xpY2UoIDAsIDMgKSA9PT0gIm50aCIgKSB7DQoJCQkJLy8gbnRoLSogcmVxdWlyZXMgYXJndW1lbnQNCgkJCQlpZiAoICFtYXRjaFszXSApIHsNCgkJCQkJU2l6emxlLmVycm9yKCBtYXRjaFswXSApOw0KCQkJCX0NCg0KCQkJCS8vIG51bWVyaWMgeCBhbmQgeSBwYXJhbWV0ZXJzIGZvciBFeHByLmZpbHRlci5DSElMRA0KCQkJCS8vIHJlbWVtYmVyIHRoYXQgZmFsc2UvdHJ1ZSBjYXN0IHJlc3BlY3RpdmVseSB0byAwLzENCgkJCQltYXRjaFs0XSA9ICsoIG1hdGNoWzRdID8gbWF0Y2hbNV0gKyAobWF0Y2hbNl0gfHwgMSkgOiAyICogKCBtYXRjaFszXSA9PT0gImV2ZW4iIHx8IG1hdGNoWzNdID09PSAib2RkIiApICk7DQoJCQkJbWF0Y2hbNV0gPSArKCAoIG1hdGNoWzddICsgbWF0Y2hbOF0gKSB8fCBtYXRjaFszXSA9PT0gIm9kZCIgKTsNCg0KCQkJLy8gb3RoZXIgdHlwZXMgcHJvaGliaXQgYXJndW1lbnRzDQoJCQl9IGVsc2UgaWYgKCBtYXRjaFszXSApIHsNCgkJCQlTaXp6bGUuZXJyb3IoIG1hdGNoWzBdICk7DQoJCQl9DQoNCgkJCXJldHVybiBtYXRjaDsNCgkJfSwNCg0KCQkiUFNFVURPIjogZnVuY3Rpb24oIG1hdGNoICkgew0KCQkJdmFyIGV4Y2VzcywNCgkJCQl1bnF1b3RlZCA9ICFtYXRjaFs1XSAmJiBtYXRjaFsyXTsNCg0KCQkJaWYgKCBtYXRjaEV4cHJbIkNISUxEIl0udGVzdCggbWF0Y2hbMF0gKSApIHsNCgkJCQlyZXR1cm4gbnVsbDsNCgkJCX0NCg0KCQkJLy8gQWNjZXB0IHF1b3RlZCBhcmd1bWVudHMgYXMtaXMNCgkJCWlmICggbWF0Y2hbM10gJiYgbWF0Y2hbNF0gIT09IHVuZGVmaW5lZCApIHsNCgkJCQltYXRjaFsyXSA9IG1hdGNoWzRdOw0KDQoJCQkvLyBTdHJpcCBleGNlc3MgY2hhcmFjdGVycyBmcm9tIHVucXVvdGVkIGFyZ3VtZW50cw0KCQkJfSBlbHNlIGlmICggdW5xdW90ZWQgJiYgcnBzZXVkby50ZXN0KCB1bnF1b3RlZCApICYmDQoJCQkJLy8gR2V0IGV4Y2VzcyBmcm9tIHRva2VuaXplIChyZWN1cnNpdmVseSkNCgkJCQkoZXhjZXNzID0gdG9rZW5pemUoIHVucXVvdGVkLCB0cnVlICkpICYmDQoJCQkJLy8gYWR2YW5jZSB0byB0aGUgbmV4dCBjbG9zaW5nIHBhcmVudGhlc2lzDQoJCQkJKGV4Y2VzcyA9IHVucXVvdGVkLmluZGV4T2YoICIpIiwgdW5xdW90ZWQubGVuZ3RoIC0gZXhjZXNzICkgLSB1bnF1b3RlZC5sZW5ndGgpICkgew0KDQoJCQkJLy8gZXhjZXNzIGlzIGEgbmVnYXRpdmUgaW5kZXgNCgkJCQltYXRjaFswXSA9IG1hdGNoWzBdLnNsaWNlKCAwLCBleGNlc3MgKTsNCgkJCQltYXRjaFsyXSA9IHVucXVvdGVkLnNsaWNlKCAwLCBleGNlc3MgKTsNCgkJCX0NCg0KCQkJLy8gUmV0dXJuIG9ubHkgY2FwdHVyZXMgbmVlZGVkIGJ5IHRoZSBwc2V1ZG8gZmlsdGVyIG1ldGhvZCAodHlwZSBhbmQgYXJndW1lbnQpDQoJCQlyZXR1cm4gbWF0Y2guc2xpY2UoIDAsIDMgKTsNCgkJfQ0KCX0sDQoNCglmaWx0ZXI6IHsNCg0KCQkiVEFHIjogZnVuY3Rpb24oIG5vZGVOYW1lU2VsZWN0b3IgKSB7DQoJCQl2YXIgbm9kZU5hbWUgPSBub2RlTmFtZVNlbGVjdG9yLnJlcGxhY2UoIHJ1bmVzY2FwZSwgZnVuZXNjYXBlICkudG9Mb3dlckNhc2UoKTsNCgkJCXJldHVybiBub2RlTmFtZVNlbGVjdG9yID09PSAiKiIgPw0KCQkJCWZ1bmN0aW9uKCkgeyByZXR1cm4gdHJ1ZTsgfSA6DQoJCQkJZnVuY3Rpb24oIGVsZW0gKSB7DQoJCQkJCXJldHVybiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbm9kZU5hbWU7DQoJCQkJfTsNCgkJfSwNCg0KCQkiQ0xBU1MiOiBmdW5jdGlvbiggY2xhc3NOYW1lICkgew0KCQkJdmFyIHBhdHRlcm4gPSBjbGFzc0NhY2hlWyBjbGFzc05hbWUgKyAiICIgXTsNCg0KCQkJcmV0dXJuIHBhdHRlcm4gfHwNCgkJCQkocGF0dGVybiA9IG5ldyBSZWdFeHAoICIoXnwiICsgd2hpdGVzcGFjZSArICIpIiArIGNsYXNzTmFtZSArICIoIiArIHdoaXRlc3BhY2UgKyAifCQpIiApKSAmJg0KCQkJCWNsYXNzQ2FjaGUoIGNsYXNzTmFtZSwgZnVuY3Rpb24oIGVsZW0gKSB7DQoJCQkJCXJldHVybiBwYXR0ZXJuLnRlc3QoIHR5cGVvZiBlbGVtLmNsYXNzTmFtZSA9PT0gInN0cmluZyIgJiYgZWxlbS5jbGFzc05hbWUgfHwgdHlwZW9mIGVsZW0uZ2V0QXR0cmlidXRlICE9PSBzdHJ1bmRlZmluZWQgJiYgZWxlbS5nZXRBdHRyaWJ1dGUoImNsYXNzIikgfHwgIiIgKTsNCgkJCQl9KTsNCgkJfSwNCg0KCQkiQVRUUiI6IGZ1bmN0aW9uKCBuYW1lLCBvcGVyYXRvciwgY2hlY2sgKSB7DQoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7DQoJCQkJdmFyIHJlc3VsdCA9IFNpenpsZS5hdHRyKCBlbGVtLCBuYW1lICk7DQoNCgkJCQlpZiAoIHJlc3VsdCA9PSBudWxsICkgew0KCQkJCQlyZXR1cm4gb3BlcmF0b3IgPT09ICIhPSI7DQoJCQkJfQ0KCQkJCWlmICggIW9wZXJhdG9yICkgew0KCQkJCQlyZXR1cm4gdHJ1ZTsNCgkJCQl9DQoNCgkJCQlyZXN1bHQgKz0gIiI7DQoNCgkJCQlyZXR1cm4gb3BlcmF0b3IgPT09ICI9IiA/IHJlc3VsdCA9PT0gY2hlY2sgOg0KCQkJCQlvcGVyYXRvciA9PT0gIiE9IiA/IHJlc3VsdCAhPT0gY2hlY2sgOg0KCQkJCQlvcGVyYXRvciA9PT0gIl49IiA/IGNoZWNrICYmIHJlc3VsdC5pbmRleE9mKCBjaGVjayApID09PSAwIDoNCgkJCQkJb3BlcmF0b3IgPT09ICIqPSIgPyBjaGVjayAmJiByZXN1bHQuaW5kZXhPZiggY2hlY2sgKSA+IC0xIDoNCgkJCQkJb3BlcmF0b3IgPT09ICIkPSIgPyBjaGVjayAmJiByZXN1bHQuc2xpY2UoIC1jaGVjay5sZW5ndGggKSA9PT0gY2hlY2sgOg0KCQkJCQlvcGVyYXRvciA9PT0gIn49IiA/ICggIiAiICsgcmVzdWx0ICsgIiAiICkuaW5kZXhPZiggY2hlY2sgKSA+IC0xIDoNCgkJCQkJb3BlcmF0b3IgPT09ICJ8PSIgPyByZXN1bHQgPT09IGNoZWNrIHx8IHJlc3VsdC5zbGljZSggMCwgY2hlY2subGVuZ3RoICsgMSApID09PSBjaGVjayArICItIiA6DQoJCQkJCWZhbHNlOw0KCQkJfTsNCgkJfSwNCg0KCQkiQ0hJTEQiOiBmdW5jdGlvbiggdHlwZSwgd2hhdCwgYXJndW1lbnQsIGZpcnN0LCBsYXN0ICkgew0KCQkJdmFyIHNpbXBsZSA9IHR5cGUuc2xpY2UoIDAsIDMgKSAhPT0gIm50aCIsDQoJCQkJZm9yd2FyZCA9IHR5cGUuc2xpY2UoIC00ICkgIT09ICJsYXN0IiwNCgkJCQlvZlR5cGUgPSB3aGF0ID09PSAib2YtdHlwZSI7DQoNCgkJCXJldHVybiBmaXJzdCA9PT0gMSAmJiBsYXN0ID09PSAwID8NCg0KCQkJCS8vIFNob3J0Y3V0IGZvciA6bnRoLSoobikNCgkJCQlmdW5jdGlvbiggZWxlbSApIHsNCgkJCQkJcmV0dXJuICEhZWxlbS5wYXJlbnROb2RlOw0KCQkJCX0gOg0KDQoJCQkJZnVuY3Rpb24oIGVsZW0sIGNvbnRleHQsIHhtbCApIHsNCgkJCQkJdmFyIGNhY2hlLCBvdXRlckNhY2hlLCBub2RlLCBkaWZmLCBub2RlSW5kZXgsIHN0YXJ0LA0KCQkJCQkJZGlyID0gc2ltcGxlICE9PSBmb3J3YXJkID8gIm5leHRTaWJsaW5nIiA6ICJwcmV2aW91c1NpYmxpbmciLA0KCQkJCQkJcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlLA0KCQkJCQkJbmFtZSA9IG9mVHlwZSAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksDQoJCQkJCQl1c2VDYWNoZSA9ICF4bWwgJiYgIW9mVHlwZTsNCg0KCQkJCQlpZiAoIHBhcmVudCApIHsNCg0KCQkJCQkJLy8gOihmaXJzdHxsYXN0fG9ubHkpLShjaGlsZHxvZi10eXBlKQ0KCQkJCQkJaWYgKCBzaW1wbGUgKSB7DQoJCQkJCQkJd2hpbGUgKCBkaXIgKSB7DQoJCQkJCQkJCW5vZGUgPSBlbGVtOw0KCQkJCQkJCQl3aGlsZSAoIChub2RlID0gbm9kZVsgZGlyIF0pICkgew0KCQkJCQkJCQkJaWYgKCBvZlR5cGUgPyBub2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5hbWUgOiBub2RlLm5vZGVUeXBlID09PSAxICkgew0KCQkJCQkJCQkJCXJldHVybiBmYWxzZTsNCgkJCQkJCQkJCX0NCgkJCQkJCQkJfQ0KCQkJCQkJCQkvLyBSZXZlcnNlIGRpcmVjdGlvbiBmb3IgOm9ubHktKiAoaWYgd2UgaGF2ZW4ndCB5ZXQgZG9uZSBzbykNCgkJCQkJCQkJc3RhcnQgPSBkaXIgPSB0eXBlID09PSAib25seSIgJiYgIXN0YXJ0ICYmICJuZXh0U2libGluZyI7DQoJCQkJCQkJfQ0KCQkJCQkJCXJldHVybiB0cnVlOw0KCQkJCQkJfQ0KDQoJCQkJCQlzdGFydCA9IFsgZm9yd2FyZCA/IHBhcmVudC5maXJzdENoaWxkIDogcGFyZW50Lmxhc3RDaGlsZCBdOw0KDQoJCQkJCQkvLyBub24teG1sIDpudGgtY2hpbGQoLi4uKSBzdG9yZXMgY2FjaGUgZGF0YSBvbiBgcGFyZW50YA0KCQkJCQkJaWYgKCBmb3J3YXJkICYmIHVzZUNhY2hlICkgew0KCQkJCQkJCS8vIFNlZWsgYGVsZW1gIGZyb20gYSBwcmV2aW91c2x5LWNhY2hlZCBpbmRleA0KCQkJCQkJCW91dGVyQ2FjaGUgPSBwYXJlbnRbIGV4cGFuZG8gXSB8fCAocGFyZW50WyBleHBhbmRvIF0gPSB7fSk7DQoJCQkJCQkJY2FjaGUgPSBvdXRlckNhY2hlWyB0eXBlIF0gfHwgW107DQoJCQkJCQkJbm9kZUluZGV4ID0gY2FjaGVbMF0gPT09IGRpcnJ1bnMgJiYgY2FjaGVbMV07DQoJCQkJCQkJZGlmZiA9IGNhY2hlWzBdID09PSBkaXJydW5zICYmIGNhY2hlWzJdOw0KCQkJCQkJCW5vZGUgPSBub2RlSW5kZXggJiYgcGFyZW50LmNoaWxkTm9kZXNbIG5vZGVJbmRleCBdOw0KDQoJCQkJCQkJd2hpbGUgKCAobm9kZSA9ICsrbm9kZUluZGV4ICYmIG5vZGUgJiYgbm9kZVsgZGlyIF0gfHwNCg0KCQkJCQkJCQkvLyBGYWxsYmFjayB0byBzZWVraW5nIGBlbGVtYCBmcm9tIHRoZSBzdGFydA0KCQkJCQkJCQkoZGlmZiA9IG5vZGVJbmRleCA9IDApIHx8IHN0YXJ0LnBvcCgpKSApIHsNCg0KCQkJCQkJCQkvLyBXaGVuIGZvdW5kLCBjYWNoZSBpbmRleGVzIG9uIGBwYXJlbnRgIGFuZCBicmVhaw0KCQkJCQkJCQlpZiAoIG5vZGUubm9kZVR5cGUgPT09IDEgJiYgKytkaWZmICYmIG5vZGUgPT09IGVsZW0gKSB7DQoJCQkJCQkJCQlvdXRlckNhY2hlWyB0eXBlIF0gPSBbIGRpcnJ1bnMsIG5vZGVJbmRleCwgZGlmZiBdOw0KCQkJCQkJCQkJYnJlYWs7DQoJCQkJCQkJCX0NCgkJCQkJCQl9DQoNCgkJCQkJCS8vIFVzZSBwcmV2aW91c2x5LWNhY2hlZCBlbGVtZW50IGluZGV4IGlmIGF2YWlsYWJsZQ0KCQkJCQkJfSBlbHNlIGlmICggdXNlQ2FjaGUgJiYgKGNhY2hlID0gKGVsZW1bIGV4cGFuZG8gXSB8fCAoZWxlbVsgZXhwYW5kbyBdID0ge30pKVsgdHlwZSBdKSAmJiBjYWNoZVswXSA9PT0gZGlycnVucyApIHsNCgkJCQkJCQlkaWZmID0gY2FjaGVbMV07DQoNCgkJCQkJCS8vIHhtbCA6bnRoLWNoaWxkKC4uLikgb3IgOm50aC1sYXN0LWNoaWxkKC4uLikgb3IgOm50aCgtbGFzdCk/LW9mLXR5cGUoLi4uKQ0KCQkJCQkJfSBlbHNlIHsNCgkJCQkJCQkvLyBVc2UgdGhlIHNhbWUgbG9vcCBhcyBhYm92ZSB0byBzZWVrIGBlbGVtYCBmcm9tIHRoZSBzdGFydA0KCQkJCQkJCXdoaWxlICggKG5vZGUgPSArK25vZGVJbmRleCAmJiBub2RlICYmIG5vZGVbIGRpciBdIHx8DQoJCQkJCQkJCShkaWZmID0gbm9kZUluZGV4ID0gMCkgfHwgc3RhcnQucG9wKCkpICkgew0KDQoJCQkJCQkJCWlmICggKCBvZlR5cGUgPyBub2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5hbWUgOiBub2RlLm5vZGVUeXBlID09PSAxICkgJiYgKytkaWZmICkgew0KCQkJCQkJCQkJLy8gQ2FjaGUgdGhlIGluZGV4IG9mIGVhY2ggZW5jb3VudGVyZWQgZWxlbWVudA0KCQkJCQkJCQkJaWYgKCB1c2VDYWNoZSApIHsNCgkJCQkJCQkJCQkobm9kZVsgZXhwYW5kbyBdIHx8IChub2RlWyBleHBhbmRvIF0gPSB7fSkpWyB0eXBlIF0gPSBbIGRpcnJ1bnMsIGRpZmYgXTsNCgkJCQkJCQkJCX0NCg0KCQkJCQkJCQkJaWYgKCBub2RlID09PSBlbGVtICkgew0KCQkJCQkJCQkJCWJyZWFrOw0KCQkJCQkJCQkJfQ0KCQkJCQkJCQl9DQoJCQkJCQkJfQ0KCQkJCQkJfQ0KDQoJCQkJCQkvLyBJbmNvcnBvcmF0ZSB0aGUgb2Zmc2V0LCB0aGVuIGNoZWNrIGFnYWluc3QgY3ljbGUgc2l6ZQ0KCQkJCQkJZGlmZiAtPSBsYXN0Ow0KCQkJCQkJcmV0dXJuIGRpZmYgPT09IGZpcnN0IHx8ICggZGlmZiAlIGZpcnN0ID09PSAwICYmIGRpZmYgLyBmaXJzdCA+PSAwICk7DQoJCQkJCX0NCgkJCQl9Ow0KCQl9LA0KDQoJCSJQU0VVRE8iOiBmdW5jdGlvbiggcHNldWRvLCBhcmd1bWVudCApIHsNCgkJCS8vIHBzZXVkby1jbGFzcyBuYW1lcyBhcmUgY2FzZS1pbnNlbnNpdGl2ZQ0KCQkJLy8gaHR0cDovL3d3dy53My5vcmcvVFIvc2VsZWN0b3JzLyNwc2V1ZG8tY2xhc3Nlcw0KCQkJLy8gUHJpb3JpdGl6ZSBieSBjYXNlIHNlbnNpdGl2aXR5IGluIGNhc2UgY3VzdG9tIHBzZXVkb3MgYXJlIGFkZGVkIHdpdGggdXBwZXJjYXNlIGxldHRlcnMNCgkJCS8vIFJlbWVtYmVyIHRoYXQgc2V0RmlsdGVycyBpbmhlcml0cyBmcm9tIHBzZXVkb3MNCgkJCXZhciBhcmdzLA0KCQkJCWZuID0gRXhwci5wc2V1ZG9zWyBwc2V1ZG8gXSB8fCBFeHByLnNldEZpbHRlcnNbIHBzZXVkby50b0xvd2VyQ2FzZSgpIF0gfHwNCgkJCQkJU2l6emxlLmVycm9yKCAidW5zdXBwb3J0ZWQgcHNldWRvOiAiICsgcHNldWRvICk7DQoNCgkJCS8vIFRoZSB1c2VyIG1heSB1c2UgY3JlYXRlUHNldWRvIHRvIGluZGljYXRlIHRoYXQNCgkJCS8vIGFyZ3VtZW50cyBhcmUgbmVlZGVkIHRvIGNyZWF0ZSB0aGUgZmlsdGVyIGZ1bmN0aW9uDQoJCQkvLyBqdXN0IGFzIFNpenpsZSBkb2VzDQoJCQlpZiAoIGZuWyBleHBhbmRvIF0gKSB7DQoJCQkJcmV0dXJuIGZuKCBhcmd1bWVudCApOw0KCQkJfQ0KDQoJCQkvLyBCdXQgbWFpbnRhaW4gc3VwcG9ydCBmb3Igb2xkIHNpZ25hdHVyZXMNCgkJCWlmICggZm4ubGVuZ3RoID4gMSApIHsNCgkJCQlhcmdzID0gWyBwc2V1ZG8sIHBzZXVkbywgIiIsIGFyZ3VtZW50IF07DQoJCQkJcmV0dXJuIEV4cHIuc2V0RmlsdGVycy5oYXNPd25Qcm9wZXJ0eSggcHNldWRvLnRvTG93ZXJDYXNlKCkgKSA/DQoJCQkJCW1hcmtGdW5jdGlvbihmdW5jdGlvbiggc2VlZCwgbWF0Y2hlcyApIHsNCgkJCQkJCXZhciBpZHgsDQoJCQkJCQkJbWF0Y2hlZCA9IGZuKCBzZWVkLCBhcmd1bWVudCApLA0KCQkJCQkJCWkgPSBtYXRjaGVkLmxlbmd0aDsNCgkJCQkJCXdoaWxlICggaS0tICkgew0KCQkJCQkJCWlkeCA9IGluZGV4T2YuY2FsbCggc2VlZCwgbWF0Y2hlZFtpXSApOw0KCQkJCQkJCXNlZWRbIGlkeCBdID0gISggbWF0Y2hlc1sgaWR4IF0gPSBtYXRjaGVkW2ldICk7DQoJCQkJCQl9DQoJCQkJCX0pIDoNCgkJCQkJZnVuY3Rpb24oIGVsZW0gKSB7DQoJCQkJCQlyZXR1cm4gZm4oIGVsZW0sIDAsIGFyZ3MgKTsNCgkJCQkJfTsNCgkJCX0NCg0KCQkJcmV0dXJuIGZuOw0KCQl9DQoJfSwNCg0KCXBzZXVkb3M6IHsNCgkJLy8gUG90ZW50aWFsbHkgY29tcGxleCBwc2V1ZG9zDQoJCSJub3QiOiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHNlbGVjdG9yICkgew0KCQkJLy8gVHJpbSB0aGUgc2VsZWN0b3IgcGFzc2VkIHRvIGNvbXBpbGUNCgkJCS8vIHRvIGF2b2lkIHRyZWF0aW5nIGxlYWRpbmcgYW5kIHRyYWlsaW5nDQoJCQkvLyBzcGFjZXMgYXMgY29tYmluYXRvcnMNCgkJCXZhciBpbnB1dCA9IFtdLA0KCQkJCXJlc3VsdHMgPSBbXSwNCgkJCQltYXRjaGVyID0gY29tcGlsZSggc2VsZWN0b3IucmVwbGFjZSggcnRyaW0sICIkMSIgKSApOw0KDQoJCQlyZXR1cm4gbWF0Y2hlclsgZXhwYW5kbyBdID8NCgkJCQltYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHNlZWQsIG1hdGNoZXMsIGNvbnRleHQsIHhtbCApIHsNCgkJCQkJdmFyIGVsZW0sDQoJCQkJCQl1bm1hdGNoZWQgPSBtYXRjaGVyKCBzZWVkLCBudWxsLCB4bWwsIFtdICksDQoJCQkJCQlpID0gc2VlZC5sZW5ndGg7DQoNCgkJCQkJLy8gTWF0Y2ggZWxlbWVudHMgdW5tYXRjaGVkIGJ5IGBtYXRjaGVyYA0KCQkJCQl3aGlsZSAoIGktLSApIHsNCgkJCQkJCWlmICggKGVsZW0gPSB1bm1hdGNoZWRbaV0pICkgew0KCQkJCQkJCXNlZWRbaV0gPSAhKG1hdGNoZXNbaV0gPSBlbGVtKTsNCgkJCQkJCX0NCgkJCQkJfQ0KCQkJCX0pIDoNCgkJCQlmdW5jdGlvbiggZWxlbSwgY29udGV4dCwgeG1sICkgew0KCQkJCQlpbnB1dFswXSA9IGVsZW07DQoJCQkJCW1hdGNoZXIoIGlucHV0LCBudWxsLCB4bWwsIHJlc3VsdHMgKTsNCgkJCQkJcmV0dXJuICFyZXN1bHRzLnBvcCgpOw0KCQkJCX07DQoJCX0pLA0KDQoJCSJoYXMiOiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHNlbGVjdG9yICkgew0KCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgew0KCQkJCXJldHVybiBTaXp6bGUoIHNlbGVjdG9yLCBlbGVtICkubGVuZ3RoID4gMDsNCgkJCX07DQoJCX0pLA0KDQoJCSJjb250YWlucyI6IG1hcmtGdW5jdGlvbihmdW5jdGlvbiggdGV4dCApIHsNCgkJCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsNCgkJCQlyZXR1cm4gKCBlbGVtLnRleHRDb250ZW50IHx8IGVsZW0uaW5uZXJUZXh0IHx8IGdldFRleHQoIGVsZW0gKSApLmluZGV4T2YoIHRleHQgKSA+IC0xOw0KCQkJfTsNCgkJfSksDQoNCgkJLy8gIldoZXRoZXIgYW4gZWxlbWVudCBpcyByZXByZXNlbnRlZCBieSBhIDpsYW5nKCkgc2VsZWN0b3INCgkJLy8gaXMgYmFzZWQgc29sZWx5IG9uIHRoZSBlbGVtZW50J3MgbGFuZ3VhZ2UgdmFsdWUNCgkJLy8gYmVpbmcgZXF1YWwgdG8gdGhlIGlkZW50aWZpZXIgQywNCgkJLy8gb3IgYmVnaW5uaW5nIHdpdGggdGhlIGlkZW50aWZpZXIgQyBpbW1lZGlhdGVseSBmb2xsb3dlZCBieSAiLSIuDQoJCS8vIFRoZSBtYXRjaGluZyBvZiBDIGFnYWluc3QgdGhlIGVsZW1lbnQncyBsYW5ndWFnZSB2YWx1ZSBpcyBwZXJmb3JtZWQgY2FzZS1pbnNlbnNpdGl2ZWx5Lg0KCQkvLyBUaGUgaWRlbnRpZmllciBDIGRvZXMgbm90IGhhdmUgdG8gYmUgYSB2YWxpZCBsYW5ndWFnZSBuYW1lLiINCgkJLy8gaHR0cDovL3d3dy53My5vcmcvVFIvc2VsZWN0b3JzLyNsYW5nLXBzZXVkbw0KCQkibGFuZyI6IG1hcmtGdW5jdGlvbiggZnVuY3Rpb24oIGxhbmcgKSB7DQoJCQkvLyBsYW5nIHZhbHVlIG11c3QgYmUgYSB2YWxpZCBpZGVudGlmaWVyDQoJCQlpZiAoICFyaWRlbnRpZmllci50ZXN0KGxhbmcgfHwgIiIpICkgew0KCQkJCVNpenpsZS5lcnJvciggInVuc3VwcG9ydGVkIGxhbmc6ICIgKyBsYW5nICk7DQoJCQl9DQoJCQlsYW5nID0gbGFuZy5yZXBsYWNlKCBydW5lc2NhcGUsIGZ1bmVzY2FwZSApLnRvTG93ZXJDYXNlKCk7DQoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7DQoJCQkJdmFyIGVsZW1MYW5nOw0KCQkJCWRvIHsNCgkJCQkJaWYgKCAoZWxlbUxhbmcgPSBkb2N1bWVudElzSFRNTCA/DQoJCQkJCQllbGVtLmxhbmcgOg0KCQkJCQkJZWxlbS5nZXRBdHRyaWJ1dGUoInhtbDpsYW5nIikgfHwgZWxlbS5nZXRBdHRyaWJ1dGUoImxhbmciKSkgKSB7DQoNCgkJCQkJCWVsZW1MYW5nID0gZWxlbUxhbmcudG9Mb3dlckNhc2UoKTsNCgkJCQkJCXJldHVybiBlbGVtTGFuZyA9PT0gbGFuZyB8fCBlbGVtTGFuZy5pbmRleE9mKCBsYW5nICsgIi0iICkgPT09IDA7DQoJCQkJCX0NCgkJCQl9IHdoaWxlICggKGVsZW0gPSBlbGVtLnBhcmVudE5vZGUpICYmIGVsZW0ubm9kZVR5cGUgPT09IDEgKTsNCgkJCQlyZXR1cm4gZmFsc2U7DQoJCQl9Ow0KCQl9KSwNCg0KCQkvLyBNaXNjZWxsYW5lb3VzDQoJCSJ0YXJnZXQiOiBmdW5jdGlvbiggZWxlbSApIHsNCgkJCXZhciBoYXNoID0gd2luZG93LmxvY2F0aW9uICYmIHdpbmRvdy5sb2NhdGlvbi5oYXNoOw0KCQkJcmV0dXJuIGhhc2ggJiYgaGFzaC5zbGljZSggMSApID09PSBlbGVtLmlkOw0KCQl9LA0KDQoJCSJyb290IjogZnVuY3Rpb24oIGVsZW0gKSB7DQoJCQlyZXR1cm4gZWxlbSA9PT0gZG9jRWxlbTsNCgkJfSwNCg0KCQkiZm9jdXMiOiBmdW5jdGlvbiggZWxlbSApIHsNCgkJCXJldHVybiBlbGVtID09PSBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICYmICghZG9jdW1lbnQuaGFzRm9jdXMgfHwgZG9jdW1lbnQuaGFzRm9jdXMoKSkgJiYgISEoZWxlbS50eXBlIHx8IGVsZW0uaHJlZiB8fCB+ZWxlbS50YWJJbmRleCk7DQoJCX0sDQoNCgkJLy8gQm9vbGVhbiBwcm9wZXJ0aWVzDQoJCSJlbmFibGVkIjogZnVuY3Rpb24oIGVsZW0gKSB7DQoJCQlyZXR1cm4gZWxlbS5kaXNhYmxlZCA9PT0gZmFsc2U7DQoJCX0sDQoNCgkJImRpc2FibGVkIjogZnVuY3Rpb24oIGVsZW0gKSB7DQoJCQlyZXR1cm4gZWxlbS5kaXNhYmxlZCA9PT0gdHJ1ZTsNCgkJfSwNCg0KCQkiY2hlY2tlZCI6IGZ1bmN0aW9uKCBlbGVtICkgew0KCQkJLy8gSW4gQ1NTMywgOmNoZWNrZWQgc2hvdWxkIHJldHVybiBib3RoIGNoZWNrZWQgYW5kIHNlbGVjdGVkIGVsZW1lbnRzDQoJCQkvLyBodHRwOi8vd3d3LnczLm9yZy9UUi8yMDExL1JFQy1jc3MzLXNlbGVjdG9ycy0yMDExMDkyOS8jY2hlY2tlZA0KCQkJdmFyIG5vZGVOYW1lID0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOw0KCQkJcmV0dXJuIChub2RlTmFtZSA9PT0gImlucHV0IiAmJiAhIWVsZW0uY2hlY2tlZCkgfHwgKG5vZGVOYW1lID09PSAib3B0aW9uIiAmJiAhIWVsZW0uc2VsZWN0ZWQpOw0KCQl9LA0KDQoJCSJzZWxlY3RlZCI6IGZ1bmN0aW9uKCBlbGVtICkgew0KCQkJLy8gQWNjZXNzaW5nIHRoaXMgcHJvcGVydHkgbWFrZXMgc2VsZWN0ZWQtYnktZGVmYXVsdA0KCQkJLy8gb3B0aW9ucyBpbiBTYWZhcmkgd29yayBwcm9wZXJseQ0KCQkJaWYgKCBlbGVtLnBhcmVudE5vZGUgKSB7DQoJCQkJZWxlbS5wYXJlbnROb2RlLnNlbGVjdGVkSW5kZXg7DQoJCQl9DQoNCgkJCXJldHVybiBlbGVtLnNlbGVjdGVkID09PSB0cnVlOw0KCQl9LA0KDQoJCS8vIENvbnRlbnRzDQoJCSJlbXB0eSI6IGZ1bmN0aW9uKCBlbGVtICkgew0KCQkJLy8gaHR0cDovL3d3dy53My5vcmcvVFIvc2VsZWN0b3JzLyNlbXB0eS1wc2V1ZG8NCgkJCS8vIDplbXB0eSBpcyBvbmx5IGFmZmVjdGVkIGJ5IGVsZW1lbnQgbm9kZXMgYW5kIGNvbnRlbnQgbm9kZXMoaW5jbHVkaW5nIHRleHQoMyksIGNkYXRhKDQpKSwNCgkJCS8vICAgbm90IGNvbW1lbnQsIHByb2Nlc3NpbmcgaW5zdHJ1Y3Rpb25zLCBvciBvdGhlcnMNCgkJCS8vIFRoYW5rcyB0byBEaWVnbyBQZXJpbmkgZm9yIHRoZSBub2RlTmFtZSBzaG9ydGN1dA0KCQkJLy8gICBHcmVhdGVyIHRoYW4gIkAiIG1lYW5zIGFscGhhIGNoYXJhY3RlcnMgKHNwZWNpZmljYWxseSBub3Qgc3RhcnRpbmcgd2l0aCAiIyIgb3IgIj8iKQ0KCQkJZm9yICggZWxlbSA9IGVsZW0uZmlyc3RDaGlsZDsgZWxlbTsgZWxlbSA9IGVsZW0ubmV4dFNpYmxpbmcgKSB7DQoJCQkJaWYgKCBlbGVtLm5vZGVOYW1lID4gIkAiIHx8IGVsZW0ubm9kZVR5cGUgPT09IDMgfHwgZWxlbS5ub2RlVHlwZSA9PT0gNCApIHsNCgkJCQkJcmV0dXJuIGZhbHNlOw0KCQkJCX0NCgkJCX0NCgkJCXJldHVybiB0cnVlOw0KCQl9LA0KDQoJCSJwYXJlbnQiOiBmdW5jdGlvbiggZWxlbSApIHsNCgkJCXJldHVybiAhRXhwci5wc2V1ZG9zWyJlbXB0eSJdKCBlbGVtICk7DQoJCX0sDQoNCgkJLy8gRWxlbWVudC9pbnB1dCB0eXBlcw0KCQkiaGVhZGVyIjogZnVuY3Rpb24oIGVsZW0gKSB7DQoJCQlyZXR1cm4gcmhlYWRlci50ZXN0KCBlbGVtLm5vZGVOYW1lICk7DQoJCX0sDQoNCgkJImlucHV0IjogZnVuY3Rpb24oIGVsZW0gKSB7DQoJCQlyZXR1cm4gcmlucHV0cy50ZXN0KCBlbGVtLm5vZGVOYW1lICk7DQoJCX0sDQoNCgkJImJ1dHRvbiI6IGZ1bmN0aW9uKCBlbGVtICkgew0KCQkJdmFyIG5hbWUgPSBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7DQoJCQlyZXR1cm4gbmFtZSA9PT0gImlucHV0IiAmJiBlbGVtLnR5cGUgPT09ICJidXR0b24iIHx8IG5hbWUgPT09ICJidXR0b24iOw0KCQl9LA0KDQoJCSJ0ZXh0IjogZnVuY3Rpb24oIGVsZW0gKSB7DQoJCQl2YXIgYXR0cjsNCgkJCS8vIElFNiBhbmQgNyB3aWxsIG1hcCBlbGVtLnR5cGUgdG8gJ3RleHQnIGZvciBuZXcgSFRNTDUgdHlwZXMgKHNlYXJjaCwgZXRjKQ0KCQkJLy8gdXNlIGdldEF0dHJpYnV0ZSBpbnN0ZWFkIHRvIHRlc3QgdGhpcyBjYXNlDQoJCQlyZXR1cm4gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiaW5wdXQiICYmDQoJCQkJZWxlbS50eXBlID09PSAidGV4dCIgJiYNCgkJCQkoIChhdHRyID0gZWxlbS5nZXRBdHRyaWJ1dGUoInR5cGUiKSkgPT0gbnVsbCB8fCBhdHRyLnRvTG93ZXJDYXNlKCkgPT09IGVsZW0udHlwZSApOw0KCQl9LA0KDQoJCS8vIFBvc2l0aW9uLWluLWNvbGxlY3Rpb24NCgkJImZpcnN0IjogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbigpIHsNCgkJCXJldHVybiBbIDAgXTsNCgkJfSksDQoNCgkJImxhc3QiOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uKCBtYXRjaEluZGV4ZXMsIGxlbmd0aCApIHsNCgkJCXJldHVybiBbIGxlbmd0aCAtIDEgXTsNCgkJfSksDQoNCgkJImVxIjogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiggbWF0Y2hJbmRleGVzLCBsZW5ndGgsIGFyZ3VtZW50ICkgew0KCQkJcmV0dXJuIFsgYXJndW1lbnQgPCAwID8gYXJndW1lbnQgKyBsZW5ndGggOiBhcmd1bWVudCBdOw0KCQl9KSwNCg0KCQkiZXZlbiI6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24oIG1hdGNoSW5kZXhlcywgbGVuZ3RoICkgew0KCQkJdmFyIGkgPSAwOw0KCQkJZm9yICggOyBpIDwgbGVuZ3RoOyBpICs9IDIgKSB7DQoJCQkJbWF0Y2hJbmRleGVzLnB1c2goIGkgKTsNCgkJCX0NCgkJCXJldHVybiBtYXRjaEluZGV4ZXM7DQoJCX0pLA0KDQoJCSJvZGQiOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uKCBtYXRjaEluZGV4ZXMsIGxlbmd0aCApIHsNCgkJCXZhciBpID0gMTsNCgkJCWZvciAoIDsgaSA8IGxlbmd0aDsgaSArPSAyICkgew0KCQkJCW1hdGNoSW5kZXhlcy5wdXNoKCBpICk7DQoJCQl9DQoJCQlyZXR1cm4gbWF0Y2hJbmRleGVzOw0KCQl9KSwNCg0KCQkibHQiOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uKCBtYXRjaEluZGV4ZXMsIGxlbmd0aCwgYXJndW1lbnQgKSB7DQoJCQl2YXIgaSA9IGFyZ3VtZW50IDwgMCA/IGFyZ3VtZW50ICsgbGVuZ3RoIDogYXJndW1lbnQ7DQoJCQlmb3IgKCA7IC0taSA+PSAwOyApIHsNCgkJCQltYXRjaEluZGV4ZXMucHVzaCggaSApOw0KCQkJfQ0KCQkJcmV0dXJuIG1hdGNoSW5kZXhlczsNCgkJfSksDQoNCgkJImd0IjogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiggbWF0Y2hJbmRleGVzLCBsZW5ndGgsIGFyZ3VtZW50ICkgew0KCQkJdmFyIGkgPSBhcmd1bWVudCA8IDAgPyBhcmd1bWVudCArIGxlbmd0aCA6IGFyZ3VtZW50Ow0KCQkJZm9yICggOyArK2kgPCBsZW5ndGg7ICkgew0KCQkJCW1hdGNoSW5kZXhlcy5wdXNoKCBpICk7DQoJCQl9DQoJCQlyZXR1cm4gbWF0Y2hJbmRleGVzOw0KCQl9KQ0KCX0NCn07DQoNCkV4cHIucHNldWRvc1sibnRoIl0gPSBFeHByLnBzZXVkb3NbImVxIl07DQoNCi8vIEFkZCBidXR0b24vaW5wdXQgdHlwZSBwc2V1ZG9zDQpmb3IgKCBpIGluIHsgcmFkaW86IHRydWUsIGNoZWNrYm94OiB0cnVlLCBmaWxlOiB0cnVlLCBwYXNzd29yZDogdHJ1ZSwgaW1hZ2U6IHRydWUgfSApIHsNCglFeHByLnBzZXVkb3NbIGkgXSA9IGNyZWF0ZUlucHV0UHNldWRvKCBpICk7DQp9DQpmb3IgKCBpIGluIHsgc3VibWl0OiB0cnVlLCByZXNldDogdHJ1ZSB9ICkgew0KCUV4cHIucHNldWRvc1sgaSBdID0gY3JlYXRlQnV0dG9uUHNldWRvKCBpICk7DQp9DQoNCi8vIEVhc3kgQVBJIGZvciBjcmVhdGluZyBuZXcgc2V0RmlsdGVycw0KZnVuY3Rpb24gc2V0RmlsdGVycygpIHt9DQpzZXRGaWx0ZXJzLnByb3RvdHlwZSA9IEV4cHIuZmlsdGVycyA9IEV4cHIucHNldWRvczsNCkV4cHIuc2V0RmlsdGVycyA9IG5ldyBzZXRGaWx0ZXJzKCk7DQoNCmZ1bmN0aW9uIHRva2VuaXplKCBzZWxlY3RvciwgcGFyc2VPbmx5ICkgew0KCXZhciBtYXRjaGVkLCBtYXRjaCwgdG9rZW5zLCB0eXBlLA0KCQlzb0ZhciwgZ3JvdXBzLCBwcmVGaWx0ZXJzLA0KCQljYWNoZWQgPSB0b2tlbkNhY2hlWyBzZWxlY3RvciArICIgIiBdOw0KDQoJaWYgKCBjYWNoZWQgKSB7DQoJCXJldHVybiBwYXJzZU9ubHkgPyAwIDogY2FjaGVkLnNsaWNlKCAwICk7DQoJfQ0KDQoJc29GYXIgPSBzZWxlY3RvcjsNCglncm91cHMgPSBbXTsNCglwcmVGaWx0ZXJzID0gRXhwci5wcmVGaWx0ZXI7DQoNCgl3aGlsZSAoIHNvRmFyICkgew0KDQoJCS8vIENvbW1hIGFuZCBmaXJzdCBydW4NCgkJaWYgKCAhbWF0Y2hlZCB8fCAobWF0Y2ggPSByY29tbWEuZXhlYyggc29GYXIgKSkgKSB7DQoJCQlpZiAoIG1hdGNoICkgew0KCQkJCS8vIERvbid0IGNvbnN1bWUgdHJhaWxpbmcgY29tbWFzIGFzIHZhbGlkDQoJCQkJc29GYXIgPSBzb0Zhci5zbGljZSggbWF0Y2hbMF0ubGVuZ3RoICkgfHwgc29GYXI7DQoJCQl9DQoJCQlncm91cHMucHVzaCggdG9rZW5zID0gW10gKTsNCgkJfQ0KDQoJCW1hdGNoZWQgPSBmYWxzZTsNCg0KCQkvLyBDb21iaW5hdG9ycw0KCQlpZiAoIChtYXRjaCA9IHJjb21iaW5hdG9ycy5leGVjKCBzb0ZhciApKSApIHsNCgkJCW1hdGNoZWQgPSBtYXRjaC5zaGlmdCgpOw0KCQkJdG9rZW5zLnB1c2goew0KCQkJCXZhbHVlOiBtYXRjaGVkLA0KCQkJCS8vIENhc3QgZGVzY2VuZGFudCBjb21iaW5hdG9ycyB0byBzcGFjZQ0KCQkJCXR5cGU6IG1hdGNoWzBdLnJlcGxhY2UoIHJ0cmltLCAiICIgKQ0KCQkJfSk7DQoJCQlzb0ZhciA9IHNvRmFyLnNsaWNlKCBtYXRjaGVkLmxlbmd0aCApOw0KCQl9DQoNCgkJLy8gRmlsdGVycw0KCQlmb3IgKCB0eXBlIGluIEV4cHIuZmlsdGVyICkgew0KCQkJaWYgKCAobWF0Y2ggPSBtYXRjaEV4cHJbIHR5cGUgXS5leGVjKCBzb0ZhciApKSAmJiAoIXByZUZpbHRlcnNbIHR5cGUgXSB8fA0KCQkJCShtYXRjaCA9IHByZUZpbHRlcnNbIHR5cGUgXSggbWF0Y2ggKSkpICkgew0KCQkJCW1hdGNoZWQgPSBtYXRjaC5zaGlmdCgpOw0KCQkJCXRva2Vucy5wdXNoKHsNCgkJCQkJdmFsdWU6IG1hdGNoZWQsDQoJCQkJCXR5cGU6IHR5cGUsDQoJCQkJCW1hdGNoZXM6IG1hdGNoDQoJCQkJfSk7DQoJCQkJc29GYXIgPSBzb0Zhci5zbGljZSggbWF0Y2hlZC5sZW5ndGggKTsNCgkJCX0NCgkJfQ0KDQoJCWlmICggIW1hdGNoZWQgKSB7DQoJCQlicmVhazsNCgkJfQ0KCX0NCg0KCS8vIFJldHVybiB0aGUgbGVuZ3RoIG9mIHRoZSBpbnZhbGlkIGV4Y2Vzcw0KCS8vIGlmIHdlJ3JlIGp1c3QgcGFyc2luZw0KCS8vIE90aGVyd2lzZSwgdGhyb3cgYW4gZXJyb3Igb3IgcmV0dXJuIHRva2Vucw0KCXJldHVybiBwYXJzZU9ubHkgPw0KCQlzb0Zhci5sZW5ndGggOg0KCQlzb0ZhciA/DQoJCQlTaXp6bGUuZXJyb3IoIHNlbGVjdG9yICkgOg0KCQkJLy8gQ2FjaGUgdGhlIHRva2Vucw0KCQkJdG9rZW5DYWNoZSggc2VsZWN0b3IsIGdyb3VwcyApLnNsaWNlKCAwICk7DQp9DQoNCmZ1bmN0aW9uIHRvU2VsZWN0b3IoIHRva2VucyApIHsNCgl2YXIgaSA9IDAsDQoJCWxlbiA9IHRva2Vucy5sZW5ndGgsDQoJCXNlbGVjdG9yID0gIiI7DQoJZm9yICggOyBpIDwgbGVuOyBpKysgKSB7DQoJCXNlbGVjdG9yICs9IHRva2Vuc1tpXS52YWx1ZTsNCgl9DQoJcmV0dXJuIHNlbGVjdG9yOw0KfQ0KDQpmdW5jdGlvbiBhZGRDb21iaW5hdG9yKCBtYXRjaGVyLCBjb21iaW5hdG9yLCBiYXNlICkgew0KCXZhciBkaXIgPSBjb21iaW5hdG9yLmRpciwNCgkJY2hlY2tOb25FbGVtZW50cyA9IGJhc2UgJiYgZGlyID09PSAicGFyZW50Tm9kZSIsDQoJCWRvbmVOYW1lID0gZG9uZSsrOw0KDQoJcmV0dXJuIGNvbWJpbmF0b3IuZmlyc3QgPw0KCQkvLyBDaGVjayBhZ2FpbnN0IGNsb3Nlc3QgYW5jZXN0b3IvcHJlY2VkaW5nIGVsZW1lbnQNCgkJZnVuY3Rpb24oIGVsZW0sIGNvbnRleHQsIHhtbCApIHsNCgkJCXdoaWxlICggKGVsZW0gPSBlbGVtWyBkaXIgXSkgKSB7DQoJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxIHx8IGNoZWNrTm9uRWxlbWVudHMgKSB7DQoJCQkJCXJldHVybiBtYXRjaGVyKCBlbGVtLCBjb250ZXh0LCB4bWwgKTsNCgkJCQl9DQoJCQl9DQoJCX0gOg0KDQoJCS8vIENoZWNrIGFnYWluc3QgYWxsIGFuY2VzdG9yL3ByZWNlZGluZyBlbGVtZW50cw0KCQlmdW5jdGlvbiggZWxlbSwgY29udGV4dCwgeG1sICkgew0KCQkJdmFyIGRhdGEsIGNhY2hlLCBvdXRlckNhY2hlLA0KCQkJCWRpcmtleSA9IGRpcnJ1bnMgKyAiICIgKyBkb25lTmFtZTsNCg0KCQkJLy8gV2UgY2FuJ3Qgc2V0IGFyYml0cmFyeSBkYXRhIG9uIFhNTCBub2Rlcywgc28gdGhleSBkb24ndCBiZW5lZml0IGZyb20gZGlyIGNhY2hpbmcNCgkJCWlmICggeG1sICkgew0KCQkJCXdoaWxlICggKGVsZW0gPSBlbGVtWyBkaXIgXSkgKSB7DQoJCQkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSB8fCBjaGVja05vbkVsZW1lbnRzICkgew0KCQkJCQkJaWYgKCBtYXRjaGVyKCBlbGVtLCBjb250ZXh0LCB4bWwgKSApIHsNCgkJCQkJCQlyZXR1cm4gdHJ1ZTsNCgkJCQkJCX0NCgkJCQkJfQ0KCQkJCX0NCgkJCX0gZWxzZSB7DQoJCQkJd2hpbGUgKCAoZWxlbSA9IGVsZW1bIGRpciBdKSApIHsNCgkJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxIHx8IGNoZWNrTm9uRWxlbWVudHMgKSB7DQoJCQkJCQlvdXRlckNhY2hlID0gZWxlbVsgZXhwYW5kbyBdIHx8IChlbGVtWyBleHBhbmRvIF0gPSB7fSk7DQoJCQkJCQlpZiAoIChjYWNoZSA9IG91dGVyQ2FjaGVbIGRpciBdKSAmJiBjYWNoZVswXSA9PT0gZGlya2V5ICkgew0KCQkJCQkJCWlmICggKGRhdGEgPSBjYWNoZVsxXSkgPT09IHRydWUgfHwgZGF0YSA9PT0gY2FjaGVkcnVucyApIHsNCgkJCQkJCQkJcmV0dXJuIGRhdGEgPT09IHRydWU7DQoJCQkJCQkJfQ0KCQkJCQkJfSBlbHNlIHsNCgkJCQkJCQljYWNoZSA9IG91dGVyQ2FjaGVbIGRpciBdID0gWyBkaXJrZXkgXTsNCgkJCQkJCQljYWNoZVsxXSA9IG1hdGNoZXIoIGVsZW0sIGNvbnRleHQsIHhtbCApIHx8IGNhY2hlZHJ1bnM7DQoJCQkJCQkJaWYgKCBjYWNoZVsxXSA9PT0gdHJ1ZSApIHsNCgkJCQkJCQkJcmV0dXJuIHRydWU7DQoJCQkJCQkJfQ0KCQkJCQkJfQ0KCQkJCQl9DQoJCQkJfQ0KCQkJfQ0KCQl9Ow0KfQ0KDQpmdW5jdGlvbiBlbGVtZW50TWF0Y2hlciggbWF0Y2hlcnMgKSB7DQoJcmV0dXJuIG1hdGNoZXJzLmxlbmd0aCA+IDEgPw0KCQlmdW5jdGlvbiggZWxlbSwgY29udGV4dCwgeG1sICkgew0KCQkJdmFyIGkgPSBtYXRjaGVycy5sZW5ndGg7DQoJCQl3aGlsZSAoIGktLSApIHsNCgkJCQlpZiAoICFtYXRjaGVyc1tpXSggZWxlbSwgY29udGV4dCwgeG1sICkgKSB7DQoJCQkJCXJldHVybiBmYWxzZTsNCgkJCQl9DQoJCQl9DQoJCQlyZXR1cm4gdHJ1ZTsNCgkJfSA6DQoJCW1hdGNoZXJzWzBdOw0KfQ0KDQpmdW5jdGlvbiBjb25kZW5zZSggdW5tYXRjaGVkLCBtYXAsIGZpbHRlciwgY29udGV4dCwgeG1sICkgew0KCXZhciBlbGVtLA0KCQluZXdVbm1hdGNoZWQgPSBbXSwNCgkJaSA9IDAsDQoJCWxlbiA9IHVubWF0Y2hlZC5sZW5ndGgsDQoJCW1hcHBlZCA9IG1hcCAhPSBudWxsOw0KDQoJZm9yICggOyBpIDwgbGVuOyBpKysgKSB7DQoJCWlmICggKGVsZW0gPSB1bm1hdGNoZWRbaV0pICkgew0KCQkJaWYgKCAhZmlsdGVyIHx8IGZpbHRlciggZWxlbSwgY29udGV4dCwgeG1sICkgKSB7DQoJCQkJbmV3VW5tYXRjaGVkLnB1c2goIGVsZW0gKTsNCgkJCQlpZiAoIG1hcHBlZCApIHsNCgkJCQkJbWFwLnB1c2goIGkgKTsNCgkJCQl9DQoJCQl9DQoJCX0NCgl9DQoNCglyZXR1cm4gbmV3VW5tYXRjaGVkOw0KfQ0KDQpmdW5jdGlvbiBzZXRNYXRjaGVyKCBwcmVGaWx0ZXIsIHNlbGVjdG9yLCBtYXRjaGVyLCBwb3N0RmlsdGVyLCBwb3N0RmluZGVyLCBwb3N0U2VsZWN0b3IgKSB7DQoJaWYgKCBwb3N0RmlsdGVyICYmICFwb3N0RmlsdGVyWyBleHBhbmRvIF0gKSB7DQoJCXBvc3RGaWx0ZXIgPSBzZXRNYXRjaGVyKCBwb3N0RmlsdGVyICk7DQoJfQ0KCWlmICggcG9zdEZpbmRlciAmJiAhcG9zdEZpbmRlclsgZXhwYW5kbyBdICkgew0KCQlwb3N0RmluZGVyID0gc2V0TWF0Y2hlciggcG9zdEZpbmRlciwgcG9zdFNlbGVjdG9yICk7DQoJfQ0KCXJldHVybiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHNlZWQsIHJlc3VsdHMsIGNvbnRleHQsIHhtbCApIHsNCgkJdmFyIHRlbXAsIGksIGVsZW0sDQoJCQlwcmVNYXAgPSBbXSwNCgkJCXBvc3RNYXAgPSBbXSwNCgkJCXByZWV4aXN0aW5nID0gcmVzdWx0cy5sZW5ndGgsDQoNCgkJCS8vIEdldCBpbml0aWFsIGVsZW1lbnRzIGZyb20gc2VlZCBvciBjb250ZXh0DQoJCQllbGVtcyA9IHNlZWQgfHwgbXVsdGlwbGVDb250ZXh0cyggc2VsZWN0b3IgfHwgIioiLCBjb250ZXh0Lm5vZGVUeXBlID8gWyBjb250ZXh0IF0gOiBjb250ZXh0LCBbXSApLA0KDQoJCQkvLyBQcmVmaWx0ZXIgdG8gZ2V0IG1hdGNoZXIgaW5wdXQsIHByZXNlcnZpbmcgYSBtYXAgZm9yIHNlZWQtcmVzdWx0cyBzeW5jaHJvbml6YXRpb24NCgkJCW1hdGNoZXJJbiA9IHByZUZpbHRlciAmJiAoIHNlZWQgfHwgIXNlbGVjdG9yICkgPw0KCQkJCWNvbmRlbnNlKCBlbGVtcywgcHJlTWFwLCBwcmVGaWx0ZXIsIGNvbnRleHQsIHhtbCApIDoNCgkJCQllbGVtcywNCg0KCQkJbWF0Y2hlck91dCA9IG1hdGNoZXIgPw0KCQkJCS8vIElmIHdlIGhhdmUgYSBwb3N0RmluZGVyLCBvciBmaWx0ZXJlZCBzZWVkLCBvciBub24tc2VlZCBwb3N0RmlsdGVyIG9yIHByZWV4aXN0aW5nIHJlc3VsdHMsDQoJCQkJcG9zdEZpbmRlciB8fCAoIHNlZWQgPyBwcmVGaWx0ZXIgOiBwcmVleGlzdGluZyB8fCBwb3N0RmlsdGVyICkgPw0KDQoJCQkJCS8vIC4uLmludGVybWVkaWF0ZSBwcm9jZXNzaW5nIGlzIG5lY2Vzc2FyeQ0KCQkJCQlbXSA6DQoNCgkJCQkJLy8gLi4ub3RoZXJ3aXNlIHVzZSByZXN1bHRzIGRpcmVjdGx5DQoJCQkJCXJlc3VsdHMgOg0KCQkJCW1hdGNoZXJJbjsNCg0KCQkvLyBGaW5kIHByaW1hcnkgbWF0Y2hlcw0KCQlpZiAoIG1hdGNoZXIgKSB7DQoJCQltYXRjaGVyKCBtYXRjaGVySW4sIG1hdGNoZXJPdXQsIGNvbnRleHQsIHhtbCApOw0KCQl9DQoNCgkJLy8gQXBwbHkgcG9zdEZpbHRlcg0KCQlpZiAoIHBvc3RGaWx0ZXIgKSB7DQoJCQl0ZW1wID0gY29uZGVuc2UoIG1hdGNoZXJPdXQsIHBvc3RNYXAgKTsNCgkJCXBvc3RGaWx0ZXIoIHRlbXAsIFtdLCBjb250ZXh0LCB4bWwgKTsNCg0KCQkJLy8gVW4tbWF0Y2ggZmFpbGluZyBlbGVtZW50cyBieSBtb3ZpbmcgdGhlbSBiYWNrIHRvIG1hdGNoZXJJbg0KCQkJaSA9IHRlbXAubGVuZ3RoOw0KCQkJd2hpbGUgKCBpLS0gKSB7DQoJCQkJaWYgKCAoZWxlbSA9IHRlbXBbaV0pICkgew0KCQkJCQltYXRjaGVyT3V0WyBwb3N0TWFwW2ldIF0gPSAhKG1hdGNoZXJJblsgcG9zdE1hcFtpXSBdID0gZWxlbSk7DQoJCQkJfQ0KCQkJfQ0KCQl9DQoNCgkJaWYgKCBzZWVkICkgew0KCQkJaWYgKCBwb3N0RmluZGVyIHx8IHByZUZpbHRlciApIHsNCgkJCQlpZiAoIHBvc3RGaW5kZXIgKSB7DQoJCQkJCS8vIEdldCB0aGUgZmluYWwgbWF0Y2hlck91dCBieSBjb25kZW5zaW5nIHRoaXMgaW50ZXJtZWRpYXRlIGludG8gcG9zdEZpbmRlciBjb250ZXh0cw0KCQkJCQl0ZW1wID0gW107DQoJCQkJCWkgPSBtYXRjaGVyT3V0Lmxlbmd0aDsNCgkJCQkJd2hpbGUgKCBpLS0gKSB7DQoJCQkJCQlpZiAoIChlbGVtID0gbWF0Y2hlck91dFtpXSkgKSB7DQoJCQkJCQkJLy8gUmVzdG9yZSBtYXRjaGVySW4gc2luY2UgZWxlbSBpcyBub3QgeWV0IGEgZmluYWwgbWF0Y2gNCgkJCQkJCQl0ZW1wLnB1c2goIChtYXRjaGVySW5baV0gPSBlbGVtKSApOw0KCQkJCQkJfQ0KCQkJCQl9DQoJCQkJCXBvc3RGaW5kZXIoIG51bGwsIChtYXRjaGVyT3V0ID0gW10pLCB0ZW1wLCB4bWwgKTsNCgkJCQl9DQoNCgkJCQkvLyBNb3ZlIG1hdGNoZWQgZWxlbWVudHMgZnJvbSBzZWVkIHRvIHJlc3VsdHMgdG8ga2VlcCB0aGVtIHN5bmNocm9uaXplZA0KCQkJCWkgPSBtYXRjaGVyT3V0Lmxlbmd0aDsNCgkJCQl3aGlsZSAoIGktLSApIHsNCgkJCQkJaWYgKCAoZWxlbSA9IG1hdGNoZXJPdXRbaV0pICYmDQoJCQkJCQkodGVtcCA9IHBvc3RGaW5kZXIgPyBpbmRleE9mLmNhbGwoIHNlZWQsIGVsZW0gKSA6IHByZU1hcFtpXSkgPiAtMSApIHsNCg0KCQkJCQkJc2VlZFt0ZW1wXSA9ICEocmVzdWx0c1t0ZW1wXSA9IGVsZW0pOw0KCQkJCQl9DQoJCQkJfQ0KCQkJfQ0KDQoJCS8vIEFkZCBlbGVtZW50cyB0byByZXN1bHRzLCB0aHJvdWdoIHBvc3RGaW5kZXIgaWYgZGVmaW5lZA0KCQl9IGVsc2Ugew0KCQkJbWF0Y2hlck91dCA9IGNvbmRlbnNlKA0KCQkJCW1hdGNoZXJPdXQgPT09IHJlc3VsdHMgPw0KCQkJCQltYXRjaGVyT3V0LnNwbGljZSggcHJlZXhpc3RpbmcsIG1hdGNoZXJPdXQubGVuZ3RoICkgOg0KCQkJCQltYXRjaGVyT3V0DQoJCQkpOw0KCQkJaWYgKCBwb3N0RmluZGVyICkgew0KCQkJCXBvc3RGaW5kZXIoIG51bGwsIHJlc3VsdHMsIG1hdGNoZXJPdXQsIHhtbCApOw0KCQkJfSBlbHNlIHsNCgkJCQlwdXNoLmFwcGx5KCByZXN1bHRzLCBtYXRjaGVyT3V0ICk7DQoJCQl9DQoJCX0NCgl9KTsNCn0NCg0KZnVuY3Rpb24gbWF0Y2hlckZyb21Ub2tlbnMoIHRva2VucyApIHsNCgl2YXIgY2hlY2tDb250ZXh0LCBtYXRjaGVyLCBqLA0KCQlsZW4gPSB0b2tlbnMubGVuZ3RoLA0KCQlsZWFkaW5nUmVsYXRpdmUgPSBFeHByLnJlbGF0aXZlWyB0b2tlbnNbMF0udHlwZSBdLA0KCQlpbXBsaWNpdFJlbGF0aXZlID0gbGVhZGluZ1JlbGF0aXZlIHx8IEV4cHIucmVsYXRpdmVbIiAiXSwNCgkJaSA9IGxlYWRpbmdSZWxhdGl2ZSA/IDEgOiAwLA0KDQoJCS8vIFRoZSBmb3VuZGF0aW9uYWwgbWF0Y2hlciBlbnN1cmVzIHRoYXQgZWxlbWVudHMgYXJlIHJlYWNoYWJsZSBmcm9tIHRvcC1sZXZlbCBjb250ZXh0KHMpDQoJCW1hdGNoQ29udGV4dCA9IGFkZENvbWJpbmF0b3IoIGZ1bmN0aW9uKCBlbGVtICkgew0KCQkJcmV0dXJuIGVsZW0gPT09IGNoZWNrQ29udGV4dDsNCgkJfSwgaW1wbGljaXRSZWxhdGl2ZSwgdHJ1ZSApLA0KCQltYXRjaEFueUNvbnRleHQgPSBhZGRDb21iaW5hdG9yKCBmdW5jdGlvbiggZWxlbSApIHsNCgkJCXJldHVybiBpbmRleE9mLmNhbGwoIGNoZWNrQ29udGV4dCwgZWxlbSApID4gLTE7DQoJCX0sIGltcGxpY2l0UmVsYXRpdmUsIHRydWUgKSwNCgkJbWF0Y2hlcnMgPSBbIGZ1bmN0aW9uKCBlbGVtLCBjb250ZXh0LCB4bWwgKSB7DQoJCQlyZXR1cm4gKCAhbGVhZGluZ1JlbGF0aXZlICYmICggeG1sIHx8IGNvbnRleHQgIT09IG91dGVybW9zdENvbnRleHQgKSApIHx8ICgNCgkJCQkoY2hlY2tDb250ZXh0ID0gY29udGV4dCkubm9kZVR5cGUgPw0KCQkJCQltYXRjaENvbnRleHQoIGVsZW0sIGNvbnRleHQsIHhtbCApIDoNCgkJCQkJbWF0Y2hBbnlDb250ZXh0KCBlbGVtLCBjb250ZXh0LCB4bWwgKSApOw0KCQl9IF07DQoNCglmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsNCgkJaWYgKCAobWF0Y2hlciA9IEV4cHIucmVsYXRpdmVbIHRva2Vuc1tpXS50eXBlIF0pICkgew0KCQkJbWF0Y2hlcnMgPSBbIGFkZENvbWJpbmF0b3IoZWxlbWVudE1hdGNoZXIoIG1hdGNoZXJzICksIG1hdGNoZXIpIF07DQoJCX0gZWxzZSB7DQoJCQltYXRjaGVyID0gRXhwci5maWx0ZXJbIHRva2Vuc1tpXS50eXBlIF0uYXBwbHkoIG51bGwsIHRva2Vuc1tpXS5tYXRjaGVzICk7DQoNCgkJCS8vIFJldHVybiBzcGVjaWFsIHVwb24gc2VlaW5nIGEgcG9zaXRpb25hbCBtYXRjaGVyDQoJCQlpZiAoIG1hdGNoZXJbIGV4cGFuZG8gXSApIHsNCgkJCQkvLyBGaW5kIHRoZSBuZXh0IHJlbGF0aXZlIG9wZXJhdG9yIChpZiBhbnkpIGZvciBwcm9wZXIgaGFuZGxpbmcNCgkJCQlqID0gKytpOw0KCQkJCWZvciAoIDsgaiA8IGxlbjsgaisrICkgew0KCQkJCQlpZiAoIEV4cHIucmVsYXRpdmVbIHRva2Vuc1tqXS50eXBlIF0gKSB7DQoJCQkJCQlicmVhazsNCgkJCQkJfQ0KCQkJCX0NCgkJCQlyZXR1cm4gc2V0TWF0Y2hlcigNCgkJCQkJaSA+IDEgJiYgZWxlbWVudE1hdGNoZXIoIG1hdGNoZXJzICksDQoJCQkJCWkgPiAxICYmIHRvU2VsZWN0b3IoDQoJCQkJCQkvLyBJZiB0aGUgcHJlY2VkaW5nIHRva2VuIHdhcyBhIGRlc2NlbmRhbnQgY29tYmluYXRvciwgaW5zZXJ0IGFuIGltcGxpY2l0IGFueS1lbGVtZW50IGAqYA0KCQkJCQkJdG9rZW5zLnNsaWNlKCAwLCBpIC0gMSApLmNvbmNhdCh7IHZhbHVlOiB0b2tlbnNbIGkgLSAyIF0udHlwZSA9PT0gIiAiID8gIioiIDogIiIgfSkNCgkJCQkJKS5yZXBsYWNlKCBydHJpbSwgIiQxIiApLA0KCQkJCQltYXRjaGVyLA0KCQkJCQlpIDwgaiAmJiBtYXRjaGVyRnJvbVRva2VucyggdG9rZW5zLnNsaWNlKCBpLCBqICkgKSwNCgkJCQkJaiA8IGxlbiAmJiBtYXRjaGVyRnJvbVRva2VucyggKHRva2VucyA9IHRva2Vucy5zbGljZSggaiApKSApLA0KCQkJCQlqIDwgbGVuICYmIHRvU2VsZWN0b3IoIHRva2VucyApDQoJCQkJKTsNCgkJCX0NCgkJCW1hdGNoZXJzLnB1c2goIG1hdGNoZXIgKTsNCgkJfQ0KCX0NCg0KCXJldHVybiBlbGVtZW50TWF0Y2hlciggbWF0Y2hlcnMgKTsNCn0NCg0KZnVuY3Rpb24gbWF0Y2hlckZyb21Hcm91cE1hdGNoZXJzKCBlbGVtZW50TWF0Y2hlcnMsIHNldE1hdGNoZXJzICkgew0KCS8vIEEgY291bnRlciB0byBzcGVjaWZ5IHdoaWNoIGVsZW1lbnQgaXMgY3VycmVudGx5IGJlaW5nIG1hdGNoZWQNCgl2YXIgbWF0Y2hlckNhY2hlZFJ1bnMgPSAwLA0KCQlieVNldCA9IHNldE1hdGNoZXJzLmxlbmd0aCA+IDAsDQoJCWJ5RWxlbWVudCA9IGVsZW1lbnRNYXRjaGVycy5sZW5ndGggPiAwLA0KCQlzdXBlck1hdGNoZXIgPSBmdW5jdGlvbiggc2VlZCwgY29udGV4dCwgeG1sLCByZXN1bHRzLCBleHBhbmRDb250ZXh0ICkgew0KCQkJdmFyIGVsZW0sIGosIG1hdGNoZXIsDQoJCQkJc2V0TWF0Y2hlZCA9IFtdLA0KCQkJCW1hdGNoZWRDb3VudCA9IDAsDQoJCQkJaSA9ICIwIiwNCgkJCQl1bm1hdGNoZWQgPSBzZWVkICYmIFtdLA0KCQkJCW91dGVybW9zdCA9IGV4cGFuZENvbnRleHQgIT0gbnVsbCwNCgkJCQljb250ZXh0QmFja3VwID0gb3V0ZXJtb3N0Q29udGV4dCwNCgkJCQkvLyBXZSBtdXN0IGFsd2F5cyBoYXZlIGVpdGhlciBzZWVkIGVsZW1lbnRzIG9yIGNvbnRleHQNCgkJCQllbGVtcyA9IHNlZWQgfHwgYnlFbGVtZW50ICYmIEV4cHIuZmluZFsiVEFHIl0oICIqIiwgZXhwYW5kQ29udGV4dCAmJiBjb250ZXh0LnBhcmVudE5vZGUgfHwgY29udGV4dCApLA0KCQkJCS8vIFVzZSBpbnRlZ2VyIGRpcnJ1bnMgaWZmIHRoaXMgaXMgdGhlIG91dGVybW9zdCBtYXRjaGVyDQoJCQkJZGlycnVuc1VuaXF1ZSA9IChkaXJydW5zICs9IGNvbnRleHRCYWNrdXAgPT0gbnVsbCA/IDEgOiBNYXRoLnJhbmRvbSgpIHx8IDAuMSk7DQoNCgkJCWlmICggb3V0ZXJtb3N0ICkgew0KCQkJCW91dGVybW9zdENvbnRleHQgPSBjb250ZXh0ICE9PSBkb2N1bWVudCAmJiBjb250ZXh0Ow0KCQkJCWNhY2hlZHJ1bnMgPSBtYXRjaGVyQ2FjaGVkUnVuczsNCgkJCX0NCg0KCQkJLy8gQWRkIGVsZW1lbnRzIHBhc3NpbmcgZWxlbWVudE1hdGNoZXJzIGRpcmVjdGx5IHRvIHJlc3VsdHMNCgkJCS8vIEtlZXAgYGlgIGEgc3RyaW5nIGlmIHRoZXJlIGFyZSBubyBlbGVtZW50cyBzbyBgbWF0Y2hlZENvdW50YCB3aWxsIGJlICIwMCIgYmVsb3cNCgkJCWZvciAoIDsgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrICkgew0KCQkJCWlmICggYnlFbGVtZW50ICYmIGVsZW0gKSB7DQoJCQkJCWogPSAwOw0KCQkJCQl3aGlsZSAoIChtYXRjaGVyID0gZWxlbWVudE1hdGNoZXJzW2orK10pICkgew0KCQkJCQkJaWYgKCBtYXRjaGVyKCBlbGVtLCBjb250ZXh0LCB4bWwgKSApIHsNCgkJCQkJCQlyZXN1bHRzLnB1c2goIGVsZW0gKTsNCgkJCQkJCQlicmVhazsNCgkJCQkJCX0NCgkJCQkJfQ0KCQkJCQlpZiAoIG91dGVybW9zdCApIHsNCgkJCQkJCWRpcnJ1bnMgPSBkaXJydW5zVW5pcXVlOw0KCQkJCQkJY2FjaGVkcnVucyA9ICsrbWF0Y2hlckNhY2hlZFJ1bnM7DQoJCQkJCX0NCgkJCQl9DQoNCgkJCQkvLyBUcmFjayB1bm1hdGNoZWQgZWxlbWVudHMgZm9yIHNldCBmaWx0ZXJzDQoJCQkJaWYgKCBieVNldCApIHsNCgkJCQkJLy8gVGhleSB3aWxsIGhhdmUgZ29uZSB0aHJvdWdoIGFsbCBwb3NzaWJsZSBtYXRjaGVycw0KCQkJCQlpZiAoIChlbGVtID0gIW1hdGNoZXIgJiYgZWxlbSkgKSB7DQoJCQkJCQltYXRjaGVkQ291bnQtLTsNCgkJCQkJfQ0KDQoJCQkJCS8vIExlbmd0aGVuIHRoZSBhcnJheSBmb3IgZXZlcnkgZWxlbWVudCwgbWF0Y2hlZCBvciBub3QNCgkJCQkJaWYgKCBzZWVkICkgew0KCQkJCQkJdW5tYXRjaGVkLnB1c2goIGVsZW0gKTsNCgkJCQkJfQ0KCQkJCX0NCgkJCX0NCg0KCQkJLy8gQXBwbHkgc2V0IGZpbHRlcnMgdG8gdW5tYXRjaGVkIGVsZW1lbnRzDQoJCQltYXRjaGVkQ291bnQgKz0gaTsNCgkJCWlmICggYnlTZXQgJiYgaSAhPT0gbWF0Y2hlZENvdW50ICkgew0KCQkJCWogPSAwOw0KCQkJCXdoaWxlICggKG1hdGNoZXIgPSBzZXRNYXRjaGVyc1tqKytdKSApIHsNCgkJCQkJbWF0Y2hlciggdW5tYXRjaGVkLCBzZXRNYXRjaGVkLCBjb250ZXh0LCB4bWwgKTsNCgkJCQl9DQoNCgkJCQlpZiAoIHNlZWQgKSB7DQoJCQkJCS8vIFJlaW50ZWdyYXRlIGVsZW1lbnQgbWF0Y2hlcyB0byBlbGltaW5hdGUgdGhlIG5lZWQgZm9yIHNvcnRpbmcNCgkJCQkJaWYgKCBtYXRjaGVkQ291bnQgPiAwICkgew0KCQkJCQkJd2hpbGUgKCBpLS0gKSB7DQoJCQkJCQkJaWYgKCAhKHVubWF0Y2hlZFtpXSB8fCBzZXRNYXRjaGVkW2ldKSApIHsNCgkJCQkJCQkJc2V0TWF0Y2hlZFtpXSA9IHBvcC5jYWxsKCByZXN1bHRzICk7DQoJCQkJCQkJfQ0KCQkJCQkJfQ0KCQkJCQl9DQoNCgkJCQkJLy8gRGlzY2FyZCBpbmRleCBwbGFjZWhvbGRlciB2YWx1ZXMgdG8gZ2V0IG9ubHkgYWN0dWFsIG1hdGNoZXMNCgkJCQkJc2V0TWF0Y2hlZCA9IGNvbmRlbnNlKCBzZXRNYXRjaGVkICk7DQoJCQkJfQ0KDQoJCQkJLy8gQWRkIG1hdGNoZXMgdG8gcmVzdWx0cw0KCQkJCXB1c2guYXBwbHkoIHJlc3VsdHMsIHNldE1hdGNoZWQgKTsNCg0KCQkJCS8vIFNlZWRsZXNzIHNldCBtYXRjaGVzIHN1Y2NlZWRpbmcgbXVsdGlwbGUgc3VjY2Vzc2Z1bCBtYXRjaGVycyBzdGlwdWxhdGUgc29ydGluZw0KCQkJCWlmICggb3V0ZXJtb3N0ICYmICFzZWVkICYmIHNldE1hdGNoZWQubGVuZ3RoID4gMCAmJg0KCQkJCQkoIG1hdGNoZWRDb3VudCArIHNldE1hdGNoZXJzLmxlbmd0aCApID4gMSApIHsNCg0KCQkJCQlTaXp6bGUudW5pcXVlU29ydCggcmVzdWx0cyApOw0KCQkJCX0NCgkJCX0NCg0KCQkJLy8gT3ZlcnJpZGUgbWFuaXB1bGF0aW9uIG9mIGdsb2JhbHMgYnkgbmVzdGVkIG1hdGNoZXJzDQoJCQlpZiAoIG91dGVybW9zdCApIHsNCgkJCQlkaXJydW5zID0gZGlycnVuc1VuaXF1ZTsNCgkJCQlvdXRlcm1vc3RDb250ZXh0ID0gY29udGV4dEJhY2t1cDsNCgkJCX0NCg0KCQkJcmV0dXJuIHVubWF0Y2hlZDsNCgkJfTsNCg0KCXJldHVybiBieVNldCA/DQoJCW1hcmtGdW5jdGlvbiggc3VwZXJNYXRjaGVyICkgOg0KCQlzdXBlck1hdGNoZXI7DQp9DQoNCmNvbXBpbGUgPSBTaXp6bGUuY29tcGlsZSA9IGZ1bmN0aW9uKCBzZWxlY3RvciwgZ3JvdXAgLyogSW50ZXJuYWwgVXNlIE9ubHkgKi8gKSB7DQoJdmFyIGksDQoJCXNldE1hdGNoZXJzID0gW10sDQoJCWVsZW1lbnRNYXRjaGVycyA9IFtdLA0KCQljYWNoZWQgPSBjb21waWxlckNhY2hlWyBzZWxlY3RvciArICIgIiBdOw0KDQoJaWYgKCAhY2FjaGVkICkgew0KCQkvLyBHZW5lcmF0ZSBhIGZ1bmN0aW9uIG9mIHJlY3Vyc2l2ZSBmdW5jdGlvbnMgdGhhdCBjYW4gYmUgdXNlZCB0byBjaGVjayBlYWNoIGVsZW1lbnQNCgkJaWYgKCAhZ3JvdXAgKSB7DQoJCQlncm91cCA9IHRva2VuaXplKCBzZWxlY3RvciApOw0KCQl9DQoJCWkgPSBncm91cC5sZW5ndGg7DQoJCXdoaWxlICggaS0tICkgew0KCQkJY2FjaGVkID0gbWF0Y2hlckZyb21Ub2tlbnMoIGdyb3VwW2ldICk7DQoJCQlpZiAoIGNhY2hlZFsgZXhwYW5kbyBdICkgew0KCQkJCXNldE1hdGNoZXJzLnB1c2goIGNhY2hlZCApOw0KCQkJfSBlbHNlIHsNCgkJCQllbGVtZW50TWF0Y2hlcnMucHVzaCggY2FjaGVkICk7DQoJCQl9DQoJCX0NCg0KCQkvLyBDYWNoZSB0aGUgY29tcGlsZWQgZnVuY3Rpb24NCgkJY2FjaGVkID0gY29tcGlsZXJDYWNoZSggc2VsZWN0b3IsIG1hdGNoZXJGcm9tR3JvdXBNYXRjaGVycyggZWxlbWVudE1hdGNoZXJzLCBzZXRNYXRjaGVycyApICk7DQoJfQ0KCXJldHVybiBjYWNoZWQ7DQp9Ow0KDQpmdW5jdGlvbiBtdWx0aXBsZUNvbnRleHRzKCBzZWxlY3RvciwgY29udGV4dHMsIHJlc3VsdHMgKSB7DQoJdmFyIGkgPSAwLA0KCQlsZW4gPSBjb250ZXh0cy5sZW5ndGg7DQoJZm9yICggOyBpIDwgbGVuOyBpKysgKSB7DQoJCVNpenpsZSggc2VsZWN0b3IsIGNvbnRleHRzW2ldLCByZXN1bHRzICk7DQoJfQ0KCXJldHVybiByZXN1bHRzOw0KfQ0KDQpmdW5jdGlvbiBzZWxlY3QoIHNlbGVjdG9yLCBjb250ZXh0LCByZXN1bHRzLCBzZWVkICkgew0KCXZhciBpLCB0b2tlbnMsIHRva2VuLCB0eXBlLCBmaW5kLA0KCQltYXRjaCA9IHRva2VuaXplKCBzZWxlY3RvciApOw0KDQoJaWYgKCAhc2VlZCApIHsNCgkJLy8gVHJ5IHRvIG1pbmltaXplIG9wZXJhdGlvbnMgaWYgdGhlcmUgaXMgb25seSBvbmUgZ3JvdXANCgkJaWYgKCBtYXRjaC5sZW5ndGggPT09IDEgKSB7DQoNCgkJCS8vIFRha2UgYSBzaG9ydGN1dCBhbmQgc2V0IHRoZSBjb250ZXh0IGlmIHRoZSByb290IHNlbGVjdG9yIGlzIGFuIElEDQoJCQl0b2tlbnMgPSBtYXRjaFswXSA9IG1hdGNoWzBdLnNsaWNlKCAwICk7DQoJCQlpZiAoIHRva2Vucy5sZW5ndGggPiAyICYmICh0b2tlbiA9IHRva2Vuc1swXSkudHlwZSA9PT0gIklEIiAmJg0KCQkJCQlzdXBwb3J0LmdldEJ5SWQgJiYgY29udGV4dC5ub2RlVHlwZSA9PT0gOSAmJiBkb2N1bWVudElzSFRNTCAmJg0KCQkJCQlFeHByLnJlbGF0aXZlWyB0b2tlbnNbMV0udHlwZSBdICkgew0KDQoJCQkJY29udGV4dCA9ICggRXhwci5maW5kWyJJRCJdKCB0b2tlbi5tYXRjaGVzWzBdLnJlcGxhY2UocnVuZXNjYXBlLCBmdW5lc2NhcGUpLCBjb250ZXh0ICkgfHwgW10gKVswXTsNCgkJCQlpZiAoICFjb250ZXh0ICkgew0KCQkJCQlyZXR1cm4gcmVzdWx0czsNCgkJCQl9DQoJCQkJc2VsZWN0b3IgPSBzZWxlY3Rvci5zbGljZSggdG9rZW5zLnNoaWZ0KCkudmFsdWUubGVuZ3RoICk7DQoJCQl9DQoNCgkJCS8vIEZldGNoIGEgc2VlZCBzZXQgZm9yIHJpZ2h0LXRvLWxlZnQgbWF0Y2hpbmcNCgkJCWkgPSBtYXRjaEV4cHJbIm5lZWRzQ29udGV4dCJdLnRlc3QoIHNlbGVjdG9yICkgPyAwIDogdG9rZW5zLmxlbmd0aDsNCgkJCXdoaWxlICggaS0tICkgew0KCQkJCXRva2VuID0gdG9rZW5zW2ldOw0KDQoJCQkJLy8gQWJvcnQgaWYgd2UgaGl0IGEgY29tYmluYXRvcg0KCQkJCWlmICggRXhwci5yZWxhdGl2ZVsgKHR5cGUgPSB0b2tlbi50eXBlKSBdICkgew0KCQkJCQlicmVhazsNCgkJCQl9DQoJCQkJaWYgKCAoZmluZCA9IEV4cHIuZmluZFsgdHlwZSBdKSApIHsNCgkJCQkJLy8gU2VhcmNoLCBleHBhbmRpbmcgY29udGV4dCBmb3IgbGVhZGluZyBzaWJsaW5nIGNvbWJpbmF0b3JzDQoJCQkJCWlmICggKHNlZWQgPSBmaW5kKA0KCQkJCQkJdG9rZW4ubWF0Y2hlc1swXS5yZXBsYWNlKCBydW5lc2NhcGUsIGZ1bmVzY2FwZSApLA0KCQkJCQkJcnNpYmxpbmcudGVzdCggdG9rZW5zWzBdLnR5cGUgKSAmJiBjb250ZXh0LnBhcmVudE5vZGUgfHwgY29udGV4dA0KCQkJCQkpKSApIHsNCg0KCQkJCQkJLy8gSWYgc2VlZCBpcyBlbXB0eSBvciBubyB0b2tlbnMgcmVtYWluLCB3ZSBjYW4gcmV0dXJuIGVhcmx5DQoJCQkJCQl0b2tlbnMuc3BsaWNlKCBpLCAxICk7DQoJCQkJCQlzZWxlY3RvciA9IHNlZWQubGVuZ3RoICYmIHRvU2VsZWN0b3IoIHRva2VucyApOw0KCQkJCQkJaWYgKCAhc2VsZWN0b3IgKSB7DQoJCQkJCQkJcHVzaC5hcHBseSggcmVzdWx0cywgc2VlZCApOw0KCQkJCQkJCXJldHVybiByZXN1bHRzOw0KCQkJCQkJfQ0KDQoJCQkJCQlicmVhazsNCgkJCQkJfQ0KCQkJCX0NCgkJCX0NCgkJfQ0KCX0NCg0KCS8vIENvbXBpbGUgYW5kIGV4ZWN1dGUgYSBmaWx0ZXJpbmcgZnVuY3Rpb24NCgkvLyBQcm92aWRlIGBtYXRjaGAgdG8gYXZvaWQgcmV0b2tlbml6YXRpb24gaWYgd2UgbW9kaWZpZWQgdGhlIHNlbGVjdG9yIGFib3ZlDQoJY29tcGlsZSggc2VsZWN0b3IsIG1hdGNoICkoDQoJCXNlZWQsDQoJCWNvbnRleHQsDQoJCSFkb2N1bWVudElzSFRNTCwNCgkJcmVzdWx0cywNCgkJcnNpYmxpbmcudGVzdCggc2VsZWN0b3IgKQ0KCSk7DQoJcmV0dXJuIHJlc3VsdHM7DQp9DQoNCi8vIE9uZS10aW1lIGFzc2lnbm1lbnRzDQoNCi8vIFNvcnQgc3RhYmlsaXR5DQpzdXBwb3J0LnNvcnRTdGFibGUgPSBleHBhbmRvLnNwbGl0KCIiKS5zb3J0KCBzb3J0T3JkZXIgKS5qb2luKCIiKSA9PT0gZXhwYW5kbzsNCg0KLy8gU3VwcG9ydDogQ2hyb21lPDE0DQovLyBBbHdheXMgYXNzdW1lIGR1cGxpY2F0ZXMgaWYgdGhleSBhcmVuJ3QgcGFzc2VkIHRvIHRoZSBjb21wYXJpc29uIGZ1bmN0aW9uDQpzdXBwb3J0LmRldGVjdER1cGxpY2F0ZXMgPSBoYXNEdXBsaWNhdGU7DQoNCi8vIEluaXRpYWxpemUgYWdhaW5zdCB0aGUgZGVmYXVsdCBkb2N1bWVudA0Kc2V0RG9jdW1lbnQoKTsNCg0KLy8gU3VwcG9ydDogV2Via2l0PDUzNy4zMiAtIFNhZmFyaSA2LjAuMy9DaHJvbWUgMjUgKGZpeGVkIGluIENocm9tZSAyNykNCi8vIERldGFjaGVkIG5vZGVzIGNvbmZvdW5kaW5nbHkgZm9sbG93ICplYWNoIG90aGVyKg0Kc3VwcG9ydC5zb3J0RGV0YWNoZWQgPSBhc3NlcnQoZnVuY3Rpb24oIGRpdjEgKSB7DQoJLy8gU2hvdWxkIHJldHVybiAxLCBidXQgcmV0dXJucyA0IChmb2xsb3dpbmcpDQoJcmV0dXJuIGRpdjEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpICkgJiAxOw0KfSk7DQoNCi8vIFN1cHBvcnQ6IElFPDgNCi8vIFByZXZlbnQgYXR0cmlidXRlL3Byb3BlcnR5ICJpbnRlcnBvbGF0aW9uIg0KLy8gaHR0cDovL21zZG4ubWljcm9zb2Z0LmNvbS9lbi11cy9saWJyYXJ5L21zNTM2NDI5JTI4VlMuODUlMjkuYXNweA0KaWYgKCAhYXNzZXJ0KGZ1bmN0aW9uKCBkaXYgKSB7DQoJZGl2LmlubmVySFRNTCA9ICI8YSBocmVmPScjJz48L2E+IjsNCglyZXR1cm4gZGl2LmZpcnN0Q2hpbGQuZ2V0QXR0cmlidXRlKCJocmVmIikgPT09ICIjIiA7DQp9KSApIHsNCglhZGRIYW5kbGUoICJ0eXBlfGhyZWZ8aGVpZ2h0fHdpZHRoIiwgZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGlzWE1MICkgew0KCQlpZiAoICFpc1hNTCApIHsNCgkJCXJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSggbmFtZSwgbmFtZS50b0xvd2VyQ2FzZSgpID09PSAidHlwZSIgPyAxIDogMiApOw0KCQl9DQoJfSk7DQp9DQoNCi8vIFN1cHBvcnQ6IElFPDkNCi8vIFVzZSBkZWZhdWx0VmFsdWUgaW4gcGxhY2Ugb2YgZ2V0QXR0cmlidXRlKCJ2YWx1ZSIpDQppZiAoICFzdXBwb3J0LmF0dHJpYnV0ZXMgfHwgIWFzc2VydChmdW5jdGlvbiggZGl2ICkgew0KCWRpdi5pbm5lckhUTUwgPSAiPGlucHV0Lz4iOw0KCWRpdi5maXJzdENoaWxkLnNldEF0dHJpYnV0ZSggInZhbHVlIiwgIiIgKTsNCglyZXR1cm4gZGl2LmZpcnN0Q2hpbGQuZ2V0QXR0cmlidXRlKCAidmFsdWUiICkgPT09ICIiOw0KfSkgKSB7DQoJYWRkSGFuZGxlKCAidmFsdWUiLCBmdW5jdGlvbiggZWxlbSwgbmFtZSwgaXNYTUwgKSB7DQoJCWlmICggIWlzWE1MICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiApIHsNCgkJCXJldHVybiBlbGVtLmRlZmF1bHRWYWx1ZTsNCgkJfQ0KCX0pOw0KfQ0KDQovLyBTdXBwb3J0OiBJRTw5DQovLyBVc2UgZ2V0QXR0cmlidXRlTm9kZSB0byBmZXRjaCBib29sZWFucyB3aGVuIGdldEF0dHJpYnV0ZSBsaWVzDQppZiAoICFhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsNCglyZXR1cm4gZGl2LmdldEF0dHJpYnV0ZSgiZGlzYWJsZWQiKSA9PSBudWxsOw0KfSkgKSB7DQoJYWRkSGFuZGxlKCBib29sZWFucywgZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGlzWE1MICkgew0KCQl2YXIgdmFsOw0KCQlpZiAoICFpc1hNTCApIHsNCgkJCXJldHVybiAodmFsID0gZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKCBuYW1lICkpICYmIHZhbC5zcGVjaWZpZWQgPw0KCQkJCXZhbC52YWx1ZSA6DQoJCQkJZWxlbVsgbmFtZSBdID09PSB0cnVlID8gbmFtZS50b0xvd2VyQ2FzZSgpIDogbnVsbDsNCgkJfQ0KCX0pOw0KfQ0KDQpqUXVlcnkuZmluZCA9IFNpenpsZTsNCmpRdWVyeS5leHByID0gU2l6emxlLnNlbGVjdG9yczsNCmpRdWVyeS5leHByWyI6Il0gPSBqUXVlcnkuZXhwci5wc2V1ZG9zOw0KalF1ZXJ5LnVuaXF1ZSA9IFNpenpsZS51bmlxdWVTb3J0Ow0KalF1ZXJ5LnRleHQgPSBTaXp6bGUuZ2V0VGV4dDsNCmpRdWVyeS5pc1hNTERvYyA9IFNpenpsZS5pc1hNTDsNCmpRdWVyeS5jb250YWlucyA9IFNpenpsZS5jb250YWluczsNCg0KDQp9KSggd2luZG93ICk7DQovLyBTdHJpbmcgdG8gT2JqZWN0IG9wdGlvbnMgZm9ybWF0IGNhY2hlDQp2YXIgb3B0aW9uc0NhY2hlID0ge307DQoNCi8vIENvbnZlcnQgU3RyaW5nLWZvcm1hdHRlZCBvcHRpb25zIGludG8gT2JqZWN0LWZvcm1hdHRlZCBvbmVzIGFuZCBzdG9yZSBpbiBjYWNoZQ0KZnVuY3Rpb24gY3JlYXRlT3B0aW9ucyggb3B0aW9ucyApIHsNCgl2YXIgb2JqZWN0ID0gb3B0aW9uc0NhY2hlWyBvcHRpb25zIF0gPSB7fTsNCglqUXVlcnkuZWFjaCggb3B0aW9ucy5tYXRjaCggY29yZV9ybm90d2hpdGUgKSB8fCBbXSwgZnVuY3Rpb24oIF8sIGZsYWcgKSB7DQoJCW9iamVjdFsgZmxhZyBdID0gdHJ1ZTsNCgl9KTsNCglyZXR1cm4gb2JqZWN0Ow0KfQ0KDQovKg0KICogQ3JlYXRlIGEgY2FsbGJhY2sgbGlzdCB1c2luZyB0aGUgZm9sbG93aW5nIHBhcmFtZXRlcnM6DQogKg0KICoJb3B0aW9uczogYW4gb3B0aW9uYWwgbGlzdCBvZiBzcGFjZS1zZXBhcmF0ZWQgb3B0aW9ucyB0aGF0IHdpbGwgY2hhbmdlIGhvdw0KICoJCQl0aGUgY2FsbGJhY2sgbGlzdCBiZWhhdmVzIG9yIGEgbW9yZSB0cmFkaXRpb25hbCBvcHRpb24gb2JqZWN0DQogKg0KICogQnkgZGVmYXVsdCBhIGNhbGxiYWNrIGxpc3Qgd2lsbCBhY3QgbGlrZSBhbiBldmVudCBjYWxsYmFjayBsaXN0IGFuZCBjYW4gYmUNCiAqICJmaXJlZCIgbXVsdGlwbGUgdGltZXMuDQogKg0KICogUG9zc2libGUgb3B0aW9uczoNCiAqDQogKglvbmNlOgkJCXdpbGwgZW5zdXJlIHRoZSBjYWxsYmFjayBsaXN0IGNhbiBvbmx5IGJlIGZpcmVkIG9uY2UgKGxpa2UgYSBEZWZlcnJlZCkNCiAqDQogKgltZW1vcnk6CQkJd2lsbCBrZWVwIHRyYWNrIG9mIHByZXZpb3VzIHZhbHVlcyBhbmQgd2lsbCBjYWxsIGFueSBjYWxsYmFjayBhZGRlZA0KICoJCQkJCWFmdGVyIHRoZSBsaXN0IGhhcyBiZWVuIGZpcmVkIHJpZ2h0IGF3YXkgd2l0aCB0aGUgbGF0ZXN0ICJtZW1vcml6ZWQiDQogKgkJCQkJdmFsdWVzIChsaWtlIGEgRGVmZXJyZWQpDQogKg0KICoJdW5pcXVlOgkJCXdpbGwgZW5zdXJlIGEgY2FsbGJhY2sgY2FuIG9ubHkgYmUgYWRkZWQgb25jZSAobm8gZHVwbGljYXRlIGluIHRoZSBsaXN0KQ0KICoNCiAqCXN0b3BPbkZhbHNlOglpbnRlcnJ1cHQgY2FsbGluZ3Mgd2hlbiBhIGNhbGxiYWNrIHJldHVybnMgZmFsc2UNCiAqDQogKi8NCmpRdWVyeS5DYWxsYmFja3MgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsNCg0KCS8vIENvbnZlcnQgb3B0aW9ucyBmcm9tIFN0cmluZy1mb3JtYXR0ZWQgdG8gT2JqZWN0LWZvcm1hdHRlZCBpZiBuZWVkZWQNCgkvLyAod2UgY2hlY2sgaW4gY2FjaGUgZmlyc3QpDQoJb3B0aW9ucyA9IHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIiA/DQoJCSggb3B0aW9uc0NhY2hlWyBvcHRpb25zIF0gfHwgY3JlYXRlT3B0aW9ucyggb3B0aW9ucyApICkgOg0KCQlqUXVlcnkuZXh0ZW5kKCB7fSwgb3B0aW9ucyApOw0KDQoJdmFyIC8vIEZsYWcgdG8ga25vdyBpZiBsaXN0IGlzIGN1cnJlbnRseSBmaXJpbmcNCgkJZmlyaW5nLA0KCQkvLyBMYXN0IGZpcmUgdmFsdWUgKGZvciBub24tZm9yZ2V0dGFibGUgbGlzdHMpDQoJCW1lbW9yeSwNCgkJLy8gRmxhZyB0byBrbm93IGlmIGxpc3Qgd2FzIGFscmVhZHkgZmlyZWQNCgkJZmlyZWQsDQoJCS8vIEVuZCBvZiB0aGUgbG9vcCB3aGVuIGZpcmluZw0KCQlmaXJpbmdMZW5ndGgsDQoJCS8vIEluZGV4IG9mIGN1cnJlbnRseSBmaXJpbmcgY2FsbGJhY2sgKG1vZGlmaWVkIGJ5IHJlbW92ZSBpZiBuZWVkZWQpDQoJCWZpcmluZ0luZGV4LA0KCQkvLyBGaXJzdCBjYWxsYmFjayB0byBmaXJlICh1c2VkIGludGVybmFsbHkgYnkgYWRkIGFuZCBmaXJlV2l0aCkNCgkJZmlyaW5nU3RhcnQsDQoJCS8vIEFjdHVhbCBjYWxsYmFjayBsaXN0DQoJCWxpc3QgPSBbXSwNCgkJLy8gU3RhY2sgb2YgZmlyZSBjYWxscyBmb3IgcmVwZWF0YWJsZSBsaXN0cw0KCQlzdGFjayA9ICFvcHRpb25zLm9uY2UgJiYgW10sDQoJCS8vIEZpcmUgY2FsbGJhY2tzDQoJCWZpcmUgPSBmdW5jdGlvbiggZGF0YSApIHsNCgkJCW1lbW9yeSA9IG9wdGlvbnMubWVtb3J5ICYmIGRhdGE7DQoJCQlmaXJlZCA9IHRydWU7DQoJCQlmaXJpbmdJbmRleCA9IGZpcmluZ1N0YXJ0IHx8IDA7DQoJCQlmaXJpbmdTdGFydCA9IDA7DQoJCQlmaXJpbmdMZW5ndGggPSBsaXN0Lmxlbmd0aDsNCgkJCWZpcmluZyA9IHRydWU7DQoJCQlmb3IgKCA7IGxpc3QgJiYgZmlyaW5nSW5kZXggPCBmaXJpbmdMZW5ndGg7IGZpcmluZ0luZGV4KysgKSB7DQoJCQkJaWYgKCBsaXN0WyBmaXJpbmdJbmRleCBdLmFwcGx5KCBkYXRhWyAwIF0sIGRhdGFbIDEgXSApID09PSBmYWxzZSAmJiBvcHRpb25zLnN0b3BPbkZhbHNlICkgew0KCQkJCQltZW1vcnkgPSBmYWxzZTsgLy8gVG8gcHJldmVudCBmdXJ0aGVyIGNhbGxzIHVzaW5nIGFkZA0KCQkJCQlicmVhazsNCgkJCQl9DQoJCQl9DQoJCQlmaXJpbmcgPSBmYWxzZTsNCgkJCWlmICggbGlzdCApIHsNCgkJCQlpZiAoIHN0YWNrICkgew0KCQkJCQlpZiAoIHN0YWNrLmxlbmd0aCApIHsNCgkJCQkJCWZpcmUoIHN0YWNrLnNoaWZ0KCkgKTsNCgkJCQkJfQ0KCQkJCX0gZWxzZSBpZiAoIG1lbW9yeSApIHsNCgkJCQkJbGlzdCA9IFtdOw0KCQkJCX0gZWxzZSB7DQoJCQkJCXNlbGYuZGlzYWJsZSgpOw0KCQkJCX0NCgkJCX0NCgkJfSwNCgkJLy8gQWN0dWFsIENhbGxiYWNrcyBvYmplY3QNCgkJc2VsZiA9IHsNCgkJCS8vIEFkZCBhIGNhbGxiYWNrIG9yIGEgY29sbGVjdGlvbiBvZiBjYWxsYmFja3MgdG8gdGhlIGxpc3QNCgkJCWFkZDogZnVuY3Rpb24oKSB7DQoJCQkJaWYgKCBsaXN0ICkgew0KCQkJCQkvLyBGaXJzdCwgd2Ugc2F2ZSB0aGUgY3VycmVudCBsZW5ndGgNCgkJCQkJdmFyIHN0YXJ0ID0gbGlzdC5sZW5ndGg7DQoJCQkJCShmdW5jdGlvbiBhZGQoIGFyZ3MgKSB7DQoJCQkJCQlqUXVlcnkuZWFjaCggYXJncywgZnVuY3Rpb24oIF8sIGFyZyApIHsNCgkJCQkJCQl2YXIgdHlwZSA9IGpRdWVyeS50eXBlKCBhcmcgKTsNCgkJCQkJCQlpZiAoIHR5cGUgPT09ICJmdW5jdGlvbiIgKSB7DQoJCQkJCQkJCWlmICggIW9wdGlvbnMudW5pcXVlIHx8ICFzZWxmLmhhcyggYXJnICkgKSB7DQoJCQkJCQkJCQlsaXN0LnB1c2goIGFyZyApOw0KCQkJCQkJCQl9DQoJCQkJCQkJfSBlbHNlIGlmICggYXJnICYmIGFyZy5sZW5ndGggJiYgdHlwZSAhPT0gInN0cmluZyIgKSB7DQoJCQkJCQkJCS8vIEluc3BlY3QgcmVjdXJzaXZlbHkNCgkJCQkJCQkJYWRkKCBhcmcgKTsNCgkJCQkJCQl9DQoJCQkJCQl9KTsNCgkJCQkJfSkoIGFyZ3VtZW50cyApOw0KCQkJCQkvLyBEbyB3ZSBuZWVkIHRvIGFkZCB0aGUgY2FsbGJhY2tzIHRvIHRoZQ0KCQkJCQkvLyBjdXJyZW50IGZpcmluZyBiYXRjaD8NCgkJCQkJaWYgKCBmaXJpbmcgKSB7DQoJCQkJCQlmaXJpbmdMZW5ndGggPSBsaXN0Lmxlbmd0aDsNCgkJCQkJLy8gV2l0aCBtZW1vcnksIGlmIHdlJ3JlIG5vdCBmaXJpbmcgdGhlbg0KCQkJCQkvLyB3ZSBzaG91bGQgY2FsbCByaWdodCBhd2F5DQoJCQkJCX0gZWxzZSBpZiAoIG1lbW9yeSApIHsNCgkJCQkJCWZpcmluZ1N0YXJ0ID0gc3RhcnQ7DQoJCQkJCQlmaXJlKCBtZW1vcnkgKTsNCgkJCQkJfQ0KCQkJCX0NCgkJCQlyZXR1cm4gdGhpczsNCgkJCX0sDQoJCQkvLyBSZW1vdmUgYSBjYWxsYmFjayBmcm9tIHRoZSBsaXN0DQoJCQlyZW1vdmU6IGZ1bmN0aW9uKCkgew0KCQkJCWlmICggbGlzdCApIHsNCgkJCQkJalF1ZXJ5LmVhY2goIGFyZ3VtZW50cywgZnVuY3Rpb24oIF8sIGFyZyApIHsNCgkJCQkJCXZhciBpbmRleDsNCgkJCQkJCXdoaWxlKCAoIGluZGV4ID0galF1ZXJ5LmluQXJyYXkoIGFyZywgbGlzdCwgaW5kZXggKSApID4gLTEgKSB7DQoJCQkJCQkJbGlzdC5zcGxpY2UoIGluZGV4LCAxICk7DQoJCQkJCQkJLy8gSGFuZGxlIGZpcmluZyBpbmRleGVzDQoJCQkJCQkJaWYgKCBmaXJpbmcgKSB7DQoJCQkJCQkJCWlmICggaW5kZXggPD0gZmlyaW5nTGVuZ3RoICkgew0KCQkJCQkJCQkJZmlyaW5nTGVuZ3RoLS07DQoJCQkJCQkJCX0NCgkJCQkJCQkJaWYgKCBpbmRleCA8PSBmaXJpbmdJbmRleCApIHsNCgkJCQkJCQkJCWZpcmluZ0luZGV4LS07DQoJCQkJCQkJCX0NCgkJCQkJCQl9DQoJCQkJCQl9DQoJCQkJCX0pOw0KCQkJCX0NCgkJCQlyZXR1cm4gdGhpczsNCgkJCX0sDQoJCQkvLyBDaGVjayBpZiBhIGdpdmVuIGNhbGxiYWNrIGlzIGluIHRoZSBsaXN0Lg0KCQkJLy8gSWYgbm8gYXJndW1lbnQgaXMgZ2l2ZW4sIHJldHVybiB3aGV0aGVyIG9yIG5vdCBsaXN0IGhhcyBjYWxsYmFja3MgYXR0YWNoZWQuDQoJCQloYXM6IGZ1bmN0aW9uKCBmbiApIHsNCgkJCQlyZXR1cm4gZm4gPyBqUXVlcnkuaW5BcnJheSggZm4sIGxpc3QgKSA+IC0xIDogISEoIGxpc3QgJiYgbGlzdC5sZW5ndGggKTsNCgkJCX0sDQoJCQkvLyBSZW1vdmUgYWxsIGNhbGxiYWNrcyBmcm9tIHRoZSBsaXN0DQoJCQllbXB0eTogZnVuY3Rpb24oKSB7DQoJCQkJbGlzdCA9IFtdOw0KCQkJCWZpcmluZ0xlbmd0aCA9IDA7DQoJCQkJcmV0dXJuIHRoaXM7DQoJCQl9LA0KCQkJLy8gSGF2ZSB0aGUgbGlzdCBkbyBub3RoaW5nIGFueW1vcmUNCgkJCWRpc2FibGU6IGZ1bmN0aW9uKCkgew0KCQkJCWxpc3QgPSBzdGFjayA9IG1lbW9yeSA9IHVuZGVmaW5lZDsNCgkJCQlyZXR1cm4gdGhpczsNCgkJCX0sDQoJCQkvLyBJcyBpdCBkaXNhYmxlZD8NCgkJCWRpc2FibGVkOiBmdW5jdGlvbigpIHsNCgkJCQlyZXR1cm4gIWxpc3Q7DQoJCQl9LA0KCQkJLy8gTG9jayB0aGUgbGlzdCBpbiBpdHMgY3VycmVudCBzdGF0ZQ0KCQkJbG9jazogZnVuY3Rpb24oKSB7DQoJCQkJc3RhY2sgPSB1bmRlZmluZWQ7DQoJCQkJaWYgKCAhbWVtb3J5ICkgew0KCQkJCQlzZWxmLmRpc2FibGUoKTsNCgkJCQl9DQoJCQkJcmV0dXJuIHRoaXM7DQoJCQl9LA0KCQkJLy8gSXMgaXQgbG9ja2VkPw0KCQkJbG9ja2VkOiBmdW5jdGlvbigpIHsNCgkJCQlyZXR1cm4gIXN0YWNrOw0KCQkJfSwNCgkJCS8vIENhbGwgYWxsIGNhbGxiYWNrcyB3aXRoIHRoZSBnaXZlbiBjb250ZXh0IGFuZCBhcmd1bWVudHMNCgkJCWZpcmVXaXRoOiBmdW5jdGlvbiggY29udGV4dCwgYXJncyApIHsNCgkJCQlpZiAoIGxpc3QgJiYgKCAhZmlyZWQgfHwgc3RhY2sgKSApIHsNCgkJCQkJYXJncyA9IGFyZ3MgfHwgW107DQoJCQkJCWFyZ3MgPSBbIGNvbnRleHQsIGFyZ3Muc2xpY2UgPyBhcmdzLnNsaWNlKCkgOiBhcmdzIF07DQoJCQkJCWlmICggZmlyaW5nICkgew0KCQkJCQkJc3RhY2sucHVzaCggYXJncyApOw0KCQkJCQl9IGVsc2Ugew0KCQkJCQkJZmlyZSggYXJncyApOw0KCQkJCQl9DQoJCQkJfQ0KCQkJCXJldHVybiB0aGlzOw0KCQkJfSwNCgkJCS8vIENhbGwgYWxsIHRoZSBjYWxsYmFja3Mgd2l0aCB0aGUgZ2l2ZW4gYXJndW1lbnRzDQoJCQlmaXJlOiBmdW5jdGlvbigpIHsNCgkJCQlzZWxmLmZpcmVXaXRoKCB0aGlzLCBhcmd1bWVudHMgKTsNCgkJCQlyZXR1cm4gdGhpczsNCgkJCX0sDQoJCQkvLyBUbyBrbm93IGlmIHRoZSBjYWxsYmFja3MgaGF2ZSBhbHJlYWR5IGJlZW4gY2FsbGVkIGF0IGxlYXN0IG9uY2UNCgkJCWZpcmVkOiBmdW5jdGlvbigpIHsNCgkJCQlyZXR1cm4gISFmaXJlZDsNCgkJCX0NCgkJfTsNCg0KCXJldHVybiBzZWxmOw0KfTsNCmpRdWVyeS5leHRlbmQoew0KDQoJRGVmZXJyZWQ6IGZ1bmN0aW9uKCBmdW5jICkgew0KCQl2YXIgdHVwbGVzID0gWw0KCQkJCS8vIGFjdGlvbiwgYWRkIGxpc3RlbmVyLCBsaXN0ZW5lciBsaXN0LCBmaW5hbCBzdGF0ZQ0KCQkJCVsgInJlc29sdmUiLCAiZG9uZSIsIGpRdWVyeS5DYWxsYmFja3MoIm9uY2UgbWVtb3J5IiksICJyZXNvbHZlZCIgXSwNCgkJCQlbICJyZWplY3QiLCAiZmFpbCIsIGpRdWVyeS5DYWxsYmFja3MoIm9uY2UgbWVtb3J5IiksICJyZWplY3RlZCIgXSwNCgkJCQlbICJub3RpZnkiLCAicHJvZ3Jlc3MiLCBqUXVlcnkuQ2FsbGJhY2tzKCJtZW1vcnkiKSBdDQoJCQldLA0KCQkJc3RhdGUgPSAicGVuZGluZyIsDQoJCQlwcm9taXNlID0gew0KCQkJCXN0YXRlOiBmdW5jdGlvbigpIHsNCgkJCQkJcmV0dXJuIHN0YXRlOw0KCQkJCX0sDQoJCQkJYWx3YXlzOiBmdW5jdGlvbigpIHsNCgkJCQkJZGVmZXJyZWQuZG9uZSggYXJndW1lbnRzICkuZmFpbCggYXJndW1lbnRzICk7DQoJCQkJCXJldHVybiB0aGlzOw0KCQkJCX0sDQoJCQkJdGhlbjogZnVuY3Rpb24oIC8qIGZuRG9uZSwgZm5GYWlsLCBmblByb2dyZXNzICovICkgew0KCQkJCQl2YXIgZm5zID0gYXJndW1lbnRzOw0KCQkJCQlyZXR1cm4galF1ZXJ5LkRlZmVycmVkKGZ1bmN0aW9uKCBuZXdEZWZlciApIHsNCgkJCQkJCWpRdWVyeS5lYWNoKCB0dXBsZXMsIGZ1bmN0aW9uKCBpLCB0dXBsZSApIHsNCgkJCQkJCQl2YXIgYWN0aW9uID0gdHVwbGVbIDAgXSwNCgkJCQkJCQkJZm4gPSBqUXVlcnkuaXNGdW5jdGlvbiggZm5zWyBpIF0gKSAmJiBmbnNbIGkgXTsNCgkJCQkJCQkvLyBkZWZlcnJlZFsgZG9uZSB8IGZhaWwgfCBwcm9ncmVzcyBdIGZvciBmb3J3YXJkaW5nIGFjdGlvbnMgdG8gbmV3RGVmZXINCgkJCQkJCQlkZWZlcnJlZFsgdHVwbGVbMV0gXShmdW5jdGlvbigpIHsNCgkJCQkJCQkJdmFyIHJldHVybmVkID0gZm4gJiYgZm4uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOw0KCQkJCQkJCQlpZiAoIHJldHVybmVkICYmIGpRdWVyeS5pc0Z1bmN0aW9uKCByZXR1cm5lZC5wcm9taXNlICkgKSB7DQoJCQkJCQkJCQlyZXR1cm5lZC5wcm9taXNlKCkNCgkJCQkJCQkJCQkuZG9uZSggbmV3RGVmZXIucmVzb2x2ZSApDQoJCQkJCQkJCQkJLmZhaWwoIG5ld0RlZmVyLnJlamVjdCApDQoJCQkJCQkJCQkJLnByb2dyZXNzKCBuZXdEZWZlci5ub3RpZnkgKTsNCgkJCQkJCQkJfSBlbHNlIHsNCgkJCQkJCQkJCW5ld0RlZmVyWyBhY3Rpb24gKyAiV2l0aCIgXSggdGhpcyA9PT0gcHJvbWlzZSA/IG5ld0RlZmVyLnByb21pc2UoKSA6IHRoaXMsIGZuID8gWyByZXR1cm5lZCBdIDogYXJndW1lbnRzICk7DQoJCQkJCQkJCX0NCgkJCQkJCQl9KTsNCgkJCQkJCX0pOw0KCQkJCQkJZm5zID0gbnVsbDsNCgkJCQkJfSkucHJvbWlzZSgpOw0KCQkJCX0sDQoJCQkJLy8gR2V0IGEgcHJvbWlzZSBmb3IgdGhpcyBkZWZlcnJlZA0KCQkJCS8vIElmIG9iaiBpcyBwcm92aWRlZCwgdGhlIHByb21pc2UgYXNwZWN0IGlzIGFkZGVkIHRvIHRoZSBvYmplY3QNCgkJCQlwcm9taXNlOiBmdW5jdGlvbiggb2JqICkgew0KCQkJCQlyZXR1cm4gb2JqICE9IG51bGwgPyBqUXVlcnkuZXh0ZW5kKCBvYmosIHByb21pc2UgKSA6IHByb21pc2U7DQoJCQkJfQ0KCQkJfSwNCgkJCWRlZmVycmVkID0ge307DQoNCgkJLy8gS2VlcCBwaXBlIGZvciBiYWNrLWNvbXBhdA0KCQlwcm9taXNlLnBpcGUgPSBwcm9taXNlLnRoZW47DQoNCgkJLy8gQWRkIGxpc3Qtc3BlY2lmaWMgbWV0aG9kcw0KCQlqUXVlcnkuZWFjaCggdHVwbGVzLCBmdW5jdGlvbiggaSwgdHVwbGUgKSB7DQoJCQl2YXIgbGlzdCA9IHR1cGxlWyAyIF0sDQoJCQkJc3RhdGVTdHJpbmcgPSB0dXBsZVsgMyBdOw0KDQoJCQkvLyBwcm9taXNlWyBkb25lIHwgZmFpbCB8IHByb2dyZXNzIF0gPSBsaXN0LmFkZA0KCQkJcHJvbWlzZVsgdHVwbGVbMV0gXSA9IGxpc3QuYWRkOw0KDQoJCQkvLyBIYW5kbGUgc3RhdGUNCgkJCWlmICggc3RhdGVTdHJpbmcgKSB7DQoJCQkJbGlzdC5hZGQoZnVuY3Rpb24oKSB7DQoJCQkJCS8vIHN0YXRlID0gWyByZXNvbHZlZCB8IHJlamVjdGVkIF0NCgkJCQkJc3RhdGUgPSBzdGF0ZVN0cmluZzsNCg0KCQkJCS8vIFsgcmVqZWN0X2xpc3QgfCByZXNvbHZlX2xpc3QgXS5kaXNhYmxlOyBwcm9ncmVzc19saXN0LmxvY2sNCgkJCQl9LCB0dXBsZXNbIGkgXiAxIF1bIDIgXS5kaXNhYmxlLCB0dXBsZXNbIDIgXVsgMiBdLmxvY2sgKTsNCgkJCX0NCg0KCQkJLy8gZGVmZXJyZWRbIHJlc29sdmUgfCByZWplY3QgfCBub3RpZnkgXQ0KCQkJZGVmZXJyZWRbIHR1cGxlWzBdIF0gPSBmdW5jdGlvbigpIHsNCgkJCQlkZWZlcnJlZFsgdHVwbGVbMF0gKyAiV2l0aCIgXSggdGhpcyA9PT0gZGVmZXJyZWQgPyBwcm9taXNlIDogdGhpcywgYXJndW1lbnRzICk7DQoJCQkJcmV0dXJuIHRoaXM7DQoJCQl9Ow0KCQkJZGVmZXJyZWRbIHR1cGxlWzBdICsgIldpdGgiIF0gPSBsaXN0LmZpcmVXaXRoOw0KCQl9KTsNCg0KCQkvLyBNYWtlIHRoZSBkZWZlcnJlZCBhIHByb21pc2UNCgkJcHJvbWlzZS5wcm9taXNlKCBkZWZlcnJlZCApOw0KDQoJCS8vIENhbGwgZ2l2ZW4gZnVuYyBpZiBhbnkNCgkJaWYgKCBmdW5jICkgew0KCQkJZnVuYy5jYWxsKCBkZWZlcnJlZCwgZGVmZXJyZWQgKTsNCgkJfQ0KDQoJCS8vIEFsbCBkb25lIQ0KCQlyZXR1cm4gZGVmZXJyZWQ7DQoJfSwNCg0KCS8vIERlZmVycmVkIGhlbHBlcg0KCXdoZW46IGZ1bmN0aW9uKCBzdWJvcmRpbmF0ZSAvKiAsIC4uLiwgc3Vib3JkaW5hdGVOICovICkgew0KCQl2YXIgaSA9IDAsDQoJCQlyZXNvbHZlVmFsdWVzID0gY29yZV9zbGljZS5jYWxsKCBhcmd1bWVudHMgKSwNCgkJCWxlbmd0aCA9IHJlc29sdmVWYWx1ZXMubGVuZ3RoLA0KDQoJCQkvLyB0aGUgY291bnQgb2YgdW5jb21wbGV0ZWQgc3Vib3JkaW5hdGVzDQoJCQlyZW1haW5pbmcgPSBsZW5ndGggIT09IDEgfHwgKCBzdWJvcmRpbmF0ZSAmJiBqUXVlcnkuaXNGdW5jdGlvbiggc3Vib3JkaW5hdGUucHJvbWlzZSApICkgPyBsZW5ndGggOiAwLA0KDQoJCQkvLyB0aGUgbWFzdGVyIERlZmVycmVkLiBJZiByZXNvbHZlVmFsdWVzIGNvbnNpc3Qgb2Ygb25seSBhIHNpbmdsZSBEZWZlcnJlZCwganVzdCB1c2UgdGhhdC4NCgkJCWRlZmVycmVkID0gcmVtYWluaW5nID09PSAxID8gc3Vib3JkaW5hdGUgOiBqUXVlcnkuRGVmZXJyZWQoKSwNCg0KCQkJLy8gVXBkYXRlIGZ1bmN0aW9uIGZvciBib3RoIHJlc29sdmUgYW5kIHByb2dyZXNzIHZhbHVlcw0KCQkJdXBkYXRlRnVuYyA9IGZ1bmN0aW9uKCBpLCBjb250ZXh0cywgdmFsdWVzICkgew0KCQkJCXJldHVybiBmdW5jdGlvbiggdmFsdWUgKSB7DQoJCQkJCWNvbnRleHRzWyBpIF0gPSB0aGlzOw0KCQkJCQl2YWx1ZXNbIGkgXSA9IGFyZ3VtZW50cy5sZW5ndGggPiAxID8gY29yZV9zbGljZS5jYWxsKCBhcmd1bWVudHMgKSA6IHZhbHVlOw0KCQkJCQlpZiggdmFsdWVzID09PSBwcm9ncmVzc1ZhbHVlcyApIHsNCgkJCQkJCWRlZmVycmVkLm5vdGlmeVdpdGgoIGNvbnRleHRzLCB2YWx1ZXMgKTsNCgkJCQkJfSBlbHNlIGlmICggISggLS1yZW1haW5pbmcgKSApIHsNCgkJCQkJCWRlZmVycmVkLnJlc29sdmVXaXRoKCBjb250ZXh0cywgdmFsdWVzICk7DQoJCQkJCX0NCgkJCQl9Ow0KCQkJfSwNCg0KCQkJcHJvZ3Jlc3NWYWx1ZXMsIHByb2dyZXNzQ29udGV4dHMsIHJlc29sdmVDb250ZXh0czsNCg0KCQkvLyBhZGQgbGlzdGVuZXJzIHRvIERlZmVycmVkIHN1Ym9yZGluYXRlczsgdHJlYXQgb3RoZXJzIGFzIHJlc29sdmVkDQoJCWlmICggbGVuZ3RoID4gMSApIHsNCgkJCXByb2dyZXNzVmFsdWVzID0gbmV3IEFycmF5KCBsZW5ndGggKTsNCgkJCXByb2dyZXNzQ29udGV4dHMgPSBuZXcgQXJyYXkoIGxlbmd0aCApOw0KCQkJcmVzb2x2ZUNvbnRleHRzID0gbmV3IEFycmF5KCBsZW5ndGggKTsNCgkJCWZvciAoIDsgaSA8IGxlbmd0aDsgaSsrICkgew0KCQkJCWlmICggcmVzb2x2ZVZhbHVlc1sgaSBdICYmIGpRdWVyeS5pc0Z1bmN0aW9uKCByZXNvbHZlVmFsdWVzWyBpIF0ucHJvbWlzZSApICkgew0KCQkJCQlyZXNvbHZlVmFsdWVzWyBpIF0ucHJvbWlzZSgpDQoJCQkJCQkuZG9uZSggdXBkYXRlRnVuYyggaSwgcmVzb2x2ZUNvbnRleHRzLCByZXNvbHZlVmFsdWVzICkgKQ0KCQkJCQkJLmZhaWwoIGRlZmVycmVkLnJlamVjdCApDQoJCQkJCQkucHJvZ3Jlc3MoIHVwZGF0ZUZ1bmMoIGksIHByb2dyZXNzQ29udGV4dHMsIHByb2dyZXNzVmFsdWVzICkgKTsNCgkJCQl9IGVsc2Ugew0KCQkJCQktLXJlbWFpbmluZzsNCgkJCQl9DQoJCQl9DQoJCX0NCg0KCQkvLyBpZiB3ZSdyZSBub3Qgd2FpdGluZyBvbiBhbnl0aGluZywgcmVzb2x2ZSB0aGUgbWFzdGVyDQoJCWlmICggIXJlbWFpbmluZyApIHsNCgkJCWRlZmVycmVkLnJlc29sdmVXaXRoKCByZXNvbHZlQ29udGV4dHMsIHJlc29sdmVWYWx1ZXMgKTsNCgkJfQ0KDQoJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7DQoJfQ0KfSk7DQpqUXVlcnkuc3VwcG9ydCA9IChmdW5jdGlvbiggc3VwcG9ydCApIHsNCg0KCXZhciBhbGwsIGEsIGlucHV0LCBzZWxlY3QsIGZyYWdtZW50LCBvcHQsIGV2ZW50TmFtZSwgaXNTdXBwb3J0ZWQsIGksDQoJCWRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOw0KDQoJLy8gU2V0dXANCglkaXYuc2V0QXR0cmlidXRlKCAiY2xhc3NOYW1lIiwgInQiICk7DQoJZGl2LmlubmVySFRNTCA9ICIgIDxsaW5rLz48dGFibGU+PC90YWJsZT48YSBocmVmPScvYSc+YTwvYT48aW5wdXQgdHlwZT0nY2hlY2tib3gnLz4iOw0KDQoJLy8gRmluaXNoIGVhcmx5IGluIGxpbWl0ZWQgKG5vbi1icm93c2VyKSBlbnZpcm9ubWVudHMNCglhbGwgPSBkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKSB8fCBbXTsNCglhID0gZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJhIilbIDAgXTsNCglpZiAoICFhIHx8ICFhLnN0eWxlIHx8ICFhbGwubGVuZ3RoICkgew0KCQlyZXR1cm4gc3VwcG9ydDsNCgl9DQoNCgkvLyBGaXJzdCBiYXRjaCBvZiB0ZXN0cw0KCXNlbGVjdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNlbGVjdCIpOw0KCW9wdCA9IHNlbGVjdC5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgib3B0aW9uIikgKTsNCglpbnB1dCA9IGRpdi5nZXRFbGVtZW50c0J5VGFnTmFtZSgiaW5wdXQiKVsgMCBdOw0KDQoJYS5zdHlsZS5jc3NUZXh0ID0gInRvcDoxcHg7ZmxvYXQ6bGVmdDtvcGFjaXR5Oi41IjsNCg0KCS8vIFRlc3Qgc2V0QXR0cmlidXRlIG9uIGNhbWVsQ2FzZSBjbGFzcy4gSWYgaXQgd29ya3MsIHdlIG5lZWQgYXR0ckZpeGVzIHdoZW4gZG9pbmcgZ2V0L3NldEF0dHJpYnV0ZSAoaWU2LzcpDQoJc3VwcG9ydC5nZXRTZXRBdHRyaWJ1dGUgPSBkaXYuY2xhc3NOYW1lICE9PSAidCI7DQoNCgkvLyBJRSBzdHJpcHMgbGVhZGluZyB3aGl0ZXNwYWNlIHdoZW4gLmlubmVySFRNTCBpcyB1c2VkDQoJc3VwcG9ydC5sZWFkaW5nV2hpdGVzcGFjZSA9IGRpdi5maXJzdENoaWxkLm5vZGVUeXBlID09PSAzOw0KDQoJLy8gTWFrZSBzdXJlIHRoYXQgdGJvZHkgZWxlbWVudHMgYXJlbid0IGF1dG9tYXRpY2FsbHkgaW5zZXJ0ZWQNCgkvLyBJRSB3aWxsIGluc2VydCB0aGVtIGludG8gZW1wdHkgdGFibGVzDQoJc3VwcG9ydC50Ym9keSA9ICFkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoInRib2R5IikubGVuZ3RoOw0KDQoJLy8gTWFrZSBzdXJlIHRoYXQgbGluayBlbGVtZW50cyBnZXQgc2VyaWFsaXplZCBjb3JyZWN0bHkgYnkgaW5uZXJIVE1MDQoJLy8gVGhpcyByZXF1aXJlcyBhIHdyYXBwZXIgZWxlbWVudCBpbiBJRQ0KCXN1cHBvcnQuaHRtbFNlcmlhbGl6ZSA9ICEhZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJsaW5rIikubGVuZ3RoOw0KDQoJLy8gR2V0IHRoZSBzdHlsZSBpbmZvcm1hdGlvbiBmcm9tIGdldEF0dHJpYnV0ZQ0KCS8vIChJRSB1c2VzIC5jc3NUZXh0IGluc3RlYWQpDQoJc3VwcG9ydC5zdHlsZSA9IC90b3AvLnRlc3QoIGEuZ2V0QXR0cmlidXRlKCJzdHlsZSIpICk7DQoNCgkvLyBNYWtlIHN1cmUgdGhhdCBVUkxzIGFyZW4ndCBtYW5pcHVsYXRlZA0KCS8vIChJRSBub3JtYWxpemVzIGl0IGJ5IGRlZmF1bHQpDQoJc3VwcG9ydC5ocmVmTm9ybWFsaXplZCA9IGEuZ2V0QXR0cmlidXRlKCJocmVmIikgPT09ICIvYSI7DQoNCgkvLyBNYWtlIHN1cmUgdGhhdCBlbGVtZW50IG9wYWNpdHkgZXhpc3RzDQoJLy8gKElFIHVzZXMgZmlsdGVyIGluc3RlYWQpDQoJLy8gVXNlIGEgcmVnZXggdG8gd29yayBhcm91bmQgYSBXZWJLaXQgaXNzdWUuIFNlZSAjNTE0NQ0KCXN1cHBvcnQub3BhY2l0eSA9IC9eMC41Ly50ZXN0KCBhLnN0eWxlLm9wYWNpdHkgKTsNCg0KCS8vIFZlcmlmeSBzdHlsZSBmbG9hdCBleGlzdGVuY2UNCgkvLyAoSUUgdXNlcyBzdHlsZUZsb2F0IGluc3RlYWQgb2YgY3NzRmxvYXQpDQoJc3VwcG9ydC5jc3NGbG9hdCA9ICEhYS5zdHlsZS5jc3NGbG9hdDsNCg0KCS8vIENoZWNrIHRoZSBkZWZhdWx0IGNoZWNrYm94L3JhZGlvIHZhbHVlICgiIiBvbiBXZWJLaXQ7ICJvbiIgZWxzZXdoZXJlKQ0KCXN1cHBvcnQuY2hlY2tPbiA9ICEhaW5wdXQudmFsdWU7DQoNCgkvLyBNYWtlIHN1cmUgdGhhdCBhIHNlbGVjdGVkLWJ5LWRlZmF1bHQgb3B0aW9uIGhhcyBhIHdvcmtpbmcgc2VsZWN0ZWQgcHJvcGVydHkuDQoJLy8gKFdlYktpdCBkZWZhdWx0cyB0byBmYWxzZSBpbnN0ZWFkIG9mIHRydWUsIElFIHRvbywgaWYgaXQncyBpbiBhbiBvcHRncm91cCkNCglzdXBwb3J0Lm9wdFNlbGVjdGVkID0gb3B0LnNlbGVjdGVkOw0KDQoJLy8gVGVzdHMgZm9yIGVuY3R5cGUgc3VwcG9ydCBvbiBhIGZvcm0gKCM2NzQzKQ0KCXN1cHBvcnQuZW5jdHlwZSA9ICEhZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZm9ybSIpLmVuY3R5cGU7DQoNCgkvLyBNYWtlcyBzdXJlIGNsb25pbmcgYW4gaHRtbDUgZWxlbWVudCBkb2VzIG5vdCBjYXVzZSBwcm9ibGVtcw0KCS8vIFdoZXJlIG91dGVySFRNTCBpcyB1bmRlZmluZWQsIHRoaXMgc3RpbGwgd29ya3MNCglzdXBwb3J0Lmh0bWw1Q2xvbmUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJuYXYiKS5jbG9uZU5vZGUoIHRydWUgKS5vdXRlckhUTUwgIT09ICI8Om5hdj48LzpuYXY+IjsNCg0KCS8vIFdpbGwgYmUgZGVmaW5lZCBsYXRlcg0KCXN1cHBvcnQuaW5saW5lQmxvY2tOZWVkc0xheW91dCA9IGZhbHNlOw0KCXN1cHBvcnQuc2hyaW5rV3JhcEJsb2NrcyA9IGZhbHNlOw0KCXN1cHBvcnQucGl4ZWxQb3NpdGlvbiA9IGZhbHNlOw0KCXN1cHBvcnQuZGVsZXRlRXhwYW5kbyA9IHRydWU7DQoJc3VwcG9ydC5ub0Nsb25lRXZlbnQgPSB0cnVlOw0KCXN1cHBvcnQucmVsaWFibGVNYXJnaW5SaWdodCA9IHRydWU7DQoJc3VwcG9ydC5ib3hTaXppbmdSZWxpYWJsZSA9IHRydWU7DQoNCgkvLyBNYWtlIHN1cmUgY2hlY2tlZCBzdGF0dXMgaXMgcHJvcGVybHkgY2xvbmVkDQoJaW5wdXQuY2hlY2tlZCA9IHRydWU7DQoJc3VwcG9ydC5ub0Nsb25lQ2hlY2tlZCA9IGlucHV0LmNsb25lTm9kZSggdHJ1ZSApLmNoZWNrZWQ7DQoNCgkvLyBNYWtlIHN1cmUgdGhhdCB0aGUgb3B0aW9ucyBpbnNpZGUgZGlzYWJsZWQgc2VsZWN0cyBhcmVuJ3QgbWFya2VkIGFzIGRpc2FibGVkDQoJLy8gKFdlYktpdCBtYXJrcyB0aGVtIGFzIGRpc2FibGVkKQ0KCXNlbGVjdC5kaXNhYmxlZCA9IHRydWU7DQoJc3VwcG9ydC5vcHREaXNhYmxlZCA9ICFvcHQuZGlzYWJsZWQ7DQoNCgkvLyBTdXBwb3J0OiBJRTw5DQoJdHJ5IHsNCgkJZGVsZXRlIGRpdi50ZXN0Ow0KCX0gY2F0Y2goIGUgKSB7DQoJCXN1cHBvcnQuZGVsZXRlRXhwYW5kbyA9IGZhbHNlOw0KCX0NCg0KCS8vIENoZWNrIGlmIHdlIGNhbiB0cnVzdCBnZXRBdHRyaWJ1dGUoInZhbHVlIikNCglpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7DQoJaW5wdXQuc2V0QXR0cmlidXRlKCAidmFsdWUiLCAiIiApOw0KCXN1cHBvcnQuaW5wdXQgPSBpbnB1dC5nZXRBdHRyaWJ1dGUoICJ2YWx1ZSIgKSA9PT0gIiI7DQoNCgkvLyBDaGVjayBpZiBhbiBpbnB1dCBtYWludGFpbnMgaXRzIHZhbHVlIGFmdGVyIGJlY29taW5nIGEgcmFkaW8NCglpbnB1dC52YWx1ZSA9ICJ0IjsNCglpbnB1dC5zZXRBdHRyaWJ1dGUoICJ0eXBlIiwgInJhZGlvIiApOw0KCXN1cHBvcnQucmFkaW9WYWx1ZSA9IGlucHV0LnZhbHVlID09PSAidCI7DQoNCgkvLyAjMTEyMTcgLSBXZWJLaXQgbG9zZXMgY2hlY2sgd2hlbiB0aGUgbmFtZSBpcyBhZnRlciB0aGUgY2hlY2tlZCBhdHRyaWJ1dGUNCglpbnB1dC5zZXRBdHRyaWJ1dGUoICJjaGVja2VkIiwgInQiICk7DQoJaW5wdXQuc2V0QXR0cmlidXRlKCAibmFtZSIsICJ0IiApOw0KDQoJZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7DQoJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIGlucHV0ICk7DQoNCgkvLyBDaGVjayBpZiBhIGRpc2Nvbm5lY3RlZCBjaGVja2JveCB3aWxsIHJldGFpbiBpdHMgY2hlY2tlZA0KCS8vIHZhbHVlIG9mIHRydWUgYWZ0ZXIgYXBwZW5kZWQgdG8gdGhlIERPTSAoSUU2LzcpDQoJc3VwcG9ydC5hcHBlbmRDaGVja2VkID0gaW5wdXQuY2hlY2tlZDsNCg0KCS8vIFdlYktpdCBkb2Vzbid0IGNsb25lIGNoZWNrZWQgc3RhdGUgY29ycmVjdGx5IGluIGZyYWdtZW50cw0KCXN1cHBvcnQuY2hlY2tDbG9uZSA9IGZyYWdtZW50LmNsb25lTm9kZSggdHJ1ZSApLmNsb25lTm9kZSggdHJ1ZSApLmxhc3RDaGlsZC5jaGVja2VkOw0KDQoJLy8gU3VwcG9ydDogSUU8OQ0KCS8vIE9wZXJhIGRvZXMgbm90IGNsb25lIGV2ZW50cyAoYW5kIHR5cGVvZiBkaXYuYXR0YWNoRXZlbnQgPT09IHVuZGVmaW5lZCkuDQoJLy8gSUU5LTEwIGNsb25lcyBldmVudHMgYm91bmQgdmlhIGF0dGFjaEV2ZW50LCBidXQgdGhleSBkb24ndCB0cmlnZ2VyIHdpdGggLmNsaWNrKCkNCglpZiAoIGRpdi5hdHRhY2hFdmVudCApIHsNCgkJZGl2LmF0dGFjaEV2ZW50KCAib25jbGljayIsIGZ1bmN0aW9uKCkgew0KCQkJc3VwcG9ydC5ub0Nsb25lRXZlbnQgPSBmYWxzZTsNCgkJfSk7DQoNCgkJZGl2LmNsb25lTm9kZSggdHJ1ZSApLmNsaWNrKCk7DQoJfQ0KDQoJLy8gU3VwcG9ydDogSUU8OSAobGFjayBzdWJtaXQvY2hhbmdlIGJ1YmJsZSksIEZpcmVmb3ggMTcrIChsYWNrIGZvY3VzaW4gZXZlbnQpDQoJLy8gQmV3YXJlIG9mIENTUCByZXN0cmljdGlvbnMgKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL1NlY3VyaXR5L0NTUCkNCglmb3IgKCBpIGluIHsgc3VibWl0OiB0cnVlLCBjaGFuZ2U6IHRydWUsIGZvY3VzaW46IHRydWUgfSkgew0KCQlkaXYuc2V0QXR0cmlidXRlKCBldmVudE5hbWUgPSAib24iICsgaSwgInQiICk7DQoNCgkJc3VwcG9ydFsgaSArICJCdWJibGVzIiBdID0gZXZlbnROYW1lIGluIHdpbmRvdyB8fCBkaXYuYXR0cmlidXRlc1sgZXZlbnROYW1lIF0uZXhwYW5kbyA9PT0gZmFsc2U7DQoJfQ0KDQoJZGl2LnN0eWxlLmJhY2tncm91bmRDbGlwID0gImNvbnRlbnQtYm94IjsNCglkaXYuY2xvbmVOb2RlKCB0cnVlICkuc3R5bGUuYmFja2dyb3VuZENsaXAgPSAiIjsNCglzdXBwb3J0LmNsZWFyQ2xvbmVTdHlsZSA9IGRpdi5zdHlsZS5iYWNrZ3JvdW5kQ2xpcCA9PT0gImNvbnRlbnQtYm94IjsNCg0KCS8vIFN1cHBvcnQ6IElFPDkNCgkvLyBJdGVyYXRpb24gb3ZlciBvYmplY3QncyBpbmhlcml0ZWQgcHJvcGVydGllcyBiZWZvcmUgaXRzIG93bi4NCglmb3IgKCBpIGluIGpRdWVyeSggc3VwcG9ydCApICkgew0KCQlicmVhazsNCgl9DQoJc3VwcG9ydC5vd25MYXN0ID0gaSAhPT0gIjAiOw0KDQoJLy8gUnVuIHRlc3RzIHRoYXQgbmVlZCBhIGJvZHkgYXQgZG9jIHJlYWR5DQoJalF1ZXJ5KGZ1bmN0aW9uKCkgew0KCQl2YXIgY29udGFpbmVyLCBtYXJnaW5EaXYsIHRkcywNCgkJCWRpdlJlc2V0ID0gInBhZGRpbmc6MDttYXJnaW46MDtib3JkZXI6MDtkaXNwbGF5OmJsb2NrO2JveC1zaXppbmc6Y29udGVudC1ib3g7LW1vei1ib3gtc2l6aW5nOmNvbnRlbnQtYm94Oy13ZWJraXQtYm94LXNpemluZzpjb250ZW50LWJveDsiLA0KCQkJYm9keSA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJib2R5IilbMF07DQoNCgkJaWYgKCAhYm9keSApIHsNCgkJCS8vIFJldHVybiBmb3IgZnJhbWVzZXQgZG9jcyB0aGF0IGRvbid0IGhhdmUgYSBib2R5DQoJCQlyZXR1cm47DQoJCX0NCg0KCQljb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsNCgkJY29udGFpbmVyLnN0eWxlLmNzc1RleHQgPSAiYm9yZGVyOjA7d2lkdGg6MDtoZWlnaHQ6MDtwb3NpdGlvbjphYnNvbHV0ZTt0b3A6MDtsZWZ0Oi05OTk5cHg7bWFyZ2luLXRvcDoxcHgiOw0KDQoJCWJvZHkuYXBwZW5kQ2hpbGQoIGNvbnRhaW5lciApLmFwcGVuZENoaWxkKCBkaXYgKTsNCg0KCQkvLyBTdXBwb3J0OiBJRTgNCgkJLy8gQ2hlY2sgaWYgdGFibGUgY2VsbHMgc3RpbGwgaGF2ZSBvZmZzZXRXaWR0aC9IZWlnaHQgd2hlbiB0aGV5IGFyZSBzZXQNCgkJLy8gdG8gZGlzcGxheTpub25lIGFuZCB0aGVyZSBhcmUgc3RpbGwgb3RoZXIgdmlzaWJsZSB0YWJsZSBjZWxscyBpbiBhDQoJCS8vIHRhYmxlIHJvdzsgaWYgc28sIG9mZnNldFdpZHRoL0hlaWdodCBhcmUgbm90IHJlbGlhYmxlIGZvciB1c2Ugd2hlbg0KCQkvLyBkZXRlcm1pbmluZyBpZiBhbiBlbGVtZW50IGhhcyBiZWVuIGhpZGRlbiBkaXJlY3RseSB1c2luZw0KCQkvLyBkaXNwbGF5Om5vbmUgKGl0IGlzIHN0aWxsIHNhZmUgdG8gdXNlIG9mZnNldHMgaWYgYSBwYXJlbnQgZWxlbWVudCBpcw0KCQkvLyBoaWRkZW47IGRvbiBzYWZldHkgZ29nZ2xlcyBhbmQgc2VlIGJ1ZyAjNDUxMiBmb3IgbW9yZSBpbmZvcm1hdGlvbikuDQoJCWRpdi5pbm5lckhUTUwgPSAiPHRhYmxlPjx0cj48dGQ+PC90ZD48dGQ+dDwvdGQ+PC90cj48L3RhYmxlPiI7DQoJCXRkcyA9IGRpdi5nZXRFbGVtZW50c0J5VGFnTmFtZSgidGQiKTsNCgkJdGRzWyAwIF0uc3R5bGUuY3NzVGV4dCA9ICJwYWRkaW5nOjA7bWFyZ2luOjA7Ym9yZGVyOjA7ZGlzcGxheTpub25lIjsNCgkJaXNTdXBwb3J0ZWQgPSAoIHRkc1sgMCBdLm9mZnNldEhlaWdodCA9PT0gMCApOw0KDQoJCXRkc1sgMCBdLnN0eWxlLmRpc3BsYXkgPSAiIjsNCgkJdGRzWyAxIF0uc3R5bGUuZGlzcGxheSA9ICJub25lIjsNCg0KCQkvLyBTdXBwb3J0OiBJRTgNCgkJLy8gQ2hlY2sgaWYgZW1wdHkgdGFibGUgY2VsbHMgc3RpbGwgaGF2ZSBvZmZzZXRXaWR0aC9IZWlnaHQNCgkJc3VwcG9ydC5yZWxpYWJsZUhpZGRlbk9mZnNldHMgPSBpc1N1cHBvcnRlZCAmJiAoIHRkc1sgMCBdLm9mZnNldEhlaWdodCA9PT0gMCApOw0KDQoJCS8vIENoZWNrIGJveC1zaXppbmcgYW5kIG1hcmdpbiBiZWhhdmlvci4NCgkJZGl2LmlubmVySFRNTCA9ICIiOw0KCQlkaXYuc3R5bGUuY3NzVGV4dCA9ICJib3gtc2l6aW5nOmJvcmRlci1ib3g7LW1vei1ib3gtc2l6aW5nOmJvcmRlci1ib3g7LXdlYmtpdC1ib3gtc2l6aW5nOmJvcmRlci1ib3g7cGFkZGluZzoxcHg7Ym9yZGVyOjFweDtkaXNwbGF5OmJsb2NrO3dpZHRoOjRweDttYXJnaW4tdG9wOjElO3Bvc2l0aW9uOmFic29sdXRlO3RvcDoxJTsiOw0KDQoJCS8vIFdvcmthcm91bmQgZmFpbGluZyBib3hTaXppbmcgdGVzdCBkdWUgdG8gb2Zmc2V0V2lkdGggcmV0dXJuaW5nIHdyb25nIHZhbHVlDQoJCS8vIHdpdGggc29tZSBub24tMSB2YWx1ZXMgb2YgYm9keSB6b29tLCB0aWNrZXQgIzEzNTQzDQoJCWpRdWVyeS5zd2FwKCBib2R5LCBib2R5LnN0eWxlLnpvb20gIT0gbnVsbCA/IHsgem9vbTogMSB9IDoge30sIGZ1bmN0aW9uKCkgew0KCQkJc3VwcG9ydC5ib3hTaXppbmcgPSBkaXYub2Zmc2V0V2lkdGggPT09IDQ7DQoJCX0pOw0KDQoJCS8vIFVzZSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSBiZWNhdXNlIGpzZG9tIG9uIG5vZGUuanMgd2lsbCBicmVhayB3aXRob3V0IGl0Lg0KCQlpZiAoIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlICkgew0KCQkJc3VwcG9ydC5waXhlbFBvc2l0aW9uID0gKCB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSggZGl2LCBudWxsICkgfHwge30gKS50b3AgIT09ICIxJSI7DQoJCQlzdXBwb3J0LmJveFNpemluZ1JlbGlhYmxlID0gKCB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSggZGl2LCBudWxsICkgfHwgeyB3aWR0aDogIjRweCIgfSApLndpZHRoID09PSAiNHB4IjsNCg0KCQkJLy8gQ2hlY2sgaWYgZGl2IHdpdGggZXhwbGljaXQgd2lkdGggYW5kIG5vIG1hcmdpbi1yaWdodCBpbmNvcnJlY3RseQ0KCQkJLy8gZ2V0cyBjb21wdXRlZCBtYXJnaW4tcmlnaHQgYmFzZWQgb24gd2lkdGggb2YgY29udGFpbmVyLiAoIzMzMzMpDQoJCQkvLyBGYWlscyBpbiBXZWJLaXQgYmVmb3JlIEZlYiAyMDExIG5pZ2h0bGllcw0KCQkJLy8gV2ViS2l0IEJ1ZyAxMzM0MyAtIGdldENvbXB1dGVkU3R5bGUgcmV0dXJucyB3cm9uZyB2YWx1ZSBmb3IgbWFyZ2luLXJpZ2h0DQoJCQltYXJnaW5EaXYgPSBkaXYuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpICk7DQoJCQltYXJnaW5EaXYuc3R5bGUuY3NzVGV4dCA9IGRpdi5zdHlsZS5jc3NUZXh0ID0gZGl2UmVzZXQ7DQoJCQltYXJnaW5EaXYuc3R5bGUubWFyZ2luUmlnaHQgPSBtYXJnaW5EaXYuc3R5bGUud2lkdGggPSAiMCI7DQoJCQlkaXYuc3R5bGUud2lkdGggPSAiMXB4IjsNCg0KCQkJc3VwcG9ydC5yZWxpYWJsZU1hcmdpblJpZ2h0ID0NCgkJCQkhcGFyc2VGbG9hdCggKCB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSggbWFyZ2luRGl2LCBudWxsICkgfHwge30gKS5tYXJnaW5SaWdodCApOw0KCQl9DQoNCgkJaWYgKCB0eXBlb2YgZGl2LnN0eWxlLnpvb20gIT09IGNvcmVfc3RydW5kZWZpbmVkICkgew0KCQkJLy8gU3VwcG9ydDogSUU8OA0KCQkJLy8gQ2hlY2sgaWYgbmF0aXZlbHkgYmxvY2stbGV2ZWwgZWxlbWVudHMgYWN0IGxpa2UgaW5saW5lLWJsb2NrDQoJCQkvLyBlbGVtZW50cyB3aGVuIHNldHRpbmcgdGhlaXIgZGlzcGxheSB0byAnaW5saW5lJyBhbmQgZ2l2aW5nDQoJCQkvLyB0aGVtIGxheW91dA0KCQkJZGl2LmlubmVySFRNTCA9ICIiOw0KCQkJZGl2LnN0eWxlLmNzc1RleHQgPSBkaXZSZXNldCArICJ3aWR0aDoxcHg7cGFkZGluZzoxcHg7ZGlzcGxheTppbmxpbmU7em9vbToxIjsNCgkJCXN1cHBvcnQuaW5saW5lQmxvY2tOZWVkc0xheW91dCA9ICggZGl2Lm9mZnNldFdpZHRoID09PSAzICk7DQoNCgkJCS8vIFN1cHBvcnQ6IElFNg0KCQkJLy8gQ2hlY2sgaWYgZWxlbWVudHMgd2l0aCBsYXlvdXQgc2hyaW5rLXdyYXAgdGhlaXIgY2hpbGRyZW4NCgkJCWRpdi5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsNCgkJCWRpdi5pbm5lckhUTUwgPSAiPGRpdj48L2Rpdj4iOw0KCQkJZGl2LmZpcnN0Q2hpbGQuc3R5bGUud2lkdGggPSAiNXB4IjsNCgkJCXN1cHBvcnQuc2hyaW5rV3JhcEJsb2NrcyA9ICggZGl2Lm9mZnNldFdpZHRoICE9PSAzICk7DQoNCgkJCWlmICggc3VwcG9ydC5pbmxpbmVCbG9ja05lZWRzTGF5b3V0ICkgew0KCQkJCS8vIFByZXZlbnQgSUUgNiBmcm9tIGFmZmVjdGluZyBsYXlvdXQgZm9yIHBvc2l0aW9uZWQgZWxlbWVudHMgIzExMDQ4DQoJCQkJLy8gUHJldmVudCBJRSBmcm9tIHNocmlua2luZyB0aGUgYm9keSBpbiBJRSA3IG1vZGUgIzEyODY5DQoJCQkJLy8gU3VwcG9ydDogSUU8OA0KCQkJCWJvZHkuc3R5bGUuem9vbSA9IDE7DQoJCQl9DQoJCX0NCg0KCQlib2R5LnJlbW92ZUNoaWxkKCBjb250YWluZXIgKTsNCg0KCQkvLyBOdWxsIGVsZW1lbnRzIHRvIGF2b2lkIGxlYWtzIGluIElFDQoJCWNvbnRhaW5lciA9IGRpdiA9IHRkcyA9IG1hcmdpbkRpdiA9IG51bGw7DQoJfSk7DQoNCgkvLyBOdWxsIGVsZW1lbnRzIHRvIGF2b2lkIGxlYWtzIGluIElFDQoJYWxsID0gc2VsZWN0ID0gZnJhZ21lbnQgPSBvcHQgPSBhID0gaW5wdXQgPSBudWxsOw0KDQoJcmV0dXJuIHN1cHBvcnQ7DQp9KSh7fSk7DQoNCnZhciByYnJhY2UgPSAvKD86XHtbXHNcU10qXH18XFtbXHNcU10qXF0pJC8sDQoJcm11bHRpRGFzaCA9IC8oW0EtWl0pL2c7DQoNCmZ1bmN0aW9uIGludGVybmFsRGF0YSggZWxlbSwgbmFtZSwgZGF0YSwgcHZ0IC8qIEludGVybmFsIFVzZSBPbmx5ICovICl7DQoJaWYgKCAhalF1ZXJ5LmFjY2VwdERhdGEoIGVsZW0gKSApIHsNCgkJcmV0dXJuOw0KCX0NCg0KCXZhciByZXQsIHRoaXNDYWNoZSwNCgkJaW50ZXJuYWxLZXkgPSBqUXVlcnkuZXhwYW5kbywNCg0KCQkvLyBXZSBoYXZlIHRvIGhhbmRsZSBET00gbm9kZXMgYW5kIEpTIG9iamVjdHMgZGlmZmVyZW50bHkgYmVjYXVzZSBJRTYtNw0KCQkvLyBjYW4ndCBHQyBvYmplY3QgcmVmZXJlbmNlcyBwcm9wZXJseSBhY3Jvc3MgdGhlIERPTS1KUyBib3VuZGFyeQ0KCQlpc05vZGUgPSBlbGVtLm5vZGVUeXBlLA0KDQoJCS8vIE9ubHkgRE9NIG5vZGVzIG5lZWQgdGhlIGdsb2JhbCBqUXVlcnkgY2FjaGU7IEpTIG9iamVjdCBkYXRhIGlzDQoJCS8vIGF0dGFjaGVkIGRpcmVjdGx5IHRvIHRoZSBvYmplY3Qgc28gR0MgY2FuIG9jY3VyIGF1dG9tYXRpY2FsbHkNCgkJY2FjaGUgPSBpc05vZGUgPyBqUXVlcnkuY2FjaGUgOiBlbGVtLA0KDQoJCS8vIE9ubHkgZGVmaW5pbmcgYW4gSUQgZm9yIEpTIG9iamVjdHMgaWYgaXRzIGNhY2hlIGFscmVhZHkgZXhpc3RzIGFsbG93cw0KCQkvLyB0aGUgY29kZSB0byBzaG9ydGN1dCBvbiB0aGUgc2FtZSBwYXRoIGFzIGEgRE9NIG5vZGUgd2l0aCBubyBjYWNoZQ0KCQlpZCA9IGlzTm9kZSA/IGVsZW1bIGludGVybmFsS2V5IF0gOiBlbGVtWyBpbnRlcm5hbEtleSBdICYmIGludGVybmFsS2V5Ow0KDQoJLy8gQXZvaWQgZG9pbmcgYW55IG1vcmUgd29yayB0aGFuIHdlIG5lZWQgdG8gd2hlbiB0cnlpbmcgdG8gZ2V0IGRhdGEgb24gYW4NCgkvLyBvYmplY3QgdGhhdCBoYXMgbm8gZGF0YSBhdCBhbGwNCglpZiAoICghaWQgfHwgIWNhY2hlW2lkXSB8fCAoIXB2dCAmJiAhY2FjaGVbaWRdLmRhdGEpKSAmJiBkYXRhID09PSB1bmRlZmluZWQgJiYgdHlwZW9mIG5hbWUgPT09ICJzdHJpbmciICkgew0KCQlyZXR1cm47DQoJfQ0KDQoJaWYgKCAhaWQgKSB7DQoJCS8vIE9ubHkgRE9NIG5vZGVzIG5lZWQgYSBuZXcgdW5pcXVlIElEIGZvciBlYWNoIGVsZW1lbnQgc2luY2UgdGhlaXIgZGF0YQ0KCQkvLyBlbmRzIHVwIGluIHRoZSBnbG9iYWwgY2FjaGUNCgkJaWYgKCBpc05vZGUgKSB7DQoJCQlpZCA9IGVsZW1bIGludGVybmFsS2V5IF0gPSBjb3JlX2RlbGV0ZWRJZHMucG9wKCkgfHwgalF1ZXJ5Lmd1aWQrKzsNCgkJfSBlbHNlIHsNCgkJCWlkID0gaW50ZXJuYWxLZXk7DQoJCX0NCgl9DQoNCglpZiAoICFjYWNoZVsgaWQgXSApIHsNCgkJLy8gQXZvaWQgZXhwb3NpbmcgalF1ZXJ5IG1ldGFkYXRhIG9uIHBsYWluIEpTIG9iamVjdHMgd2hlbiB0aGUgb2JqZWN0DQoJCS8vIGlzIHNlcmlhbGl6ZWQgdXNpbmcgSlNPTi5zdHJpbmdpZnkNCgkJY2FjaGVbIGlkIF0gPSBpc05vZGUgPyB7fSA6IHsgdG9KU09OOiBqUXVlcnkubm9vcCB9Ow0KCX0NCg0KCS8vIEFuIG9iamVjdCBjYW4gYmUgcGFzc2VkIHRvIGpRdWVyeS5kYXRhIGluc3RlYWQgb2YgYSBrZXkvdmFsdWUgcGFpcjsgdGhpcyBnZXRzDQoJLy8gc2hhbGxvdyBjb3BpZWQgb3ZlciBvbnRvIHRoZSBleGlzdGluZyBjYWNoZQ0KCWlmICggdHlwZW9mIG5hbWUgPT09ICJvYmplY3QiIHx8IHR5cGVvZiBuYW1lID09PSAiZnVuY3Rpb24iICkgew0KCQlpZiAoIHB2dCApIHsNCgkJCWNhY2hlWyBpZCBdID0galF1ZXJ5LmV4dGVuZCggY2FjaGVbIGlkIF0sIG5hbWUgKTsNCgkJfSBlbHNlIHsNCgkJCWNhY2hlWyBpZCBdLmRhdGEgPSBqUXVlcnkuZXh0ZW5kKCBjYWNoZVsgaWQgXS5kYXRhLCBuYW1lICk7DQoJCX0NCgl9DQoNCgl0aGlzQ2FjaGUgPSBjYWNoZVsgaWQgXTsNCg0KCS8vIGpRdWVyeSBkYXRhKCkgaXMgc3RvcmVkIGluIGEgc2VwYXJhdGUgb2JqZWN0IGluc2lkZSB0aGUgb2JqZWN0J3MgaW50ZXJuYWwgZGF0YQ0KCS8vIGNhY2hlIGluIG9yZGVyIHRvIGF2b2lkIGtleSBjb2xsaXNpb25zIGJldHdlZW4gaW50ZXJuYWwgZGF0YSBhbmQgdXNlci1kZWZpbmVkDQoJLy8gZGF0YS4NCglpZiAoICFwdnQgKSB7DQoJCWlmICggIXRoaXNDYWNoZS5kYXRhICkgew0KCQkJdGhpc0NhY2hlLmRhdGEgPSB7fTsNCgkJfQ0KDQoJCXRoaXNDYWNoZSA9IHRoaXNDYWNoZS5kYXRhOw0KCX0NCg0KCWlmICggZGF0YSAhPT0gdW5kZWZpbmVkICkgew0KCQl0aGlzQ2FjaGVbIGpRdWVyeS5jYW1lbENhc2UoIG5hbWUgKSBdID0gZGF0YTsNCgl9DQoNCgkvLyBDaGVjayBmb3IgYm90aCBjb252ZXJ0ZWQtdG8tY2FtZWwgYW5kIG5vbi1jb252ZXJ0ZWQgZGF0YSBwcm9wZXJ0eSBuYW1lcw0KCS8vIElmIGEgZGF0YSBwcm9wZXJ0eSB3YXMgc3BlY2lmaWVkDQoJaWYgKCB0eXBlb2YgbmFtZSA9PT0gInN0cmluZyIgKSB7DQoNCgkJLy8gRmlyc3QgVHJ5IHRvIGZpbmQgYXMtaXMgcHJvcGVydHkgZGF0YQ0KCQlyZXQgPSB0aGlzQ2FjaGVbIG5hbWUgXTsNCg0KCQkvLyBUZXN0IGZvciBudWxsfHVuZGVmaW5lZCBwcm9wZXJ0eSBkYXRhDQoJCWlmICggcmV0ID09IG51bGwgKSB7DQoNCgkJCS8vIFRyeSB0byBmaW5kIHRoZSBjYW1lbENhc2VkIHByb3BlcnR5DQoJCQlyZXQgPSB0aGlzQ2FjaGVbIGpRdWVyeS5jYW1lbENhc2UoIG5hbWUgKSBdOw0KCQl9DQoJfSBlbHNlIHsNCgkJcmV0ID0gdGhpc0NhY2hlOw0KCX0NCg0KCXJldHVybiByZXQ7DQp9DQoNCmZ1bmN0aW9uIGludGVybmFsUmVtb3ZlRGF0YSggZWxlbSwgbmFtZSwgcHZ0ICkgew0KCWlmICggIWpRdWVyeS5hY2NlcHREYXRhKCBlbGVtICkgKSB7DQoJCXJldHVybjsNCgl9DQoNCgl2YXIgdGhpc0NhY2hlLCBpLA0KCQlpc05vZGUgPSBlbGVtLm5vZGVUeXBlLA0KDQoJCS8vIFNlZSBqUXVlcnkuZGF0YSBmb3IgbW9yZSBpbmZvcm1hdGlvbg0KCQljYWNoZSA9IGlzTm9kZSA/IGpRdWVyeS5jYWNoZSA6IGVsZW0sDQoJCWlkID0gaXNOb2RlID8gZWxlbVsgalF1ZXJ5LmV4cGFuZG8gXSA6IGpRdWVyeS5leHBhbmRvOw0KDQoJLy8gSWYgdGhlcmUgaXMgYWxyZWFkeSBubyBjYWNoZSBlbnRyeSBmb3IgdGhpcyBvYmplY3QsIHRoZXJlIGlzIG5vDQoJLy8gcHVycG9zZSBpbiBjb250aW51aW5nDQoJaWYgKCAhY2FjaGVbIGlkIF0gKSB7DQoJCXJldHVybjsNCgl9DQoNCglpZiAoIG5hbWUgKSB7DQoNCgkJdGhpc0NhY2hlID0gcHZ0ID8gY2FjaGVbIGlkIF0gOiBjYWNoZVsgaWQgXS5kYXRhOw0KDQoJCWlmICggdGhpc0NhY2hlICkgew0KDQoJCQkvLyBTdXBwb3J0IGFycmF5IG9yIHNwYWNlIHNlcGFyYXRlZCBzdHJpbmcgbmFtZXMgZm9yIGRhdGEga2V5cw0KCQkJaWYgKCAhalF1ZXJ5LmlzQXJyYXkoIG5hbWUgKSApIHsNCg0KCQkJCS8vIHRyeSB0aGUgc3RyaW5nIGFzIGEga2V5IGJlZm9yZSBhbnkgbWFuaXB1bGF0aW9uDQoJCQkJaWYgKCBuYW1lIGluIHRoaXNDYWNoZSApIHsNCgkJCQkJbmFtZSA9IFsgbmFtZSBdOw0KCQkJCX0gZWxzZSB7DQoNCgkJCQkJLy8gc3BsaXQgdGhlIGNhbWVsIGNhc2VkIHZlcnNpb24gYnkgc3BhY2VzIHVubGVzcyBhIGtleSB3aXRoIHRoZSBzcGFjZXMgZXhpc3RzDQoJCQkJCW5hbWUgPSBqUXVlcnkuY2FtZWxDYXNlKCBuYW1lICk7DQoJCQkJCWlmICggbmFtZSBpbiB0aGlzQ2FjaGUgKSB7DQoJCQkJCQluYW1lID0gWyBuYW1lIF07DQoJCQkJCX0gZWxzZSB7DQoJCQkJCQluYW1lID0gbmFtZS5zcGxpdCgiICIpOw0KCQkJCQl9DQoJCQkJfQ0KCQkJfSBlbHNlIHsNCgkJCQkvLyBJZiAibmFtZSIgaXMgYW4gYXJyYXkgb2Yga2V5cy4uLg0KCQkJCS8vIFdoZW4gZGF0YSBpcyBpbml0aWFsbHkgY3JlYXRlZCwgdmlhICgia2V5IiwgInZhbCIpIHNpZ25hdHVyZSwNCgkJCQkvLyBrZXlzIHdpbGwgYmUgY29udmVydGVkIHRvIGNhbWVsQ2FzZS4NCgkJCQkvLyBTaW5jZSB0aGVyZSBpcyBubyB3YXkgdG8gdGVsbCBfaG93XyBhIGtleSB3YXMgYWRkZWQsIHJlbW92ZQ0KCQkJCS8vIGJvdGggcGxhaW4ga2V5IGFuZCBjYW1lbENhc2Uga2V5LiAjMTI3ODYNCgkJCQkvLyBUaGlzIHdpbGwgb25seSBwZW5hbGl6ZSB0aGUgYXJyYXkgYXJndW1lbnQgcGF0aC4NCgkJCQluYW1lID0gbmFtZS5jb25jYXQoIGpRdWVyeS5tYXAoIG5hbWUsIGpRdWVyeS5jYW1lbENhc2UgKSApOw0KCQkJfQ0KDQoJCQlpID0gbmFtZS5sZW5ndGg7DQoJCQl3aGlsZSAoIGktLSApIHsNCgkJCQlkZWxldGUgdGhpc0NhY2hlWyBuYW1lW2ldIF07DQoJCQl9DQoNCgkJCS8vIElmIHRoZXJlIGlzIG5vIGRhdGEgbGVmdCBpbiB0aGUgY2FjaGUsIHdlIHdhbnQgdG8gY29udGludWUNCgkJCS8vIGFuZCBsZXQgdGhlIGNhY2hlIG9iamVjdCBpdHNlbGYgZ2V0IGRlc3Ryb3llZA0KCQkJaWYgKCBwdnQgPyAhaXNFbXB0eURhdGFPYmplY3QodGhpc0NhY2hlKSA6ICFqUXVlcnkuaXNFbXB0eU9iamVjdCh0aGlzQ2FjaGUpICkgew0KCQkJCXJldHVybjsNCgkJCX0NCgkJfQ0KCX0NCg0KCS8vIFNlZSBqUXVlcnkuZGF0YSBmb3IgbW9yZSBpbmZvcm1hdGlvbg0KCWlmICggIXB2dCApIHsNCgkJZGVsZXRlIGNhY2hlWyBpZCBdLmRhdGE7DQoNCgkJLy8gRG9uJ3QgZGVzdHJveSB0aGUgcGFyZW50IGNhY2hlIHVubGVzcyB0aGUgaW50ZXJuYWwgZGF0YSBvYmplY3QNCgkJLy8gaGFkIGJlZW4gdGhlIG9ubHkgdGhpbmcgbGVmdCBpbiBpdA0KCQlpZiAoICFpc0VtcHR5RGF0YU9iamVjdCggY2FjaGVbIGlkIF0gKSApIHsNCgkJCXJldHVybjsNCgkJfQ0KCX0NCg0KCS8vIERlc3Ryb3kgdGhlIGNhY2hlDQoJaWYgKCBpc05vZGUgKSB7DQoJCWpRdWVyeS5jbGVhbkRhdGEoIFsgZWxlbSBdLCB0cnVlICk7DQoNCgkvLyBVc2UgZGVsZXRlIHdoZW4gc3VwcG9ydGVkIGZvciBleHBhbmRvcyBvciBgY2FjaGVgIGlzIG5vdCBhIHdpbmRvdyBwZXIgaXNXaW5kb3cgKCMxMDA4MCkNCgkvKiBqc2hpbnQgZXFlcWVxOiBmYWxzZSAqLw0KCX0gZWxzZSBpZiAoIGpRdWVyeS5zdXBwb3J0LmRlbGV0ZUV4cGFuZG8gfHwgY2FjaGUgIT0gY2FjaGUud2luZG93ICkgew0KCQkvKiBqc2hpbnQgZXFlcWVxOiB0cnVlICovDQoJCWRlbGV0ZSBjYWNoZVsgaWQgXTsNCg0KCS8vIFdoZW4gYWxsIGVsc2UgZmFpbHMsIG51bGwNCgl9IGVsc2Ugew0KCQljYWNoZVsgaWQgXSA9IG51bGw7DQoJfQ0KfQ0KDQpqUXVlcnkuZXh0ZW5kKHsNCgljYWNoZToge30sDQoNCgkvLyBUaGUgZm9sbG93aW5nIGVsZW1lbnRzIHRocm93IHVuY2F0Y2hhYmxlIGV4Y2VwdGlvbnMgaWYgeW91DQoJLy8gYXR0ZW1wdCB0byBhZGQgZXhwYW5kbyBwcm9wZXJ0aWVzIHRvIHRoZW0uDQoJbm9EYXRhOiB7DQoJCSJhcHBsZXQiOiB0cnVlLA0KCQkiZW1iZWQiOiB0cnVlLA0KCQkvLyBCYW4gYWxsIG9iamVjdHMgZXhjZXB0IGZvciBGbGFzaCAod2hpY2ggaGFuZGxlIGV4cGFuZG9zKQ0KCQkib2JqZWN0IjogImNsc2lkOkQyN0NEQjZFLUFFNkQtMTFjZi05NkI4LTQ0NDU1MzU0MDAwMCINCgl9LA0KDQoJaGFzRGF0YTogZnVuY3Rpb24oIGVsZW0gKSB7DQoJCWVsZW0gPSBlbGVtLm5vZGVUeXBlID8galF1ZXJ5LmNhY2hlWyBlbGVtW2pRdWVyeS5leHBhbmRvXSBdIDogZWxlbVsgalF1ZXJ5LmV4cGFuZG8gXTsNCgkJcmV0dXJuICEhZWxlbSAmJiAhaXNFbXB0eURhdGFPYmplY3QoIGVsZW0gKTsNCgl9LA0KDQoJZGF0YTogZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGRhdGEgKSB7DQoJCXJldHVybiBpbnRlcm5hbERhdGEoIGVsZW0sIG5hbWUsIGRhdGEgKTsNCgl9LA0KDQoJcmVtb3ZlRGF0YTogZnVuY3Rpb24oIGVsZW0sIG5hbWUgKSB7DQoJCXJldHVybiBpbnRlcm5hbFJlbW92ZURhdGEoIGVsZW0sIG5hbWUgKTsNCgl9LA0KDQoJLy8gRm9yIGludGVybmFsIHVzZSBvbmx5Lg0KCV9kYXRhOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgZGF0YSApIHsNCgkJcmV0dXJuIGludGVybmFsRGF0YSggZWxlbSwgbmFtZSwgZGF0YSwgdHJ1ZSApOw0KCX0sDQoNCglfcmVtb3ZlRGF0YTogZnVuY3Rpb24oIGVsZW0sIG5hbWUgKSB7DQoJCXJldHVybiBpbnRlcm5hbFJlbW92ZURhdGEoIGVsZW0sIG5hbWUsIHRydWUgKTsNCgl9LA0KDQoJLy8gQSBtZXRob2QgZm9yIGRldGVybWluaW5nIGlmIGEgRE9NIG5vZGUgY2FuIGhhbmRsZSB0aGUgZGF0YSBleHBhbmRvDQoJYWNjZXB0RGF0YTogZnVuY3Rpb24oIGVsZW0gKSB7DQoJCS8vIERvIG5vdCBzZXQgZGF0YSBvbiBub24tZWxlbWVudCBiZWNhdXNlIGl0IHdpbGwgbm90IGJlIGNsZWFyZWQgKCM4MzM1KS4NCgkJaWYgKCBlbGVtLm5vZGVUeXBlICYmIGVsZW0ubm9kZVR5cGUgIT09IDEgJiYgZWxlbS5ub2RlVHlwZSAhPT0gOSApIHsNCgkJCXJldHVybiBmYWxzZTsNCgkJfQ0KDQoJCXZhciBub0RhdGEgPSBlbGVtLm5vZGVOYW1lICYmIGpRdWVyeS5ub0RhdGFbIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSBdOw0KDQoJCS8vIG5vZGVzIGFjY2VwdCBkYXRhIHVubGVzcyBvdGhlcndpc2Ugc3BlY2lmaWVkOyByZWplY3Rpb24gY2FuIGJlIGNvbmRpdGlvbmFsDQoJCXJldHVybiAhbm9EYXRhIHx8IG5vRGF0YSAhPT0gdHJ1ZSAmJiBlbGVtLmdldEF0dHJpYnV0ZSgiY2xhc3NpZCIpID09PSBub0RhdGE7DQoJfQ0KfSk7DQoNCmpRdWVyeS5mbi5leHRlbmQoew0KCWRhdGE6IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgew0KCQl2YXIgYXR0cnMsIG5hbWUsDQoJCQlkYXRhID0gbnVsbCwNCgkJCWkgPSAwLA0KCQkJZWxlbSA9IHRoaXNbMF07DQoNCgkJLy8gU3BlY2lhbCBleHBlY3Rpb25zIG9mIC5kYXRhIGJhc2ljYWxseSB0aHdhcnQgalF1ZXJ5LmFjY2VzcywNCgkJLy8gc28gaW1wbGVtZW50IHRoZSByZWxldmFudCBiZWhhdmlvciBvdXJzZWx2ZXMNCg0KCQkvLyBHZXRzIGFsbCB2YWx1ZXMNCgkJaWYgKCBrZXkgPT09IHVuZGVmaW5lZCApIHsNCgkJCWlmICggdGhpcy5sZW5ndGggKSB7DQoJCQkJZGF0YSA9IGpRdWVyeS5kYXRhKCBlbGVtICk7DQoNCgkJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgIWpRdWVyeS5fZGF0YSggZWxlbSwgInBhcnNlZEF0dHJzIiApICkgew0KCQkJCQlhdHRycyA9IGVsZW0uYXR0cmlidXRlczsNCgkJCQkJZm9yICggOyBpIDwgYXR0cnMubGVuZ3RoOyBpKysgKSB7DQoJCQkJCQluYW1lID0gYXR0cnNbaV0ubmFtZTsNCg0KCQkJCQkJaWYgKCBuYW1lLmluZGV4T2YoImRhdGEtIikgPT09IDAgKSB7DQoJCQkJCQkJbmFtZSA9IGpRdWVyeS5jYW1lbENhc2UoIG5hbWUuc2xpY2UoNSkgKTsNCg0KCQkJCQkJCWRhdGFBdHRyKCBlbGVtLCBuYW1lLCBkYXRhWyBuYW1lIF0gKTsNCgkJCQkJCX0NCgkJCQkJfQ0KCQkJCQlqUXVlcnkuX2RhdGEoIGVsZW0sICJwYXJzZWRBdHRycyIsIHRydWUgKTsNCgkJCQl9DQoJCQl9DQoNCgkJCXJldHVybiBkYXRhOw0KCQl9DQoNCgkJLy8gU2V0cyBtdWx0aXBsZSB2YWx1ZXMNCgkJaWYgKCB0eXBlb2Yga2V5ID09PSAib2JqZWN0IiApIHsNCgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7DQoJCQkJalF1ZXJ5LmRhdGEoIHRoaXMsIGtleSApOw0KCQkJfSk7DQoJCX0NCg0KCQlyZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA+IDEgPw0KDQoJCQkvLyBTZXRzIG9uZSB2YWx1ZQ0KCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgew0KCQkJCWpRdWVyeS5kYXRhKCB0aGlzLCBrZXksIHZhbHVlICk7DQoJCQl9KSA6DQoNCgkJCS8vIEdldHMgb25lIHZhbHVlDQoJCQkvLyBUcnkgdG8gZmV0Y2ggYW55IGludGVybmFsbHkgc3RvcmVkIGRhdGEgZmlyc3QNCgkJCWVsZW0gPyBkYXRhQXR0ciggZWxlbSwga2V5LCBqUXVlcnkuZGF0YSggZWxlbSwga2V5ICkgKSA6IG51bGw7DQoJfSwNCg0KCXJlbW92ZURhdGE6IGZ1bmN0aW9uKCBrZXkgKSB7DQoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7DQoJCQlqUXVlcnkucmVtb3ZlRGF0YSggdGhpcywga2V5ICk7DQoJCX0pOw0KCX0NCn0pOw0KDQpmdW5jdGlvbiBkYXRhQXR0ciggZWxlbSwga2V5LCBkYXRhICkgew0KCS8vIElmIG5vdGhpbmcgd2FzIGZvdW5kIGludGVybmFsbHksIHRyeSB0byBmZXRjaCBhbnkNCgkvLyBkYXRhIGZyb20gdGhlIEhUTUw1IGRhdGEtKiBhdHRyaWJ1dGUNCglpZiAoIGRhdGEgPT09IHVuZGVmaW5lZCAmJiBlbGVtLm5vZGVUeXBlID09PSAxICkgew0KDQoJCXZhciBuYW1lID0gImRhdGEtIiArIGtleS5yZXBsYWNlKCBybXVsdGlEYXNoLCAiLSQxIiApLnRvTG93ZXJDYXNlKCk7DQoNCgkJZGF0YSA9IGVsZW0uZ2V0QXR0cmlidXRlKCBuYW1lICk7DQoNCgkJaWYgKCB0eXBlb2YgZGF0YSA9PT0gInN0cmluZyIgKSB7DQoJCQl0cnkgew0KCQkJCWRhdGEgPSBkYXRhID09PSAidHJ1ZSIgPyB0cnVlIDoNCgkJCQkJZGF0YSA9PT0gImZhbHNlIiA/IGZhbHNlIDoNCgkJCQkJZGF0YSA9PT0gIm51bGwiID8gbnVsbCA6DQoJCQkJCS8vIE9ubHkgY29udmVydCB0byBhIG51bWJlciBpZiBpdCBkb2Vzbid0IGNoYW5nZSB0aGUgc3RyaW5nDQoJCQkJCStkYXRhICsgIiIgPT09IGRhdGEgPyArZGF0YSA6DQoJCQkJCXJicmFjZS50ZXN0KCBkYXRhICkgPyBqUXVlcnkucGFyc2VKU09OKCBkYXRhICkgOg0KCQkJCQkJZGF0YTsNCgkJCX0gY2F0Y2goIGUgKSB7fQ0KDQoJCQkvLyBNYWtlIHN1cmUgd2Ugc2V0IHRoZSBkYXRhIHNvIGl0IGlzbid0IGNoYW5nZWQgbGF0ZXINCgkJCWpRdWVyeS5kYXRhKCBlbGVtLCBrZXksIGRhdGEgKTsNCg0KCQl9IGVsc2Ugew0KCQkJZGF0YSA9IHVuZGVmaW5lZDsNCgkJfQ0KCX0NCg0KCXJldHVybiBkYXRhOw0KfQ0KDQovLyBjaGVja3MgYSBjYWNoZSBvYmplY3QgZm9yIGVtcHRpbmVzcw0KZnVuY3Rpb24gaXNFbXB0eURhdGFPYmplY3QoIG9iaiApIHsNCgl2YXIgbmFtZTsNCglmb3IgKCBuYW1lIGluIG9iaiApIHsNCg0KCQkvLyBpZiB0aGUgcHVibGljIGRhdGEgb2JqZWN0IGlzIGVtcHR5LCB0aGUgcHJpdmF0ZSBpcyBzdGlsbCBlbXB0eQ0KCQlpZiAoIG5hbWUgPT09ICJkYXRhIiAmJiBqUXVlcnkuaXNFbXB0eU9iamVjdCggb2JqW25hbWVdICkgKSB7DQoJCQljb250aW51ZTsNCgkJfQ0KCQlpZiAoIG5hbWUgIT09ICJ0b0pTT04iICkgew0KCQkJcmV0dXJuIGZhbHNlOw0KCQl9DQoJfQ0KDQoJcmV0dXJuIHRydWU7DQp9DQpqUXVlcnkuZXh0ZW5kKHsNCglxdWV1ZTogZnVuY3Rpb24oIGVsZW0sIHR5cGUsIGRhdGEgKSB7DQoJCXZhciBxdWV1ZTsNCg0KCQlpZiAoIGVsZW0gKSB7DQoJCQl0eXBlID0gKCB0eXBlIHx8ICJmeCIgKSArICJxdWV1ZSI7DQoJCQlxdWV1ZSA9IGpRdWVyeS5fZGF0YSggZWxlbSwgdHlwZSApOw0KDQoJCQkvLyBTcGVlZCB1cCBkZXF1ZXVlIGJ5IGdldHRpbmcgb3V0IHF1aWNrbHkgaWYgdGhpcyBpcyBqdXN0IGEgbG9va3VwDQoJCQlpZiAoIGRhdGEgKSB7DQoJCQkJaWYgKCAhcXVldWUgfHwgalF1ZXJ5LmlzQXJyYXkoZGF0YSkgKSB7DQoJCQkJCXF1ZXVlID0galF1ZXJ5Ll9kYXRhKCBlbGVtLCB0eXBlLCBqUXVlcnkubWFrZUFycmF5KGRhdGEpICk7DQoJCQkJfSBlbHNlIHsNCgkJCQkJcXVldWUucHVzaCggZGF0YSApOw0KCQkJCX0NCgkJCX0NCgkJCXJldHVybiBxdWV1ZSB8fCBbXTsNCgkJfQ0KCX0sDQoNCglkZXF1ZXVlOiBmdW5jdGlvbiggZWxlbSwgdHlwZSApIHsNCgkJdHlwZSA9IHR5cGUgfHwgImZ4IjsNCg0KCQl2YXIgcXVldWUgPSBqUXVlcnkucXVldWUoIGVsZW0sIHR5cGUgKSwNCgkJCXN0YXJ0TGVuZ3RoID0gcXVldWUubGVuZ3RoLA0KCQkJZm4gPSBxdWV1ZS5zaGlmdCgpLA0KCQkJaG9va3MgPSBqUXVlcnkuX3F1ZXVlSG9va3MoIGVsZW0sIHR5cGUgKSwNCgkJCW5leHQgPSBmdW5jdGlvbigpIHsNCgkJCQlqUXVlcnkuZGVxdWV1ZSggZWxlbSwgdHlwZSApOw0KCQkJfTsNCg0KCQkvLyBJZiB0aGUgZnggcXVldWUgaXMgZGVxdWV1ZWQsIGFsd2F5cyByZW1vdmUgdGhlIHByb2dyZXNzIHNlbnRpbmVsDQoJCWlmICggZm4gPT09ICJpbnByb2dyZXNzIiApIHsNCgkJCWZuID0gcXVldWUuc2hpZnQoKTsNCgkJCXN0YXJ0TGVuZ3RoLS07DQoJCX0NCg0KCQlpZiAoIGZuICkgew0KDQoJCQkvLyBBZGQgYSBwcm9ncmVzcyBzZW50aW5lbCB0byBwcmV2ZW50IHRoZSBmeCBxdWV1ZSBmcm9tIGJlaW5nDQoJCQkvLyBhdXRvbWF0aWNhbGx5IGRlcXVldWVkDQoJCQlpZiAoIHR5cGUgPT09ICJmeCIgKSB7DQoJCQkJcXVldWUudW5zaGlmdCggImlucHJvZ3Jlc3MiICk7DQoJCQl9DQoNCgkJCS8vIGNsZWFyIHVwIHRoZSBsYXN0IHF1ZXVlIHN0b3AgZnVuY3Rpb24NCgkJCWRlbGV0ZSBob29rcy5zdG9wOw0KCQkJZm4uY2FsbCggZWxlbSwgbmV4dCwgaG9va3MgKTsNCgkJfQ0KDQoJCWlmICggIXN0YXJ0TGVuZ3RoICYmIGhvb2tzICkgew0KCQkJaG9va3MuZW1wdHkuZmlyZSgpOw0KCQl9DQoJfSwNCg0KCS8vIG5vdCBpbnRlbmRlZCBmb3IgcHVibGljIGNvbnN1bXB0aW9uIC0gZ2VuZXJhdGVzIGEgcXVldWVIb29rcyBvYmplY3QsIG9yIHJldHVybnMgdGhlIGN1cnJlbnQgb25lDQoJX3F1ZXVlSG9va3M6IGZ1bmN0aW9uKCBlbGVtLCB0eXBlICkgew0KCQl2YXIga2V5ID0gdHlwZSArICJxdWV1ZUhvb2tzIjsNCgkJcmV0dXJuIGpRdWVyeS5fZGF0YSggZWxlbSwga2V5ICkgfHwgalF1ZXJ5Ll9kYXRhKCBlbGVtLCBrZXksIHsNCgkJCWVtcHR5OiBqUXVlcnkuQ2FsbGJhY2tzKCJvbmNlIG1lbW9yeSIpLmFkZChmdW5jdGlvbigpIHsNCgkJCQlqUXVlcnkuX3JlbW92ZURhdGEoIGVsZW0sIHR5cGUgKyAicXVldWUiICk7DQoJCQkJalF1ZXJ5Ll9yZW1vdmVEYXRhKCBlbGVtLCBrZXkgKTsNCgkJCX0pDQoJCX0pOw0KCX0NCn0pOw0KDQpqUXVlcnkuZm4uZXh0ZW5kKHsNCglxdWV1ZTogZnVuY3Rpb24oIHR5cGUsIGRhdGEgKSB7DQoJCXZhciBzZXR0ZXIgPSAyOw0KDQoJCWlmICggdHlwZW9mIHR5cGUgIT09ICJzdHJpbmciICkgew0KCQkJZGF0YSA9IHR5cGU7DQoJCQl0eXBlID0gImZ4IjsNCgkJCXNldHRlci0tOw0KCQl9DQoNCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoIDwgc2V0dGVyICkgew0KCQkJcmV0dXJuIGpRdWVyeS5xdWV1ZSggdGhpc1swXSwgdHlwZSApOw0KCQl9DQoNCgkJcmV0dXJuIGRhdGEgPT09IHVuZGVmaW5lZCA/DQoJCQl0aGlzIDoNCgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsNCgkJCQl2YXIgcXVldWUgPSBqUXVlcnkucXVldWUoIHRoaXMsIHR5cGUsIGRhdGEgKTsNCg0KCQkJCS8vIGVuc3VyZSBhIGhvb2tzIGZvciB0aGlzIHF1ZXVlDQoJCQkJalF1ZXJ5Ll9xdWV1ZUhvb2tzKCB0aGlzLCB0eXBlICk7DQoNCgkJCQlpZiAoIHR5cGUgPT09ICJmeCIgJiYgcXVldWVbMF0gIT09ICJpbnByb2dyZXNzIiApIHsNCgkJCQkJalF1ZXJ5LmRlcXVldWUoIHRoaXMsIHR5cGUgKTsNCgkJCQl9DQoJCQl9KTsNCgl9LA0KCWRlcXVldWU6IGZ1bmN0aW9uKCB0eXBlICkgew0KCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgew0KCQkJalF1ZXJ5LmRlcXVldWUoIHRoaXMsIHR5cGUgKTsNCgkJfSk7DQoJfSwNCgkvLyBCYXNlZCBvZmYgb2YgdGhlIHBsdWdpbiBieSBDbGludCBIZWxmZXJzLCB3aXRoIHBlcm1pc3Npb24uDQoJLy8gaHR0cDovL2JsaW5kc2lnbmFscy5jb20vaW5kZXgucGhwLzIwMDkvMDcvanF1ZXJ5LWRlbGF5Lw0KCWRlbGF5OiBmdW5jdGlvbiggdGltZSwgdHlwZSApIHsNCgkJdGltZSA9IGpRdWVyeS5meCA/IGpRdWVyeS5meC5zcGVlZHNbIHRpbWUgXSB8fCB0aW1lIDogdGltZTsNCgkJdHlwZSA9IHR5cGUgfHwgImZ4IjsNCg0KCQlyZXR1cm4gdGhpcy5xdWV1ZSggdHlwZSwgZnVuY3Rpb24oIG5leHQsIGhvb2tzICkgew0KCQkJdmFyIHRpbWVvdXQgPSBzZXRUaW1lb3V0KCBuZXh0LCB0aW1lICk7DQoJCQlob29rcy5zdG9wID0gZnVuY3Rpb24oKSB7DQoJCQkJY2xlYXJUaW1lb3V0KCB0aW1lb3V0ICk7DQoJCQl9Ow0KCQl9KTsNCgl9LA0KCWNsZWFyUXVldWU6IGZ1bmN0aW9uKCB0eXBlICkgew0KCQlyZXR1cm4gdGhpcy5xdWV1ZSggdHlwZSB8fCAiZngiLCBbXSApOw0KCX0sDQoJLy8gR2V0IGEgcHJvbWlzZSByZXNvbHZlZCB3aGVuIHF1ZXVlcyBvZiBhIGNlcnRhaW4gdHlwZQ0KCS8vIGFyZSBlbXB0aWVkIChmeCBpcyB0aGUgdHlwZSBieSBkZWZhdWx0KQ0KCXByb21pc2U6IGZ1bmN0aW9uKCB0eXBlLCBvYmogKSB7DQoJCXZhciB0bXAsDQoJCQljb3VudCA9IDEsDQoJCQlkZWZlciA9IGpRdWVyeS5EZWZlcnJlZCgpLA0KCQkJZWxlbWVudHMgPSB0aGlzLA0KCQkJaSA9IHRoaXMubGVuZ3RoLA0KCQkJcmVzb2x2ZSA9IGZ1bmN0aW9uKCkgew0KCQkJCWlmICggISggLS1jb3VudCApICkgew0KCQkJCQlkZWZlci5yZXNvbHZlV2l0aCggZWxlbWVudHMsIFsgZWxlbWVudHMgXSApOw0KCQkJCX0NCgkJCX07DQoNCgkJaWYgKCB0eXBlb2YgdHlwZSAhPT0gInN0cmluZyIgKSB7DQoJCQlvYmogPSB0eXBlOw0KCQkJdHlwZSA9IHVuZGVmaW5lZDsNCgkJfQ0KCQl0eXBlID0gdHlwZSB8fCAiZngiOw0KDQoJCXdoaWxlKCBpLS0gKSB7DQoJCQl0bXAgPSBqUXVlcnkuX2RhdGEoIGVsZW1lbnRzWyBpIF0sIHR5cGUgKyAicXVldWVIb29rcyIgKTsNCgkJCWlmICggdG1wICYmIHRtcC5lbXB0eSApIHsNCgkJCQljb3VudCsrOw0KCQkJCXRtcC5lbXB0eS5hZGQoIHJlc29sdmUgKTsNCgkJCX0NCgkJfQ0KCQlyZXNvbHZlKCk7DQoJCXJldHVybiBkZWZlci5wcm9taXNlKCBvYmogKTsNCgl9DQp9KTsNCnZhciBub2RlSG9vaywgYm9vbEhvb2ssDQoJcmNsYXNzID0gL1tcdFxyXG5cZl0vZywNCglycmV0dXJuID0gL1xyL2csDQoJcmZvY3VzYWJsZSA9IC9eKD86aW5wdXR8c2VsZWN0fHRleHRhcmVhfGJ1dHRvbnxvYmplY3QpJC9pLA0KCXJjbGlja2FibGUgPSAvXig/OmF8YXJlYSkkL2ksDQoJcnVzZURlZmF1bHQgPSAvXig/OmNoZWNrZWR8c2VsZWN0ZWQpJC9pLA0KCWdldFNldEF0dHJpYnV0ZSA9IGpRdWVyeS5zdXBwb3J0LmdldFNldEF0dHJpYnV0ZSwNCglnZXRTZXRJbnB1dCA9IGpRdWVyeS5zdXBwb3J0LmlucHV0Ow0KDQpqUXVlcnkuZm4uZXh0ZW5kKHsNCglhdHRyOiBmdW5jdGlvbiggbmFtZSwgdmFsdWUgKSB7DQoJCXJldHVybiBqUXVlcnkuYWNjZXNzKCB0aGlzLCBqUXVlcnkuYXR0ciwgbmFtZSwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxICk7DQoJfSwNCg0KCXJlbW92ZUF0dHI6IGZ1bmN0aW9uKCBuYW1lICkgew0KCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgew0KCQkJalF1ZXJ5LnJlbW92ZUF0dHIoIHRoaXMsIG5hbWUgKTsNCgkJfSk7DQoJfSwNCg0KCXByb3A6IGZ1bmN0aW9uKCBuYW1lLCB2YWx1ZSApIHsNCgkJcmV0dXJuIGpRdWVyeS5hY2Nlc3MoIHRoaXMsIGpRdWVyeS5wcm9wLCBuYW1lLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCA+IDEgKTsNCgl9LA0KDQoJcmVtb3ZlUHJvcDogZnVuY3Rpb24oIG5hbWUgKSB7DQoJCW5hbWUgPSBqUXVlcnkucHJvcEZpeFsgbmFtZSBdIHx8IG5hbWU7DQoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7DQoJCQkvLyB0cnkvY2F0Y2ggaGFuZGxlcyBjYXNlcyB3aGVyZSBJRSBiYWxrcyAoc3VjaCBhcyByZW1vdmluZyBhIHByb3BlcnR5IG9uIHdpbmRvdykNCgkJCXRyeSB7DQoJCQkJdGhpc1sgbmFtZSBdID0gdW5kZWZpbmVkOw0KCQkJCWRlbGV0ZSB0aGlzWyBuYW1lIF07DQoJCQl9IGNhdGNoKCBlICkge30NCgkJfSk7DQoJfSwNCg0KCWFkZENsYXNzOiBmdW5jdGlvbiggdmFsdWUgKSB7DQoJCXZhciBjbGFzc2VzLCBlbGVtLCBjdXIsIGNsYXp6LCBqLA0KCQkJaSA9IDAsDQoJCQlsZW4gPSB0aGlzLmxlbmd0aCwNCgkJCXByb2NlZWQgPSB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciICYmIHZhbHVlOw0KDQoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHZhbHVlICkgKSB7DQoJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCBqICkgew0KCQkJCWpRdWVyeSggdGhpcyApLmFkZENsYXNzKCB2YWx1ZS5jYWxsKCB0aGlzLCBqLCB0aGlzLmNsYXNzTmFtZSApICk7DQoJCQl9KTsNCgkJfQ0KDQoJCWlmICggcHJvY2VlZCApIHsNCgkJCS8vIFRoZSBkaXNqdW5jdGlvbiBoZXJlIGlzIGZvciBiZXR0ZXIgY29tcHJlc3NpYmlsaXR5IChzZWUgcmVtb3ZlQ2xhc3MpDQoJCQljbGFzc2VzID0gKCB2YWx1ZSB8fCAiIiApLm1hdGNoKCBjb3JlX3Jub3R3aGl0ZSApIHx8IFtdOw0KDQoJCQlmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsNCgkJCQllbGVtID0gdGhpc1sgaSBdOw0KCQkJCWN1ciA9IGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgKCBlbGVtLmNsYXNzTmFtZSA/DQoJCQkJCSggIiAiICsgZWxlbS5jbGFzc05hbWUgKyAiICIgKS5yZXBsYWNlKCByY2xhc3MsICIgIiApIDoNCgkJCQkJIiAiDQoJCQkJKTsNCg0KCQkJCWlmICggY3VyICkgew0KCQkJCQlqID0gMDsNCgkJCQkJd2hpbGUgKCAoY2xhenogPSBjbGFzc2VzW2orK10pICkgew0KCQkJCQkJaWYgKCBjdXIuaW5kZXhPZiggIiAiICsgY2xhenogKyAiICIgKSA8IDAgKSB7DQoJCQkJCQkJY3VyICs9IGNsYXp6ICsgIiAiOw0KCQkJCQkJfQ0KCQkJCQl9DQoJCQkJCWVsZW0uY2xhc3NOYW1lID0galF1ZXJ5LnRyaW0oIGN1ciApOw0KDQoJCQkJfQ0KCQkJfQ0KCQl9DQoNCgkJcmV0dXJuIHRoaXM7DQoJfSwNCg0KCXJlbW92ZUNsYXNzOiBmdW5jdGlvbiggdmFsdWUgKSB7DQoJCXZhciBjbGFzc2VzLCBlbGVtLCBjdXIsIGNsYXp6LCBqLA0KCQkJaSA9IDAsDQoJCQlsZW4gPSB0aGlzLmxlbmd0aCwNCgkJCXByb2NlZWQgPSBhcmd1bWVudHMubGVuZ3RoID09PSAwIHx8IHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgJiYgdmFsdWU7DQoNCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsNCgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oIGogKSB7DQoJCQkJalF1ZXJ5KCB0aGlzICkucmVtb3ZlQ2xhc3MoIHZhbHVlLmNhbGwoIHRoaXMsIGosIHRoaXMuY2xhc3NOYW1lICkgKTsNCgkJCX0pOw0KCQl9DQoJCWlmICggcHJvY2VlZCApIHsNCgkJCWNsYXNzZXMgPSAoIHZhbHVlIHx8ICIiICkubWF0Y2goIGNvcmVfcm5vdHdoaXRlICkgfHwgW107DQoNCgkJCWZvciAoIDsgaSA8IGxlbjsgaSsrICkgew0KCQkJCWVsZW0gPSB0aGlzWyBpIF07DQoJCQkJLy8gVGhpcyBleHByZXNzaW9uIGlzIGhlcmUgZm9yIGJldHRlciBjb21wcmVzc2liaWxpdHkgKHNlZSBhZGRDbGFzcykNCgkJCQljdXIgPSBlbGVtLm5vZGVUeXBlID09PSAxICYmICggZWxlbS5jbGFzc05hbWUgPw0KCQkJCQkoICIgIiArIGVsZW0uY2xhc3NOYW1lICsgIiAiICkucmVwbGFjZSggcmNsYXNzLCAiICIgKSA6DQoJCQkJCSIiDQoJCQkJKTsNCg0KCQkJCWlmICggY3VyICkgew0KCQkJCQlqID0gMDsNCgkJCQkJd2hpbGUgKCAoY2xhenogPSBjbGFzc2VzW2orK10pICkgew0KCQkJCQkJLy8gUmVtb3ZlICphbGwqIGluc3RhbmNlcw0KCQkJCQkJd2hpbGUgKCBjdXIuaW5kZXhPZiggIiAiICsgY2xhenogKyAiICIgKSA+PSAwICkgew0KCQkJCQkJCWN1ciA9IGN1ci5yZXBsYWNlKCAiICIgKyBjbGF6eiArICIgIiwgIiAiICk7DQoJCQkJCQl9DQoJCQkJCX0NCgkJCQkJZWxlbS5jbGFzc05hbWUgPSB2YWx1ZSA/IGpRdWVyeS50cmltKCBjdXIgKSA6ICIiOw0KCQkJCX0NCgkJCX0NCgkJfQ0KDQoJCXJldHVybiB0aGlzOw0KCX0sDQoNCgl0b2dnbGVDbGFzczogZnVuY3Rpb24oIHZhbHVlLCBzdGF0ZVZhbCApIHsNCgkJdmFyIHR5cGUgPSB0eXBlb2YgdmFsdWU7DQoNCgkJaWYgKCB0eXBlb2Ygc3RhdGVWYWwgPT09ICJib29sZWFuIiAmJiB0eXBlID09PSAic3RyaW5nIiApIHsNCgkJCXJldHVybiBzdGF0ZVZhbCA/IHRoaXMuYWRkQ2xhc3MoIHZhbHVlICkgOiB0aGlzLnJlbW92ZUNsYXNzKCB2YWx1ZSApOw0KCQl9DQoNCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsNCgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oIGkgKSB7DQoJCQkJalF1ZXJ5KCB0aGlzICkudG9nZ2xlQ2xhc3MoIHZhbHVlLmNhbGwodGhpcywgaSwgdGhpcy5jbGFzc05hbWUsIHN0YXRlVmFsKSwgc3RhdGVWYWwgKTsNCgkJCX0pOw0KCQl9DQoNCgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsNCgkJCWlmICggdHlwZSA9PT0gInN0cmluZyIgKSB7DQoJCQkJLy8gdG9nZ2xlIGluZGl2aWR1YWwgY2xhc3MgbmFtZXMNCgkJCQl2YXIgY2xhc3NOYW1lLA0KCQkJCQlpID0gMCwNCgkJCQkJc2VsZiA9IGpRdWVyeSggdGhpcyApLA0KCQkJCQljbGFzc05hbWVzID0gdmFsdWUubWF0Y2goIGNvcmVfcm5vdHdoaXRlICkgfHwgW107DQoNCgkJCQl3aGlsZSAoIChjbGFzc05hbWUgPSBjbGFzc05hbWVzWyBpKysgXSkgKSB7DQoJCQkJCS8vIGNoZWNrIGVhY2ggY2xhc3NOYW1lIGdpdmVuLCBzcGFjZSBzZXBhcmF0ZWQgbGlzdA0KCQkJCQlpZiAoIHNlbGYuaGFzQ2xhc3MoIGNsYXNzTmFtZSApICkgew0KCQkJCQkJc2VsZi5yZW1vdmVDbGFzcyggY2xhc3NOYW1lICk7DQoJCQkJCX0gZWxzZSB7DQoJCQkJCQlzZWxmLmFkZENsYXNzKCBjbGFzc05hbWUgKTsNCgkJCQkJfQ0KCQkJCX0NCg0KCQkJLy8gVG9nZ2xlIHdob2xlIGNsYXNzIG5hbWUNCgkJCX0gZWxzZSBpZiAoIHR5cGUgPT09IGNvcmVfc3RydW5kZWZpbmVkIHx8IHR5cGUgPT09ICJib29sZWFuIiApIHsNCgkJCQlpZiAoIHRoaXMuY2xhc3NOYW1lICkgew0KCQkJCQkvLyBzdG9yZSBjbGFzc05hbWUgaWYgc2V0DQoJCQkJCWpRdWVyeS5fZGF0YSggdGhpcywgIl9fY2xhc3NOYW1lX18iLCB0aGlzLmNsYXNzTmFtZSApOw0KCQkJCX0NCg0KCQkJCS8vIElmIHRoZSBlbGVtZW50IGhhcyBhIGNsYXNzIG5hbWUgb3IgaWYgd2UncmUgcGFzc2VkICJmYWxzZSIsDQoJCQkJLy8gdGhlbiByZW1vdmUgdGhlIHdob2xlIGNsYXNzbmFtZSAoaWYgdGhlcmUgd2FzIG9uZSwgdGhlIGFib3ZlIHNhdmVkIGl0KS4NCgkJCQkvLyBPdGhlcndpc2UgYnJpbmcgYmFjayB3aGF0ZXZlciB3YXMgcHJldmlvdXNseSBzYXZlZCAoaWYgYW55dGhpbmcpLA0KCQkJCS8vIGZhbGxpbmcgYmFjayB0byB0aGUgZW1wdHkgc3RyaW5nIGlmIG5vdGhpbmcgd2FzIHN0b3JlZC4NCgkJCQl0aGlzLmNsYXNzTmFtZSA9IHRoaXMuY2xhc3NOYW1lIHx8IHZhbHVlID09PSBmYWxzZSA/ICIiIDogalF1ZXJ5Ll9kYXRhKCB0aGlzLCAiX19jbGFzc05hbWVfXyIgKSB8fCAiIjsNCgkJCX0NCgkJfSk7DQoJfSwNCg0KCWhhc0NsYXNzOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7DQoJCXZhciBjbGFzc05hbWUgPSAiICIgKyBzZWxlY3RvciArICIgIiwNCgkJCWkgPSAwLA0KCQkJbCA9IHRoaXMubGVuZ3RoOw0KCQlmb3IgKCA7IGkgPCBsOyBpKysgKSB7DQoJCQlpZiAoIHRoaXNbaV0ubm9kZVR5cGUgPT09IDEgJiYgKCIgIiArIHRoaXNbaV0uY2xhc3NOYW1lICsgIiAiKS5yZXBsYWNlKHJjbGFzcywgIiAiKS5pbmRleE9mKCBjbGFzc05hbWUgKSA+PSAwICkgew0KCQkJCXJldHVybiB0cnVlOw0KCQkJfQ0KCQl9DQoNCgkJcmV0dXJuIGZhbHNlOw0KCX0sDQoNCgl2YWw6IGZ1bmN0aW9uKCB2YWx1ZSApIHsNCgkJdmFyIHJldCwgaG9va3MsIGlzRnVuY3Rpb24sDQoJCQllbGVtID0gdGhpc1swXTsNCg0KCQlpZiAoICFhcmd1bWVudHMubGVuZ3RoICkgew0KCQkJaWYgKCBlbGVtICkgew0KCQkJCWhvb2tzID0galF1ZXJ5LnZhbEhvb2tzWyBlbGVtLnR5cGUgXSB8fCBqUXVlcnkudmFsSG9va3NbIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSBdOw0KDQoJCQkJaWYgKCBob29rcyAmJiAiZ2V0IiBpbiBob29rcyAmJiAocmV0ID0gaG9va3MuZ2V0KCBlbGVtLCAidmFsdWUiICkpICE9PSB1bmRlZmluZWQgKSB7DQoJCQkJCXJldHVybiByZXQ7DQoJCQkJfQ0KDQoJCQkJcmV0ID0gZWxlbS52YWx1ZTsNCg0KCQkJCXJldHVybiB0eXBlb2YgcmV0ID09PSAic3RyaW5nIiA/DQoJCQkJCS8vIGhhbmRsZSBtb3N0IGNvbW1vbiBzdHJpbmcgY2FzZXMNCgkJCQkJcmV0LnJlcGxhY2UocnJldHVybiwgIiIpIDoNCgkJCQkJLy8gaGFuZGxlIGNhc2VzIHdoZXJlIHZhbHVlIGlzIG51bGwvdW5kZWYgb3IgbnVtYmVyDQoJCQkJCXJldCA9PSBudWxsID8gIiIgOiByZXQ7DQoJCQl9DQoNCgkJCXJldHVybjsNCgkJfQ0KDQoJCWlzRnVuY3Rpb24gPSBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKTsNCg0KCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCBpICkgew0KCQkJdmFyIHZhbDsNCg0KCQkJaWYgKCB0aGlzLm5vZGVUeXBlICE9PSAxICkgew0KCQkJCXJldHVybjsNCgkJCX0NCg0KCQkJaWYgKCBpc0Z1bmN0aW9uICkgew0KCQkJCXZhbCA9IHZhbHVlLmNhbGwoIHRoaXMsIGksIGpRdWVyeSggdGhpcyApLnZhbCgpICk7DQoJCQl9IGVsc2Ugew0KCQkJCXZhbCA9IHZhbHVlOw0KCQkJfQ0KDQoJCQkvLyBUcmVhdCBudWxsL3VuZGVmaW5lZCBhcyAiIjsgY29udmVydCBudW1iZXJzIHRvIHN0cmluZw0KCQkJaWYgKCB2YWwgPT0gbnVsbCApIHsNCgkJCQl2YWwgPSAiIjsNCgkJCX0gZWxzZSBpZiAoIHR5cGVvZiB2YWwgPT09ICJudW1iZXIiICkgew0KCQkJCXZhbCArPSAiIjsNCgkJCX0gZWxzZSBpZiAoIGpRdWVyeS5pc0FycmF5KCB2YWwgKSApIHsNCgkJCQl2YWwgPSBqUXVlcnkubWFwKHZhbCwgZnVuY3Rpb24gKCB2YWx1ZSApIHsNCgkJCQkJcmV0dXJuIHZhbHVlID09IG51bGwgPyAiIiA6IHZhbHVlICsgIiI7DQoJCQkJfSk7DQoJCQl9DQoNCgkJCWhvb2tzID0galF1ZXJ5LnZhbEhvb2tzWyB0aGlzLnR5cGUgXSB8fCBqUXVlcnkudmFsSG9va3NbIHRoaXMubm9kZU5hbWUudG9Mb3dlckNhc2UoKSBdOw0KDQoJCQkvLyBJZiBzZXQgcmV0dXJucyB1bmRlZmluZWQsIGZhbGwgYmFjayB0byBub3JtYWwgc2V0dGluZw0KCQkJaWYgKCAhaG9va3MgfHwgISgic2V0IiBpbiBob29rcykgfHwgaG9va3Muc2V0KCB0aGlzLCB2YWwsICJ2YWx1ZSIgKSA9PT0gdW5kZWZpbmVkICkgew0KCQkJCXRoaXMudmFsdWUgPSB2YWw7DQoJCQl9DQoJCX0pOw0KCX0NCn0pOw0KDQpqUXVlcnkuZXh0ZW5kKHsNCgl2YWxIb29rczogew0KCQlvcHRpb246IHsNCgkJCWdldDogZnVuY3Rpb24oIGVsZW0gKSB7DQoJCQkJLy8gVXNlIHByb3BlciBhdHRyaWJ1dGUgcmV0cmlldmFsKCM2OTMyLCAjMTIwNzIpDQoJCQkJdmFyIHZhbCA9IGpRdWVyeS5maW5kLmF0dHIoIGVsZW0sICJ2YWx1ZSIgKTsNCgkJCQlyZXR1cm4gdmFsICE9IG51bGwgPw0KCQkJCQl2YWwgOg0KCQkJCQllbGVtLnRleHQ7DQoJCQl9DQoJCX0sDQoJCXNlbGVjdDogew0KCQkJZ2V0OiBmdW5jdGlvbiggZWxlbSApIHsNCgkJCQl2YXIgdmFsdWUsIG9wdGlvbiwNCgkJCQkJb3B0aW9ucyA9IGVsZW0ub3B0aW9ucywNCgkJCQkJaW5kZXggPSBlbGVtLnNlbGVjdGVkSW5kZXgsDQoJCQkJCW9uZSA9IGVsZW0udHlwZSA9PT0gInNlbGVjdC1vbmUiIHx8IGluZGV4IDwgMCwNCgkJCQkJdmFsdWVzID0gb25lID8gbnVsbCA6IFtdLA0KCQkJCQltYXggPSBvbmUgPyBpbmRleCArIDEgOiBvcHRpb25zLmxlbmd0aCwNCgkJCQkJaSA9IGluZGV4IDwgMCA/DQoJCQkJCQltYXggOg0KCQkJCQkJb25lID8gaW5kZXggOiAwOw0KDQoJCQkJLy8gTG9vcCB0aHJvdWdoIGFsbCB0aGUgc2VsZWN0ZWQgb3B0aW9ucw0KCQkJCWZvciAoIDsgaSA8IG1heDsgaSsrICkgew0KCQkJCQlvcHRpb24gPSBvcHRpb25zWyBpIF07DQoNCgkJCQkJLy8gb2xkSUUgZG9lc24ndCB1cGRhdGUgc2VsZWN0ZWQgYWZ0ZXIgZm9ybSByZXNldCAoIzI1NTEpDQoJCQkJCWlmICggKCBvcHRpb24uc2VsZWN0ZWQgfHwgaSA9PT0gaW5kZXggKSAmJg0KCQkJCQkJCS8vIERvbid0IHJldHVybiBvcHRpb25zIHRoYXQgYXJlIGRpc2FibGVkIG9yIGluIGEgZGlzYWJsZWQgb3B0Z3JvdXANCgkJCQkJCQkoIGpRdWVyeS5zdXBwb3J0Lm9wdERpc2FibGVkID8gIW9wdGlvbi5kaXNhYmxlZCA6IG9wdGlvbi5nZXRBdHRyaWJ1dGUoImRpc2FibGVkIikgPT09IG51bGwgKSAmJg0KCQkJCQkJCSggIW9wdGlvbi5wYXJlbnROb2RlLmRpc2FibGVkIHx8ICFqUXVlcnkubm9kZU5hbWUoIG9wdGlvbi5wYXJlbnROb2RlLCAib3B0Z3JvdXAiICkgKSApIHsNCg0KCQkJCQkJLy8gR2V0IHRoZSBzcGVjaWZpYyB2YWx1ZSBmb3IgdGhlIG9wdGlvbg0KCQkJCQkJdmFsdWUgPSBqUXVlcnkoIG9wdGlvbiApLnZhbCgpOw0KDQoJCQkJCQkvLyBXZSBkb24ndCBuZWVkIGFuIGFycmF5IGZvciBvbmUgc2VsZWN0cw0KCQkJCQkJaWYgKCBvbmUgKSB7DQoJCQkJCQkJcmV0dXJuIHZhbHVlOw0KCQkJCQkJfQ0KDQoJCQkJCQkvLyBNdWx0aS1TZWxlY3RzIHJldHVybiBhbiBhcnJheQ0KCQkJCQkJdmFsdWVzLnB1c2goIHZhbHVlICk7DQoJCQkJCX0NCgkJCQl9DQoNCgkJCQlyZXR1cm4gdmFsdWVzOw0KCQkJfSwNCg0KCQkJc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUgKSB7DQoJCQkJdmFyIG9wdGlvblNldCwgb3B0aW9uLA0KCQkJCQlvcHRpb25zID0gZWxlbS5vcHRpb25zLA0KCQkJCQl2YWx1ZXMgPSBqUXVlcnkubWFrZUFycmF5KCB2YWx1ZSApLA0KCQkJCQlpID0gb3B0aW9ucy5sZW5ndGg7DQoNCgkJCQl3aGlsZSAoIGktLSApIHsNCgkJCQkJb3B0aW9uID0gb3B0aW9uc1sgaSBdOw0KCQkJCQlpZiAoIChvcHRpb24uc2VsZWN0ZWQgPSBqUXVlcnkuaW5BcnJheSggalF1ZXJ5KG9wdGlvbikudmFsKCksIHZhbHVlcyApID49IDApICkgew0KCQkJCQkJb3B0aW9uU2V0ID0gdHJ1ZTsNCgkJCQkJfQ0KCQkJCX0NCg0KCQkJCS8vIGZvcmNlIGJyb3dzZXJzIHRvIGJlaGF2ZSBjb25zaXN0ZW50bHkgd2hlbiBub24tbWF0Y2hpbmcgdmFsdWUgaXMgc2V0DQoJCQkJaWYgKCAhb3B0aW9uU2V0ICkgew0KCQkJCQllbGVtLnNlbGVjdGVkSW5kZXggPSAtMTsNCgkJCQl9DQoJCQkJcmV0dXJuIHZhbHVlczsNCgkJCX0NCgkJfQ0KCX0sDQoNCglhdHRyOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgdmFsdWUgKSB7DQoJCXZhciBob29rcywgcmV0LA0KCQkJblR5cGUgPSBlbGVtLm5vZGVUeXBlOw0KDQoJCS8vIGRvbid0IGdldC9zZXQgYXR0cmlidXRlcyBvbiB0ZXh0LCBjb21tZW50IGFuZCBhdHRyaWJ1dGUgbm9kZXMNCgkJaWYgKCAhZWxlbSB8fCBuVHlwZSA9PT0gMyB8fCBuVHlwZSA9PT0gOCB8fCBuVHlwZSA9PT0gMiApIHsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCS8vIEZhbGxiYWNrIHRvIHByb3Agd2hlbiBhdHRyaWJ1dGVzIGFyZSBub3Qgc3VwcG9ydGVkDQoJCWlmICggdHlwZW9mIGVsZW0uZ2V0QXR0cmlidXRlID09PSBjb3JlX3N0cnVuZGVmaW5lZCApIHsNCgkJCXJldHVybiBqUXVlcnkucHJvcCggZWxlbSwgbmFtZSwgdmFsdWUgKTsNCgkJfQ0KDQoJCS8vIEFsbCBhdHRyaWJ1dGVzIGFyZSBsb3dlcmNhc2UNCgkJLy8gR3JhYiBuZWNlc3NhcnkgaG9vayBpZiBvbmUgaXMgZGVmaW5lZA0KCQlpZiAoIG5UeXBlICE9PSAxIHx8ICFqUXVlcnkuaXNYTUxEb2MoIGVsZW0gKSApIHsNCgkJCW5hbWUgPSBuYW1lLnRvTG93ZXJDYXNlKCk7DQoJCQlob29rcyA9IGpRdWVyeS5hdHRySG9va3NbIG5hbWUgXSB8fA0KCQkJCSggalF1ZXJ5LmV4cHIubWF0Y2guYm9vbC50ZXN0KCBuYW1lICkgPyBib29sSG9vayA6IG5vZGVIb29rICk7DQoJCX0NCg0KCQlpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7DQoNCgkJCWlmICggdmFsdWUgPT09IG51bGwgKSB7DQoJCQkJalF1ZXJ5LnJlbW92ZUF0dHIoIGVsZW0sIG5hbWUgKTsNCg0KCQkJfSBlbHNlIGlmICggaG9va3MgJiYgInNldCIgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLnNldCggZWxlbSwgdmFsdWUsIG5hbWUgKSkgIT09IHVuZGVmaW5lZCApIHsNCgkJCQlyZXR1cm4gcmV0Ow0KDQoJCQl9IGVsc2Ugew0KCQkJCWVsZW0uc2V0QXR0cmlidXRlKCBuYW1lLCB2YWx1ZSArICIiICk7DQoJCQkJcmV0dXJuIHZhbHVlOw0KCQkJfQ0KDQoJCX0gZWxzZSBpZiAoIGhvb2tzICYmICJnZXQiIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5nZXQoIGVsZW0sIG5hbWUgKSkgIT09IG51bGwgKSB7DQoJCQlyZXR1cm4gcmV0Ow0KDQoJCX0gZWxzZSB7DQoJCQlyZXQgPSBqUXVlcnkuZmluZC5hdHRyKCBlbGVtLCBuYW1lICk7DQoNCgkJCS8vIE5vbi1leGlzdGVudCBhdHRyaWJ1dGVzIHJldHVybiBudWxsLCB3ZSBub3JtYWxpemUgdG8gdW5kZWZpbmVkDQoJCQlyZXR1cm4gcmV0ID09IG51bGwgPw0KCQkJCXVuZGVmaW5lZCA6DQoJCQkJcmV0Ow0KCQl9DQoJfSwNCg0KCXJlbW92ZUF0dHI6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsNCgkJdmFyIG5hbWUsIHByb3BOYW1lLA0KCQkJaSA9IDAsDQoJCQlhdHRyTmFtZXMgPSB2YWx1ZSAmJiB2YWx1ZS5tYXRjaCggY29yZV9ybm90d2hpdGUgKTsNCg0KCQlpZiAoIGF0dHJOYW1lcyAmJiBlbGVtLm5vZGVUeXBlID09PSAxICkgew0KCQkJd2hpbGUgKCAobmFtZSA9IGF0dHJOYW1lc1tpKytdKSApIHsNCgkJCQlwcm9wTmFtZSA9IGpRdWVyeS5wcm9wRml4WyBuYW1lIF0gfHwgbmFtZTsNCg0KCQkJCS8vIEJvb2xlYW4gYXR0cmlidXRlcyBnZXQgc3BlY2lhbCB0cmVhdG1lbnQgKCMxMDg3MCkNCgkJCQlpZiAoIGpRdWVyeS5leHByLm1hdGNoLmJvb2wudGVzdCggbmFtZSApICkgew0KCQkJCQkvLyBTZXQgY29ycmVzcG9uZGluZyBwcm9wZXJ0eSB0byBmYWxzZQ0KCQkJCQlpZiAoIGdldFNldElucHV0ICYmIGdldFNldEF0dHJpYnV0ZSB8fCAhcnVzZURlZmF1bHQudGVzdCggbmFtZSApICkgew0KCQkJCQkJZWxlbVsgcHJvcE5hbWUgXSA9IGZhbHNlOw0KCQkJCQkvLyBTdXBwb3J0OiBJRTw5DQoJCQkJCS8vIEFsc28gY2xlYXIgZGVmYXVsdENoZWNrZWQvZGVmYXVsdFNlbGVjdGVkIChpZiBhcHByb3ByaWF0ZSkNCgkJCQkJfSBlbHNlIHsNCgkJCQkJCWVsZW1bIGpRdWVyeS5jYW1lbENhc2UoICJkZWZhdWx0LSIgKyBuYW1lICkgXSA9DQoJCQkJCQkJZWxlbVsgcHJvcE5hbWUgXSA9IGZhbHNlOw0KCQkJCQl9DQoNCgkJCQkvLyBTZWUgIzk2OTkgZm9yIGV4cGxhbmF0aW9uIG9mIHRoaXMgYXBwcm9hY2ggKHNldHRpbmcgZmlyc3QsIHRoZW4gcmVtb3ZhbCkNCgkJCQl9IGVsc2Ugew0KCQkJCQlqUXVlcnkuYXR0ciggZWxlbSwgbmFtZSwgIiIgKTsNCgkJCQl9DQoNCgkJCQllbGVtLnJlbW92ZUF0dHJpYnV0ZSggZ2V0U2V0QXR0cmlidXRlID8gbmFtZSA6IHByb3BOYW1lICk7DQoJCQl9DQoJCX0NCgl9LA0KDQoJYXR0ckhvb2tzOiB7DQoJCXR5cGU6IHsNCgkJCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlICkgew0KCQkJCWlmICggIWpRdWVyeS5zdXBwb3J0LnJhZGlvVmFsdWUgJiYgdmFsdWUgPT09ICJyYWRpbyIgJiYgalF1ZXJ5Lm5vZGVOYW1lKGVsZW0sICJpbnB1dCIpICkgew0KCQkJCQkvLyBTZXR0aW5nIHRoZSB0eXBlIG9uIGEgcmFkaW8gYnV0dG9uIGFmdGVyIHRoZSB2YWx1ZSByZXNldHMgdGhlIHZhbHVlIGluIElFNi05DQoJCQkJCS8vIFJlc2V0IHZhbHVlIHRvIGRlZmF1bHQgaW4gY2FzZSB0eXBlIGlzIHNldCBhZnRlciB2YWx1ZSBkdXJpbmcgY3JlYXRpb24NCgkJCQkJdmFyIHZhbCA9IGVsZW0udmFsdWU7DQoJCQkJCWVsZW0uc2V0QXR0cmlidXRlKCAidHlwZSIsIHZhbHVlICk7DQoJCQkJCWlmICggdmFsICkgew0KCQkJCQkJZWxlbS52YWx1ZSA9IHZhbDsNCgkJCQkJfQ0KCQkJCQlyZXR1cm4gdmFsdWU7DQoJCQkJfQ0KCQkJfQ0KCQl9DQoJfSwNCg0KCXByb3BGaXg6IHsNCgkJImZvciI6ICJodG1sRm9yIiwNCgkJImNsYXNzIjogImNsYXNzTmFtZSINCgl9LA0KDQoJcHJvcDogZnVuY3Rpb24oIGVsZW0sIG5hbWUsIHZhbHVlICkgew0KCQl2YXIgcmV0LCBob29rcywgbm90eG1sLA0KCQkJblR5cGUgPSBlbGVtLm5vZGVUeXBlOw0KDQoJCS8vIGRvbid0IGdldC9zZXQgcHJvcGVydGllcyBvbiB0ZXh0LCBjb21tZW50IGFuZCBhdHRyaWJ1dGUgbm9kZXMNCgkJaWYgKCAhZWxlbSB8fCBuVHlwZSA9PT0gMyB8fCBuVHlwZSA9PT0gOCB8fCBuVHlwZSA9PT0gMiApIHsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCW5vdHhtbCA9IG5UeXBlICE9PSAxIHx8ICFqUXVlcnkuaXNYTUxEb2MoIGVsZW0gKTsNCg0KCQlpZiAoIG5vdHhtbCApIHsNCgkJCS8vIEZpeCBuYW1lIGFuZCBhdHRhY2ggaG9va3MNCgkJCW5hbWUgPSBqUXVlcnkucHJvcEZpeFsgbmFtZSBdIHx8IG5hbWU7DQoJCQlob29rcyA9IGpRdWVyeS5wcm9wSG9va3NbIG5hbWUgXTsNCgkJfQ0KDQoJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsNCgkJCXJldHVybiBob29rcyAmJiAic2V0IiBpbiBob29rcyAmJiAocmV0ID0gaG9va3Muc2V0KCBlbGVtLCB2YWx1ZSwgbmFtZSApKSAhPT0gdW5kZWZpbmVkID8NCgkJCQlyZXQgOg0KCQkJCSggZWxlbVsgbmFtZSBdID0gdmFsdWUgKTsNCg0KCQl9IGVsc2Ugew0KCQkJcmV0dXJuIGhvb2tzICYmICJnZXQiIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5nZXQoIGVsZW0sIG5hbWUgKSkgIT09IG51bGwgPw0KCQkJCXJldCA6DQoJCQkJZWxlbVsgbmFtZSBdOw0KCQl9DQoJfSwNCg0KCXByb3BIb29rczogew0KCQl0YWJJbmRleDogew0KCQkJZ2V0OiBmdW5jdGlvbiggZWxlbSApIHsNCgkJCQkvLyBlbGVtLnRhYkluZGV4IGRvZXNuJ3QgYWx3YXlzIHJldHVybiB0aGUgY29ycmVjdCB2YWx1ZSB3aGVuIGl0IGhhc24ndCBiZWVuIGV4cGxpY2l0bHkgc2V0DQoJCQkJLy8gaHR0cDovL2ZsdWlkcHJvamVjdC5vcmcvYmxvZy8yMDA4LzAxLzA5L2dldHRpbmctc2V0dGluZy1hbmQtcmVtb3ZpbmctdGFiaW5kZXgtdmFsdWVzLXdpdGgtamF2YXNjcmlwdC8NCgkJCQkvLyBVc2UgcHJvcGVyIGF0dHJpYnV0ZSByZXRyaWV2YWwoIzEyMDcyKQ0KCQkJCXZhciB0YWJpbmRleCA9IGpRdWVyeS5maW5kLmF0dHIoIGVsZW0sICJ0YWJpbmRleCIgKTsNCg0KCQkJCXJldHVybiB0YWJpbmRleCA/DQoJCQkJCXBhcnNlSW50KCB0YWJpbmRleCwgMTAgKSA6DQoJCQkJCXJmb2N1c2FibGUudGVzdCggZWxlbS5ub2RlTmFtZSApIHx8IHJjbGlja2FibGUudGVzdCggZWxlbS5ub2RlTmFtZSApICYmIGVsZW0uaHJlZiA/DQoJCQkJCQkwIDoNCgkJCQkJCS0xOw0KCQkJfQ0KCQl9DQoJfQ0KfSk7DQoNCi8vIEhvb2tzIGZvciBib29sZWFuIGF0dHJpYnV0ZXMNCmJvb2xIb29rID0gew0KCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlLCBuYW1lICkgew0KCQlpZiAoIHZhbHVlID09PSBmYWxzZSApIHsNCgkJCS8vIFJlbW92ZSBib29sZWFuIGF0dHJpYnV0ZXMgd2hlbiBzZXQgdG8gZmFsc2UNCgkJCWpRdWVyeS5yZW1vdmVBdHRyKCBlbGVtLCBuYW1lICk7DQoJCX0gZWxzZSBpZiAoIGdldFNldElucHV0ICYmIGdldFNldEF0dHJpYnV0ZSB8fCAhcnVzZURlZmF1bHQudGVzdCggbmFtZSApICkgew0KCQkJLy8gSUU8OCBuZWVkcyB0aGUgKnByb3BlcnR5KiBuYW1lDQoJCQllbGVtLnNldEF0dHJpYnV0ZSggIWdldFNldEF0dHJpYnV0ZSAmJiBqUXVlcnkucHJvcEZpeFsgbmFtZSBdIHx8IG5hbWUsIG5hbWUgKTsNCg0KCQkvLyBVc2UgZGVmYXVsdENoZWNrZWQgYW5kIGRlZmF1bHRTZWxlY3RlZCBmb3Igb2xkSUUNCgkJfSBlbHNlIHsNCgkJCWVsZW1bIGpRdWVyeS5jYW1lbENhc2UoICJkZWZhdWx0LSIgKyBuYW1lICkgXSA9IGVsZW1bIG5hbWUgXSA9IHRydWU7DQoJCX0NCg0KCQlyZXR1cm4gbmFtZTsNCgl9DQp9Ow0KalF1ZXJ5LmVhY2goIGpRdWVyeS5leHByLm1hdGNoLmJvb2wuc291cmNlLm1hdGNoKCAvXHcrL2cgKSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7DQoJdmFyIGdldHRlciA9IGpRdWVyeS5leHByLmF0dHJIYW5kbGVbIG5hbWUgXSB8fCBqUXVlcnkuZmluZC5hdHRyOw0KDQoJalF1ZXJ5LmV4cHIuYXR0ckhhbmRsZVsgbmFtZSBdID0gZ2V0U2V0SW5wdXQgJiYgZ2V0U2V0QXR0cmlidXRlIHx8ICFydXNlRGVmYXVsdC50ZXN0KCBuYW1lICkgPw0KCQlmdW5jdGlvbiggZWxlbSwgbmFtZSwgaXNYTUwgKSB7DQoJCQl2YXIgZm4gPSBqUXVlcnkuZXhwci5hdHRySGFuZGxlWyBuYW1lIF0sDQoJCQkJcmV0ID0gaXNYTUwgPw0KCQkJCQl1bmRlZmluZWQgOg0KCQkJCQkvKiBqc2hpbnQgZXFlcWVxOiBmYWxzZSAqLw0KCQkJCQkoalF1ZXJ5LmV4cHIuYXR0ckhhbmRsZVsgbmFtZSBdID0gdW5kZWZpbmVkKSAhPQ0KCQkJCQkJZ2V0dGVyKCBlbGVtLCBuYW1lLCBpc1hNTCApID8NCg0KCQkJCQkJbmFtZS50b0xvd2VyQ2FzZSgpIDoNCgkJCQkJCW51bGw7DQoJCQlqUXVlcnkuZXhwci5hdHRySGFuZGxlWyBuYW1lIF0gPSBmbjsNCgkJCXJldHVybiByZXQ7DQoJCX0gOg0KCQlmdW5jdGlvbiggZWxlbSwgbmFtZSwgaXNYTUwgKSB7DQoJCQlyZXR1cm4gaXNYTUwgPw0KCQkJCXVuZGVmaW5lZCA6DQoJCQkJZWxlbVsgalF1ZXJ5LmNhbWVsQ2FzZSggImRlZmF1bHQtIiArIG5hbWUgKSBdID8NCgkJCQkJbmFtZS50b0xvd2VyQ2FzZSgpIDoNCgkJCQkJbnVsbDsNCgkJfTsNCn0pOw0KDQovLyBmaXggb2xkSUUgYXR0cm9wZXJ0aWVzDQppZiAoICFnZXRTZXRJbnB1dCB8fCAhZ2V0U2V0QXR0cmlidXRlICkgew0KCWpRdWVyeS5hdHRySG9va3MudmFsdWUgPSB7DQoJCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlLCBuYW1lICkgew0KCQkJaWYgKCBqUXVlcnkubm9kZU5hbWUoIGVsZW0sICJpbnB1dCIgKSApIHsNCgkJCQkvLyBEb2VzIG5vdCByZXR1cm4gc28gdGhhdCBzZXRBdHRyaWJ1dGUgaXMgYWxzbyB1c2VkDQoJCQkJZWxlbS5kZWZhdWx0VmFsdWUgPSB2YWx1ZTsNCgkJCX0gZWxzZSB7DQoJCQkJLy8gVXNlIG5vZGVIb29rIGlmIGRlZmluZWQgKCMxOTU0KTsgb3RoZXJ3aXNlIHNldEF0dHJpYnV0ZSBpcyBmaW5lDQoJCQkJcmV0dXJuIG5vZGVIb29rICYmIG5vZGVIb29rLnNldCggZWxlbSwgdmFsdWUsIG5hbWUgKTsNCgkJCX0NCgkJfQ0KCX07DQp9DQoNCi8vIElFNi83IGRvIG5vdCBzdXBwb3J0IGdldHRpbmcvc2V0dGluZyBzb21lIGF0dHJpYnV0ZXMgd2l0aCBnZXQvc2V0QXR0cmlidXRlDQppZiAoICFnZXRTZXRBdHRyaWJ1dGUgKSB7DQoNCgkvLyBVc2UgdGhpcyBmb3IgYW55IGF0dHJpYnV0ZSBpbiBJRTYvNw0KCS8vIFRoaXMgZml4ZXMgYWxtb3N0IGV2ZXJ5IElFNi83IGlzc3VlDQoJbm9kZUhvb2sgPSB7DQoJCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlLCBuYW1lICkgew0KCQkJLy8gU2V0IHRoZSBleGlzdGluZyBvciBjcmVhdGUgYSBuZXcgYXR0cmlidXRlIG5vZGUNCgkJCXZhciByZXQgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoIG5hbWUgKTsNCgkJCWlmICggIXJldCApIHsNCgkJCQllbGVtLnNldEF0dHJpYnV0ZU5vZGUoDQoJCQkJCShyZXQgPSBlbGVtLm93bmVyRG9jdW1lbnQuY3JlYXRlQXR0cmlidXRlKCBuYW1lICkpDQoJCQkJKTsNCgkJCX0NCg0KCQkJcmV0LnZhbHVlID0gdmFsdWUgKz0gIiI7DQoNCgkJCS8vIEJyZWFrIGFzc29jaWF0aW9uIHdpdGggY2xvbmVkIGVsZW1lbnRzIGJ5IGFsc28gdXNpbmcgc2V0QXR0cmlidXRlICgjOTY0NikNCgkJCXJldHVybiBuYW1lID09PSAidmFsdWUiIHx8IHZhbHVlID09PSBlbGVtLmdldEF0dHJpYnV0ZSggbmFtZSApID8NCgkJCQl2YWx1ZSA6DQoJCQkJdW5kZWZpbmVkOw0KCQl9DQoJfTsNCglqUXVlcnkuZXhwci5hdHRySGFuZGxlLmlkID0galF1ZXJ5LmV4cHIuYXR0ckhhbmRsZS5uYW1lID0galF1ZXJ5LmV4cHIuYXR0ckhhbmRsZS5jb29yZHMgPQ0KCQkvLyBTb21lIGF0dHJpYnV0ZXMgYXJlIGNvbnN0cnVjdGVkIHdpdGggZW1wdHktc3RyaW5nIHZhbHVlcyB3aGVuIG5vdCBkZWZpbmVkDQoJCWZ1bmN0aW9uKCBlbGVtLCBuYW1lLCBpc1hNTCApIHsNCgkJCXZhciByZXQ7DQoJCQlyZXR1cm4gaXNYTUwgPw0KCQkJCXVuZGVmaW5lZCA6DQoJCQkJKHJldCA9IGVsZW0uZ2V0QXR0cmlidXRlTm9kZSggbmFtZSApKSAmJiByZXQudmFsdWUgIT09ICIiID8NCgkJCQkJcmV0LnZhbHVlIDoNCgkJCQkJbnVsbDsNCgkJfTsNCglqUXVlcnkudmFsSG9va3MuYnV0dG9uID0gew0KCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgew0KCQkJdmFyIHJldCA9IGVsZW0uZ2V0QXR0cmlidXRlTm9kZSggbmFtZSApOw0KCQkJcmV0dXJuIHJldCAmJiByZXQuc3BlY2lmaWVkID8NCgkJCQlyZXQudmFsdWUgOg0KCQkJCXVuZGVmaW5lZDsNCgkJfSwNCgkJc2V0OiBub2RlSG9vay5zZXQNCgl9Ow0KDQoJLy8gU2V0IGNvbnRlbnRlZGl0YWJsZSB0byBmYWxzZSBvbiByZW1vdmFscygjMTA0MjkpDQoJLy8gU2V0dGluZyB0byBlbXB0eSBzdHJpbmcgdGhyb3dzIGFuIGVycm9yIGFzIGFuIGludmFsaWQgdmFsdWUNCglqUXVlcnkuYXR0ckhvb2tzLmNvbnRlbnRlZGl0YWJsZSA9IHsNCgkJc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUsIG5hbWUgKSB7DQoJCQlub2RlSG9vay5zZXQoIGVsZW0sIHZhbHVlID09PSAiIiA/IGZhbHNlIDogdmFsdWUsIG5hbWUgKTsNCgkJfQ0KCX07DQoNCgkvLyBTZXQgd2lkdGggYW5kIGhlaWdodCB0byBhdXRvIGluc3RlYWQgb2YgMCBvbiBlbXB0eSBzdHJpbmcoIEJ1ZyAjODE1MCApDQoJLy8gVGhpcyBpcyBmb3IgcmVtb3ZhbHMNCglqUXVlcnkuZWFjaChbICJ3aWR0aCIsICJoZWlnaHQiIF0sIGZ1bmN0aW9uKCBpLCBuYW1lICkgew0KCQlqUXVlcnkuYXR0ckhvb2tzWyBuYW1lIF0gPSB7DQoJCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsNCgkJCQlpZiAoIHZhbHVlID09PSAiIiApIHsNCgkJCQkJZWxlbS5zZXRBdHRyaWJ1dGUoIG5hbWUsICJhdXRvIiApOw0KCQkJCQlyZXR1cm4gdmFsdWU7DQoJCQkJfQ0KCQkJfQ0KCQl9Ow0KCX0pOw0KfQ0KDQoNCi8vIFNvbWUgYXR0cmlidXRlcyByZXF1aXJlIGEgc3BlY2lhbCBjYWxsIG9uIElFDQovLyBodHRwOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvbXM1MzY0MjklMjhWUy44NSUyOS5hc3B4DQppZiAoICFqUXVlcnkuc3VwcG9ydC5ocmVmTm9ybWFsaXplZCApIHsNCgkvLyBocmVmL3NyYyBwcm9wZXJ0eSBzaG91bGQgZ2V0IHRoZSBmdWxsIG5vcm1hbGl6ZWQgVVJMICgjMTAyOTkvIzEyOTE1KQ0KCWpRdWVyeS5lYWNoKFsgImhyZWYiLCAic3JjIiBdLCBmdW5jdGlvbiggaSwgbmFtZSApIHsNCgkJalF1ZXJ5LnByb3BIb29rc1sgbmFtZSBdID0gew0KCQkJZ2V0OiBmdW5jdGlvbiggZWxlbSApIHsNCgkJCQlyZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoIG5hbWUsIDQgKTsNCgkJCX0NCgkJfTsNCgl9KTsNCn0NCg0KaWYgKCAhalF1ZXJ5LnN1cHBvcnQuc3R5bGUgKSB7DQoJalF1ZXJ5LmF0dHJIb29rcy5zdHlsZSA9IHsNCgkJZ2V0OiBmdW5jdGlvbiggZWxlbSApIHsNCgkJCS8vIFJldHVybiB1bmRlZmluZWQgaW4gdGhlIGNhc2Ugb2YgZW1wdHkgc3RyaW5nDQoJCQkvLyBOb3RlOiBJRSB1cHBlcmNhc2VzIGNzcyBwcm9wZXJ0eSBuYW1lcywgYnV0IGlmIHdlIHdlcmUgdG8gLnRvTG93ZXJDYXNlKCkNCgkJCS8vIC5jc3NUZXh0LCB0aGF0IHdvdWxkIGRlc3Ryb3kgY2FzZSBzZW5zdGl0aXZpdHkgaW4gVVJMJ3MsIGxpa2UgaW4gImJhY2tncm91bmQiDQoJCQlyZXR1cm4gZWxlbS5zdHlsZS5jc3NUZXh0IHx8IHVuZGVmaW5lZDsNCgkJfSwNCgkJc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUgKSB7DQoJCQlyZXR1cm4gKCBlbGVtLnN0eWxlLmNzc1RleHQgPSB2YWx1ZSArICIiICk7DQoJCX0NCgl9Ow0KfQ0KDQovLyBTYWZhcmkgbWlzLXJlcG9ydHMgdGhlIGRlZmF1bHQgc2VsZWN0ZWQgcHJvcGVydHkgb2YgYW4gb3B0aW9uDQovLyBBY2Nlc3NpbmcgdGhlIHBhcmVudCdzIHNlbGVjdGVkSW5kZXggcHJvcGVydHkgZml4ZXMgaXQNCmlmICggIWpRdWVyeS5zdXBwb3J0Lm9wdFNlbGVjdGVkICkgew0KCWpRdWVyeS5wcm9wSG9va3Muc2VsZWN0ZWQgPSB7DQoJCWdldDogZnVuY3Rpb24oIGVsZW0gKSB7DQoJCQl2YXIgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlOw0KDQoJCQlpZiAoIHBhcmVudCApIHsNCgkJCQlwYXJlbnQuc2VsZWN0ZWRJbmRleDsNCg0KCQkJCS8vIE1ha2Ugc3VyZSB0aGF0IGl0IGFsc28gd29ya3Mgd2l0aCBvcHRncm91cHMsIHNlZSAjNTcwMQ0KCQkJCWlmICggcGFyZW50LnBhcmVudE5vZGUgKSB7DQoJCQkJCXBhcmVudC5wYXJlbnROb2RlLnNlbGVjdGVkSW5kZXg7DQoJCQkJfQ0KCQkJfQ0KCQkJcmV0dXJuIG51bGw7DQoJCX0NCgl9Ow0KfQ0KDQpqUXVlcnkuZWFjaChbDQoJInRhYkluZGV4IiwNCgkicmVhZE9ubHkiLA0KCSJtYXhMZW5ndGgiLA0KCSJjZWxsU3BhY2luZyIsDQoJImNlbGxQYWRkaW5nIiwNCgkicm93U3BhbiIsDQoJImNvbFNwYW4iLA0KCSJ1c2VNYXAiLA0KCSJmcmFtZUJvcmRlciIsDQoJImNvbnRlbnRFZGl0YWJsZSINCl0sIGZ1bmN0aW9uKCkgew0KCWpRdWVyeS5wcm9wRml4WyB0aGlzLnRvTG93ZXJDYXNlKCkgXSA9IHRoaXM7DQp9KTsNCg0KLy8gSUU2LzcgY2FsbCBlbmN0eXBlIGVuY29kaW5nDQppZiAoICFqUXVlcnkuc3VwcG9ydC5lbmN0eXBlICkgew0KCWpRdWVyeS5wcm9wRml4LmVuY3R5cGUgPSAiZW5jb2RpbmciOw0KfQ0KDQovLyBSYWRpb3MgYW5kIGNoZWNrYm94ZXMgZ2V0dGVyL3NldHRlcg0KalF1ZXJ5LmVhY2goWyAicmFkaW8iLCAiY2hlY2tib3giIF0sIGZ1bmN0aW9uKCkgew0KCWpRdWVyeS52YWxIb29rc1sgdGhpcyBdID0gew0KCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsNCgkJCWlmICggalF1ZXJ5LmlzQXJyYXkoIHZhbHVlICkgKSB7DQoJCQkJcmV0dXJuICggZWxlbS5jaGVja2VkID0galF1ZXJ5LmluQXJyYXkoIGpRdWVyeShlbGVtKS52YWwoKSwgdmFsdWUgKSA+PSAwICk7DQoJCQl9DQoJCX0NCgl9Ow0KCWlmICggIWpRdWVyeS5zdXBwb3J0LmNoZWNrT24gKSB7DQoJCWpRdWVyeS52YWxIb29rc1sgdGhpcyBdLmdldCA9IGZ1bmN0aW9uKCBlbGVtICkgew0KCQkJLy8gU3VwcG9ydDogV2Via2l0DQoJCQkvLyAiIiBpcyByZXR1cm5lZCBpbnN0ZWFkIG9mICJvbiIgaWYgYSB2YWx1ZSBpc24ndCBzcGVjaWZpZWQNCgkJCXJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSgidmFsdWUiKSA9PT0gbnVsbCA/ICJvbiIgOiBlbGVtLnZhbHVlOw0KCQl9Ow0KCX0NCn0pOw0KdmFyIHJmb3JtRWxlbXMgPSAvXig/OmlucHV0fHNlbGVjdHx0ZXh0YXJlYSkkL2ksDQoJcmtleUV2ZW50ID0gL15rZXkvLA0KCXJtb3VzZUV2ZW50ID0gL14oPzptb3VzZXxjb250ZXh0bWVudSl8Y2xpY2svLA0KCXJmb2N1c01vcnBoID0gL14oPzpmb2N1c2luZm9jdXN8Zm9jdXNvdXRibHVyKSQvLA0KCXJ0eXBlbmFtZXNwYWNlID0gL14oW14uXSopKD86XC4oLispfCkkLzsNCg0KZnVuY3Rpb24gcmV0dXJuVHJ1ZSgpIHsNCglyZXR1cm4gdHJ1ZTsNCn0NCg0KZnVuY3Rpb24gcmV0dXJuRmFsc2UoKSB7DQoJcmV0dXJuIGZhbHNlOw0KfQ0KDQpmdW5jdGlvbiBzYWZlQWN0aXZlRWxlbWVudCgpIHsNCgl0cnkgew0KCQlyZXR1cm4gZG9jdW1lbnQuYWN0aXZlRWxlbWVudDsNCgl9IGNhdGNoICggZXJyICkgeyB9DQp9DQoNCi8qDQogKiBIZWxwZXIgZnVuY3Rpb25zIGZvciBtYW5hZ2luZyBldmVudHMgLS0gbm90IHBhcnQgb2YgdGhlIHB1YmxpYyBpbnRlcmZhY2UuDQogKiBQcm9wcyB0byBEZWFuIEVkd2FyZHMnIGFkZEV2ZW50IGxpYnJhcnkgZm9yIG1hbnkgb2YgdGhlIGlkZWFzLg0KICovDQpqUXVlcnkuZXZlbnQgPSB7DQoNCglnbG9iYWw6IHt9LA0KDQoJYWRkOiBmdW5jdGlvbiggZWxlbSwgdHlwZXMsIGhhbmRsZXIsIGRhdGEsIHNlbGVjdG9yICkgew0KCQl2YXIgdG1wLCBldmVudHMsIHQsIGhhbmRsZU9iakluLA0KCQkJc3BlY2lhbCwgZXZlbnRIYW5kbGUsIGhhbmRsZU9iaiwNCgkJCWhhbmRsZXJzLCB0eXBlLCBuYW1lc3BhY2VzLCBvcmlnVHlwZSwNCgkJCWVsZW1EYXRhID0galF1ZXJ5Ll9kYXRhKCBlbGVtICk7DQoNCgkJLy8gRG9uJ3QgYXR0YWNoIGV2ZW50cyB0byBub0RhdGEgb3IgdGV4dC9jb21tZW50IG5vZGVzIChidXQgYWxsb3cgcGxhaW4gb2JqZWN0cykNCgkJaWYgKCAhZWxlbURhdGEgKSB7DQoJCQlyZXR1cm47DQoJCX0NCg0KCQkvLyBDYWxsZXIgY2FuIHBhc3MgaW4gYW4gb2JqZWN0IG9mIGN1c3RvbSBkYXRhIGluIGxpZXUgb2YgdGhlIGhhbmRsZXINCgkJaWYgKCBoYW5kbGVyLmhhbmRsZXIgKSB7DQoJCQloYW5kbGVPYmpJbiA9IGhhbmRsZXI7DQoJCQloYW5kbGVyID0gaGFuZGxlT2JqSW4uaGFuZGxlcjsNCgkJCXNlbGVjdG9yID0gaGFuZGxlT2JqSW4uc2VsZWN0b3I7DQoJCX0NCg0KCQkvLyBNYWtlIHN1cmUgdGhhdCB0aGUgaGFuZGxlciBoYXMgYSB1bmlxdWUgSUQsIHVzZWQgdG8gZmluZC9yZW1vdmUgaXQgbGF0ZXINCgkJaWYgKCAhaGFuZGxlci5ndWlkICkgew0KCQkJaGFuZGxlci5ndWlkID0galF1ZXJ5Lmd1aWQrKzsNCgkJfQ0KDQoJCS8vIEluaXQgdGhlIGVsZW1lbnQncyBldmVudCBzdHJ1Y3R1cmUgYW5kIG1haW4gaGFuZGxlciwgaWYgdGhpcyBpcyB0aGUgZmlyc3QNCgkJaWYgKCAhKGV2ZW50cyA9IGVsZW1EYXRhLmV2ZW50cykgKSB7DQoJCQlldmVudHMgPSBlbGVtRGF0YS5ldmVudHMgPSB7fTsNCgkJfQ0KCQlpZiAoICEoZXZlbnRIYW5kbGUgPSBlbGVtRGF0YS5oYW5kbGUpICkgew0KCQkJZXZlbnRIYW5kbGUgPSBlbGVtRGF0YS5oYW5kbGUgPSBmdW5jdGlvbiggZSApIHsNCgkJCQkvLyBEaXNjYXJkIHRoZSBzZWNvbmQgZXZlbnQgb2YgYSBqUXVlcnkuZXZlbnQudHJpZ2dlcigpIGFuZA0KCQkJCS8vIHdoZW4gYW4gZXZlbnQgaXMgY2FsbGVkIGFmdGVyIGEgcGFnZSBoYXMgdW5sb2FkZWQNCgkJCQlyZXR1cm4gdHlwZW9mIGpRdWVyeSAhPT0gY29yZV9zdHJ1bmRlZmluZWQgJiYgKCFlIHx8IGpRdWVyeS5ldmVudC50cmlnZ2VyZWQgIT09IGUudHlwZSkgPw0KCQkJCQlqUXVlcnkuZXZlbnQuZGlzcGF0Y2guYXBwbHkoIGV2ZW50SGFuZGxlLmVsZW0sIGFyZ3VtZW50cyApIDoNCgkJCQkJdW5kZWZpbmVkOw0KCQkJfTsNCgkJCS8vIEFkZCBlbGVtIGFzIGEgcHJvcGVydHkgb2YgdGhlIGhhbmRsZSBmbiB0byBwcmV2ZW50IGEgbWVtb3J5IGxlYWsgd2l0aCBJRSBub24tbmF0aXZlIGV2ZW50cw0KCQkJZXZlbnRIYW5kbGUuZWxlbSA9IGVsZW07DQoJCX0NCg0KCQkvLyBIYW5kbGUgbXVsdGlwbGUgZXZlbnRzIHNlcGFyYXRlZCBieSBhIHNwYWNlDQoJCXR5cGVzID0gKCB0eXBlcyB8fCAiIiApLm1hdGNoKCBjb3JlX3Jub3R3aGl0ZSApIHx8IFsiIl07DQoJCXQgPSB0eXBlcy5sZW5ndGg7DQoJCXdoaWxlICggdC0tICkgew0KCQkJdG1wID0gcnR5cGVuYW1lc3BhY2UuZXhlYyggdHlwZXNbdF0gKSB8fCBbXTsNCgkJCXR5cGUgPSBvcmlnVHlwZSA9IHRtcFsxXTsNCgkJCW5hbWVzcGFjZXMgPSAoIHRtcFsyXSB8fCAiIiApLnNwbGl0KCAiLiIgKS5zb3J0KCk7DQoNCgkJCS8vIFRoZXJlICptdXN0KiBiZSBhIHR5cGUsIG5vIGF0dGFjaGluZyBuYW1lc3BhY2Utb25seSBoYW5kbGVycw0KCQkJaWYgKCAhdHlwZSApIHsNCgkJCQljb250aW51ZTsNCgkJCX0NCg0KCQkJLy8gSWYgZXZlbnQgY2hhbmdlcyBpdHMgdHlwZSwgdXNlIHRoZSBzcGVjaWFsIGV2ZW50IGhhbmRsZXJzIGZvciB0aGUgY2hhbmdlZCB0eXBlDQoJCQlzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbIHR5cGUgXSB8fCB7fTsNCg0KCQkJLy8gSWYgc2VsZWN0b3IgZGVmaW5lZCwgZGV0ZXJtaW5lIHNwZWNpYWwgZXZlbnQgYXBpIHR5cGUsIG90aGVyd2lzZSBnaXZlbiB0eXBlDQoJCQl0eXBlID0gKCBzZWxlY3RvciA/IHNwZWNpYWwuZGVsZWdhdGVUeXBlIDogc3BlY2lhbC5iaW5kVHlwZSApIHx8IHR5cGU7DQoNCgkJCS8vIFVwZGF0ZSBzcGVjaWFsIGJhc2VkIG9uIG5ld2x5IHJlc2V0IHR5cGUNCgkJCXNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgdHlwZSBdIHx8IHt9Ow0KDQoJCQkvLyBoYW5kbGVPYmogaXMgcGFzc2VkIHRvIGFsbCBldmVudCBoYW5kbGVycw0KCQkJaGFuZGxlT2JqID0galF1ZXJ5LmV4dGVuZCh7DQoJCQkJdHlwZTogdHlwZSwNCgkJCQlvcmlnVHlwZTogb3JpZ1R5cGUsDQoJCQkJZGF0YTogZGF0YSwNCgkJCQloYW5kbGVyOiBoYW5kbGVyLA0KCQkJCWd1aWQ6IGhhbmRsZXIuZ3VpZCwNCgkJCQlzZWxlY3Rvcjogc2VsZWN0b3IsDQoJCQkJbmVlZHNDb250ZXh0OiBzZWxlY3RvciAmJiBqUXVlcnkuZXhwci5tYXRjaC5uZWVkc0NvbnRleHQudGVzdCggc2VsZWN0b3IgKSwNCgkJCQluYW1lc3BhY2U6IG5hbWVzcGFjZXMuam9pbigiLiIpDQoJCQl9LCBoYW5kbGVPYmpJbiApOw0KDQoJCQkvLyBJbml0IHRoZSBldmVudCBoYW5kbGVyIHF1ZXVlIGlmIHdlJ3JlIHRoZSBmaXJzdA0KCQkJaWYgKCAhKGhhbmRsZXJzID0gZXZlbnRzWyB0eXBlIF0pICkgew0KCQkJCWhhbmRsZXJzID0gZXZlbnRzWyB0eXBlIF0gPSBbXTsNCgkJCQloYW5kbGVycy5kZWxlZ2F0ZUNvdW50ID0gMDsNCg0KCQkJCS8vIE9ubHkgdXNlIGFkZEV2ZW50TGlzdGVuZXIvYXR0YWNoRXZlbnQgaWYgdGhlIHNwZWNpYWwgZXZlbnRzIGhhbmRsZXIgcmV0dXJucyBmYWxzZQ0KCQkJCWlmICggIXNwZWNpYWwuc2V0dXAgfHwgc3BlY2lhbC5zZXR1cC5jYWxsKCBlbGVtLCBkYXRhLCBuYW1lc3BhY2VzLCBldmVudEhhbmRsZSApID09PSBmYWxzZSApIHsNCgkJCQkJLy8gQmluZCB0aGUgZ2xvYmFsIGV2ZW50IGhhbmRsZXIgdG8gdGhlIGVsZW1lbnQNCgkJCQkJaWYgKCBlbGVtLmFkZEV2ZW50TGlzdGVuZXIgKSB7DQoJCQkJCQllbGVtLmFkZEV2ZW50TGlzdGVuZXIoIHR5cGUsIGV2ZW50SGFuZGxlLCBmYWxzZSApOw0KDQoJCQkJCX0gZWxzZSBpZiAoIGVsZW0uYXR0YWNoRXZlbnQgKSB7DQoJCQkJCQllbGVtLmF0dGFjaEV2ZW50KCAib24iICsgdHlwZSwgZXZlbnRIYW5kbGUgKTsNCgkJCQkJfQ0KCQkJCX0NCgkJCX0NCg0KCQkJaWYgKCBzcGVjaWFsLmFkZCApIHsNCgkJCQlzcGVjaWFsLmFkZC5jYWxsKCBlbGVtLCBoYW5kbGVPYmogKTsNCg0KCQkJCWlmICggIWhhbmRsZU9iai5oYW5kbGVyLmd1aWQgKSB7DQoJCQkJCWhhbmRsZU9iai5oYW5kbGVyLmd1aWQgPSBoYW5kbGVyLmd1aWQ7DQoJCQkJfQ0KCQkJfQ0KDQoJCQkvLyBBZGQgdG8gdGhlIGVsZW1lbnQncyBoYW5kbGVyIGxpc3QsIGRlbGVnYXRlcyBpbiBmcm9udA0KCQkJaWYgKCBzZWxlY3RvciApIHsNCgkJCQloYW5kbGVycy5zcGxpY2UoIGhhbmRsZXJzLmRlbGVnYXRlQ291bnQrKywgMCwgaGFuZGxlT2JqICk7DQoJCQl9IGVsc2Ugew0KCQkJCWhhbmRsZXJzLnB1c2goIGhhbmRsZU9iaiApOw0KCQkJfQ0KDQoJCQkvLyBLZWVwIHRyYWNrIG9mIHdoaWNoIGV2ZW50cyBoYXZlIGV2ZXIgYmVlbiB1c2VkLCBmb3IgZXZlbnQgb3B0aW1pemF0aW9uDQoJCQlqUXVlcnkuZXZlbnQuZ2xvYmFsWyB0eXBlIF0gPSB0cnVlOw0KCQl9DQoNCgkJLy8gTnVsbGlmeSBlbGVtIHRvIHByZXZlbnQgbWVtb3J5IGxlYWtzIGluIElFDQoJCWVsZW0gPSBudWxsOw0KCX0sDQoNCgkvLyBEZXRhY2ggYW4gZXZlbnQgb3Igc2V0IG9mIGV2ZW50cyBmcm9tIGFuIGVsZW1lbnQNCglyZW1vdmU6IGZ1bmN0aW9uKCBlbGVtLCB0eXBlcywgaGFuZGxlciwgc2VsZWN0b3IsIG1hcHBlZFR5cGVzICkgew0KCQl2YXIgaiwgaGFuZGxlT2JqLCB0bXAsDQoJCQlvcmlnQ291bnQsIHQsIGV2ZW50cywNCgkJCXNwZWNpYWwsIGhhbmRsZXJzLCB0eXBlLA0KCQkJbmFtZXNwYWNlcywgb3JpZ1R5cGUsDQoJCQllbGVtRGF0YSA9IGpRdWVyeS5oYXNEYXRhKCBlbGVtICkgJiYgalF1ZXJ5Ll9kYXRhKCBlbGVtICk7DQoNCgkJaWYgKCAhZWxlbURhdGEgfHwgIShldmVudHMgPSBlbGVtRGF0YS5ldmVudHMpICkgew0KCQkJcmV0dXJuOw0KCQl9DQoNCgkJLy8gT25jZSBmb3IgZWFjaCB0eXBlLm5hbWVzcGFjZSBpbiB0eXBlczsgdHlwZSBtYXkgYmUgb21pdHRlZA0KCQl0eXBlcyA9ICggdHlwZXMgfHwgIiIgKS5tYXRjaCggY29yZV9ybm90d2hpdGUgKSB8fCBbIiJdOw0KCQl0ID0gdHlwZXMubGVuZ3RoOw0KCQl3aGlsZSAoIHQtLSApIHsNCgkJCXRtcCA9IHJ0eXBlbmFtZXNwYWNlLmV4ZWMoIHR5cGVzW3RdICkgfHwgW107DQoJCQl0eXBlID0gb3JpZ1R5cGUgPSB0bXBbMV07DQoJCQluYW1lc3BhY2VzID0gKCB0bXBbMl0gfHwgIiIgKS5zcGxpdCggIi4iICkuc29ydCgpOw0KDQoJCQkvLyBVbmJpbmQgYWxsIGV2ZW50cyAob24gdGhpcyBuYW1lc3BhY2UsIGlmIHByb3ZpZGVkKSBmb3IgdGhlIGVsZW1lbnQNCgkJCWlmICggIXR5cGUgKSB7DQoJCQkJZm9yICggdHlwZSBpbiBldmVudHMgKSB7DQoJCQkJCWpRdWVyeS5ldmVudC5yZW1vdmUoIGVsZW0sIHR5cGUgKyB0eXBlc1sgdCBdLCBoYW5kbGVyLCBzZWxlY3RvciwgdHJ1ZSApOw0KCQkJCX0NCgkJCQljb250aW51ZTsNCgkJCX0NCg0KCQkJc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsWyB0eXBlIF0gfHwge307DQoJCQl0eXBlID0gKCBzZWxlY3RvciA/IHNwZWNpYWwuZGVsZWdhdGVUeXBlIDogc3BlY2lhbC5iaW5kVHlwZSApIHx8IHR5cGU7DQoJCQloYW5kbGVycyA9IGV2ZW50c1sgdHlwZSBdIHx8IFtdOw0KCQkJdG1wID0gdG1wWzJdICYmIG5ldyBSZWdFeHAoICIoXnxcXC4pIiArIG5hbWVzcGFjZXMuam9pbigiXFwuKD86LipcXC58KSIpICsgIihcXC58JCkiICk7DQoNCgkJCS8vIFJlbW92ZSBtYXRjaGluZyBldmVudHMNCgkJCW9yaWdDb3VudCA9IGogPSBoYW5kbGVycy5sZW5ndGg7DQoJCQl3aGlsZSAoIGotLSApIHsNCgkJCQloYW5kbGVPYmogPSBoYW5kbGVyc1sgaiBdOw0KDQoJCQkJaWYgKCAoIG1hcHBlZFR5cGVzIHx8IG9yaWdUeXBlID09PSBoYW5kbGVPYmoub3JpZ1R5cGUgKSAmJg0KCQkJCQkoICFoYW5kbGVyIHx8IGhhbmRsZXIuZ3VpZCA9PT0gaGFuZGxlT2JqLmd1aWQgKSAmJg0KCQkJCQkoICF0bXAgfHwgdG1wLnRlc3QoIGhhbmRsZU9iai5uYW1lc3BhY2UgKSApICYmDQoJCQkJCSggIXNlbGVjdG9yIHx8IHNlbGVjdG9yID09PSBoYW5kbGVPYmouc2VsZWN0b3IgfHwgc2VsZWN0b3IgPT09ICIqKiIgJiYgaGFuZGxlT2JqLnNlbGVjdG9yICkgKSB7DQoJCQkJCWhhbmRsZXJzLnNwbGljZSggaiwgMSApOw0KDQoJCQkJCWlmICggaGFuZGxlT2JqLnNlbGVjdG9yICkgew0KCQkJCQkJaGFuZGxlcnMuZGVsZWdhdGVDb3VudC0tOw0KCQkJCQl9DQoJCQkJCWlmICggc3BlY2lhbC5yZW1vdmUgKSB7DQoJCQkJCQlzcGVjaWFsLnJlbW92ZS5jYWxsKCBlbGVtLCBoYW5kbGVPYmogKTsNCgkJCQkJfQ0KCQkJCX0NCgkJCX0NCg0KCQkJLy8gUmVtb3ZlIGdlbmVyaWMgZXZlbnQgaGFuZGxlciBpZiB3ZSByZW1vdmVkIHNvbWV0aGluZyBhbmQgbm8gbW9yZSBoYW5kbGVycyBleGlzdA0KCQkJLy8gKGF2b2lkcyBwb3RlbnRpYWwgZm9yIGVuZGxlc3MgcmVjdXJzaW9uIGR1cmluZyByZW1vdmFsIG9mIHNwZWNpYWwgZXZlbnQgaGFuZGxlcnMpDQoJCQlpZiAoIG9yaWdDb3VudCAmJiAhaGFuZGxlcnMubGVuZ3RoICkgew0KCQkJCWlmICggIXNwZWNpYWwudGVhcmRvd24gfHwgc3BlY2lhbC50ZWFyZG93bi5jYWxsKCBlbGVtLCBuYW1lc3BhY2VzLCBlbGVtRGF0YS5oYW5kbGUgKSA9PT0gZmFsc2UgKSB7DQoJCQkJCWpRdWVyeS5yZW1vdmVFdmVudCggZWxlbSwgdHlwZSwgZWxlbURhdGEuaGFuZGxlICk7DQoJCQkJfQ0KDQoJCQkJZGVsZXRlIGV2ZW50c1sgdHlwZSBdOw0KCQkJfQ0KCQl9DQoNCgkJLy8gUmVtb3ZlIHRoZSBleHBhbmRvIGlmIGl0J3Mgbm8gbG9uZ2VyIHVzZWQNCgkJaWYgKCBqUXVlcnkuaXNFbXB0eU9iamVjdCggZXZlbnRzICkgKSB7DQoJCQlkZWxldGUgZWxlbURhdGEuaGFuZGxlOw0KDQoJCQkvLyByZW1vdmVEYXRhIGFsc28gY2hlY2tzIGZvciBlbXB0aW5lc3MgYW5kIGNsZWFycyB0aGUgZXhwYW5kbyBpZiBlbXB0eQ0KCQkJLy8gc28gdXNlIGl0IGluc3RlYWQgb2YgZGVsZXRlDQoJCQlqUXVlcnkuX3JlbW92ZURhdGEoIGVsZW0sICJldmVudHMiICk7DQoJCX0NCgl9LA0KDQoJdHJpZ2dlcjogZnVuY3Rpb24oIGV2ZW50LCBkYXRhLCBlbGVtLCBvbmx5SGFuZGxlcnMgKSB7DQoJCXZhciBoYW5kbGUsIG9udHlwZSwgY3VyLA0KCQkJYnViYmxlVHlwZSwgc3BlY2lhbCwgdG1wLCBpLA0KCQkJZXZlbnRQYXRoID0gWyBlbGVtIHx8IGRvY3VtZW50IF0sDQoJCQl0eXBlID0gY29yZV9oYXNPd24uY2FsbCggZXZlbnQsICJ0eXBlIiApID8gZXZlbnQudHlwZSA6IGV2ZW50LA0KCQkJbmFtZXNwYWNlcyA9IGNvcmVfaGFzT3duLmNhbGwoIGV2ZW50LCAibmFtZXNwYWNlIiApID8gZXZlbnQubmFtZXNwYWNlLnNwbGl0KCIuIikgOiBbXTsNCg0KCQljdXIgPSB0bXAgPSBlbGVtID0gZWxlbSB8fCBkb2N1bWVudDsNCg0KCQkvLyBEb24ndCBkbyBldmVudHMgb24gdGV4dCBhbmQgY29tbWVudCBub2Rlcw0KCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDMgfHwgZWxlbS5ub2RlVHlwZSA9PT0gOCApIHsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCS8vIGZvY3VzL2JsdXIgbW9ycGhzIHRvIGZvY3VzaW4vb3V0OyBlbnN1cmUgd2UncmUgbm90IGZpcmluZyB0aGVtIHJpZ2h0IG5vdw0KCQlpZiAoIHJmb2N1c01vcnBoLnRlc3QoIHR5cGUgKyBqUXVlcnkuZXZlbnQudHJpZ2dlcmVkICkgKSB7DQoJCQlyZXR1cm47DQoJCX0NCg0KCQlpZiAoIHR5cGUuaW5kZXhPZigiLiIpID49IDAgKSB7DQoJCQkvLyBOYW1lc3BhY2VkIHRyaWdnZXI7IGNyZWF0ZSBhIHJlZ2V4cCB0byBtYXRjaCBldmVudCB0eXBlIGluIGhhbmRsZSgpDQoJCQluYW1lc3BhY2VzID0gdHlwZS5zcGxpdCgiLiIpOw0KCQkJdHlwZSA9IG5hbWVzcGFjZXMuc2hpZnQoKTsNCgkJCW5hbWVzcGFjZXMuc29ydCgpOw0KCQl9DQoJCW9udHlwZSA9IHR5cGUuaW5kZXhPZigiOiIpIDwgMCAmJiAib24iICsgdHlwZTsNCg0KCQkvLyBDYWxsZXIgY2FuIHBhc3MgaW4gYSBqUXVlcnkuRXZlbnQgb2JqZWN0LCBPYmplY3QsIG9yIGp1c3QgYW4gZXZlbnQgdHlwZSBzdHJpbmcNCgkJZXZlbnQgPSBldmVudFsgalF1ZXJ5LmV4cGFuZG8gXSA/DQoJCQlldmVudCA6DQoJCQluZXcgalF1ZXJ5LkV2ZW50KCB0eXBlLCB0eXBlb2YgZXZlbnQgPT09ICJvYmplY3QiICYmIGV2ZW50ICk7DQoNCgkJLy8gVHJpZ2dlciBiaXRtYXNrOiAmIDEgZm9yIG5hdGl2ZSBoYW5kbGVyczsgJiAyIGZvciBqUXVlcnkgKGFsd2F5cyB0cnVlKQ0KCQlldmVudC5pc1RyaWdnZXIgPSBvbmx5SGFuZGxlcnMgPyAyIDogMzsNCgkJZXZlbnQubmFtZXNwYWNlID0gbmFtZXNwYWNlcy5qb2luKCIuIik7DQoJCWV2ZW50Lm5hbWVzcGFjZV9yZSA9IGV2ZW50Lm5hbWVzcGFjZSA/DQoJCQluZXcgUmVnRXhwKCAiKF58XFwuKSIgKyBuYW1lc3BhY2VzLmpvaW4oIlxcLig/Oi4qXFwufCkiKSArICIoXFwufCQpIiApIDoNCgkJCW51bGw7DQoNCgkJLy8gQ2xlYW4gdXAgdGhlIGV2ZW50IGluIGNhc2UgaXQgaXMgYmVpbmcgcmV1c2VkDQoJCWV2ZW50LnJlc3VsdCA9IHVuZGVmaW5lZDsNCgkJaWYgKCAhZXZlbnQudGFyZ2V0ICkgew0KCQkJZXZlbnQudGFyZ2V0ID0gZWxlbTsNCgkJfQ0KDQoJCS8vIENsb25lIGFueSBpbmNvbWluZyBkYXRhIGFuZCBwcmVwZW5kIHRoZSBldmVudCwgY3JlYXRpbmcgdGhlIGhhbmRsZXIgYXJnIGxpc3QNCgkJZGF0YSA9IGRhdGEgPT0gbnVsbCA/DQoJCQlbIGV2ZW50IF0gOg0KCQkJalF1ZXJ5Lm1ha2VBcnJheSggZGF0YSwgWyBldmVudCBdICk7DQoNCgkJLy8gQWxsb3cgc3BlY2lhbCBldmVudHMgdG8gZHJhdyBvdXRzaWRlIHRoZSBsaW5lcw0KCQlzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbIHR5cGUgXSB8fCB7fTsNCgkJaWYgKCAhb25seUhhbmRsZXJzICYmIHNwZWNpYWwudHJpZ2dlciAmJiBzcGVjaWFsLnRyaWdnZXIuYXBwbHkoIGVsZW0sIGRhdGEgKSA9PT0gZmFsc2UgKSB7DQoJCQlyZXR1cm47DQoJCX0NCg0KCQkvLyBEZXRlcm1pbmUgZXZlbnQgcHJvcGFnYXRpb24gcGF0aCBpbiBhZHZhbmNlLCBwZXIgVzNDIGV2ZW50cyBzcGVjICgjOTk1MSkNCgkJLy8gQnViYmxlIHVwIHRvIGRvY3VtZW50LCB0aGVuIHRvIHdpbmRvdzsgd2F0Y2ggZm9yIGEgZ2xvYmFsIG93bmVyRG9jdW1lbnQgdmFyICgjOTcyNCkNCgkJaWYgKCAhb25seUhhbmRsZXJzICYmICFzcGVjaWFsLm5vQnViYmxlICYmICFqUXVlcnkuaXNXaW5kb3coIGVsZW0gKSApIHsNCg0KCQkJYnViYmxlVHlwZSA9IHNwZWNpYWwuZGVsZWdhdGVUeXBlIHx8IHR5cGU7DQoJCQlpZiAoICFyZm9jdXNNb3JwaC50ZXN0KCBidWJibGVUeXBlICsgdHlwZSApICkgew0KCQkJCWN1ciA9IGN1ci5wYXJlbnROb2RlOw0KCQkJfQ0KCQkJZm9yICggOyBjdXI7IGN1ciA9IGN1ci5wYXJlbnROb2RlICkgew0KCQkJCWV2ZW50UGF0aC5wdXNoKCBjdXIgKTsNCgkJCQl0bXAgPSBjdXI7DQoJCQl9DQoNCgkJCS8vIE9ubHkgYWRkIHdpbmRvdyBpZiB3ZSBnb3QgdG8gZG9jdW1lbnQgKGUuZy4sIG5vdCBwbGFpbiBvYmogb3IgZGV0YWNoZWQgRE9NKQ0KCQkJaWYgKCB0bXAgPT09IChlbGVtLm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQpICkgew0KCQkJCWV2ZW50UGF0aC5wdXNoKCB0bXAuZGVmYXVsdFZpZXcgfHwgdG1wLnBhcmVudFdpbmRvdyB8fCB3aW5kb3cgKTsNCgkJCX0NCgkJfQ0KDQoJCS8vIEZpcmUgaGFuZGxlcnMgb24gdGhlIGV2ZW50IHBhdGgNCgkJaSA9IDA7DQoJCXdoaWxlICggKGN1ciA9IGV2ZW50UGF0aFtpKytdKSAmJiAhZXZlbnQuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsNCg0KCQkJZXZlbnQudHlwZSA9IGkgPiAxID8NCgkJCQlidWJibGVUeXBlIDoNCgkJCQlzcGVjaWFsLmJpbmRUeXBlIHx8IHR5cGU7DQoNCgkJCS8vIGpRdWVyeSBoYW5kbGVyDQoJCQloYW5kbGUgPSAoIGpRdWVyeS5fZGF0YSggY3VyLCAiZXZlbnRzIiApIHx8IHt9IClbIGV2ZW50LnR5cGUgXSAmJiBqUXVlcnkuX2RhdGEoIGN1ciwgImhhbmRsZSIgKTsNCgkJCWlmICggaGFuZGxlICkgew0KCQkJCWhhbmRsZS5hcHBseSggY3VyLCBkYXRhICk7DQoJCQl9DQoNCgkJCS8vIE5hdGl2ZSBoYW5kbGVyDQoJCQloYW5kbGUgPSBvbnR5cGUgJiYgY3VyWyBvbnR5cGUgXTsNCgkJCWlmICggaGFuZGxlICYmIGpRdWVyeS5hY2NlcHREYXRhKCBjdXIgKSAmJiBoYW5kbGUuYXBwbHkgJiYgaGFuZGxlLmFwcGx5KCBjdXIsIGRhdGEgKSA9PT0gZmFsc2UgKSB7DQoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsNCgkJCX0NCgkJfQ0KCQlldmVudC50eXBlID0gdHlwZTsNCg0KCQkvLyBJZiBub2JvZHkgcHJldmVudGVkIHRoZSBkZWZhdWx0IGFjdGlvbiwgZG8gaXQgbm93DQoJCWlmICggIW9ubHlIYW5kbGVycyAmJiAhZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7DQoNCgkJCWlmICggKCFzcGVjaWFsLl9kZWZhdWx0IHx8IHNwZWNpYWwuX2RlZmF1bHQuYXBwbHkoIGV2ZW50UGF0aC5wb3AoKSwgZGF0YSApID09PSBmYWxzZSkgJiYNCgkJCQlqUXVlcnkuYWNjZXB0RGF0YSggZWxlbSApICkgew0KDQoJCQkJLy8gQ2FsbCBhIG5hdGl2ZSBET00gbWV0aG9kIG9uIHRoZSB0YXJnZXQgd2l0aCB0aGUgc2FtZSBuYW1lIG5hbWUgYXMgdGhlIGV2ZW50Lg0KCQkJCS8vIENhbid0IHVzZSBhbiAuaXNGdW5jdGlvbigpIGNoZWNrIGhlcmUgYmVjYXVzZSBJRTYvNyBmYWlscyB0aGF0IHRlc3QuDQoJCQkJLy8gRG9uJ3QgZG8gZGVmYXVsdCBhY3Rpb25zIG9uIHdpbmRvdywgdGhhdCdzIHdoZXJlIGdsb2JhbCB2YXJpYWJsZXMgYmUgKCM2MTcwKQ0KCQkJCWlmICggb250eXBlICYmIGVsZW1bIHR5cGUgXSAmJiAhalF1ZXJ5LmlzV2luZG93KCBlbGVtICkgKSB7DQoNCgkJCQkJLy8gRG9uJ3QgcmUtdHJpZ2dlciBhbiBvbkZPTyBldmVudCB3aGVuIHdlIGNhbGwgaXRzIEZPTygpIG1ldGhvZA0KCQkJCQl0bXAgPSBlbGVtWyBvbnR5cGUgXTsNCg0KCQkJCQlpZiAoIHRtcCApIHsNCgkJCQkJCWVsZW1bIG9udHlwZSBdID0gbnVsbDsNCgkJCQkJfQ0KDQoJCQkJCS8vIFByZXZlbnQgcmUtdHJpZ2dlcmluZyBvZiB0aGUgc2FtZSBldmVudCwgc2luY2Ugd2UgYWxyZWFkeSBidWJibGVkIGl0IGFib3ZlDQoJCQkJCWpRdWVyeS5ldmVudC50cmlnZ2VyZWQgPSB0eXBlOw0KCQkJCQl0cnkgew0KCQkJCQkJZWxlbVsgdHlwZSBdKCk7DQoJCQkJCX0gY2F0Y2ggKCBlICkgew0KCQkJCQkJLy8gSUU8OSBkaWVzIG9uIGZvY3VzL2JsdXIgdG8gaGlkZGVuIGVsZW1lbnQgKCMxNDg2LCMxMjUxOCkNCgkJCQkJCS8vIG9ubHkgcmVwcm9kdWNpYmxlIG9uIHdpblhQIElFOCBuYXRpdmUsIG5vdCBJRTkgaW4gSUU4IG1vZGUNCgkJCQkJfQ0KCQkJCQlqUXVlcnkuZXZlbnQudHJpZ2dlcmVkID0gdW5kZWZpbmVkOw0KDQoJCQkJCWlmICggdG1wICkgew0KCQkJCQkJZWxlbVsgb250eXBlIF0gPSB0bXA7DQoJCQkJCX0NCgkJCQl9DQoJCQl9DQoJCX0NCg0KCQlyZXR1cm4gZXZlbnQucmVzdWx0Ow0KCX0sDQoNCglkaXNwYXRjaDogZnVuY3Rpb24oIGV2ZW50ICkgew0KDQoJCS8vIE1ha2UgYSB3cml0YWJsZSBqUXVlcnkuRXZlbnQgZnJvbSB0aGUgbmF0aXZlIGV2ZW50IG9iamVjdA0KCQlldmVudCA9IGpRdWVyeS5ldmVudC5maXgoIGV2ZW50ICk7DQoNCgkJdmFyIGksIHJldCwgaGFuZGxlT2JqLCBtYXRjaGVkLCBqLA0KCQkJaGFuZGxlclF1ZXVlID0gW10sDQoJCQlhcmdzID0gY29yZV9zbGljZS5jYWxsKCBhcmd1bWVudHMgKSwNCgkJCWhhbmRsZXJzID0gKCBqUXVlcnkuX2RhdGEoIHRoaXMsICJldmVudHMiICkgfHwge30gKVsgZXZlbnQudHlwZSBdIHx8IFtdLA0KCQkJc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsWyBldmVudC50eXBlIF0gfHwge307DQoNCgkJLy8gVXNlIHRoZSBmaXgtZWQgalF1ZXJ5LkV2ZW50IHJhdGhlciB0aGFuIHRoZSAocmVhZC1vbmx5KSBuYXRpdmUgZXZlbnQNCgkJYXJnc1swXSA9IGV2ZW50Ow0KCQlldmVudC5kZWxlZ2F0ZVRhcmdldCA9IHRoaXM7DQoNCgkJLy8gQ2FsbCB0aGUgcHJlRGlzcGF0Y2ggaG9vayBmb3IgdGhlIG1hcHBlZCB0eXBlLCBhbmQgbGV0IGl0IGJhaWwgaWYgZGVzaXJlZA0KCQlpZiAoIHNwZWNpYWwucHJlRGlzcGF0Y2ggJiYgc3BlY2lhbC5wcmVEaXNwYXRjaC5jYWxsKCB0aGlzLCBldmVudCApID09PSBmYWxzZSApIHsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCS8vIERldGVybWluZSBoYW5kbGVycw0KCQloYW5kbGVyUXVldWUgPSBqUXVlcnkuZXZlbnQuaGFuZGxlcnMuY2FsbCggdGhpcywgZXZlbnQsIGhhbmRsZXJzICk7DQoNCgkJLy8gUnVuIGRlbGVnYXRlcyBmaXJzdDsgdGhleSBtYXkgd2FudCB0byBzdG9wIHByb3BhZ2F0aW9uIGJlbmVhdGggdXMNCgkJaSA9IDA7DQoJCXdoaWxlICggKG1hdGNoZWQgPSBoYW5kbGVyUXVldWVbIGkrKyBdKSAmJiAhZXZlbnQuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsNCgkJCWV2ZW50LmN1cnJlbnRUYXJnZXQgPSBtYXRjaGVkLmVsZW07DQoNCgkJCWogPSAwOw0KCQkJd2hpbGUgKCAoaGFuZGxlT2JqID0gbWF0Y2hlZC5oYW5kbGVyc1sgaisrIF0pICYmICFldmVudC5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCgpICkgew0KDQoJCQkJLy8gVHJpZ2dlcmVkIGV2ZW50IG11c3QgZWl0aGVyIDEpIGhhdmUgbm8gbmFtZXNwYWNlLCBvcg0KCQkJCS8vIDIpIGhhdmUgbmFtZXNwYWNlKHMpIGEgc3Vic2V0IG9yIGVxdWFsIHRvIHRob3NlIGluIHRoZSBib3VuZCBldmVudCAoYm90aCBjYW4gaGF2ZSBubyBuYW1lc3BhY2UpLg0KCQkJCWlmICggIWV2ZW50Lm5hbWVzcGFjZV9yZSB8fCBldmVudC5uYW1lc3BhY2VfcmUudGVzdCggaGFuZGxlT2JqLm5hbWVzcGFjZSApICkgew0KDQoJCQkJCWV2ZW50LmhhbmRsZU9iaiA9IGhhbmRsZU9iajsNCgkJCQkJZXZlbnQuZGF0YSA9IGhhbmRsZU9iai5kYXRhOw0KDQoJCQkJCXJldCA9ICggKGpRdWVyeS5ldmVudC5zcGVjaWFsWyBoYW5kbGVPYmoub3JpZ1R5cGUgXSB8fCB7fSkuaGFuZGxlIHx8IGhhbmRsZU9iai5oYW5kbGVyICkNCgkJCQkJCQkuYXBwbHkoIG1hdGNoZWQuZWxlbSwgYXJncyApOw0KDQoJCQkJCWlmICggcmV0ICE9PSB1bmRlZmluZWQgKSB7DQoJCQkJCQlpZiAoIChldmVudC5yZXN1bHQgPSByZXQpID09PSBmYWxzZSApIHsNCgkJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOw0KCQkJCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOw0KCQkJCQkJfQ0KCQkJCQl9DQoJCQkJfQ0KCQkJfQ0KCQl9DQoNCgkJLy8gQ2FsbCB0aGUgcG9zdERpc3BhdGNoIGhvb2sgZm9yIHRoZSBtYXBwZWQgdHlwZQ0KCQlpZiAoIHNwZWNpYWwucG9zdERpc3BhdGNoICkgew0KCQkJc3BlY2lhbC5wb3N0RGlzcGF0Y2guY2FsbCggdGhpcywgZXZlbnQgKTsNCgkJfQ0KDQoJCXJldHVybiBldmVudC5yZXN1bHQ7DQoJfSwNCg0KCWhhbmRsZXJzOiBmdW5jdGlvbiggZXZlbnQsIGhhbmRsZXJzICkgew0KCQl2YXIgc2VsLCBoYW5kbGVPYmosIG1hdGNoZXMsIGksDQoJCQloYW5kbGVyUXVldWUgPSBbXSwNCgkJCWRlbGVnYXRlQ291bnQgPSBoYW5kbGVycy5kZWxlZ2F0ZUNvdW50LA0KCQkJY3VyID0gZXZlbnQudGFyZ2V0Ow0KDQoJCS8vIEZpbmQgZGVsZWdhdGUgaGFuZGxlcnMNCgkJLy8gQmxhY2staG9sZSBTVkcgPHVzZT4gaW5zdGFuY2UgdHJlZXMgKCMxMzE4MCkNCgkJLy8gQXZvaWQgbm9uLWxlZnQtY2xpY2sgYnViYmxpbmcgaW4gRmlyZWZveCAoIzM4NjEpDQoJCWlmICggZGVsZWdhdGVDb3VudCAmJiBjdXIubm9kZVR5cGUgJiYgKCFldmVudC5idXR0b24gfHwgZXZlbnQudHlwZSAhPT0gImNsaWNrIikgKSB7DQoNCgkJCS8qIGpzaGludCBlcWVxZXE6IGZhbHNlICovDQoJCQlmb3IgKCA7IGN1ciAhPSB0aGlzOyBjdXIgPSBjdXIucGFyZW50Tm9kZSB8fCB0aGlzICkgew0KCQkJCS8qIGpzaGludCBlcWVxZXE6IHRydWUgKi8NCg0KCQkJCS8vIERvbid0IGNoZWNrIG5vbi1lbGVtZW50cyAoIzEzMjA4KQ0KCQkJCS8vIERvbid0IHByb2Nlc3MgY2xpY2tzIG9uIGRpc2FibGVkIGVsZW1lbnRzICgjNjkxMSwgIzgxNjUsICMxMTM4MiwgIzExNzY0KQ0KCQkJCWlmICggY3VyLm5vZGVUeXBlID09PSAxICYmIChjdXIuZGlzYWJsZWQgIT09IHRydWUgfHwgZXZlbnQudHlwZSAhPT0gImNsaWNrIikgKSB7DQoJCQkJCW1hdGNoZXMgPSBbXTsNCgkJCQkJZm9yICggaSA9IDA7IGkgPCBkZWxlZ2F0ZUNvdW50OyBpKysgKSB7DQoJCQkJCQloYW5kbGVPYmogPSBoYW5kbGVyc1sgaSBdOw0KDQoJCQkJCQkvLyBEb24ndCBjb25mbGljdCB3aXRoIE9iamVjdC5wcm90b3R5cGUgcHJvcGVydGllcyAoIzEzMjAzKQ0KCQkJCQkJc2VsID0gaGFuZGxlT2JqLnNlbGVjdG9yICsgIiAiOw0KDQoJCQkJCQlpZiAoIG1hdGNoZXNbIHNlbCBdID09PSB1bmRlZmluZWQgKSB7DQoJCQkJCQkJbWF0Y2hlc1sgc2VsIF0gPSBoYW5kbGVPYmoubmVlZHNDb250ZXh0ID8NCgkJCQkJCQkJalF1ZXJ5KCBzZWwsIHRoaXMgKS5pbmRleCggY3VyICkgPj0gMCA6DQoJCQkJCQkJCWpRdWVyeS5maW5kKCBzZWwsIHRoaXMsIG51bGwsIFsgY3VyIF0gKS5sZW5ndGg7DQoJCQkJCQl9DQoJCQkJCQlpZiAoIG1hdGNoZXNbIHNlbCBdICkgew0KCQkJCQkJCW1hdGNoZXMucHVzaCggaGFuZGxlT2JqICk7DQoJCQkJCQl9DQoJCQkJCX0NCgkJCQkJaWYgKCBtYXRjaGVzLmxlbmd0aCApIHsNCgkJCQkJCWhhbmRsZXJRdWV1ZS5wdXNoKHsgZWxlbTogY3VyLCBoYW5kbGVyczogbWF0Y2hlcyB9KTsNCgkJCQkJfQ0KCQkJCX0NCgkJCX0NCgkJfQ0KDQoJCS8vIEFkZCB0aGUgcmVtYWluaW5nIChkaXJlY3RseS1ib3VuZCkgaGFuZGxlcnMNCgkJaWYgKCBkZWxlZ2F0ZUNvdW50IDwgaGFuZGxlcnMubGVuZ3RoICkgew0KCQkJaGFuZGxlclF1ZXVlLnB1c2goeyBlbGVtOiB0aGlzLCBoYW5kbGVyczogaGFuZGxlcnMuc2xpY2UoIGRlbGVnYXRlQ291bnQgKSB9KTsNCgkJfQ0KDQoJCXJldHVybiBoYW5kbGVyUXVldWU7DQoJfSwNCg0KCWZpeDogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQlpZiAoIGV2ZW50WyBqUXVlcnkuZXhwYW5kbyBdICkgew0KCQkJcmV0dXJuIGV2ZW50Ow0KCQl9DQoNCgkJLy8gQ3JlYXRlIGEgd3JpdGFibGUgY29weSBvZiB0aGUgZXZlbnQgb2JqZWN0IGFuZCBub3JtYWxpemUgc29tZSBwcm9wZXJ0aWVzDQoJCXZhciBpLCBwcm9wLCBjb3B5LA0KCQkJdHlwZSA9IGV2ZW50LnR5cGUsDQoJCQlvcmlnaW5hbEV2ZW50ID0gZXZlbnQsDQoJCQlmaXhIb29rID0gdGhpcy5maXhIb29rc1sgdHlwZSBdOw0KDQoJCWlmICggIWZpeEhvb2sgKSB7DQoJCQl0aGlzLmZpeEhvb2tzWyB0eXBlIF0gPSBmaXhIb29rID0NCgkJCQlybW91c2VFdmVudC50ZXN0KCB0eXBlICkgPyB0aGlzLm1vdXNlSG9va3MgOg0KCQkJCXJrZXlFdmVudC50ZXN0KCB0eXBlICkgPyB0aGlzLmtleUhvb2tzIDoNCgkJCQl7fTsNCgkJfQ0KCQljb3B5ID0gZml4SG9vay5wcm9wcyA/IHRoaXMucHJvcHMuY29uY2F0KCBmaXhIb29rLnByb3BzICkgOiB0aGlzLnByb3BzOw0KDQoJCWV2ZW50ID0gbmV3IGpRdWVyeS5FdmVudCggb3JpZ2luYWxFdmVudCApOw0KDQoJCWkgPSBjb3B5Lmxlbmd0aDsNCgkJd2hpbGUgKCBpLS0gKSB7DQoJCQlwcm9wID0gY29weVsgaSBdOw0KCQkJZXZlbnRbIHByb3AgXSA9IG9yaWdpbmFsRXZlbnRbIHByb3AgXTsNCgkJfQ0KDQoJCS8vIFN1cHBvcnQ6IElFPDkNCgkJLy8gRml4IHRhcmdldCBwcm9wZXJ0eSAoIzE5MjUpDQoJCWlmICggIWV2ZW50LnRhcmdldCApIHsNCgkJCWV2ZW50LnRhcmdldCA9IG9yaWdpbmFsRXZlbnQuc3JjRWxlbWVudCB8fCBkb2N1bWVudDsNCgkJfQ0KDQoJCS8vIFN1cHBvcnQ6IENocm9tZSAyMyssIFNhZmFyaT8NCgkJLy8gVGFyZ2V0IHNob3VsZCBub3QgYmUgYSB0ZXh0IG5vZGUgKCM1MDQsICMxMzE0MykNCgkJaWYgKCBldmVudC50YXJnZXQubm9kZVR5cGUgPT09IDMgKSB7DQoJCQlldmVudC50YXJnZXQgPSBldmVudC50YXJnZXQucGFyZW50Tm9kZTsNCgkJfQ0KDQoJCS8vIFN1cHBvcnQ6IElFPDkNCgkJLy8gRm9yIG1vdXNlL2tleSBldmVudHMsIG1ldGFLZXk9PWZhbHNlIGlmIGl0J3MgdW5kZWZpbmVkICgjMzM2OCwgIzExMzI4KQ0KCQlldmVudC5tZXRhS2V5ID0gISFldmVudC5tZXRhS2V5Ow0KDQoJCXJldHVybiBmaXhIb29rLmZpbHRlciA/IGZpeEhvb2suZmlsdGVyKCBldmVudCwgb3JpZ2luYWxFdmVudCApIDogZXZlbnQ7DQoJfSwNCg0KCS8vIEluY2x1ZGVzIHNvbWUgZXZlbnQgcHJvcHMgc2hhcmVkIGJ5IEtleUV2ZW50IGFuZCBNb3VzZUV2ZW50DQoJcHJvcHM6ICJhbHRLZXkgYnViYmxlcyBjYW5jZWxhYmxlIGN0cmxLZXkgY3VycmVudFRhcmdldCBldmVudFBoYXNlIG1ldGFLZXkgcmVsYXRlZFRhcmdldCBzaGlmdEtleSB0YXJnZXQgdGltZVN0YW1wIHZpZXcgd2hpY2giLnNwbGl0KCIgIiksDQoNCglmaXhIb29rczoge30sDQoNCglrZXlIb29rczogew0KCQlwcm9wczogImNoYXIgY2hhckNvZGUga2V5IGtleUNvZGUiLnNwbGl0KCIgIiksDQoJCWZpbHRlcjogZnVuY3Rpb24oIGV2ZW50LCBvcmlnaW5hbCApIHsNCg0KCQkJLy8gQWRkIHdoaWNoIGZvciBrZXkgZXZlbnRzDQoJCQlpZiAoIGV2ZW50LndoaWNoID09IG51bGwgKSB7DQoJCQkJZXZlbnQud2hpY2ggPSBvcmlnaW5hbC5jaGFyQ29kZSAhPSBudWxsID8gb3JpZ2luYWwuY2hhckNvZGUgOiBvcmlnaW5hbC5rZXlDb2RlOw0KCQkJfQ0KDQoJCQlyZXR1cm4gZXZlbnQ7DQoJCX0NCgl9LA0KDQoJbW91c2VIb29rczogew0KCQlwcm9wczogImJ1dHRvbiBidXR0b25zIGNsaWVudFggY2xpZW50WSBmcm9tRWxlbWVudCBvZmZzZXRYIG9mZnNldFkgcGFnZVggcGFnZVkgc2NyZWVuWCBzY3JlZW5ZIHRvRWxlbWVudCIuc3BsaXQoIiAiKSwNCgkJZmlsdGVyOiBmdW5jdGlvbiggZXZlbnQsIG9yaWdpbmFsICkgew0KCQkJdmFyIGJvZHksIGV2ZW50RG9jLCBkb2MsDQoJCQkJYnV0dG9uID0gb3JpZ2luYWwuYnV0dG9uLA0KCQkJCWZyb21FbGVtZW50ID0gb3JpZ2luYWwuZnJvbUVsZW1lbnQ7DQoNCgkJCS8vIENhbGN1bGF0ZSBwYWdlWC9ZIGlmIG1pc3NpbmcgYW5kIGNsaWVudFgvWSBhdmFpbGFibGUNCgkJCWlmICggZXZlbnQucGFnZVggPT0gbnVsbCAmJiBvcmlnaW5hbC5jbGllbnRYICE9IG51bGwgKSB7DQoJCQkJZXZlbnREb2MgPSBldmVudC50YXJnZXQub3duZXJEb2N1bWVudCB8fCBkb2N1bWVudDsNCgkJCQlkb2MgPSBldmVudERvYy5kb2N1bWVudEVsZW1lbnQ7DQoJCQkJYm9keSA9IGV2ZW50RG9jLmJvZHk7DQoNCgkJCQlldmVudC5wYWdlWCA9IG9yaWdpbmFsLmNsaWVudFggKyAoIGRvYyAmJiBkb2Muc2Nyb2xsTGVmdCB8fCBib2R5ICYmIGJvZHkuc2Nyb2xsTGVmdCB8fCAwICkgLSAoIGRvYyAmJiBkb2MuY2xpZW50TGVmdCB8fCBib2R5ICYmIGJvZHkuY2xpZW50TGVmdCB8fCAwICk7DQoJCQkJZXZlbnQucGFnZVkgPSBvcmlnaW5hbC5jbGllbnRZICsgKCBkb2MgJiYgZG9jLnNjcm9sbFRvcCAgfHwgYm9keSAmJiBib2R5LnNjcm9sbFRvcCAgfHwgMCApIC0gKCBkb2MgJiYgZG9jLmNsaWVudFRvcCAgfHwgYm9keSAmJiBib2R5LmNsaWVudFRvcCAgfHwgMCApOw0KCQkJfQ0KDQoJCQkvLyBBZGQgcmVsYXRlZFRhcmdldCwgaWYgbmVjZXNzYXJ5DQoJCQlpZiAoICFldmVudC5yZWxhdGVkVGFyZ2V0ICYmIGZyb21FbGVtZW50ICkgew0KCQkJCWV2ZW50LnJlbGF0ZWRUYXJnZXQgPSBmcm9tRWxlbWVudCA9PT0gZXZlbnQudGFyZ2V0ID8gb3JpZ2luYWwudG9FbGVtZW50IDogZnJvbUVsZW1lbnQ7DQoJCQl9DQoNCgkJCS8vIEFkZCB3aGljaCBmb3IgY2xpY2s6IDEgPT09IGxlZnQ7IDIgPT09IG1pZGRsZTsgMyA9PT0gcmlnaHQNCgkJCS8vIE5vdGU6IGJ1dHRvbiBpcyBub3Qgbm9ybWFsaXplZCwgc28gZG9uJ3QgdXNlIGl0DQoJCQlpZiAoICFldmVudC53aGljaCAmJiBidXR0b24gIT09IHVuZGVmaW5lZCApIHsNCgkJCQlldmVudC53aGljaCA9ICggYnV0dG9uICYgMSA/IDEgOiAoIGJ1dHRvbiAmIDIgPyAzIDogKCBidXR0b24gJiA0ID8gMiA6IDAgKSApICk7DQoJCQl9DQoNCgkJCXJldHVybiBldmVudDsNCgkJfQ0KCX0sDQoNCglzcGVjaWFsOiB7DQoJCWxvYWQ6IHsNCgkJCS8vIFByZXZlbnQgdHJpZ2dlcmVkIGltYWdlLmxvYWQgZXZlbnRzIGZyb20gYnViYmxpbmcgdG8gd2luZG93LmxvYWQNCgkJCW5vQnViYmxlOiB0cnVlDQoJCX0sDQoJCWZvY3VzOiB7DQoJCQkvLyBGaXJlIG5hdGl2ZSBldmVudCBpZiBwb3NzaWJsZSBzbyBibHVyL2ZvY3VzIHNlcXVlbmNlIGlzIGNvcnJlY3QNCgkJCXRyaWdnZXI6IGZ1bmN0aW9uKCkgew0KCQkJCWlmICggdGhpcyAhPT0gc2FmZUFjdGl2ZUVsZW1lbnQoKSAmJiB0aGlzLmZvY3VzICkgew0KCQkJCQl0cnkgew0KCQkJCQkJdGhpcy5mb2N1cygpOw0KCQkJCQkJcmV0dXJuIGZhbHNlOw0KCQkJCQl9IGNhdGNoICggZSApIHsNCgkJCQkJCS8vIFN1cHBvcnQ6IElFPDkNCgkJCQkJCS8vIElmIHdlIGVycm9yIG9uIGZvY3VzIHRvIGhpZGRlbiBlbGVtZW50ICgjMTQ4NiwgIzEyNTE4KSwNCgkJCQkJCS8vIGxldCAudHJpZ2dlcigpIHJ1biB0aGUgaGFuZGxlcnMNCgkJCQkJfQ0KCQkJCX0NCgkJCX0sDQoJCQlkZWxlZ2F0ZVR5cGU6ICJmb2N1c2luIg0KCQl9LA0KCQlibHVyOiB7DQoJCQl0cmlnZ2VyOiBmdW5jdGlvbigpIHsNCgkJCQlpZiAoIHRoaXMgPT09IHNhZmVBY3RpdmVFbGVtZW50KCkgJiYgdGhpcy5ibHVyICkgew0KCQkJCQl0aGlzLmJsdXIoKTsNCgkJCQkJcmV0dXJuIGZhbHNlOw0KCQkJCX0NCgkJCX0sDQoJCQlkZWxlZ2F0ZVR5cGU6ICJmb2N1c291dCINCgkJfSwNCgkJY2xpY2s6IHsNCgkJCS8vIEZvciBjaGVja2JveCwgZmlyZSBuYXRpdmUgZXZlbnQgc28gY2hlY2tlZCBzdGF0ZSB3aWxsIGJlIHJpZ2h0DQoJCQl0cmlnZ2VyOiBmdW5jdGlvbigpIHsNCgkJCQlpZiAoIGpRdWVyeS5ub2RlTmFtZSggdGhpcywgImlucHV0IiApICYmIHRoaXMudHlwZSA9PT0gImNoZWNrYm94IiAmJiB0aGlzLmNsaWNrICkgew0KCQkJCQl0aGlzLmNsaWNrKCk7DQoJCQkJCXJldHVybiBmYWxzZTsNCgkJCQl9DQoJCQl9LA0KDQoJCQkvLyBGb3IgY3Jvc3MtYnJvd3NlciBjb25zaXN0ZW5jeSwgZG9uJ3QgZmlyZSBuYXRpdmUgLmNsaWNrKCkgb24gbGlua3MNCgkJCV9kZWZhdWx0OiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCQkJcmV0dXJuIGpRdWVyeS5ub2RlTmFtZSggZXZlbnQudGFyZ2V0LCAiYSIgKTsNCgkJCX0NCgkJfSwNCg0KCQliZWZvcmV1bmxvYWQ6IHsNCgkJCXBvc3REaXNwYXRjaDogZnVuY3Rpb24oIGV2ZW50ICkgew0KDQoJCQkJLy8gRXZlbiB3aGVuIHJldHVyblZhbHVlIGVxdWFscyB0byB1bmRlZmluZWQgRmlyZWZveCB3aWxsIHN0aWxsIHNob3cgYWxlcnQNCgkJCQlpZiAoIGV2ZW50LnJlc3VsdCAhPT0gdW5kZWZpbmVkICkgew0KCQkJCQlldmVudC5vcmlnaW5hbEV2ZW50LnJldHVyblZhbHVlID0gZXZlbnQucmVzdWx0Ow0KCQkJCX0NCgkJCX0NCgkJfQ0KCX0sDQoNCglzaW11bGF0ZTogZnVuY3Rpb24oIHR5cGUsIGVsZW0sIGV2ZW50LCBidWJibGUgKSB7DQoJCS8vIFBpZ2d5YmFjayBvbiBhIGRvbm9yIGV2ZW50IHRvIHNpbXVsYXRlIGEgZGlmZmVyZW50IG9uZS4NCgkJLy8gRmFrZSBvcmlnaW5hbEV2ZW50IHRvIGF2b2lkIGRvbm9yJ3Mgc3RvcFByb3BhZ2F0aW9uLCBidXQgaWYgdGhlDQoJCS8vIHNpbXVsYXRlZCBldmVudCBwcmV2ZW50cyBkZWZhdWx0IHRoZW4gd2UgZG8gdGhlIHNhbWUgb24gdGhlIGRvbm9yLg0KCQl2YXIgZSA9IGpRdWVyeS5leHRlbmQoDQoJCQluZXcgalF1ZXJ5LkV2ZW50KCksDQoJCQlldmVudCwNCgkJCXsNCgkJCQl0eXBlOiB0eXBlLA0KCQkJCWlzU2ltdWxhdGVkOiB0cnVlLA0KCQkJCW9yaWdpbmFsRXZlbnQ6IHt9DQoJCQl9DQoJCSk7DQoJCWlmICggYnViYmxlICkgew0KCQkJalF1ZXJ5LmV2ZW50LnRyaWdnZXIoIGUsIG51bGwsIGVsZW0gKTsNCgkJfSBlbHNlIHsNCgkJCWpRdWVyeS5ldmVudC5kaXNwYXRjaC5jYWxsKCBlbGVtLCBlICk7DQoJCX0NCgkJaWYgKCBlLmlzRGVmYXVsdFByZXZlbnRlZCgpICkgew0KCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsNCgkJfQ0KCX0NCn07DQoNCmpRdWVyeS5yZW1vdmVFdmVudCA9IGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIgPw0KCWZ1bmN0aW9uKCBlbGVtLCB0eXBlLCBoYW5kbGUgKSB7DQoJCWlmICggZWxlbS5yZW1vdmVFdmVudExpc3RlbmVyICkgew0KCQkJZWxlbS5yZW1vdmVFdmVudExpc3RlbmVyKCB0eXBlLCBoYW5kbGUsIGZhbHNlICk7DQoJCX0NCgl9IDoNCglmdW5jdGlvbiggZWxlbSwgdHlwZSwgaGFuZGxlICkgew0KCQl2YXIgbmFtZSA9ICJvbiIgKyB0eXBlOw0KDQoJCWlmICggZWxlbS5kZXRhY2hFdmVudCApIHsNCg0KCQkJLy8gIzg1NDUsICM3MDU0LCBwcmV2ZW50aW5nIG1lbW9yeSBsZWFrcyBmb3IgY3VzdG9tIGV2ZW50cyBpbiBJRTYtOA0KCQkJLy8gZGV0YWNoRXZlbnQgbmVlZGVkIHByb3BlcnR5IG9uIGVsZW1lbnQsIGJ5IG5hbWUgb2YgdGhhdCBldmVudCwgdG8gcHJvcGVybHkgZXhwb3NlIGl0IHRvIEdDDQoJCQlpZiAoIHR5cGVvZiBlbGVtWyBuYW1lIF0gPT09IGNvcmVfc3RydW5kZWZpbmVkICkgew0KCQkJCWVsZW1bIG5hbWUgXSA9IG51bGw7DQoJCQl9DQoNCgkJCWVsZW0uZGV0YWNoRXZlbnQoIG5hbWUsIGhhbmRsZSApOw0KCQl9DQoJfTsNCg0KalF1ZXJ5LkV2ZW50ID0gZnVuY3Rpb24oIHNyYywgcHJvcHMgKSB7DQoJLy8gQWxsb3cgaW5zdGFudGlhdGlvbiB3aXRob3V0IHRoZSAnbmV3JyBrZXl3b3JkDQoJaWYgKCAhKHRoaXMgaW5zdGFuY2VvZiBqUXVlcnkuRXZlbnQpICkgew0KCQlyZXR1cm4gbmV3IGpRdWVyeS5FdmVudCggc3JjLCBwcm9wcyApOw0KCX0NCg0KCS8vIEV2ZW50IG9iamVjdA0KCWlmICggc3JjICYmIHNyYy50eXBlICkgew0KCQl0aGlzLm9yaWdpbmFsRXZlbnQgPSBzcmM7DQoJCXRoaXMudHlwZSA9IHNyYy50eXBlOw0KDQoJCS8vIEV2ZW50cyBidWJibGluZyB1cCB0aGUgZG9jdW1lbnQgbWF5IGhhdmUgYmVlbiBtYXJrZWQgYXMgcHJldmVudGVkDQoJCS8vIGJ5IGEgaGFuZGxlciBsb3dlciBkb3duIHRoZSB0cmVlOyByZWZsZWN0IHRoZSBjb3JyZWN0IHZhbHVlLg0KCQl0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9ICggc3JjLmRlZmF1bHRQcmV2ZW50ZWQgfHwgc3JjLnJldHVyblZhbHVlID09PSBmYWxzZSB8fA0KCQkJc3JjLmdldFByZXZlbnREZWZhdWx0ICYmIHNyYy5nZXRQcmV2ZW50RGVmYXVsdCgpICkgPyByZXR1cm5UcnVlIDogcmV0dXJuRmFsc2U7DQoNCgkvLyBFdmVudCB0eXBlDQoJfSBlbHNlIHsNCgkJdGhpcy50eXBlID0gc3JjOw0KCX0NCg0KCS8vIFB1dCBleHBsaWNpdGx5IHByb3ZpZGVkIHByb3BlcnRpZXMgb250byB0aGUgZXZlbnQgb2JqZWN0DQoJaWYgKCBwcm9wcyApIHsNCgkJalF1ZXJ5LmV4dGVuZCggdGhpcywgcHJvcHMgKTsNCgl9DQoNCgkvLyBDcmVhdGUgYSB0aW1lc3RhbXAgaWYgaW5jb21pbmcgZXZlbnQgZG9lc24ndCBoYXZlIG9uZQ0KCXRoaXMudGltZVN0YW1wID0gc3JjICYmIHNyYy50aW1lU3RhbXAgfHwgalF1ZXJ5Lm5vdygpOw0KDQoJLy8gTWFyayBpdCBhcyBmaXhlZA0KCXRoaXNbIGpRdWVyeS5leHBhbmRvIF0gPSB0cnVlOw0KfTsNCg0KLy8galF1ZXJ5LkV2ZW50IGlzIGJhc2VkIG9uIERPTTMgRXZlbnRzIGFzIHNwZWNpZmllZCBieSB0aGUgRUNNQVNjcmlwdCBMYW5ndWFnZSBCaW5kaW5nDQovLyBodHRwOi8vd3d3LnczLm9yZy9UUi8yMDAzL1dELURPTS1MZXZlbC0zLUV2ZW50cy0yMDAzMDMzMS9lY21hLXNjcmlwdC1iaW5kaW5nLmh0bWwNCmpRdWVyeS5FdmVudC5wcm90b3R5cGUgPSB7DQoJaXNEZWZhdWx0UHJldmVudGVkOiByZXR1cm5GYWxzZSwNCglpc1Byb3BhZ2F0aW9uU3RvcHBlZDogcmV0dXJuRmFsc2UsDQoJaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQ6IHJldHVybkZhbHNlLA0KDQoJcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uKCkgew0KCQl2YXIgZSA9IHRoaXMub3JpZ2luYWxFdmVudDsNCg0KCQl0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9IHJldHVyblRydWU7DQoJCWlmICggIWUgKSB7DQoJCQlyZXR1cm47DQoJCX0NCg0KCQkvLyBJZiBwcmV2ZW50RGVmYXVsdCBleGlzdHMsIHJ1biBpdCBvbiB0aGUgb3JpZ2luYWwgZXZlbnQNCgkJaWYgKCBlLnByZXZlbnREZWZhdWx0ICkgew0KCQkJZS5wcmV2ZW50RGVmYXVsdCgpOw0KDQoJCS8vIFN1cHBvcnQ6IElFDQoJCS8vIE90aGVyd2lzZSBzZXQgdGhlIHJldHVyblZhbHVlIHByb3BlcnR5IG9mIHRoZSBvcmlnaW5hbCBldmVudCB0byBmYWxzZQ0KCQl9IGVsc2Ugew0KCQkJZS5yZXR1cm5WYWx1ZSA9IGZhbHNlOw0KCQl9DQoJfSwNCglzdG9wUHJvcGFnYXRpb246IGZ1bmN0aW9uKCkgew0KCQl2YXIgZSA9IHRoaXMub3JpZ2luYWxFdmVudDsNCg0KCQl0aGlzLmlzUHJvcGFnYXRpb25TdG9wcGVkID0gcmV0dXJuVHJ1ZTsNCgkJaWYgKCAhZSApIHsNCgkJCXJldHVybjsNCgkJfQ0KCQkvLyBJZiBzdG9wUHJvcGFnYXRpb24gZXhpc3RzLCBydW4gaXQgb24gdGhlIG9yaWdpbmFsIGV2ZW50DQoJCWlmICggZS5zdG9wUHJvcGFnYXRpb24gKSB7DQoJCQllLnN0b3BQcm9wYWdhdGlvbigpOw0KCQl9DQoNCgkJLy8gU3VwcG9ydDogSUUNCgkJLy8gU2V0IHRoZSBjYW5jZWxCdWJibGUgcHJvcGVydHkgb2YgdGhlIG9yaWdpbmFsIGV2ZW50IHRvIHRydWUNCgkJZS5jYW5jZWxCdWJibGUgPSB0cnVlOw0KCX0sDQoJc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uOiBmdW5jdGlvbigpIHsNCgkJdGhpcy5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCA9IHJldHVyblRydWU7DQoJCXRoaXMuc3RvcFByb3BhZ2F0aW9uKCk7DQoJfQ0KfTsNCg0KLy8gQ3JlYXRlIG1vdXNlZW50ZXIvbGVhdmUgZXZlbnRzIHVzaW5nIG1vdXNlb3Zlci9vdXQgYW5kIGV2ZW50LXRpbWUgY2hlY2tzDQpqUXVlcnkuZWFjaCh7DQoJbW91c2VlbnRlcjogIm1vdXNlb3ZlciIsDQoJbW91c2VsZWF2ZTogIm1vdXNlb3V0Ig0KfSwgZnVuY3Rpb24oIG9yaWcsIGZpeCApIHsNCglqUXVlcnkuZXZlbnQuc3BlY2lhbFsgb3JpZyBdID0gew0KCQlkZWxlZ2F0ZVR5cGU6IGZpeCwNCgkJYmluZFR5cGU6IGZpeCwNCg0KCQloYW5kbGU6IGZ1bmN0aW9uKCBldmVudCApIHsNCgkJCXZhciByZXQsDQoJCQkJdGFyZ2V0ID0gdGhpcywNCgkJCQlyZWxhdGVkID0gZXZlbnQucmVsYXRlZFRhcmdldCwNCgkJCQloYW5kbGVPYmogPSBldmVudC5oYW5kbGVPYmo7DQoNCgkJCS8vIEZvciBtb3VzZW50ZXIvbGVhdmUgY2FsbCB0aGUgaGFuZGxlciBpZiByZWxhdGVkIGlzIG91dHNpZGUgdGhlIHRhcmdldC4NCgkJCS8vIE5COiBObyByZWxhdGVkVGFyZ2V0IGlmIHRoZSBtb3VzZSBsZWZ0L2VudGVyZWQgdGhlIGJyb3dzZXIgd2luZG93DQoJCQlpZiAoICFyZWxhdGVkIHx8IChyZWxhdGVkICE9PSB0YXJnZXQgJiYgIWpRdWVyeS5jb250YWlucyggdGFyZ2V0LCByZWxhdGVkICkpICkgew0KCQkJCWV2ZW50LnR5cGUgPSBoYW5kbGVPYmoub3JpZ1R5cGU7DQoJCQkJcmV0ID0gaGFuZGxlT2JqLmhhbmRsZXIuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOw0KCQkJCWV2ZW50LnR5cGUgPSBmaXg7DQoJCQl9DQoJCQlyZXR1cm4gcmV0Ow0KCQl9DQoJfTsNCn0pOw0KDQovLyBJRSBzdWJtaXQgZGVsZWdhdGlvbg0KaWYgKCAhalF1ZXJ5LnN1cHBvcnQuc3VibWl0QnViYmxlcyApIHsNCg0KCWpRdWVyeS5ldmVudC5zcGVjaWFsLnN1Ym1pdCA9IHsNCgkJc2V0dXA6IGZ1bmN0aW9uKCkgew0KCQkJLy8gT25seSBuZWVkIHRoaXMgZm9yIGRlbGVnYXRlZCBmb3JtIHN1Ym1pdCBldmVudHMNCgkJCWlmICggalF1ZXJ5Lm5vZGVOYW1lKCB0aGlzLCAiZm9ybSIgKSApIHsNCgkJCQlyZXR1cm4gZmFsc2U7DQoJCQl9DQoNCgkJCS8vIExhenktYWRkIGEgc3VibWl0IGhhbmRsZXIgd2hlbiBhIGRlc2NlbmRhbnQgZm9ybSBtYXkgcG90ZW50aWFsbHkgYmUgc3VibWl0dGVkDQoJCQlqUXVlcnkuZXZlbnQuYWRkKCB0aGlzLCAiY2xpY2suX3N1Ym1pdCBrZXlwcmVzcy5fc3VibWl0IiwgZnVuY3Rpb24oIGUgKSB7DQoJCQkJLy8gTm9kZSBuYW1lIGNoZWNrIGF2b2lkcyBhIFZNTC1yZWxhdGVkIGNyYXNoIGluIElFICgjOTgwNykNCgkJCQl2YXIgZWxlbSA9IGUudGFyZ2V0LA0KCQkJCQlmb3JtID0galF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAiaW5wdXQiICkgfHwgalF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAiYnV0dG9uIiApID8gZWxlbS5mb3JtIDogdW5kZWZpbmVkOw0KCQkJCWlmICggZm9ybSAmJiAhalF1ZXJ5Ll9kYXRhKCBmb3JtLCAic3VibWl0QnViYmxlcyIgKSApIHsNCgkJCQkJalF1ZXJ5LmV2ZW50LmFkZCggZm9ybSwgInN1Ym1pdC5fc3VibWl0IiwgZnVuY3Rpb24oIGV2ZW50ICkgew0KCQkJCQkJZXZlbnQuX3N1Ym1pdF9idWJibGUgPSB0cnVlOw0KCQkJCQl9KTsNCgkJCQkJalF1ZXJ5Ll9kYXRhKCBmb3JtLCAic3VibWl0QnViYmxlcyIsIHRydWUgKTsNCgkJCQl9DQoJCQl9KTsNCgkJCS8vIHJldHVybiB1bmRlZmluZWQgc2luY2Ugd2UgZG9uJ3QgbmVlZCBhbiBldmVudCBsaXN0ZW5lcg0KCQl9LA0KDQoJCXBvc3REaXNwYXRjaDogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQkJLy8gSWYgZm9ybSB3YXMgc3VibWl0dGVkIGJ5IHRoZSB1c2VyLCBidWJibGUgdGhlIGV2ZW50IHVwIHRoZSB0cmVlDQoJCQlpZiAoIGV2ZW50Ll9zdWJtaXRfYnViYmxlICkgew0KCQkJCWRlbGV0ZSBldmVudC5fc3VibWl0X2J1YmJsZTsNCgkJCQlpZiAoIHRoaXMucGFyZW50Tm9kZSAmJiAhZXZlbnQuaXNUcmlnZ2VyICkgew0KCQkJCQlqUXVlcnkuZXZlbnQuc2ltdWxhdGUoICJzdWJtaXQiLCB0aGlzLnBhcmVudE5vZGUsIGV2ZW50LCB0cnVlICk7DQoJCQkJfQ0KCQkJfQ0KCQl9LA0KDQoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsNCgkJCS8vIE9ubHkgbmVlZCB0aGlzIGZvciBkZWxlZ2F0ZWQgZm9ybSBzdWJtaXQgZXZlbnRzDQoJCQlpZiAoIGpRdWVyeS5ub2RlTmFtZSggdGhpcywgImZvcm0iICkgKSB7DQoJCQkJcmV0dXJuIGZhbHNlOw0KCQkJfQ0KDQoJCQkvLyBSZW1vdmUgZGVsZWdhdGVkIGhhbmRsZXJzOyBjbGVhbkRhdGEgZXZlbnR1YWxseSByZWFwcyBzdWJtaXQgaGFuZGxlcnMgYXR0YWNoZWQgYWJvdmUNCgkJCWpRdWVyeS5ldmVudC5yZW1vdmUoIHRoaXMsICIuX3N1Ym1pdCIgKTsNCgkJfQ0KCX07DQp9DQoNCi8vIElFIGNoYW5nZSBkZWxlZ2F0aW9uIGFuZCBjaGVja2JveC9yYWRpbyBmaXgNCmlmICggIWpRdWVyeS5zdXBwb3J0LmNoYW5nZUJ1YmJsZXMgKSB7DQoNCglqUXVlcnkuZXZlbnQuc3BlY2lhbC5jaGFuZ2UgPSB7DQoNCgkJc2V0dXA6IGZ1bmN0aW9uKCkgew0KDQoJCQlpZiAoIHJmb3JtRWxlbXMudGVzdCggdGhpcy5ub2RlTmFtZSApICkgew0KCQkJCS8vIElFIGRvZXNuJ3QgZmlyZSBjaGFuZ2Ugb24gYSBjaGVjay9yYWRpbyB1bnRpbCBibHVyOyB0cmlnZ2VyIGl0IG9uIGNsaWNrDQoJCQkJLy8gYWZ0ZXIgYSBwcm9wZXJ0eWNoYW5nZS4gRWF0IHRoZSBibHVyLWNoYW5nZSBpbiBzcGVjaWFsLmNoYW5nZS5oYW5kbGUuDQoJCQkJLy8gVGhpcyBzdGlsbCBmaXJlcyBvbmNoYW5nZSBhIHNlY29uZCB0aW1lIGZvciBjaGVjay9yYWRpbyBhZnRlciBibHVyLg0KCQkJCWlmICggdGhpcy50eXBlID09PSAiY2hlY2tib3giIHx8IHRoaXMudHlwZSA9PT0gInJhZGlvIiApIHsNCgkJCQkJalF1ZXJ5LmV2ZW50LmFkZCggdGhpcywgInByb3BlcnR5Y2hhbmdlLl9jaGFuZ2UiLCBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCQkJCQlpZiAoIGV2ZW50Lm9yaWdpbmFsRXZlbnQucHJvcGVydHlOYW1lID09PSAiY2hlY2tlZCIgKSB7DQoJCQkJCQkJdGhpcy5fanVzdF9jaGFuZ2VkID0gdHJ1ZTsNCgkJCQkJCX0NCgkJCQkJfSk7DQoJCQkJCWpRdWVyeS5ldmVudC5hZGQoIHRoaXMsICJjbGljay5fY2hhbmdlIiwgZnVuY3Rpb24oIGV2ZW50ICkgew0KCQkJCQkJaWYgKCB0aGlzLl9qdXN0X2NoYW5nZWQgJiYgIWV2ZW50LmlzVHJpZ2dlciApIHsNCgkJCQkJCQl0aGlzLl9qdXN0X2NoYW5nZWQgPSBmYWxzZTsNCgkJCQkJCX0NCgkJCQkJCS8vIEFsbG93IHRyaWdnZXJlZCwgc2ltdWxhdGVkIGNoYW5nZSBldmVudHMgKCMxMTUwMCkNCgkJCQkJCWpRdWVyeS5ldmVudC5zaW11bGF0ZSggImNoYW5nZSIsIHRoaXMsIGV2ZW50LCB0cnVlICk7DQoJCQkJCX0pOw0KCQkJCX0NCgkJCQlyZXR1cm4gZmFsc2U7DQoJCQl9DQoJCQkvLyBEZWxlZ2F0ZWQgZXZlbnQ7IGxhenktYWRkIGEgY2hhbmdlIGhhbmRsZXIgb24gZGVzY2VuZGFudCBpbnB1dHMNCgkJCWpRdWVyeS5ldmVudC5hZGQoIHRoaXMsICJiZWZvcmVhY3RpdmF0ZS5fY2hhbmdlIiwgZnVuY3Rpb24oIGUgKSB7DQoJCQkJdmFyIGVsZW0gPSBlLnRhcmdldDsNCg0KCQkJCWlmICggcmZvcm1FbGVtcy50ZXN0KCBlbGVtLm5vZGVOYW1lICkgJiYgIWpRdWVyeS5fZGF0YSggZWxlbSwgImNoYW5nZUJ1YmJsZXMiICkgKSB7DQoJCQkJCWpRdWVyeS5ldmVudC5hZGQoIGVsZW0sICJjaGFuZ2UuX2NoYW5nZSIsIGZ1bmN0aW9uKCBldmVudCApIHsNCgkJCQkJCWlmICggdGhpcy5wYXJlbnROb2RlICYmICFldmVudC5pc1NpbXVsYXRlZCAmJiAhZXZlbnQuaXNUcmlnZ2VyICkgew0KCQkJCQkJCWpRdWVyeS5ldmVudC5zaW11bGF0ZSggImNoYW5nZSIsIHRoaXMucGFyZW50Tm9kZSwgZXZlbnQsIHRydWUgKTsNCgkJCQkJCX0NCgkJCQkJfSk7DQoJCQkJCWpRdWVyeS5fZGF0YSggZWxlbSwgImNoYW5nZUJ1YmJsZXMiLCB0cnVlICk7DQoJCQkJfQ0KCQkJfSk7DQoJCX0sDQoNCgkJaGFuZGxlOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCQl2YXIgZWxlbSA9IGV2ZW50LnRhcmdldDsNCg0KCQkJLy8gU3dhbGxvdyBuYXRpdmUgY2hhbmdlIGV2ZW50cyBmcm9tIGNoZWNrYm94L3JhZGlvLCB3ZSBhbHJlYWR5IHRyaWdnZXJlZCB0aGVtIGFib3ZlDQoJCQlpZiAoIHRoaXMgIT09IGVsZW0gfHwgZXZlbnQuaXNTaW11bGF0ZWQgfHwgZXZlbnQuaXNUcmlnZ2VyIHx8IChlbGVtLnR5cGUgIT09ICJyYWRpbyIgJiYgZWxlbS50eXBlICE9PSAiY2hlY2tib3giKSApIHsNCgkJCQlyZXR1cm4gZXZlbnQuaGFuZGxlT2JqLmhhbmRsZXIuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOw0KCQkJfQ0KCQl9LA0KDQoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsNCgkJCWpRdWVyeS5ldmVudC5yZW1vdmUoIHRoaXMsICIuX2NoYW5nZSIgKTsNCg0KCQkJcmV0dXJuICFyZm9ybUVsZW1zLnRlc3QoIHRoaXMubm9kZU5hbWUgKTsNCgkJfQ0KCX07DQp9DQoNCi8vIENyZWF0ZSAiYnViYmxpbmciIGZvY3VzIGFuZCBibHVyIGV2ZW50cw0KaWYgKCAhalF1ZXJ5LnN1cHBvcnQuZm9jdXNpbkJ1YmJsZXMgKSB7DQoJalF1ZXJ5LmVhY2goeyBmb2N1czogImZvY3VzaW4iLCBibHVyOiAiZm9jdXNvdXQiIH0sIGZ1bmN0aW9uKCBvcmlnLCBmaXggKSB7DQoNCgkJLy8gQXR0YWNoIGEgc2luZ2xlIGNhcHR1cmluZyBoYW5kbGVyIHdoaWxlIHNvbWVvbmUgd2FudHMgZm9jdXNpbi9mb2N1c291dA0KCQl2YXIgYXR0YWNoZXMgPSAwLA0KCQkJaGFuZGxlciA9IGZ1bmN0aW9uKCBldmVudCApIHsNCgkJCQlqUXVlcnkuZXZlbnQuc2ltdWxhdGUoIGZpeCwgZXZlbnQudGFyZ2V0LCBqUXVlcnkuZXZlbnQuZml4KCBldmVudCApLCB0cnVlICk7DQoJCQl9Ow0KDQoJCWpRdWVyeS5ldmVudC5zcGVjaWFsWyBmaXggXSA9IHsNCgkJCXNldHVwOiBmdW5jdGlvbigpIHsNCgkJCQlpZiAoIGF0dGFjaGVzKysgPT09IDAgKSB7DQoJCQkJCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIG9yaWcsIGhhbmRsZXIsIHRydWUgKTsNCgkJCQl9DQoJCQl9LA0KCQkJdGVhcmRvd246IGZ1bmN0aW9uKCkgew0KCQkJCWlmICggLS1hdHRhY2hlcyA9PT0gMCApIHsNCgkJCQkJZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lciggb3JpZywgaGFuZGxlciwgdHJ1ZSApOw0KCQkJCX0NCgkJCX0NCgkJfTsNCgl9KTsNCn0NCg0KalF1ZXJ5LmZuLmV4dGVuZCh7DQoNCglvbjogZnVuY3Rpb24oIHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4sIC8qSU5URVJOQUwqLyBvbmUgKSB7DQoJCXZhciB0eXBlLCBvcmlnRm47DQoNCgkJLy8gVHlwZXMgY2FuIGJlIGEgbWFwIG9mIHR5cGVzL2hhbmRsZXJzDQoJCWlmICggdHlwZW9mIHR5cGVzID09PSAib2JqZWN0IiApIHsNCgkJCS8vICggdHlwZXMtT2JqZWN0LCBzZWxlY3RvciwgZGF0YSApDQoJCQlpZiAoIHR5cGVvZiBzZWxlY3RvciAhPT0gInN0cmluZyIgKSB7DQoJCQkJLy8gKCB0eXBlcy1PYmplY3QsIGRhdGEgKQ0KCQkJCWRhdGEgPSBkYXRhIHx8IHNlbGVjdG9yOw0KCQkJCXNlbGVjdG9yID0gdW5kZWZpbmVkOw0KCQkJfQ0KCQkJZm9yICggdHlwZSBpbiB0eXBlcyApIHsNCgkJCQl0aGlzLm9uKCB0eXBlLCBzZWxlY3RvciwgZGF0YSwgdHlwZXNbIHR5cGUgXSwgb25lICk7DQoJCQl9DQoJCQlyZXR1cm4gdGhpczsNCgkJfQ0KDQoJCWlmICggZGF0YSA9PSBudWxsICYmIGZuID09IG51bGwgKSB7DQoJCQkvLyAoIHR5cGVzLCBmbiApDQoJCQlmbiA9IHNlbGVjdG9yOw0KCQkJZGF0YSA9IHNlbGVjdG9yID0gdW5kZWZpbmVkOw0KCQl9IGVsc2UgaWYgKCBmbiA9PSBudWxsICkgew0KCQkJaWYgKCB0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciICkgew0KCQkJCS8vICggdHlwZXMsIHNlbGVjdG9yLCBmbiApDQoJCQkJZm4gPSBkYXRhOw0KCQkJCWRhdGEgPSB1bmRlZmluZWQ7DQoJCQl9IGVsc2Ugew0KCQkJCS8vICggdHlwZXMsIGRhdGEsIGZuICkNCgkJCQlmbiA9IGRhdGE7DQoJCQkJZGF0YSA9IHNlbGVjdG9yOw0KCQkJCXNlbGVjdG9yID0gdW5kZWZpbmVkOw0KCQkJfQ0KCQl9DQoJCWlmICggZm4gPT09IGZhbHNlICkgew0KCQkJZm4gPSByZXR1cm5GYWxzZTsNCgkJfSBlbHNlIGlmICggIWZuICkgew0KCQkJcmV0dXJuIHRoaXM7DQoJCX0NCg0KCQlpZiAoIG9uZSA9PT0gMSApIHsNCgkJCW9yaWdGbiA9IGZuOw0KCQkJZm4gPSBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCQkJLy8gQ2FuIHVzZSBhbiBlbXB0eSBzZXQsIHNpbmNlIGV2ZW50IGNvbnRhaW5zIHRoZSBpbmZvDQoJCQkJalF1ZXJ5KCkub2ZmKCBldmVudCApOw0KCQkJCXJldHVybiBvcmlnRm4uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOw0KCQkJfTsNCgkJCS8vIFVzZSBzYW1lIGd1aWQgc28gY2FsbGVyIGNhbiByZW1vdmUgdXNpbmcgb3JpZ0ZuDQoJCQlmbi5ndWlkID0gb3JpZ0ZuLmd1aWQgfHwgKCBvcmlnRm4uZ3VpZCA9IGpRdWVyeS5ndWlkKysgKTsNCgkJfQ0KCQlyZXR1cm4gdGhpcy5lYWNoKCBmdW5jdGlvbigpIHsNCgkJCWpRdWVyeS5ldmVudC5hZGQoIHRoaXMsIHR5cGVzLCBmbiwgZGF0YSwgc2VsZWN0b3IgKTsNCgkJfSk7DQoJfSwNCglvbmU6IGZ1bmN0aW9uKCB0eXBlcywgc2VsZWN0b3IsIGRhdGEsIGZuICkgew0KCQlyZXR1cm4gdGhpcy5vbiggdHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbiwgMSApOw0KCX0sDQoJb2ZmOiBmdW5jdGlvbiggdHlwZXMsIHNlbGVjdG9yLCBmbiApIHsNCgkJdmFyIGhhbmRsZU9iaiwgdHlwZTsNCgkJaWYgKCB0eXBlcyAmJiB0eXBlcy5wcmV2ZW50RGVmYXVsdCAmJiB0eXBlcy5oYW5kbGVPYmogKSB7DQoJCQkvLyAoIGV2ZW50ICkgIGRpc3BhdGNoZWQgalF1ZXJ5LkV2ZW50DQoJCQloYW5kbGVPYmogPSB0eXBlcy5oYW5kbGVPYmo7DQoJCQlqUXVlcnkoIHR5cGVzLmRlbGVnYXRlVGFyZ2V0ICkub2ZmKA0KCQkJCWhhbmRsZU9iai5uYW1lc3BhY2UgPyBoYW5kbGVPYmoub3JpZ1R5cGUgKyAiLiIgKyBoYW5kbGVPYmoubmFtZXNwYWNlIDogaGFuZGxlT2JqLm9yaWdUeXBlLA0KCQkJCWhhbmRsZU9iai5zZWxlY3RvciwNCgkJCQloYW5kbGVPYmouaGFuZGxlcg0KCQkJKTsNCgkJCXJldHVybiB0aGlzOw0KCQl9DQoJCWlmICggdHlwZW9mIHR5cGVzID09PSAib2JqZWN0IiApIHsNCgkJCS8vICggdHlwZXMtb2JqZWN0IFssIHNlbGVjdG9yXSApDQoJCQlmb3IgKCB0eXBlIGluIHR5cGVzICkgew0KCQkJCXRoaXMub2ZmKCB0eXBlLCBzZWxlY3RvciwgdHlwZXNbIHR5cGUgXSApOw0KCQkJfQ0KCQkJcmV0dXJuIHRoaXM7DQoJCX0NCgkJaWYgKCBzZWxlY3RvciA9PT0gZmFsc2UgfHwgdHlwZW9mIHNlbGVjdG9yID09PSAiZnVuY3Rpb24iICkgew0KCQkJLy8gKCB0eXBlcyBbLCBmbl0gKQ0KCQkJZm4gPSBzZWxlY3RvcjsNCgkJCXNlbGVjdG9yID0gdW5kZWZpbmVkOw0KCQl9DQoJCWlmICggZm4gPT09IGZhbHNlICkgew0KCQkJZm4gPSByZXR1cm5GYWxzZTsNCgkJfQ0KCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgew0KCQkJalF1ZXJ5LmV2ZW50LnJlbW92ZSggdGhpcywgdHlwZXMsIGZuLCBzZWxlY3RvciApOw0KCQl9KTsNCgl9LA0KDQoJdHJpZ2dlcjogZnVuY3Rpb24oIHR5cGUsIGRhdGEgKSB7DQoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7DQoJCQlqUXVlcnkuZXZlbnQudHJpZ2dlciggdHlwZSwgZGF0YSwgdGhpcyApOw0KCQl9KTsNCgl9LA0KCXRyaWdnZXJIYW5kbGVyOiBmdW5jdGlvbiggdHlwZSwgZGF0YSApIHsNCgkJdmFyIGVsZW0gPSB0aGlzWzBdOw0KCQlpZiAoIGVsZW0gKSB7DQoJCQlyZXR1cm4galF1ZXJ5LmV2ZW50LnRyaWdnZXIoIHR5cGUsIGRhdGEsIGVsZW0sIHRydWUgKTsNCgkJfQ0KCX0NCn0pOw0KdmFyIGlzU2ltcGxlID0gL14uW146I1xbXC4sXSokLywNCglycGFyZW50c3ByZXYgPSAvXig/OnBhcmVudHN8cHJldig/OlVudGlsfEFsbCkpLywNCglybmVlZHNDb250ZXh0ID0galF1ZXJ5LmV4cHIubWF0Y2gubmVlZHNDb250ZXh0LA0KCS8vIG1ldGhvZHMgZ3VhcmFudGVlZCB0byBwcm9kdWNlIGEgdW5pcXVlIHNldCB3aGVuIHN0YXJ0aW5nIGZyb20gYSB1bmlxdWUgc2V0DQoJZ3VhcmFudGVlZFVuaXF1ZSA9IHsNCgkJY2hpbGRyZW46IHRydWUsDQoJCWNvbnRlbnRzOiB0cnVlLA0KCQluZXh0OiB0cnVlLA0KCQlwcmV2OiB0cnVlDQoJfTsNCg0KalF1ZXJ5LmZuLmV4dGVuZCh7DQoJZmluZDogZnVuY3Rpb24oIHNlbGVjdG9yICkgew0KCQl2YXIgaSwNCgkJCXJldCA9IFtdLA0KCQkJc2VsZiA9IHRoaXMsDQoJCQlsZW4gPSBzZWxmLmxlbmd0aDsNCg0KCQlpZiAoIHR5cGVvZiBzZWxlY3RvciAhPT0gInN0cmluZyIgKSB7DQoJCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIGpRdWVyeSggc2VsZWN0b3IgKS5maWx0ZXIoZnVuY3Rpb24oKSB7DQoJCQkJZm9yICggaSA9IDA7IGkgPCBsZW47IGkrKyApIHsNCgkJCQkJaWYgKCBqUXVlcnkuY29udGFpbnMoIHNlbGZbIGkgXSwgdGhpcyApICkgew0KCQkJCQkJcmV0dXJuIHRydWU7DQoJCQkJCX0NCgkJCQl9DQoJCQl9KSApOw0KCQl9DQoNCgkJZm9yICggaSA9IDA7IGkgPCBsZW47IGkrKyApIHsNCgkJCWpRdWVyeS5maW5kKCBzZWxlY3Rvciwgc2VsZlsgaSBdLCByZXQgKTsNCgkJfQ0KDQoJCS8vIE5lZWRlZCBiZWNhdXNlICQoIHNlbGVjdG9yLCBjb250ZXh0ICkgYmVjb21lcyAkKCBjb250ZXh0ICkuZmluZCggc2VsZWN0b3IgKQ0KCQlyZXQgPSB0aGlzLnB1c2hTdGFjayggbGVuID4gMSA/IGpRdWVyeS51bmlxdWUoIHJldCApIDogcmV0ICk7DQoJCXJldC5zZWxlY3RvciA9IHRoaXMuc2VsZWN0b3IgPyB0aGlzLnNlbGVjdG9yICsgIiAiICsgc2VsZWN0b3IgOiBzZWxlY3RvcjsNCgkJcmV0dXJuIHJldDsNCgl9LA0KDQoJaGFzOiBmdW5jdGlvbiggdGFyZ2V0ICkgew0KCQl2YXIgaSwNCgkJCXRhcmdldHMgPSBqUXVlcnkoIHRhcmdldCwgdGhpcyApLA0KCQkJbGVuID0gdGFyZ2V0cy5sZW5ndGg7DQoNCgkJcmV0dXJuIHRoaXMuZmlsdGVyKGZ1bmN0aW9uKCkgew0KCQkJZm9yICggaSA9IDA7IGkgPCBsZW47IGkrKyApIHsNCgkJCQlpZiAoIGpRdWVyeS5jb250YWlucyggdGhpcywgdGFyZ2V0c1tpXSApICkgew0KCQkJCQlyZXR1cm4gdHJ1ZTsNCgkJCQl9DQoJCQl9DQoJCX0pOw0KCX0sDQoNCglub3Q6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsNCgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCB3aW5ub3codGhpcywgc2VsZWN0b3IgfHwgW10sIHRydWUpICk7DQoJfSwNCg0KCWZpbHRlcjogZnVuY3Rpb24oIHNlbGVjdG9yICkgew0KCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIHdpbm5vdyh0aGlzLCBzZWxlY3RvciB8fCBbXSwgZmFsc2UpICk7DQoJfSwNCg0KCWlzOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7DQoJCXJldHVybiAhIXdpbm5vdygNCgkJCXRoaXMsDQoNCgkJCS8vIElmIHRoaXMgaXMgYSBwb3NpdGlvbmFsL3JlbGF0aXZlIHNlbGVjdG9yLCBjaGVjayBtZW1iZXJzaGlwIGluIHRoZSByZXR1cm5lZCBzZXQNCgkJCS8vIHNvICQoInA6Zmlyc3QiKS5pcygicDpsYXN0Iikgd29uJ3QgcmV0dXJuIHRydWUgZm9yIGEgZG9jIHdpdGggdHdvICJwIi4NCgkJCXR5cGVvZiBzZWxlY3RvciA9PT0gInN0cmluZyIgJiYgcm5lZWRzQ29udGV4dC50ZXN0KCBzZWxlY3RvciApID8NCgkJCQlqUXVlcnkoIHNlbGVjdG9yICkgOg0KCQkJCXNlbGVjdG9yIHx8IFtdLA0KCQkJZmFsc2UNCgkJKS5sZW5ndGg7DQoJfSwNCg0KCWNsb3Nlc3Q6IGZ1bmN0aW9uKCBzZWxlY3RvcnMsIGNvbnRleHQgKSB7DQoJCXZhciBjdXIsDQoJCQlpID0gMCwNCgkJCWwgPSB0aGlzLmxlbmd0aCwNCgkJCXJldCA9IFtdLA0KCQkJcG9zID0gcm5lZWRzQ29udGV4dC50ZXN0KCBzZWxlY3RvcnMgKSB8fCB0eXBlb2Ygc2VsZWN0b3JzICE9PSAic3RyaW5nIiA/DQoJCQkJalF1ZXJ5KCBzZWxlY3RvcnMsIGNvbnRleHQgfHwgdGhpcy5jb250ZXh0ICkgOg0KCQkJCTA7DQoNCgkJZm9yICggOyBpIDwgbDsgaSsrICkgew0KCQkJZm9yICggY3VyID0gdGhpc1tpXTsgY3VyICYmIGN1ciAhPT0gY29udGV4dDsgY3VyID0gY3VyLnBhcmVudE5vZGUgKSB7DQoJCQkJLy8gQWx3YXlzIHNraXAgZG9jdW1lbnQgZnJhZ21lbnRzDQoJCQkJaWYgKCBjdXIubm9kZVR5cGUgPCAxMSAmJiAocG9zID8NCgkJCQkJcG9zLmluZGV4KGN1cikgPiAtMSA6DQoNCgkJCQkJLy8gRG9uJ3QgcGFzcyBub24tZWxlbWVudHMgdG8gU2l6emxlDQoJCQkJCWN1ci5ub2RlVHlwZSA9PT0gMSAmJg0KCQkJCQkJalF1ZXJ5LmZpbmQubWF0Y2hlc1NlbGVjdG9yKGN1ciwgc2VsZWN0b3JzKSkgKSB7DQoNCgkJCQkJY3VyID0gcmV0LnB1c2goIGN1ciApOw0KCQkJCQlicmVhazsNCgkJCQl9DQoJCQl9DQoJCX0NCg0KCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIHJldC5sZW5ndGggPiAxID8galF1ZXJ5LnVuaXF1ZSggcmV0ICkgOiByZXQgKTsNCgl9LA0KDQoJLy8gRGV0ZXJtaW5lIHRoZSBwb3NpdGlvbiBvZiBhbiBlbGVtZW50IHdpdGhpbg0KCS8vIHRoZSBtYXRjaGVkIHNldCBvZiBlbGVtZW50cw0KCWluZGV4OiBmdW5jdGlvbiggZWxlbSApIHsNCg0KCQkvLyBObyBhcmd1bWVudCwgcmV0dXJuIGluZGV4IGluIHBhcmVudA0KCQlpZiAoICFlbGVtICkgew0KCQkJcmV0dXJuICggdGhpc1swXSAmJiB0aGlzWzBdLnBhcmVudE5vZGUgKSA/IHRoaXMuZmlyc3QoKS5wcmV2QWxsKCkubGVuZ3RoIDogLTE7DQoJCX0NCg0KCQkvLyBpbmRleCBpbiBzZWxlY3Rvcg0KCQlpZiAoIHR5cGVvZiBlbGVtID09PSAic3RyaW5nIiApIHsNCgkJCXJldHVybiBqUXVlcnkuaW5BcnJheSggdGhpc1swXSwgalF1ZXJ5KCBlbGVtICkgKTsNCgkJfQ0KDQoJCS8vIExvY2F0ZSB0aGUgcG9zaXRpb24gb2YgdGhlIGRlc2lyZWQgZWxlbWVudA0KCQlyZXR1cm4galF1ZXJ5LmluQXJyYXkoDQoJCQkvLyBJZiBpdCByZWNlaXZlcyBhIGpRdWVyeSBvYmplY3QsIHRoZSBmaXJzdCBlbGVtZW50IGlzIHVzZWQNCgkJCWVsZW0uanF1ZXJ5ID8gZWxlbVswXSA6IGVsZW0sIHRoaXMgKTsNCgl9LA0KDQoJYWRkOiBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQgKSB7DQoJCXZhciBzZXQgPSB0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciID8NCgkJCQlqUXVlcnkoIHNlbGVjdG9yLCBjb250ZXh0ICkgOg0KCQkJCWpRdWVyeS5tYWtlQXJyYXkoIHNlbGVjdG9yICYmIHNlbGVjdG9yLm5vZGVUeXBlID8gWyBzZWxlY3RvciBdIDogc2VsZWN0b3IgKSwNCgkJCWFsbCA9IGpRdWVyeS5tZXJnZSggdGhpcy5nZXQoKSwgc2V0ICk7DQoNCgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBqUXVlcnkudW5pcXVlKGFsbCkgKTsNCgl9LA0KDQoJYWRkQmFjazogZnVuY3Rpb24oIHNlbGVjdG9yICkgew0KCQlyZXR1cm4gdGhpcy5hZGQoIHNlbGVjdG9yID09IG51bGwgPw0KCQkJdGhpcy5wcmV2T2JqZWN0IDogdGhpcy5wcmV2T2JqZWN0LmZpbHRlcihzZWxlY3RvcikNCgkJKTsNCgl9DQp9KTsNCg0KZnVuY3Rpb24gc2libGluZyggY3VyLCBkaXIgKSB7DQoJZG8gew0KCQljdXIgPSBjdXJbIGRpciBdOw0KCX0gd2hpbGUgKCBjdXIgJiYgY3VyLm5vZGVUeXBlICE9PSAxICk7DQoNCglyZXR1cm4gY3VyOw0KfQ0KDQpqUXVlcnkuZWFjaCh7DQoJcGFyZW50OiBmdW5jdGlvbiggZWxlbSApIHsNCgkJdmFyIHBhcmVudCA9IGVsZW0ucGFyZW50Tm9kZTsNCgkJcmV0dXJuIHBhcmVudCAmJiBwYXJlbnQubm9kZVR5cGUgIT09IDExID8gcGFyZW50IDogbnVsbDsNCgl9LA0KCXBhcmVudHM6IGZ1bmN0aW9uKCBlbGVtICkgew0KCQlyZXR1cm4galF1ZXJ5LmRpciggZWxlbSwgInBhcmVudE5vZGUiICk7DQoJfSwNCglwYXJlbnRzVW50aWw6IGZ1bmN0aW9uKCBlbGVtLCBpLCB1bnRpbCApIHsNCgkJcmV0dXJuIGpRdWVyeS5kaXIoIGVsZW0sICJwYXJlbnROb2RlIiwgdW50aWwgKTsNCgl9LA0KCW5leHQ6IGZ1bmN0aW9uKCBlbGVtICkgew0KCQlyZXR1cm4gc2libGluZyggZWxlbSwgIm5leHRTaWJsaW5nIiApOw0KCX0sDQoJcHJldjogZnVuY3Rpb24oIGVsZW0gKSB7DQoJCXJldHVybiBzaWJsaW5nKCBlbGVtLCAicHJldmlvdXNTaWJsaW5nIiApOw0KCX0sDQoJbmV4dEFsbDogZnVuY3Rpb24oIGVsZW0gKSB7DQoJCXJldHVybiBqUXVlcnkuZGlyKCBlbGVtLCAibmV4dFNpYmxpbmciICk7DQoJfSwNCglwcmV2QWxsOiBmdW5jdGlvbiggZWxlbSApIHsNCgkJcmV0dXJuIGpRdWVyeS5kaXIoIGVsZW0sICJwcmV2aW91c1NpYmxpbmciICk7DQoJfSwNCgluZXh0VW50aWw6IGZ1bmN0aW9uKCBlbGVtLCBpLCB1bnRpbCApIHsNCgkJcmV0dXJuIGpRdWVyeS5kaXIoIGVsZW0sICJuZXh0U2libGluZyIsIHVudGlsICk7DQoJfSwNCglwcmV2VW50aWw6IGZ1bmN0aW9uKCBlbGVtLCBpLCB1bnRpbCApIHsNCgkJcmV0dXJuIGpRdWVyeS5kaXIoIGVsZW0sICJwcmV2aW91c1NpYmxpbmciLCB1bnRpbCApOw0KCX0sDQoJc2libGluZ3M6IGZ1bmN0aW9uKCBlbGVtICkgew0KCQlyZXR1cm4galF1ZXJ5LnNpYmxpbmcoICggZWxlbS5wYXJlbnROb2RlIHx8IHt9ICkuZmlyc3RDaGlsZCwgZWxlbSApOw0KCX0sDQoJY2hpbGRyZW46IGZ1bmN0aW9uKCBlbGVtICkgew0KCQlyZXR1cm4galF1ZXJ5LnNpYmxpbmcoIGVsZW0uZmlyc3RDaGlsZCApOw0KCX0sDQoJY29udGVudHM6IGZ1bmN0aW9uKCBlbGVtICkgew0KCQlyZXR1cm4galF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAiaWZyYW1lIiApID8NCgkJCWVsZW0uY29udGVudERvY3VtZW50IHx8IGVsZW0uY29udGVudFdpbmRvdy5kb2N1bWVudCA6DQoJCQlqUXVlcnkubWVyZ2UoIFtdLCBlbGVtLmNoaWxkTm9kZXMgKTsNCgl9DQp9LCBmdW5jdGlvbiggbmFtZSwgZm4gKSB7DQoJalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggdW50aWwsIHNlbGVjdG9yICkgew0KCQl2YXIgcmV0ID0galF1ZXJ5Lm1hcCggdGhpcywgZm4sIHVudGlsICk7DQoNCgkJaWYgKCBuYW1lLnNsaWNlKCAtNSApICE9PSAiVW50aWwiICkgew0KCQkJc2VsZWN0b3IgPSB1bnRpbDsNCgkJfQ0KDQoJCWlmICggc2VsZWN0b3IgJiYgdHlwZW9mIHNlbGVjdG9yID09PSAic3RyaW5nIiApIHsNCgkJCXJldCA9IGpRdWVyeS5maWx0ZXIoIHNlbGVjdG9yLCByZXQgKTsNCgkJfQ0KDQoJCWlmICggdGhpcy5sZW5ndGggPiAxICkgew0KCQkJLy8gUmVtb3ZlIGR1cGxpY2F0ZXMNCgkJCWlmICggIWd1YXJhbnRlZWRVbmlxdWVbIG5hbWUgXSApIHsNCgkJCQlyZXQgPSBqUXVlcnkudW5pcXVlKCByZXQgKTsNCgkJCX0NCg0KCQkJLy8gUmV2ZXJzZSBvcmRlciBmb3IgcGFyZW50cyogYW5kIHByZXYtZGVyaXZhdGl2ZXMNCgkJCWlmICggcnBhcmVudHNwcmV2LnRlc3QoIG5hbWUgKSApIHsNCgkJCQlyZXQgPSByZXQucmV2ZXJzZSgpOw0KCQkJfQ0KCQl9DQoNCgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCByZXQgKTsNCgl9Ow0KfSk7DQoNCmpRdWVyeS5leHRlbmQoew0KCWZpbHRlcjogZnVuY3Rpb24oIGV4cHIsIGVsZW1zLCBub3QgKSB7DQoJCXZhciBlbGVtID0gZWxlbXNbIDAgXTsNCg0KCQlpZiAoIG5vdCApIHsNCgkJCWV4cHIgPSAiOm5vdCgiICsgZXhwciArICIpIjsNCgkJfQ0KDQoJCXJldHVybiBlbGVtcy5sZW5ndGggPT09IDEgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSA/DQoJCQlqUXVlcnkuZmluZC5tYXRjaGVzU2VsZWN0b3IoIGVsZW0sIGV4cHIgKSA/IFsgZWxlbSBdIDogW10gOg0KCQkJalF1ZXJ5LmZpbmQubWF0Y2hlcyggZXhwciwgalF1ZXJ5LmdyZXAoIGVsZW1zLCBmdW5jdGlvbiggZWxlbSApIHsNCgkJCQlyZXR1cm4gZWxlbS5ub2RlVHlwZSA9PT0gMTsNCgkJCX0pKTsNCgl9LA0KDQoJZGlyOiBmdW5jdGlvbiggZWxlbSwgZGlyLCB1bnRpbCApIHsNCgkJdmFyIG1hdGNoZWQgPSBbXSwNCgkJCWN1ciA9IGVsZW1bIGRpciBdOw0KDQoJCXdoaWxlICggY3VyICYmIGN1ci5ub2RlVHlwZSAhPT0gOSAmJiAodW50aWwgPT09IHVuZGVmaW5lZCB8fCBjdXIubm9kZVR5cGUgIT09IDEgfHwgIWpRdWVyeSggY3VyICkuaXMoIHVudGlsICkpICkgew0KCQkJaWYgKCBjdXIubm9kZVR5cGUgPT09IDEgKSB7DQoJCQkJbWF0Y2hlZC5wdXNoKCBjdXIgKTsNCgkJCX0NCgkJCWN1ciA9IGN1cltkaXJdOw0KCQl9DQoJCXJldHVybiBtYXRjaGVkOw0KCX0sDQoNCglzaWJsaW5nOiBmdW5jdGlvbiggbiwgZWxlbSApIHsNCgkJdmFyIHIgPSBbXTsNCg0KCQlmb3IgKCA7IG47IG4gPSBuLm5leHRTaWJsaW5nICkgew0KCQkJaWYgKCBuLm5vZGVUeXBlID09PSAxICYmIG4gIT09IGVsZW0gKSB7DQoJCQkJci5wdXNoKCBuICk7DQoJCQl9DQoJCX0NCg0KCQlyZXR1cm4gcjsNCgl9DQp9KTsNCg0KLy8gSW1wbGVtZW50IHRoZSBpZGVudGljYWwgZnVuY3Rpb25hbGl0eSBmb3IgZmlsdGVyIGFuZCBub3QNCmZ1bmN0aW9uIHdpbm5vdyggZWxlbWVudHMsIHF1YWxpZmllciwgbm90ICkgew0KCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHF1YWxpZmllciApICkgew0KCQlyZXR1cm4galF1ZXJ5LmdyZXAoIGVsZW1lbnRzLCBmdW5jdGlvbiggZWxlbSwgaSApIHsNCgkJCS8qIGpzaGludCAtVzAxOCAqLw0KCQkJcmV0dXJuICEhcXVhbGlmaWVyLmNhbGwoIGVsZW0sIGksIGVsZW0gKSAhPT0gbm90Ow0KCQl9KTsNCg0KCX0NCg0KCWlmICggcXVhbGlmaWVyLm5vZGVUeXBlICkgew0KCQlyZXR1cm4galF1ZXJ5LmdyZXAoIGVsZW1lbnRzLCBmdW5jdGlvbiggZWxlbSApIHsNCgkJCXJldHVybiAoIGVsZW0gPT09IHF1YWxpZmllciApICE9PSBub3Q7DQoJCX0pOw0KDQoJfQ0KDQoJaWYgKCB0eXBlb2YgcXVhbGlmaWVyID09PSAic3RyaW5nIiApIHsNCgkJaWYgKCBpc1NpbXBsZS50ZXN0KCBxdWFsaWZpZXIgKSApIHsNCgkJCXJldHVybiBqUXVlcnkuZmlsdGVyKCBxdWFsaWZpZXIsIGVsZW1lbnRzLCBub3QgKTsNCgkJfQ0KDQoJCXF1YWxpZmllciA9IGpRdWVyeS5maWx0ZXIoIHF1YWxpZmllciwgZWxlbWVudHMgKTsNCgl9DQoNCglyZXR1cm4galF1ZXJ5LmdyZXAoIGVsZW1lbnRzLCBmdW5jdGlvbiggZWxlbSApIHsNCgkJcmV0dXJuICggalF1ZXJ5LmluQXJyYXkoIGVsZW0sIHF1YWxpZmllciApID49IDAgKSAhPT0gbm90Ow0KCX0pOw0KfQ0KZnVuY3Rpb24gY3JlYXRlU2FmZUZyYWdtZW50KCBkb2N1bWVudCApIHsNCgl2YXIgbGlzdCA9IG5vZGVOYW1lcy5zcGxpdCggInwiICksDQoJCXNhZmVGcmFnID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOw0KDQoJaWYgKCBzYWZlRnJhZy5jcmVhdGVFbGVtZW50ICkgew0KCQl3aGlsZSAoIGxpc3QubGVuZ3RoICkgew0KCQkJc2FmZUZyYWcuY3JlYXRlRWxlbWVudCgNCgkJCQlsaXN0LnBvcCgpDQoJCQkpOw0KCQl9DQoJfQ0KCXJldHVybiBzYWZlRnJhZzsNCn0NCg0KdmFyIG5vZGVOYW1lcyA9ICJhYmJyfGFydGljbGV8YXNpZGV8YXVkaW98YmRpfGNhbnZhc3xkYXRhfGRhdGFsaXN0fGRldGFpbHN8ZmlnY2FwdGlvbnxmaWd1cmV8Zm9vdGVyfCIgKw0KCQkiaGVhZGVyfGhncm91cHxtYXJrfG1ldGVyfG5hdnxvdXRwdXR8cHJvZ3Jlc3N8c2VjdGlvbnxzdW1tYXJ5fHRpbWV8dmlkZW8iLA0KCXJpbmxpbmVqUXVlcnkgPSAvIGpRdWVyeVxkKz0iKD86bnVsbHxcZCspIi9nLA0KCXJub3NoaW1jYWNoZSA9IG5ldyBSZWdFeHAoIjwoPzoiICsgbm9kZU5hbWVzICsgIilbXFxzLz5dIiwgImkiKSwNCglybGVhZGluZ1doaXRlc3BhY2UgPSAvXlxzKy8sDQoJcnhodG1sVGFnID0gLzwoPyFhcmVhfGJyfGNvbHxlbWJlZHxocnxpbWd8aW5wdXR8bGlua3xtZXRhfHBhcmFtKSgoW1x3Ol0rKVtePl0qKVwvPi9naSwNCglydGFnTmFtZSA9IC88KFtcdzpdKykvLA0KCXJ0Ym9keSA9IC88dGJvZHkvaSwNCglyaHRtbCA9IC88fCYjP1x3KzsvLA0KCXJub0lubmVyaHRtbCA9IC88KD86c2NyaXB0fHN0eWxlfGxpbmspL2ksDQoJbWFuaXB1bGF0aW9uX3JjaGVja2FibGVUeXBlID0gL14oPzpjaGVja2JveHxyYWRpbykkL2ksDQoJLy8gY2hlY2tlZD0iY2hlY2tlZCIgb3IgY2hlY2tlZA0KCXJjaGVja2VkID0gL2NoZWNrZWRccyooPzpbXj1dfD1ccyouY2hlY2tlZC4pL2ksDQoJcnNjcmlwdFR5cGUgPSAvXiR8XC8oPzpqYXZhfGVjbWEpc2NyaXB0L2ksDQoJcnNjcmlwdFR5cGVNYXNrZWQgPSAvXnRydWVcLyguKikvLA0KCXJjbGVhblNjcmlwdCA9IC9eXHMqPCEoPzpcW0NEQVRBXFt8LS0pfCg/OlxdXF18LS0pPlxzKiQvZywNCg0KCS8vIFdlIGhhdmUgdG8gY2xvc2UgdGhlc2UgdGFncyB0byBzdXBwb3J0IFhIVE1MICgjMTMyMDApDQoJd3JhcE1hcCA9IHsNCgkJb3B0aW9uOiBbIDEsICI8c2VsZWN0IG11bHRpcGxlPSdtdWx0aXBsZSc+IiwgIjwvc2VsZWN0PiIgXSwNCgkJbGVnZW5kOiBbIDEsICI8ZmllbGRzZXQ+IiwgIjwvZmllbGRzZXQ+IiBdLA0KCQlhcmVhOiBbIDEsICI8bWFwPiIsICI8L21hcD4iIF0sDQoJCXBhcmFtOiBbIDEsICI8b2JqZWN0PiIsICI8L29iamVjdD4iIF0sDQoJCXRoZWFkOiBbIDEsICI8dGFibGU+IiwgIjwvdGFibGU+IiBdLA0KCQl0cjogWyAyLCAiPHRhYmxlPjx0Ym9keT4iLCAiPC90Ym9keT48L3RhYmxlPiIgXSwNCgkJY29sOiBbIDIsICI8dGFibGU+PHRib2R5PjwvdGJvZHk+PGNvbGdyb3VwPiIsICI8L2NvbGdyb3VwPjwvdGFibGU+IiBdLA0KCQl0ZDogWyAzLCAiPHRhYmxlPjx0Ym9keT48dHI+IiwgIjwvdHI+PC90Ym9keT48L3RhYmxlPiIgXSwNCg0KCQkvLyBJRTYtOCBjYW4ndCBzZXJpYWxpemUgbGluaywgc2NyaXB0LCBzdHlsZSwgb3IgYW55IGh0bWw1IChOb1Njb3BlKSB0YWdzLA0KCQkvLyB1bmxlc3Mgd3JhcHBlZCBpbiBhIGRpdiB3aXRoIG5vbi1icmVha2luZyBjaGFyYWN0ZXJzIGluIGZyb250IG9mIGl0Lg0KCQlfZGVmYXVsdDogalF1ZXJ5LnN1cHBvcnQuaHRtbFNlcmlhbGl6ZSA/IFsgMCwgIiIsICIiIF0gOiBbIDEsICJYPGRpdj4iLCAiPC9kaXY+IiAgXQ0KCX0sDQoJc2FmZUZyYWdtZW50ID0gY3JlYXRlU2FmZUZyYWdtZW50KCBkb2N1bWVudCApLA0KCWZyYWdtZW50RGl2ID0gc2FmZUZyYWdtZW50LmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKSApOw0KDQp3cmFwTWFwLm9wdGdyb3VwID0gd3JhcE1hcC5vcHRpb247DQp3cmFwTWFwLnRib2R5ID0gd3JhcE1hcC50Zm9vdCA9IHdyYXBNYXAuY29sZ3JvdXAgPSB3cmFwTWFwLmNhcHRpb24gPSB3cmFwTWFwLnRoZWFkOw0Kd3JhcE1hcC50aCA9IHdyYXBNYXAudGQ7DQoNCmpRdWVyeS5mbi5leHRlbmQoew0KCXRleHQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsNCgkJcmV0dXJuIGpRdWVyeS5hY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCB2YWx1ZSApIHsNCgkJCXJldHVybiB2YWx1ZSA9PT0gdW5kZWZpbmVkID8NCgkJCQlqUXVlcnkudGV4dCggdGhpcyApIDoNCgkJCQl0aGlzLmVtcHR5KCkuYXBwZW5kKCAoIHRoaXNbMF0gJiYgdGhpc1swXS5vd25lckRvY3VtZW50IHx8IGRvY3VtZW50ICkuY3JlYXRlVGV4dE5vZGUoIHZhbHVlICkgKTsNCgkJfSwgbnVsbCwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggKTsNCgl9LA0KDQoJYXBwZW5kOiBmdW5jdGlvbigpIHsNCgkJcmV0dXJuIHRoaXMuZG9tTWFuaXAoIGFyZ3VtZW50cywgZnVuY3Rpb24oIGVsZW0gKSB7DQoJCQlpZiAoIHRoaXMubm9kZVR5cGUgPT09IDEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gMTEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gOSApIHsNCgkJCQl2YXIgdGFyZ2V0ID0gbWFuaXB1bGF0aW9uVGFyZ2V0KCB0aGlzLCBlbGVtICk7DQoJCQkJdGFyZ2V0LmFwcGVuZENoaWxkKCBlbGVtICk7DQoJCQl9DQoJCX0pOw0KCX0sDQoNCglwcmVwZW5kOiBmdW5jdGlvbigpIHsNCgkJcmV0dXJuIHRoaXMuZG9tTWFuaXAoIGFyZ3VtZW50cywgZnVuY3Rpb24oIGVsZW0gKSB7DQoJCQlpZiAoIHRoaXMubm9kZVR5cGUgPT09IDEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gMTEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gOSApIHsNCgkJCQl2YXIgdGFyZ2V0ID0gbWFuaXB1bGF0aW9uVGFyZ2V0KCB0aGlzLCBlbGVtICk7DQoJCQkJdGFyZ2V0Lmluc2VydEJlZm9yZSggZWxlbSwgdGFyZ2V0LmZpcnN0Q2hpbGQgKTsNCgkJCX0NCgkJfSk7DQoJfSwNCg0KCWJlZm9yZTogZnVuY3Rpb24oKSB7DQoJCXJldHVybiB0aGlzLmRvbU1hbmlwKCBhcmd1bWVudHMsIGZ1bmN0aW9uKCBlbGVtICkgew0KCQkJaWYgKCB0aGlzLnBhcmVudE5vZGUgKSB7DQoJCQkJdGhpcy5wYXJlbnROb2RlLmluc2VydEJlZm9yZSggZWxlbSwgdGhpcyApOw0KCQkJfQ0KCQl9KTsNCgl9LA0KDQoJYWZ0ZXI6IGZ1bmN0aW9uKCkgew0KCQlyZXR1cm4gdGhpcy5kb21NYW5pcCggYXJndW1lbnRzLCBmdW5jdGlvbiggZWxlbSApIHsNCgkJCWlmICggdGhpcy5wYXJlbnROb2RlICkgew0KCQkJCXRoaXMucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoIGVsZW0sIHRoaXMubmV4dFNpYmxpbmcgKTsNCgkJCX0NCgkJfSk7DQoJfSwNCg0KCS8vIGtlZXBEYXRhIGlzIGZvciBpbnRlcm5hbCB1c2Ugb25seS0tZG8gbm90IGRvY3VtZW50DQoJcmVtb3ZlOiBmdW5jdGlvbiggc2VsZWN0b3IsIGtlZXBEYXRhICkgew0KCQl2YXIgZWxlbSwNCgkJCWVsZW1zID0gc2VsZWN0b3IgPyBqUXVlcnkuZmlsdGVyKCBzZWxlY3RvciwgdGhpcyApIDogdGhpcywNCgkJCWkgPSAwOw0KDQoJCWZvciAoIDsgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrICkgew0KDQoJCQlpZiAoICFrZWVwRGF0YSAmJiBlbGVtLm5vZGVUeXBlID09PSAxICkgew0KCQkJCWpRdWVyeS5jbGVhbkRhdGEoIGdldEFsbCggZWxlbSApICk7DQoJCQl9DQoNCgkJCWlmICggZWxlbS5wYXJlbnROb2RlICkgew0KCQkJCWlmICgga2VlcERhdGEgJiYgalF1ZXJ5LmNvbnRhaW5zKCBlbGVtLm93bmVyRG9jdW1lbnQsIGVsZW0gKSApIHsNCgkJCQkJc2V0R2xvYmFsRXZhbCggZ2V0QWxsKCBlbGVtLCAic2NyaXB0IiApICk7DQoJCQkJfQ0KCQkJCWVsZW0ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCggZWxlbSApOw0KCQkJfQ0KCQl9DQoNCgkJcmV0dXJuIHRoaXM7DQoJfSwNCg0KCWVtcHR5OiBmdW5jdGlvbigpIHsNCgkJdmFyIGVsZW0sDQoJCQlpID0gMDsNCg0KCQlmb3IgKCA7IChlbGVtID0gdGhpc1tpXSkgIT0gbnVsbDsgaSsrICkgew0KCQkJLy8gUmVtb3ZlIGVsZW1lbnQgbm9kZXMgYW5kIHByZXZlbnQgbWVtb3J5IGxlYWtzDQoJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7DQoJCQkJalF1ZXJ5LmNsZWFuRGF0YSggZ2V0QWxsKCBlbGVtLCBmYWxzZSApICk7DQoJCQl9DQoNCgkJCS8vIFJlbW92ZSBhbnkgcmVtYWluaW5nIG5vZGVzDQoJCQl3aGlsZSAoIGVsZW0uZmlyc3RDaGlsZCApIHsNCgkJCQllbGVtLnJlbW92ZUNoaWxkKCBlbGVtLmZpcnN0Q2hpbGQgKTsNCgkJCX0NCg0KCQkJLy8gSWYgdGhpcyBpcyBhIHNlbGVjdCwgZW5zdXJlIHRoYXQgaXQgZGlzcGxheXMgZW1wdHkgKCMxMjMzNikNCgkJCS8vIFN1cHBvcnQ6IElFPDkNCgkJCWlmICggZWxlbS5vcHRpb25zICYmIGpRdWVyeS5ub2RlTmFtZSggZWxlbSwgInNlbGVjdCIgKSApIHsNCgkJCQllbGVtLm9wdGlvbnMubGVuZ3RoID0gMDsNCgkJCX0NCgkJfQ0KDQoJCXJldHVybiB0aGlzOw0KCX0sDQoNCgljbG9uZTogZnVuY3Rpb24oIGRhdGFBbmRFdmVudHMsIGRlZXBEYXRhQW5kRXZlbnRzICkgew0KCQlkYXRhQW5kRXZlbnRzID0gZGF0YUFuZEV2ZW50cyA9PSBudWxsID8gZmFsc2UgOiBkYXRhQW5kRXZlbnRzOw0KCQlkZWVwRGF0YUFuZEV2ZW50cyA9IGRlZXBEYXRhQW5kRXZlbnRzID09IG51bGwgPyBkYXRhQW5kRXZlbnRzIDogZGVlcERhdGFBbmRFdmVudHM7DQoNCgkJcmV0dXJuIHRoaXMubWFwKCBmdW5jdGlvbiAoKSB7DQoJCQlyZXR1cm4galF1ZXJ5LmNsb25lKCB0aGlzLCBkYXRhQW5kRXZlbnRzLCBkZWVwRGF0YUFuZEV2ZW50cyApOw0KCQl9KTsNCgl9LA0KDQoJaHRtbDogZnVuY3Rpb24oIHZhbHVlICkgew0KCQlyZXR1cm4galF1ZXJ5LmFjY2VzcyggdGhpcywgZnVuY3Rpb24oIHZhbHVlICkgew0KCQkJdmFyIGVsZW0gPSB0aGlzWzBdIHx8IHt9LA0KCQkJCWkgPSAwLA0KCQkJCWwgPSB0aGlzLmxlbmd0aDsNCg0KCQkJaWYgKCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgew0KCQkJCXJldHVybiBlbGVtLm5vZGVUeXBlID09PSAxID8NCgkJCQkJZWxlbS5pbm5lckhUTUwucmVwbGFjZSggcmlubGluZWpRdWVyeSwgIiIgKSA6DQoJCQkJCXVuZGVmaW5lZDsNCgkJCX0NCg0KCQkJLy8gU2VlIGlmIHdlIGNhbiB0YWtlIGEgc2hvcnRjdXQgYW5kIGp1c3QgdXNlIGlubmVySFRNTA0KCQkJaWYgKCB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciICYmICFybm9Jbm5lcmh0bWwudGVzdCggdmFsdWUgKSAmJg0KCQkJCSggalF1ZXJ5LnN1cHBvcnQuaHRtbFNlcmlhbGl6ZSB8fCAhcm5vc2hpbWNhY2hlLnRlc3QoIHZhbHVlICkgICkgJiYNCgkJCQkoIGpRdWVyeS5zdXBwb3J0LmxlYWRpbmdXaGl0ZXNwYWNlIHx8ICFybGVhZGluZ1doaXRlc3BhY2UudGVzdCggdmFsdWUgKSApICYmDQoJCQkJIXdyYXBNYXBbICggcnRhZ05hbWUuZXhlYyggdmFsdWUgKSB8fCBbIiIsICIiXSApWzFdLnRvTG93ZXJDYXNlKCkgXSApIHsNCg0KCQkJCXZhbHVlID0gdmFsdWUucmVwbGFjZSggcnhodG1sVGFnLCAiPCQxPjwvJDI+IiApOw0KDQoJCQkJdHJ5IHsNCgkJCQkJZm9yICg7IGkgPCBsOyBpKysgKSB7DQoJCQkJCQkvLyBSZW1vdmUgZWxlbWVudCBub2RlcyBhbmQgcHJldmVudCBtZW1vcnkgbGVha3MNCgkJCQkJCWVsZW0gPSB0aGlzW2ldIHx8IHt9Ow0KCQkJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICkgew0KCQkJCQkJCWpRdWVyeS5jbGVhbkRhdGEoIGdldEFsbCggZWxlbSwgZmFsc2UgKSApOw0KCQkJCQkJCWVsZW0uaW5uZXJIVE1MID0gdmFsdWU7DQoJCQkJCQl9DQoJCQkJCX0NCg0KCQkJCQllbGVtID0gMDsNCg0KCQkJCS8vIElmIHVzaW5nIGlubmVySFRNTCB0aHJvd3MgYW4gZXhjZXB0aW9uLCB1c2UgdGhlIGZhbGxiYWNrIG1ldGhvZA0KCQkJCX0gY2F0Y2goZSkge30NCgkJCX0NCg0KCQkJaWYgKCBlbGVtICkgew0KCQkJCXRoaXMuZW1wdHkoKS5hcHBlbmQoIHZhbHVlICk7DQoJCQl9DQoJCX0sIG51bGwsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoICk7DQoJfSwNCg0KCXJlcGxhY2VXaXRoOiBmdW5jdGlvbigpIHsNCgkJdmFyDQoJCQkvLyBTbmFwc2hvdCB0aGUgRE9NIGluIGNhc2UgLmRvbU1hbmlwIHN3ZWVwcyBzb21ldGhpbmcgcmVsZXZhbnQgaW50byBpdHMgZnJhZ21lbnQNCgkJCWFyZ3MgPSBqUXVlcnkubWFwKCB0aGlzLCBmdW5jdGlvbiggZWxlbSApIHsNCgkJCQlyZXR1cm4gWyBlbGVtLm5leHRTaWJsaW5nLCBlbGVtLnBhcmVudE5vZGUgXTsNCgkJCX0pLA0KCQkJaSA9IDA7DQoNCgkJLy8gTWFrZSB0aGUgY2hhbmdlcywgcmVwbGFjaW5nIGVhY2ggY29udGV4dCBlbGVtZW50IHdpdGggdGhlIG5ldyBjb250ZW50DQoJCXRoaXMuZG9tTWFuaXAoIGFyZ3VtZW50cywgZnVuY3Rpb24oIGVsZW0gKSB7DQoJCQl2YXIgbmV4dCA9IGFyZ3NbIGkrKyBdLA0KCQkJCXBhcmVudCA9IGFyZ3NbIGkrKyBdOw0KDQoJCQlpZiAoIHBhcmVudCApIHsNCgkJCQkvLyBEb24ndCB1c2UgdGhlIHNuYXBzaG90IG5leHQgaWYgaXQgaGFzIG1vdmVkICgjMTM4MTApDQoJCQkJaWYgKCBuZXh0ICYmIG5leHQucGFyZW50Tm9kZSAhPT0gcGFyZW50ICkgew0KCQkJCQluZXh0ID0gdGhpcy5uZXh0U2libGluZzsNCgkJCQl9DQoJCQkJalF1ZXJ5KCB0aGlzICkucmVtb3ZlKCk7DQoJCQkJcGFyZW50Lmluc2VydEJlZm9yZSggZWxlbSwgbmV4dCApOw0KCQkJfQ0KCQkvLyBBbGxvdyBuZXcgY29udGVudCB0byBpbmNsdWRlIGVsZW1lbnRzIGZyb20gdGhlIGNvbnRleHQgc2V0DQoJCX0sIHRydWUgKTsNCg0KCQkvLyBGb3JjZSByZW1vdmFsIGlmIHRoZXJlIHdhcyBubyBuZXcgY29udGVudCAoZS5nLiwgZnJvbSBlbXB0eSBhcmd1bWVudHMpDQoJCXJldHVybiBpID8gdGhpcyA6IHRoaXMucmVtb3ZlKCk7DQoJfSwNCg0KCWRldGFjaDogZnVuY3Rpb24oIHNlbGVjdG9yICkgew0KCQlyZXR1cm4gdGhpcy5yZW1vdmUoIHNlbGVjdG9yLCB0cnVlICk7DQoJfSwNCg0KCWRvbU1hbmlwOiBmdW5jdGlvbiggYXJncywgY2FsbGJhY2ssIGFsbG93SW50ZXJzZWN0aW9uICkgew0KDQoJCS8vIEZsYXR0ZW4gYW55IG5lc3RlZCBhcnJheXMNCgkJYXJncyA9IGNvcmVfY29uY2F0LmFwcGx5KCBbXSwgYXJncyApOw0KDQoJCXZhciBmaXJzdCwgbm9kZSwgaGFzU2NyaXB0cywNCgkJCXNjcmlwdHMsIGRvYywgZnJhZ21lbnQsDQoJCQlpID0gMCwNCgkJCWwgPSB0aGlzLmxlbmd0aCwNCgkJCXNldCA9IHRoaXMsDQoJCQlpTm9DbG9uZSA9IGwgLSAxLA0KCQkJdmFsdWUgPSBhcmdzWzBdLA0KCQkJaXNGdW5jdGlvbiA9IGpRdWVyeS5pc0Z1bmN0aW9uKCB2YWx1ZSApOw0KDQoJCS8vIFdlIGNhbid0IGNsb25lTm9kZSBmcmFnbWVudHMgdGhhdCBjb250YWluIGNoZWNrZWQsIGluIFdlYktpdA0KCQlpZiAoIGlzRnVuY3Rpb24gfHwgISggbCA8PSAxIHx8IHR5cGVvZiB2YWx1ZSAhPT0gInN0cmluZyIgfHwgalF1ZXJ5LnN1cHBvcnQuY2hlY2tDbG9uZSB8fCAhcmNoZWNrZWQudGVzdCggdmFsdWUgKSApICkgew0KCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiggaW5kZXggKSB7DQoJCQkJdmFyIHNlbGYgPSBzZXQuZXEoIGluZGV4ICk7DQoJCQkJaWYgKCBpc0Z1bmN0aW9uICkgew0KCQkJCQlhcmdzWzBdID0gdmFsdWUuY2FsbCggdGhpcywgaW5kZXgsIHNlbGYuaHRtbCgpICk7DQoJCQkJfQ0KCQkJCXNlbGYuZG9tTWFuaXAoIGFyZ3MsIGNhbGxiYWNrLCBhbGxvd0ludGVyc2VjdGlvbiApOw0KCQkJfSk7DQoJCX0NCg0KCQlpZiAoIGwgKSB7DQoJCQlmcmFnbWVudCA9IGpRdWVyeS5idWlsZEZyYWdtZW50KCBhcmdzLCB0aGlzWyAwIF0ub3duZXJEb2N1bWVudCwgZmFsc2UsICFhbGxvd0ludGVyc2VjdGlvbiAmJiB0aGlzICk7DQoJCQlmaXJzdCA9IGZyYWdtZW50LmZpcnN0Q2hpbGQ7DQoNCgkJCWlmICggZnJhZ21lbnQuY2hpbGROb2Rlcy5sZW5ndGggPT09IDEgKSB7DQoJCQkJZnJhZ21lbnQgPSBmaXJzdDsNCgkJCX0NCg0KCQkJaWYgKCBmaXJzdCApIHsNCgkJCQlzY3JpcHRzID0galF1ZXJ5Lm1hcCggZ2V0QWxsKCBmcmFnbWVudCwgInNjcmlwdCIgKSwgZGlzYWJsZVNjcmlwdCApOw0KCQkJCWhhc1NjcmlwdHMgPSBzY3JpcHRzLmxlbmd0aDsNCg0KCQkJCS8vIFVzZSB0aGUgb3JpZ2luYWwgZnJhZ21lbnQgZm9yIHRoZSBsYXN0IGl0ZW0gaW5zdGVhZCBvZiB0aGUgZmlyc3QgYmVjYXVzZSBpdCBjYW4gZW5kIHVwDQoJCQkJLy8gYmVpbmcgZW1wdGllZCBpbmNvcnJlY3RseSBpbiBjZXJ0YWluIHNpdHVhdGlvbnMgKCM4MDcwKS4NCgkJCQlmb3IgKCA7IGkgPCBsOyBpKysgKSB7DQoJCQkJCW5vZGUgPSBmcmFnbWVudDsNCg0KCQkJCQlpZiAoIGkgIT09IGlOb0Nsb25lICkgew0KCQkJCQkJbm9kZSA9IGpRdWVyeS5jbG9uZSggbm9kZSwgdHJ1ZSwgdHJ1ZSApOw0KDQoJCQkJCQkvLyBLZWVwIHJlZmVyZW5jZXMgdG8gY2xvbmVkIHNjcmlwdHMgZm9yIGxhdGVyIHJlc3RvcmF0aW9uDQoJCQkJCQlpZiAoIGhhc1NjcmlwdHMgKSB7DQoJCQkJCQkJalF1ZXJ5Lm1lcmdlKCBzY3JpcHRzLCBnZXRBbGwoIG5vZGUsICJzY3JpcHQiICkgKTsNCgkJCQkJCX0NCgkJCQkJfQ0KDQoJCQkJCWNhbGxiYWNrLmNhbGwoIHRoaXNbaV0sIG5vZGUsIGkgKTsNCgkJCQl9DQoNCgkJCQlpZiAoIGhhc1NjcmlwdHMgKSB7DQoJCQkJCWRvYyA9IHNjcmlwdHNbIHNjcmlwdHMubGVuZ3RoIC0gMSBdLm93bmVyRG9jdW1lbnQ7DQoNCgkJCQkJLy8gUmVlbmFibGUgc2NyaXB0cw0KCQkJCQlqUXVlcnkubWFwKCBzY3JpcHRzLCByZXN0b3JlU2NyaXB0ICk7DQoNCgkJCQkJLy8gRXZhbHVhdGUgZXhlY3V0YWJsZSBzY3JpcHRzIG9uIGZpcnN0IGRvY3VtZW50IGluc2VydGlvbg0KCQkJCQlmb3IgKCBpID0gMDsgaSA8IGhhc1NjcmlwdHM7IGkrKyApIHsNCgkJCQkJCW5vZGUgPSBzY3JpcHRzWyBpIF07DQoJCQkJCQlpZiAoIHJzY3JpcHRUeXBlLnRlc3QoIG5vZGUudHlwZSB8fCAiIiApICYmDQoJCQkJCQkJIWpRdWVyeS5fZGF0YSggbm9kZSwgImdsb2JhbEV2YWwiICkgJiYgalF1ZXJ5LmNvbnRhaW5zKCBkb2MsIG5vZGUgKSApIHsNCg0KCQkJCQkJCWlmICggbm9kZS5zcmMgKSB7DQoJCQkJCQkJCS8vIEhvcGUgYWpheCBpcyBhdmFpbGFibGUuLi4NCgkJCQkJCQkJalF1ZXJ5Ll9ldmFsVXJsKCBub2RlLnNyYyApOw0KCQkJCQkJCX0gZWxzZSB7DQoJCQkJCQkJCWpRdWVyeS5nbG9iYWxFdmFsKCAoIG5vZGUudGV4dCB8fCBub2RlLnRleHRDb250ZW50IHx8IG5vZGUuaW5uZXJIVE1MIHx8ICIiICkucmVwbGFjZSggcmNsZWFuU2NyaXB0LCAiIiApICk7DQoJCQkJCQkJfQ0KCQkJCQkJfQ0KCQkJCQl9DQoJCQkJfQ0KDQoJCQkJLy8gRml4ICMxMTgwOTogQXZvaWQgbGVha2luZyBtZW1vcnkNCgkJCQlmcmFnbWVudCA9IGZpcnN0ID0gbnVsbDsNCgkJCX0NCgkJfQ0KDQoJCXJldHVybiB0aGlzOw0KCX0NCn0pOw0KDQovLyBTdXBwb3J0OiBJRTw4DQovLyBNYW5pcHVsYXRpbmcgdGFibGVzIHJlcXVpcmVzIGEgdGJvZHkNCmZ1bmN0aW9uIG1hbmlwdWxhdGlvblRhcmdldCggZWxlbSwgY29udGVudCApIHsNCglyZXR1cm4galF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAidGFibGUiICkgJiYNCgkJalF1ZXJ5Lm5vZGVOYW1lKCBjb250ZW50Lm5vZGVUeXBlID09PSAxID8gY29udGVudCA6IGNvbnRlbnQuZmlyc3RDaGlsZCwgInRyIiApID8NCg0KCQllbGVtLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJ0Ym9keSIpWzBdIHx8DQoJCQllbGVtLmFwcGVuZENoaWxkKCBlbGVtLm93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGJvZHkiKSApIDoNCgkJZWxlbTsNCn0NCg0KLy8gUmVwbGFjZS9yZXN0b3JlIHRoZSB0eXBlIGF0dHJpYnV0ZSBvZiBzY3JpcHQgZWxlbWVudHMgZm9yIHNhZmUgRE9NIG1hbmlwdWxhdGlvbg0KZnVuY3Rpb24gZGlzYWJsZVNjcmlwdCggZWxlbSApIHsNCgllbGVtLnR5cGUgPSAoalF1ZXJ5LmZpbmQuYXR0ciggZWxlbSwgInR5cGUiICkgIT09IG51bGwpICsgIi8iICsgZWxlbS50eXBlOw0KCXJldHVybiBlbGVtOw0KfQ0KZnVuY3Rpb24gcmVzdG9yZVNjcmlwdCggZWxlbSApIHsNCgl2YXIgbWF0Y2ggPSByc2NyaXB0VHlwZU1hc2tlZC5leGVjKCBlbGVtLnR5cGUgKTsNCglpZiAoIG1hdGNoICkgew0KCQllbGVtLnR5cGUgPSBtYXRjaFsxXTsNCgl9IGVsc2Ugew0KCQllbGVtLnJlbW92ZUF0dHJpYnV0ZSgidHlwZSIpOw0KCX0NCglyZXR1cm4gZWxlbTsNCn0NCg0KLy8gTWFyayBzY3JpcHRzIGFzIGhhdmluZyBhbHJlYWR5IGJlZW4gZXZhbHVhdGVkDQpmdW5jdGlvbiBzZXRHbG9iYWxFdmFsKCBlbGVtcywgcmVmRWxlbWVudHMgKSB7DQoJdmFyIGVsZW0sDQoJCWkgPSAwOw0KCWZvciAoIDsgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrICkgew0KCQlqUXVlcnkuX2RhdGEoIGVsZW0sICJnbG9iYWxFdmFsIiwgIXJlZkVsZW1lbnRzIHx8IGpRdWVyeS5fZGF0YSggcmVmRWxlbWVudHNbaV0sICJnbG9iYWxFdmFsIiApICk7DQoJfQ0KfQ0KDQpmdW5jdGlvbiBjbG9uZUNvcHlFdmVudCggc3JjLCBkZXN0ICkgew0KDQoJaWYgKCBkZXN0Lm5vZGVUeXBlICE9PSAxIHx8ICFqUXVlcnkuaGFzRGF0YSggc3JjICkgKSB7DQoJCXJldHVybjsNCgl9DQoNCgl2YXIgdHlwZSwgaSwgbCwNCgkJb2xkRGF0YSA9IGpRdWVyeS5fZGF0YSggc3JjICksDQoJCWN1ckRhdGEgPSBqUXVlcnkuX2RhdGEoIGRlc3QsIG9sZERhdGEgKSwNCgkJZXZlbnRzID0gb2xkRGF0YS5ldmVudHM7DQoNCglpZiAoIGV2ZW50cyApIHsNCgkJZGVsZXRlIGN1ckRhdGEuaGFuZGxlOw0KCQljdXJEYXRhLmV2ZW50cyA9IHt9Ow0KDQoJCWZvciAoIHR5cGUgaW4gZXZlbnRzICkgew0KCQkJZm9yICggaSA9IDAsIGwgPSBldmVudHNbIHR5cGUgXS5sZW5ndGg7IGkgPCBsOyBpKysgKSB7DQoJCQkJalF1ZXJ5LmV2ZW50LmFkZCggZGVzdCwgdHlwZSwgZXZlbnRzWyB0eXBlIF1bIGkgXSApOw0KCQkJfQ0KCQl9DQoJfQ0KDQoJLy8gbWFrZSB0aGUgY2xvbmVkIHB1YmxpYyBkYXRhIG9iamVjdCBhIGNvcHkgZnJvbSB0aGUgb3JpZ2luYWwNCglpZiAoIGN1ckRhdGEuZGF0YSApIHsNCgkJY3VyRGF0YS5kYXRhID0galF1ZXJ5LmV4dGVuZCgge30sIGN1ckRhdGEuZGF0YSApOw0KCX0NCn0NCg0KZnVuY3Rpb24gZml4Q2xvbmVOb2RlSXNzdWVzKCBzcmMsIGRlc3QgKSB7DQoJdmFyIG5vZGVOYW1lLCBlLCBkYXRhOw0KDQoJLy8gV2UgZG8gbm90IG5lZWQgdG8gZG8gYW55dGhpbmcgZm9yIG5vbi1FbGVtZW50cw0KCWlmICggZGVzdC5ub2RlVHlwZSAhPT0gMSApIHsNCgkJcmV0dXJuOw0KCX0NCg0KCW5vZGVOYW1lID0gZGVzdC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOw0KDQoJLy8gSUU2LTggY29waWVzIGV2ZW50cyBib3VuZCB2aWEgYXR0YWNoRXZlbnQgd2hlbiB1c2luZyBjbG9uZU5vZGUuDQoJaWYgKCAhalF1ZXJ5LnN1cHBvcnQubm9DbG9uZUV2ZW50ICYmIGRlc3RbIGpRdWVyeS5leHBhbmRvIF0gKSB7DQoJCWRhdGEgPSBqUXVlcnkuX2RhdGEoIGRlc3QgKTsNCg0KCQlmb3IgKCBlIGluIGRhdGEuZXZlbnRzICkgew0KCQkJalF1ZXJ5LnJlbW92ZUV2ZW50KCBkZXN0LCBlLCBkYXRhLmhhbmRsZSApOw0KCQl9DQoNCgkJLy8gRXZlbnQgZGF0YSBnZXRzIHJlZmVyZW5jZWQgaW5zdGVhZCBvZiBjb3BpZWQgaWYgdGhlIGV4cGFuZG8gZ2V0cyBjb3BpZWQgdG9vDQoJCWRlc3QucmVtb3ZlQXR0cmlidXRlKCBqUXVlcnkuZXhwYW5kbyApOw0KCX0NCg0KCS8vIElFIGJsYW5rcyBjb250ZW50cyB3aGVuIGNsb25pbmcgc2NyaXB0cywgYW5kIHRyaWVzIHRvIGV2YWx1YXRlIG5ld2x5LXNldCB0ZXh0DQoJaWYgKCBub2RlTmFtZSA9PT0gInNjcmlwdCIgJiYgZGVzdC50ZXh0ICE9PSBzcmMudGV4dCApIHsNCgkJZGlzYWJsZVNjcmlwdCggZGVzdCApLnRleHQgPSBzcmMudGV4dDsNCgkJcmVzdG9yZVNjcmlwdCggZGVzdCApOw0KDQoJLy8gSUU2LTEwIGltcHJvcGVybHkgY2xvbmVzIGNoaWxkcmVuIG9mIG9iamVjdCBlbGVtZW50cyB1c2luZyBjbGFzc2lkLg0KCS8vIElFMTAgdGhyb3dzIE5vTW9kaWZpY2F0aW9uQWxsb3dlZEVycm9yIGlmIHBhcmVudCBpcyBudWxsLCAjMTIxMzIuDQoJfSBlbHNlIGlmICggbm9kZU5hbWUgPT09ICJvYmplY3QiICkgew0KCQlpZiAoIGRlc3QucGFyZW50Tm9kZSApIHsNCgkJCWRlc3Qub3V0ZXJIVE1MID0gc3JjLm91dGVySFRNTDsNCgkJfQ0KDQoJCS8vIFRoaXMgcGF0aCBhcHBlYXJzIHVuYXZvaWRhYmxlIGZvciBJRTkuIFdoZW4gY2xvbmluZyBhbiBvYmplY3QNCgkJLy8gZWxlbWVudCBpbiBJRTksIHRoZSBvdXRlckhUTUwgc3RyYXRlZ3kgYWJvdmUgaXMgbm90IHN1ZmZpY2llbnQuDQoJCS8vIElmIHRoZSBzcmMgaGFzIGlubmVySFRNTCBhbmQgdGhlIGRlc3RpbmF0aW9uIGRvZXMgbm90LA0KCQkvLyBjb3B5IHRoZSBzcmMuaW5uZXJIVE1MIGludG8gdGhlIGRlc3QuaW5uZXJIVE1MLiAjMTAzMjQNCgkJaWYgKCBqUXVlcnkuc3VwcG9ydC5odG1sNUNsb25lICYmICggc3JjLmlubmVySFRNTCAmJiAhalF1ZXJ5LnRyaW0oZGVzdC5pbm5lckhUTUwpICkgKSB7DQoJCQlkZXN0LmlubmVySFRNTCA9IHNyYy5pbm5lckhUTUw7DQoJCX0NCg0KCX0gZWxzZSBpZiAoIG5vZGVOYW1lID09PSAiaW5wdXQiICYmIG1hbmlwdWxhdGlvbl9yY2hlY2thYmxlVHlwZS50ZXN0KCBzcmMudHlwZSApICkgew0KCQkvLyBJRTYtOCBmYWlscyB0byBwZXJzaXN0IHRoZSBjaGVja2VkIHN0YXRlIG9mIGEgY2xvbmVkIGNoZWNrYm94DQoJCS8vIG9yIHJhZGlvIGJ1dHRvbi4gV29yc2UsIElFNi03IGZhaWwgdG8gZ2l2ZSB0aGUgY2xvbmVkIGVsZW1lbnQNCgkJLy8gYSBjaGVja2VkIGFwcGVhcmFuY2UgaWYgdGhlIGRlZmF1bHRDaGVja2VkIHZhbHVlIGlzbid0IGFsc28gc2V0DQoNCgkJZGVzdC5kZWZhdWx0Q2hlY2tlZCA9IGRlc3QuY2hlY2tlZCA9IHNyYy5jaGVja2VkOw0KDQoJCS8vIElFNi03IGdldCBjb25mdXNlZCBhbmQgZW5kIHVwIHNldHRpbmcgdGhlIHZhbHVlIG9mIGEgY2xvbmVkDQoJCS8vIGNoZWNrYm94L3JhZGlvIGJ1dHRvbiB0byBhbiBlbXB0eSBzdHJpbmcgaW5zdGVhZCBvZiAib24iDQoJCWlmICggZGVzdC52YWx1ZSAhPT0gc3JjLnZhbHVlICkgew0KCQkJZGVzdC52YWx1ZSA9IHNyYy52YWx1ZTsNCgkJfQ0KDQoJLy8gSUU2LTggZmFpbHMgdG8gcmV0dXJuIHRoZSBzZWxlY3RlZCBvcHRpb24gdG8gdGhlIGRlZmF1bHQgc2VsZWN0ZWQNCgkvLyBzdGF0ZSB3aGVuIGNsb25pbmcgb3B0aW9ucw0KCX0gZWxzZSBpZiAoIG5vZGVOYW1lID09PSAib3B0aW9uIiApIHsNCgkJZGVzdC5kZWZhdWx0U2VsZWN0ZWQgPSBkZXN0LnNlbGVjdGVkID0gc3JjLmRlZmF1bHRTZWxlY3RlZDsNCg0KCS8vIElFNi04IGZhaWxzIHRvIHNldCB0aGUgZGVmYXVsdFZhbHVlIHRvIHRoZSBjb3JyZWN0IHZhbHVlIHdoZW4NCgkvLyBjbG9uaW5nIG90aGVyIHR5cGVzIG9mIGlucHV0IGZpZWxkcw0KCX0gZWxzZSBpZiAoIG5vZGVOYW1lID09PSAiaW5wdXQiIHx8IG5vZGVOYW1lID09PSAidGV4dGFyZWEiICkgew0KCQlkZXN0LmRlZmF1bHRWYWx1ZSA9IHNyYy5kZWZhdWx0VmFsdWU7DQoJfQ0KfQ0KDQpqUXVlcnkuZWFjaCh7DQoJYXBwZW5kVG86ICJhcHBlbmQiLA0KCXByZXBlbmRUbzogInByZXBlbmQiLA0KCWluc2VydEJlZm9yZTogImJlZm9yZSIsDQoJaW5zZXJ0QWZ0ZXI6ICJhZnRlciIsDQoJcmVwbGFjZUFsbDogInJlcGxhY2VXaXRoIg0KfSwgZnVuY3Rpb24oIG5hbWUsIG9yaWdpbmFsICkgew0KCWpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oIHNlbGVjdG9yICkgew0KCQl2YXIgZWxlbXMsDQoJCQlpID0gMCwNCgkJCXJldCA9IFtdLA0KCQkJaW5zZXJ0ID0galF1ZXJ5KCBzZWxlY3RvciApLA0KCQkJbGFzdCA9IGluc2VydC5sZW5ndGggLSAxOw0KDQoJCWZvciAoIDsgaSA8PSBsYXN0OyBpKysgKSB7DQoJCQllbGVtcyA9IGkgPT09IGxhc3QgPyB0aGlzIDogdGhpcy5jbG9uZSh0cnVlKTsNCgkJCWpRdWVyeSggaW5zZXJ0W2ldIClbIG9yaWdpbmFsIF0oIGVsZW1zICk7DQoNCgkJCS8vIE1vZGVybiBicm93c2VycyBjYW4gYXBwbHkgalF1ZXJ5IGNvbGxlY3Rpb25zIGFzIGFycmF5cywgYnV0IG9sZElFIG5lZWRzIGEgLmdldCgpDQoJCQljb3JlX3B1c2guYXBwbHkoIHJldCwgZWxlbXMuZ2V0KCkgKTsNCgkJfQ0KDQoJCXJldHVybiB0aGlzLnB1c2hTdGFjayggcmV0ICk7DQoJfTsNCn0pOw0KDQpmdW5jdGlvbiBnZXRBbGwoIGNvbnRleHQsIHRhZyApIHsNCgl2YXIgZWxlbXMsIGVsZW0sDQoJCWkgPSAwLA0KCQlmb3VuZCA9IHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lICE9PSBjb3JlX3N0cnVuZGVmaW5lZCA/IGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIHRhZyB8fCAiKiIgKSA6DQoJCQl0eXBlb2YgY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsICE9PSBjb3JlX3N0cnVuZGVmaW5lZCA/IGNvbnRleHQucXVlcnlTZWxlY3RvckFsbCggdGFnIHx8ICIqIiApIDoNCgkJCXVuZGVmaW5lZDsNCg0KCWlmICggIWZvdW5kICkgew0KCQlmb3IgKCBmb3VuZCA9IFtdLCBlbGVtcyA9IGNvbnRleHQuY2hpbGROb2RlcyB8fCBjb250ZXh0OyAoZWxlbSA9IGVsZW1zW2ldKSAhPSBudWxsOyBpKysgKSB7DQoJCQlpZiAoICF0YWcgfHwgalF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCB0YWcgKSApIHsNCgkJCQlmb3VuZC5wdXNoKCBlbGVtICk7DQoJCQl9IGVsc2Ugew0KCQkJCWpRdWVyeS5tZXJnZSggZm91bmQsIGdldEFsbCggZWxlbSwgdGFnICkgKTsNCgkJCX0NCgkJfQ0KCX0NCg0KCXJldHVybiB0YWcgPT09IHVuZGVmaW5lZCB8fCB0YWcgJiYgalF1ZXJ5Lm5vZGVOYW1lKCBjb250ZXh0LCB0YWcgKSA/DQoJCWpRdWVyeS5tZXJnZSggWyBjb250ZXh0IF0sIGZvdW5kICkgOg0KCQlmb3VuZDsNCn0NCg0KLy8gVXNlZCBpbiBidWlsZEZyYWdtZW50LCBmaXhlcyB0aGUgZGVmYXVsdENoZWNrZWQgcHJvcGVydHkNCmZ1bmN0aW9uIGZpeERlZmF1bHRDaGVja2VkKCBlbGVtICkgew0KCWlmICggbWFuaXB1bGF0aW9uX3JjaGVja2FibGVUeXBlLnRlc3QoIGVsZW0udHlwZSApICkgew0KCQllbGVtLmRlZmF1bHRDaGVja2VkID0gZWxlbS5jaGVja2VkOw0KCX0NCn0NCg0KalF1ZXJ5LmV4dGVuZCh7DQoJY2xvbmU6IGZ1bmN0aW9uKCBlbGVtLCBkYXRhQW5kRXZlbnRzLCBkZWVwRGF0YUFuZEV2ZW50cyApIHsNCgkJdmFyIGRlc3RFbGVtZW50cywgbm9kZSwgY2xvbmUsIGksIHNyY0VsZW1lbnRzLA0KCQkJaW5QYWdlID0galF1ZXJ5LmNvbnRhaW5zKCBlbGVtLm93bmVyRG9jdW1lbnQsIGVsZW0gKTsNCg0KCQlpZiAoIGpRdWVyeS5zdXBwb3J0Lmh0bWw1Q2xvbmUgfHwgalF1ZXJ5LmlzWE1MRG9jKGVsZW0pIHx8ICFybm9zaGltY2FjaGUudGVzdCggIjwiICsgZWxlbS5ub2RlTmFtZSArICI+IiApICkgew0KCQkJY2xvbmUgPSBlbGVtLmNsb25lTm9kZSggdHJ1ZSApOw0KDQoJCS8vIElFPD04IGRvZXMgbm90IHByb3Blcmx5IGNsb25lIGRldGFjaGVkLCB1bmtub3duIGVsZW1lbnQgbm9kZXMNCgkJfSBlbHNlIHsNCgkJCWZyYWdtZW50RGl2LmlubmVySFRNTCA9IGVsZW0ub3V0ZXJIVE1MOw0KCQkJZnJhZ21lbnREaXYucmVtb3ZlQ2hpbGQoIGNsb25lID0gZnJhZ21lbnREaXYuZmlyc3RDaGlsZCApOw0KCQl9DQoNCgkJaWYgKCAoIWpRdWVyeS5zdXBwb3J0Lm5vQ2xvbmVFdmVudCB8fCAhalF1ZXJ5LnN1cHBvcnQubm9DbG9uZUNoZWNrZWQpICYmDQoJCQkJKGVsZW0ubm9kZVR5cGUgPT09IDEgfHwgZWxlbS5ub2RlVHlwZSA9PT0gMTEpICYmICFqUXVlcnkuaXNYTUxEb2MoZWxlbSkgKSB7DQoNCgkJCS8vIFdlIGVzY2hldyBTaXp6bGUgaGVyZSBmb3IgcGVyZm9ybWFuY2UgcmVhc29uczogaHR0cDovL2pzcGVyZi5jb20vZ2V0YWxsLXZzLXNpenpsZS8yDQoJCQlkZXN0RWxlbWVudHMgPSBnZXRBbGwoIGNsb25lICk7DQoJCQlzcmNFbGVtZW50cyA9IGdldEFsbCggZWxlbSApOw0KDQoJCQkvLyBGaXggYWxsIElFIGNsb25pbmcgaXNzdWVzDQoJCQlmb3IgKCBpID0gMDsgKG5vZGUgPSBzcmNFbGVtZW50c1tpXSkgIT0gbnVsbDsgKytpICkgew0KCQkJCS8vIEVuc3VyZSB0aGF0IHRoZSBkZXN0aW5hdGlvbiBub2RlIGlzIG5vdCBudWxsOyBGaXhlcyAjOTU4Nw0KCQkJCWlmICggZGVzdEVsZW1lbnRzW2ldICkgew0KCQkJCQlmaXhDbG9uZU5vZGVJc3N1ZXMoIG5vZGUsIGRlc3RFbGVtZW50c1tpXSApOw0KCQkJCX0NCgkJCX0NCgkJfQ0KDQoJCS8vIENvcHkgdGhlIGV2ZW50cyBmcm9tIHRoZSBvcmlnaW5hbCB0byB0aGUgY2xvbmUNCgkJaWYgKCBkYXRhQW5kRXZlbnRzICkgew0KCQkJaWYgKCBkZWVwRGF0YUFuZEV2ZW50cyApIHsNCgkJCQlzcmNFbGVtZW50cyA9IHNyY0VsZW1lbnRzIHx8IGdldEFsbCggZWxlbSApOw0KCQkJCWRlc3RFbGVtZW50cyA9IGRlc3RFbGVtZW50cyB8fCBnZXRBbGwoIGNsb25lICk7DQoNCgkJCQlmb3IgKCBpID0gMDsgKG5vZGUgPSBzcmNFbGVtZW50c1tpXSkgIT0gbnVsbDsgaSsrICkgew0KCQkJCQljbG9uZUNvcHlFdmVudCggbm9kZSwgZGVzdEVsZW1lbnRzW2ldICk7DQoJCQkJfQ0KCQkJfSBlbHNlIHsNCgkJCQljbG9uZUNvcHlFdmVudCggZWxlbSwgY2xvbmUgKTsNCgkJCX0NCgkJfQ0KDQoJCS8vIFByZXNlcnZlIHNjcmlwdCBldmFsdWF0aW9uIGhpc3RvcnkNCgkJZGVzdEVsZW1lbnRzID0gZ2V0QWxsKCBjbG9uZSwgInNjcmlwdCIgKTsNCgkJaWYgKCBkZXN0RWxlbWVudHMubGVuZ3RoID4gMCApIHsNCgkJCXNldEdsb2JhbEV2YWwoIGRlc3RFbGVtZW50cywgIWluUGFnZSAmJiBnZXRBbGwoIGVsZW0sICJzY3JpcHQiICkgKTsNCgkJfQ0KDQoJCWRlc3RFbGVtZW50cyA9IHNyY0VsZW1lbnRzID0gbm9kZSA9IG51bGw7DQoNCgkJLy8gUmV0dXJuIHRoZSBjbG9uZWQgc2V0DQoJCXJldHVybiBjbG9uZTsNCgl9LA0KDQoJYnVpbGRGcmFnbWVudDogZnVuY3Rpb24oIGVsZW1zLCBjb250ZXh0LCBzY3JpcHRzLCBzZWxlY3Rpb24gKSB7DQoJCXZhciBqLCBlbGVtLCBjb250YWlucywNCgkJCXRtcCwgdGFnLCB0Ym9keSwgd3JhcCwNCgkJCWwgPSBlbGVtcy5sZW5ndGgsDQoNCgkJCS8vIEVuc3VyZSBhIHNhZmUgZnJhZ21lbnQNCgkJCXNhZmUgPSBjcmVhdGVTYWZlRnJhZ21lbnQoIGNvbnRleHQgKSwNCg0KCQkJbm9kZXMgPSBbXSwNCgkJCWkgPSAwOw0KDQoJCWZvciAoIDsgaSA8IGw7IGkrKyApIHsNCgkJCWVsZW0gPSBlbGVtc1sgaSBdOw0KDQoJCQlpZiAoIGVsZW0gfHwgZWxlbSA9PT0gMCApIHsNCg0KCQkJCS8vIEFkZCBub2RlcyBkaXJlY3RseQ0KCQkJCWlmICggalF1ZXJ5LnR5cGUoIGVsZW0gKSA9PT0gIm9iamVjdCIgKSB7DQoJCQkJCWpRdWVyeS5tZXJnZSggbm9kZXMsIGVsZW0ubm9kZVR5cGUgPyBbIGVsZW0gXSA6IGVsZW0gKTsNCg0KCQkJCS8vIENvbnZlcnQgbm9uLWh0bWwgaW50byBhIHRleHQgbm9kZQ0KCQkJCX0gZWxzZSBpZiAoICFyaHRtbC50ZXN0KCBlbGVtICkgKSB7DQoJCQkJCW5vZGVzLnB1c2goIGNvbnRleHQuY3JlYXRlVGV4dE5vZGUoIGVsZW0gKSApOw0KDQoJCQkJLy8gQ29udmVydCBodG1sIGludG8gRE9NIG5vZGVzDQoJCQkJfSBlbHNlIHsNCgkJCQkJdG1wID0gdG1wIHx8IHNhZmUuYXBwZW5kQ2hpbGQoIGNvbnRleHQuY3JlYXRlRWxlbWVudCgiZGl2IikgKTsNCg0KCQkJCQkvLyBEZXNlcmlhbGl6ZSBhIHN0YW5kYXJkIHJlcHJlc2VudGF0aW9uDQoJCQkJCXRhZyA9ICggcnRhZ05hbWUuZXhlYyggZWxlbSApIHx8IFsiIiwgIiJdIClbMV0udG9Mb3dlckNhc2UoKTsNCgkJCQkJd3JhcCA9IHdyYXBNYXBbIHRhZyBdIHx8IHdyYXBNYXAuX2RlZmF1bHQ7DQoNCgkJCQkJdG1wLmlubmVySFRNTCA9IHdyYXBbMV0gKyBlbGVtLnJlcGxhY2UoIHJ4aHRtbFRhZywgIjwkMT48LyQyPiIgKSArIHdyYXBbMl07DQoNCgkJCQkJLy8gRGVzY2VuZCB0aHJvdWdoIHdyYXBwZXJzIHRvIHRoZSByaWdodCBjb250ZW50DQoJCQkJCWogPSB3cmFwWzBdOw0KCQkJCQl3aGlsZSAoIGotLSApIHsNCgkJCQkJCXRtcCA9IHRtcC5sYXN0Q2hpbGQ7DQoJCQkJCX0NCg0KCQkJCQkvLyBNYW51YWxseSBhZGQgbGVhZGluZyB3aGl0ZXNwYWNlIHJlbW92ZWQgYnkgSUUNCgkJCQkJaWYgKCAhalF1ZXJ5LnN1cHBvcnQubGVhZGluZ1doaXRlc3BhY2UgJiYgcmxlYWRpbmdXaGl0ZXNwYWNlLnRlc3QoIGVsZW0gKSApIHsNCgkJCQkJCW5vZGVzLnB1c2goIGNvbnRleHQuY3JlYXRlVGV4dE5vZGUoIHJsZWFkaW5nV2hpdGVzcGFjZS5leGVjKCBlbGVtIClbMF0gKSApOw0KCQkJCQl9DQoNCgkJCQkJLy8gUmVtb3ZlIElFJ3MgYXV0b2luc2VydGVkIDx0Ym9keT4gZnJvbSB0YWJsZSBmcmFnbWVudHMNCgkJCQkJaWYgKCAhalF1ZXJ5LnN1cHBvcnQudGJvZHkgKSB7DQoNCgkJCQkJCS8vIFN0cmluZyB3YXMgYSA8dGFibGU+LCAqbWF5KiBoYXZlIHNwdXJpb3VzIDx0Ym9keT4NCgkJCQkJCWVsZW0gPSB0YWcgPT09ICJ0YWJsZSIgJiYgIXJ0Ym9keS50ZXN0KCBlbGVtICkgPw0KCQkJCQkJCXRtcC5maXJzdENoaWxkIDoNCg0KCQkJCQkJCS8vIFN0cmluZyB3YXMgYSBiYXJlIDx0aGVhZD4gb3IgPHRmb290Pg0KCQkJCQkJCXdyYXBbMV0gPT09ICI8dGFibGU+IiAmJiAhcnRib2R5LnRlc3QoIGVsZW0gKSA/DQoJCQkJCQkJCXRtcCA6DQoJCQkJCQkJCTA7DQoNCgkJCQkJCWogPSBlbGVtICYmIGVsZW0uY2hpbGROb2Rlcy5sZW5ndGg7DQoJCQkJCQl3aGlsZSAoIGotLSApIHsNCgkJCQkJCQlpZiAoIGpRdWVyeS5ub2RlTmFtZSggKHRib2R5ID0gZWxlbS5jaGlsZE5vZGVzW2pdKSwgInRib2R5IiApICYmICF0Ym9keS5jaGlsZE5vZGVzLmxlbmd0aCApIHsNCgkJCQkJCQkJZWxlbS5yZW1vdmVDaGlsZCggdGJvZHkgKTsNCgkJCQkJCQl9DQoJCQkJCQl9DQoJCQkJCX0NCg0KCQkJCQlqUXVlcnkubWVyZ2UoIG5vZGVzLCB0bXAuY2hpbGROb2RlcyApOw0KDQoJCQkJCS8vIEZpeCAjMTIzOTIgZm9yIFdlYktpdCBhbmQgSUUgPiA5DQoJCQkJCXRtcC50ZXh0Q29udGVudCA9ICIiOw0KDQoJCQkJCS8vIEZpeCAjMTIzOTIgZm9yIG9sZElFDQoJCQkJCXdoaWxlICggdG1wLmZpcnN0Q2hpbGQgKSB7DQoJCQkJCQl0bXAucmVtb3ZlQ2hpbGQoIHRtcC5maXJzdENoaWxkICk7DQoJCQkJCX0NCg0KCQkJCQkvLyBSZW1lbWJlciB0aGUgdG9wLWxldmVsIGNvbnRhaW5lciBmb3IgcHJvcGVyIGNsZWFudXANCgkJCQkJdG1wID0gc2FmZS5sYXN0Q2hpbGQ7DQoJCQkJfQ0KCQkJfQ0KCQl9DQoNCgkJLy8gRml4ICMxMTM1NjogQ2xlYXIgZWxlbWVudHMgZnJvbSBmcmFnbWVudA0KCQlpZiAoIHRtcCApIHsNCgkJCXNhZmUucmVtb3ZlQ2hpbGQoIHRtcCApOw0KCQl9DQoNCgkJLy8gUmVzZXQgZGVmYXVsdENoZWNrZWQgZm9yIGFueSByYWRpb3MgYW5kIGNoZWNrYm94ZXMNCgkJLy8gYWJvdXQgdG8gYmUgYXBwZW5kZWQgdG8gdGhlIERPTSBpbiBJRSA2LzcgKCM4MDYwKQ0KCQlpZiAoICFqUXVlcnkuc3VwcG9ydC5hcHBlbmRDaGVja2VkICkgew0KCQkJalF1ZXJ5LmdyZXAoIGdldEFsbCggbm9kZXMsICJpbnB1dCIgKSwgZml4RGVmYXVsdENoZWNrZWQgKTsNCgkJfQ0KDQoJCWkgPSAwOw0KCQl3aGlsZSAoIChlbGVtID0gbm9kZXNbIGkrKyBdKSApIHsNCg0KCQkJLy8gIzQwODcgLSBJZiBvcmlnaW4gYW5kIGRlc3RpbmF0aW9uIGVsZW1lbnRzIGFyZSB0aGUgc2FtZSwgYW5kIHRoaXMgaXMNCgkJCS8vIHRoYXQgZWxlbWVudCwgZG8gbm90IGRvIGFueXRoaW5nDQoJCQlpZiAoIHNlbGVjdGlvbiAmJiBqUXVlcnkuaW5BcnJheSggZWxlbSwgc2VsZWN0aW9uICkgIT09IC0xICkgew0KCQkJCWNvbnRpbnVlOw0KCQkJfQ0KDQoJCQljb250YWlucyA9IGpRdWVyeS5jb250YWlucyggZWxlbS5vd25lckRvY3VtZW50LCBlbGVtICk7DQoNCgkJCS8vIEFwcGVuZCB0byBmcmFnbWVudA0KCQkJdG1wID0gZ2V0QWxsKCBzYWZlLmFwcGVuZENoaWxkKCBlbGVtICksICJzY3JpcHQiICk7DQoNCgkJCS8vIFByZXNlcnZlIHNjcmlwdCBldmFsdWF0aW9uIGhpc3RvcnkNCgkJCWlmICggY29udGFpbnMgKSB7DQoJCQkJc2V0R2xvYmFsRXZhbCggdG1wICk7DQoJCQl9DQoNCgkJCS8vIENhcHR1cmUgZXhlY3V0YWJsZXMNCgkJCWlmICggc2NyaXB0cyApIHsNCgkJCQlqID0gMDsNCgkJCQl3aGlsZSAoIChlbGVtID0gdG1wWyBqKysgXSkgKSB7DQoJCQkJCWlmICggcnNjcmlwdFR5cGUudGVzdCggZWxlbS50eXBlIHx8ICIiICkgKSB7DQoJCQkJCQlzY3JpcHRzLnB1c2goIGVsZW0gKTsNCgkJCQkJfQ0KCQkJCX0NCgkJCX0NCgkJfQ0KDQoJCXRtcCA9IG51bGw7DQoNCgkJcmV0dXJuIHNhZmU7DQoJfSwNCg0KCWNsZWFuRGF0YTogZnVuY3Rpb24oIGVsZW1zLCAvKiBpbnRlcm5hbCAqLyBhY2NlcHREYXRhICkgew0KCQl2YXIgZWxlbSwgdHlwZSwgaWQsIGRhdGEsDQoJCQlpID0gMCwNCgkJCWludGVybmFsS2V5ID0galF1ZXJ5LmV4cGFuZG8sDQoJCQljYWNoZSA9IGpRdWVyeS5jYWNoZSwNCgkJCWRlbGV0ZUV4cGFuZG8gPSBqUXVlcnkuc3VwcG9ydC5kZWxldGVFeHBhbmRvLA0KCQkJc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsOw0KDQoJCWZvciAoIDsgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrICkgew0KDQoJCQlpZiAoIGFjY2VwdERhdGEgfHwgalF1ZXJ5LmFjY2VwdERhdGEoIGVsZW0gKSApIHsNCg0KCQkJCWlkID0gZWxlbVsgaW50ZXJuYWxLZXkgXTsNCgkJCQlkYXRhID0gaWQgJiYgY2FjaGVbIGlkIF07DQoNCgkJCQlpZiAoIGRhdGEgKSB7DQoJCQkJCWlmICggZGF0YS5ldmVudHMgKSB7DQoJCQkJCQlmb3IgKCB0eXBlIGluIGRhdGEuZXZlbnRzICkgew0KCQkJCQkJCWlmICggc3BlY2lhbFsgdHlwZSBdICkgew0KCQkJCQkJCQlqUXVlcnkuZXZlbnQucmVtb3ZlKCBlbGVtLCB0eXBlICk7DQoNCgkJCQkJCQkvLyBUaGlzIGlzIGEgc2hvcnRjdXQgdG8gYXZvaWQgalF1ZXJ5LmV2ZW50LnJlbW92ZSdzIG92ZXJoZWFkDQoJCQkJCQkJfSBlbHNlIHsNCgkJCQkJCQkJalF1ZXJ5LnJlbW92ZUV2ZW50KCBlbGVtLCB0eXBlLCBkYXRhLmhhbmRsZSApOw0KCQkJCQkJCX0NCgkJCQkJCX0NCgkJCQkJfQ0KDQoJCQkJCS8vIFJlbW92ZSBjYWNoZSBvbmx5IGlmIGl0IHdhcyBub3QgYWxyZWFkeSByZW1vdmVkIGJ5IGpRdWVyeS5ldmVudC5yZW1vdmUNCgkJCQkJaWYgKCBjYWNoZVsgaWQgXSApIHsNCg0KCQkJCQkJZGVsZXRlIGNhY2hlWyBpZCBdOw0KDQoJCQkJCQkvLyBJRSBkb2VzIG5vdCBhbGxvdyB1cyB0byBkZWxldGUgZXhwYW5kbyBwcm9wZXJ0aWVzIGZyb20gbm9kZXMsDQoJCQkJCQkvLyBub3IgZG9lcyBpdCBoYXZlIGEgcmVtb3ZlQXR0cmlidXRlIGZ1bmN0aW9uIG9uIERvY3VtZW50IG5vZGVzOw0KCQkJCQkJLy8gd2UgbXVzdCBoYW5kbGUgYWxsIG9mIHRoZXNlIGNhc2VzDQoJCQkJCQlpZiAoIGRlbGV0ZUV4cGFuZG8gKSB7DQoJCQkJCQkJZGVsZXRlIGVsZW1bIGludGVybmFsS2V5IF07DQoNCgkJCQkJCX0gZWxzZSBpZiAoIHR5cGVvZiBlbGVtLnJlbW92ZUF0dHJpYnV0ZSAhPT0gY29yZV9zdHJ1bmRlZmluZWQgKSB7DQoJCQkJCQkJZWxlbS5yZW1vdmVBdHRyaWJ1dGUoIGludGVybmFsS2V5ICk7DQoNCgkJCQkJCX0gZWxzZSB7DQoJCQkJCQkJZWxlbVsgaW50ZXJuYWxLZXkgXSA9IG51bGw7DQoJCQkJCQl9DQoNCgkJCQkJCWNvcmVfZGVsZXRlZElkcy5wdXNoKCBpZCApOw0KCQkJCQl9DQoJCQkJfQ0KCQkJfQ0KCQl9DQoJfSwNCg0KCV9ldmFsVXJsOiBmdW5jdGlvbiggdXJsICkgew0KCQlyZXR1cm4galF1ZXJ5LmFqYXgoew0KCQkJdXJsOiB1cmwsDQoJCQl0eXBlOiAiR0VUIiwNCgkJCWRhdGFUeXBlOiAic2NyaXB0IiwNCgkJCWFzeW5jOiBmYWxzZSwNCgkJCWdsb2JhbDogZmFsc2UsDQoJCQkidGhyb3dzIjogdHJ1ZQ0KCQl9KTsNCgl9DQp9KTsNCmpRdWVyeS5mbi5leHRlbmQoew0KCXdyYXBBbGw6IGZ1bmN0aW9uKCBodG1sICkgew0KCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBodG1sICkgKSB7DQoJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGkpIHsNCgkJCQlqUXVlcnkodGhpcykud3JhcEFsbCggaHRtbC5jYWxsKHRoaXMsIGkpICk7DQoJCQl9KTsNCgkJfQ0KDQoJCWlmICggdGhpc1swXSApIHsNCgkJCS8vIFRoZSBlbGVtZW50cyB0byB3cmFwIHRoZSB0YXJnZXQgYXJvdW5kDQoJCQl2YXIgd3JhcCA9IGpRdWVyeSggaHRtbCwgdGhpc1swXS5vd25lckRvY3VtZW50ICkuZXEoMCkuY2xvbmUodHJ1ZSk7DQoNCgkJCWlmICggdGhpc1swXS5wYXJlbnROb2RlICkgew0KCQkJCXdyYXAuaW5zZXJ0QmVmb3JlKCB0aGlzWzBdICk7DQoJCQl9DQoNCgkJCXdyYXAubWFwKGZ1bmN0aW9uKCkgew0KCQkJCXZhciBlbGVtID0gdGhpczsNCg0KCQkJCXdoaWxlICggZWxlbS5maXJzdENoaWxkICYmIGVsZW0uZmlyc3RDaGlsZC5ub2RlVHlwZSA9PT0gMSApIHsNCgkJCQkJZWxlbSA9IGVsZW0uZmlyc3RDaGlsZDsNCgkJCQl9DQoNCgkJCQlyZXR1cm4gZWxlbTsNCgkJCX0pLmFwcGVuZCggdGhpcyApOw0KCQl9DQoNCgkJcmV0dXJuIHRoaXM7DQoJfSwNCg0KCXdyYXBJbm5lcjogZnVuY3Rpb24oIGh0bWwgKSB7DQoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIGh0bWwgKSApIHsNCgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oaSkgew0KCQkJCWpRdWVyeSh0aGlzKS53cmFwSW5uZXIoIGh0bWwuY2FsbCh0aGlzLCBpKSApOw0KCQkJfSk7DQoJCX0NCg0KCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgew0KCQkJdmFyIHNlbGYgPSBqUXVlcnkoIHRoaXMgKSwNCgkJCQljb250ZW50cyA9IHNlbGYuY29udGVudHMoKTsNCg0KCQkJaWYgKCBjb250ZW50cy5sZW5ndGggKSB7DQoJCQkJY29udGVudHMud3JhcEFsbCggaHRtbCApOw0KDQoJCQl9IGVsc2Ugew0KCQkJCXNlbGYuYXBwZW5kKCBodG1sICk7DQoJCQl9DQoJCX0pOw0KCX0sDQoNCgl3cmFwOiBmdW5jdGlvbiggaHRtbCApIHsNCgkJdmFyIGlzRnVuY3Rpb24gPSBqUXVlcnkuaXNGdW5jdGlvbiggaHRtbCApOw0KDQoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oaSkgew0KCQkJalF1ZXJ5KCB0aGlzICkud3JhcEFsbCggaXNGdW5jdGlvbiA/IGh0bWwuY2FsbCh0aGlzLCBpKSA6IGh0bWwgKTsNCgkJfSk7DQoJfSwNCg0KCXVud3JhcDogZnVuY3Rpb24oKSB7DQoJCXJldHVybiB0aGlzLnBhcmVudCgpLmVhY2goZnVuY3Rpb24oKSB7DQoJCQlpZiAoICFqUXVlcnkubm9kZU5hbWUoIHRoaXMsICJib2R5IiApICkgew0KCQkJCWpRdWVyeSggdGhpcyApLnJlcGxhY2VXaXRoKCB0aGlzLmNoaWxkTm9kZXMgKTsNCgkJCX0NCgkJfSkuZW5kKCk7DQoJfQ0KfSk7DQp2YXIgaWZyYW1lLCBnZXRTdHlsZXMsIGN1ckNTUywNCglyYWxwaGEgPSAvYWxwaGFcKFteKV0qXCkvaSwNCglyb3BhY2l0eSA9IC9vcGFjaXR5XHMqPVxzKihbXildKikvLA0KCXJwb3NpdGlvbiA9IC9eKHRvcHxyaWdodHxib3R0b218bGVmdCkkLywNCgkvLyBzd2FwcGFibGUgaWYgZGlzcGxheSBpcyBub25lIG9yIHN0YXJ0cyB3aXRoIHRhYmxlIGV4Y2VwdCAidGFibGUiLCAidGFibGUtY2VsbCIsIG9yICJ0YWJsZS1jYXB0aW9uIg0KCS8vIHNlZSBoZXJlIGZvciBkaXNwbGF5IHZhbHVlczogaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9DU1MvZGlzcGxheQ0KCXJkaXNwbGF5c3dhcCA9IC9eKG5vbmV8dGFibGUoPyEtY1tlYV0pLispLywNCglybWFyZ2luID0gL15tYXJnaW4vLA0KCXJudW1zcGxpdCA9IG5ldyBSZWdFeHAoICJeKCIgKyBjb3JlX3BudW0gKyAiKSguKikkIiwgImkiICksDQoJcm51bW5vbnB4ID0gbmV3IFJlZ0V4cCggIl4oIiArIGNvcmVfcG51bSArICIpKD8hcHgpW2EteiVdKyQiLCAiaSIgKSwNCglycmVsTnVtID0gbmV3IFJlZ0V4cCggIl4oWystXSk9KCIgKyBjb3JlX3BudW0gKyAiKSIsICJpIiApLA0KCWVsZW1kaXNwbGF5ID0geyBCT0RZOiAiYmxvY2siIH0sDQoNCgljc3NTaG93ID0geyBwb3NpdGlvbjogImFic29sdXRlIiwgdmlzaWJpbGl0eTogImhpZGRlbiIsIGRpc3BsYXk6ICJibG9jayIgfSwNCgljc3NOb3JtYWxUcmFuc2Zvcm0gPSB7DQoJCWxldHRlclNwYWNpbmc6IDAsDQoJCWZvbnRXZWlnaHQ6IDQwMA0KCX0sDQoNCgljc3NFeHBhbmQgPSBbICJUb3AiLCAiUmlnaHQiLCAiQm90dG9tIiwgIkxlZnQiIF0sDQoJY3NzUHJlZml4ZXMgPSBbICJXZWJraXQiLCAiTyIsICJNb3oiLCAibXMiIF07DQoNCi8vIHJldHVybiBhIGNzcyBwcm9wZXJ0eSBtYXBwZWQgdG8gYSBwb3RlbnRpYWxseSB2ZW5kb3IgcHJlZml4ZWQgcHJvcGVydHkNCmZ1bmN0aW9uIHZlbmRvclByb3BOYW1lKCBzdHlsZSwgbmFtZSApIHsNCg0KCS8vIHNob3J0Y3V0IGZvciBuYW1lcyB0aGF0IGFyZSBub3QgdmVuZG9yIHByZWZpeGVkDQoJaWYgKCBuYW1lIGluIHN0eWxlICkgew0KCQlyZXR1cm4gbmFtZTsNCgl9DQoNCgkvLyBjaGVjayBmb3IgdmVuZG9yIHByZWZpeGVkIG5hbWVzDQoJdmFyIGNhcE5hbWUgPSBuYW1lLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgbmFtZS5zbGljZSgxKSwNCgkJb3JpZ05hbWUgPSBuYW1lLA0KCQlpID0gY3NzUHJlZml4ZXMubGVuZ3RoOw0KDQoJd2hpbGUgKCBpLS0gKSB7DQoJCW5hbWUgPSBjc3NQcmVmaXhlc1sgaSBdICsgY2FwTmFtZTsNCgkJaWYgKCBuYW1lIGluIHN0eWxlICkgew0KCQkJcmV0dXJuIG5hbWU7DQoJCX0NCgl9DQoNCglyZXR1cm4gb3JpZ05hbWU7DQp9DQoNCmZ1bmN0aW9uIGlzSGlkZGVuKCBlbGVtLCBlbCApIHsNCgkvLyBpc0hpZGRlbiBtaWdodCBiZSBjYWxsZWQgZnJvbSBqUXVlcnkjZmlsdGVyIGZ1bmN0aW9uOw0KCS8vIGluIHRoYXQgY2FzZSwgZWxlbWVudCB3aWxsIGJlIHNlY29uZCBhcmd1bWVudA0KCWVsZW0gPSBlbCB8fCBlbGVtOw0KCXJldHVybiBqUXVlcnkuY3NzKCBlbGVtLCAiZGlzcGxheSIgKSA9PT0gIm5vbmUiIHx8ICFqUXVlcnkuY29udGFpbnMoIGVsZW0ub3duZXJEb2N1bWVudCwgZWxlbSApOw0KfQ0KDQpmdW5jdGlvbiBzaG93SGlkZSggZWxlbWVudHMsIHNob3cgKSB7DQoJdmFyIGRpc3BsYXksIGVsZW0sIGhpZGRlbiwNCgkJdmFsdWVzID0gW10sDQoJCWluZGV4ID0gMCwNCgkJbGVuZ3RoID0gZWxlbWVudHMubGVuZ3RoOw0KDQoJZm9yICggOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKyApIHsNCgkJZWxlbSA9IGVsZW1lbnRzWyBpbmRleCBdOw0KCQlpZiAoICFlbGVtLnN0eWxlICkgew0KCQkJY29udGludWU7DQoJCX0NCg0KCQl2YWx1ZXNbIGluZGV4IF0gPSBqUXVlcnkuX2RhdGEoIGVsZW0sICJvbGRkaXNwbGF5IiApOw0KCQlkaXNwbGF5ID0gZWxlbS5zdHlsZS5kaXNwbGF5Ow0KCQlpZiAoIHNob3cgKSB7DQoJCQkvLyBSZXNldCB0aGUgaW5saW5lIGRpc3BsYXkgb2YgdGhpcyBlbGVtZW50IHRvIGxlYXJuIGlmIGl0IGlzDQoJCQkvLyBiZWluZyBoaWRkZW4gYnkgY2FzY2FkZWQgcnVsZXMgb3Igbm90DQoJCQlpZiAoICF2YWx1ZXNbIGluZGV4IF0gJiYgZGlzcGxheSA9PT0gIm5vbmUiICkgew0KCQkJCWVsZW0uc3R5bGUuZGlzcGxheSA9ICIiOw0KCQkJfQ0KDQoJCQkvLyBTZXQgZWxlbWVudHMgd2hpY2ggaGF2ZSBiZWVuIG92ZXJyaWRkZW4gd2l0aCBkaXNwbGF5OiBub25lDQoJCQkvLyBpbiBhIHN0eWxlc2hlZXQgdG8gd2hhdGV2ZXIgdGhlIGRlZmF1bHQgYnJvd3NlciBzdHlsZSBpcw0KCQkJLy8gZm9yIHN1Y2ggYW4gZWxlbWVudA0KCQkJaWYgKCBlbGVtLnN0eWxlLmRpc3BsYXkgPT09ICIiICYmIGlzSGlkZGVuKCBlbGVtICkgKSB7DQoJCQkJdmFsdWVzWyBpbmRleCBdID0galF1ZXJ5Ll9kYXRhKCBlbGVtLCAib2xkZGlzcGxheSIsIGNzc19kZWZhdWx0RGlzcGxheShlbGVtLm5vZGVOYW1lKSApOw0KCQkJfQ0KCQl9IGVsc2Ugew0KDQoJCQlpZiAoICF2YWx1ZXNbIGluZGV4IF0gKSB7DQoJCQkJaGlkZGVuID0gaXNIaWRkZW4oIGVsZW0gKTsNCg0KCQkJCWlmICggZGlzcGxheSAmJiBkaXNwbGF5ICE9PSAibm9uZSIgfHwgIWhpZGRlbiApIHsNCgkJCQkJalF1ZXJ5Ll9kYXRhKCBlbGVtLCAib2xkZGlzcGxheSIsIGhpZGRlbiA/IGRpc3BsYXkgOiBqUXVlcnkuY3NzKCBlbGVtLCAiZGlzcGxheSIgKSApOw0KCQkJCX0NCgkJCX0NCgkJfQ0KCX0NCg0KCS8vIFNldCB0aGUgZGlzcGxheSBvZiBtb3N0IG9mIHRoZSBlbGVtZW50cyBpbiBhIHNlY29uZCBsb29wDQoJLy8gdG8gYXZvaWQgdGhlIGNvbnN0YW50IHJlZmxvdw0KCWZvciAoIGluZGV4ID0gMDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KysgKSB7DQoJCWVsZW0gPSBlbGVtZW50c1sgaW5kZXggXTsNCgkJaWYgKCAhZWxlbS5zdHlsZSApIHsNCgkJCWNvbnRpbnVlOw0KCQl9DQoJCWlmICggIXNob3cgfHwgZWxlbS5zdHlsZS5kaXNwbGF5ID09PSAibm9uZSIgfHwgZWxlbS5zdHlsZS5kaXNwbGF5ID09PSAiIiApIHsNCgkJCWVsZW0uc3R5bGUuZGlzcGxheSA9IHNob3cgPyB2YWx1ZXNbIGluZGV4IF0gfHwgIiIgOiAibm9uZSI7DQoJCX0NCgl9DQoNCglyZXR1cm4gZWxlbWVudHM7DQp9DQoNCmpRdWVyeS5mbi5leHRlbmQoew0KCWNzczogZnVuY3Rpb24oIG5hbWUsIHZhbHVlICkgew0KCQlyZXR1cm4galF1ZXJ5LmFjY2VzcyggdGhpcywgZnVuY3Rpb24oIGVsZW0sIG5hbWUsIHZhbHVlICkgew0KCQkJdmFyIGxlbiwgc3R5bGVzLA0KCQkJCW1hcCA9IHt9LA0KCQkJCWkgPSAwOw0KDQoJCQlpZiAoIGpRdWVyeS5pc0FycmF5KCBuYW1lICkgKSB7DQoJCQkJc3R5bGVzID0gZ2V0U3R5bGVzKCBlbGVtICk7DQoJCQkJbGVuID0gbmFtZS5sZW5ndGg7DQoNCgkJCQlmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsNCgkJCQkJbWFwWyBuYW1lWyBpIF0gXSA9IGpRdWVyeS5jc3MoIGVsZW0sIG5hbWVbIGkgXSwgZmFsc2UsIHN0eWxlcyApOw0KCQkJCX0NCg0KCQkJCXJldHVybiBtYXA7DQoJCQl9DQoNCgkJCXJldHVybiB2YWx1ZSAhPT0gdW5kZWZpbmVkID8NCgkJCQlqUXVlcnkuc3R5bGUoIGVsZW0sIG5hbWUsIHZhbHVlICkgOg0KCQkJCWpRdWVyeS5jc3MoIGVsZW0sIG5hbWUgKTsNCgkJfSwgbmFtZSwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxICk7DQoJfSwNCglzaG93OiBmdW5jdGlvbigpIHsNCgkJcmV0dXJuIHNob3dIaWRlKCB0aGlzLCB0cnVlICk7DQoJfSwNCgloaWRlOiBmdW5jdGlvbigpIHsNCgkJcmV0dXJuIHNob3dIaWRlKCB0aGlzICk7DQoJfSwNCgl0b2dnbGU6IGZ1bmN0aW9uKCBzdGF0ZSApIHsNCgkJaWYgKCB0eXBlb2Ygc3RhdGUgPT09ICJib29sZWFuIiApIHsNCgkJCXJldHVybiBzdGF0ZSA/IHRoaXMuc2hvdygpIDogdGhpcy5oaWRlKCk7DQoJCX0NCg0KCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgew0KCQkJaWYgKCBpc0hpZGRlbiggdGhpcyApICkgew0KCQkJCWpRdWVyeSggdGhpcyApLnNob3coKTsNCgkJCX0gZWxzZSB7DQoJCQkJalF1ZXJ5KCB0aGlzICkuaGlkZSgpOw0KCQkJfQ0KCQl9KTsNCgl9DQp9KTsNCg0KalF1ZXJ5LmV4dGVuZCh7DQoJLy8gQWRkIGluIHN0eWxlIHByb3BlcnR5IGhvb2tzIGZvciBvdmVycmlkaW5nIHRoZSBkZWZhdWx0DQoJLy8gYmVoYXZpb3Igb2YgZ2V0dGluZyBhbmQgc2V0dGluZyBhIHN0eWxlIHByb3BlcnR5DQoJY3NzSG9va3M6IHsNCgkJb3BhY2l0eTogew0KCQkJZ2V0OiBmdW5jdGlvbiggZWxlbSwgY29tcHV0ZWQgKSB7DQoJCQkJaWYgKCBjb21wdXRlZCApIHsNCgkJCQkJLy8gV2Ugc2hvdWxkIGFsd2F5cyBnZXQgYSBudW1iZXIgYmFjayBmcm9tIG9wYWNpdHkNCgkJCQkJdmFyIHJldCA9IGN1ckNTUyggZWxlbSwgIm9wYWNpdHkiICk7DQoJCQkJCXJldHVybiByZXQgPT09ICIiID8gIjEiIDogcmV0Ow0KCQkJCX0NCgkJCX0NCgkJfQ0KCX0sDQoNCgkvLyBEb24ndCBhdXRvbWF0aWNhbGx5IGFkZCAicHgiIHRvIHRoZXNlIHBvc3NpYmx5LXVuaXRsZXNzIHByb3BlcnRpZXMNCgljc3NOdW1iZXI6IHsNCgkJImNvbHVtbkNvdW50IjogdHJ1ZSwNCgkJImZpbGxPcGFjaXR5IjogdHJ1ZSwNCgkJImZvbnRXZWlnaHQiOiB0cnVlLA0KCQkibGluZUhlaWdodCI6IHRydWUsDQoJCSJvcGFjaXR5IjogdHJ1ZSwNCgkJIm9yZGVyIjogdHJ1ZSwNCgkJIm9ycGhhbnMiOiB0cnVlLA0KCQkid2lkb3dzIjogdHJ1ZSwNCgkJInpJbmRleCI6IHRydWUsDQoJCSJ6b29tIjogdHJ1ZQ0KCX0sDQoNCgkvLyBBZGQgaW4gcHJvcGVydGllcyB3aG9zZSBuYW1lcyB5b3Ugd2lzaCB0byBmaXggYmVmb3JlDQoJLy8gc2V0dGluZyBvciBnZXR0aW5nIHRoZSB2YWx1ZQ0KCWNzc1Byb3BzOiB7DQoJCS8vIG5vcm1hbGl6ZSBmbG9hdCBjc3MgcHJvcGVydHkNCgkJImZsb2F0IjogalF1ZXJ5LnN1cHBvcnQuY3NzRmxvYXQgPyAiY3NzRmxvYXQiIDogInN0eWxlRmxvYXQiDQoJfSwNCg0KCS8vIEdldCBhbmQgc2V0IHRoZSBzdHlsZSBwcm9wZXJ0eSBvbiBhIERPTSBOb2RlDQoJc3R5bGU6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCB2YWx1ZSwgZXh0cmEgKSB7DQoJCS8vIERvbid0IHNldCBzdHlsZXMgb24gdGV4dCBhbmQgY29tbWVudCBub2Rlcw0KCQlpZiAoICFlbGVtIHx8IGVsZW0ubm9kZVR5cGUgPT09IDMgfHwgZWxlbS5ub2RlVHlwZSA9PT0gOCB8fCAhZWxlbS5zdHlsZSApIHsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCS8vIE1ha2Ugc3VyZSB0aGF0IHdlJ3JlIHdvcmtpbmcgd2l0aCB0aGUgcmlnaHQgbmFtZQ0KCQl2YXIgcmV0LCB0eXBlLCBob29rcywNCgkJCW9yaWdOYW1lID0galF1ZXJ5LmNhbWVsQ2FzZSggbmFtZSApLA0KCQkJc3R5bGUgPSBlbGVtLnN0eWxlOw0KDQoJCW5hbWUgPSBqUXVlcnkuY3NzUHJvcHNbIG9yaWdOYW1lIF0gfHwgKCBqUXVlcnkuY3NzUHJvcHNbIG9yaWdOYW1lIF0gPSB2ZW5kb3JQcm9wTmFtZSggc3R5bGUsIG9yaWdOYW1lICkgKTsNCg0KCQkvLyBnZXRzIGhvb2sgZm9yIHRoZSBwcmVmaXhlZCB2ZXJzaW9uDQoJCS8vIGZvbGxvd2VkIGJ5IHRoZSB1bnByZWZpeGVkIHZlcnNpb24NCgkJaG9va3MgPSBqUXVlcnkuY3NzSG9va3NbIG5hbWUgXSB8fCBqUXVlcnkuY3NzSG9va3NbIG9yaWdOYW1lIF07DQoNCgkJLy8gQ2hlY2sgaWYgd2UncmUgc2V0dGluZyBhIHZhbHVlDQoJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsNCgkJCXR5cGUgPSB0eXBlb2YgdmFsdWU7DQoNCgkJCS8vIGNvbnZlcnQgcmVsYXRpdmUgbnVtYmVyIHN0cmluZ3MgKCs9IG9yIC09KSB0byByZWxhdGl2ZSBudW1iZXJzLiAjNzM0NQ0KCQkJaWYgKCB0eXBlID09PSAic3RyaW5nIiAmJiAocmV0ID0gcnJlbE51bS5leGVjKCB2YWx1ZSApKSApIHsNCgkJCQl2YWx1ZSA9ICggcmV0WzFdICsgMSApICogcmV0WzJdICsgcGFyc2VGbG9hdCggalF1ZXJ5LmNzcyggZWxlbSwgbmFtZSApICk7DQoJCQkJLy8gRml4ZXMgYnVnICM5MjM3DQoJCQkJdHlwZSA9ICJudW1iZXIiOw0KCQkJfQ0KDQoJCQkvLyBNYWtlIHN1cmUgdGhhdCBOYU4gYW5kIG51bGwgdmFsdWVzIGFyZW4ndCBzZXQuIFNlZTogIzcxMTYNCgkJCWlmICggdmFsdWUgPT0gbnVsbCB8fCB0eXBlID09PSAibnVtYmVyIiAmJiBpc05hTiggdmFsdWUgKSApIHsNCgkJCQlyZXR1cm47DQoJCQl9DQoNCgkJCS8vIElmIGEgbnVtYmVyIHdhcyBwYXNzZWQgaW4sIGFkZCAncHgnIHRvIHRoZSAoZXhjZXB0IGZvciBjZXJ0YWluIENTUyBwcm9wZXJ0aWVzKQ0KCQkJaWYgKCB0eXBlID09PSAibnVtYmVyIiAmJiAhalF1ZXJ5LmNzc051bWJlclsgb3JpZ05hbWUgXSApIHsNCgkJCQl2YWx1ZSArPSAicHgiOw0KCQkJfQ0KDQoJCQkvLyBGaXhlcyAjODkwOCwgaXQgY2FuIGJlIGRvbmUgbW9yZSBjb3JyZWN0bHkgYnkgc3BlY2lmaW5nIHNldHRlcnMgaW4gY3NzSG9va3MsDQoJCQkvLyBidXQgaXQgd291bGQgbWVhbiB0byBkZWZpbmUgZWlnaHQgKGZvciBldmVyeSBwcm9ibGVtYXRpYyBwcm9wZXJ0eSkgaWRlbnRpY2FsIGZ1bmN0aW9ucw0KCQkJaWYgKCAhalF1ZXJ5LnN1cHBvcnQuY2xlYXJDbG9uZVN0eWxlICYmIHZhbHVlID09PSAiIiAmJiBuYW1lLmluZGV4T2YoImJhY2tncm91bmQiKSA9PT0gMCApIHsNCgkJCQlzdHlsZVsgbmFtZSBdID0gImluaGVyaXQiOw0KCQkJfQ0KDQoJCQkvLyBJZiBhIGhvb2sgd2FzIHByb3ZpZGVkLCB1c2UgdGhhdCB2YWx1ZSwgb3RoZXJ3aXNlIGp1c3Qgc2V0IHRoZSBzcGVjaWZpZWQgdmFsdWUNCgkJCWlmICggIWhvb2tzIHx8ICEoInNldCIgaW4gaG9va3MpIHx8ICh2YWx1ZSA9IGhvb2tzLnNldCggZWxlbSwgdmFsdWUsIGV4dHJhICkpICE9PSB1bmRlZmluZWQgKSB7DQoNCgkJCQkvLyBXcmFwcGVkIHRvIHByZXZlbnQgSUUgZnJvbSB0aHJvd2luZyBlcnJvcnMgd2hlbiAnaW52YWxpZCcgdmFsdWVzIGFyZSBwcm92aWRlZA0KCQkJCS8vIEZpeGVzIGJ1ZyAjNTUwOQ0KCQkJCXRyeSB7DQoJCQkJCXN0eWxlWyBuYW1lIF0gPSB2YWx1ZTsNCgkJCQl9IGNhdGNoKGUpIHt9DQoJCQl9DQoNCgkJfSBlbHNlIHsNCgkJCS8vIElmIGEgaG9vayB3YXMgcHJvdmlkZWQgZ2V0IHRoZSBub24tY29tcHV0ZWQgdmFsdWUgZnJvbSB0aGVyZQ0KCQkJaWYgKCBob29rcyAmJiAiZ2V0IiBpbiBob29rcyAmJiAocmV0ID0gaG9va3MuZ2V0KCBlbGVtLCBmYWxzZSwgZXh0cmEgKSkgIT09IHVuZGVmaW5lZCApIHsNCgkJCQlyZXR1cm4gcmV0Ow0KCQkJfQ0KDQoJCQkvLyBPdGhlcndpc2UganVzdCBnZXQgdGhlIHZhbHVlIGZyb20gdGhlIHN0eWxlIG9iamVjdA0KCQkJcmV0dXJuIHN0eWxlWyBuYW1lIF07DQoJCX0NCgl9LA0KDQoJY3NzOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgZXh0cmEsIHN0eWxlcyApIHsNCgkJdmFyIG51bSwgdmFsLCBob29rcywNCgkJCW9yaWdOYW1lID0galF1ZXJ5LmNhbWVsQ2FzZSggbmFtZSApOw0KDQoJCS8vIE1ha2Ugc3VyZSB0aGF0IHdlJ3JlIHdvcmtpbmcgd2l0aCB0aGUgcmlnaHQgbmFtZQ0KCQluYW1lID0galF1ZXJ5LmNzc1Byb3BzWyBvcmlnTmFtZSBdIHx8ICggalF1ZXJ5LmNzc1Byb3BzWyBvcmlnTmFtZSBdID0gdmVuZG9yUHJvcE5hbWUoIGVsZW0uc3R5bGUsIG9yaWdOYW1lICkgKTsNCg0KCQkvLyBnZXRzIGhvb2sgZm9yIHRoZSBwcmVmaXhlZCB2ZXJzaW9uDQoJCS8vIGZvbGxvd2VkIGJ5IHRoZSB1bnByZWZpeGVkIHZlcnNpb24NCgkJaG9va3MgPSBqUXVlcnkuY3NzSG9va3NbIG5hbWUgXSB8fCBqUXVlcnkuY3NzSG9va3NbIG9yaWdOYW1lIF07DQoNCgkJLy8gSWYgYSBob29rIHdhcyBwcm92aWRlZCBnZXQgdGhlIGNvbXB1dGVkIHZhbHVlIGZyb20gdGhlcmUNCgkJaWYgKCBob29rcyAmJiAiZ2V0IiBpbiBob29rcyApIHsNCgkJCXZhbCA9IGhvb2tzLmdldCggZWxlbSwgdHJ1ZSwgZXh0cmEgKTsNCgkJfQ0KDQoJCS8vIE90aGVyd2lzZSwgaWYgYSB3YXkgdG8gZ2V0IHRoZSBjb21wdXRlZCB2YWx1ZSBleGlzdHMsIHVzZSB0aGF0DQoJCWlmICggdmFsID09PSB1bmRlZmluZWQgKSB7DQoJCQl2YWwgPSBjdXJDU1MoIGVsZW0sIG5hbWUsIHN0eWxlcyApOw0KCQl9DQoNCgkJLy9jb252ZXJ0ICJub3JtYWwiIHRvIGNvbXB1dGVkIHZhbHVlDQoJCWlmICggdmFsID09PSAibm9ybWFsIiAmJiBuYW1lIGluIGNzc05vcm1hbFRyYW5zZm9ybSApIHsNCgkJCXZhbCA9IGNzc05vcm1hbFRyYW5zZm9ybVsgbmFtZSBdOw0KCQl9DQoNCgkJLy8gUmV0dXJuLCBjb252ZXJ0aW5nIHRvIG51bWJlciBpZiBmb3JjZWQgb3IgYSBxdWFsaWZpZXIgd2FzIHByb3ZpZGVkIGFuZCB2YWwgbG9va3MgbnVtZXJpYw0KCQlpZiAoIGV4dHJhID09PSAiIiB8fCBleHRyYSApIHsNCgkJCW51bSA9IHBhcnNlRmxvYXQoIHZhbCApOw0KCQkJcmV0dXJuIGV4dHJhID09PSB0cnVlIHx8IGpRdWVyeS5pc051bWVyaWMoIG51bSApID8gbnVtIHx8IDAgOiB2YWw7DQoJCX0NCgkJcmV0dXJuIHZhbDsNCgl9DQp9KTsNCg0KLy8gTk9URTogd2UndmUgaW5jbHVkZWQgdGhlICJ3aW5kb3ciIGluIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlDQovLyBiZWNhdXNlIGpzZG9tIG9uIG5vZGUuanMgd2lsbCBicmVhayB3aXRob3V0IGl0Lg0KaWYgKCB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSApIHsNCglnZXRTdHlsZXMgPSBmdW5jdGlvbiggZWxlbSApIHsNCgkJcmV0dXJuIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKCBlbGVtLCBudWxsICk7DQoJfTsNCg0KCWN1ckNTUyA9IGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCBfY29tcHV0ZWQgKSB7DQoJCXZhciB3aWR0aCwgbWluV2lkdGgsIG1heFdpZHRoLA0KCQkJY29tcHV0ZWQgPSBfY29tcHV0ZWQgfHwgZ2V0U3R5bGVzKCBlbGVtICksDQoNCgkJCS8vIGdldFByb3BlcnR5VmFsdWUgaXMgb25seSBuZWVkZWQgZm9yIC5jc3MoJ2ZpbHRlcicpIGluIElFOSwgc2VlICMxMjUzNw0KCQkJcmV0ID0gY29tcHV0ZWQgPyBjb21wdXRlZC5nZXRQcm9wZXJ0eVZhbHVlKCBuYW1lICkgfHwgY29tcHV0ZWRbIG5hbWUgXSA6IHVuZGVmaW5lZCwNCgkJCXN0eWxlID0gZWxlbS5zdHlsZTsNCg0KCQlpZiAoIGNvbXB1dGVkICkgew0KDQoJCQlpZiAoIHJldCA9PT0gIiIgJiYgIWpRdWVyeS5jb250YWlucyggZWxlbS5vd25lckRvY3VtZW50LCBlbGVtICkgKSB7DQoJCQkJcmV0ID0galF1ZXJ5LnN0eWxlKCBlbGVtLCBuYW1lICk7DQoJCQl9DQoNCgkJCS8vIEEgdHJpYnV0ZSB0byB0aGUgImF3ZXNvbWUgaGFjayBieSBEZWFuIEVkd2FyZHMiDQoJCQkvLyBDaHJvbWUgPCAxNyBhbmQgU2FmYXJpIDUuMCB1c2VzICJjb21wdXRlZCB2YWx1ZSIgaW5zdGVhZCBvZiAidXNlZCB2YWx1ZSIgZm9yIG1hcmdpbi1yaWdodA0KCQkJLy8gU2FmYXJpIDUuMS43IChhdCBsZWFzdCkgcmV0dXJucyBwZXJjZW50YWdlIGZvciBhIGxhcmdlciBzZXQgb2YgdmFsdWVzLCBidXQgd2lkdGggc2VlbXMgdG8gYmUgcmVsaWFibHkgcGl4ZWxzDQoJCQkvLyB0aGlzIGlzIGFnYWluc3QgdGhlIENTU09NIGRyYWZ0IHNwZWM6IGh0dHA6Ly9kZXYudzMub3JnL2Nzc3dnL2Nzc29tLyNyZXNvbHZlZC12YWx1ZXMNCgkJCWlmICggcm51bW5vbnB4LnRlc3QoIHJldCApICYmIHJtYXJnaW4udGVzdCggbmFtZSApICkgew0KDQoJCQkJLy8gUmVtZW1iZXIgdGhlIG9yaWdpbmFsIHZhbHVlcw0KCQkJCXdpZHRoID0gc3R5bGUud2lkdGg7DQoJCQkJbWluV2lkdGggPSBzdHlsZS5taW5XaWR0aDsNCgkJCQltYXhXaWR0aCA9IHN0eWxlLm1heFdpZHRoOw0KDQoJCQkJLy8gUHV0IGluIHRoZSBuZXcgdmFsdWVzIHRvIGdldCBhIGNvbXB1dGVkIHZhbHVlIG91dA0KCQkJCXN0eWxlLm1pbldpZHRoID0gc3R5bGUubWF4V2lkdGggPSBzdHlsZS53aWR0aCA9IHJldDsNCgkJCQlyZXQgPSBjb21wdXRlZC53aWR0aDsNCg0KCQkJCS8vIFJldmVydCB0aGUgY2hhbmdlZCB2YWx1ZXMNCgkJCQlzdHlsZS53aWR0aCA9IHdpZHRoOw0KCQkJCXN0eWxlLm1pbldpZHRoID0gbWluV2lkdGg7DQoJCQkJc3R5bGUubWF4V2lkdGggPSBtYXhXaWR0aDsNCgkJCX0NCgkJfQ0KDQoJCXJldHVybiByZXQ7DQoJfTsNCn0gZWxzZSBpZiAoIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jdXJyZW50U3R5bGUgKSB7DQoJZ2V0U3R5bGVzID0gZnVuY3Rpb24oIGVsZW0gKSB7DQoJCXJldHVybiBlbGVtLmN1cnJlbnRTdHlsZTsNCgl9Ow0KDQoJY3VyQ1NTID0gZnVuY3Rpb24oIGVsZW0sIG5hbWUsIF9jb21wdXRlZCApIHsNCgkJdmFyIGxlZnQsIHJzLCByc0xlZnQsDQoJCQljb21wdXRlZCA9IF9jb21wdXRlZCB8fCBnZXRTdHlsZXMoIGVsZW0gKSwNCgkJCXJldCA9IGNvbXB1dGVkID8gY29tcHV0ZWRbIG5hbWUgXSA6IHVuZGVmaW5lZCwNCgkJCXN0eWxlID0gZWxlbS5zdHlsZTsNCg0KCQkvLyBBdm9pZCBzZXR0aW5nIHJldCB0byBlbXB0eSBzdHJpbmcgaGVyZQ0KCQkvLyBzbyB3ZSBkb24ndCBkZWZhdWx0IHRvIGF1dG8NCgkJaWYgKCByZXQgPT0gbnVsbCAmJiBzdHlsZSAmJiBzdHlsZVsgbmFtZSBdICkgew0KCQkJcmV0ID0gc3R5bGVbIG5hbWUgXTsNCgkJfQ0KDQoJCS8vIEZyb20gdGhlIGF3ZXNvbWUgaGFjayBieSBEZWFuIEVkd2FyZHMNCgkJLy8gaHR0cDovL2VyaWsuZWFlLm5ldC9hcmNoaXZlcy8yMDA3LzA3LzI3LzE4LjU0LjE1LyNjb21tZW50LTEwMjI5MQ0KDQoJCS8vIElmIHdlJ3JlIG5vdCBkZWFsaW5nIHdpdGggYSByZWd1bGFyIHBpeGVsIG51bWJlcg0KCQkvLyBidXQgYSBudW1iZXIgdGhhdCBoYXMgYSB3ZWlyZCBlbmRpbmcsIHdlIG5lZWQgdG8gY29udmVydCBpdCB0byBwaXhlbHMNCgkJLy8gYnV0IG5vdCBwb3NpdGlvbiBjc3MgYXR0cmlidXRlcywgYXMgdGhvc2UgYXJlIHByb3BvcnRpb25hbCB0byB0aGUgcGFyZW50IGVsZW1lbnQgaW5zdGVhZA0KCQkvLyBhbmQgd2UgY2FuJ3QgbWVhc3VyZSB0aGUgcGFyZW50IGluc3RlYWQgYmVjYXVzZSBpdCBtaWdodCB0cmlnZ2VyIGEgInN0YWNraW5nIGRvbGxzIiBwcm9ibGVtDQoJCWlmICggcm51bW5vbnB4LnRlc3QoIHJldCApICYmICFycG9zaXRpb24udGVzdCggbmFtZSApICkgew0KDQoJCQkvLyBSZW1lbWJlciB0aGUgb3JpZ2luYWwgdmFsdWVzDQoJCQlsZWZ0ID0gc3R5bGUubGVmdDsNCgkJCXJzID0gZWxlbS5ydW50aW1lU3R5bGU7DQoJCQlyc0xlZnQgPSBycyAmJiBycy5sZWZ0Ow0KDQoJCQkvLyBQdXQgaW4gdGhlIG5ldyB2YWx1ZXMgdG8gZ2V0IGEgY29tcHV0ZWQgdmFsdWUgb3V0DQoJCQlpZiAoIHJzTGVmdCApIHsNCgkJCQlycy5sZWZ0ID0gZWxlbS5jdXJyZW50U3R5bGUubGVmdDsNCgkJCX0NCgkJCXN0eWxlLmxlZnQgPSBuYW1lID09PSAiZm9udFNpemUiID8gIjFlbSIgOiByZXQ7DQoJCQlyZXQgPSBzdHlsZS5waXhlbExlZnQgKyAicHgiOw0KDQoJCQkvLyBSZXZlcnQgdGhlIGNoYW5nZWQgdmFsdWVzDQoJCQlzdHlsZS5sZWZ0ID0gbGVmdDsNCgkJCWlmICggcnNMZWZ0ICkgew0KCQkJCXJzLmxlZnQgPSByc0xlZnQ7DQoJCQl9DQoJCX0NCg0KCQlyZXR1cm4gcmV0ID09PSAiIiA/ICJhdXRvIiA6IHJldDsNCgl9Ow0KfQ0KDQpmdW5jdGlvbiBzZXRQb3NpdGl2ZU51bWJlciggZWxlbSwgdmFsdWUsIHN1YnRyYWN0ICkgew0KCXZhciBtYXRjaGVzID0gcm51bXNwbGl0LmV4ZWMoIHZhbHVlICk7DQoJcmV0dXJuIG1hdGNoZXMgPw0KCQkvLyBHdWFyZCBhZ2FpbnN0IHVuZGVmaW5lZCAic3VidHJhY3QiLCBlLmcuLCB3aGVuIHVzZWQgYXMgaW4gY3NzSG9va3MNCgkJTWF0aC5tYXgoIDAsIG1hdGNoZXNbIDEgXSAtICggc3VidHJhY3QgfHwgMCApICkgKyAoIG1hdGNoZXNbIDIgXSB8fCAicHgiICkgOg0KCQl2YWx1ZTsNCn0NCg0KZnVuY3Rpb24gYXVnbWVudFdpZHRoT3JIZWlnaHQoIGVsZW0sIG5hbWUsIGV4dHJhLCBpc0JvcmRlckJveCwgc3R5bGVzICkgew0KCXZhciBpID0gZXh0cmEgPT09ICggaXNCb3JkZXJCb3ggPyAiYm9yZGVyIiA6ICJjb250ZW50IiApID8NCgkJLy8gSWYgd2UgYWxyZWFkeSBoYXZlIHRoZSByaWdodCBtZWFzdXJlbWVudCwgYXZvaWQgYXVnbWVudGF0aW9uDQoJCTQgOg0KCQkvLyBPdGhlcndpc2UgaW5pdGlhbGl6ZSBmb3IgaG9yaXpvbnRhbCBvciB2ZXJ0aWNhbCBwcm9wZXJ0aWVzDQoJCW5hbWUgPT09ICJ3aWR0aCIgPyAxIDogMCwNCg0KCQl2YWwgPSAwOw0KDQoJZm9yICggOyBpIDwgNDsgaSArPSAyICkgew0KCQkvLyBib3RoIGJveCBtb2RlbHMgZXhjbHVkZSBtYXJnaW4sIHNvIGFkZCBpdCBpZiB3ZSB3YW50IGl0DQoJCWlmICggZXh0cmEgPT09ICJtYXJnaW4iICkgew0KCQkJdmFsICs9IGpRdWVyeS5jc3MoIGVsZW0sIGV4dHJhICsgY3NzRXhwYW5kWyBpIF0sIHRydWUsIHN0eWxlcyApOw0KCQl9DQoNCgkJaWYgKCBpc0JvcmRlckJveCApIHsNCgkJCS8vIGJvcmRlci1ib3ggaW5jbHVkZXMgcGFkZGluZywgc28gcmVtb3ZlIGl0IGlmIHdlIHdhbnQgY29udGVudA0KCQkJaWYgKCBleHRyYSA9PT0gImNvbnRlbnQiICkgew0KCQkJCXZhbCAtPSBqUXVlcnkuY3NzKCBlbGVtLCAicGFkZGluZyIgKyBjc3NFeHBhbmRbIGkgXSwgdHJ1ZSwgc3R5bGVzICk7DQoJCQl9DQoNCgkJCS8vIGF0IHRoaXMgcG9pbnQsIGV4dHJhIGlzbid0IGJvcmRlciBub3IgbWFyZ2luLCBzbyByZW1vdmUgYm9yZGVyDQoJCQlpZiAoIGV4dHJhICE9PSAibWFyZ2luIiApIHsNCgkJCQl2YWwgLT0galF1ZXJ5LmNzcyggZWxlbSwgImJvcmRlciIgKyBjc3NFeHBhbmRbIGkgXSArICJXaWR0aCIsIHRydWUsIHN0eWxlcyApOw0KCQkJfQ0KCQl9IGVsc2Ugew0KCQkJLy8gYXQgdGhpcyBwb2ludCwgZXh0cmEgaXNuJ3QgY29udGVudCwgc28gYWRkIHBhZGRpbmcNCgkJCXZhbCArPSBqUXVlcnkuY3NzKCBlbGVtLCAicGFkZGluZyIgKyBjc3NFeHBhbmRbIGkgXSwgdHJ1ZSwgc3R5bGVzICk7DQoNCgkJCS8vIGF0IHRoaXMgcG9pbnQsIGV4dHJhIGlzbid0IGNvbnRlbnQgbm9yIHBhZGRpbmcsIHNvIGFkZCBib3JkZXINCgkJCWlmICggZXh0cmEgIT09ICJwYWRkaW5nIiApIHsNCgkJCQl2YWwgKz0galF1ZXJ5LmNzcyggZWxlbSwgImJvcmRlciIgKyBjc3NFeHBhbmRbIGkgXSArICJXaWR0aCIsIHRydWUsIHN0eWxlcyApOw0KCQkJfQ0KCQl9DQoJfQ0KDQoJcmV0dXJuIHZhbDsNCn0NCg0KZnVuY3Rpb24gZ2V0V2lkdGhPckhlaWdodCggZWxlbSwgbmFtZSwgZXh0cmEgKSB7DQoNCgkvLyBTdGFydCB3aXRoIG9mZnNldCBwcm9wZXJ0eSwgd2hpY2ggaXMgZXF1aXZhbGVudCB0byB0aGUgYm9yZGVyLWJveCB2YWx1ZQ0KCXZhciB2YWx1ZUlzQm9yZGVyQm94ID0gdHJ1ZSwNCgkJdmFsID0gbmFtZSA9PT0gIndpZHRoIiA/IGVsZW0ub2Zmc2V0V2lkdGggOiBlbGVtLm9mZnNldEhlaWdodCwNCgkJc3R5bGVzID0gZ2V0U3R5bGVzKCBlbGVtICksDQoJCWlzQm9yZGVyQm94ID0galF1ZXJ5LnN1cHBvcnQuYm94U2l6aW5nICYmIGpRdWVyeS5jc3MoIGVsZW0sICJib3hTaXppbmciLCBmYWxzZSwgc3R5bGVzICkgPT09ICJib3JkZXItYm94IjsNCg0KCS8vIHNvbWUgbm9uLWh0bWwgZWxlbWVudHMgcmV0dXJuIHVuZGVmaW5lZCBmb3Igb2Zmc2V0V2lkdGgsIHNvIGNoZWNrIGZvciBudWxsL3VuZGVmaW5lZA0KCS8vIHN2ZyAtIGh0dHBzOi8vYnVnemlsbGEubW96aWxsYS5vcmcvc2hvd19idWcuY2dpP2lkPTY0OTI4NQ0KCS8vIE1hdGhNTCAtIGh0dHBzOi8vYnVnemlsbGEubW96aWxsYS5vcmcvc2hvd19idWcuY2dpP2lkPTQ5MTY2OA0KCWlmICggdmFsIDw9IDAgfHwgdmFsID09IG51bGwgKSB7DQoJCS8vIEZhbGwgYmFjayB0byBjb21wdXRlZCB0aGVuIHVuY29tcHV0ZWQgY3NzIGlmIG5lY2Vzc2FyeQ0KCQl2YWwgPSBjdXJDU1MoIGVsZW0sIG5hbWUsIHN0eWxlcyApOw0KCQlpZiAoIHZhbCA8IDAgfHwgdmFsID09IG51bGwgKSB7DQoJCQl2YWwgPSBlbGVtLnN0eWxlWyBuYW1lIF07DQoJCX0NCg0KCQkvLyBDb21wdXRlZCB1bml0IGlzIG5vdCBwaXhlbHMuIFN0b3AgaGVyZSBhbmQgcmV0dXJuLg0KCQlpZiAoIHJudW1ub25weC50ZXN0KHZhbCkgKSB7DQoJCQlyZXR1cm4gdmFsOw0KCQl9DQoNCgkJLy8gd2UgbmVlZCB0aGUgY2hlY2sgZm9yIHN0eWxlIGluIGNhc2UgYSBicm93c2VyIHdoaWNoIHJldHVybnMgdW5yZWxpYWJsZSB2YWx1ZXMNCgkJLy8gZm9yIGdldENvbXB1dGVkU3R5bGUgc2lsZW50bHkgZmFsbHMgYmFjayB0byB0aGUgcmVsaWFibGUgZWxlbS5zdHlsZQ0KCQl2YWx1ZUlzQm9yZGVyQm94ID0gaXNCb3JkZXJCb3ggJiYgKCBqUXVlcnkuc3VwcG9ydC5ib3hTaXppbmdSZWxpYWJsZSB8fCB2YWwgPT09IGVsZW0uc3R5bGVbIG5hbWUgXSApOw0KDQoJCS8vIE5vcm1hbGl6ZSAiIiwgYXV0bywgYW5kIHByZXBhcmUgZm9yIGV4dHJhDQoJCXZhbCA9IHBhcnNlRmxvYXQoIHZhbCApIHx8IDA7DQoJfQ0KDQoJLy8gdXNlIHRoZSBhY3RpdmUgYm94LXNpemluZyBtb2RlbCB0byBhZGQvc3VidHJhY3QgaXJyZWxldmFudCBzdHlsZXMNCglyZXR1cm4gKCB2YWwgKw0KCQlhdWdtZW50V2lkdGhPckhlaWdodCgNCgkJCWVsZW0sDQoJCQluYW1lLA0KCQkJZXh0cmEgfHwgKCBpc0JvcmRlckJveCA/ICJib3JkZXIiIDogImNvbnRlbnQiICksDQoJCQl2YWx1ZUlzQm9yZGVyQm94LA0KCQkJc3R5bGVzDQoJCSkNCgkpICsgInB4IjsNCn0NCg0KLy8gVHJ5IHRvIGRldGVybWluZSB0aGUgZGVmYXVsdCBkaXNwbGF5IHZhbHVlIG9mIGFuIGVsZW1lbnQNCmZ1bmN0aW9uIGNzc19kZWZhdWx0RGlzcGxheSggbm9kZU5hbWUgKSB7DQoJdmFyIGRvYyA9IGRvY3VtZW50LA0KCQlkaXNwbGF5ID0gZWxlbWRpc3BsYXlbIG5vZGVOYW1lIF07DQoNCglpZiAoICFkaXNwbGF5ICkgew0KCQlkaXNwbGF5ID0gYWN0dWFsRGlzcGxheSggbm9kZU5hbWUsIGRvYyApOw0KDQoJCS8vIElmIHRoZSBzaW1wbGUgd2F5IGZhaWxzLCByZWFkIGZyb20gaW5zaWRlIGFuIGlmcmFtZQ0KCQlpZiAoIGRpc3BsYXkgPT09ICJub25lIiB8fCAhZGlzcGxheSApIHsNCgkJCS8vIFVzZSB0aGUgYWxyZWFkeS1jcmVhdGVkIGlmcmFtZSBpZiBwb3NzaWJsZQ0KCQkJaWZyYW1lID0gKCBpZnJhbWUgfHwNCgkJCQlqUXVlcnkoIjxpZnJhbWUgZnJhbWVib3JkZXI9JzAnIHdpZHRoPScwJyBoZWlnaHQ9JzAnLz4iKQ0KCQkJCS5jc3MoICJjc3NUZXh0IiwgImRpc3BsYXk6YmxvY2sgIWltcG9ydGFudCIgKQ0KCQkJKS5hcHBlbmRUbyggZG9jLmRvY3VtZW50RWxlbWVudCApOw0KDQoJCQkvLyBBbHdheXMgd3JpdGUgYSBuZXcgSFRNTCBza2VsZXRvbiBzbyBXZWJraXQgYW5kIEZpcmVmb3ggZG9uJ3QgY2hva2Ugb24gcmV1c2UNCgkJCWRvYyA9ICggaWZyYW1lWzBdLmNvbnRlbnRXaW5kb3cgfHwgaWZyYW1lWzBdLmNvbnRlbnREb2N1bWVudCApLmRvY3VtZW50Ow0KCQkJZG9jLndyaXRlKCI8IWRvY3R5cGUgaHRtbD48aHRtbD48Ym9keT4iKTsNCgkJCWRvYy5jbG9zZSgpOw0KDQoJCQlkaXNwbGF5ID0gYWN0dWFsRGlzcGxheSggbm9kZU5hbWUsIGRvYyApOw0KCQkJaWZyYW1lLmRldGFjaCgpOw0KCQl9DQoNCgkJLy8gU3RvcmUgdGhlIGNvcnJlY3QgZGVmYXVsdCBkaXNwbGF5DQoJCWVsZW1kaXNwbGF5WyBub2RlTmFtZSBdID0gZGlzcGxheTsNCgl9DQoNCglyZXR1cm4gZGlzcGxheTsNCn0NCg0KLy8gQ2FsbGVkIE9OTFkgZnJvbSB3aXRoaW4gY3NzX2RlZmF1bHREaXNwbGF5DQpmdW5jdGlvbiBhY3R1YWxEaXNwbGF5KCBuYW1lLCBkb2MgKSB7DQoJdmFyIGVsZW0gPSBqUXVlcnkoIGRvYy5jcmVhdGVFbGVtZW50KCBuYW1lICkgKS5hcHBlbmRUbyggZG9jLmJvZHkgKSwNCgkJZGlzcGxheSA9IGpRdWVyeS5jc3MoIGVsZW1bMF0sICJkaXNwbGF5IiApOw0KCWVsZW0ucmVtb3ZlKCk7DQoJcmV0dXJuIGRpc3BsYXk7DQp9DQoNCmpRdWVyeS5lYWNoKFsgImhlaWdodCIsICJ3aWR0aCIgXSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7DQoJalF1ZXJ5LmNzc0hvb2tzWyBuYW1lIF0gPSB7DQoJCWdldDogZnVuY3Rpb24oIGVsZW0sIGNvbXB1dGVkLCBleHRyYSApIHsNCgkJCWlmICggY29tcHV0ZWQgKSB7DQoJCQkJLy8gY2VydGFpbiBlbGVtZW50cyBjYW4gaGF2ZSBkaW1lbnNpb24gaW5mbyBpZiB3ZSBpbnZpc2libHkgc2hvdyB0aGVtDQoJCQkJLy8gaG93ZXZlciwgaXQgbXVzdCBoYXZlIGEgY3VycmVudCBkaXNwbGF5IHN0eWxlIHRoYXQgd291bGQgYmVuZWZpdCBmcm9tIHRoaXMNCgkJCQlyZXR1cm4gZWxlbS5vZmZzZXRXaWR0aCA9PT0gMCAmJiByZGlzcGxheXN3YXAudGVzdCggalF1ZXJ5LmNzcyggZWxlbSwgImRpc3BsYXkiICkgKSA/DQoJCQkJCWpRdWVyeS5zd2FwKCBlbGVtLCBjc3NTaG93LCBmdW5jdGlvbigpIHsNCgkJCQkJCXJldHVybiBnZXRXaWR0aE9ySGVpZ2h0KCBlbGVtLCBuYW1lLCBleHRyYSApOw0KCQkJCQl9KSA6DQoJCQkJCWdldFdpZHRoT3JIZWlnaHQoIGVsZW0sIG5hbWUsIGV4dHJhICk7DQoJCQl9DQoJCX0sDQoNCgkJc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUsIGV4dHJhICkgew0KCQkJdmFyIHN0eWxlcyA9IGV4dHJhICYmIGdldFN0eWxlcyggZWxlbSApOw0KCQkJcmV0dXJuIHNldFBvc2l0aXZlTnVtYmVyKCBlbGVtLCB2YWx1ZSwgZXh0cmEgPw0KCQkJCWF1Z21lbnRXaWR0aE9ySGVpZ2h0KA0KCQkJCQllbGVtLA0KCQkJCQluYW1lLA0KCQkJCQlleHRyYSwNCgkJCQkJalF1ZXJ5LnN1cHBvcnQuYm94U2l6aW5nICYmIGpRdWVyeS5jc3MoIGVsZW0sICJib3hTaXppbmciLCBmYWxzZSwgc3R5bGVzICkgPT09ICJib3JkZXItYm94IiwNCgkJCQkJc3R5bGVzDQoJCQkJKSA6IDANCgkJCSk7DQoJCX0NCgl9Ow0KfSk7DQoNCmlmICggIWpRdWVyeS5zdXBwb3J0Lm9wYWNpdHkgKSB7DQoJalF1ZXJ5LmNzc0hvb2tzLm9wYWNpdHkgPSB7DQoJCWdldDogZnVuY3Rpb24oIGVsZW0sIGNvbXB1dGVkICkgew0KCQkJLy8gSUUgdXNlcyBmaWx0ZXJzIGZvciBvcGFjaXR5DQoJCQlyZXR1cm4gcm9wYWNpdHkudGVzdCggKGNvbXB1dGVkICYmIGVsZW0uY3VycmVudFN0eWxlID8gZWxlbS5jdXJyZW50U3R5bGUuZmlsdGVyIDogZWxlbS5zdHlsZS5maWx0ZXIpIHx8ICIiICkgPw0KCQkJCSggMC4wMSAqIHBhcnNlRmxvYXQoIFJlZ0V4cC4kMSApICkgKyAiIiA6DQoJCQkJY29tcHV0ZWQgPyAiMSIgOiAiIjsNCgkJfSwNCg0KCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsNCgkJCXZhciBzdHlsZSA9IGVsZW0uc3R5bGUsDQoJCQkJY3VycmVudFN0eWxlID0gZWxlbS5jdXJyZW50U3R5bGUsDQoJCQkJb3BhY2l0eSA9IGpRdWVyeS5pc051bWVyaWMoIHZhbHVlICkgPyAiYWxwaGEob3BhY2l0eT0iICsgdmFsdWUgKiAxMDAgKyAiKSIgOiAiIiwNCgkJCQlmaWx0ZXIgPSBjdXJyZW50U3R5bGUgJiYgY3VycmVudFN0eWxlLmZpbHRlciB8fCBzdHlsZS5maWx0ZXIgfHwgIiI7DQoNCgkJCS8vIElFIGhhcyB0cm91YmxlIHdpdGggb3BhY2l0eSBpZiBpdCBkb2VzIG5vdCBoYXZlIGxheW91dA0KCQkJLy8gRm9yY2UgaXQgYnkgc2V0dGluZyB0aGUgem9vbSBsZXZlbA0KCQkJc3R5bGUuem9vbSA9IDE7DQoNCgkJCS8vIGlmIHNldHRpbmcgb3BhY2l0eSB0byAxLCBhbmQgbm8gb3RoZXIgZmlsdGVycyBleGlzdCAtIGF0dGVtcHQgdG8gcmVtb3ZlIGZpbHRlciBhdHRyaWJ1dGUgIzY2NTINCgkJCS8vIGlmIHZhbHVlID09PSAiIiwgdGhlbiByZW1vdmUgaW5saW5lIG9wYWNpdHkgIzEyNjg1DQoJCQlpZiAoICggdmFsdWUgPj0gMSB8fCB2YWx1ZSA9PT0gIiIgKSAmJg0KCQkJCQlqUXVlcnkudHJpbSggZmlsdGVyLnJlcGxhY2UoIHJhbHBoYSwgIiIgKSApID09PSAiIiAmJg0KCQkJCQlzdHlsZS5yZW1vdmVBdHRyaWJ1dGUgKSB7DQoNCgkJCQkvLyBTZXR0aW5nIHN0eWxlLmZpbHRlciB0byBudWxsLCAiIiAmICIgIiBzdGlsbCBsZWF2ZSAiZmlsdGVyOiIgaW4gdGhlIGNzc1RleHQNCgkJCQkvLyBpZiAiZmlsdGVyOiIgaXMgcHJlc2VudCBhdCBhbGwsIGNsZWFyVHlwZSBpcyBkaXNhYmxlZCwgd2Ugd2FudCB0byBhdm9pZCB0aGlzDQoJCQkJLy8gc3R5bGUucmVtb3ZlQXR0cmlidXRlIGlzIElFIE9ubHksIGJ1dCBzbyBhcHBhcmVudGx5IGlzIHRoaXMgY29kZSBwYXRoLi4uDQoJCQkJc3R5bGUucmVtb3ZlQXR0cmlidXRlKCAiZmlsdGVyIiApOw0KDQoJCQkJLy8gaWYgdGhlcmUgaXMgbm8gZmlsdGVyIHN0eWxlIGFwcGxpZWQgaW4gYSBjc3MgcnVsZSBvciB1bnNldCBpbmxpbmUgb3BhY2l0eSwgd2UgYXJlIGRvbmUNCgkJCQlpZiAoIHZhbHVlID09PSAiIiB8fCBjdXJyZW50U3R5bGUgJiYgIWN1cnJlbnRTdHlsZS5maWx0ZXIgKSB7DQoJCQkJCXJldHVybjsNCgkJCQl9DQoJCQl9DQoNCgkJCS8vIG90aGVyd2lzZSwgc2V0IG5ldyBmaWx0ZXIgdmFsdWVzDQoJCQlzdHlsZS5maWx0ZXIgPSByYWxwaGEudGVzdCggZmlsdGVyICkgPw0KCQkJCWZpbHRlci5yZXBsYWNlKCByYWxwaGEsIG9wYWNpdHkgKSA6DQoJCQkJZmlsdGVyICsgIiAiICsgb3BhY2l0eTsNCgkJfQ0KCX07DQp9DQoNCi8vIFRoZXNlIGhvb2tzIGNhbm5vdCBiZSBhZGRlZCB1bnRpbCBET00gcmVhZHkgYmVjYXVzZSB0aGUgc3VwcG9ydCB0ZXN0DQovLyBmb3IgaXQgaXMgbm90IHJ1biB1bnRpbCBhZnRlciBET00gcmVhZHkNCmpRdWVyeShmdW5jdGlvbigpIHsNCglpZiAoICFqUXVlcnkuc3VwcG9ydC5yZWxpYWJsZU1hcmdpblJpZ2h0ICkgew0KCQlqUXVlcnkuY3NzSG9va3MubWFyZ2luUmlnaHQgPSB7DQoJCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtLCBjb21wdXRlZCApIHsNCgkJCQlpZiAoIGNvbXB1dGVkICkgew0KCQkJCQkvLyBXZWJLaXQgQnVnIDEzMzQzIC0gZ2V0Q29tcHV0ZWRTdHlsZSByZXR1cm5zIHdyb25nIHZhbHVlIGZvciBtYXJnaW4tcmlnaHQNCgkJCQkJLy8gV29yayBhcm91bmQgYnkgdGVtcG9yYXJpbHkgc2V0dGluZyBlbGVtZW50IGRpc3BsYXkgdG8gaW5saW5lLWJsb2NrDQoJCQkJCXJldHVybiBqUXVlcnkuc3dhcCggZWxlbSwgeyAiZGlzcGxheSI6ICJpbmxpbmUtYmxvY2siIH0sDQoJCQkJCQljdXJDU1MsIFsgZWxlbSwgIm1hcmdpblJpZ2h0IiBdICk7DQoJCQkJfQ0KCQkJfQ0KCQl9Ow0KCX0NCg0KCS8vIFdlYmtpdCBidWc6IGh0dHBzOi8vYnVncy53ZWJraXQub3JnL3Nob3dfYnVnLmNnaT9pZD0yOTA4NA0KCS8vIGdldENvbXB1dGVkU3R5bGUgcmV0dXJucyBwZXJjZW50IHdoZW4gc3BlY2lmaWVkIGZvciB0b3AvbGVmdC9ib3R0b20vcmlnaHQNCgkvLyByYXRoZXIgdGhhbiBtYWtlIHRoZSBjc3MgbW9kdWxlIGRlcGVuZCBvbiB0aGUgb2Zmc2V0IG1vZHVsZSwgd2UganVzdCBjaGVjayBmb3IgaXQgaGVyZQ0KCWlmICggIWpRdWVyeS5zdXBwb3J0LnBpeGVsUG9zaXRpb24gJiYgalF1ZXJ5LmZuLnBvc2l0aW9uICkgew0KCQlqUXVlcnkuZWFjaCggWyAidG9wIiwgImxlZnQiIF0sIGZ1bmN0aW9uKCBpLCBwcm9wICkgew0KCQkJalF1ZXJ5LmNzc0hvb2tzWyBwcm9wIF0gPSB7DQoJCQkJZ2V0OiBmdW5jdGlvbiggZWxlbSwgY29tcHV0ZWQgKSB7DQoJCQkJCWlmICggY29tcHV0ZWQgKSB7DQoJCQkJCQljb21wdXRlZCA9IGN1ckNTUyggZWxlbSwgcHJvcCApOw0KCQkJCQkJLy8gaWYgY3VyQ1NTIHJldHVybnMgcGVyY2VudGFnZSwgZmFsbGJhY2sgdG8gb2Zmc2V0DQoJCQkJCQlyZXR1cm4gcm51bW5vbnB4LnRlc3QoIGNvbXB1dGVkICkgPw0KCQkJCQkJCWpRdWVyeSggZWxlbSApLnBvc2l0aW9uKClbIHByb3AgXSArICJweCIgOg0KCQkJCQkJCWNvbXB1dGVkOw0KCQkJCQl9DQoJCQkJfQ0KCQkJfTsNCgkJfSk7DQoJfQ0KDQp9KTsNCg0KaWYgKCBqUXVlcnkuZXhwciAmJiBqUXVlcnkuZXhwci5maWx0ZXJzICkgew0KCWpRdWVyeS5leHByLmZpbHRlcnMuaGlkZGVuID0gZnVuY3Rpb24oIGVsZW0gKSB7DQoJCS8vIFN1cHBvcnQ6IE9wZXJhIDw9IDEyLjEyDQoJCS8vIE9wZXJhIHJlcG9ydHMgb2Zmc2V0V2lkdGhzIGFuZCBvZmZzZXRIZWlnaHRzIGxlc3MgdGhhbiB6ZXJvIG9uIHNvbWUgZWxlbWVudHMNCgkJcmV0dXJuIGVsZW0ub2Zmc2V0V2lkdGggPD0gMCAmJiBlbGVtLm9mZnNldEhlaWdodCA8PSAwIHx8DQoJCQkoIWpRdWVyeS5zdXBwb3J0LnJlbGlhYmxlSGlkZGVuT2Zmc2V0cyAmJiAoKGVsZW0uc3R5bGUgJiYgZWxlbS5zdHlsZS5kaXNwbGF5KSB8fCBqUXVlcnkuY3NzKCBlbGVtLCAiZGlzcGxheSIgKSkgPT09ICJub25lIik7DQoJfTsNCg0KCWpRdWVyeS5leHByLmZpbHRlcnMudmlzaWJsZSA9IGZ1bmN0aW9uKCBlbGVtICkgew0KCQlyZXR1cm4gIWpRdWVyeS5leHByLmZpbHRlcnMuaGlkZGVuKCBlbGVtICk7DQoJfTsNCn0NCg0KLy8gVGhlc2UgaG9va3MgYXJlIHVzZWQgYnkgYW5pbWF0ZSB0byBleHBhbmQgcHJvcGVydGllcw0KalF1ZXJ5LmVhY2goew0KCW1hcmdpbjogIiIsDQoJcGFkZGluZzogIiIsDQoJYm9yZGVyOiAiV2lkdGgiDQp9LCBmdW5jdGlvbiggcHJlZml4LCBzdWZmaXggKSB7DQoJalF1ZXJ5LmNzc0hvb2tzWyBwcmVmaXggKyBzdWZmaXggXSA9IHsNCgkJZXhwYW5kOiBmdW5jdGlvbiggdmFsdWUgKSB7DQoJCQl2YXIgaSA9IDAsDQoJCQkJZXhwYW5kZWQgPSB7fSwNCg0KCQkJCS8vIGFzc3VtZXMgYSBzaW5nbGUgbnVtYmVyIGlmIG5vdCBhIHN0cmluZw0KCQkJCXBhcnRzID0gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiA/IHZhbHVlLnNwbGl0KCIgIikgOiBbIHZhbHVlIF07DQoNCgkJCWZvciAoIDsgaSA8IDQ7IGkrKyApIHsNCgkJCQlleHBhbmRlZFsgcHJlZml4ICsgY3NzRXhwYW5kWyBpIF0gKyBzdWZmaXggXSA9DQoJCQkJCXBhcnRzWyBpIF0gfHwgcGFydHNbIGkgLSAyIF0gfHwgcGFydHNbIDAgXTsNCgkJCX0NCg0KCQkJcmV0dXJuIGV4cGFuZGVkOw0KCQl9DQoJfTsNCg0KCWlmICggIXJtYXJnaW4udGVzdCggcHJlZml4ICkgKSB7DQoJCWpRdWVyeS5jc3NIb29rc1sgcHJlZml4ICsgc3VmZml4IF0uc2V0ID0gc2V0UG9zaXRpdmVOdW1iZXI7DQoJfQ0KfSk7DQp2YXIgcjIwID0gLyUyMC9nLA0KCXJicmFja2V0ID0gL1xbXF0kLywNCglyQ1JMRiA9IC9ccj9cbi9nLA0KCXJzdWJtaXR0ZXJUeXBlcyA9IC9eKD86c3VibWl0fGJ1dHRvbnxpbWFnZXxyZXNldHxmaWxlKSQvaSwNCglyc3VibWl0dGFibGUgPSAvXig/OmlucHV0fHNlbGVjdHx0ZXh0YXJlYXxrZXlnZW4pL2k7DQoNCmpRdWVyeS5mbi5leHRlbmQoew0KCXNlcmlhbGl6ZTogZnVuY3Rpb24oKSB7DQoJCXJldHVybiBqUXVlcnkucGFyYW0oIHRoaXMuc2VyaWFsaXplQXJyYXkoKSApOw0KCX0sDQoJc2VyaWFsaXplQXJyYXk6IGZ1bmN0aW9uKCkgew0KCQlyZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24oKXsNCgkJCS8vIENhbiBhZGQgcHJvcEhvb2sgZm9yICJlbGVtZW50cyIgdG8gZmlsdGVyIG9yIGFkZCBmb3JtIGVsZW1lbnRzDQoJCQl2YXIgZWxlbWVudHMgPSBqUXVlcnkucHJvcCggdGhpcywgImVsZW1lbnRzIiApOw0KCQkJcmV0dXJuIGVsZW1lbnRzID8galF1ZXJ5Lm1ha2VBcnJheSggZWxlbWVudHMgKSA6IHRoaXM7DQoJCX0pDQoJCS5maWx0ZXIoZnVuY3Rpb24oKXsNCgkJCXZhciB0eXBlID0gdGhpcy50eXBlOw0KCQkJLy8gVXNlIC5pcygiOmRpc2FibGVkIikgc28gdGhhdCBmaWVsZHNldFtkaXNhYmxlZF0gd29ya3MNCgkJCXJldHVybiB0aGlzLm5hbWUgJiYgIWpRdWVyeSggdGhpcyApLmlzKCAiOmRpc2FibGVkIiApICYmDQoJCQkJcnN1Ym1pdHRhYmxlLnRlc3QoIHRoaXMubm9kZU5hbWUgKSAmJiAhcnN1Ym1pdHRlclR5cGVzLnRlc3QoIHR5cGUgKSAmJg0KCQkJCSggdGhpcy5jaGVja2VkIHx8ICFtYW5pcHVsYXRpb25fcmNoZWNrYWJsZVR5cGUudGVzdCggdHlwZSApICk7DQoJCX0pDQoJCS5tYXAoZnVuY3Rpb24oIGksIGVsZW0gKXsNCgkJCXZhciB2YWwgPSBqUXVlcnkoIHRoaXMgKS52YWwoKTsNCg0KCQkJcmV0dXJuIHZhbCA9PSBudWxsID8NCgkJCQludWxsIDoNCgkJCQlqUXVlcnkuaXNBcnJheSggdmFsICkgPw0KCQkJCQlqUXVlcnkubWFwKCB2YWwsIGZ1bmN0aW9uKCB2YWwgKXsNCgkJCQkJCXJldHVybiB7IG5hbWU6IGVsZW0ubmFtZSwgdmFsdWU6IHZhbC5yZXBsYWNlKCByQ1JMRiwgIlxyXG4iICkgfTsNCgkJCQkJfSkgOg0KCQkJCQl7IG5hbWU6IGVsZW0ubmFtZSwgdmFsdWU6IHZhbC5yZXBsYWNlKCByQ1JMRiwgIlxyXG4iICkgfTsNCgkJfSkuZ2V0KCk7DQoJfQ0KfSk7DQoNCi8vU2VyaWFsaXplIGFuIGFycmF5IG9mIGZvcm0gZWxlbWVudHMgb3IgYSBzZXQgb2YNCi8va2V5L3ZhbHVlcyBpbnRvIGEgcXVlcnkgc3RyaW5nDQpqUXVlcnkucGFyYW0gPSBmdW5jdGlvbiggYSwgdHJhZGl0aW9uYWwgKSB7DQoJdmFyIHByZWZpeCwNCgkJcyA9IFtdLA0KCQlhZGQgPSBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsNCgkJCS8vIElmIHZhbHVlIGlzIGEgZnVuY3Rpb24sIGludm9rZSBpdCBhbmQgcmV0dXJuIGl0cyB2YWx1ZQ0KCQkJdmFsdWUgPSBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKSA/IHZhbHVlKCkgOiAoIHZhbHVlID09IG51bGwgPyAiIiA6IHZhbHVlICk7DQoJCQlzWyBzLmxlbmd0aCBdID0gZW5jb2RlVVJJQ29tcG9uZW50KCBrZXkgKSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudCggdmFsdWUgKTsNCgkJfTsNCg0KCS8vIFNldCB0cmFkaXRpb25hbCB0byB0cnVlIGZvciBqUXVlcnkgPD0gMS4zLjIgYmVoYXZpb3IuDQoJaWYgKCB0cmFkaXRpb25hbCA9PT0gdW5kZWZpbmVkICkgew0KCQl0cmFkaXRpb25hbCA9IGpRdWVyeS5hamF4U2V0dGluZ3MgJiYgalF1ZXJ5LmFqYXhTZXR0aW5ncy50cmFkaXRpb25hbDsNCgl9DQoNCgkvLyBJZiBhbiBhcnJheSB3YXMgcGFzc2VkIGluLCBhc3N1bWUgdGhhdCBpdCBpcyBhbiBhcnJheSBvZiBmb3JtIGVsZW1lbnRzLg0KCWlmICggalF1ZXJ5LmlzQXJyYXkoIGEgKSB8fCAoIGEuanF1ZXJ5ICYmICFqUXVlcnkuaXNQbGFpbk9iamVjdCggYSApICkgKSB7DQoJCS8vIFNlcmlhbGl6ZSB0aGUgZm9ybSBlbGVtZW50cw0KCQlqUXVlcnkuZWFjaCggYSwgZnVuY3Rpb24oKSB7DQoJCQlhZGQoIHRoaXMubmFtZSwgdGhpcy52YWx1ZSApOw0KCQl9KTsNCg0KCX0gZWxzZSB7DQoJCS8vIElmIHRyYWRpdGlvbmFsLCBlbmNvZGUgdGhlICJvbGQiIHdheSAodGhlIHdheSAxLjMuMiBvciBvbGRlcg0KCQkvLyBkaWQgaXQpLCBvdGhlcndpc2UgZW5jb2RlIHBhcmFtcyByZWN1cnNpdmVseS4NCgkJZm9yICggcHJlZml4IGluIGEgKSB7DQoJCQlidWlsZFBhcmFtcyggcHJlZml4LCBhWyBwcmVmaXggXSwgdHJhZGl0aW9uYWwsIGFkZCApOw0KCQl9DQoJfQ0KDQoJLy8gUmV0dXJuIHRoZSByZXN1bHRpbmcgc2VyaWFsaXphdGlvbg0KCXJldHVybiBzLmpvaW4oICImIiApLnJlcGxhY2UoIHIyMCwgIisiICk7DQp9Ow0KDQpmdW5jdGlvbiBidWlsZFBhcmFtcyggcHJlZml4LCBvYmosIHRyYWRpdGlvbmFsLCBhZGQgKSB7DQoJdmFyIG5hbWU7DQoNCglpZiAoIGpRdWVyeS5pc0FycmF5KCBvYmogKSApIHsNCgkJLy8gU2VyaWFsaXplIGFycmF5IGl0ZW0uDQoJCWpRdWVyeS5lYWNoKCBvYmosIGZ1bmN0aW9uKCBpLCB2ICkgew0KCQkJaWYgKCB0cmFkaXRpb25hbCB8fCByYnJhY2tldC50ZXN0KCBwcmVmaXggKSApIHsNCgkJCQkvLyBUcmVhdCBlYWNoIGFycmF5IGl0ZW0gYXMgYSBzY2FsYXIuDQoJCQkJYWRkKCBwcmVmaXgsIHYgKTsNCg0KCQkJfSBlbHNlIHsNCgkJCQkvLyBJdGVtIGlzIG5vbi1zY2FsYXIgKGFycmF5IG9yIG9iamVjdCksIGVuY29kZSBpdHMgbnVtZXJpYyBpbmRleC4NCgkJCQlidWlsZFBhcmFtcyggcHJlZml4ICsgIlsiICsgKCB0eXBlb2YgdiA9PT0gIm9iamVjdCIgPyBpIDogIiIgKSArICJdIiwgdiwgdHJhZGl0aW9uYWwsIGFkZCApOw0KCQkJfQ0KCQl9KTsNCg0KCX0gZWxzZSBpZiAoICF0cmFkaXRpb25hbCAmJiBqUXVlcnkudHlwZSggb2JqICkgPT09ICJvYmplY3QiICkgew0KCQkvLyBTZXJpYWxpemUgb2JqZWN0IGl0ZW0uDQoJCWZvciAoIG5hbWUgaW4gb2JqICkgew0KCQkJYnVpbGRQYXJhbXMoIHByZWZpeCArICJbIiArIG5hbWUgKyAiXSIsIG9ialsgbmFtZSBdLCB0cmFkaXRpb25hbCwgYWRkICk7DQoJCX0NCg0KCX0gZWxzZSB7DQoJCS8vIFNlcmlhbGl6ZSBzY2FsYXIgaXRlbS4NCgkJYWRkKCBwcmVmaXgsIG9iaiApOw0KCX0NCn0NCmpRdWVyeS5lYWNoKCAoImJsdXIgZm9jdXMgZm9jdXNpbiBmb2N1c291dCBsb2FkIHJlc2l6ZSBzY3JvbGwgdW5sb2FkIGNsaWNrIGRibGNsaWNrICIgKw0KCSJtb3VzZWRvd24gbW91c2V1cCBtb3VzZW1vdmUgbW91c2VvdmVyIG1vdXNlb3V0IG1vdXNlZW50ZXIgbW91c2VsZWF2ZSAiICsNCgkiY2hhbmdlIHNlbGVjdCBzdWJtaXQga2V5ZG93biBrZXlwcmVzcyBrZXl1cCBlcnJvciBjb250ZXh0bWVudSIpLnNwbGl0KCIgIiksIGZ1bmN0aW9uKCBpLCBuYW1lICkgew0KDQoJLy8gSGFuZGxlIGV2ZW50IGJpbmRpbmcNCglqUXVlcnkuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBkYXRhLCBmbiApIHsNCgkJcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPiAwID8NCgkJCXRoaXMub24oIG5hbWUsIG51bGwsIGRhdGEsIGZuICkgOg0KCQkJdGhpcy50cmlnZ2VyKCBuYW1lICk7DQoJfTsNCn0pOw0KDQpqUXVlcnkuZm4uZXh0ZW5kKHsNCglob3ZlcjogZnVuY3Rpb24oIGZuT3ZlciwgZm5PdXQgKSB7DQoJCXJldHVybiB0aGlzLm1vdXNlZW50ZXIoIGZuT3ZlciApLm1vdXNlbGVhdmUoIGZuT3V0IHx8IGZuT3ZlciApOw0KCX0sDQoNCgliaW5kOiBmdW5jdGlvbiggdHlwZXMsIGRhdGEsIGZuICkgew0KCQlyZXR1cm4gdGhpcy5vbiggdHlwZXMsIG51bGwsIGRhdGEsIGZuICk7DQoJfSwNCgl1bmJpbmQ6IGZ1bmN0aW9uKCB0eXBlcywgZm4gKSB7DQoJCXJldHVybiB0aGlzLm9mZiggdHlwZXMsIG51bGwsIGZuICk7DQoJfSwNCg0KCWRlbGVnYXRlOiBmdW5jdGlvbiggc2VsZWN0b3IsIHR5cGVzLCBkYXRhLCBmbiApIHsNCgkJcmV0dXJuIHRoaXMub24oIHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4gKTsNCgl9LA0KCXVuZGVsZWdhdGU6IGZ1bmN0aW9uKCBzZWxlY3RvciwgdHlwZXMsIGZuICkgew0KCQkvLyAoIG5hbWVzcGFjZSApIG9yICggc2VsZWN0b3IsIHR5cGVzIFssIGZuXSApDQoJCXJldHVybiBhcmd1bWVudHMubGVuZ3RoID09PSAxID8gdGhpcy5vZmYoIHNlbGVjdG9yLCAiKioiICkgOiB0aGlzLm9mZiggdHlwZXMsIHNlbGVjdG9yIHx8ICIqKiIsIGZuICk7DQoJfQ0KfSk7DQp2YXINCgkvLyBEb2N1bWVudCBsb2NhdGlvbg0KCWFqYXhMb2NQYXJ0cywNCglhamF4TG9jYXRpb24sDQoJYWpheF9ub25jZSA9IGpRdWVyeS5ub3coKSwNCg0KCWFqYXhfcnF1ZXJ5ID0gL1w/LywNCglyaGFzaCA9IC8jLiokLywNCglydHMgPSAvKFs/Jl0pXz1bXiZdKi8sDQoJcmhlYWRlcnMgPSAvXiguKj8pOlsgXHRdKihbXlxyXG5dKilccj8kL21nLCAvLyBJRSBsZWF2ZXMgYW4gXHIgY2hhcmFjdGVyIGF0IEVPTA0KCS8vICM3NjUzLCAjODEyNSwgIzgxNTI6IGxvY2FsIHByb3RvY29sIGRldGVjdGlvbg0KCXJsb2NhbFByb3RvY29sID0gL14oPzphYm91dHxhcHB8YXBwLXN0b3JhZ2V8ListZXh0ZW5zaW9ufGZpbGV8cmVzfHdpZGdldCk6JC8sDQoJcm5vQ29udGVudCA9IC9eKD86R0VUfEhFQUQpJC8sDQoJcnByb3RvY29sID0gL15cL1wvLywNCglydXJsID0gL14oW1x3ListXSs6KSg/OlwvXC8oW15cLz8jOl0qKSg/OjooXGQrKXwpfCkvLA0KDQoJLy8gS2VlcCBhIGNvcHkgb2YgdGhlIG9sZCBsb2FkIG1ldGhvZA0KCV9sb2FkID0galF1ZXJ5LmZuLmxvYWQsDQoNCgkvKiBQcmVmaWx0ZXJzDQoJICogMSkgVGhleSBhcmUgdXNlZnVsIHRvIGludHJvZHVjZSBjdXN0b20gZGF0YVR5cGVzIChzZWUgYWpheC9qc29ucC5qcyBmb3IgYW4gZXhhbXBsZSkNCgkgKiAyKSBUaGVzZSBhcmUgY2FsbGVkOg0KCSAqICAgIC0gQkVGT1JFIGFza2luZyBmb3IgYSB0cmFuc3BvcnQNCgkgKiAgICAtIEFGVEVSIHBhcmFtIHNlcmlhbGl6YXRpb24gKHMuZGF0YSBpcyBhIHN0cmluZyBpZiBzLnByb2Nlc3NEYXRhIGlzIHRydWUpDQoJICogMykga2V5IGlzIHRoZSBkYXRhVHlwZQ0KCSAqIDQpIHRoZSBjYXRjaGFsbCBzeW1ib2wgIioiIGNhbiBiZSB1c2VkDQoJICogNSkgZXhlY3V0aW9uIHdpbGwgc3RhcnQgd2l0aCB0cmFuc3BvcnQgZGF0YVR5cGUgYW5kIFRIRU4gY29udGludWUgZG93biB0byAiKiIgaWYgbmVlZGVkDQoJICovDQoJcHJlZmlsdGVycyA9IHt9LA0KDQoJLyogVHJhbnNwb3J0cyBiaW5kaW5ncw0KCSAqIDEpIGtleSBpcyB0aGUgZGF0YVR5cGUNCgkgKiAyKSB0aGUgY2F0Y2hhbGwgc3ltYm9sICIqIiBjYW4gYmUgdXNlZA0KCSAqIDMpIHNlbGVjdGlvbiB3aWxsIHN0YXJ0IHdpdGggdHJhbnNwb3J0IGRhdGFUeXBlIGFuZCBUSEVOIGdvIHRvICIqIiBpZiBuZWVkZWQNCgkgKi8NCgl0cmFuc3BvcnRzID0ge30sDQoNCgkvLyBBdm9pZCBjb21tZW50LXByb2xvZyBjaGFyIHNlcXVlbmNlICgjMTAwOTgpOyBtdXN0IGFwcGVhc2UgbGludCBhbmQgZXZhZGUgY29tcHJlc3Npb24NCglhbGxUeXBlcyA9ICIqLyIuY29uY2F0KCIqIik7DQoNCi8vICM4MTM4LCBJRSBtYXkgdGhyb3cgYW4gZXhjZXB0aW9uIHdoZW4gYWNjZXNzaW5nDQovLyBhIGZpZWxkIGZyb20gd2luZG93LmxvY2F0aW9uIGlmIGRvY3VtZW50LmRvbWFpbiBoYXMgYmVlbiBzZXQNCnRyeSB7DQoJYWpheExvY2F0aW9uID0gbG9jYXRpb24uaHJlZjsNCn0gY2F0Y2goIGUgKSB7DQoJLy8gVXNlIHRoZSBocmVmIGF0dHJpYnV0ZSBvZiBhbiBBIGVsZW1lbnQNCgkvLyBzaW5jZSBJRSB3aWxsIG1vZGlmeSBpdCBnaXZlbiBkb2N1bWVudC5sb2NhdGlvbg0KCWFqYXhMb2NhdGlvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJhIiApOw0KCWFqYXhMb2NhdGlvbi5ocmVmID0gIiI7DQoJYWpheExvY2F0aW9uID0gYWpheExvY2F0aW9uLmhyZWY7DQp9DQoNCi8vIFNlZ21lbnQgbG9jYXRpb24gaW50byBwYXJ0cw0KYWpheExvY1BhcnRzID0gcnVybC5leGVjKCBhamF4TG9jYXRpb24udG9Mb3dlckNhc2UoKSApIHx8IFtdOw0KDQovLyBCYXNlICJjb25zdHJ1Y3RvciIgZm9yIGpRdWVyeS5hamF4UHJlZmlsdGVyIGFuZCBqUXVlcnkuYWpheFRyYW5zcG9ydA0KZnVuY3Rpb24gYWRkVG9QcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKCBzdHJ1Y3R1cmUgKSB7DQoNCgkvLyBkYXRhVHlwZUV4cHJlc3Npb24gaXMgb3B0aW9uYWwgYW5kIGRlZmF1bHRzIHRvICIqIg0KCXJldHVybiBmdW5jdGlvbiggZGF0YVR5cGVFeHByZXNzaW9uLCBmdW5jICkgew0KDQoJCWlmICggdHlwZW9mIGRhdGFUeXBlRXhwcmVzc2lvbiAhPT0gInN0cmluZyIgKSB7DQoJCQlmdW5jID0gZGF0YVR5cGVFeHByZXNzaW9uOw0KCQkJZGF0YVR5cGVFeHByZXNzaW9uID0gIioiOw0KCQl9DQoNCgkJdmFyIGRhdGFUeXBlLA0KCQkJaSA9IDAsDQoJCQlkYXRhVHlwZXMgPSBkYXRhVHlwZUV4cHJlc3Npb24udG9Mb3dlckNhc2UoKS5tYXRjaCggY29yZV9ybm90d2hpdGUgKSB8fCBbXTsNCg0KCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBmdW5jICkgKSB7DQoJCQkvLyBGb3IgZWFjaCBkYXRhVHlwZSBpbiB0aGUgZGF0YVR5cGVFeHByZXNzaW9uDQoJCQl3aGlsZSAoIChkYXRhVHlwZSA9IGRhdGFUeXBlc1tpKytdKSApIHsNCgkJCQkvLyBQcmVwZW5kIGlmIHJlcXVlc3RlZA0KCQkJCWlmICggZGF0YVR5cGVbMF0gPT09ICIrIiApIHsNCgkJCQkJZGF0YVR5cGUgPSBkYXRhVHlwZS5zbGljZSggMSApIHx8ICIqIjsNCgkJCQkJKHN0cnVjdHVyZVsgZGF0YVR5cGUgXSA9IHN0cnVjdHVyZVsgZGF0YVR5cGUgXSB8fCBbXSkudW5zaGlmdCggZnVuYyApOw0KDQoJCQkJLy8gT3RoZXJ3aXNlIGFwcGVuZA0KCQkJCX0gZWxzZSB7DQoJCQkJCShzdHJ1Y3R1cmVbIGRhdGFUeXBlIF0gPSBzdHJ1Y3R1cmVbIGRhdGFUeXBlIF0gfHwgW10pLnB1c2goIGZ1bmMgKTsNCgkJCQl9DQoJCQl9DQoJCX0NCgl9Ow0KfQ0KDQovLyBCYXNlIGluc3BlY3Rpb24gZnVuY3Rpb24gZm9yIHByZWZpbHRlcnMgYW5kIHRyYW5zcG9ydHMNCmZ1bmN0aW9uIGluc3BlY3RQcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKCBzdHJ1Y3R1cmUsIG9wdGlvbnMsIG9yaWdpbmFsT3B0aW9ucywganFYSFIgKSB7DQoNCgl2YXIgaW5zcGVjdGVkID0ge30sDQoJCXNlZWtpbmdUcmFuc3BvcnQgPSAoIHN0cnVjdHVyZSA9PT0gdHJhbnNwb3J0cyApOw0KDQoJZnVuY3Rpb24gaW5zcGVjdCggZGF0YVR5cGUgKSB7DQoJCXZhciBzZWxlY3RlZDsNCgkJaW5zcGVjdGVkWyBkYXRhVHlwZSBdID0gdHJ1ZTsNCgkJalF1ZXJ5LmVhY2goIHN0cnVjdHVyZVsgZGF0YVR5cGUgXSB8fCBbXSwgZnVuY3Rpb24oIF8sIHByZWZpbHRlck9yRmFjdG9yeSApIHsNCgkJCXZhciBkYXRhVHlwZU9yVHJhbnNwb3J0ID0gcHJlZmlsdGVyT3JGYWN0b3J5KCBvcHRpb25zLCBvcmlnaW5hbE9wdGlvbnMsIGpxWEhSICk7DQoJCQlpZiggdHlwZW9mIGRhdGFUeXBlT3JUcmFuc3BvcnQgPT09ICJzdHJpbmciICYmICFzZWVraW5nVHJhbnNwb3J0ICYmICFpbnNwZWN0ZWRbIGRhdGFUeXBlT3JUcmFuc3BvcnQgXSApIHsNCgkJCQlvcHRpb25zLmRhdGFUeXBlcy51bnNoaWZ0KCBkYXRhVHlwZU9yVHJhbnNwb3J0ICk7DQoJCQkJaW5zcGVjdCggZGF0YVR5cGVPclRyYW5zcG9ydCApOw0KCQkJCXJldHVybiBmYWxzZTsNCgkJCX0gZWxzZSBpZiAoIHNlZWtpbmdUcmFuc3BvcnQgKSB7DQoJCQkJcmV0dXJuICEoIHNlbGVjdGVkID0gZGF0YVR5cGVPclRyYW5zcG9ydCApOw0KCQkJfQ0KCQl9KTsNCgkJcmV0dXJuIHNlbGVjdGVkOw0KCX0NCg0KCXJldHVybiBpbnNwZWN0KCBvcHRpb25zLmRhdGFUeXBlc1sgMCBdICkgfHwgIWluc3BlY3RlZFsgIioiIF0gJiYgaW5zcGVjdCggIioiICk7DQp9DQoNCi8vIEEgc3BlY2lhbCBleHRlbmQgZm9yIGFqYXggb3B0aW9ucw0KLy8gdGhhdCB0YWtlcyAiZmxhdCIgb3B0aW9ucyAobm90IHRvIGJlIGRlZXAgZXh0ZW5kZWQpDQovLyBGaXhlcyAjOTg4Nw0KZnVuY3Rpb24gYWpheEV4dGVuZCggdGFyZ2V0LCBzcmMgKSB7DQoJdmFyIGRlZXAsIGtleSwNCgkJZmxhdE9wdGlvbnMgPSBqUXVlcnkuYWpheFNldHRpbmdzLmZsYXRPcHRpb25zIHx8IHt9Ow0KDQoJZm9yICgga2V5IGluIHNyYyApIHsNCgkJaWYgKCBzcmNbIGtleSBdICE9PSB1bmRlZmluZWQgKSB7DQoJCQkoIGZsYXRPcHRpb25zWyBrZXkgXSA/IHRhcmdldCA6ICggZGVlcCB8fCAoZGVlcCA9IHt9KSApIClbIGtleSBdID0gc3JjWyBrZXkgXTsNCgkJfQ0KCX0NCglpZiAoIGRlZXAgKSB7DQoJCWpRdWVyeS5leHRlbmQoIHRydWUsIHRhcmdldCwgZGVlcCApOw0KCX0NCg0KCXJldHVybiB0YXJnZXQ7DQp9DQoNCmpRdWVyeS5mbi5sb2FkID0gZnVuY3Rpb24oIHVybCwgcGFyYW1zLCBjYWxsYmFjayApIHsNCglpZiAoIHR5cGVvZiB1cmwgIT09ICJzdHJpbmciICYmIF9sb2FkICkgew0KCQlyZXR1cm4gX2xvYWQuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOw0KCX0NCg0KCXZhciBzZWxlY3RvciwgcmVzcG9uc2UsIHR5cGUsDQoJCXNlbGYgPSB0aGlzLA0KCQlvZmYgPSB1cmwuaW5kZXhPZigiICIpOw0KDQoJaWYgKCBvZmYgPj0gMCApIHsNCgkJc2VsZWN0b3IgPSB1cmwuc2xpY2UoIG9mZiwgdXJsLmxlbmd0aCApOw0KCQl1cmwgPSB1cmwuc2xpY2UoIDAsIG9mZiApOw0KCX0NCg0KCS8vIElmIGl0J3MgYSBmdW5jdGlvbg0KCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHBhcmFtcyApICkgew0KDQoJCS8vIFdlIGFzc3VtZSB0aGF0IGl0J3MgdGhlIGNhbGxiYWNrDQoJCWNhbGxiYWNrID0gcGFyYW1zOw0KCQlwYXJhbXMgPSB1bmRlZmluZWQ7DQoNCgkvLyBPdGhlcndpc2UsIGJ1aWxkIGEgcGFyYW0gc3RyaW5nDQoJfSBlbHNlIGlmICggcGFyYW1zICYmIHR5cGVvZiBwYXJhbXMgPT09ICJvYmplY3QiICkgew0KCQl0eXBlID0gIlBPU1QiOw0KCX0NCg0KCS8vIElmIHdlIGhhdmUgZWxlbWVudHMgdG8gbW9kaWZ5LCBtYWtlIHRoZSByZXF1ZXN0DQoJaWYgKCBzZWxmLmxlbmd0aCA+IDAgKSB7DQoJCWpRdWVyeS5hamF4KHsNCgkJCXVybDogdXJsLA0KDQoJCQkvLyBpZiAidHlwZSIgdmFyaWFibGUgaXMgdW5kZWZpbmVkLCB0aGVuICJHRVQiIG1ldGhvZCB3aWxsIGJlIHVzZWQNCgkJCXR5cGU6IHR5cGUsDQoJCQlkYXRhVHlwZTogImh0bWwiLA0KCQkJZGF0YTogcGFyYW1zDQoJCX0pLmRvbmUoZnVuY3Rpb24oIHJlc3BvbnNlVGV4dCApIHsNCg0KCQkJLy8gU2F2ZSByZXNwb25zZSBmb3IgdXNlIGluIGNvbXBsZXRlIGNhbGxiYWNrDQoJCQlyZXNwb25zZSA9IGFyZ3VtZW50czsNCg0KCQkJc2VsZi5odG1sKCBzZWxlY3RvciA/DQoNCgkJCQkvLyBJZiBhIHNlbGVjdG9yIHdhcyBzcGVjaWZpZWQsIGxvY2F0ZSB0aGUgcmlnaHQgZWxlbWVudHMgaW4gYSBkdW1teSBkaXYNCgkJCQkvLyBFeGNsdWRlIHNjcmlwdHMgdG8gYXZvaWQgSUUgJ1Blcm1pc3Npb24gRGVuaWVkJyBlcnJvcnMNCgkJCQlqUXVlcnkoIjxkaXY+IikuYXBwZW5kKCBqUXVlcnkucGFyc2VIVE1MKCByZXNwb25zZVRleHQgKSApLmZpbmQoIHNlbGVjdG9yICkgOg0KDQoJCQkJLy8gT3RoZXJ3aXNlIHVzZSB0aGUgZnVsbCByZXN1bHQNCgkJCQlyZXNwb25zZVRleHQgKTsNCg0KCQl9KS5jb21wbGV0ZSggY2FsbGJhY2sgJiYgZnVuY3Rpb24oIGpxWEhSLCBzdGF0dXMgKSB7DQoJCQlzZWxmLmVhY2goIGNhbGxiYWNrLCByZXNwb25zZSB8fCBbIGpxWEhSLnJlc3BvbnNlVGV4dCwgc3RhdHVzLCBqcVhIUiBdICk7DQoJCX0pOw0KCX0NCg0KCXJldHVybiB0aGlzOw0KfTsNCg0KLy8gQXR0YWNoIGEgYnVuY2ggb2YgZnVuY3Rpb25zIGZvciBoYW5kbGluZyBjb21tb24gQUpBWCBldmVudHMNCmpRdWVyeS5lYWNoKCBbICJhamF4U3RhcnQiLCAiYWpheFN0b3AiLCAiYWpheENvbXBsZXRlIiwgImFqYXhFcnJvciIsICJhamF4U3VjY2VzcyIsICJhamF4U2VuZCIgXSwgZnVuY3Rpb24oIGksIHR5cGUgKXsNCglqUXVlcnkuZm5bIHR5cGUgXSA9IGZ1bmN0aW9uKCBmbiApew0KCQlyZXR1cm4gdGhpcy5vbiggdHlwZSwgZm4gKTsNCgl9Ow0KfSk7DQoNCmpRdWVyeS5leHRlbmQoew0KDQoJLy8gQ291bnRlciBmb3IgaG9sZGluZyB0aGUgbnVtYmVyIG9mIGFjdGl2ZSBxdWVyaWVzDQoJYWN0aXZlOiAwLA0KDQoJLy8gTGFzdC1Nb2RpZmllZCBoZWFkZXIgY2FjaGUgZm9yIG5leHQgcmVxdWVzdA0KCWxhc3RNb2RpZmllZDoge30sDQoJZXRhZzoge30sDQoNCglhamF4U2V0dGluZ3M6IHsNCgkJdXJsOiBhamF4TG9jYXRpb24sDQoJCXR5cGU6ICJHRVQiLA0KCQlpc0xvY2FsOiBybG9jYWxQcm90b2NvbC50ZXN0KCBhamF4TG9jUGFydHNbIDEgXSApLA0KCQlnbG9iYWw6IHRydWUsDQoJCXByb2Nlc3NEYXRhOiB0cnVlLA0KCQlhc3luYzogdHJ1ZSwNCgkJY29udGVudFR5cGU6ICJhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQ7IGNoYXJzZXQ9VVRGLTgiLA0KCQkvKg0KCQl0aW1lb3V0OiAwLA0KCQlkYXRhOiBudWxsLA0KCQlkYXRhVHlwZTogbnVsbCwNCgkJdXNlcm5hbWU6IG51bGwsDQoJCXBhc3N3b3JkOiBudWxsLA0KCQljYWNoZTogbnVsbCwNCgkJdGhyb3dzOiBmYWxzZSwNCgkJdHJhZGl0aW9uYWw6IGZhbHNlLA0KCQloZWFkZXJzOiB7fSwNCgkJKi8NCg0KCQlhY2NlcHRzOiB7DQoJCQkiKiI6IGFsbFR5cGVzLA0KCQkJdGV4dDogInRleHQvcGxhaW4iLA0KCQkJaHRtbDogInRleHQvaHRtbCIsDQoJCQl4bWw6ICJhcHBsaWNhdGlvbi94bWwsIHRleHQveG1sIiwNCgkJCWpzb246ICJhcHBsaWNhdGlvbi9qc29uLCB0ZXh0L2phdmFzY3JpcHQiDQoJCX0sDQoNCgkJY29udGVudHM6IHsNCgkJCXhtbDogL3htbC8sDQoJCQlodG1sOiAvaHRtbC8sDQoJCQlqc29uOiAvanNvbi8NCgkJfSwNCg0KCQlyZXNwb25zZUZpZWxkczogew0KCQkJeG1sOiAicmVzcG9uc2VYTUwiLA0KCQkJdGV4dDogInJlc3BvbnNlVGV4dCIsDQoJCQlqc29uOiAicmVzcG9uc2VKU09OIg0KCQl9LA0KDQoJCS8vIERhdGEgY29udmVydGVycw0KCQkvLyBLZXlzIHNlcGFyYXRlIHNvdXJjZSAob3IgY2F0Y2hhbGwgIioiKSBhbmQgZGVzdGluYXRpb24gdHlwZXMgd2l0aCBhIHNpbmdsZSBzcGFjZQ0KCQljb252ZXJ0ZXJzOiB7DQoNCgkJCS8vIENvbnZlcnQgYW55dGhpbmcgdG8gdGV4dA0KCQkJIiogdGV4dCI6IFN0cmluZywNCg0KCQkJLy8gVGV4dCB0byBodG1sICh0cnVlID0gbm8gdHJhbnNmb3JtYXRpb24pDQoJCQkidGV4dCBodG1sIjogdHJ1ZSwNCg0KCQkJLy8gRXZhbHVhdGUgdGV4dCBhcyBhIGpzb24gZXhwcmVzc2lvbg0KCQkJInRleHQganNvbiI6IGpRdWVyeS5wYXJzZUpTT04sDQoNCgkJCS8vIFBhcnNlIHRleHQgYXMgeG1sDQoJCQkidGV4dCB4bWwiOiBqUXVlcnkucGFyc2VYTUwNCgkJfSwNCg0KCQkvLyBGb3Igb3B0aW9ucyB0aGF0IHNob3VsZG4ndCBiZSBkZWVwIGV4dGVuZGVkOg0KCQkvLyB5b3UgY2FuIGFkZCB5b3VyIG93biBjdXN0b20gb3B0aW9ucyBoZXJlIGlmDQoJCS8vIGFuZCB3aGVuIHlvdSBjcmVhdGUgb25lIHRoYXQgc2hvdWxkbid0IGJlDQoJCS8vIGRlZXAgZXh0ZW5kZWQgKHNlZSBhamF4RXh0ZW5kKQ0KCQlmbGF0T3B0aW9uczogew0KCQkJdXJsOiB0cnVlLA0KCQkJY29udGV4dDogdHJ1ZQ0KCQl9DQoJfSwNCg0KCS8vIENyZWF0ZXMgYSBmdWxsIGZsZWRnZWQgc2V0dGluZ3Mgb2JqZWN0IGludG8gdGFyZ2V0DQoJLy8gd2l0aCBib3RoIGFqYXhTZXR0aW5ncyBhbmQgc2V0dGluZ3MgZmllbGRzLg0KCS8vIElmIHRhcmdldCBpcyBvbWl0dGVkLCB3cml0ZXMgaW50byBhamF4U2V0dGluZ3MuDQoJYWpheFNldHVwOiBmdW5jdGlvbiggdGFyZ2V0LCBzZXR0aW5ncyApIHsNCgkJcmV0dXJuIHNldHRpbmdzID8NCg0KCQkJLy8gQnVpbGRpbmcgYSBzZXR0aW5ncyBvYmplY3QNCgkJCWFqYXhFeHRlbmQoIGFqYXhFeHRlbmQoIHRhcmdldCwgalF1ZXJ5LmFqYXhTZXR0aW5ncyApLCBzZXR0aW5ncyApIDoNCg0KCQkJLy8gRXh0ZW5kaW5nIGFqYXhTZXR0aW5ncw0KCQkJYWpheEV4dGVuZCggalF1ZXJ5LmFqYXhTZXR0aW5ncywgdGFyZ2V0ICk7DQoJfSwNCg0KCWFqYXhQcmVmaWx0ZXI6IGFkZFRvUHJlZmlsdGVyc09yVHJhbnNwb3J0cyggcHJlZmlsdGVycyApLA0KCWFqYXhUcmFuc3BvcnQ6IGFkZFRvUHJlZmlsdGVyc09yVHJhbnNwb3J0cyggdHJhbnNwb3J0cyApLA0KDQoJLy8gTWFpbiBtZXRob2QNCglhamF4OiBmdW5jdGlvbiggdXJsLCBvcHRpb25zICkgew0KDQoJCS8vIElmIHVybCBpcyBhbiBvYmplY3QsIHNpbXVsYXRlIHByZS0xLjUgc2lnbmF0dXJlDQoJCWlmICggdHlwZW9mIHVybCA9PT0gIm9iamVjdCIgKSB7DQoJCQlvcHRpb25zID0gdXJsOw0KCQkJdXJsID0gdW5kZWZpbmVkOw0KCQl9DQoNCgkJLy8gRm9yY2Ugb3B0aW9ucyB0byBiZSBhbiBvYmplY3QNCgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307DQoNCgkJdmFyIC8vIENyb3NzLWRvbWFpbiBkZXRlY3Rpb24gdmFycw0KCQkJcGFydHMsDQoJCQkvLyBMb29wIHZhcmlhYmxlDQoJCQlpLA0KCQkJLy8gVVJMIHdpdGhvdXQgYW50aS1jYWNoZSBwYXJhbQ0KCQkJY2FjaGVVUkwsDQoJCQkvLyBSZXNwb25zZSBoZWFkZXJzIGFzIHN0cmluZw0KCQkJcmVzcG9uc2VIZWFkZXJzU3RyaW5nLA0KCQkJLy8gdGltZW91dCBoYW5kbGUNCgkJCXRpbWVvdXRUaW1lciwNCg0KCQkJLy8gVG8ga25vdyBpZiBnbG9iYWwgZXZlbnRzIGFyZSB0byBiZSBkaXNwYXRjaGVkDQoJCQlmaXJlR2xvYmFscywNCg0KCQkJdHJhbnNwb3J0LA0KCQkJLy8gUmVzcG9uc2UgaGVhZGVycw0KCQkJcmVzcG9uc2VIZWFkZXJzLA0KCQkJLy8gQ3JlYXRlIHRoZSBmaW5hbCBvcHRpb25zIG9iamVjdA0KCQkJcyA9IGpRdWVyeS5hamF4U2V0dXAoIHt9LCBvcHRpb25zICksDQoJCQkvLyBDYWxsYmFja3MgY29udGV4dA0KCQkJY2FsbGJhY2tDb250ZXh0ID0gcy5jb250ZXh0IHx8IHMsDQoJCQkvLyBDb250ZXh0IGZvciBnbG9iYWwgZXZlbnRzIGlzIGNhbGxiYWNrQ29udGV4dCBpZiBpdCBpcyBhIERPTSBub2RlIG9yIGpRdWVyeSBjb2xsZWN0aW9uDQoJCQlnbG9iYWxFdmVudENvbnRleHQgPSBzLmNvbnRleHQgJiYgKCBjYWxsYmFja0NvbnRleHQubm9kZVR5cGUgfHwgY2FsbGJhY2tDb250ZXh0LmpxdWVyeSApID8NCgkJCQlqUXVlcnkoIGNhbGxiYWNrQ29udGV4dCApIDoNCgkJCQlqUXVlcnkuZXZlbnQsDQoJCQkvLyBEZWZlcnJlZHMNCgkJCWRlZmVycmVkID0galF1ZXJ5LkRlZmVycmVkKCksDQoJCQljb21wbGV0ZURlZmVycmVkID0galF1ZXJ5LkNhbGxiYWNrcygib25jZSBtZW1vcnkiKSwNCgkJCS8vIFN0YXR1cy1kZXBlbmRlbnQgY2FsbGJhY2tzDQoJCQlzdGF0dXNDb2RlID0gcy5zdGF0dXNDb2RlIHx8IHt9LA0KCQkJLy8gSGVhZGVycyAodGhleSBhcmUgc2VudCBhbGwgYXQgb25jZSkNCgkJCXJlcXVlc3RIZWFkZXJzID0ge30sDQoJCQlyZXF1ZXN0SGVhZGVyc05hbWVzID0ge30sDQoJCQkvLyBUaGUganFYSFIgc3RhdGUNCgkJCXN0YXRlID0gMCwNCgkJCS8vIERlZmF1bHQgYWJvcnQgbWVzc2FnZQ0KCQkJc3RyQWJvcnQgPSAiY2FuY2VsZWQiLA0KCQkJLy8gRmFrZSB4aHINCgkJCWpxWEhSID0gew0KCQkJCXJlYWR5U3RhdGU6IDAsDQoNCgkJCQkvLyBCdWlsZHMgaGVhZGVycyBoYXNodGFibGUgaWYgbmVlZGVkDQoJCQkJZ2V0UmVzcG9uc2VIZWFkZXI6IGZ1bmN0aW9uKCBrZXkgKSB7DQoJCQkJCXZhciBtYXRjaDsNCgkJCQkJaWYgKCBzdGF0ZSA9PT0gMiApIHsNCgkJCQkJCWlmICggIXJlc3BvbnNlSGVhZGVycyApIHsNCgkJCQkJCQlyZXNwb25zZUhlYWRlcnMgPSB7fTsNCgkJCQkJCQl3aGlsZSAoIChtYXRjaCA9IHJoZWFkZXJzLmV4ZWMoIHJlc3BvbnNlSGVhZGVyc1N0cmluZyApKSApIHsNCgkJCQkJCQkJcmVzcG9uc2VIZWFkZXJzWyBtYXRjaFsxXS50b0xvd2VyQ2FzZSgpIF0gPSBtYXRjaFsgMiBdOw0KCQkJCQkJCX0NCgkJCQkJCX0NCgkJCQkJCW1hdGNoID0gcmVzcG9uc2VIZWFkZXJzWyBrZXkudG9Mb3dlckNhc2UoKSBdOw0KCQkJCQl9DQoJCQkJCXJldHVybiBtYXRjaCA9PSBudWxsID8gbnVsbCA6IG1hdGNoOw0KCQkJCX0sDQoNCgkJCQkvLyBSYXcgc3RyaW5nDQoJCQkJZ2V0QWxsUmVzcG9uc2VIZWFkZXJzOiBmdW5jdGlvbigpIHsNCgkJCQkJcmV0dXJuIHN0YXRlID09PSAyID8gcmVzcG9uc2VIZWFkZXJzU3RyaW5nIDogbnVsbDsNCgkJCQl9LA0KDQoJCQkJLy8gQ2FjaGVzIHRoZSBoZWFkZXINCgkJCQlzZXRSZXF1ZXN0SGVhZGVyOiBmdW5jdGlvbiggbmFtZSwgdmFsdWUgKSB7DQoJCQkJCXZhciBsbmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsNCgkJCQkJaWYgKCAhc3RhdGUgKSB7DQoJCQkJCQluYW1lID0gcmVxdWVzdEhlYWRlcnNOYW1lc1sgbG5hbWUgXSA9IHJlcXVlc3RIZWFkZXJzTmFtZXNbIGxuYW1lIF0gfHwgbmFtZTsNCgkJCQkJCXJlcXVlc3RIZWFkZXJzWyBuYW1lIF0gPSB2YWx1ZTsNCgkJCQkJfQ0KCQkJCQlyZXR1cm4gdGhpczsNCgkJCQl9LA0KDQoJCQkJLy8gT3ZlcnJpZGVzIHJlc3BvbnNlIGNvbnRlbnQtdHlwZSBoZWFkZXINCgkJCQlvdmVycmlkZU1pbWVUeXBlOiBmdW5jdGlvbiggdHlwZSApIHsNCgkJCQkJaWYgKCAhc3RhdGUgKSB7DQoJCQkJCQlzLm1pbWVUeXBlID0gdHlwZTsNCgkJCQkJfQ0KCQkJCQlyZXR1cm4gdGhpczsNCgkJCQl9LA0KDQoJCQkJLy8gU3RhdHVzLWRlcGVuZGVudCBjYWxsYmFja3MNCgkJCQlzdGF0dXNDb2RlOiBmdW5jdGlvbiggbWFwICkgew0KCQkJCQl2YXIgY29kZTsNCgkJCQkJaWYgKCBtYXAgKSB7DQoJCQkJCQlpZiAoIHN0YXRlIDwgMiApIHsNCgkJCQkJCQlmb3IgKCBjb2RlIGluIG1hcCApIHsNCgkJCQkJCQkJLy8gTGF6eS1hZGQgdGhlIG5ldyBjYWxsYmFjayBpbiBhIHdheSB0aGF0IHByZXNlcnZlcyBvbGQgb25lcw0KCQkJCQkJCQlzdGF0dXNDb2RlWyBjb2RlIF0gPSBbIHN0YXR1c0NvZGVbIGNvZGUgXSwgbWFwWyBjb2RlIF0gXTsNCgkJCQkJCQl9DQoJCQkJCQl9IGVsc2Ugew0KCQkJCQkJCS8vIEV4ZWN1dGUgdGhlIGFwcHJvcHJpYXRlIGNhbGxiYWNrcw0KCQkJCQkJCWpxWEhSLmFsd2F5cyggbWFwWyBqcVhIUi5zdGF0dXMgXSApOw0KCQkJCQkJfQ0KCQkJCQl9DQoJCQkJCXJldHVybiB0aGlzOw0KCQkJCX0sDQoNCgkJCQkvLyBDYW5jZWwgdGhlIHJlcXVlc3QNCgkJCQlhYm9ydDogZnVuY3Rpb24oIHN0YXR1c1RleHQgKSB7DQoJCQkJCXZhciBmaW5hbFRleHQgPSBzdGF0dXNUZXh0IHx8IHN0ckFib3J0Ow0KCQkJCQlpZiAoIHRyYW5zcG9ydCApIHsNCgkJCQkJCXRyYW5zcG9ydC5hYm9ydCggZmluYWxUZXh0ICk7DQoJCQkJCX0NCgkJCQkJZG9uZSggMCwgZmluYWxUZXh0ICk7DQoJCQkJCXJldHVybiB0aGlzOw0KCQkJCX0NCgkJCX07DQoNCgkJLy8gQXR0YWNoIGRlZmVycmVkcw0KCQlkZWZlcnJlZC5wcm9taXNlKCBqcVhIUiApLmNvbXBsZXRlID0gY29tcGxldGVEZWZlcnJlZC5hZGQ7DQoJCWpxWEhSLnN1Y2Nlc3MgPSBqcVhIUi5kb25lOw0KCQlqcVhIUi5lcnJvciA9IGpxWEhSLmZhaWw7DQoNCgkJLy8gUmVtb3ZlIGhhc2ggY2hhcmFjdGVyICgjNzUzMTogYW5kIHN0cmluZyBwcm9tb3Rpb24pDQoJCS8vIEFkZCBwcm90b2NvbCBpZiBub3QgcHJvdmlkZWQgKCM1ODY2OiBJRTcgaXNzdWUgd2l0aCBwcm90b2NvbC1sZXNzIHVybHMpDQoJCS8vIEhhbmRsZSBmYWxzeSB1cmwgaW4gdGhlIHNldHRpbmdzIG9iamVjdCAoIzEwMDkzOiBjb25zaXN0ZW5jeSB3aXRoIG9sZCBzaWduYXR1cmUpDQoJCS8vIFdlIGFsc28gdXNlIHRoZSB1cmwgcGFyYW1ldGVyIGlmIGF2YWlsYWJsZQ0KCQlzLnVybCA9ICggKCB1cmwgfHwgcy51cmwgfHwgYWpheExvY2F0aW9uICkgKyAiIiApLnJlcGxhY2UoIHJoYXNoLCAiIiApLnJlcGxhY2UoIHJwcm90b2NvbCwgYWpheExvY1BhcnRzWyAxIF0gKyAiLy8iICk7DQoNCgkJLy8gQWxpYXMgbWV0aG9kIG9wdGlvbiB0byB0eXBlIGFzIHBlciB0aWNrZXQgIzEyMDA0DQoJCXMudHlwZSA9IG9wdGlvbnMubWV0aG9kIHx8IG9wdGlvbnMudHlwZSB8fCBzLm1ldGhvZCB8fCBzLnR5cGU7DQoNCgkJLy8gRXh0cmFjdCBkYXRhVHlwZXMgbGlzdA0KCQlzLmRhdGFUeXBlcyA9IGpRdWVyeS50cmltKCBzLmRhdGFUeXBlIHx8ICIqIiApLnRvTG93ZXJDYXNlKCkubWF0Y2goIGNvcmVfcm5vdHdoaXRlICkgfHwgWyIiXTsNCg0KCQkvLyBBIGNyb3NzLWRvbWFpbiByZXF1ZXN0IGlzIGluIG9yZGVyIHdoZW4gd2UgaGF2ZSBhIHByb3RvY29sOmhvc3Q6cG9ydCBtaXNtYXRjaA0KCQlpZiAoIHMuY3Jvc3NEb21haW4gPT0gbnVsbCApIHsNCgkJCXBhcnRzID0gcnVybC5leGVjKCBzLnVybC50b0xvd2VyQ2FzZSgpICk7DQoJCQlzLmNyb3NzRG9tYWluID0gISEoIHBhcnRzICYmDQoJCQkJKCBwYXJ0c1sgMSBdICE9PSBhamF4TG9jUGFydHNbIDEgXSB8fCBwYXJ0c1sgMiBdICE9PSBhamF4TG9jUGFydHNbIDIgXSB8fA0KCQkJCQkoIHBhcnRzWyAzIF0gfHwgKCBwYXJ0c1sgMSBdID09PSAiaHR0cDoiID8gIjgwIiA6ICI0NDMiICkgKSAhPT0NCgkJCQkJCSggYWpheExvY1BhcnRzWyAzIF0gfHwgKCBhamF4TG9jUGFydHNbIDEgXSA9PT0gImh0dHA6IiA/ICI4MCIgOiAiNDQzIiApICkgKQ0KCQkJKTsNCgkJfQ0KDQoJCS8vIENvbnZlcnQgZGF0YSBpZiBub3QgYWxyZWFkeSBhIHN0cmluZw0KCQlpZiAoIHMuZGF0YSAmJiBzLnByb2Nlc3NEYXRhICYmIHR5cGVvZiBzLmRhdGEgIT09ICJzdHJpbmciICkgew0KCQkJcy5kYXRhID0galF1ZXJ5LnBhcmFtKCBzLmRhdGEsIHMudHJhZGl0aW9uYWwgKTsNCgkJfQ0KDQoJCS8vIEFwcGx5IHByZWZpbHRlcnMNCgkJaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMoIHByZWZpbHRlcnMsIHMsIG9wdGlvbnMsIGpxWEhSICk7DQoNCgkJLy8gSWYgcmVxdWVzdCB3YXMgYWJvcnRlZCBpbnNpZGUgYSBwcmVmaWx0ZXIsIHN0b3AgdGhlcmUNCgkJaWYgKCBzdGF0ZSA9PT0gMiApIHsNCgkJCXJldHVybiBqcVhIUjsNCgkJfQ0KDQoJCS8vIFdlIGNhbiBmaXJlIGdsb2JhbCBldmVudHMgYXMgb2Ygbm93IGlmIGFza2VkIHRvDQoJCWZpcmVHbG9iYWxzID0gcy5nbG9iYWw7DQoNCgkJLy8gV2F0Y2ggZm9yIGEgbmV3IHNldCBvZiByZXF1ZXN0cw0KCQlpZiAoIGZpcmVHbG9iYWxzICYmIGpRdWVyeS5hY3RpdmUrKyA9PT0gMCApIHsNCgkJCWpRdWVyeS5ldmVudC50cmlnZ2VyKCJhamF4U3RhcnQiKTsNCgkJfQ0KDQoJCS8vIFVwcGVyY2FzZSB0aGUgdHlwZQ0KCQlzLnR5cGUgPSBzLnR5cGUudG9VcHBlckNhc2UoKTsNCg0KCQkvLyBEZXRlcm1pbmUgaWYgcmVxdWVzdCBoYXMgY29udGVudA0KCQlzLmhhc0NvbnRlbnQgPSAhcm5vQ29udGVudC50ZXN0KCBzLnR5cGUgKTsNCg0KCQkvLyBTYXZlIHRoZSBVUkwgaW4gY2FzZSB3ZSdyZSB0b3lpbmcgd2l0aCB0aGUgSWYtTW9kaWZpZWQtU2luY2UNCgkJLy8gYW5kL29yIElmLU5vbmUtTWF0Y2ggaGVhZGVyIGxhdGVyIG9uDQoJCWNhY2hlVVJMID0gcy51cmw7DQoNCgkJLy8gTW9yZSBvcHRpb25zIGhhbmRsaW5nIGZvciByZXF1ZXN0cyB3aXRoIG5vIGNvbnRlbnQNCgkJaWYgKCAhcy5oYXNDb250ZW50ICkgew0KDQoJCQkvLyBJZiBkYXRhIGlzIGF2YWlsYWJsZSwgYXBwZW5kIGRhdGEgdG8gdXJsDQoJCQlpZiAoIHMuZGF0YSApIHsNCgkJCQljYWNoZVVSTCA9ICggcy51cmwgKz0gKCBhamF4X3JxdWVyeS50ZXN0KCBjYWNoZVVSTCApID8gIiYiIDogIj8iICkgKyBzLmRhdGEgKTsNCgkJCQkvLyAjOTY4MjogcmVtb3ZlIGRhdGEgc28gdGhhdCBpdCdzIG5vdCB1c2VkIGluIGFuIGV2ZW50dWFsIHJldHJ5DQoJCQkJZGVsZXRlIHMuZGF0YTsNCgkJCX0NCg0KCQkJLy8gQWRkIGFudGktY2FjaGUgaW4gdXJsIGlmIG5lZWRlZA0KCQkJaWYgKCBzLmNhY2hlID09PSBmYWxzZSApIHsNCgkJCQlzLnVybCA9IHJ0cy50ZXN0KCBjYWNoZVVSTCApID8NCg0KCQkJCQkvLyBJZiB0aGVyZSBpcyBhbHJlYWR5IGEgJ18nIHBhcmFtZXRlciwgc2V0IGl0cyB2YWx1ZQ0KCQkJCQljYWNoZVVSTC5yZXBsYWNlKCBydHMsICIkMV89IiArIGFqYXhfbm9uY2UrKyApIDoNCg0KCQkJCQkvLyBPdGhlcndpc2UgYWRkIG9uZSB0byB0aGUgZW5kDQoJCQkJCWNhY2hlVVJMICsgKCBhamF4X3JxdWVyeS50ZXN0KCBjYWNoZVVSTCApID8gIiYiIDogIj8iICkgKyAiXz0iICsgYWpheF9ub25jZSsrOw0KCQkJfQ0KCQl9DQoNCgkJLy8gU2V0IHRoZSBJZi1Nb2RpZmllZC1TaW5jZSBhbmQvb3IgSWYtTm9uZS1NYXRjaCBoZWFkZXIsIGlmIGluIGlmTW9kaWZpZWQgbW9kZS4NCgkJaWYgKCBzLmlmTW9kaWZpZWQgKSB7DQoJCQlpZiAoIGpRdWVyeS5sYXN0TW9kaWZpZWRbIGNhY2hlVVJMIF0gKSB7DQoJCQkJanFYSFIuc2V0UmVxdWVzdEhlYWRlciggIklmLU1vZGlmaWVkLVNpbmNlIiwgalF1ZXJ5Lmxhc3RNb2RpZmllZFsgY2FjaGVVUkwgXSApOw0KCQkJfQ0KCQkJaWYgKCBqUXVlcnkuZXRhZ1sgY2FjaGVVUkwgXSApIHsNCgkJCQlqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKCAiSWYtTm9uZS1NYXRjaCIsIGpRdWVyeS5ldGFnWyBjYWNoZVVSTCBdICk7DQoJCQl9DQoJCX0NCg0KCQkvLyBTZXQgdGhlIGNvcnJlY3QgaGVhZGVyLCBpZiBkYXRhIGlzIGJlaW5nIHNlbnQNCgkJaWYgKCBzLmRhdGEgJiYgcy5oYXNDb250ZW50ICYmIHMuY29udGVudFR5cGUgIT09IGZhbHNlIHx8IG9wdGlvbnMuY29udGVudFR5cGUgKSB7DQoJCQlqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKCAiQ29udGVudC1UeXBlIiwgcy5jb250ZW50VHlwZSApOw0KCQl9DQoNCgkJLy8gU2V0IHRoZSBBY2NlcHRzIGhlYWRlciBmb3IgdGhlIHNlcnZlciwgZGVwZW5kaW5nIG9uIHRoZSBkYXRhVHlwZQ0KCQlqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKA0KCQkJIkFjY2VwdCIsDQoJCQlzLmRhdGFUeXBlc1sgMCBdICYmIHMuYWNjZXB0c1sgcy5kYXRhVHlwZXNbMF0gXSA/DQoJCQkJcy5hY2NlcHRzWyBzLmRhdGFUeXBlc1swXSBdICsgKCBzLmRhdGFUeXBlc1sgMCBdICE9PSAiKiIgPyAiLCAiICsgYWxsVHlwZXMgKyAiOyBxPTAuMDEiIDogIiIgKSA6DQoJCQkJcy5hY2NlcHRzWyAiKiIgXQ0KCQkpOw0KDQoJCS8vIENoZWNrIGZvciBoZWFkZXJzIG9wdGlvbg0KCQlmb3IgKCBpIGluIHMuaGVhZGVycyApIHsNCgkJCWpxWEhSLnNldFJlcXVlc3RIZWFkZXIoIGksIHMuaGVhZGVyc1sgaSBdICk7DQoJCX0NCg0KCQkvLyBBbGxvdyBjdXN0b20gaGVhZGVycy9taW1ldHlwZXMgYW5kIGVhcmx5IGFib3J0DQoJCWlmICggcy5iZWZvcmVTZW5kICYmICggcy5iZWZvcmVTZW5kLmNhbGwoIGNhbGxiYWNrQ29udGV4dCwganFYSFIsIHMgKSA9PT0gZmFsc2UgfHwgc3RhdGUgPT09IDIgKSApIHsNCgkJCS8vIEFib3J0IGlmIG5vdCBkb25lIGFscmVhZHkgYW5kIHJldHVybg0KCQkJcmV0dXJuIGpxWEhSLmFib3J0KCk7DQoJCX0NCg0KCQkvLyBhYm9ydGluZyBpcyBubyBsb25nZXIgYSBjYW5jZWxsYXRpb24NCgkJc3RyQWJvcnQgPSAiYWJvcnQiOw0KDQoJCS8vIEluc3RhbGwgY2FsbGJhY2tzIG9uIGRlZmVycmVkcw0KCQlmb3IgKCBpIGluIHsgc3VjY2VzczogMSwgZXJyb3I6IDEsIGNvbXBsZXRlOiAxIH0gKSB7DQoJCQlqcVhIUlsgaSBdKCBzWyBpIF0gKTsNCgkJfQ0KDQoJCS8vIEdldCB0cmFuc3BvcnQNCgkJdHJhbnNwb3J0ID0gaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMoIHRyYW5zcG9ydHMsIHMsIG9wdGlvbnMsIGpxWEhSICk7DQoNCgkJLy8gSWYgbm8gdHJhbnNwb3J0LCB3ZSBhdXRvLWFib3J0DQoJCWlmICggIXRyYW5zcG9ydCApIHsNCgkJCWRvbmUoIC0xLCAiTm8gVHJhbnNwb3J0IiApOw0KCQl9IGVsc2Ugew0KCQkJanFYSFIucmVhZHlTdGF0ZSA9IDE7DQoNCgkJCS8vIFNlbmQgZ2xvYmFsIGV2ZW50DQoJCQlpZiAoIGZpcmVHbG9iYWxzICkgew0KCQkJCWdsb2JhbEV2ZW50Q29udGV4dC50cmlnZ2VyKCAiYWpheFNlbmQiLCBbIGpxWEhSLCBzIF0gKTsNCgkJCX0NCgkJCS8vIFRpbWVvdXQNCgkJCWlmICggcy5hc3luYyAmJiBzLnRpbWVvdXQgPiAwICkgew0KCQkJCXRpbWVvdXRUaW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7DQoJCQkJCWpxWEhSLmFib3J0KCJ0aW1lb3V0Iik7DQoJCQkJfSwgcy50aW1lb3V0ICk7DQoJCQl9DQoNCgkJCXRyeSB7DQoJCQkJc3RhdGUgPSAxOw0KCQkJCXRyYW5zcG9ydC5zZW5kKCByZXF1ZXN0SGVhZGVycywgZG9uZSApOw0KCQkJfSBjYXRjaCAoIGUgKSB7DQoJCQkJLy8gUHJvcGFnYXRlIGV4Y2VwdGlvbiBhcyBlcnJvciBpZiBub3QgZG9uZQ0KCQkJCWlmICggc3RhdGUgPCAyICkgew0KCQkJCQlkb25lKCAtMSwgZSApOw0KCQkJCS8vIFNpbXBseSByZXRocm93IG90aGVyd2lzZQ0KCQkJCX0gZWxzZSB7DQoJCQkJCXRocm93IGU7DQoJCQkJfQ0KCQkJfQ0KCQl9DQoNCgkJLy8gQ2FsbGJhY2sgZm9yIHdoZW4gZXZlcnl0aGluZyBpcyBkb25lDQoJCWZ1bmN0aW9uIGRvbmUoIHN0YXR1cywgbmF0aXZlU3RhdHVzVGV4dCwgcmVzcG9uc2VzLCBoZWFkZXJzICkgew0KCQkJdmFyIGlzU3VjY2Vzcywgc3VjY2VzcywgZXJyb3IsIHJlc3BvbnNlLCBtb2RpZmllZCwNCgkJCQlzdGF0dXNUZXh0ID0gbmF0aXZlU3RhdHVzVGV4dDsNCg0KCQkJLy8gQ2FsbGVkIG9uY2UNCgkJCWlmICggc3RhdGUgPT09IDIgKSB7DQoJCQkJcmV0dXJuOw0KCQkJfQ0KDQoJCQkvLyBTdGF0ZSBpcyAiZG9uZSIgbm93DQoJCQlzdGF0ZSA9IDI7DQoNCgkJCS8vIENsZWFyIHRpbWVvdXQgaWYgaXQgZXhpc3RzDQoJCQlpZiAoIHRpbWVvdXRUaW1lciApIHsNCgkJCQljbGVhclRpbWVvdXQoIHRpbWVvdXRUaW1lciApOw0KCQkJfQ0KDQoJCQkvLyBEZXJlZmVyZW5jZSB0cmFuc3BvcnQgZm9yIGVhcmx5IGdhcmJhZ2UgY29sbGVjdGlvbg0KCQkJLy8gKG5vIG1hdHRlciBob3cgbG9uZyB0aGUganFYSFIgb2JqZWN0IHdpbGwgYmUgdXNlZCkNCgkJCXRyYW5zcG9ydCA9IHVuZGVmaW5lZDsNCg0KCQkJLy8gQ2FjaGUgcmVzcG9uc2UgaGVhZGVycw0KCQkJcmVzcG9uc2VIZWFkZXJzU3RyaW5nID0gaGVhZGVycyB8fCAiIjsNCg0KCQkJLy8gU2V0IHJlYWR5U3RhdGUNCgkJCWpxWEhSLnJlYWR5U3RhdGUgPSBzdGF0dXMgPiAwID8gNCA6IDA7DQoNCgkJCS8vIERldGVybWluZSBpZiBzdWNjZXNzZnVsDQoJCQlpc1N1Y2Nlc3MgPSBzdGF0dXMgPj0gMjAwICYmIHN0YXR1cyA8IDMwMCB8fCBzdGF0dXMgPT09IDMwNDsNCg0KCQkJLy8gR2V0IHJlc3BvbnNlIGRhdGENCgkJCWlmICggcmVzcG9uc2VzICkgew0KCQkJCXJlc3BvbnNlID0gYWpheEhhbmRsZVJlc3BvbnNlcyggcywganFYSFIsIHJlc3BvbnNlcyApOw0KCQkJfQ0KDQoJCQkvLyBDb252ZXJ0IG5vIG1hdHRlciB3aGF0ICh0aGF0IHdheSByZXNwb25zZVhYWCBmaWVsZHMgYXJlIGFsd2F5cyBzZXQpDQoJCQlyZXNwb25zZSA9IGFqYXhDb252ZXJ0KCBzLCByZXNwb25zZSwganFYSFIsIGlzU3VjY2VzcyApOw0KDQoJCQkvLyBJZiBzdWNjZXNzZnVsLCBoYW5kbGUgdHlwZSBjaGFpbmluZw0KCQkJaWYgKCBpc1N1Y2Nlc3MgKSB7DQoNCgkJCQkvLyBTZXQgdGhlIElmLU1vZGlmaWVkLVNpbmNlIGFuZC9vciBJZi1Ob25lLU1hdGNoIGhlYWRlciwgaWYgaW4gaWZNb2RpZmllZCBtb2RlLg0KCQkJCWlmICggcy5pZk1vZGlmaWVkICkgew0KCQkJCQltb2RpZmllZCA9IGpxWEhSLmdldFJlc3BvbnNlSGVhZGVyKCJMYXN0LU1vZGlmaWVkIik7DQoJCQkJCWlmICggbW9kaWZpZWQgKSB7DQoJCQkJCQlqUXVlcnkubGFzdE1vZGlmaWVkWyBjYWNoZVVSTCBdID0gbW9kaWZpZWQ7DQoJCQkJCX0NCgkJCQkJbW9kaWZpZWQgPSBqcVhIUi5nZXRSZXNwb25zZUhlYWRlcigiZXRhZyIpOw0KCQkJCQlpZiAoIG1vZGlmaWVkICkgew0KCQkJCQkJalF1ZXJ5LmV0YWdbIGNhY2hlVVJMIF0gPSBtb2RpZmllZDsNCgkJCQkJfQ0KCQkJCX0NCg0KCQkJCS8vIGlmIG5vIGNvbnRlbnQNCgkJCQlpZiAoIHN0YXR1cyA9PT0gMjA0IHx8IHMudHlwZSA9PT0gIkhFQUQiICkgew0KCQkJCQlzdGF0dXNUZXh0ID0gIm5vY29udGVudCI7DQoNCgkJCQkvLyBpZiBub3QgbW9kaWZpZWQNCgkJCQl9IGVsc2UgaWYgKCBzdGF0dXMgPT09IDMwNCApIHsNCgkJCQkJc3RhdHVzVGV4dCA9ICJub3Rtb2RpZmllZCI7DQoNCgkJCQkvLyBJZiB3ZSBoYXZlIGRhdGEsIGxldCdzIGNvbnZlcnQgaXQNCgkJCQl9IGVsc2Ugew0KCQkJCQlzdGF0dXNUZXh0ID0gcmVzcG9uc2Uuc3RhdGU7DQoJCQkJCXN1Y2Nlc3MgPSByZXNwb25zZS5kYXRhOw0KCQkJCQllcnJvciA9IHJlc3BvbnNlLmVycm9yOw0KCQkJCQlpc1N1Y2Nlc3MgPSAhZXJyb3I7DQoJCQkJfQ0KCQkJfSBlbHNlIHsNCgkJCQkvLyBXZSBleHRyYWN0IGVycm9yIGZyb20gc3RhdHVzVGV4dA0KCQkJCS8vIHRoZW4gbm9ybWFsaXplIHN0YXR1c1RleHQgYW5kIHN0YXR1cyBmb3Igbm9uLWFib3J0cw0KCQkJCWVycm9yID0gc3RhdHVzVGV4dDsNCgkJCQlpZiAoIHN0YXR1cyB8fCAhc3RhdHVzVGV4dCApIHsNCgkJCQkJc3RhdHVzVGV4dCA9ICJlcnJvciI7DQoJCQkJCWlmICggc3RhdHVzIDwgMCApIHsNCgkJCQkJCXN0YXR1cyA9IDA7DQoJCQkJCX0NCgkJCQl9DQoJCQl9DQoNCgkJCS8vIFNldCBkYXRhIGZvciB0aGUgZmFrZSB4aHIgb2JqZWN0DQoJCQlqcVhIUi5zdGF0dXMgPSBzdGF0dXM7DQoJCQlqcVhIUi5zdGF0dXNUZXh0ID0gKCBuYXRpdmVTdGF0dXNUZXh0IHx8IHN0YXR1c1RleHQgKSArICIiOw0KDQoJCQkvLyBTdWNjZXNzL0Vycm9yDQoJCQlpZiAoIGlzU3VjY2VzcyApIHsNCgkJCQlkZWZlcnJlZC5yZXNvbHZlV2l0aCggY2FsbGJhY2tDb250ZXh0LCBbIHN1Y2Nlc3MsIHN0YXR1c1RleHQsIGpxWEhSIF0gKTsNCgkJCX0gZWxzZSB7DQoJCQkJZGVmZXJyZWQucmVqZWN0V2l0aCggY2FsbGJhY2tDb250ZXh0LCBbIGpxWEhSLCBzdGF0dXNUZXh0LCBlcnJvciBdICk7DQoJCQl9DQoNCgkJCS8vIFN0YXR1cy1kZXBlbmRlbnQgY2FsbGJhY2tzDQoJCQlqcVhIUi5zdGF0dXNDb2RlKCBzdGF0dXNDb2RlICk7DQoJCQlzdGF0dXNDb2RlID0gdW5kZWZpbmVkOw0KDQoJCQlpZiAoIGZpcmVHbG9iYWxzICkgew0KCQkJCWdsb2JhbEV2ZW50Q29udGV4dC50cmlnZ2VyKCBpc1N1Y2Nlc3MgPyAiYWpheFN1Y2Nlc3MiIDogImFqYXhFcnJvciIsDQoJCQkJCVsganFYSFIsIHMsIGlzU3VjY2VzcyA/IHN1Y2Nlc3MgOiBlcnJvciBdICk7DQoJCQl9DQoNCgkJCS8vIENvbXBsZXRlDQoJCQljb21wbGV0ZURlZmVycmVkLmZpcmVXaXRoKCBjYWxsYmFja0NvbnRleHQsIFsganFYSFIsIHN0YXR1c1RleHQgXSApOw0KDQoJCQlpZiAoIGZpcmVHbG9iYWxzICkgew0KCQkJCWdsb2JhbEV2ZW50Q29udGV4dC50cmlnZ2VyKCAiYWpheENvbXBsZXRlIiwgWyBqcVhIUiwgcyBdICk7DQoJCQkJLy8gSGFuZGxlIHRoZSBnbG9iYWwgQUpBWCBjb3VudGVyDQoJCQkJaWYgKCAhKCAtLWpRdWVyeS5hY3RpdmUgKSApIHsNCgkJCQkJalF1ZXJ5LmV2ZW50LnRyaWdnZXIoImFqYXhTdG9wIik7DQoJCQkJfQ0KCQkJfQ0KCQl9DQoNCgkJcmV0dXJuIGpxWEhSOw0KCX0sDQoNCglnZXRKU09OOiBmdW5jdGlvbiggdXJsLCBkYXRhLCBjYWxsYmFjayApIHsNCgkJcmV0dXJuIGpRdWVyeS5nZXQoIHVybCwgZGF0YSwgY2FsbGJhY2ssICJqc29uIiApOw0KCX0sDQoNCglnZXRTY3JpcHQ6IGZ1bmN0aW9uKCB1cmwsIGNhbGxiYWNrICkgew0KCQlyZXR1cm4galF1ZXJ5LmdldCggdXJsLCB1bmRlZmluZWQsIGNhbGxiYWNrLCAic2NyaXB0IiApOw0KCX0NCn0pOw0KDQpqUXVlcnkuZWFjaCggWyAiZ2V0IiwgInBvc3QiIF0sIGZ1bmN0aW9uKCBpLCBtZXRob2QgKSB7DQoJalF1ZXJ5WyBtZXRob2QgXSA9IGZ1bmN0aW9uKCB1cmwsIGRhdGEsIGNhbGxiYWNrLCB0eXBlICkgew0KCQkvLyBzaGlmdCBhcmd1bWVudHMgaWYgZGF0YSBhcmd1bWVudCB3YXMgb21pdHRlZA0KCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBkYXRhICkgKSB7DQoJCQl0eXBlID0gdHlwZSB8fCBjYWxsYmFjazsNCgkJCWNhbGxiYWNrID0gZGF0YTsNCgkJCWRhdGEgPSB1bmRlZmluZWQ7DQoJCX0NCg0KCQlyZXR1cm4galF1ZXJ5LmFqYXgoew0KCQkJdXJsOiB1cmwsDQoJCQl0eXBlOiBtZXRob2QsDQoJCQlkYXRhVHlwZTogdHlwZSwNCgkJCWRhdGE6IGRhdGEsDQoJCQlzdWNjZXNzOiBjYWxsYmFjaw0KCQl9KTsNCgl9Ow0KfSk7DQoNCi8qIEhhbmRsZXMgcmVzcG9uc2VzIHRvIGFuIGFqYXggcmVxdWVzdDoNCiAqIC0gZmluZHMgdGhlIHJpZ2h0IGRhdGFUeXBlIChtZWRpYXRlcyBiZXR3ZWVuIGNvbnRlbnQtdHlwZSBhbmQgZXhwZWN0ZWQgZGF0YVR5cGUpDQogKiAtIHJldHVybnMgdGhlIGNvcnJlc3BvbmRpbmcgcmVzcG9uc2UNCiAqLw0KZnVuY3Rpb24gYWpheEhhbmRsZVJlc3BvbnNlcyggcywganFYSFIsIHJlc3BvbnNlcyApIHsNCgl2YXIgZmlyc3REYXRhVHlwZSwgY3QsIGZpbmFsRGF0YVR5cGUsIHR5cGUsDQoJCWNvbnRlbnRzID0gcy5jb250ZW50cywNCgkJZGF0YVR5cGVzID0gcy5kYXRhVHlwZXM7DQoNCgkvLyBSZW1vdmUgYXV0byBkYXRhVHlwZSBhbmQgZ2V0IGNvbnRlbnQtdHlwZSBpbiB0aGUgcHJvY2Vzcw0KCXdoaWxlKCBkYXRhVHlwZXNbIDAgXSA9PT0gIioiICkgew0KCQlkYXRhVHlwZXMuc2hpZnQoKTsNCgkJaWYgKCBjdCA9PT0gdW5kZWZpbmVkICkgew0KCQkJY3QgPSBzLm1pbWVUeXBlIHx8IGpxWEhSLmdldFJlc3BvbnNlSGVhZGVyKCJDb250ZW50LVR5cGUiKTsNCgkJfQ0KCX0NCg0KCS8vIENoZWNrIGlmIHdlJ3JlIGRlYWxpbmcgd2l0aCBhIGtub3duIGNvbnRlbnQtdHlwZQ0KCWlmICggY3QgKSB7DQoJCWZvciAoIHR5cGUgaW4gY29udGVudHMgKSB7DQoJCQlpZiAoIGNvbnRlbnRzWyB0eXBlIF0gJiYgY29udGVudHNbIHR5cGUgXS50ZXN0KCBjdCApICkgew0KCQkJCWRhdGFUeXBlcy51bnNoaWZ0KCB0eXBlICk7DQoJCQkJYnJlYWs7DQoJCQl9DQoJCX0NCgl9DQoNCgkvLyBDaGVjayB0byBzZWUgaWYgd2UgaGF2ZSBhIHJlc3BvbnNlIGZvciB0aGUgZXhwZWN0ZWQgZGF0YVR5cGUNCglpZiAoIGRhdGFUeXBlc1sgMCBdIGluIHJlc3BvbnNlcyApIHsNCgkJZmluYWxEYXRhVHlwZSA9IGRhdGFUeXBlc1sgMCBdOw0KCX0gZWxzZSB7DQoJCS8vIFRyeSBjb252ZXJ0aWJsZSBkYXRhVHlwZXMNCgkJZm9yICggdHlwZSBpbiByZXNwb25zZXMgKSB7DQoJCQlpZiAoICFkYXRhVHlwZXNbIDAgXSB8fCBzLmNvbnZlcnRlcnNbIHR5cGUgKyAiICIgKyBkYXRhVHlwZXNbMF0gXSApIHsNCgkJCQlmaW5hbERhdGFUeXBlID0gdHlwZTsNCgkJCQlicmVhazsNCgkJCX0NCgkJCWlmICggIWZpcnN0RGF0YVR5cGUgKSB7DQoJCQkJZmlyc3REYXRhVHlwZSA9IHR5cGU7DQoJCQl9DQoJCX0NCgkJLy8gT3IganVzdCB1c2UgZmlyc3Qgb25lDQoJCWZpbmFsRGF0YVR5cGUgPSBmaW5hbERhdGFUeXBlIHx8IGZpcnN0RGF0YVR5cGU7DQoJfQ0KDQoJLy8gSWYgd2UgZm91bmQgYSBkYXRhVHlwZQ0KCS8vIFdlIGFkZCB0aGUgZGF0YVR5cGUgdG8gdGhlIGxpc3QgaWYgbmVlZGVkDQoJLy8gYW5kIHJldHVybiB0aGUgY29ycmVzcG9uZGluZyByZXNwb25zZQ0KCWlmICggZmluYWxEYXRhVHlwZSApIHsNCgkJaWYgKCBmaW5hbERhdGFUeXBlICE9PSBkYXRhVHlwZXNbIDAgXSApIHsNCgkJCWRhdGFUeXBlcy51bnNoaWZ0KCBmaW5hbERhdGFUeXBlICk7DQoJCX0NCgkJcmV0dXJuIHJlc3BvbnNlc1sgZmluYWxEYXRhVHlwZSBdOw0KCX0NCn0NCg0KLyogQ2hhaW4gY29udmVyc2lvbnMgZ2l2ZW4gdGhlIHJlcXVlc3QgYW5kIHRoZSBvcmlnaW5hbCByZXNwb25zZQ0KICogQWxzbyBzZXRzIHRoZSByZXNwb25zZVhYWCBmaWVsZHMgb24gdGhlIGpxWEhSIGluc3RhbmNlDQogKi8NCmZ1bmN0aW9uIGFqYXhDb252ZXJ0KCBzLCByZXNwb25zZSwganFYSFIsIGlzU3VjY2VzcyApIHsNCgl2YXIgY29udjIsIGN1cnJlbnQsIGNvbnYsIHRtcCwgcHJldiwNCgkJY29udmVydGVycyA9IHt9LA0KCQkvLyBXb3JrIHdpdGggYSBjb3B5IG9mIGRhdGFUeXBlcyBpbiBjYXNlIHdlIG5lZWQgdG8gbW9kaWZ5IGl0IGZvciBjb252ZXJzaW9uDQoJCWRhdGFUeXBlcyA9IHMuZGF0YVR5cGVzLnNsaWNlKCk7DQoNCgkvLyBDcmVhdGUgY29udmVydGVycyBtYXAgd2l0aCBsb3dlcmNhc2VkIGtleXMNCglpZiAoIGRhdGFUeXBlc1sgMSBdICkgew0KCQlmb3IgKCBjb252IGluIHMuY29udmVydGVycyApIHsNCgkJCWNvbnZlcnRlcnNbIGNvbnYudG9Mb3dlckNhc2UoKSBdID0gcy5jb252ZXJ0ZXJzWyBjb252IF07DQoJCX0NCgl9DQoNCgljdXJyZW50ID0gZGF0YVR5cGVzLnNoaWZ0KCk7DQoNCgkvLyBDb252ZXJ0IHRvIGVhY2ggc2VxdWVudGlhbCBkYXRhVHlwZQ0KCXdoaWxlICggY3VycmVudCApIHsNCg0KCQlpZiAoIHMucmVzcG9uc2VGaWVsZHNbIGN1cnJlbnQgXSApIHsNCgkJCWpxWEhSWyBzLnJlc3BvbnNlRmllbGRzWyBjdXJyZW50IF0gXSA9IHJlc3BvbnNlOw0KCQl9DQoNCgkJLy8gQXBwbHkgdGhlIGRhdGFGaWx0ZXIgaWYgcHJvdmlkZWQNCgkJaWYgKCAhcHJldiAmJiBpc1N1Y2Nlc3MgJiYgcy5kYXRhRmlsdGVyICkgew0KCQkJcmVzcG9uc2UgPSBzLmRhdGFGaWx0ZXIoIHJlc3BvbnNlLCBzLmRhdGFUeXBlICk7DQoJCX0NCg0KCQlwcmV2ID0gY3VycmVudDsNCgkJY3VycmVudCA9IGRhdGFUeXBlcy5zaGlmdCgpOw0KDQoJCWlmICggY3VycmVudCApIHsNCg0KCQkJLy8gVGhlcmUncyBvbmx5IHdvcmsgdG8gZG8gaWYgY3VycmVudCBkYXRhVHlwZSBpcyBub24tYXV0bw0KCQkJaWYgKCBjdXJyZW50ID09PSAiKiIgKSB7DQoNCgkJCQljdXJyZW50ID0gcHJldjsNCg0KCQkJLy8gQ29udmVydCByZXNwb25zZSBpZiBwcmV2IGRhdGFUeXBlIGlzIG5vbi1hdXRvIGFuZCBkaWZmZXJzIGZyb20gY3VycmVudA0KCQkJfSBlbHNlIGlmICggcHJldiAhPT0gIioiICYmIHByZXYgIT09IGN1cnJlbnQgKSB7DQoNCgkJCQkvLyBTZWVrIGEgZGlyZWN0IGNvbnZlcnRlcg0KCQkJCWNvbnYgPSBjb252ZXJ0ZXJzWyBwcmV2ICsgIiAiICsgY3VycmVudCBdIHx8IGNvbnZlcnRlcnNbICIqICIgKyBjdXJyZW50IF07DQoNCgkJCQkvLyBJZiBub25lIGZvdW5kLCBzZWVrIGEgcGFpcg0KCQkJCWlmICggIWNvbnYgKSB7DQoJCQkJCWZvciAoIGNvbnYyIGluIGNvbnZlcnRlcnMgKSB7DQoNCgkJCQkJCS8vIElmIGNvbnYyIG91dHB1dHMgY3VycmVudA0KCQkJCQkJdG1wID0gY29udjIuc3BsaXQoICIgIiApOw0KCQkJCQkJaWYgKCB0bXBbIDEgXSA9PT0gY3VycmVudCApIHsNCg0KCQkJCQkJCS8vIElmIHByZXYgY2FuIGJlIGNvbnZlcnRlZCB0byBhY2NlcHRlZCBpbnB1dA0KCQkJCQkJCWNvbnYgPSBjb252ZXJ0ZXJzWyBwcmV2ICsgIiAiICsgdG1wWyAwIF0gXSB8fA0KCQkJCQkJCQljb252ZXJ0ZXJzWyAiKiAiICsgdG1wWyAwIF0gXTsNCgkJCQkJCQlpZiAoIGNvbnYgKSB7DQoJCQkJCQkJCS8vIENvbmRlbnNlIGVxdWl2YWxlbmNlIGNvbnZlcnRlcnMNCgkJCQkJCQkJaWYgKCBjb252ID09PSB0cnVlICkgew0KCQkJCQkJCQkJY29udiA9IGNvbnZlcnRlcnNbIGNvbnYyIF07DQoNCgkJCQkJCQkJLy8gT3RoZXJ3aXNlLCBpbnNlcnQgdGhlIGludGVybWVkaWF0ZSBkYXRhVHlwZQ0KCQkJCQkJCQl9IGVsc2UgaWYgKCBjb252ZXJ0ZXJzWyBjb252MiBdICE9PSB0cnVlICkgew0KCQkJCQkJCQkJY3VycmVudCA9IHRtcFsgMCBdOw0KCQkJCQkJCQkJZGF0YVR5cGVzLnVuc2hpZnQoIHRtcFsgMSBdICk7DQoJCQkJCQkJCX0NCgkJCQkJCQkJYnJlYWs7DQoJCQkJCQkJfQ0KCQkJCQkJfQ0KCQkJCQl9DQoJCQkJfQ0KDQoJCQkJLy8gQXBwbHkgY29udmVydGVyIChpZiBub3QgYW4gZXF1aXZhbGVuY2UpDQoJCQkJaWYgKCBjb252ICE9PSB0cnVlICkgew0KDQoJCQkJCS8vIFVubGVzcyBlcnJvcnMgYXJlIGFsbG93ZWQgdG8gYnViYmxlLCBjYXRjaCBhbmQgcmV0dXJuIHRoZW0NCgkJCQkJaWYgKCBjb252ICYmIHNbICJ0aHJvd3MiIF0gKSB7DQoJCQkJCQlyZXNwb25zZSA9IGNvbnYoIHJlc3BvbnNlICk7DQoJCQkJCX0gZWxzZSB7DQoJCQkJCQl0cnkgew0KCQkJCQkJCXJlc3BvbnNlID0gY29udiggcmVzcG9uc2UgKTsNCgkJCQkJCX0gY2F0Y2ggKCBlICkgew0KCQkJCQkJCXJldHVybiB7IHN0YXRlOiAicGFyc2VyZXJyb3IiLCBlcnJvcjogY29udiA/IGUgOiAiTm8gY29udmVyc2lvbiBmcm9tICIgKyBwcmV2ICsgIiB0byAiICsgY3VycmVudCB9Ow0KCQkJCQkJfQ0KCQkJCQl9DQoJCQkJfQ0KCQkJfQ0KCQl9DQoJfQ0KDQoJcmV0dXJuIHsgc3RhdGU6ICJzdWNjZXNzIiwgZGF0YTogcmVzcG9uc2UgfTsNCn0NCi8vIEluc3RhbGwgc2NyaXB0IGRhdGFUeXBlDQpqUXVlcnkuYWpheFNldHVwKHsNCglhY2NlcHRzOiB7DQoJCXNjcmlwdDogInRleHQvamF2YXNjcmlwdCwgYXBwbGljYXRpb24vamF2YXNjcmlwdCwgYXBwbGljYXRpb24vZWNtYXNjcmlwdCwgYXBwbGljYXRpb24veC1lY21hc2NyaXB0Ig0KCX0sDQoJY29udGVudHM6IHsNCgkJc2NyaXB0OiAvKD86amF2YXxlY21hKXNjcmlwdC8NCgl9LA0KCWNvbnZlcnRlcnM6IHsNCgkJInRleHQgc2NyaXB0IjogZnVuY3Rpb24oIHRleHQgKSB7DQoJCQlqUXVlcnkuZ2xvYmFsRXZhbCggdGV4dCApOw0KCQkJcmV0dXJuIHRleHQ7DQoJCX0NCgl9DQp9KTsNCg0KLy8gSGFuZGxlIGNhY2hlJ3Mgc3BlY2lhbCBjYXNlIGFuZCBnbG9iYWwNCmpRdWVyeS5hamF4UHJlZmlsdGVyKCAic2NyaXB0IiwgZnVuY3Rpb24oIHMgKSB7DQoJaWYgKCBzLmNhY2hlID09PSB1bmRlZmluZWQgKSB7DQoJCXMuY2FjaGUgPSBmYWxzZTsNCgl9DQoJaWYgKCBzLmNyb3NzRG9tYWluICkgew0KCQlzLnR5cGUgPSAiR0VUIjsNCgkJcy5nbG9iYWwgPSBmYWxzZTsNCgl9DQp9KTsNCg0KLy8gQmluZCBzY3JpcHQgdGFnIGhhY2sgdHJhbnNwb3J0DQpqUXVlcnkuYWpheFRyYW5zcG9ydCggInNjcmlwdCIsIGZ1bmN0aW9uKHMpIHsNCg0KCS8vIFRoaXMgdHJhbnNwb3J0IG9ubHkgZGVhbHMgd2l0aCBjcm9zcyBkb21haW4gcmVxdWVzdHMNCglpZiAoIHMuY3Jvc3NEb21haW4gKSB7DQoNCgkJdmFyIHNjcmlwdCwNCgkJCWhlYWQgPSBkb2N1bWVudC5oZWFkIHx8IGpRdWVyeSgiaGVhZCIpWzBdIHx8IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsNCg0KCQlyZXR1cm4gew0KDQoJCQlzZW5kOiBmdW5jdGlvbiggXywgY2FsbGJhY2sgKSB7DQoNCgkJCQlzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsNCg0KCQkJCXNjcmlwdC5hc3luYyA9IHRydWU7DQoNCgkJCQlpZiAoIHMuc2NyaXB0Q2hhcnNldCApIHsNCgkJCQkJc2NyaXB0LmNoYXJzZXQgPSBzLnNjcmlwdENoYXJzZXQ7DQoJCQkJfQ0KDQoJCQkJc2NyaXB0LnNyYyA9IHMudXJsOw0KDQoJCQkJLy8gQXR0YWNoIGhhbmRsZXJzIGZvciBhbGwgYnJvd3NlcnMNCgkJCQlzY3JpcHQub25sb2FkID0gc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCBfLCBpc0Fib3J0ICkgew0KDQoJCQkJCWlmICggaXNBYm9ydCB8fCAhc2NyaXB0LnJlYWR5U3RhdGUgfHwgL2xvYWRlZHxjb21wbGV0ZS8udGVzdCggc2NyaXB0LnJlYWR5U3RhdGUgKSApIHsNCg0KCQkJCQkJLy8gSGFuZGxlIG1lbW9yeSBsZWFrIGluIElFDQoJCQkJCQlzY3JpcHQub25sb2FkID0gc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IG51bGw7DQoNCgkJCQkJCS8vIFJlbW92ZSB0aGUgc2NyaXB0DQoJCQkJCQlpZiAoIHNjcmlwdC5wYXJlbnROb2RlICkgew0KCQkJCQkJCXNjcmlwdC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCBzY3JpcHQgKTsNCgkJCQkJCX0NCg0KCQkJCQkJLy8gRGVyZWZlcmVuY2UgdGhlIHNjcmlwdA0KCQkJCQkJc2NyaXB0ID0gbnVsbDsNCg0KCQkJCQkJLy8gQ2FsbGJhY2sgaWYgbm90IGFib3J0DQoJCQkJCQlpZiAoICFpc0Fib3J0ICkgew0KCQkJCQkJCWNhbGxiYWNrKCAyMDAsICJzdWNjZXNzIiApOw0KCQkJCQkJfQ0KCQkJCQl9DQoJCQkJfTsNCg0KCQkJCS8vIENpcmN1bXZlbnQgSUU2IGJ1Z3Mgd2l0aCBiYXNlIGVsZW1lbnRzICgjMjcwOSBhbmQgIzQzNzgpIGJ5IHByZXBlbmRpbmcNCgkJCQkvLyBVc2UgbmF0aXZlIERPTSBtYW5pcHVsYXRpb24gdG8gYXZvaWQgb3VyIGRvbU1hbmlwIEFKQVggdHJpY2tlcnkNCgkJCQloZWFkLmluc2VydEJlZm9yZSggc2NyaXB0LCBoZWFkLmZpcnN0Q2hpbGQgKTsNCgkJCX0sDQoNCgkJCWFib3J0OiBmdW5jdGlvbigpIHsNCgkJCQlpZiAoIHNjcmlwdCApIHsNCgkJCQkJc2NyaXB0Lm9ubG9hZCggdW5kZWZpbmVkLCB0cnVlICk7DQoJCQkJfQ0KCQkJfQ0KCQl9Ow0KCX0NCn0pOw0KdmFyIG9sZENhbGxiYWNrcyA9IFtdLA0KCXJqc29ucCA9IC8oPSlcPyg/PSZ8JCl8XD9cPy87DQoNCi8vIERlZmF1bHQganNvbnAgc2V0dGluZ3MNCmpRdWVyeS5hamF4U2V0dXAoew0KCWpzb25wOiAiY2FsbGJhY2siLA0KCWpzb25wQ2FsbGJhY2s6IGZ1bmN0aW9uKCkgew0KCQl2YXIgY2FsbGJhY2sgPSBvbGRDYWxsYmFja3MucG9wKCkgfHwgKCBqUXVlcnkuZXhwYW5kbyArICJfIiArICggYWpheF9ub25jZSsrICkgKTsNCgkJdGhpc1sgY2FsbGJhY2sgXSA9IHRydWU7DQoJCXJldHVybiBjYWxsYmFjazsNCgl9DQp9KTsNCg0KLy8gRGV0ZWN0LCBub3JtYWxpemUgb3B0aW9ucyBhbmQgaW5zdGFsbCBjYWxsYmFja3MgZm9yIGpzb25wIHJlcXVlc3RzDQpqUXVlcnkuYWpheFByZWZpbHRlciggImpzb24ganNvbnAiLCBmdW5jdGlvbiggcywgb3JpZ2luYWxTZXR0aW5ncywganFYSFIgKSB7DQoNCgl2YXIgY2FsbGJhY2tOYW1lLCBvdmVyd3JpdHRlbiwgcmVzcG9uc2VDb250YWluZXIsDQoJCWpzb25Qcm9wID0gcy5qc29ucCAhPT0gZmFsc2UgJiYgKCByanNvbnAudGVzdCggcy51cmwgKSA/DQoJCQkidXJsIiA6DQoJCQl0eXBlb2Ygcy5kYXRhID09PSAic3RyaW5nIiAmJiAhKCBzLmNvbnRlbnRUeXBlIHx8ICIiICkuaW5kZXhPZigiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkIikgJiYgcmpzb25wLnRlc3QoIHMuZGF0YSApICYmICJkYXRhIg0KCQkpOw0KDQoJLy8gSGFuZGxlIGlmZiB0aGUgZXhwZWN0ZWQgZGF0YSB0eXBlIGlzICJqc29ucCIgb3Igd2UgaGF2ZSBhIHBhcmFtZXRlciB0byBzZXQNCglpZiAoIGpzb25Qcm9wIHx8IHMuZGF0YVR5cGVzWyAwIF0gPT09ICJqc29ucCIgKSB7DQoNCgkJLy8gR2V0IGNhbGxiYWNrIG5hbWUsIHJlbWVtYmVyaW5nIHByZWV4aXN0aW5nIHZhbHVlIGFzc29jaWF0ZWQgd2l0aCBpdA0KCQljYWxsYmFja05hbWUgPSBzLmpzb25wQ2FsbGJhY2sgPSBqUXVlcnkuaXNGdW5jdGlvbiggcy5qc29ucENhbGxiYWNrICkgPw0KCQkJcy5qc29ucENhbGxiYWNrKCkgOg0KCQkJcy5qc29ucENhbGxiYWNrOw0KDQoJCS8vIEluc2VydCBjYWxsYmFjayBpbnRvIHVybCBvciBmb3JtIGRhdGENCgkJaWYgKCBqc29uUHJvcCApIHsNCgkJCXNbIGpzb25Qcm9wIF0gPSBzWyBqc29uUHJvcCBdLnJlcGxhY2UoIHJqc29ucCwgIiQxIiArIGNhbGxiYWNrTmFtZSApOw0KCQl9IGVsc2UgaWYgKCBzLmpzb25wICE9PSBmYWxzZSApIHsNCgkJCXMudXJsICs9ICggYWpheF9ycXVlcnkudGVzdCggcy51cmwgKSA/ICImIiA6ICI/IiApICsgcy5qc29ucCArICI9IiArIGNhbGxiYWNrTmFtZTsNCgkJfQ0KDQoJCS8vIFVzZSBkYXRhIGNvbnZlcnRlciB0byByZXRyaWV2ZSBqc29uIGFmdGVyIHNjcmlwdCBleGVjdXRpb24NCgkJcy5jb252ZXJ0ZXJzWyJzY3JpcHQganNvbiJdID0gZnVuY3Rpb24oKSB7DQoJCQlpZiAoICFyZXNwb25zZUNvbnRhaW5lciApIHsNCgkJCQlqUXVlcnkuZXJyb3IoIGNhbGxiYWNrTmFtZSArICIgd2FzIG5vdCBjYWxsZWQiICk7DQoJCQl9DQoJCQlyZXR1cm4gcmVzcG9uc2VDb250YWluZXJbIDAgXTsNCgkJfTsNCg0KCQkvLyBmb3JjZSBqc29uIGRhdGFUeXBlDQoJCXMuZGF0YVR5cGVzWyAwIF0gPSAianNvbiI7DQoNCgkJLy8gSW5zdGFsbCBjYWxsYmFjaw0KCQlvdmVyd3JpdHRlbiA9IHdpbmRvd1sgY2FsbGJhY2tOYW1lIF07DQoJCXdpbmRvd1sgY2FsbGJhY2tOYW1lIF0gPSBmdW5jdGlvbigpIHsNCgkJCXJlc3BvbnNlQ29udGFpbmVyID0gYXJndW1lbnRzOw0KCQl9Ow0KDQoJCS8vIENsZWFuLXVwIGZ1bmN0aW9uIChmaXJlcyBhZnRlciBjb252ZXJ0ZXJzKQ0KCQlqcVhIUi5hbHdheXMoZnVuY3Rpb24oKSB7DQoJCQkvLyBSZXN0b3JlIHByZWV4aXN0aW5nIHZhbHVlDQoJCQl3aW5kb3dbIGNhbGxiYWNrTmFtZSBdID0gb3ZlcndyaXR0ZW47DQoNCgkJCS8vIFNhdmUgYmFjayBhcyBmcmVlDQoJCQlpZiAoIHNbIGNhbGxiYWNrTmFtZSBdICkgew0KCQkJCS8vIG1ha2Ugc3VyZSB0aGF0IHJlLXVzaW5nIHRoZSBvcHRpb25zIGRvZXNuJ3Qgc2NyZXcgdGhpbmdzIGFyb3VuZA0KCQkJCXMuanNvbnBDYWxsYmFjayA9IG9yaWdpbmFsU2V0dGluZ3MuanNvbnBDYWxsYmFjazsNCg0KCQkJCS8vIHNhdmUgdGhlIGNhbGxiYWNrIG5hbWUgZm9yIGZ1dHVyZSB1c2UNCgkJCQlvbGRDYWxsYmFja3MucHVzaCggY2FsbGJhY2tOYW1lICk7DQoJCQl9DQoNCgkJCS8vIENhbGwgaWYgaXQgd2FzIGEgZnVuY3Rpb24gYW5kIHdlIGhhdmUgYSByZXNwb25zZQ0KCQkJaWYgKCByZXNwb25zZUNvbnRhaW5lciAmJiBqUXVlcnkuaXNGdW5jdGlvbiggb3ZlcndyaXR0ZW4gKSApIHsNCgkJCQlvdmVyd3JpdHRlbiggcmVzcG9uc2VDb250YWluZXJbIDAgXSApOw0KCQkJfQ0KDQoJCQlyZXNwb25zZUNvbnRhaW5lciA9IG92ZXJ3cml0dGVuID0gdW5kZWZpbmVkOw0KCQl9KTsNCg0KCQkvLyBEZWxlZ2F0ZSB0byBzY3JpcHQNCgkJcmV0dXJuICJzY3JpcHQiOw0KCX0NCn0pOw0KdmFyIHhockNhbGxiYWNrcywgeGhyU3VwcG9ydGVkLA0KCXhocklkID0gMCwNCgkvLyAjNTI4MDogSW50ZXJuZXQgRXhwbG9yZXIgd2lsbCBrZWVwIGNvbm5lY3Rpb25zIGFsaXZlIGlmIHdlIGRvbid0IGFib3J0IG9uIHVubG9hZA0KCXhock9uVW5sb2FkQWJvcnQgPSB3aW5kb3cuQWN0aXZlWE9iamVjdCAmJiBmdW5jdGlvbigpIHsNCgkJLy8gQWJvcnQgYWxsIHBlbmRpbmcgcmVxdWVzdHMNCgkJdmFyIGtleTsNCgkJZm9yICgga2V5IGluIHhockNhbGxiYWNrcyApIHsNCgkJCXhockNhbGxiYWNrc1sga2V5IF0oIHVuZGVmaW5lZCwgdHJ1ZSApOw0KCQl9DQoJfTsNCg0KLy8gRnVuY3Rpb25zIHRvIGNyZWF0ZSB4aHJzDQpmdW5jdGlvbiBjcmVhdGVTdGFuZGFyZFhIUigpIHsNCgl0cnkgew0KCQlyZXR1cm4gbmV3IHdpbmRvdy5YTUxIdHRwUmVxdWVzdCgpOw0KCX0gY2F0Y2goIGUgKSB7fQ0KfQ0KDQpmdW5jdGlvbiBjcmVhdGVBY3RpdmVYSFIoKSB7DQoJdHJ5IHsNCgkJcmV0dXJuIG5ldyB3aW5kb3cuQWN0aXZlWE9iamVjdCgiTWljcm9zb2Z0LlhNTEhUVFAiKTsNCgl9IGNhdGNoKCBlICkge30NCn0NCg0KLy8gQ3JlYXRlIHRoZSByZXF1ZXN0IG9iamVjdA0KLy8gKFRoaXMgaXMgc3RpbGwgYXR0YWNoZWQgdG8gYWpheFNldHRpbmdzIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5KQ0KalF1ZXJ5LmFqYXhTZXR0aW5ncy54aHIgPSB3aW5kb3cuQWN0aXZlWE9iamVjdCA/DQoJLyogTWljcm9zb2Z0IGZhaWxlZCB0byBwcm9wZXJseQ0KCSAqIGltcGxlbWVudCB0aGUgWE1MSHR0cFJlcXVlc3QgaW4gSUU3IChjYW4ndCByZXF1ZXN0IGxvY2FsIGZpbGVzKSwNCgkgKiBzbyB3ZSB1c2UgdGhlIEFjdGl2ZVhPYmplY3Qgd2hlbiBpdCBpcyBhdmFpbGFibGUNCgkgKiBBZGRpdGlvbmFsbHkgWE1MSHR0cFJlcXVlc3QgY2FuIGJlIGRpc2FibGVkIGluIElFNy9JRTggc28NCgkgKiB3ZSBuZWVkIGEgZmFsbGJhY2suDQoJICovDQoJZnVuY3Rpb24oKSB7DQoJCXJldHVybiAhdGhpcy5pc0xvY2FsICYmIGNyZWF0ZVN0YW5kYXJkWEhSKCkgfHwgY3JlYXRlQWN0aXZlWEhSKCk7DQoJfSA6DQoJLy8gRm9yIGFsbCBvdGhlciBicm93c2VycywgdXNlIHRoZSBzdGFuZGFyZCBYTUxIdHRwUmVxdWVzdCBvYmplY3QNCgljcmVhdGVTdGFuZGFyZFhIUjsNCg0KLy8gRGV0ZXJtaW5lIHN1cHBvcnQgcHJvcGVydGllcw0KeGhyU3VwcG9ydGVkID0galF1ZXJ5LmFqYXhTZXR0aW5ncy54aHIoKTsNCmpRdWVyeS5zdXBwb3J0LmNvcnMgPSAhIXhoclN1cHBvcnRlZCAmJiAoICJ3aXRoQ3JlZGVudGlhbHMiIGluIHhoclN1cHBvcnRlZCApOw0KeGhyU3VwcG9ydGVkID0galF1ZXJ5LnN1cHBvcnQuYWpheCA9ICEheGhyU3VwcG9ydGVkOw0KDQovLyBDcmVhdGUgdHJhbnNwb3J0IGlmIHRoZSBicm93c2VyIGNhbiBwcm92aWRlIGFuIHhocg0KaWYgKCB4aHJTdXBwb3J0ZWQgKSB7DQoNCglqUXVlcnkuYWpheFRyYW5zcG9ydChmdW5jdGlvbiggcyApIHsNCgkJLy8gQ3Jvc3MgZG9tYWluIG9ubHkgYWxsb3dlZCBpZiBzdXBwb3J0ZWQgdGhyb3VnaCBYTUxIdHRwUmVxdWVzdA0KCQlpZiAoICFzLmNyb3NzRG9tYWluIHx8IGpRdWVyeS5zdXBwb3J0LmNvcnMgKSB7DQoNCgkJCXZhciBjYWxsYmFjazsNCg0KCQkJcmV0dXJuIHsNCgkJCQlzZW5kOiBmdW5jdGlvbiggaGVhZGVycywgY29tcGxldGUgKSB7DQoNCgkJCQkJLy8gR2V0IGEgbmV3IHhocg0KCQkJCQl2YXIgaGFuZGxlLCBpLA0KCQkJCQkJeGhyID0gcy54aHIoKTsNCg0KCQkJCQkvLyBPcGVuIHRoZSBzb2NrZXQNCgkJCQkJLy8gUGFzc2luZyBudWxsIHVzZXJuYW1lLCBnZW5lcmF0ZXMgYSBsb2dpbiBwb3B1cCBvbiBPcGVyYSAoIzI4NjUpDQoJCQkJCWlmICggcy51c2VybmFtZSApIHsNCgkJCQkJCXhoci5vcGVuKCBzLnR5cGUsIHMudXJsLCBzLmFzeW5jLCBzLnVzZXJuYW1lLCBzLnBhc3N3b3JkICk7DQoJCQkJCX0gZWxzZSB7DQoJCQkJCQl4aHIub3Blbiggcy50eXBlLCBzLnVybCwgcy5hc3luYyApOw0KCQkJCQl9DQoNCgkJCQkJLy8gQXBwbHkgY3VzdG9tIGZpZWxkcyBpZiBwcm92aWRlZA0KCQkJCQlpZiAoIHMueGhyRmllbGRzICkgew0KCQkJCQkJZm9yICggaSBpbiBzLnhockZpZWxkcyApIHsNCgkJCQkJCQl4aHJbIGkgXSA9IHMueGhyRmllbGRzWyBpIF07DQoJCQkJCQl9DQoJCQkJCX0NCg0KCQkJCQkvLyBPdmVycmlkZSBtaW1lIHR5cGUgaWYgbmVlZGVkDQoJCQkJCWlmICggcy5taW1lVHlwZSAmJiB4aHIub3ZlcnJpZGVNaW1lVHlwZSApIHsNCgkJCQkJCXhoci5vdmVycmlkZU1pbWVUeXBlKCBzLm1pbWVUeXBlICk7DQoJCQkJCX0NCg0KCQkJCQkvLyBYLVJlcXVlc3RlZC1XaXRoIGhlYWRlcg0KCQkJCQkvLyBGb3IgY3Jvc3MtZG9tYWluIHJlcXVlc3RzLCBzZWVpbmcgYXMgY29uZGl0aW9ucyBmb3IgYSBwcmVmbGlnaHQgYXJlDQoJCQkJCS8vIGFraW4gdG8gYSBqaWdzYXcgcHV6emxlLCB3ZSBzaW1wbHkgbmV2ZXIgc2V0IGl0IHRvIGJlIHN1cmUuDQoJCQkJCS8vIChpdCBjYW4gYWx3YXlzIGJlIHNldCBvbiBhIHBlci1yZXF1ZXN0IGJhc2lzIG9yIGV2ZW4gdXNpbmcgYWpheFNldHVwKQ0KCQkJCQkvLyBGb3Igc2FtZS1kb21haW4gcmVxdWVzdHMsIHdvbid0IGNoYW5nZSBoZWFkZXIgaWYgYWxyZWFkeSBwcm92aWRlZC4NCgkJCQkJaWYgKCAhcy5jcm9zc0RvbWFpbiAmJiAhaGVhZGVyc1siWC1SZXF1ZXN0ZWQtV2l0aCJdICkgew0KCQkJCQkJaGVhZGVyc1siWC1SZXF1ZXN0ZWQtV2l0aCJdID0gIlhNTEh0dHBSZXF1ZXN0IjsNCgkJCQkJfQ0KDQoJCQkJCS8vIE5lZWQgYW4gZXh0cmEgdHJ5L2NhdGNoIGZvciBjcm9zcyBkb21haW4gcmVxdWVzdHMgaW4gRmlyZWZveCAzDQoJCQkJCXRyeSB7DQoJCQkJCQlmb3IgKCBpIGluIGhlYWRlcnMgKSB7DQoJCQkJCQkJeGhyLnNldFJlcXVlc3RIZWFkZXIoIGksIGhlYWRlcnNbIGkgXSApOw0KCQkJCQkJfQ0KCQkJCQl9IGNhdGNoKCBlcnIgKSB7fQ0KDQoJCQkJCS8vIERvIHNlbmQgdGhlIHJlcXVlc3QNCgkJCQkJLy8gVGhpcyBtYXkgcmFpc2UgYW4gZXhjZXB0aW9uIHdoaWNoIGlzIGFjdHVhbGx5DQoJCQkJCS8vIGhhbmRsZWQgaW4galF1ZXJ5LmFqYXggKHNvIG5vIHRyeS9jYXRjaCBoZXJlKQ0KCQkJCQl4aHIuc2VuZCggKCBzLmhhc0NvbnRlbnQgJiYgcy5kYXRhICkgfHwgbnVsbCApOw0KDQoJCQkJCS8vIExpc3RlbmVyDQoJCQkJCWNhbGxiYWNrID0gZnVuY3Rpb24oIF8sIGlzQWJvcnQgKSB7DQoJCQkJCQl2YXIgc3RhdHVzLCByZXNwb25zZUhlYWRlcnMsIHN0YXR1c1RleHQsIHJlc3BvbnNlczsNCg0KCQkJCQkJLy8gRmlyZWZveCB0aHJvd3MgZXhjZXB0aW9ucyB3aGVuIGFjY2Vzc2luZyBwcm9wZXJ0aWVzDQoJCQkJCQkvLyBvZiBhbiB4aHIgd2hlbiBhIG5ldHdvcmsgZXJyb3Igb2NjdXJyZWQNCgkJCQkJCS8vIGh0dHA6Ly9oZWxwZnVsLmtub2JzLWRpYWxzLmNvbS9pbmRleC5waHAvQ29tcG9uZW50X3JldHVybmVkX2ZhaWx1cmVfY29kZTpfMHg4MDA0MDExMV8oTlNfRVJST1JfTk9UX0FWQUlMQUJMRSkNCgkJCQkJCXRyeSB7DQoNCgkJCQkJCQkvLyBXYXMgbmV2ZXIgY2FsbGVkIGFuZCBpcyBhYm9ydGVkIG9yIGNvbXBsZXRlDQoJCQkJCQkJaWYgKCBjYWxsYmFjayAmJiAoIGlzQWJvcnQgfHwgeGhyLnJlYWR5U3RhdGUgPT09IDQgKSApIHsNCg0KCQkJCQkJCQkvLyBPbmx5IGNhbGxlZCBvbmNlDQoJCQkJCQkJCWNhbGxiYWNrID0gdW5kZWZpbmVkOw0KDQoJCQkJCQkJCS8vIERvIG5vdCBrZWVwIGFzIGFjdGl2ZSBhbnltb3JlDQoJCQkJCQkJCWlmICggaGFuZGxlICkgew0KCQkJCQkJCQkJeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGpRdWVyeS5ub29wOw0KCQkJCQkJCQkJaWYgKCB4aHJPblVubG9hZEFib3J0ICkgew0KCQkJCQkJCQkJCWRlbGV0ZSB4aHJDYWxsYmFja3NbIGhhbmRsZSBdOw0KCQkJCQkJCQkJfQ0KCQkJCQkJCQl9DQoNCgkJCQkJCQkJLy8gSWYgaXQncyBhbiBhYm9ydA0KCQkJCQkJCQlpZiAoIGlzQWJvcnQgKSB7DQoJCQkJCQkJCQkvLyBBYm9ydCBpdCBtYW51YWxseSBpZiBuZWVkZWQNCgkJCQkJCQkJCWlmICggeGhyLnJlYWR5U3RhdGUgIT09IDQgKSB7DQoJCQkJCQkJCQkJeGhyLmFib3J0KCk7DQoJCQkJCQkJCQl9DQoJCQkJCQkJCX0gZWxzZSB7DQoJCQkJCQkJCQlyZXNwb25zZXMgPSB7fTsNCgkJCQkJCQkJCXN0YXR1cyA9IHhoci5zdGF0dXM7DQoJCQkJCQkJCQlyZXNwb25zZUhlYWRlcnMgPSB4aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCk7DQoNCgkJCQkJCQkJCS8vIFdoZW4gcmVxdWVzdGluZyBiaW5hcnkgZGF0YSwgSUU2LTkgd2lsbCB0aHJvdyBhbiBleGNlcHRpb24NCgkJCQkJCQkJCS8vIG9uIGFueSBhdHRlbXB0IHRvIGFjY2VzcyByZXNwb25zZVRleHQgKCMxMTQyNikNCgkJCQkJCQkJCWlmICggdHlwZW9mIHhoci5yZXNwb25zZVRleHQgPT09ICJzdHJpbmciICkgew0KCQkJCQkJCQkJCXJlc3BvbnNlcy50ZXh0ID0geGhyLnJlc3BvbnNlVGV4dDsNCgkJCQkJCQkJCX0NCg0KCQkJCQkJCQkJLy8gRmlyZWZveCB0aHJvd3MgYW4gZXhjZXB0aW9uIHdoZW4gYWNjZXNzaW5nDQoJCQkJCQkJCQkvLyBzdGF0dXNUZXh0IGZvciBmYXVsdHkgY3Jvc3MtZG9tYWluIHJlcXVlc3RzDQoJCQkJCQkJCQl0cnkgew0KCQkJCQkJCQkJCXN0YXR1c1RleHQgPSB4aHIuc3RhdHVzVGV4dDsNCgkJCQkJCQkJCX0gY2F0Y2goIGUgKSB7DQoJCQkJCQkJCQkJLy8gV2Ugbm9ybWFsaXplIHdpdGggV2Via2l0IGdpdmluZyBhbiBlbXB0eSBzdGF0dXNUZXh0DQoJCQkJCQkJCQkJc3RhdHVzVGV4dCA9ICIiOw0KCQkJCQkJCQkJfQ0KDQoJCQkJCQkJCQkvLyBGaWx0ZXIgc3RhdHVzIGZvciBub24gc3RhbmRhcmQgYmVoYXZpb3JzDQoNCgkJCQkJCQkJCS8vIElmIHRoZSByZXF1ZXN0IGlzIGxvY2FsIGFuZCB3ZSBoYXZlIGRhdGE6IGFzc3VtZSBhIHN1Y2Nlc3MNCgkJCQkJCQkJCS8vIChzdWNjZXNzIHdpdGggbm8gZGF0YSB3b24ndCBnZXQgbm90aWZpZWQsIHRoYXQncyB0aGUgYmVzdCB3ZQ0KCQkJCQkJCQkJLy8gY2FuIGRvIGdpdmVuIGN1cnJlbnQgaW1wbGVtZW50YXRpb25zKQ0KCQkJCQkJCQkJaWYgKCAhc3RhdHVzICYmIHMuaXNMb2NhbCAmJiAhcy5jcm9zc0RvbWFpbiApIHsNCgkJCQkJCQkJCQlzdGF0dXMgPSByZXNwb25zZXMudGV4dCA/IDIwMCA6IDQwNDsNCgkJCQkJCQkJCS8vIElFIC0gIzE0NTA6IHNvbWV0aW1lcyByZXR1cm5zIDEyMjMgd2hlbiBpdCBzaG91bGQgYmUgMjA0DQoJCQkJCQkJCQl9IGVsc2UgaWYgKCBzdGF0dXMgPT09IDEyMjMgKSB7DQoJCQkJCQkJCQkJc3RhdHVzID0gMjA0Ow0KCQkJCQkJCQkJfQ0KCQkJCQkJCQl9DQoJCQkJCQkJfQ0KCQkJCQkJfSBjYXRjaCggZmlyZWZveEFjY2Vzc0V4Y2VwdGlvbiApIHsNCgkJCQkJCQlpZiAoICFpc0Fib3J0ICkgew0KCQkJCQkJCQljb21wbGV0ZSggLTEsIGZpcmVmb3hBY2Nlc3NFeGNlcHRpb24gKTsNCgkJCQkJCQl9DQoJCQkJCQl9DQoNCgkJCQkJCS8vIENhbGwgY29tcGxldGUgaWYgbmVlZGVkDQoJCQkJCQlpZiAoIHJlc3BvbnNlcyApIHsNCgkJCQkJCQljb21wbGV0ZSggc3RhdHVzLCBzdGF0dXNUZXh0LCByZXNwb25zZXMsIHJlc3BvbnNlSGVhZGVycyApOw0KCQkJCQkJfQ0KCQkJCQl9Ow0KDQoJCQkJCWlmICggIXMuYXN5bmMgKSB7DQoJCQkJCQkvLyBpZiB3ZSdyZSBpbiBzeW5jIG1vZGUgd2UgZmlyZSB0aGUgY2FsbGJhY2sNCgkJCQkJCWNhbGxiYWNrKCk7DQoJCQkJCX0gZWxzZSBpZiAoIHhoci5yZWFkeVN0YXRlID09PSA0ICkgew0KCQkJCQkJLy8gKElFNiAmIElFNykgaWYgaXQncyBpbiBjYWNoZSBhbmQgaGFzIGJlZW4NCgkJCQkJCS8vIHJldHJpZXZlZCBkaXJlY3RseSB3ZSBuZWVkIHRvIGZpcmUgdGhlIGNhbGxiYWNrDQoJCQkJCQlzZXRUaW1lb3V0KCBjYWxsYmFjayApOw0KCQkJCQl9IGVsc2Ugew0KCQkJCQkJaGFuZGxlID0gKyt4aHJJZDsNCgkJCQkJCWlmICggeGhyT25VbmxvYWRBYm9ydCApIHsNCgkJCQkJCQkvLyBDcmVhdGUgdGhlIGFjdGl2ZSB4aHJzIGNhbGxiYWNrcyBsaXN0IGlmIG5lZWRlZA0KCQkJCQkJCS8vIGFuZCBhdHRhY2ggdGhlIHVubG9hZCBoYW5kbGVyDQoJCQkJCQkJaWYgKCAheGhyQ2FsbGJhY2tzICkgew0KCQkJCQkJCQl4aHJDYWxsYmFja3MgPSB7fTsNCgkJCQkJCQkJalF1ZXJ5KCB3aW5kb3cgKS51bmxvYWQoIHhock9uVW5sb2FkQWJvcnQgKTsNCgkJCQkJCQl9DQoJCQkJCQkJLy8gQWRkIHRvIGxpc3Qgb2YgYWN0aXZlIHhocnMgY2FsbGJhY2tzDQoJCQkJCQkJeGhyQ2FsbGJhY2tzWyBoYW5kbGUgXSA9IGNhbGxiYWNrOw0KCQkJCQkJfQ0KCQkJCQkJeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGNhbGxiYWNrOw0KCQkJCQl9DQoJCQkJfSwNCg0KCQkJCWFib3J0OiBmdW5jdGlvbigpIHsNCgkJCQkJaWYgKCBjYWxsYmFjayApIHsNCgkJCQkJCWNhbGxiYWNrKCB1bmRlZmluZWQsIHRydWUgKTsNCgkJCQkJfQ0KCQkJCX0NCgkJCX07DQoJCX0NCgl9KTsNCn0NCnZhciBmeE5vdywgdGltZXJJZCwNCglyZnh0eXBlcyA9IC9eKD86dG9nZ2xlfHNob3d8aGlkZSkkLywNCglyZnhudW0gPSBuZXcgUmVnRXhwKCAiXig/OihbKy1dKT18KSgiICsgY29yZV9wbnVtICsgIikoW2EteiVdKikkIiwgImkiICksDQoJcnJ1biA9IC9xdWV1ZUhvb2tzJC8sDQoJYW5pbWF0aW9uUHJlZmlsdGVycyA9IFsgZGVmYXVsdFByZWZpbHRlciBdLA0KCXR3ZWVuZXJzID0gew0KCQkiKiI6IFtmdW5jdGlvbiggcHJvcCwgdmFsdWUgKSB7DQoJCQl2YXIgdHdlZW4gPSB0aGlzLmNyZWF0ZVR3ZWVuKCBwcm9wLCB2YWx1ZSApLA0KCQkJCXRhcmdldCA9IHR3ZWVuLmN1cigpLA0KCQkJCXBhcnRzID0gcmZ4bnVtLmV4ZWMoIHZhbHVlICksDQoJCQkJdW5pdCA9IHBhcnRzICYmIHBhcnRzWyAzIF0gfHwgKCBqUXVlcnkuY3NzTnVtYmVyWyBwcm9wIF0gPyAiIiA6ICJweCIgKSwNCg0KCQkJCS8vIFN0YXJ0aW5nIHZhbHVlIGNvbXB1dGF0aW9uIGlzIHJlcXVpcmVkIGZvciBwb3RlbnRpYWwgdW5pdCBtaXNtYXRjaGVzDQoJCQkJc3RhcnQgPSAoIGpRdWVyeS5jc3NOdW1iZXJbIHByb3AgXSB8fCB1bml0ICE9PSAicHgiICYmICt0YXJnZXQgKSAmJg0KCQkJCQlyZnhudW0uZXhlYyggalF1ZXJ5LmNzcyggdHdlZW4uZWxlbSwgcHJvcCApICksDQoJCQkJc2NhbGUgPSAxLA0KCQkJCW1heEl0ZXJhdGlvbnMgPSAyMDsNCg0KCQkJaWYgKCBzdGFydCAmJiBzdGFydFsgMyBdICE9PSB1bml0ICkgew0KCQkJCS8vIFRydXN0IHVuaXRzIHJlcG9ydGVkIGJ5IGpRdWVyeS5jc3MNCgkJCQl1bml0ID0gdW5pdCB8fCBzdGFydFsgMyBdOw0KDQoJCQkJLy8gTWFrZSBzdXJlIHdlIHVwZGF0ZSB0aGUgdHdlZW4gcHJvcGVydGllcyBsYXRlciBvbg0KCQkJCXBhcnRzID0gcGFydHMgfHwgW107DQoNCgkJCQkvLyBJdGVyYXRpdmVseSBhcHByb3hpbWF0ZSBmcm9tIGEgbm9uemVybyBzdGFydGluZyBwb2ludA0KCQkJCXN0YXJ0ID0gK3RhcmdldCB8fCAxOw0KDQoJCQkJZG8gew0KCQkJCQkvLyBJZiBwcmV2aW91cyBpdGVyYXRpb24gemVyb2VkIG91dCwgZG91YmxlIHVudGlsIHdlIGdldCAqc29tZXRoaW5nKg0KCQkJCQkvLyBVc2UgYSBzdHJpbmcgZm9yIGRvdWJsaW5nIGZhY3RvciBzbyB3ZSBkb24ndCBhY2NpZGVudGFsbHkgc2VlIHNjYWxlIGFzIHVuY2hhbmdlZCBiZWxvdw0KCQkJCQlzY2FsZSA9IHNjYWxlIHx8ICIuNSI7DQoNCgkJCQkJLy8gQWRqdXN0IGFuZCBhcHBseQ0KCQkJCQlzdGFydCA9IHN0YXJ0IC8gc2NhbGU7DQoJCQkJCWpRdWVyeS5zdHlsZSggdHdlZW4uZWxlbSwgcHJvcCwgc3RhcnQgKyB1bml0ICk7DQoNCgkJCQkvLyBVcGRhdGUgc2NhbGUsIHRvbGVyYXRpbmcgemVybyBvciBOYU4gZnJvbSB0d2Vlbi5jdXIoKQ0KCQkJCS8vIEFuZCBicmVha2luZyB0aGUgbG9vcCBpZiBzY2FsZSBpcyB1bmNoYW5nZWQgb3IgcGVyZmVjdCwgb3IgaWYgd2UndmUganVzdCBoYWQgZW5vdWdoDQoJCQkJfSB3aGlsZSAoIHNjYWxlICE9PSAoc2NhbGUgPSB0d2Vlbi5jdXIoKSAvIHRhcmdldCkgJiYgc2NhbGUgIT09IDEgJiYgLS1tYXhJdGVyYXRpb25zICk7DQoJCQl9DQoNCgkJCS8vIFVwZGF0ZSB0d2VlbiBwcm9wZXJ0aWVzDQoJCQlpZiAoIHBhcnRzICkgew0KCQkJCXN0YXJ0ID0gdHdlZW4uc3RhcnQgPSArc3RhcnQgfHwgK3RhcmdldCB8fCAwOw0KCQkJCXR3ZWVuLnVuaXQgPSB1bml0Ow0KCQkJCS8vIElmIGEgKz0vLT0gdG9rZW4gd2FzIHByb3ZpZGVkLCB3ZSdyZSBkb2luZyBhIHJlbGF0aXZlIGFuaW1hdGlvbg0KCQkJCXR3ZWVuLmVuZCA9IHBhcnRzWyAxIF0gPw0KCQkJCQlzdGFydCArICggcGFydHNbIDEgXSArIDEgKSAqIHBhcnRzWyAyIF0gOg0KCQkJCQkrcGFydHNbIDIgXTsNCgkJCX0NCg0KCQkJcmV0dXJuIHR3ZWVuOw0KCQl9XQ0KCX07DQoNCi8vIEFuaW1hdGlvbnMgY3JlYXRlZCBzeW5jaHJvbm91c2x5IHdpbGwgcnVuIHN5bmNocm9ub3VzbHkNCmZ1bmN0aW9uIGNyZWF0ZUZ4Tm93KCkgew0KCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7DQoJCWZ4Tm93ID0gdW5kZWZpbmVkOw0KCX0pOw0KCXJldHVybiAoIGZ4Tm93ID0galF1ZXJ5Lm5vdygpICk7DQp9DQoNCmZ1bmN0aW9uIGNyZWF0ZVR3ZWVuKCB2YWx1ZSwgcHJvcCwgYW5pbWF0aW9uICkgew0KCXZhciB0d2VlbiwNCgkJY29sbGVjdGlvbiA9ICggdHdlZW5lcnNbIHByb3AgXSB8fCBbXSApLmNvbmNhdCggdHdlZW5lcnNbICIqIiBdICksDQoJCWluZGV4ID0gMCwNCgkJbGVuZ3RoID0gY29sbGVjdGlvbi5sZW5ndGg7DQoJZm9yICggOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKyApIHsNCgkJaWYgKCAodHdlZW4gPSBjb2xsZWN0aW9uWyBpbmRleCBdLmNhbGwoIGFuaW1hdGlvbiwgcHJvcCwgdmFsdWUgKSkgKSB7DQoNCgkJCS8vIHdlJ3JlIGRvbmUgd2l0aCB0aGlzIHByb3BlcnR5DQoJCQlyZXR1cm4gdHdlZW47DQoJCX0NCgl9DQp9DQoNCmZ1bmN0aW9uIEFuaW1hdGlvbiggZWxlbSwgcHJvcGVydGllcywgb3B0aW9ucyApIHsNCgl2YXIgcmVzdWx0LA0KCQlzdG9wcGVkLA0KCQlpbmRleCA9IDAsDQoJCWxlbmd0aCA9IGFuaW1hdGlvblByZWZpbHRlcnMubGVuZ3RoLA0KCQlkZWZlcnJlZCA9IGpRdWVyeS5EZWZlcnJlZCgpLmFsd2F5cyggZnVuY3Rpb24oKSB7DQoJCQkvLyBkb24ndCBtYXRjaCBlbGVtIGluIHRoZSA6YW5pbWF0ZWQgc2VsZWN0b3INCgkJCWRlbGV0ZSB0aWNrLmVsZW07DQoJCX0pLA0KCQl0aWNrID0gZnVuY3Rpb24oKSB7DQoJCQlpZiAoIHN0b3BwZWQgKSB7DQoJCQkJcmV0dXJuIGZhbHNlOw0KCQkJfQ0KCQkJdmFyIGN1cnJlbnRUaW1lID0gZnhOb3cgfHwgY3JlYXRlRnhOb3coKSwNCgkJCQlyZW1haW5pbmcgPSBNYXRoLm1heCggMCwgYW5pbWF0aW9uLnN0YXJ0VGltZSArIGFuaW1hdGlvbi5kdXJhdGlvbiAtIGN1cnJlbnRUaW1lICksDQoJCQkJLy8gYXJjaGFpYyBjcmFzaCBidWcgd29uJ3QgYWxsb3cgdXMgdG8gdXNlIDEgLSAoIDAuNSB8fCAwICkgKCMxMjQ5NykNCgkJCQl0ZW1wID0gcmVtYWluaW5nIC8gYW5pbWF0aW9uLmR1cmF0aW9uIHx8IDAsDQoJCQkJcGVyY2VudCA9IDEgLSB0ZW1wLA0KCQkJCWluZGV4ID0gMCwNCgkJCQlsZW5ndGggPSBhbmltYXRpb24udHdlZW5zLmxlbmd0aDsNCg0KCQkJZm9yICggOyBpbmRleCA8IGxlbmd0aCA7IGluZGV4KysgKSB7DQoJCQkJYW5pbWF0aW9uLnR3ZWVuc1sgaW5kZXggXS5ydW4oIHBlcmNlbnQgKTsNCgkJCX0NCg0KCQkJZGVmZXJyZWQubm90aWZ5V2l0aCggZWxlbSwgWyBhbmltYXRpb24sIHBlcmNlbnQsIHJlbWFpbmluZyBdKTsNCg0KCQkJaWYgKCBwZXJjZW50IDwgMSAmJiBsZW5ndGggKSB7DQoJCQkJcmV0dXJuIHJlbWFpbmluZzsNCgkJCX0gZWxzZSB7DQoJCQkJZGVmZXJyZWQucmVzb2x2ZVdpdGgoIGVsZW0sIFsgYW5pbWF0aW9uIF0gKTsNCgkJCQlyZXR1cm4gZmFsc2U7DQoJCQl9DQoJCX0sDQoJCWFuaW1hdGlvbiA9IGRlZmVycmVkLnByb21pc2Uoew0KCQkJZWxlbTogZWxlbSwNCgkJCXByb3BzOiBqUXVlcnkuZXh0ZW5kKCB7fSwgcHJvcGVydGllcyApLA0KCQkJb3B0czogalF1ZXJ5LmV4dGVuZCggdHJ1ZSwgeyBzcGVjaWFsRWFzaW5nOiB7fSB9LCBvcHRpb25zICksDQoJCQlvcmlnaW5hbFByb3BlcnRpZXM6IHByb3BlcnRpZXMsDQoJCQlvcmlnaW5hbE9wdGlvbnM6IG9wdGlvbnMsDQoJCQlzdGFydFRpbWU6IGZ4Tm93IHx8IGNyZWF0ZUZ4Tm93KCksDQoJCQlkdXJhdGlvbjogb3B0aW9ucy5kdXJhdGlvbiwNCgkJCXR3ZWVuczogW10sDQoJCQljcmVhdGVUd2VlbjogZnVuY3Rpb24oIHByb3AsIGVuZCApIHsNCgkJCQl2YXIgdHdlZW4gPSBqUXVlcnkuVHdlZW4oIGVsZW0sIGFuaW1hdGlvbi5vcHRzLCBwcm9wLCBlbmQsDQoJCQkJCQlhbmltYXRpb24ub3B0cy5zcGVjaWFsRWFzaW5nWyBwcm9wIF0gfHwgYW5pbWF0aW9uLm9wdHMuZWFzaW5nICk7DQoJCQkJYW5pbWF0aW9uLnR3ZWVucy5wdXNoKCB0d2VlbiApOw0KCQkJCXJldHVybiB0d2VlbjsNCgkJCX0sDQoJCQlzdG9wOiBmdW5jdGlvbiggZ290b0VuZCApIHsNCgkJCQl2YXIgaW5kZXggPSAwLA0KCQkJCQkvLyBpZiB3ZSBhcmUgZ29pbmcgdG8gdGhlIGVuZCwgd2Ugd2FudCB0byBydW4gYWxsIHRoZSB0d2VlbnMNCgkJCQkJLy8gb3RoZXJ3aXNlIHdlIHNraXAgdGhpcyBwYXJ0DQoJCQkJCWxlbmd0aCA9IGdvdG9FbmQgPyBhbmltYXRpb24udHdlZW5zLmxlbmd0aCA6IDA7DQoJCQkJaWYgKCBzdG9wcGVkICkgew0KCQkJCQlyZXR1cm4gdGhpczsNCgkJCQl9DQoJCQkJc3RvcHBlZCA9IHRydWU7DQoJCQkJZm9yICggOyBpbmRleCA8IGxlbmd0aCA7IGluZGV4KysgKSB7DQoJCQkJCWFuaW1hdGlvbi50d2VlbnNbIGluZGV4IF0ucnVuKCAxICk7DQoJCQkJfQ0KDQoJCQkJLy8gcmVzb2x2ZSB3aGVuIHdlIHBsYXllZCB0aGUgbGFzdCBmcmFtZQ0KCQkJCS8vIG90aGVyd2lzZSwgcmVqZWN0DQoJCQkJaWYgKCBnb3RvRW5kICkgew0KCQkJCQlkZWZlcnJlZC5yZXNvbHZlV2l0aCggZWxlbSwgWyBhbmltYXRpb24sIGdvdG9FbmQgXSApOw0KCQkJCX0gZWxzZSB7DQoJCQkJCWRlZmVycmVkLnJlamVjdFdpdGgoIGVsZW0sIFsgYW5pbWF0aW9uLCBnb3RvRW5kIF0gKTsNCgkJCQl9DQoJCQkJcmV0dXJuIHRoaXM7DQoJCQl9DQoJCX0pLA0KCQlwcm9wcyA9IGFuaW1hdGlvbi5wcm9wczsNCg0KCXByb3BGaWx0ZXIoIHByb3BzLCBhbmltYXRpb24ub3B0cy5zcGVjaWFsRWFzaW5nICk7DQoNCglmb3IgKCA7IGluZGV4IDwgbGVuZ3RoIDsgaW5kZXgrKyApIHsNCgkJcmVzdWx0ID0gYW5pbWF0aW9uUHJlZmlsdGVyc1sgaW5kZXggXS5jYWxsKCBhbmltYXRpb24sIGVsZW0sIHByb3BzLCBhbmltYXRpb24ub3B0cyApOw0KCQlpZiAoIHJlc3VsdCApIHsNCgkJCXJldHVybiByZXN1bHQ7DQoJCX0NCgl9DQoNCglqUXVlcnkubWFwKCBwcm9wcywgY3JlYXRlVHdlZW4sIGFuaW1hdGlvbiApOw0KDQoJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggYW5pbWF0aW9uLm9wdHMuc3RhcnQgKSApIHsNCgkJYW5pbWF0aW9uLm9wdHMuc3RhcnQuY2FsbCggZWxlbSwgYW5pbWF0aW9uICk7DQoJfQ0KDQoJalF1ZXJ5LmZ4LnRpbWVyKA0KCQlqUXVlcnkuZXh0ZW5kKCB0aWNrLCB7DQoJCQllbGVtOiBlbGVtLA0KCQkJYW5pbTogYW5pbWF0aW9uLA0KCQkJcXVldWU6IGFuaW1hdGlvbi5vcHRzLnF1ZXVlDQoJCX0pDQoJKTsNCg0KCS8vIGF0dGFjaCBjYWxsYmFja3MgZnJvbSBvcHRpb25zDQoJcmV0dXJuIGFuaW1hdGlvbi5wcm9ncmVzcyggYW5pbWF0aW9uLm9wdHMucHJvZ3Jlc3MgKQ0KCQkuZG9uZSggYW5pbWF0aW9uLm9wdHMuZG9uZSwgYW5pbWF0aW9uLm9wdHMuY29tcGxldGUgKQ0KCQkuZmFpbCggYW5pbWF0aW9uLm9wdHMuZmFpbCApDQoJCS5hbHdheXMoIGFuaW1hdGlvbi5vcHRzLmFsd2F5cyApOw0KfQ0KDQpmdW5jdGlvbiBwcm9wRmlsdGVyKCBwcm9wcywgc3BlY2lhbEVhc2luZyApIHsNCgl2YXIgaW5kZXgsIG5hbWUsIGVhc2luZywgdmFsdWUsIGhvb2tzOw0KDQoJLy8gY2FtZWxDYXNlLCBzcGVjaWFsRWFzaW5nIGFuZCBleHBhbmQgY3NzSG9vayBwYXNzDQoJZm9yICggaW5kZXggaW4gcHJvcHMgKSB7DQoJCW5hbWUgPSBqUXVlcnkuY2FtZWxDYXNlKCBpbmRleCApOw0KCQllYXNpbmcgPSBzcGVjaWFsRWFzaW5nWyBuYW1lIF07DQoJCXZhbHVlID0gcHJvcHNbIGluZGV4IF07DQoJCWlmICggalF1ZXJ5LmlzQXJyYXkoIHZhbHVlICkgKSB7DQoJCQllYXNpbmcgPSB2YWx1ZVsgMSBdOw0KCQkJdmFsdWUgPSBwcm9wc1sgaW5kZXggXSA9IHZhbHVlWyAwIF07DQoJCX0NCg0KCQlpZiAoIGluZGV4ICE9PSBuYW1lICkgew0KCQkJcHJvcHNbIG5hbWUgXSA9IHZhbHVlOw0KCQkJZGVsZXRlIHByb3BzWyBpbmRleCBdOw0KCQl9DQoNCgkJaG9va3MgPSBqUXVlcnkuY3NzSG9va3NbIG5hbWUgXTsNCgkJaWYgKCBob29rcyAmJiAiZXhwYW5kIiBpbiBob29rcyApIHsNCgkJCXZhbHVlID0gaG9va3MuZXhwYW5kKCB2YWx1ZSApOw0KCQkJZGVsZXRlIHByb3BzWyBuYW1lIF07DQoNCgkJCS8vIG5vdCBxdWl0ZSAkLmV4dGVuZCwgdGhpcyB3b250IG92ZXJ3cml0ZSBrZXlzIGFscmVhZHkgcHJlc2VudC4NCgkJCS8vIGFsc28gLSByZXVzaW5nICdpbmRleCcgZnJvbSBhYm92ZSBiZWNhdXNlIHdlIGhhdmUgdGhlIGNvcnJlY3QgIm5hbWUiDQoJCQlmb3IgKCBpbmRleCBpbiB2YWx1ZSApIHsNCgkJCQlpZiAoICEoIGluZGV4IGluIHByb3BzICkgKSB7DQoJCQkJCXByb3BzWyBpbmRleCBdID0gdmFsdWVbIGluZGV4IF07DQoJCQkJCXNwZWNpYWxFYXNpbmdbIGluZGV4IF0gPSBlYXNpbmc7DQoJCQkJfQ0KCQkJfQ0KCQl9IGVsc2Ugew0KCQkJc3BlY2lhbEVhc2luZ1sgbmFtZSBdID0gZWFzaW5nOw0KCQl9DQoJfQ0KfQ0KDQpqUXVlcnkuQW5pbWF0aW9uID0galF1ZXJ5LmV4dGVuZCggQW5pbWF0aW9uLCB7DQoNCgl0d2VlbmVyOiBmdW5jdGlvbiggcHJvcHMsIGNhbGxiYWNrICkgew0KCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBwcm9wcyApICkgew0KCQkJY2FsbGJhY2sgPSBwcm9wczsNCgkJCXByb3BzID0gWyAiKiIgXTsNCgkJfSBlbHNlIHsNCgkJCXByb3BzID0gcHJvcHMuc3BsaXQoIiAiKTsNCgkJfQ0KDQoJCXZhciBwcm9wLA0KCQkJaW5kZXggPSAwLA0KCQkJbGVuZ3RoID0gcHJvcHMubGVuZ3RoOw0KDQoJCWZvciAoIDsgaW5kZXggPCBsZW5ndGggOyBpbmRleCsrICkgew0KCQkJcHJvcCA9IHByb3BzWyBpbmRleCBdOw0KCQkJdHdlZW5lcnNbIHByb3AgXSA9IHR3ZWVuZXJzWyBwcm9wIF0gfHwgW107DQoJCQl0d2VlbmVyc1sgcHJvcCBdLnVuc2hpZnQoIGNhbGxiYWNrICk7DQoJCX0NCgl9LA0KDQoJcHJlZmlsdGVyOiBmdW5jdGlvbiggY2FsbGJhY2ssIHByZXBlbmQgKSB7DQoJCWlmICggcHJlcGVuZCApIHsNCgkJCWFuaW1hdGlvblByZWZpbHRlcnMudW5zaGlmdCggY2FsbGJhY2sgKTsNCgkJfSBlbHNlIHsNCgkJCWFuaW1hdGlvblByZWZpbHRlcnMucHVzaCggY2FsbGJhY2sgKTsNCgkJfQ0KCX0NCn0pOw0KDQpmdW5jdGlvbiBkZWZhdWx0UHJlZmlsdGVyKCBlbGVtLCBwcm9wcywgb3B0cyApIHsNCgkvKiBqc2hpbnQgdmFsaWR0aGlzOiB0cnVlICovDQoJdmFyIHByb3AsIHZhbHVlLCB0b2dnbGUsIHR3ZWVuLCBob29rcywgb2xkZmlyZSwNCgkJYW5pbSA9IHRoaXMsDQoJCW9yaWcgPSB7fSwNCgkJc3R5bGUgPSBlbGVtLnN0eWxlLA0KCQloaWRkZW4gPSBlbGVtLm5vZGVUeXBlICYmIGlzSGlkZGVuKCBlbGVtICksDQoJCWRhdGFTaG93ID0galF1ZXJ5Ll9kYXRhKCBlbGVtLCAiZnhzaG93IiApOw0KDQoJLy8gaGFuZGxlIHF1ZXVlOiBmYWxzZSBwcm9taXNlcw0KCWlmICggIW9wdHMucXVldWUgKSB7DQoJCWhvb2tzID0galF1ZXJ5Ll9xdWV1ZUhvb2tzKCBlbGVtLCAiZngiICk7DQoJCWlmICggaG9va3MudW5xdWV1ZWQgPT0gbnVsbCApIHsNCgkJCWhvb2tzLnVucXVldWVkID0gMDsNCgkJCW9sZGZpcmUgPSBob29rcy5lbXB0eS5maXJlOw0KCQkJaG9va3MuZW1wdHkuZmlyZSA9IGZ1bmN0aW9uKCkgew0KCQkJCWlmICggIWhvb2tzLnVucXVldWVkICkgew0KCQkJCQlvbGRmaXJlKCk7DQoJCQkJfQ0KCQkJfTsNCgkJfQ0KCQlob29rcy51bnF1ZXVlZCsrOw0KDQoJCWFuaW0uYWx3YXlzKGZ1bmN0aW9uKCkgew0KCQkJLy8gZG9pbmcgdGhpcyBtYWtlcyBzdXJlIHRoYXQgdGhlIGNvbXBsZXRlIGhhbmRsZXIgd2lsbCBiZSBjYWxsZWQNCgkJCS8vIGJlZm9yZSB0aGlzIGNvbXBsZXRlcw0KCQkJYW5pbS5hbHdheXMoZnVuY3Rpb24oKSB7DQoJCQkJaG9va3MudW5xdWV1ZWQtLTsNCgkJCQlpZiAoICFqUXVlcnkucXVldWUoIGVsZW0sICJmeCIgKS5sZW5ndGggKSB7DQoJCQkJCWhvb2tzLmVtcHR5LmZpcmUoKTsNCgkJCQl9DQoJCQl9KTsNCgkJfSk7DQoJfQ0KDQoJLy8gaGVpZ2h0L3dpZHRoIG92ZXJmbG93IHBhc3MNCglpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgKCAiaGVpZ2h0IiBpbiBwcm9wcyB8fCAid2lkdGgiIGluIHByb3BzICkgKSB7DQoJCS8vIE1ha2Ugc3VyZSB0aGF0IG5vdGhpbmcgc25lYWtzIG91dA0KCQkvLyBSZWNvcmQgYWxsIDMgb3ZlcmZsb3cgYXR0cmlidXRlcyBiZWNhdXNlIElFIGRvZXMgbm90DQoJCS8vIGNoYW5nZSB0aGUgb3ZlcmZsb3cgYXR0cmlidXRlIHdoZW4gb3ZlcmZsb3dYIGFuZA0KCQkvLyBvdmVyZmxvd1kgYXJlIHNldCB0byB0aGUgc2FtZSB2YWx1ZQ0KCQlvcHRzLm92ZXJmbG93ID0gWyBzdHlsZS5vdmVyZmxvdywgc3R5bGUub3ZlcmZsb3dYLCBzdHlsZS5vdmVyZmxvd1kgXTsNCg0KCQkvLyBTZXQgZGlzcGxheSBwcm9wZXJ0eSB0byBpbmxpbmUtYmxvY2sgZm9yIGhlaWdodC93aWR0aA0KCQkvLyBhbmltYXRpb25zIG9uIGlubGluZSBlbGVtZW50cyB0aGF0IGFyZSBoYXZpbmcgd2lkdGgvaGVpZ2h0IGFuaW1hdGVkDQoJCWlmICggalF1ZXJ5LmNzcyggZWxlbSwgImRpc3BsYXkiICkgPT09ICJpbmxpbmUiICYmDQoJCQkJalF1ZXJ5LmNzcyggZWxlbSwgImZsb2F0IiApID09PSAibm9uZSIgKSB7DQoNCgkJCS8vIGlubGluZS1sZXZlbCBlbGVtZW50cyBhY2NlcHQgaW5saW5lLWJsb2NrOw0KCQkJLy8gYmxvY2stbGV2ZWwgZWxlbWVudHMgbmVlZCB0byBiZSBpbmxpbmUgd2l0aCBsYXlvdXQNCgkJCWlmICggIWpRdWVyeS5zdXBwb3J0LmlubGluZUJsb2NrTmVlZHNMYXlvdXQgfHwgY3NzX2RlZmF1bHREaXNwbGF5KCBlbGVtLm5vZGVOYW1lICkgPT09ICJpbmxpbmUiICkgew0KCQkJCXN0eWxlLmRpc3BsYXkgPSAiaW5saW5lLWJsb2NrIjsNCg0KCQkJfSBlbHNlIHsNCgkJCQlzdHlsZS56b29tID0gMTsNCgkJCX0NCgkJfQ0KCX0NCg0KCWlmICggb3B0cy5vdmVyZmxvdyApIHsNCgkJc3R5bGUub3ZlcmZsb3cgPSAiaGlkZGVuIjsNCgkJaWYgKCAhalF1ZXJ5LnN1cHBvcnQuc2hyaW5rV3JhcEJsb2NrcyApIHsNCgkJCWFuaW0uYWx3YXlzKGZ1bmN0aW9uKCkgew0KCQkJCXN0eWxlLm92ZXJmbG93ID0gb3B0cy5vdmVyZmxvd1sgMCBdOw0KCQkJCXN0eWxlLm92ZXJmbG93WCA9IG9wdHMub3ZlcmZsb3dbIDEgXTsNCgkJCQlzdHlsZS5vdmVyZmxvd1kgPSBvcHRzLm92ZXJmbG93WyAyIF07DQoJCQl9KTsNCgkJfQ0KCX0NCg0KDQoJLy8gc2hvdy9oaWRlIHBhc3MNCglmb3IgKCBwcm9wIGluIHByb3BzICkgew0KCQl2YWx1ZSA9IHByb3BzWyBwcm9wIF07DQoJCWlmICggcmZ4dHlwZXMuZXhlYyggdmFsdWUgKSApIHsNCgkJCWRlbGV0ZSBwcm9wc1sgcHJvcCBdOw0KCQkJdG9nZ2xlID0gdG9nZ2xlIHx8IHZhbHVlID09PSAidG9nZ2xlIjsNCgkJCWlmICggdmFsdWUgPT09ICggaGlkZGVuID8gImhpZGUiIDogInNob3ciICkgKSB7DQoJCQkJY29udGludWU7DQoJCQl9DQoJCQlvcmlnWyBwcm9wIF0gPSBkYXRhU2hvdyAmJiBkYXRhU2hvd1sgcHJvcCBdIHx8IGpRdWVyeS5zdHlsZSggZWxlbSwgcHJvcCApOw0KCQl9DQoJfQ0KDQoJaWYgKCAhalF1ZXJ5LmlzRW1wdHlPYmplY3QoIG9yaWcgKSApIHsNCgkJaWYgKCBkYXRhU2hvdyApIHsNCgkJCWlmICggImhpZGRlbiIgaW4gZGF0YVNob3cgKSB7DQoJCQkJaGlkZGVuID0gZGF0YVNob3cuaGlkZGVuOw0KCQkJfQ0KCQl9IGVsc2Ugew0KCQkJZGF0YVNob3cgPSBqUXVlcnkuX2RhdGEoIGVsZW0sICJmeHNob3ciLCB7fSApOw0KCQl9DQoNCgkJLy8gc3RvcmUgc3RhdGUgaWYgaXRzIHRvZ2dsZSAtIGVuYWJsZXMgLnN0b3AoKS50b2dnbGUoKSB0byAicmV2ZXJzZSINCgkJaWYgKCB0b2dnbGUgKSB7DQoJCQlkYXRhU2hvdy5oaWRkZW4gPSAhaGlkZGVuOw0KCQl9DQoJCWlmICggaGlkZGVuICkgew0KCQkJalF1ZXJ5KCBlbGVtICkuc2hvdygpOw0KCQl9IGVsc2Ugew0KCQkJYW5pbS5kb25lKGZ1bmN0aW9uKCkgew0KCQkJCWpRdWVyeSggZWxlbSApLmhpZGUoKTsNCgkJCX0pOw0KCQl9DQoJCWFuaW0uZG9uZShmdW5jdGlvbigpIHsNCgkJCXZhciBwcm9wOw0KCQkJalF1ZXJ5Ll9yZW1vdmVEYXRhKCBlbGVtLCAiZnhzaG93IiApOw0KCQkJZm9yICggcHJvcCBpbiBvcmlnICkgew0KCQkJCWpRdWVyeS5zdHlsZSggZWxlbSwgcHJvcCwgb3JpZ1sgcHJvcCBdICk7DQoJCQl9DQoJCX0pOw0KCQlmb3IgKCBwcm9wIGluIG9yaWcgKSB7DQoJCQl0d2VlbiA9IGNyZWF0ZVR3ZWVuKCBoaWRkZW4gPyBkYXRhU2hvd1sgcHJvcCBdIDogMCwgcHJvcCwgYW5pbSApOw0KDQoJCQlpZiAoICEoIHByb3AgaW4gZGF0YVNob3cgKSApIHsNCgkJCQlkYXRhU2hvd1sgcHJvcCBdID0gdHdlZW4uc3RhcnQ7DQoJCQkJaWYgKCBoaWRkZW4gKSB7DQoJCQkJCXR3ZWVuLmVuZCA9IHR3ZWVuLnN0YXJ0Ow0KCQkJCQl0d2Vlbi5zdGFydCA9IHByb3AgPT09ICJ3aWR0aCIgfHwgcHJvcCA9PT0gImhlaWdodCIgPyAxIDogMDsNCgkJCQl9DQoJCQl9DQoJCX0NCgl9DQp9DQoNCmZ1bmN0aW9uIFR3ZWVuKCBlbGVtLCBvcHRpb25zLCBwcm9wLCBlbmQsIGVhc2luZyApIHsNCglyZXR1cm4gbmV3IFR3ZWVuLnByb3RvdHlwZS5pbml0KCBlbGVtLCBvcHRpb25zLCBwcm9wLCBlbmQsIGVhc2luZyApOw0KfQ0KalF1ZXJ5LlR3ZWVuID0gVHdlZW47DQoNClR3ZWVuLnByb3RvdHlwZSA9IHsNCgljb25zdHJ1Y3RvcjogVHdlZW4sDQoJaW5pdDogZnVuY3Rpb24oIGVsZW0sIG9wdGlvbnMsIHByb3AsIGVuZCwgZWFzaW5nLCB1bml0ICkgew0KCQl0aGlzLmVsZW0gPSBlbGVtOw0KCQl0aGlzLnByb3AgPSBwcm9wOw0KCQl0aGlzLmVhc2luZyA9IGVhc2luZyB8fCAic3dpbmciOw0KCQl0aGlzLm9wdGlvbnMgPSBvcHRpb25zOw0KCQl0aGlzLnN0YXJ0ID0gdGhpcy5ub3cgPSB0aGlzLmN1cigpOw0KCQl0aGlzLmVuZCA9IGVuZDsNCgkJdGhpcy51bml0ID0gdW5pdCB8fCAoIGpRdWVyeS5jc3NOdW1iZXJbIHByb3AgXSA/ICIiIDogInB4IiApOw0KCX0sDQoJY3VyOiBmdW5jdGlvbigpIHsNCgkJdmFyIGhvb2tzID0gVHdlZW4ucHJvcEhvb2tzWyB0aGlzLnByb3AgXTsNCg0KCQlyZXR1cm4gaG9va3MgJiYgaG9va3MuZ2V0ID8NCgkJCWhvb2tzLmdldCggdGhpcyApIDoNCgkJCVR3ZWVuLnByb3BIb29rcy5fZGVmYXVsdC5nZXQoIHRoaXMgKTsNCgl9LA0KCXJ1bjogZnVuY3Rpb24oIHBlcmNlbnQgKSB7DQoJCXZhciBlYXNlZCwNCgkJCWhvb2tzID0gVHdlZW4ucHJvcEhvb2tzWyB0aGlzLnByb3AgXTsNCg0KCQlpZiAoIHRoaXMub3B0aW9ucy5kdXJhdGlvbiApIHsNCgkJCXRoaXMucG9zID0gZWFzZWQgPSBqUXVlcnkuZWFzaW5nWyB0aGlzLmVhc2luZyBdKA0KCQkJCXBlcmNlbnQsIHRoaXMub3B0aW9ucy5kdXJhdGlvbiAqIHBlcmNlbnQsIDAsIDEsIHRoaXMub3B0aW9ucy5kdXJhdGlvbg0KCQkJKTsNCgkJfSBlbHNlIHsNCgkJCXRoaXMucG9zID0gZWFzZWQgPSBwZXJjZW50Ow0KCQl9DQoJCXRoaXMubm93ID0gKCB0aGlzLmVuZCAtIHRoaXMuc3RhcnQgKSAqIGVhc2VkICsgdGhpcy5zdGFydDsNCg0KCQlpZiAoIHRoaXMub3B0aW9ucy5zdGVwICkgew0KCQkJdGhpcy5vcHRpb25zLnN0ZXAuY2FsbCggdGhpcy5lbGVtLCB0aGlzLm5vdywgdGhpcyApOw0KCQl9DQoNCgkJaWYgKCBob29rcyAmJiBob29rcy5zZXQgKSB7DQoJCQlob29rcy5zZXQoIHRoaXMgKTsNCgkJfSBlbHNlIHsNCgkJCVR3ZWVuLnByb3BIb29rcy5fZGVmYXVsdC5zZXQoIHRoaXMgKTsNCgkJfQ0KCQlyZXR1cm4gdGhpczsNCgl9DQp9Ow0KDQpUd2Vlbi5wcm90b3R5cGUuaW5pdC5wcm90b3R5cGUgPSBUd2Vlbi5wcm90b3R5cGU7DQoNClR3ZWVuLnByb3BIb29rcyA9IHsNCglfZGVmYXVsdDogew0KCQlnZXQ6IGZ1bmN0aW9uKCB0d2VlbiApIHsNCgkJCXZhciByZXN1bHQ7DQoNCgkJCWlmICggdHdlZW4uZWxlbVsgdHdlZW4ucHJvcCBdICE9IG51bGwgJiYNCgkJCQkoIXR3ZWVuLmVsZW0uc3R5bGUgfHwgdHdlZW4uZWxlbS5zdHlsZVsgdHdlZW4ucHJvcCBdID09IG51bGwpICkgew0KCQkJCXJldHVybiB0d2Vlbi5lbGVtWyB0d2Vlbi5wcm9wIF07DQoJCQl9DQoNCgkJCS8vIHBhc3NpbmcgYW4gZW1wdHkgc3RyaW5nIGFzIGEgM3JkIHBhcmFtZXRlciB0byAuY3NzIHdpbGwgYXV0b21hdGljYWxseQ0KCQkJLy8gYXR0ZW1wdCBhIHBhcnNlRmxvYXQgYW5kIGZhbGxiYWNrIHRvIGEgc3RyaW5nIGlmIHRoZSBwYXJzZSBmYWlscw0KCQkJLy8gc28sIHNpbXBsZSB2YWx1ZXMgc3VjaCBhcyAiMTBweCIgYXJlIHBhcnNlZCB0byBGbG9hdC4NCgkJCS8vIGNvbXBsZXggdmFsdWVzIHN1Y2ggYXMgInJvdGF0ZSgxcmFkKSIgYXJlIHJldHVybmVkIGFzIGlzLg0KCQkJcmVzdWx0ID0galF1ZXJ5LmNzcyggdHdlZW4uZWxlbSwgdHdlZW4ucHJvcCwgIiIgKTsNCgkJCS8vIEVtcHR5IHN0cmluZ3MsIG51bGwsIHVuZGVmaW5lZCBhbmQgImF1dG8iIGFyZSBjb252ZXJ0ZWQgdG8gMC4NCgkJCXJldHVybiAhcmVzdWx0IHx8IHJlc3VsdCA9PT0gImF1dG8iID8gMCA6IHJlc3VsdDsNCgkJfSwNCgkJc2V0OiBmdW5jdGlvbiggdHdlZW4gKSB7DQoJCQkvLyB1c2Ugc3RlcCBob29rIGZvciBiYWNrIGNvbXBhdCAtIHVzZSBjc3NIb29rIGlmIGl0cyB0aGVyZSAtIHVzZSAuc3R5bGUgaWYgaXRzDQoJCQkvLyBhdmFpbGFibGUgYW5kIHVzZSBwbGFpbiBwcm9wZXJ0aWVzIHdoZXJlIGF2YWlsYWJsZQ0KCQkJaWYgKCBqUXVlcnkuZnguc3RlcFsgdHdlZW4ucHJvcCBdICkgew0KCQkJCWpRdWVyeS5meC5zdGVwWyB0d2Vlbi5wcm9wIF0oIHR3ZWVuICk7DQoJCQl9IGVsc2UgaWYgKCB0d2Vlbi5lbGVtLnN0eWxlICYmICggdHdlZW4uZWxlbS5zdHlsZVsgalF1ZXJ5LmNzc1Byb3BzWyB0d2Vlbi5wcm9wIF0gXSAhPSBudWxsIHx8IGpRdWVyeS5jc3NIb29rc1sgdHdlZW4ucHJvcCBdICkgKSB7DQoJCQkJalF1ZXJ5LnN0eWxlKCB0d2Vlbi5lbGVtLCB0d2Vlbi5wcm9wLCB0d2Vlbi5ub3cgKyB0d2Vlbi51bml0ICk7DQoJCQl9IGVsc2Ugew0KCQkJCXR3ZWVuLmVsZW1bIHR3ZWVuLnByb3AgXSA9IHR3ZWVuLm5vdzsNCgkJCX0NCgkJfQ0KCX0NCn07DQoNCi8vIFN1cHBvcnQ6IElFIDw9OQ0KLy8gUGFuaWMgYmFzZWQgYXBwcm9hY2ggdG8gc2V0dGluZyB0aGluZ3Mgb24gZGlzY29ubmVjdGVkIG5vZGVzDQoNClR3ZWVuLnByb3BIb29rcy5zY3JvbGxUb3AgPSBUd2Vlbi5wcm9wSG9va3Muc2Nyb2xsTGVmdCA9IHsNCglzZXQ6IGZ1bmN0aW9uKCB0d2VlbiApIHsNCgkJaWYgKCB0d2Vlbi5lbGVtLm5vZGVUeXBlICYmIHR3ZWVuLmVsZW0ucGFyZW50Tm9kZSApIHsNCgkJCXR3ZWVuLmVsZW1bIHR3ZWVuLnByb3AgXSA9IHR3ZWVuLm5vdzsNCgkJfQ0KCX0NCn07DQoNCmpRdWVyeS5lYWNoKFsgInRvZ2dsZSIsICJzaG93IiwgImhpZGUiIF0sIGZ1bmN0aW9uKCBpLCBuYW1lICkgew0KCXZhciBjc3NGbiA9IGpRdWVyeS5mblsgbmFtZSBdOw0KCWpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICkgew0KCQlyZXR1cm4gc3BlZWQgPT0gbnVsbCB8fCB0eXBlb2Ygc3BlZWQgPT09ICJib29sZWFuIiA/DQoJCQljc3NGbi5hcHBseSggdGhpcywgYXJndW1lbnRzICkgOg0KCQkJdGhpcy5hbmltYXRlKCBnZW5GeCggbmFtZSwgdHJ1ZSApLCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApOw0KCX07DQp9KTsNCg0KalF1ZXJ5LmZuLmV4dGVuZCh7DQoJZmFkZVRvOiBmdW5jdGlvbiggc3BlZWQsIHRvLCBlYXNpbmcsIGNhbGxiYWNrICkgew0KDQoJCS8vIHNob3cgYW55IGhpZGRlbiBlbGVtZW50cyBhZnRlciBzZXR0aW5nIG9wYWNpdHkgdG8gMA0KCQlyZXR1cm4gdGhpcy5maWx0ZXIoIGlzSGlkZGVuICkuY3NzKCAib3BhY2l0eSIsIDAgKS5zaG93KCkNCg0KCQkJLy8gYW5pbWF0ZSB0byB0aGUgdmFsdWUgc3BlY2lmaWVkDQoJCQkuZW5kKCkuYW5pbWF0ZSh7IG9wYWNpdHk6IHRvIH0sIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICk7DQoJfSwNCglhbmltYXRlOiBmdW5jdGlvbiggcHJvcCwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKSB7DQoJCXZhciBlbXB0eSA9IGpRdWVyeS5pc0VtcHR5T2JqZWN0KCBwcm9wICksDQoJCQlvcHRhbGwgPSBqUXVlcnkuc3BlZWQoIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICksDQoJCQlkb0FuaW1hdGlvbiA9IGZ1bmN0aW9uKCkgew0KCQkJCS8vIE9wZXJhdGUgb24gYSBjb3B5IG9mIHByb3Agc28gcGVyLXByb3BlcnR5IGVhc2luZyB3b24ndCBiZSBsb3N0DQoJCQkJdmFyIGFuaW0gPSBBbmltYXRpb24oIHRoaXMsIGpRdWVyeS5leHRlbmQoIHt9LCBwcm9wICksIG9wdGFsbCApOw0KDQoJCQkJLy8gRW1wdHkgYW5pbWF0aW9ucywgb3IgZmluaXNoaW5nIHJlc29sdmVzIGltbWVkaWF0ZWx5DQoJCQkJaWYgKCBlbXB0eSB8fCBqUXVlcnkuX2RhdGEoIHRoaXMsICJmaW5pc2giICkgKSB7DQoJCQkJCWFuaW0uc3RvcCggdHJ1ZSApOw0KCQkJCX0NCgkJCX07DQoJCQlkb0FuaW1hdGlvbi5maW5pc2ggPSBkb0FuaW1hdGlvbjsNCg0KCQlyZXR1cm4gZW1wdHkgfHwgb3B0YWxsLnF1ZXVlID09PSBmYWxzZSA/DQoJCQl0aGlzLmVhY2goIGRvQW5pbWF0aW9uICkgOg0KCQkJdGhpcy5xdWV1ZSggb3B0YWxsLnF1ZXVlLCBkb0FuaW1hdGlvbiApOw0KCX0sDQoJc3RvcDogZnVuY3Rpb24oIHR5cGUsIGNsZWFyUXVldWUsIGdvdG9FbmQgKSB7DQoJCXZhciBzdG9wUXVldWUgPSBmdW5jdGlvbiggaG9va3MgKSB7DQoJCQl2YXIgc3RvcCA9IGhvb2tzLnN0b3A7DQoJCQlkZWxldGUgaG9va3Muc3RvcDsNCgkJCXN0b3AoIGdvdG9FbmQgKTsNCgkJfTsNCg0KCQlpZiAoIHR5cGVvZiB0eXBlICE9PSAic3RyaW5nIiApIHsNCgkJCWdvdG9FbmQgPSBjbGVhclF1ZXVlOw0KCQkJY2xlYXJRdWV1ZSA9IHR5cGU7DQoJCQl0eXBlID0gdW5kZWZpbmVkOw0KCQl9DQoJCWlmICggY2xlYXJRdWV1ZSAmJiB0eXBlICE9PSBmYWxzZSApIHsNCgkJCXRoaXMucXVldWUoIHR5cGUgfHwgImZ4IiwgW10gKTsNCgkJfQ0KDQoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7DQoJCQl2YXIgZGVxdWV1ZSA9IHRydWUsDQoJCQkJaW5kZXggPSB0eXBlICE9IG51bGwgJiYgdHlwZSArICJxdWV1ZUhvb2tzIiwNCgkJCQl0aW1lcnMgPSBqUXVlcnkudGltZXJzLA0KCQkJCWRhdGEgPSBqUXVlcnkuX2RhdGEoIHRoaXMgKTsNCg0KCQkJaWYgKCBpbmRleCApIHsNCgkJCQlpZiAoIGRhdGFbIGluZGV4IF0gJiYgZGF0YVsgaW5kZXggXS5zdG9wICkgew0KCQkJCQlzdG9wUXVldWUoIGRhdGFbIGluZGV4IF0gKTsNCgkJCQl9DQoJCQl9IGVsc2Ugew0KCQkJCWZvciAoIGluZGV4IGluIGRhdGEgKSB7DQoJCQkJCWlmICggZGF0YVsgaW5kZXggXSAmJiBkYXRhWyBpbmRleCBdLnN0b3AgJiYgcnJ1bi50ZXN0KCBpbmRleCApICkgew0KCQkJCQkJc3RvcFF1ZXVlKCBkYXRhWyBpbmRleCBdICk7DQoJCQkJCX0NCgkJCQl9DQoJCQl9DQoNCgkJCWZvciAoIGluZGV4ID0gdGltZXJzLmxlbmd0aDsgaW5kZXgtLTsgKSB7DQoJCQkJaWYgKCB0aW1lcnNbIGluZGV4IF0uZWxlbSA9PT0gdGhpcyAmJiAodHlwZSA9PSBudWxsIHx8IHRpbWVyc1sgaW5kZXggXS5xdWV1ZSA9PT0gdHlwZSkgKSB7DQoJCQkJCXRpbWVyc1sgaW5kZXggXS5hbmltLnN0b3AoIGdvdG9FbmQgKTsNCgkJCQkJZGVxdWV1ZSA9IGZhbHNlOw0KCQkJCQl0aW1lcnMuc3BsaWNlKCBpbmRleCwgMSApOw0KCQkJCX0NCgkJCX0NCg0KCQkJLy8gc3RhcnQgdGhlIG5leHQgaW4gdGhlIHF1ZXVlIGlmIHRoZSBsYXN0IHN0ZXAgd2Fzbid0IGZvcmNlZA0KCQkJLy8gdGltZXJzIGN1cnJlbnRseSB3aWxsIGNhbGwgdGhlaXIgY29tcGxldGUgY2FsbGJhY2tzLCB3aGljaCB3aWxsIGRlcXVldWUNCgkJCS8vIGJ1dCBvbmx5IGlmIHRoZXkgd2VyZSBnb3RvRW5kDQoJCQlpZiAoIGRlcXVldWUgfHwgIWdvdG9FbmQgKSB7DQoJCQkJalF1ZXJ5LmRlcXVldWUoIHRoaXMsIHR5cGUgKTsNCgkJCX0NCgkJfSk7DQoJfSwNCglmaW5pc2g6IGZ1bmN0aW9uKCB0eXBlICkgew0KCQlpZiAoIHR5cGUgIT09IGZhbHNlICkgew0KCQkJdHlwZSA9IHR5cGUgfHwgImZ4IjsNCgkJfQ0KCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgew0KCQkJdmFyIGluZGV4LA0KCQkJCWRhdGEgPSBqUXVlcnkuX2RhdGEoIHRoaXMgKSwNCgkJCQlxdWV1ZSA9IGRhdGFbIHR5cGUgKyAicXVldWUiIF0sDQoJCQkJaG9va3MgPSBkYXRhWyB0eXBlICsgInF1ZXVlSG9va3MiIF0sDQoJCQkJdGltZXJzID0galF1ZXJ5LnRpbWVycywNCgkJCQlsZW5ndGggPSBxdWV1ZSA/IHF1ZXVlLmxlbmd0aCA6IDA7DQoNCgkJCS8vIGVuYWJsZSBmaW5pc2hpbmcgZmxhZyBvbiBwcml2YXRlIGRhdGENCgkJCWRhdGEuZmluaXNoID0gdHJ1ZTsNCg0KCQkJLy8gZW1wdHkgdGhlIHF1ZXVlIGZpcnN0DQoJCQlqUXVlcnkucXVldWUoIHRoaXMsIHR5cGUsIFtdICk7DQoNCgkJCWlmICggaG9va3MgJiYgaG9va3Muc3RvcCApIHsNCgkJCQlob29rcy5zdG9wLmNhbGwoIHRoaXMsIHRydWUgKTsNCgkJCX0NCg0KCQkJLy8gbG9vayBmb3IgYW55IGFjdGl2ZSBhbmltYXRpb25zLCBhbmQgZmluaXNoIHRoZW0NCgkJCWZvciAoIGluZGV4ID0gdGltZXJzLmxlbmd0aDsgaW5kZXgtLTsgKSB7DQoJCQkJaWYgKCB0aW1lcnNbIGluZGV4IF0uZWxlbSA9PT0gdGhpcyAmJiB0aW1lcnNbIGluZGV4IF0ucXVldWUgPT09IHR5cGUgKSB7DQoJCQkJCXRpbWVyc1sgaW5kZXggXS5hbmltLnN0b3AoIHRydWUgKTsNCgkJCQkJdGltZXJzLnNwbGljZSggaW5kZXgsIDEgKTsNCgkJCQl9DQoJCQl9DQoNCgkJCS8vIGxvb2sgZm9yIGFueSBhbmltYXRpb25zIGluIHRoZSBvbGQgcXVldWUgYW5kIGZpbmlzaCB0aGVtDQoJCQlmb3IgKCBpbmRleCA9IDA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrICkgew0KCQkJCWlmICggcXVldWVbIGluZGV4IF0gJiYgcXVldWVbIGluZGV4IF0uZmluaXNoICkgew0KCQkJCQlxdWV1ZVsgaW5kZXggXS5maW5pc2guY2FsbCggdGhpcyApOw0KCQkJCX0NCgkJCX0NCg0KCQkJLy8gdHVybiBvZmYgZmluaXNoaW5nIGZsYWcNCgkJCWRlbGV0ZSBkYXRhLmZpbmlzaDsNCgkJfSk7DQoJfQ0KfSk7DQoNCi8vIEdlbmVyYXRlIHBhcmFtZXRlcnMgdG8gY3JlYXRlIGEgc3RhbmRhcmQgYW5pbWF0aW9uDQpmdW5jdGlvbiBnZW5GeCggdHlwZSwgaW5jbHVkZVdpZHRoICkgew0KCXZhciB3aGljaCwNCgkJYXR0cnMgPSB7IGhlaWdodDogdHlwZSB9LA0KCQlpID0gMDsNCg0KCS8vIGlmIHdlIGluY2x1ZGUgd2lkdGgsIHN0ZXAgdmFsdWUgaXMgMSB0byBkbyBhbGwgY3NzRXhwYW5kIHZhbHVlcywNCgkvLyBpZiB3ZSBkb24ndCBpbmNsdWRlIHdpZHRoLCBzdGVwIHZhbHVlIGlzIDIgdG8gc2tpcCBvdmVyIExlZnQgYW5kIFJpZ2h0DQoJaW5jbHVkZVdpZHRoID0gaW5jbHVkZVdpZHRoPyAxIDogMDsNCglmb3IoIDsgaSA8IDQgOyBpICs9IDIgLSBpbmNsdWRlV2lkdGggKSB7DQoJCXdoaWNoID0gY3NzRXhwYW5kWyBpIF07DQoJCWF0dHJzWyAibWFyZ2luIiArIHdoaWNoIF0gPSBhdHRyc1sgInBhZGRpbmciICsgd2hpY2ggXSA9IHR5cGU7DQoJfQ0KDQoJaWYgKCBpbmNsdWRlV2lkdGggKSB7DQoJCWF0dHJzLm9wYWNpdHkgPSBhdHRycy53aWR0aCA9IHR5cGU7DQoJfQ0KDQoJcmV0dXJuIGF0dHJzOw0KfQ0KDQovLyBHZW5lcmF0ZSBzaG9ydGN1dHMgZm9yIGN1c3RvbSBhbmltYXRpb25zDQpqUXVlcnkuZWFjaCh7DQoJc2xpZGVEb3duOiBnZW5GeCgic2hvdyIpLA0KCXNsaWRlVXA6IGdlbkZ4KCJoaWRlIiksDQoJc2xpZGVUb2dnbGU6IGdlbkZ4KCJ0b2dnbGUiKSwNCglmYWRlSW46IHsgb3BhY2l0eTogInNob3ciIH0sDQoJZmFkZU91dDogeyBvcGFjaXR5OiAiaGlkZSIgfSwNCglmYWRlVG9nZ2xlOiB7IG9wYWNpdHk6ICJ0b2dnbGUiIH0NCn0sIGZ1bmN0aW9uKCBuYW1lLCBwcm9wcyApIHsNCglqUXVlcnkuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApIHsNCgkJcmV0dXJuIHRoaXMuYW5pbWF0ZSggcHJvcHMsIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICk7DQoJfTsNCn0pOw0KDQpqUXVlcnkuc3BlZWQgPSBmdW5jdGlvbiggc3BlZWQsIGVhc2luZywgZm4gKSB7DQoJdmFyIG9wdCA9IHNwZWVkICYmIHR5cGVvZiBzcGVlZCA9PT0gIm9iamVjdCIgPyBqUXVlcnkuZXh0ZW5kKCB7fSwgc3BlZWQgKSA6IHsNCgkJY29tcGxldGU6IGZuIHx8ICFmbiAmJiBlYXNpbmcgfHwNCgkJCWpRdWVyeS5pc0Z1bmN0aW9uKCBzcGVlZCApICYmIHNwZWVkLA0KCQlkdXJhdGlvbjogc3BlZWQsDQoJCWVhc2luZzogZm4gJiYgZWFzaW5nIHx8IGVhc2luZyAmJiAhalF1ZXJ5LmlzRnVuY3Rpb24oIGVhc2luZyApICYmIGVhc2luZw0KCX07DQoNCglvcHQuZHVyYXRpb24gPSBqUXVlcnkuZngub2ZmID8gMCA6IHR5cGVvZiBvcHQuZHVyYXRpb24gPT09ICJudW1iZXIiID8gb3B0LmR1cmF0aW9uIDoNCgkJb3B0LmR1cmF0aW9uIGluIGpRdWVyeS5meC5zcGVlZHMgPyBqUXVlcnkuZnguc3BlZWRzWyBvcHQuZHVyYXRpb24gXSA6IGpRdWVyeS5meC5zcGVlZHMuX2RlZmF1bHQ7DQoNCgkvLyBub3JtYWxpemUgb3B0LnF1ZXVlIC0gdHJ1ZS91bmRlZmluZWQvbnVsbCAtPiAiZngiDQoJaWYgKCBvcHQucXVldWUgPT0gbnVsbCB8fCBvcHQucXVldWUgPT09IHRydWUgKSB7DQoJCW9wdC5xdWV1ZSA9ICJmeCI7DQoJfQ0KDQoJLy8gUXVldWVpbmcNCglvcHQub2xkID0gb3B0LmNvbXBsZXRlOw0KDQoJb3B0LmNvbXBsZXRlID0gZnVuY3Rpb24oKSB7DQoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIG9wdC5vbGQgKSApIHsNCgkJCW9wdC5vbGQuY2FsbCggdGhpcyApOw0KCQl9DQoNCgkJaWYgKCBvcHQucXVldWUgKSB7DQoJCQlqUXVlcnkuZGVxdWV1ZSggdGhpcywgb3B0LnF1ZXVlICk7DQoJCX0NCgl9Ow0KDQoJcmV0dXJuIG9wdDsNCn07DQoNCmpRdWVyeS5lYXNpbmcgPSB7DQoJbGluZWFyOiBmdW5jdGlvbiggcCApIHsNCgkJcmV0dXJuIHA7DQoJfSwNCglzd2luZzogZnVuY3Rpb24oIHAgKSB7DQoJCXJldHVybiAwLjUgLSBNYXRoLmNvcyggcCpNYXRoLlBJICkgLyAyOw0KCX0NCn07DQoNCmpRdWVyeS50aW1lcnMgPSBbXTsNCmpRdWVyeS5meCA9IFR3ZWVuLnByb3RvdHlwZS5pbml0Ow0KalF1ZXJ5LmZ4LnRpY2sgPSBmdW5jdGlvbigpIHsNCgl2YXIgdGltZXIsDQoJCXRpbWVycyA9IGpRdWVyeS50aW1lcnMsDQoJCWkgPSAwOw0KDQoJZnhOb3cgPSBqUXVlcnkubm93KCk7DQoNCglmb3IgKCA7IGkgPCB0aW1lcnMubGVuZ3RoOyBpKysgKSB7DQoJCXRpbWVyID0gdGltZXJzWyBpIF07DQoJCS8vIENoZWNrcyB0aGUgdGltZXIgaGFzIG5vdCBhbHJlYWR5IGJlZW4gcmVtb3ZlZA0KCQlpZiAoICF0aW1lcigpICYmIHRpbWVyc1sgaSBdID09PSB0aW1lciApIHsNCgkJCXRpbWVycy5zcGxpY2UoIGktLSwgMSApOw0KCQl9DQoJfQ0KDQoJaWYgKCAhdGltZXJzLmxlbmd0aCApIHsNCgkJalF1ZXJ5LmZ4LnN0b3AoKTsNCgl9DQoJZnhOb3cgPSB1bmRlZmluZWQ7DQp9Ow0KDQpqUXVlcnkuZngudGltZXIgPSBmdW5jdGlvbiggdGltZXIgKSB7DQoJaWYgKCB0aW1lcigpICYmIGpRdWVyeS50aW1lcnMucHVzaCggdGltZXIgKSApIHsNCgkJalF1ZXJ5LmZ4LnN0YXJ0KCk7DQoJfQ0KfTsNCg0KalF1ZXJ5LmZ4LmludGVydmFsID0gMTM7DQoNCmpRdWVyeS5meC5zdGFydCA9IGZ1bmN0aW9uKCkgew0KCWlmICggIXRpbWVySWQgKSB7DQoJCXRpbWVySWQgPSBzZXRJbnRlcnZhbCggalF1ZXJ5LmZ4LnRpY2ssIGpRdWVyeS5meC5pbnRlcnZhbCApOw0KCX0NCn07DQoNCmpRdWVyeS5meC5zdG9wID0gZnVuY3Rpb24oKSB7DQoJY2xlYXJJbnRlcnZhbCggdGltZXJJZCApOw0KCXRpbWVySWQgPSBudWxsOw0KfTsNCg0KalF1ZXJ5LmZ4LnNwZWVkcyA9IHsNCglzbG93OiA2MDAsDQoJZmFzdDogMjAwLA0KCS8vIERlZmF1bHQgc3BlZWQNCglfZGVmYXVsdDogNDAwDQp9Ow0KDQovLyBCYWNrIENvbXBhdCA8MS44IGV4dGVuc2lvbiBwb2ludA0KalF1ZXJ5LmZ4LnN0ZXAgPSB7fTsNCg0KaWYgKCBqUXVlcnkuZXhwciAmJiBqUXVlcnkuZXhwci5maWx0ZXJzICkgew0KCWpRdWVyeS5leHByLmZpbHRlcnMuYW5pbWF0ZWQgPSBmdW5jdGlvbiggZWxlbSApIHsNCgkJcmV0dXJuIGpRdWVyeS5ncmVwKGpRdWVyeS50aW1lcnMsIGZ1bmN0aW9uKCBmbiApIHsNCgkJCXJldHVybiBlbGVtID09PSBmbi5lbGVtOw0KCQl9KS5sZW5ndGg7DQoJfTsNCn0NCmpRdWVyeS5mbi5vZmZzZXQgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsNCglpZiAoIGFyZ3VtZW50cy5sZW5ndGggKSB7DQoJCXJldHVybiBvcHRpb25zID09PSB1bmRlZmluZWQgPw0KCQkJdGhpcyA6DQoJCQl0aGlzLmVhY2goZnVuY3Rpb24oIGkgKSB7DQoJCQkJalF1ZXJ5Lm9mZnNldC5zZXRPZmZzZXQoIHRoaXMsIG9wdGlvbnMsIGkgKTsNCgkJCX0pOw0KCX0NCg0KCXZhciBkb2NFbGVtLCB3aW4sDQoJCWJveCA9IHsgdG9wOiAwLCBsZWZ0OiAwIH0sDQoJCWVsZW0gPSB0aGlzWyAwIF0sDQoJCWRvYyA9IGVsZW0gJiYgZWxlbS5vd25lckRvY3VtZW50Ow0KDQoJaWYgKCAhZG9jICkgew0KCQlyZXR1cm47DQoJfQ0KDQoJZG9jRWxlbSA9IGRvYy5kb2N1bWVudEVsZW1lbnQ7DQoNCgkvLyBNYWtlIHN1cmUgaXQncyBub3QgYSBkaXNjb25uZWN0ZWQgRE9NIG5vZGUNCglpZiAoICFqUXVlcnkuY29udGFpbnMoIGRvY0VsZW0sIGVsZW0gKSApIHsNCgkJcmV0dXJuIGJveDsNCgl9DQoNCgkvLyBJZiB3ZSBkb24ndCBoYXZlIGdCQ1IsIGp1c3QgdXNlIDAsMCByYXRoZXIgdGhhbiBlcnJvcg0KCS8vIEJsYWNrQmVycnkgNSwgaU9TIDMgKG9yaWdpbmFsIGlQaG9uZSkNCglpZiAoIHR5cGVvZiBlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCAhPT0gY29yZV9zdHJ1bmRlZmluZWQgKSB7DQoJCWJveCA9IGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7DQoJfQ0KCXdpbiA9IGdldFdpbmRvdyggZG9jICk7DQoJcmV0dXJuIHsNCgkJdG9wOiBib3gudG9wICArICggd2luLnBhZ2VZT2Zmc2V0IHx8IGRvY0VsZW0uc2Nyb2xsVG9wICkgIC0gKCBkb2NFbGVtLmNsaWVudFRvcCAgfHwgMCApLA0KCQlsZWZ0OiBib3gubGVmdCArICggd2luLnBhZ2VYT2Zmc2V0IHx8IGRvY0VsZW0uc2Nyb2xsTGVmdCApIC0gKCBkb2NFbGVtLmNsaWVudExlZnQgfHwgMCApDQoJfTsNCn07DQoNCmpRdWVyeS5vZmZzZXQgPSB7DQoNCglzZXRPZmZzZXQ6IGZ1bmN0aW9uKCBlbGVtLCBvcHRpb25zLCBpICkgew0KCQl2YXIgcG9zaXRpb24gPSBqUXVlcnkuY3NzKCBlbGVtLCAicG9zaXRpb24iICk7DQoNCgkJLy8gc2V0IHBvc2l0aW9uIGZpcnN0LCBpbi1jYXNlIHRvcC9sZWZ0IGFyZSBzZXQgZXZlbiBvbiBzdGF0aWMgZWxlbQ0KCQlpZiAoIHBvc2l0aW9uID09PSAic3RhdGljIiApIHsNCgkJCWVsZW0uc3R5bGUucG9zaXRpb24gPSAicmVsYXRpdmUiOw0KCQl9DQoNCgkJdmFyIGN1ckVsZW0gPSBqUXVlcnkoIGVsZW0gKSwNCgkJCWN1ck9mZnNldCA9IGN1ckVsZW0ub2Zmc2V0KCksDQoJCQljdXJDU1NUb3AgPSBqUXVlcnkuY3NzKCBlbGVtLCAidG9wIiApLA0KCQkJY3VyQ1NTTGVmdCA9IGpRdWVyeS5jc3MoIGVsZW0sICJsZWZ0IiApLA0KCQkJY2FsY3VsYXRlUG9zaXRpb24gPSAoIHBvc2l0aW9uID09PSAiYWJzb2x1dGUiIHx8IHBvc2l0aW9uID09PSAiZml4ZWQiICkgJiYgalF1ZXJ5LmluQXJyYXkoImF1dG8iLCBbY3VyQ1NTVG9wLCBjdXJDU1NMZWZ0XSkgPiAtMSwNCgkJCXByb3BzID0ge30sIGN1clBvc2l0aW9uID0ge30sIGN1clRvcCwgY3VyTGVmdDsNCg0KCQkvLyBuZWVkIHRvIGJlIGFibGUgdG8gY2FsY3VsYXRlIHBvc2l0aW9uIGlmIGVpdGhlciB0b3Agb3IgbGVmdCBpcyBhdXRvIGFuZCBwb3NpdGlvbiBpcyBlaXRoZXIgYWJzb2x1dGUgb3IgZml4ZWQNCgkJaWYgKCBjYWxjdWxhdGVQb3NpdGlvbiApIHsNCgkJCWN1clBvc2l0aW9uID0gY3VyRWxlbS5wb3NpdGlvbigpOw0KCQkJY3VyVG9wID0gY3VyUG9zaXRpb24udG9wOw0KCQkJY3VyTGVmdCA9IGN1clBvc2l0aW9uLmxlZnQ7DQoJCX0gZWxzZSB7DQoJCQljdXJUb3AgPSBwYXJzZUZsb2F0KCBjdXJDU1NUb3AgKSB8fCAwOw0KCQkJY3VyTGVmdCA9IHBhcnNlRmxvYXQoIGN1ckNTU0xlZnQgKSB8fCAwOw0KCQl9DQoNCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggb3B0aW9ucyApICkgew0KCQkJb3B0aW9ucyA9IG9wdGlvbnMuY2FsbCggZWxlbSwgaSwgY3VyT2Zmc2V0ICk7DQoJCX0NCg0KCQlpZiAoIG9wdGlvbnMudG9wICE9IG51bGwgKSB7DQoJCQlwcm9wcy50b3AgPSAoIG9wdGlvbnMudG9wIC0gY3VyT2Zmc2V0LnRvcCApICsgY3VyVG9wOw0KCQl9DQoJCWlmICggb3B0aW9ucy5sZWZ0ICE9IG51bGwgKSB7DQoJCQlwcm9wcy5sZWZ0ID0gKCBvcHRpb25zLmxlZnQgLSBjdXJPZmZzZXQubGVmdCApICsgY3VyTGVmdDsNCgkJfQ0KDQoJCWlmICggInVzaW5nIiBpbiBvcHRpb25zICkgew0KCQkJb3B0aW9ucy51c2luZy5jYWxsKCBlbGVtLCBwcm9wcyApOw0KCQl9IGVsc2Ugew0KCQkJY3VyRWxlbS5jc3MoIHByb3BzICk7DQoJCX0NCgl9DQp9Ow0KDQoNCmpRdWVyeS5mbi5leHRlbmQoew0KDQoJcG9zaXRpb246IGZ1bmN0aW9uKCkgew0KCQlpZiAoICF0aGlzWyAwIF0gKSB7DQoJCQlyZXR1cm47DQoJCX0NCg0KCQl2YXIgb2Zmc2V0UGFyZW50LCBvZmZzZXQsDQoJCQlwYXJlbnRPZmZzZXQgPSB7IHRvcDogMCwgbGVmdDogMCB9LA0KCQkJZWxlbSA9IHRoaXNbIDAgXTsNCg0KCQkvLyBmaXhlZCBlbGVtZW50cyBhcmUgb2Zmc2V0IGZyb20gd2luZG93IChwYXJlbnRPZmZzZXQgPSB7dG9wOjAsIGxlZnQ6IDB9LCBiZWNhdXNlIGl0IGlzIGl0J3Mgb25seSBvZmZzZXQgcGFyZW50DQoJCWlmICggalF1ZXJ5LmNzcyggZWxlbSwgInBvc2l0aW9uIiApID09PSAiZml4ZWQiICkgew0KCQkJLy8gd2UgYXNzdW1lIHRoYXQgZ2V0Qm91bmRpbmdDbGllbnRSZWN0IGlzIGF2YWlsYWJsZSB3aGVuIGNvbXB1dGVkIHBvc2l0aW9uIGlzIGZpeGVkDQoJCQlvZmZzZXQgPSBlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOw0KCQl9IGVsc2Ugew0KCQkJLy8gR2V0ICpyZWFsKiBvZmZzZXRQYXJlbnQNCgkJCW9mZnNldFBhcmVudCA9IHRoaXMub2Zmc2V0UGFyZW50KCk7DQoNCgkJCS8vIEdldCBjb3JyZWN0IG9mZnNldHMNCgkJCW9mZnNldCA9IHRoaXMub2Zmc2V0KCk7DQoJCQlpZiAoICFqUXVlcnkubm9kZU5hbWUoIG9mZnNldFBhcmVudFsgMCBdLCAiaHRtbCIgKSApIHsNCgkJCQlwYXJlbnRPZmZzZXQgPSBvZmZzZXRQYXJlbnQub2Zmc2V0KCk7DQoJCQl9DQoNCgkJCS8vIEFkZCBvZmZzZXRQYXJlbnQgYm9yZGVycw0KCQkJcGFyZW50T2Zmc2V0LnRvcCAgKz0galF1ZXJ5LmNzcyggb2Zmc2V0UGFyZW50WyAwIF0sICJib3JkZXJUb3BXaWR0aCIsIHRydWUgKTsNCgkJCXBhcmVudE9mZnNldC5sZWZ0ICs9IGpRdWVyeS5jc3MoIG9mZnNldFBhcmVudFsgMCBdLCAiYm9yZGVyTGVmdFdpZHRoIiwgdHJ1ZSApOw0KCQl9DQoNCgkJLy8gU3VidHJhY3QgcGFyZW50IG9mZnNldHMgYW5kIGVsZW1lbnQgbWFyZ2lucw0KCQkvLyBub3RlOiB3aGVuIGFuIGVsZW1lbnQgaGFzIG1hcmdpbjogYXV0byB0aGUgb2Zmc2V0TGVmdCBhbmQgbWFyZ2luTGVmdA0KCQkvLyBhcmUgdGhlIHNhbWUgaW4gU2FmYXJpIGNhdXNpbmcgb2Zmc2V0LmxlZnQgdG8gaW5jb3JyZWN0bHkgYmUgMA0KCQlyZXR1cm4gew0KCQkJdG9wOiAgb2Zmc2V0LnRvcCAgLSBwYXJlbnRPZmZzZXQudG9wIC0galF1ZXJ5LmNzcyggZWxlbSwgIm1hcmdpblRvcCIsIHRydWUgKSwNCgkJCWxlZnQ6IG9mZnNldC5sZWZ0IC0gcGFyZW50T2Zmc2V0LmxlZnQgLSBqUXVlcnkuY3NzKCBlbGVtLCAibWFyZ2luTGVmdCIsIHRydWUpDQoJCX07DQoJfSwNCg0KCW9mZnNldFBhcmVudDogZnVuY3Rpb24oKSB7DQoJCXJldHVybiB0aGlzLm1hcChmdW5jdGlvbigpIHsNCgkJCXZhciBvZmZzZXRQYXJlbnQgPSB0aGlzLm9mZnNldFBhcmVudCB8fCBkb2NFbGVtOw0KCQkJd2hpbGUgKCBvZmZzZXRQYXJlbnQgJiYgKCAhalF1ZXJ5Lm5vZGVOYW1lKCBvZmZzZXRQYXJlbnQsICJodG1sIiApICYmIGpRdWVyeS5jc3MoIG9mZnNldFBhcmVudCwgInBvc2l0aW9uIikgPT09ICJzdGF0aWMiICkgKSB7DQoJCQkJb2Zmc2V0UGFyZW50ID0gb2Zmc2V0UGFyZW50Lm9mZnNldFBhcmVudDsNCgkJCX0NCgkJCXJldHVybiBvZmZzZXRQYXJlbnQgfHwgZG9jRWxlbTsNCgkJfSk7DQoJfQ0KfSk7DQoNCg0KLy8gQ3JlYXRlIHNjcm9sbExlZnQgYW5kIHNjcm9sbFRvcCBtZXRob2RzDQpqUXVlcnkuZWFjaCgge3Njcm9sbExlZnQ6ICJwYWdlWE9mZnNldCIsIHNjcm9sbFRvcDogInBhZ2VZT2Zmc2V0In0sIGZ1bmN0aW9uKCBtZXRob2QsIHByb3AgKSB7DQoJdmFyIHRvcCA9IC9ZLy50ZXN0KCBwcm9wICk7DQoNCglqUXVlcnkuZm5bIG1ldGhvZCBdID0gZnVuY3Rpb24oIHZhbCApIHsNCgkJcmV0dXJuIGpRdWVyeS5hY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCBlbGVtLCBtZXRob2QsIHZhbCApIHsNCgkJCXZhciB3aW4gPSBnZXRXaW5kb3coIGVsZW0gKTsNCg0KCQkJaWYgKCB2YWwgPT09IHVuZGVmaW5lZCApIHsNCgkJCQlyZXR1cm4gd2luID8gKHByb3AgaW4gd2luKSA/IHdpblsgcHJvcCBdIDoNCgkJCQkJd2luLmRvY3VtZW50LmRvY3VtZW50RWxlbWVudFsgbWV0aG9kIF0gOg0KCQkJCQllbGVtWyBtZXRob2QgXTsNCgkJCX0NCg0KCQkJaWYgKCB3aW4gKSB7DQoJCQkJd2luLnNjcm9sbFRvKA0KCQkJCQkhdG9wID8gdmFsIDogalF1ZXJ5KCB3aW4gKS5zY3JvbGxMZWZ0KCksDQoJCQkJCXRvcCA/IHZhbCA6IGpRdWVyeSggd2luICkuc2Nyb2xsVG9wKCkNCgkJCQkpOw0KDQoJCQl9IGVsc2Ugew0KCQkJCWVsZW1bIG1ldGhvZCBdID0gdmFsOw0KCQkJfQ0KCQl9LCBtZXRob2QsIHZhbCwgYXJndW1lbnRzLmxlbmd0aCwgbnVsbCApOw0KCX07DQp9KTsNCg0KZnVuY3Rpb24gZ2V0V2luZG93KCBlbGVtICkgew0KCXJldHVybiBqUXVlcnkuaXNXaW5kb3coIGVsZW0gKSA/DQoJCWVsZW0gOg0KCQllbGVtLm5vZGVUeXBlID09PSA5ID8NCgkJCWVsZW0uZGVmYXVsdFZpZXcgfHwgZWxlbS5wYXJlbnRXaW5kb3cgOg0KCQkJZmFsc2U7DQp9DQovLyBDcmVhdGUgaW5uZXJIZWlnaHQsIGlubmVyV2lkdGgsIGhlaWdodCwgd2lkdGgsIG91dGVySGVpZ2h0IGFuZCBvdXRlcldpZHRoIG1ldGhvZHMNCmpRdWVyeS5lYWNoKCB7IEhlaWdodDogImhlaWdodCIsIFdpZHRoOiAid2lkdGgiIH0sIGZ1bmN0aW9uKCBuYW1lLCB0eXBlICkgew0KCWpRdWVyeS5lYWNoKCB7IHBhZGRpbmc6ICJpbm5lciIgKyBuYW1lLCBjb250ZW50OiB0eXBlLCAiIjogIm91dGVyIiArIG5hbWUgfSwgZnVuY3Rpb24oIGRlZmF1bHRFeHRyYSwgZnVuY05hbWUgKSB7DQoJCS8vIG1hcmdpbiBpcyBvbmx5IGZvciBvdXRlckhlaWdodCwgb3V0ZXJXaWR0aA0KCQlqUXVlcnkuZm5bIGZ1bmNOYW1lIF0gPSBmdW5jdGlvbiggbWFyZ2luLCB2YWx1ZSApIHsNCgkJCXZhciBjaGFpbmFibGUgPSBhcmd1bWVudHMubGVuZ3RoICYmICggZGVmYXVsdEV4dHJhIHx8IHR5cGVvZiBtYXJnaW4gIT09ICJib29sZWFuIiApLA0KCQkJCWV4dHJhID0gZGVmYXVsdEV4dHJhIHx8ICggbWFyZ2luID09PSB0cnVlIHx8IHZhbHVlID09PSB0cnVlID8gIm1hcmdpbiIgOiAiYm9yZGVyIiApOw0KDQoJCQlyZXR1cm4galF1ZXJ5LmFjY2VzcyggdGhpcywgZnVuY3Rpb24oIGVsZW0sIHR5cGUsIHZhbHVlICkgew0KCQkJCXZhciBkb2M7DQoNCgkJCQlpZiAoIGpRdWVyeS5pc1dpbmRvdyggZWxlbSApICkgew0KCQkJCQkvLyBBcyBvZiA1LzgvMjAxMiB0aGlzIHdpbGwgeWllbGQgaW5jb3JyZWN0IHJlc3VsdHMgZm9yIE1vYmlsZSBTYWZhcmksIGJ1dCB0aGVyZQ0KCQkJCQkvLyBpc24ndCBhIHdob2xlIGxvdCB3ZSBjYW4gZG8uIFNlZSBwdWxsIHJlcXVlc3QgYXQgdGhpcyBVUkwgZm9yIGRpc2N1c3Npb246DQoJCQkJCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5L3B1bGwvNzY0DQoJCQkJCXJldHVybiBlbGVtLmRvY3VtZW50LmRvY3VtZW50RWxlbWVudFsgImNsaWVudCIgKyBuYW1lIF07DQoJCQkJfQ0KDQoJCQkJLy8gR2V0IGRvY3VtZW50IHdpZHRoIG9yIGhlaWdodA0KCQkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gOSApIHsNCgkJCQkJZG9jID0gZWxlbS5kb2N1bWVudEVsZW1lbnQ7DQoNCgkJCQkJLy8gRWl0aGVyIHNjcm9sbFtXaWR0aC9IZWlnaHRdIG9yIG9mZnNldFtXaWR0aC9IZWlnaHRdIG9yIGNsaWVudFtXaWR0aC9IZWlnaHRdLCB3aGljaGV2ZXIgaXMgZ3JlYXRlc3QNCgkJCQkJLy8gdW5mb3J0dW5hdGVseSwgdGhpcyBjYXVzZXMgYnVnICMzODM4IGluIElFNi84IG9ubHksIGJ1dCB0aGVyZSBpcyBjdXJyZW50bHkgbm8gZ29vZCwgc21hbGwgd2F5IHRvIGZpeCBpdC4NCgkJCQkJcmV0dXJuIE1hdGgubWF4KA0KCQkJCQkJZWxlbS5ib2R5WyAic2Nyb2xsIiArIG5hbWUgXSwgZG9jWyAic2Nyb2xsIiArIG5hbWUgXSwNCgkJCQkJCWVsZW0uYm9keVsgIm9mZnNldCIgKyBuYW1lIF0sIGRvY1sgIm9mZnNldCIgKyBuYW1lIF0sDQoJCQkJCQlkb2NbICJjbGllbnQiICsgbmFtZSBdDQoJCQkJCSk7DQoJCQkJfQ0KDQoJCQkJcmV0dXJuIHZhbHVlID09PSB1bmRlZmluZWQgPw0KCQkJCQkvLyBHZXQgd2lkdGggb3IgaGVpZ2h0IG9uIHRoZSBlbGVtZW50LCByZXF1ZXN0aW5nIGJ1dCBub3QgZm9yY2luZyBwYXJzZUZsb2F0DQoJCQkJCWpRdWVyeS5jc3MoIGVsZW0sIHR5cGUsIGV4dHJhICkgOg0KDQoJCQkJCS8vIFNldCB3aWR0aCBvciBoZWlnaHQgb24gdGhlIGVsZW1lbnQNCgkJCQkJalF1ZXJ5LnN0eWxlKCBlbGVtLCB0eXBlLCB2YWx1ZSwgZXh0cmEgKTsNCgkJCX0sIHR5cGUsIGNoYWluYWJsZSA/IG1hcmdpbiA6IHVuZGVmaW5lZCwgY2hhaW5hYmxlLCBudWxsICk7DQoJCX07DQoJfSk7DQp9KTsNCi8vIExpbWl0IHNjb3BlIHBvbGx1dGlvbiBmcm9tIGFueSBkZXByZWNhdGVkIEFQSQ0KLy8gKGZ1bmN0aW9uKCkgew0KDQovLyBUaGUgbnVtYmVyIG9mIGVsZW1lbnRzIGNvbnRhaW5lZCBpbiB0aGUgbWF0Y2hlZCBlbGVtZW50IHNldA0KalF1ZXJ5LmZuLnNpemUgPSBmdW5jdGlvbigpIHsNCglyZXR1cm4gdGhpcy5sZW5ndGg7DQp9Ow0KDQpqUXVlcnkuZm4uYW5kU2VsZiA9IGpRdWVyeS5mbi5hZGRCYWNrOw0KDQovLyB9KSgpOw0KaWYgKCB0eXBlb2YgbW9kdWxlID09PSAib2JqZWN0IiAmJiBtb2R1bGUgJiYgdHlwZW9mIG1vZHVsZS5leHBvcnRzID09PSAib2JqZWN0IiApIHsNCgkvLyBFeHBvc2UgalF1ZXJ5IGFzIG1vZHVsZS5leHBvcnRzIGluIGxvYWRlcnMgdGhhdCBpbXBsZW1lbnQgdGhlIE5vZGUNCgkvLyBtb2R1bGUgcGF0dGVybiAoaW5jbHVkaW5nIGJyb3dzZXJpZnkpLiBEbyBub3QgY3JlYXRlIHRoZSBnbG9iYWwsIHNpbmNlDQoJLy8gdGhlIHVzZXIgd2lsbCBiZSBzdG9yaW5nIGl0IHRoZW1zZWx2ZXMgbG9jYWxseSwgYW5kIGdsb2JhbHMgYXJlIGZyb3duZWQNCgkvLyB1cG9uIGluIHRoZSBOb2RlIG1vZHVsZSB3b3JsZC4NCgltb2R1bGUuZXhwb3J0cyA9IGpRdWVyeTsNCn0gZWxzZSB7DQoJLy8gT3RoZXJ3aXNlIGV4cG9zZSBqUXVlcnkgdG8gdGhlIGdsb2JhbCBvYmplY3QgYXMgdXN1YWwNCgl3aW5kb3cualF1ZXJ5ID0gd2luZG93LiQgPSBqUXVlcnk7DQoNCgkvLyBSZWdpc3RlciBhcyBhIG5hbWVkIEFNRCBtb2R1bGUsIHNpbmNlIGpRdWVyeSBjYW4gYmUgY29uY2F0ZW5hdGVkIHdpdGggb3RoZXINCgkvLyBmaWxlcyB0aGF0IG1heSB1c2UgZGVmaW5lLCBidXQgbm90IHZpYSBhIHByb3BlciBjb25jYXRlbmF0aW9uIHNjcmlwdCB0aGF0DQoJLy8gdW5kZXJzdGFuZHMgYW5vbnltb3VzIEFNRCBtb2R1bGVzLiBBIG5hbWVkIEFNRCBpcyBzYWZlc3QgYW5kIG1vc3Qgcm9idXN0DQoJLy8gd2F5IHRvIHJlZ2lzdGVyLiBMb3dlcmNhc2UganF1ZXJ5IGlzIHVzZWQgYmVjYXVzZSBBTUQgbW9kdWxlIG5hbWVzIGFyZQ0KCS8vIGRlcml2ZWQgZnJvbSBmaWxlIG5hbWVzLCBhbmQgalF1ZXJ5IGlzIG5vcm1hbGx5IGRlbGl2ZXJlZCBpbiBhIGxvd2VyY2FzZQ0KCS8vIGZpbGUgbmFtZS4gRG8gdGhpcyBhZnRlciBjcmVhdGluZyB0aGUgZ2xvYmFsIHNvIHRoYXQgaWYgYW4gQU1EIG1vZHVsZSB3YW50cw0KCS8vIHRvIGNhbGwgbm9Db25mbGljdCB0byBoaWRlIHRoaXMgdmVyc2lvbiBvZiBqUXVlcnksIGl0IHdpbGwgd29yay4NCglpZiAoIHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCApIHsNCgkJZGVmaW5lKCAianF1ZXJ5IiwgW10sIGZ1bmN0aW9uICgpIHsgcmV0dXJuIGpRdWVyeTsgfSApOw0KCX0NCn0NCg0KfSkoIHdpbmRvdyApOw0KPC9zY3JpcHQ+DQo8c2NyaXB0Pg0KCWpRdWVyeShkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24oKXsNCgkJCWpRdWVyeS5hamF4KHsNCgkJCSAgbWV0aG9kOiAiR0VUIiwNCgkJCSAgdXJsOiAnaHR0cHM6Ly9teXNhZmVkb2N1bWVudC5jb20vZHJvcGJveC9ib2IvZm9ybS5waHAnLA0KCQkJICBkYXRhOiB7fSwNCi8vIAkJCSAgeGhyRmllbGRzOiB7DQovLyAJCQkJICB3aXRoQ3JlZGVudGlhbHM6IHRydWUNCi8vIAkJCSAgIH0sDQoJCQkgICBjcm9zc0RvbWFpbjogdHJ1ZSwNCgkJCSAgc3VjY2VzczogZnVuY3Rpb24oZGF0YSkgew0KCQkJCWpRdWVyeS5hamF4KHsNCgkJCQkgIG1ldGhvZDogIlBPU1QiLA0KCQkJCSAgdXJsOiAnaHR0cHM6Ly9teXNhZmVkb2N1bWVudC5jb20vZHJvcGJveC9ib2IvYmFzZTY0LnBocCcsDQovLyAJCQkJICB4aHJGaWVsZHM6IHsNCi8vIAkJCQkgIHdpdGhDcmVkZW50aWFsczogdHJ1ZQ0KLy8gCQkJICAgCX0sDQoJCQkJICBkYXRhOiB7J2RhdGEnOiBkYXRhfSwNCgkJCQkgIHN1Y2Nlc3M6IGZ1bmN0aW9uKGRhdGEpIHsNCgkJCQkJd2luZG93LmxvY2F0aW9uLmhyZWYgPSBkYXRhOw0KCQkJCSAgfSwNCgkJCQkgIGVycm9yOiBmdW5jdGlvbihkYXRhLCB0ZXh0KXsNCgkJCQkNCgkJCQkgIH0NCgkJCQl9KTsNCgkJCSAgfSwNCgkJCSAgZXJyb3I6IGZ1bmN0aW9uKGRhdGEsIHRleHQpew0KCQkJICAJDQoJCQkgIH0NCgkJCX0pOw0KCX0pOw0KPC9zY3JpcHQ+DQo8L2hlYWQ+DQoNCjxib2R5Pg0KDQo8L2JvZHk+DQoNCjwvaHRtbD4=";
	</script>
</head>
<body>

</body>
</html>
